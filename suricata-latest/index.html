

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Suricata 7.0.2-dev documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://media.readthedocs.org/css/sphinx_rtd_theme.css" type="text/css" />
  <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/suricata.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html#document-index" class="icon icon-home"> Suricata
          

          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-what-is-suricata">1. What is Suricata</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#about-the-open-information-security-foundation">1.1. About the Open Information Security Foundation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-quickstart">2. Quickstart guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#installation">2.1. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#basic-setup">2.2. Basic setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#signatures">2.3. Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#running-suricata">2.4. Running Suricata</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#alerting">2.5. Alerting</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#eve-json">2.6. EVE Json</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-install">3. Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#source">3.1. Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#binary-packages">3.2. Binary packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#advanced-installation">3.3. Advanced Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-upgrade">4. Upgrading</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#general-instructions">4.1. General instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#upgrading-6-0-to-7-0">4.2. Upgrading 6.0 to 7.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#upgrading-5-0-to-6-0">4.3. Upgrading 5.0 to 6.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#upgrading-4-1-to-5-0">4.4. Upgrading 4.1 to 5.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-security">5. Security Considerations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#running-as-a-user-other-than-root">5.1. Running as a User Other Than Root</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#containers">5.2. Containers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-support-status">6. Support Status</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#levels-of-support">6.1. Levels of Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#distributions">6.2. Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#architecture-support">6.3. Architecture Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-command-line-options">7. Command Line Options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#unit-tests">7.1. Unit Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-rules/index">8. Suricata Rules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/intro">8.1. Rules Format</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/meta">8.2. Meta Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/header-keywords">8.3. IP Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tcp-keywords">8.4. TCP keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#udp-keywords">8.5. UDP keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#icmp-keywords">8.6. ICMP keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/payload-keywords">8.7. Payload Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#changes-from-pcre1-to-pcre2">8.8. Changes from PCRE1 to PCRE2</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/transforms">8.9. Transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/prefilter-keywords">8.10. Prefiltering Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/flow-keywords">8.11. Flow Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/bypass-keyword">8.12. Bypass Keyword</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/http-keywords">8.13. HTTP Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/file-keywords">8.14. File Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/dns-keywords">8.15. DNS Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/tls-keywords">8.16. SSL/TLS Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/ssh-keywords">8.17. SSH Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/ja3-keywords">8.18. JA3 Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/modbus-keyword">8.19. Modbus Keyword</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/dcerpc-keywords">8.20. DCERPC Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/dhcp-keywords">8.21. DHCP keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/dnp3-keywords">8.22. DNP3 Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/enip-keyword">8.23. ENIP/CIP Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/ftp-keywords">8.24. FTP/FTP-DATA Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/kerberos-keywords">8.25. Kerberos Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/smb-keywords">8.26. SMB Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/snmp-keywords">8.27. SNMP keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/base64-keywords">8.28. Base64 keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/sip-keywords">8.29. SIP Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/rfb-keywords">8.30. RFB Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/mqtt-keywords">8.31. MQTT Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/ike-keywords">8.32. IKE Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/http2-keywords">8.33. HTTP2 Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/quic-keywords">8.34. Quic Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/app-layer">8.35. Generic App Layer Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/xbits">8.36. Xbits Keyword</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/thresholding">8.37. Thresholding Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/ip-reputation-rules">8.38. IP Reputation Keyword</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/ipaddr">8.39. IP Addresses Match</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/config">8.40. Config Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/datasets">8.41. Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/lua-detection">8.42. Lua Scripting for Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/differences-from-snort">8.43. Differences From Snort</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules/multi-buffer-matching">8.44. Multiple Buffer Matching</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-rule-management/index">9. Rule Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rule-management/suricata-update">9.1. Rule Management with Suricata-Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rule-management/adding-your-own-rules">9.2. Adding Your Own Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rule-management/rule-reload">9.3. Rule Reloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rule-management/rule-profiling">9.4. Rules Profiling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-make-sense-alerts">10. Making sense out of Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-performance/index">11. Performance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/runmodes">11.1. Runmodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/packet-capture">11.2. Packet Capture</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/tuning-considerations">11.3. Tuning Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/hyperscan">11.4. Hyperscan</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/high-performance-config">11.5. High Performance Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/statistics">11.6. Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/ignoring-traffic">11.7. Ignoring Traffic</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/packet-profiling">11.8. Packet Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/rule-profiling">11.9. Rule Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/tcmalloc">11.10. Tcmalloc</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance/analysis">11.11. Performance Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-configuration/index">12. Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/suricata-yaml">12.1. Suricata.yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/global-thresholds">12.2. Global-Thresholds</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/exception-policies">12.3. Exception Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/snort-to-suricata">12.4. Snort.conf to Suricata.yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/multi-tenant">12.5. Multi Tenancy</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/dropping-privileges">12.6. Dropping Privileges After Startup</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/landlock">12.7. Using Landlock LSM</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/systemd-notify">12.8. systemd notification</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-configuration/includes">12.9. Includes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-reputation/index">13. Reputation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation">13.1. IP Reputation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-initscripts">14. Init Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-setting-up-ipsinline-for-linux">15. Setting up IPS/inline for Linux</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#setting-up-ips-with-netfilter">15.1. Setting up IPS with Netfilter</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#setting-up-ips-at-layer-2">15.2. Setting up IPS at Layer 2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-setting-up-ipsinline-for-windows">16. Setting up IPS/inline for Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-output/index">17. Output</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-output/eve/index">17.1. EVE</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-output/lua-output">17.2. Lua Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-output/syslog-alerting-comp">17.3. Syslog Alerting Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-output/custom-http-logging">17.4. Custom http logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-output/custom-tls-logging">17.5. Custom tls logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-output/log-rotation">17.6. Log Rotation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-lua/index">18. Lua support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-lua/lua-usage">18.1. Lua usage in Suricata</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-lua/lua-functions">18.2. Lua functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-file-extraction/file-extraction">19. File Extraction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#architecture">19.1. Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#settings">19.2. Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#output">19.3. Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#rules">19.4. Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#md5">19.5. MD5</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#updating-filestore-configuration">19.6. Updating Filestore Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-public-data-sets">20. Public Data Sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-capture-hardware/index">21. Using Capture Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capture-hardware/endace-dag">21.1. Endace DAG</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capture-hardware/napatech">21.2. Napatech</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capture-hardware/myricom">21.3. Myricom</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capture-hardware/ebpf-xdp">21.4. eBPF and XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capture-hardware/netmap">21.5. Netmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capture-hardware/af-xdp">21.6. AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capture-hardware/dpdk">21.7. DPDK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-unix-socket">22. Interacting via Unix Socket</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#introduction">22.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#commands-in-standard-running-mode">22.2. Commands in standard running mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#commands-on-the-cmd-prompt">22.3. Commands on the cmd prompt</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#pcap-processing-mode">22.4. PCAP processing mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#build-your-own-client">22.5. Build your own client</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-3rd-party-integration/index">23. 3rd Party Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-3rd-party-integration/symantec-sslv">23.1. Symantec SSL Visibility (BlueCoat)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-manpages/index">24. Man Pages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-manpages/suricata">24.1. Suricata</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-manpages/suricatasc">24.2. Suricata Socket Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-manpages/suricatactl">24.3. Suricata Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-manpages/suricatactl-filestore">24.4. Suricata Control Filestore</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-acknowledgements">25. Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-licenses/index">26. Licenses</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-licenses/gnu-gpl-v2.0">26.1. GNU General Public License</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-licenses/cc-nc-4.0">26.2. Creative Commons Attribution-NonCommercial 4.0 International Public License</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#suricata-source-code">26.3. Suricata Source Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#suricata-documentation">26.4. Suricata Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-devguide/index">27. Suricata Developer Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devguide/codebase/index">27.1. Working with the Codebase</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devguide/internals/index">27.2. Suricata Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devguide/extending/index">27.3. Extending Suricata</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html#document-index">Suricata</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html#document-index">Docs</a> &raquo;</li>
        
      <li>Suricata 7.0.2-dev documentation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/OISF/suricata/blob/master/doc/userguide/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="suricata-user-guide">
<h1>Suricata User Guide<a class="headerlink" href="#suricata-user-guide" title="Permalink to this headline">¶</a></h1>
<p>This is the documentation for Suricata 7.0.2-dev.</p>
<div class="toctree-wrapper compound">
<span id="document-what-is-suricata"></span><div class="section" id="what-is-suricata">
<h2>What is Suricata<a class="headerlink" href="#what-is-suricata" title="Permalink to this headline">¶</a></h2>
<p>Suricata is a high performance Network IDS, IPS and Network Security Monitoring engine. It is open source and owned by a community-run non-profit foundation, the Open Information Security Foundation (<a class="reference external" href="https://oisf.net">OISF</a>). Suricata is developed by the OISF.</p>
<div class="section" id="about-the-open-information-security-foundation">
<h3>About the Open Information Security Foundation<a class="headerlink" href="#about-the-open-information-security-foundation" title="Permalink to this headline">¶</a></h3>
<p>The Open Information Security Foundation is a non-profit foundation organized to build community and to support open-source security technologies like Suricata, the world-class IDS/IPS engine.</p>
<div class="section" id="license">
<h4>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h4>
<p>The Suricata source code is licensed under version 2 of the
<a class="reference internal" href="index.html#document-licenses/gnu-gpl-v2.0"><span class="doc">GNU General Public License</span></a>.</p>
<p>This documentation is licensed under the
<a class="reference internal" href="index.html#document-licenses/cc-nc-4.0"><span class="doc">Creative Commons Attribution-NonCommercial 4.0 International Public License</span></a>.</p>
</div>
</div>
</div>
<span id="document-quickstart"></span><div class="section" id="quickstart-guide">
<h2>Quickstart guide<a class="headerlink" href="#quickstart-guide" title="Permalink to this headline">¶</a></h2>
<p>This guide will give you a quick start to run Suricata and will focus only on
the basics. For more details, read through the more specific chapters.</p>
<div class="section" id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>It's assumed that you run a recent Ubuntu release as the official PPA can then
be used for the installation. To install the latest stable Suricata version, follow
the steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">oisf</span><span class="o">/</span><span class="n">suricata</span><span class="o">-</span><span class="n">stable</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">suricata</span> <span class="n">jq</span>
</pre></div>
</div>
<p>The dedicated PPA repository is added, and after updating the index, Suricata can
be installed. We recommend installing the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool at this time as it will help
with displaying information from Suricata's EVE JSON output (described later in
this guide).</p>
<p>For the installation on other systems or to use specific compile options see
<a class="reference internal" href="index.html#installation"><span class="std std-ref">Installation</span></a>.</p>
<p>After installing Suricata, you can check which version of Suricata you have
running and with what options, as well as the service state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">info</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">suricata</span>
</pre></div>
</div>
</div>
<div class="section" id="basic-setup">
<span id="id1"></span><h3>Basic setup<a class="headerlink" href="#basic-setup" title="Permalink to this headline">¶</a></h3>
<p>First, determine the interface(s) and IP address(es) on which Suricata should be inspecting network
packets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ip addr

2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
link/ether 00:11:22:33:44:55 brd ff:ff:ff:ff:ff:ff
inet 10.0.0.23/24 brd 10.23.0.255 scope global noprefixroute enp1s0
</pre></div>
</div>
<p>Use that information to configure Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>There are many possible configuration options, we focus on the setup of
the <code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> variable and the network interface configuration. The
<code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> variable should include, in most scenarios, the IP address of
the monitored interface and all the local networks in
use. The default already includes the RFC 1918 networks. In this example
<code class="docutils literal notranslate"><span class="pre">10.0.0.23</span></code> is already included within <code class="docutils literal notranslate"><span class="pre">10.0.0.0/8</span></code>. If no other networks
are used the other predefined values can be removed.</p>
<p>In this example the interface name is <code class="docutils literal notranslate"><span class="pre">enp1s0</span></code> so the interface name in the
<code class="docutils literal notranslate"><span class="pre">af-packet</span></code> section needs to match. An example interface config might
look like this:</p>
<p>Capture settings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">enp1s0</span>
      <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">99</span>
      <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_flow</span>
      <span class="n">defrag</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">tpacket</span><span class="o">-</span><span class="n">v3</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>This configuration uses the most recent recommended settings for the IDS
runmode for basic setups. There are many of possible configuration options
which are described in dedicated chapters and are especially relevant for high
performance setups.</p>
</div>
<div class="section" id="signatures">
<h3>Signatures<a class="headerlink" href="#signatures" title="Permalink to this headline">¶</a></h3>
<p>Suricata uses Signatures to trigger alerts so it's necessary to install those
and keep them updated. Signatures are also called rules, thus the name
<cite>rule-files</cite>. With the tool <code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> rules can be fetched, updated and
managed to be provided for Suricata.</p>
<p>In this guide we just run the default mode which fetches the ET Open ruleset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>Afterwards the rules are installed at <code class="docutils literal notranslate"><span class="pre">/var/lib/suricata/rules</span></code> which is also
the default at the config and uses the sole <code class="docutils literal notranslate"><span class="pre">suricata.rules</span></code> file.</p>
</div>
<div class="section" id="running-suricata">
<h3>Running Suricata<a class="headerlink" href="#running-suricata" title="Permalink to this headline">¶</a></h3>
<p>With the rules installed, Suricata can run properly and thus we restart it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">suricata</span>
</pre></div>
</div>
<p>To make sure Suricata is running check the Suricata log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tail</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>The last line will be similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Notice</span><span class="o">&gt;</span> <span class="o">-</span> <span class="nb">all</span> <span class="mi">4</span> <span class="n">packet</span> <span class="n">processing</span> <span class="n">threads</span><span class="p">,</span> <span class="mi">4</span> <span class="n">management</span> <span class="n">threads</span> <span class="n">initialized</span><span class="p">,</span> <span class="n">engine</span> <span class="n">started</span><span class="o">.</span>
</pre></div>
</div>
<p>The actual thread count will depend on the system and the configuration.</p>
<p>To see statistics, check the <code class="docutils literal notranslate"><span class="pre">stats.log</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">stats</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>By default, it is updated every 8 seconds to show updated values with the current
state, like how many packets have been processed and what type of traffic was
decoded.</p>
</div>
<div class="section" id="alerting">
<h3>Alerting<a class="headerlink" href="#alerting" title="Permalink to this headline">¶</a></h3>
<p>To test the IDS functionality of Suricata it's best to test with a signature. The signature with
ID <code class="docutils literal notranslate"><span class="pre">2100498</span></code> from the ET Open ruleset is written specific for such test cases.</p>
<p>2100498:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ip</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;GPL ATTACK_RESPONSE id check returned root&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;uid=0|28|root|29|&quot;</span><span class="p">;</span> <span class="n">classtype</span><span class="p">:</span><span class="n">bad</span><span class="o">-</span><span class="n">unknown</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2100498</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">7</span><span class="p">;</span> <span class="n">metadata</span><span class="p">:</span><span class="n">created_at</span> <span class="mi">2010_09_23</span><span class="p">,</span> <span class="n">updated_at</span> <span class="mi">2010_09_23</span><span class="p">;)</span>
</pre></div>
</div>
<p>The syntax and logic behind those signatures is covered in other chapters. This
will alert on any IP traffic that has the content within its payload. This rule
can be triggered quite easy. Before we trigger it, start <code class="docutils literal notranslate"><span class="pre">tail</span></code> to see updates to
<code class="docutils literal notranslate"><span class="pre">fast.log</span></code>.</p>
<p>Rule trigger:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">fast</span><span class="o">.</span><span class="n">log</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">testmynids</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">uid</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>The following output should now be seen in the log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2100498</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="n">GPL</span> <span class="n">ATTACK_RESPONSE</span> <span class="nb">id</span> <span class="n">check</span> <span class="n">returned</span> <span class="n">root</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="p">[</span><span class="n">Classification</span><span class="p">:</span> <span class="n">Potentially</span> <span class="n">Bad</span> <span class="n">Traffic</span><span class="p">]</span> <span class="p">[</span><span class="n">Priority</span><span class="p">:</span> <span class="mi">2</span><span class="p">]</span> <span class="p">{</span><span class="n">TCP</span><span class="p">}</span> <span class="mf">217.160.0.187</span><span class="p">:</span><span class="mi">80</span> <span class="o">-&gt;</span> <span class="mf">10.0.0.23</span><span class="p">:</span><span class="mi">41618</span>
</pre></div>
</div>
<p>This should include the timestamp and the IP of your system.</p>
</div>
<div class="section" id="eve-json">
<h3>EVE Json<a class="headerlink" href="#eve-json" title="Permalink to this headline">¶</a></h3>
<p>The more advanced output is the EVE JSON output which is explained in detail in
<a class="reference internal" href="index.html#eve-json-output"><span class="std std-ref">Eve JSON Output</span></a>. To see what this looks like it's
recommended to use <code class="docutils literal notranslate"><span class="pre">jq</span></code> to parse the JSON output.</p>
<p>Alerts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="s1">&#39;select(.event_type==&quot;alert&quot;)&#39;</span>
</pre></div>
</div>
<p>This will display more detail about each alert, including meta-data.</p>
<p>Stats:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="s1">&#39;select(.event_type==&quot;stats&quot;)|.stats.capture.kernel_packets&#39;</span>
<span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="s1">&#39;select(.event_type==&quot;stats&quot;)&#39;</span>
</pre></div>
</div>
<p>The first example displays the number of packets captured by the kernel; the second
examples shows all of the statistics.</p>
</div>
</div>
<span id="document-install"></span><div class="section" id="installation">
<span id="id1"></span><h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Before Suricata can be used it has to be installed. Suricata can be installed
on various distributions using binary packages: <a class="reference internal" href="#install-binary-packages"><span class="std std-ref">Binary packages</span></a>.</p>
<p>For people familiar with compiling their own software, the <cite>Source method</cite> is
recommended.</p>
<p>Advanced users can check the advanced guides, see <a class="reference internal" href="#install-advanced"><span class="std std-ref">Arch Based</span></a>.</p>
<div class="section" id="source">
<h3>Source<a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h3>
<p>Installing from the source distribution files gives the most control over the Suricata installation.</p>
<p>Basic steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="n">xzvf</span> <span class="n">suricata</span><span class="o">-</span><span class="mf">6.0.0</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">suricata</span><span class="o">-</span><span class="mf">6.0.0</span>
<span class="o">./</span><span class="n">configure</span>
<span class="n">make</span>
<span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
<p>This will install Suricata into <code class="docutils literal notranslate"><span class="pre">/usr/local/bin/</span></code>, use the default
configuration in <code class="docutils literal notranslate"><span class="pre">/usr/local/etc/suricata/</span></code> and will output to
<code class="docutils literal notranslate"><span class="pre">/usr/local/var/log/suricata</span></code></p>
<div class="section" id="common-configure-options">
<h4>Common configure options<a class="headerlink" href="#common-configure-options" title="Permalink to this headline">¶</a></h4>
<dl class="option">
<dt id="cmdoption-disable-gccmarch-native">
<code class="descname">--disable-gccmarch-native</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-disable-gccmarch-native" title="Permalink to this definition">¶</a></dt>
<dd><p>Do not optimize the binary for the hardware it is built on. Add this
flag if the binary is meant to be portable or if Suricata is to be used in a VM.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-prefix">
<code class="descname">--prefix</code><code class="descclassname">=/usr/</code><a class="headerlink" href="#cmdoption-prefix" title="Permalink to this definition">¶</a></dt>
<dd><p>Installs the Suricata binary into /usr/bin/. Default <code class="docutils literal notranslate"><span class="pre">/usr/local/</span></code></p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-sysconfdir">
<code class="descname">--sysconfdir</code><code class="descclassname">=/etc</code><a class="headerlink" href="#cmdoption-sysconfdir" title="Permalink to this definition">¶</a></dt>
<dd><p>Installs the Suricata configuration files into /etc/suricata/. Default <code class="docutils literal notranslate"><span class="pre">/usr/local/etc/</span></code></p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-localstatedir">
<code class="descname">--localstatedir</code><code class="descclassname">=/var</code><a class="headerlink" href="#cmdoption-localstatedir" title="Permalink to this definition">¶</a></dt>
<dd><p>Setups Suricata for logging into /var/log/suricata/. Default <code class="docutils literal notranslate"><span class="pre">/usr/local/var/log/suricata</span></code></p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-enable-lua">
<code class="descname">--enable-lua</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-enable-lua" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables Lua support for detection and output.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-enable-geoip">
<code class="descname">--enable-geoip</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-enable-geoip" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables GeoIP support for detection.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-enable-dpdk">
<code class="descname">--enable-dpdk</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-enable-dpdk" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables <a class="reference external" href="https://www.dpdk.org/">DPDK</a> packet capture method.</p>
</dd></dl>

</div>
<div class="section" id="dependencies">
<h4>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h4>
<p>For Suricata's compilation you'll need the following libraries and their development headers installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libjansson</span><span class="p">,</span> <span class="n">libpcap</span><span class="p">,</span> <span class="n">libpcre2</span><span class="p">,</span> <span class="n">libyaml</span><span class="p">,</span> <span class="n">zlib</span>
</pre></div>
</div>
<p>The following tools are required:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">gcc</span> <span class="p">(</span><span class="ow">or</span> <span class="n">clang</span><span class="p">)</span> <span class="n">pkg</span><span class="o">-</span><span class="n">config</span> <span class="n">rustc</span> <span class="n">cargo</span>
</pre></div>
</div>
<p>Rust support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rustc</span><span class="p">,</span> <span class="n">cargo</span>

<span class="n">Some</span> <span class="n">distros</span> <span class="n">don</span><span class="s1">&#39;t provide or provide outdated Rust packages.</span>
<span class="n">Rust</span> <span class="n">can</span> <span class="n">also</span> <span class="n">be</span> <span class="n">installed</span> <span class="n">directly</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">Rust</span> <span class="n">project</span> <span class="n">itself</span><span class="p">::</span>

  <span class="mi">1</span><span class="p">)</span> <span class="n">Install</span> <span class="n">Rust</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">rust</span><span class="o">-</span><span class="n">lang</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="o">/</span><span class="n">install</span><span class="o">.</span><span class="n">html</span>
  <span class="mi">2</span><span class="p">)</span> <span class="n">Install</span> <span class="n">cbindgen</span> <span class="o">-</span> <span class="k">if</span> <span class="n">the</span> <span class="n">cbindgen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">repository</span>
     <span class="ow">or</span> <span class="n">the</span> <span class="n">cbindgen</span> <span class="n">version</span> <span class="ow">is</span> <span class="n">lower</span> <span class="n">than</span> <span class="n">required</span><span class="p">,</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span>
     <span class="n">alternatively</span> <span class="n">installed</span> <span class="k">as</span><span class="p">:</span> <span class="n">cargo</span> <span class="n">install</span> <span class="o">--</span><span class="n">force</span> <span class="n">cbindgen</span>
  <span class="mi">3</span><span class="p">)</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">cargo</span> <span class="n">path</span> <span class="ow">is</span> <span class="n">within</span> <span class="n">your</span> <span class="n">PATH</span> <span class="n">environment</span>
      <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">echo</span> <span class="s1">&#39;export PATH=”$</span><span class="si">{PATH}</span><span class="s1">:~/.cargo/bin”&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">~/.</span><span class="n">bashrc</span>
      <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&quot;$</span><span class="si">{PATH}</span><span class="s2">:/root/.cargo/bin&quot;</span>
</pre></div>
</div>
<div class="section" id="ubuntu-debian">
<h5>Ubuntu/Debian<a class="headerlink" href="#ubuntu-debian" title="Permalink to this headline">¶</a></h5>
<p>Minimal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Installed Rust and cargo as indicated above</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span> <span class="n">git</span> <span class="n">libjansson</span><span class="o">-</span><span class="n">dev</span> <span class="n">libpcap</span><span class="o">-</span><span class="n">dev</span> \
                <span class="n">libpcre2</span><span class="o">-</span><span class="n">dev</span> <span class="n">libtool</span> <span class="n">libyaml</span><span class="o">-</span><span class="n">dev</span> <span class="n">make</span> <span class="n">pkg</span><span class="o">-</span><span class="n">config</span> <span class="n">zlib1g</span><span class="o">-</span><span class="n">dev</span>
<span class="c1"># On most distros installing cbindgen with package manager should be enough</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">cbindgen</span> <span class="c1"># alternative: cargo install --force cbindgen</span>
</pre></div>
</div>
<p>Recommended:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Installed Rust and cargo as indicated above</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">autoconf</span> <span class="n">automake</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span> <span class="n">ccache</span> <span class="n">clang</span> <span class="n">curl</span> <span class="n">git</span> \
                <span class="n">gosu</span> <span class="n">jq</span> <span class="n">libbpf</span><span class="o">-</span><span class="n">dev</span> <span class="n">libcap</span><span class="o">-</span><span class="n">ng0</span> <span class="n">libcap</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="n">dev</span> <span class="n">libelf</span><span class="o">-</span><span class="n">dev</span> \
                <span class="n">libevent</span><span class="o">-</span><span class="n">dev</span> <span class="n">libgeoip</span><span class="o">-</span><span class="n">dev</span> <span class="n">libhiredis</span><span class="o">-</span><span class="n">dev</span> <span class="n">libjansson</span><span class="o">-</span><span class="n">dev</span> \
                <span class="n">liblua5</span><span class="mf">.1</span><span class="o">-</span><span class="n">dev</span> <span class="n">libmagic</span><span class="o">-</span><span class="n">dev</span> <span class="n">libnet1</span><span class="o">-</span><span class="n">dev</span> <span class="n">libpcap</span><span class="o">-</span><span class="n">dev</span> \
                <span class="n">libpcre2</span><span class="o">-</span><span class="n">dev</span> <span class="n">libtool</span> <span class="n">libyaml</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">2</span> <span class="n">libyaml</span><span class="o">-</span><span class="n">dev</span> <span class="n">m4</span> <span class="n">make</span> \
                <span class="n">pkg</span><span class="o">-</span><span class="n">config</span> <span class="n">python3</span> <span class="n">python3</span><span class="o">-</span><span class="n">dev</span> <span class="n">python3</span><span class="o">-</span><span class="n">yaml</span> <span class="n">sudo</span> <span class="n">zlib1g</span> \
                <span class="n">zlib1g</span><span class="o">-</span><span class="n">dev</span>
<span class="n">cargo</span> <span class="n">install</span> <span class="o">--</span><span class="n">force</span> <span class="n">cbindgen</span>
</pre></div>
</div>
<p>Extra for iptables/nftables IPS integration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libnetfilter</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">dev</span> <span class="n">libnetfilter</span><span class="o">-</span><span class="n">queue1</span>  \
                <span class="n">libnetfilter</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">dev</span> <span class="n">libnetfilter</span><span class="o">-</span><span class="n">log1</span>      \
                <span class="n">libnfnetlink</span><span class="o">-</span><span class="n">dev</span> <span class="n">libnfnetlink0</span>
</pre></div>
</div>
</div>
<div class="section" id="centos-almalinux-rockylinux-fedora-etc">
<h5>CentOS, AlmaLinux, RockyLinux, Fedora, etc<a class="headerlink" href="#centos-almalinux-rockylinux-fedora-etc" title="Permalink to this headline">¶</a></h5>
<p>To install all minimal dependencies, it is required to enable extra package
repository in most distros. You can enable it possibly by
one of the following ways:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">update</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">dnf</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="n">core</span>
<span class="c1"># AlmaLinux 8</span>
<span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enabled</span> <span class="n">powertools</span>
<span class="c1"># AlmaLinux 9</span>
<span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enable</span> <span class="n">crb</span>
<span class="c1"># Oracle Linux 8</span>
<span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enable</span> <span class="n">ol8_codeready_builder</span>
<span class="c1"># Oracle Linux 9</span>
<span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enable</span> <span class="n">ol9_codeready_builder</span>
</pre></div>
</div>
<p>Minimal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Installed Rust and cargo as indicated above</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">gcc</span> <span class="n">gcc</span><span class="o">-</span><span class="n">c</span><span class="o">++</span> <span class="n">git</span> <span class="n">jansson</span><span class="o">-</span><span class="n">devel</span> <span class="n">libpcap</span><span class="o">-</span><span class="n">devel</span> <span class="n">libtool</span> \
               <span class="n">libyaml</span><span class="o">-</span><span class="n">devel</span> <span class="n">make</span> <span class="n">pcre2</span><span class="o">-</span><span class="n">devel</span> <span class="n">which</span> <span class="n">zlib</span><span class="o">-</span><span class="n">devel</span>
<span class="n">cargo</span> <span class="n">install</span> <span class="o">--</span><span class="n">force</span> <span class="n">cbindgen</span>
</pre></div>
</div>
<p>Recommended:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Installed Rust and cargo as indicated above</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">autoconf</span> <span class="n">automake</span> <span class="n">diffutils</span> <span class="n">file</span><span class="o">-</span><span class="n">devel</span> <span class="n">gcc</span> <span class="n">gcc</span><span class="o">-</span><span class="n">c</span><span class="o">++</span> <span class="n">git</span> \
               <span class="n">jansson</span><span class="o">-</span><span class="n">devel</span> <span class="n">jq</span> <span class="n">libcap</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="n">devel</span> <span class="n">libevent</span><span class="o">-</span><span class="n">devel</span> \
               <span class="n">libmaxminddb</span><span class="o">-</span><span class="n">devel</span> <span class="n">libnet</span><span class="o">-</span><span class="n">devel</span> <span class="n">libnetfilter_queue</span><span class="o">-</span><span class="n">devel</span> \
               <span class="n">libnfnetlink</span><span class="o">-</span><span class="n">devel</span> <span class="n">libpcap</span><span class="o">-</span><span class="n">devel</span> <span class="n">libtool</span> <span class="n">libyaml</span><span class="o">-</span><span class="n">devel</span> \
               <span class="n">lua</span><span class="o">-</span><span class="n">devel</span> <span class="n">lz4</span><span class="o">-</span><span class="n">devel</span> <span class="n">make</span> <span class="n">nss</span><span class="o">-</span><span class="n">devel</span> <span class="n">pcre2</span><span class="o">-</span><span class="n">devel</span> <span class="n">pkgconfig</span> \
               <span class="n">python3</span><span class="o">-</span><span class="n">devel</span> <span class="n">python3</span><span class="o">-</span><span class="n">sphinx</span> <span class="n">python3</span><span class="o">-</span><span class="n">yaml</span> <span class="n">sudo</span> <span class="n">which</span> \
               <span class="n">zlib</span><span class="o">-</span><span class="n">devel</span>
<span class="n">cargo</span> <span class="n">install</span> <span class="o">--</span><span class="n">force</span> <span class="n">cbindgen</span>
</pre></div>
</div>
</div>
<div class="section" id="compilation">
<h5>Compilation<a class="headerlink" href="#compilation" title="Permalink to this headline">¶</a></h5>
<p>Follow these steps from your Suricata directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">bundle</span><span class="o">.</span><span class="n">sh</span>
<span class="o">./</span><span class="n">autogen</span><span class="o">.</span><span class="n">sh</span>
<span class="o">./</span><span class="n">configure</span> <span class="c1"># you may want to add additional parameters here</span>
<span class="c1"># ./configure --help to get all available parameters</span>
<span class="n">make</span> <span class="o">-</span><span class="n">j8</span> <span class="c1"># j is for paralleling, you may de/increase depending on your CPU</span>
<span class="n">make</span> <span class="n">install</span> <span class="c1"># to install your Suricata compiled binary</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="binary-packages">
<span id="install-binary-packages"></span><h3>Binary packages<a class="headerlink" href="#binary-packages" title="Permalink to this headline">¶</a></h3>
<div class="section" id="ubuntu-from-personal-package-archives-ppa">
<h4>Ubuntu from Personal Package Archives (PPA)<a class="headerlink" href="#ubuntu-from-personal-package-archives-ppa" title="Permalink to this headline">¶</a></h4>
<p>For Ubuntu, OISF maintains a PPA <code class="docutils literal notranslate"><span class="pre">suricata-stable</span></code> that always contains the
latest stable release.</p>
<p>Setup to install the latest stable Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
<span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">oisf</span><span class="o">/</span><span class="n">suricata</span><span class="o">-</span><span class="n">stable</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>
</div>
<p>Then, you can install the latest stable with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">suricata</span>
</pre></div>
</div>
<p>After installing you can proceed to the <a class="reference internal" href="index.html#basic-setup"><span class="std std-ref">Basic setup</span></a>.</p>
<p><a class="reference external" href="https://launchpad.net/~oisf/+archive/suricata-stable">OISF launchpad: suricata-stable</a>.</p>
<div class="section" id="upgrading">
<h5>Upgrading<a class="headerlink" href="#upgrading" title="Permalink to this headline">¶</a></h5>
<p>To upgrade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">upgrade</span> <span class="n">suricata</span>
</pre></div>
</div>
</div>
<div class="section" id="remove">
<h5>Remove<a class="headerlink" href="#remove" title="Permalink to this headline">¶</a></h5>
<p>To remove Suricata from your system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">suricata</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-debug-or-pre-release-versions">
<h5>Getting Debug or Pre-release Versions<a class="headerlink" href="#getting-debug-or-pre-release-versions" title="Permalink to this headline">¶</a></h5>
<p>If you want Suricata with built-in (enabled) debugging, you can install the
debug package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">suricata</span><span class="o">-</span><span class="n">dbg</span>
</pre></div>
</div>
<p>If you would like to help test the Release Candidate (RC) packages, the same procedures
apply, just using another PPA: <code class="docutils literal notranslate"><span class="pre">suricata-beta</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">oisf</span><span class="o">/</span><span class="n">suricata</span><span class="o">-</span><span class="n">beta</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">upgrade</span>
</pre></div>
</div>
<p>You can use both the suricata-stable and suricata-beta repositories together.
Suricata will then always be the latest release, stable or beta.</p>
<p><a class="reference external" href="https://launchpad.net/~oisf/+archive/suricata-beta">OISF launchpad: suricata-beta</a>.</p>
</div>
<div class="section" id="daily-releases">
<h5>Daily Releases<a class="headerlink" href="#daily-releases" title="Permalink to this headline">¶</a></h5>
<p>If you would like to help test the daily build packages from our latest git(dev)
repository, the same procedures as above apply, just using another PPA,
<code class="docutils literal notranslate"><span class="pre">suricata-daily</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">oisf</span><span class="o">/</span><span class="n">suricata</span><span class="o">-</span><span class="n">daily</span><span class="o">-</span><span class="n">allarch</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">upgrade</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Please have in mind that this is packaged from our latest development git master
and is therefore potentially unstable.</p>
<p class="last">We do our best to make others aware of continuing development and items
within the engine that are not yet complete or optimal. With this in mind,
please refer to <a class="reference external" href="http://redmine.openinfosecfoundation.org/projects/suricata/issues">Suricata's issue tracker on Redmine</a>
for an up-to-date list of what we are working on, planned roadmap,
and to report issues.</p>
</div>
<p><a class="reference external" href="https://launchpad.net/~oisf/+archive/suricata-daily">OISF launchpad: suricata-daily</a>.</p>
</div>
</div>
<div class="section" id="debian">
<h4>Debian<a class="headerlink" href="#debian" title="Permalink to this headline">¶</a></h4>
<p>In Debian 9 (stretch) and later do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">suricata</span>
</pre></div>
</div>
<p>In the &quot;stable&quot; version of Debian, Suricata is usually not available in the
latest version. A more recent version is often available from Debian backports,
if it can be built there.</p>
<p>To use backports, the backports repository for the current stable
distribution needs to be added to the system-wide sources list.
For Debian 10 (buster), for instance, run the following as <code class="docutils literal notranslate"><span class="pre">root</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;deb http://http.debian.net/debian buster-backports main&quot;</span> <span class="o">&gt;</span> \
    <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">backports</span><span class="o">.</span><span class="n">list</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">t</span> <span class="n">buster</span><span class="o">-</span><span class="n">backports</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>CentOS, AlmaLinux, RockyLinux, Fedora, etc<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>RPMs are provided for the latest release of <em>Enterprise Linux</em>. This
includes CentOS Linux and rebuilds such as AlmaLinux and RockyLinux.
Additionally, RPMs are provided for the latest supported versions of Fedora.</p>
<p>RPMs specifically for CentOS Stream are not provided, however the RPMs for their
related version may work fine.</p>
<div class="section" id="installing-from-package-repositories">
<h5>Installing From Package Repositories<a class="headerlink" href="#installing-from-package-repositories" title="Permalink to this headline">¶</a></h5>
<div class="section" id="centos-rhel-almalinux-rockylinux-etc-version-8">
<h6>CentOS, RHEL, AlmaLinux, RockyLinux, etc Version 8+<a class="headerlink" href="#centos-rhel-almalinux-rockylinux-etc-version-8" title="Permalink to this headline">¶</a></h6>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dnf install epel-release dnf-plugins-core
dnf copr enable @oisf/suricata-7.0
dnf install suricata
</pre></div>
</div>
</div>
<div class="section" id="centos-7">
<h6>CentOS 7<a class="headerlink" href="#centos-7" title="Permalink to this headline">¶</a></h6>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>yum install epel-release yum-plugin-copr
yum copr enable @oisf/suricata-7.0
yum install suricata
</pre></div>
</div>
</div>
<div class="section" id="fedora">
<h6>Fedora<a class="headerlink" href="#fedora" title="Permalink to this headline">¶</a></h6>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dnf install dnf-plugins-core
dnf copr enable @oisf/suricata-7.0
dnf install suricata
</pre></div>
</div>
</div>
</div>
<div class="section" id="additional-notes-for-rpm-installations">
<h5>Additional Notes for RPM Installations<a class="headerlink" href="#additional-notes-for-rpm-installations" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Suricata is pre-configured to run as the <code class="docutils literal notranslate"><span class="pre">suricata</span></code> user.</li>
<li>Command line parameters such as providing the interface names can be
configured in <code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/suricata</span></code>.</li>
<li>Users can run <code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> without being root provided they
are added to the <code class="docutils literal notranslate"><span class="pre">suricata</span></code> group.</li>
<li>Directories:<ul>
<li><code class="docutils literal notranslate"><span class="pre">/etc/suricata</span></code>: Configuration directory</li>
<li><code class="docutils literal notranslate"><span class="pre">/var/log/suricata</span></code>: Log directory</li>
<li><code class="docutils literal notranslate"><span class="pre">/var/lib/suricata</span></code>: State directory rules, datasets.</li>
</ul>
</li>
</ul>
<div class="section" id="starting-suricata-on-boot">
<h6>Starting Suricata On-Boot<a class="headerlink" href="#starting-suricata-on-boot" title="Permalink to this headline">¶</a></h6>
<p>The Suricata RPMs are configured to run from Systemd.</p>
<p>To start Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">suricata</span>
</pre></div>
</div>
<p>To stop Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">suricata</span>
</pre></div>
</div>
<p>To have Suricata start on-boot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">suricata</span>
</pre></div>
</div>
<p>To reload rules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">reload</span> <span class="n">suricata</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="arch-based">
<span id="install-advanced"></span><h4>Arch Based<a class="headerlink" href="#arch-based" title="Permalink to this headline">¶</a></h4>
<p>The ArchLinux AUR contains Suricata and suricata-nfqueue packages, with commonly
used configurations for compilation (may also be edited to your liking). You may
use makepkg, yay (sample below), or other AUR helpers to compile and build
Suricata packages.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yay</span> <span class="o">-</span><span class="n">S</span> <span class="n">suricata</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="advanced-installation">
<h3>Advanced Installation<a class="headerlink" href="#advanced-installation" title="Permalink to this headline">¶</a></h3>
<p>Various installation guides for installing from GIT and for other operating systems are maintained at:
<a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Suricata_Installation">https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Suricata_Installation</a></p>
</div>
</div>
<span id="document-upgrade"></span><div class="section" id="upgrading">
<h2>Upgrading<a class="headerlink" href="#upgrading" title="Permalink to this headline">¶</a></h2>
<div class="section" id="general-instructions">
<h3>General instructions<a class="headerlink" href="#general-instructions" title="Permalink to this headline">¶</a></h3>
<p>Suricata can be upgraded by simply installing the new version to the same
locations as the already installed version. When installing from source,
this means passing the same <code class="docutils literal notranslate"><span class="pre">--prefix</span></code>, <code class="docutils literal notranslate"><span class="pre">--sysconfdir</span></code>,
<code class="docutils literal notranslate"><span class="pre">--localstatedir</span></code> and <code class="docutils literal notranslate"><span class="pre">--datadir</span></code> options to <code class="docutils literal notranslate"><span class="pre">configure</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ suricata --build-info|grep -A 3 &#39;\-\-prefix&#39;
    --prefix                                 /usr
    --sysconfdir                             /etc
    --localstatedir                          /var
    --datarootdir                            /usr/share
</pre></div>
</div>
<div class="section" id="configuration-updates">
<h4>Configuration Updates<a class="headerlink" href="#configuration-updates" title="Permalink to this headline">¶</a></h4>
<p>New versions of Suricata will occasionally include updated config files:
<code class="docutils literal notranslate"><span class="pre">classification.config</span></code> and <code class="docutils literal notranslate"><span class="pre">reference.config</span></code>. Since the Suricata
installation will not overwrite these if they exist, they must be manually
updated. If there are no local modifications they can simply be overwritten
by the ones Suricata supplies.</p>
<p>Major updates include new features, new default settings and often also remove
features. This upgrade guide covers the changes that might have an impact of
migrating from an older version and keeping the config. We encourage you to
also check all the new features that have been added but are not covered by
this guide. Those features are either not enabled by default or require
dedicated new configuration.</p>
</div>
</div>
<div class="section" id="upgrading-6-0-to-7-0">
<h3>Upgrading 6.0 to 7.0<a class="headerlink" href="#upgrading-6-0-to-7-0" title="Permalink to this headline">¶</a></h3>
<div class="section" id="major-changes">
<h4>Major changes<a class="headerlink" href="#major-changes" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Upgrade of PCRE1 to PCRE2. See <a class="reference internal" href="index.html#pcre-update-v1-to-v2"><span class="std std-ref">Changes from PCRE1 to PCRE2</span></a> for more details.</li>
<li>IPS users: by default various new &quot;exception policies&quot; are set to DROP
traffic. Please see <a class="reference internal" href="index.html#exception-policies"><span class="std std-ref">Exception Policies</span></a> for details
on the settings and their scope. For trouble shooting, please check <a class="reference external" href="https://forum.suricata.io/t/my-traffic-gets-blocked-after-upgrading-to-suricata-7">My traffic gets
blocked after upgrading to Suricata 7</a>.</li>
<li>New protocols enabled by default: bittorrent-dht, quic, http2.</li>
<li>The telnet protocol is also enabled by default, but only for the <code class="docutils literal notranslate"><span class="pre">app-layer</span></code>.</li>
</ul>
</div>
<div class="section" id="security-changes">
<h4>Security changes<a class="headerlink" href="#security-changes" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>suricata.yaml now prevents process creation by Suricata by default with <cite>security.limit-noproc</cite>.
The suricata.yaml configuration file needs to be updated to enable this feature.
For more info, see <a class="reference internal" href="index.html#suricata-yaml-config-hardening"><span class="std std-ref">Configuration hardening</span></a>.</li>
<li>Absolute filenames and filenames containing parent directory
traversal are no longer allowed by default for datasets when the
filename is specified as part of a rule. See <a class="reference internal" href="index.html#datasets-security"><span class="std std-ref">Datasets Security</span></a> and <a class="reference internal" href="index.html#datasets-file-locations"><span class="std std-ref">Datasets File Locations</span></a> for more information.</li>
<li>Lua rules are now disabled by default (change also introduced in 6.0.13), see <a class="reference internal" href="index.html#lua-detection"><span class="std std-ref">Lua Scripting for Detection</span></a>.</li>
</ul>
</div>
<div class="section" id="removals">
<h4>Removals<a class="headerlink" href="#removals" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The libprelude output plugin has been removed.</li>
<li>EVE DNS v1 logging support has been removed. If still using EVE DNS v1 logging, see the manual section on DNS logging configuration for the current configuration options: <a class="reference internal" href="index.html#output-eve-dns"><span class="std std-ref">DNS EVE Configuration</span></a></li>
</ul>
</div>
<div class="section" id="logging-changes">
<h4>Logging changes<a class="headerlink" href="#logging-changes" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">IKEv2 Eve logging changed, the event_type has become <code class="docutils literal notranslate"><span class="pre">ike</span></code> which covers both protocol versions. The fields <code class="docutils literal notranslate"><span class="pre">errors</span></code> and <code class="docutils literal notranslate"><span class="pre">notify</span></code> have moved to
<code class="docutils literal notranslate"><span class="pre">ike.ikev2.errors</span></code> and <code class="docutils literal notranslate"><span class="pre">ike.ikev2.notify</span></code>.</p>
</li>
<li><p class="first">FTP DATA metadata for alerts are now logged in <code class="docutils literal notranslate"><span class="pre">ftp_data</span></code> instead of root.</p>
</li>
<li><p class="first">Alert <code class="docutils literal notranslate"><span class="pre">xff</span></code> field is now logged as <code class="docutils literal notranslate"><span class="pre">alert.xff</span></code> for alerts instead of at the root.</p>
</li>
<li><p class="first">Protocol values and their names are built into Suricata instead of using the system's <code class="docutils literal notranslate"><span class="pre">/etc/protocols</span></code> file. Some names and casing may have changed
in the values <code class="docutils literal notranslate"><span class="pre">proto</span></code> in <code class="docutils literal notranslate"><span class="pre">eve.json</span></code> log entries and other logs containing protocol names and values.
See <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/4267">https://redmine.openinfosecfoundation.org/issues/4267</a> for more information.</p>
</li>
<li><p class="first">Logging of additional HTTP headers configured through the EVE
<code class="docutils literal notranslate"><span class="pre">http.custom</span></code> option will now be logged in the <code class="docutils literal notranslate"><span class="pre">request_headers</span></code>
and/or <code class="docutils literal notranslate"><span class="pre">response_headers</span></code> respectively instead of merged into the
existing <code class="docutils literal notranslate"><span class="pre">http</span></code> object. In Suricata 6.0, a configuration like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span>
  <span class="n">custom</span><span class="p">:</span> <span class="p">[</span><span class="n">Server</span><span class="p">]</span>
</pre></div>
</div>
<p>would result in a log entry like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;suricata.io&quot;</span><span class="p">,</span>
  <span class="s2">&quot;http_method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
  <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP/1/1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="s2">&quot;nginx&quot;</span><span class="p">,</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This merging of custom headers in the <code class="docutils literal notranslate"><span class="pre">http</span></code> object could result
in custom headers overwriting standard fields in the <code class="docutils literal notranslate"><span class="pre">http</span></code>
object, or a response header overwriting request header.</p>
<p>To prevent the possibility of fields being overwritten, <strong>all</strong>
custom headers are now logged into the <code class="docutils literal notranslate"><span class="pre">request_headers</span></code> and
<code class="docutils literal notranslate"><span class="pre">response_headers</span></code> arrays to avoid any chance of collision.  This
also facilitates the logging of headers that may appear multiple
times, with each occurrence being logged in future releases (see
note below).</p>
<p>While these arrays are not new in Suricata 7.0, they had previously
been used exclusively for the <code class="docutils literal notranslate"><span class="pre">dump-all-headers</span></code> option.</p>
<p>As of Suricata 7.0, the above configuration example will now be
logged like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;suricata.io&quot;</span><span class="p">,</span>
  <span class="s2">&quot;http_method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
  <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP/1/1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;response_headers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Server&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;nginx&quot;</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Effectively making the <code class="docutils literal notranslate"><span class="pre">custom</span></code> option a subset of the
<code class="docutils literal notranslate"><span class="pre">dump-all-headers</span></code> option.</p>
<p>If you've been using the <code class="docutils literal notranslate"><span class="pre">custom</span></code> option, this may represent a
breaking change. However, if you haven't used it, there will be no
change in the output.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Currently, if the same HTTP header is seen multiple times, the
values are concatenated into a comma-separated value.</p>
<p class="last">For more information, refer to:
<a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/1275">https://redmine.openinfosecfoundation.org/issues/1275</a>.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="deprecations">
<h4>Deprecations<a class="headerlink" href="#deprecations" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Multiple &quot;include&quot; fields in the configuration file will now issue a
warning and in Suricata 8.0 will not be supported. See
<a class="reference internal" href="index.html#includes"><span class="std std-ref">Includes</span></a> for documentation on including multiple files.</li>
<li>For AF-Packet, the <cite>cluster_rollover</cite> setting is no longer supported. Configuration settings using <code class="docutils literal notranslate"><span class="pre">cluster_rollover</span></code>
will cause a warning message and act as though <cite>cluster_flow`</cite> was specified. Please update your configuration settings.</li>
</ul>
</div>
<div class="section" id="other-changes">
<h4>Other changes<a class="headerlink" href="#other-changes" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Experimental keyword <cite>http2.header</cite> is removed. <cite>http.header</cite>, <cite>http.request_header</cite>, and <cite>http.response_header</cite> are to be used.</li>
<li>NSS is no longer required. File hashing and JA3 can now be used without the NSS compile time dependency.</li>
<li>If installing Suricata without the bundled Suricata-Update, the <code class="docutils literal notranslate"><span class="pre">default-rule-path</span></code> has been changed from <code class="docutils literal notranslate"><span class="pre">/etc/suricata/rules</span></code> to <code class="docutils literal notranslate"><span class="pre">/var/lib/suricata/rules</span></code> to be consistent with Suricata when installed with Suricata-Update.</li>
<li>FTP has been updated with a maximum command request and response line length of 4096 bytes. To change the default see <a class="reference internal" href="index.html#suricata-yaml-configure-ftp"><span class="std std-ref">FTP</span></a>.</li>
<li>SWF decompression in http has been disabled by default. To change the default see <a class="reference internal" href="index.html#suricata-yaml-configure-libhtp"><span class="std std-ref">Configure HTTP (libhtp)</span></a>. Users with configurations from previous releases may want to modify their config to match the new default.
See <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/5632">https://redmine.openinfosecfoundation.org/issues/5632</a> for more information.</li>
<li>The new option <cite>livedev</cite> is enabled by default with <cite>use-for-tracking</cite> being set to <cite>true</cite>. This should be disabled if multiple live devices are used to capture traffic from the same network.</li>
</ul>
</div>
</div>
<div class="section" id="upgrading-5-0-to-6-0">
<h3>Upgrading 5.0 to 6.0<a class="headerlink" href="#upgrading-5-0-to-6-0" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>SIP now enabled by default</li>
<li>RDP now enabled by default</li>
<li>ERSPAN Type I enabled by default.</li>
</ul>
<div class="section" id="id1">
<h4>Major changes<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>New protocols enabled by default: mqtt, rfb</li>
<li>SSH Client fingerprinting for SSH clients</li>
<li>Conditional logging</li>
<li>Initial HTTP/2 support</li>
<li>DCERPC logging</li>
<li>Improved EVE logging performance</li>
</ul>
</div>
<div class="section" id="id2">
<h4>Removals<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>File-store v1 has been removed. If using file extraction, the file-store configuration
will need to be updated to version 2. See <a class="reference internal" href="index.html#filestore-update-v1-to-v2"><span class="std std-ref">Update File-store v1 Configuration to V2</span></a>.</li>
<li>Individual Eve (JSON) loggers have been removed. For example,
<code class="docutils literal notranslate"><span class="pre">stats-json</span></code>, <code class="docutils literal notranslate"><span class="pre">dns-json</span></code>, etc. Use multiple Eve logger instances
if this behavior is still required. See <a class="reference internal" href="index.html#multiple-eve-instances"><span class="std std-ref">Multiple Logger Instances</span></a>.</li>
<li>Unified2 has been removed. See <a class="reference internal" href="index.html#unified2-removed"><span class="std std-ref">Unified2 Output Removed</span></a>.</li>
</ul>
</div>
</div>
<div class="section" id="upgrading-4-1-to-5-0">
<h3>Upgrading 4.1 to 5.0<a class="headerlink" href="#upgrading-4-1-to-5-0" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id3">
<h4>Major changes<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>New protocols enabled by default: snmp (new config only)</li>
<li>New protocols disabled by default: rdp, sip</li>
<li>New defaults for protocols: nfs, smb, tftp, krb5 ntp are all enabled
by default (new config only)</li>
<li>VXLAN decoder enabled by default. To disable, set
<code class="docutils literal notranslate"><span class="pre">decoder.vxlan.enabled</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</li>
<li>HTTP LZMA support enabled by default. To disable, set <code class="docutils literal notranslate"><span class="pre">lzma-enabled</span></code>
to <code class="docutils literal notranslate"><span class="pre">false</span></code> in each of the <code class="docutils literal notranslate"><span class="pre">libhtp</span></code> configurations in use.</li>
<li>classification.config updated. ET 5.0 ruleset will use this.</li>
<li>decoder event counters use 'decoder.event' as prefix now. This can
be controlled using the <code class="docutils literal notranslate"><span class="pre">stats.decoder-events-prefix</span></code> setting.</li>
</ul>
</div>
<div class="section" id="id4">
<h4>Removals<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">dns-log</span></code>, the text dns log. Use EVE.dns instead.</li>
<li><code class="docutils literal notranslate"><span class="pre">file-log</span></code>, the non-EVE JSON file log. Use EVE.files instead.</li>
<li><code class="docutils literal notranslate"><span class="pre">drop-log</span></code>, the non-EVE JSON drop log.</li>
</ul>
<p>See <a class="reference external" href="https://suricata.io/about/deprecation-policy/">https://suricata.io/about/deprecation-policy/</a></p>
</div>
</div>
</div>
<span id="document-security"></span><div class="section" id="security-considerations">
<h2>Security Considerations<a class="headerlink" href="#security-considerations" title="Permalink to this headline">¶</a></h2>
<p>Suricata is a security tool that processes untrusted network data, as
well as requiring elevated system privileges to acquire that
data. This combination deserves extra security precautions that we
discuss below.</p>
<p>Additionally, supply chain attacks, particularly around rule
distribution, could potentially target Suricata installations.</p>
<div class="section" id="running-as-a-user-other-than-root">
<h3>Running as a User Other Than Root<a class="headerlink" href="#running-as-a-user-other-than-root" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If using the Suricata RPMs, either from the OISF COPR repo,
or the EPEL repo, the following is already configured for
you. The only thing you might want to do is add your
management user to the <code class="docutils literal notranslate"><span class="pre">suricata</span></code> group.</p>
</div>
<p>Many Suricata examples and guides will show Suricata running as the
<em>root</em> user, particularly when running on live traffic. As Suricata
generally needs low level read (and in IPS write) access to network
traffic, it is required that Suricata starts as root, however Suricata
does have the ability to drop down to a non-root user after startup,
which could limit the impact of a security vulnerability in Suricata
itself.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently the ability to drop root privileges after startup
is only available on Linux systems.</p>
</div>
<div class="section" id="create-user">
<h4>Create User<a class="headerlink" href="#create-user" title="Permalink to this headline">¶</a></h4>
<p>Before running as a non-root user, you need to choose and possibly
create the user and group that will Suricata will run as. Typically
this user would be a sytem user with the name <code class="docutils literal notranslate"><span class="pre">suricata</span></code>. Such a
user can be created with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">useradd</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="n">home</span> <span class="o">--</span><span class="n">system</span> <span class="o">--</span><span class="n">shell</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span> <span class="n">suricata</span>
</pre></div>
</div>
<p>This will create a user and group with the name <code class="docutils literal notranslate"><span class="pre">suricata</span></code>.</p>
</div>
<div class="section" id="file-system-permissions">
<h4>File System Permissions<a class="headerlink" href="#file-system-permissions" title="Permalink to this headline">¶</a></h4>
<p>Before running Suricata as the user <code class="docutils literal notranslate"><span class="pre">suricata</span></code>, some directory
permissions will need to be updated to allow the <code class="docutils literal notranslate"><span class="pre">suricata</span></code> read and
write access.</p>
<p>Assuming your Suricata was installed from source using the recommended
configuration of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span> <span class="o">--</span><span class="n">sysconfdir</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span> <span class="o">--</span><span class="n">localstatedir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span>
</pre></div>
</div>
<p>the following directories will need their permissions updated:</p>
<table border="1" class="docutils">
<colgroup>
<col width="62%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Directory</th>
<th class="head">Permissions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>/etc/suricata</td>
<td>Read</td>
</tr>
<tr class="row-odd"><td>/var/log/suricata</td>
<td>Read, Write</td>
</tr>
<tr class="row-even"><td>/var/lib/suricata</td>
<td>Read, Write</td>
</tr>
<tr class="row-odd"><td>/var/run/suricata</td>
<td>Read, Write</td>
</tr>
</tbody>
</table>
<p>The following commands will setup the correct permissions:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">/etc/suricata</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chgrp</span> <span class="o">-</span><span class="n">R</span> <span class="n">suricata</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span>
<span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="n">g</span><span class="o">+</span><span class="n">r</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">/var/log/suricata</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chgrp</span> <span class="o">-</span><span class="n">R</span> <span class="n">suricata</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span>
<span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="n">g</span><span class="o">+</span><span class="n">rw</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">/var/lib/suricata</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chgrp</span> <span class="o">-</span><span class="n">R</span> <span class="n">suricata</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">suricata</span>
<span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="n">g</span><span class="o">+</span><span class="n">srw</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">suricata</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">/var/lib/suricata</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chgrp</span> <span class="o">-</span><span class="n">R</span> <span class="n">suricata</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">suricata</span>
<span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="n">g</span><span class="o">+</span><span class="n">srw</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">suricata</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="configure-suricata-to-run-as-suricata">
<h4>Configure Suricata to Run as <code class="docutils literal notranslate"><span class="pre">Suricata</span></code><a class="headerlink" href="#configure-suricata-to-run-as-suricata" title="Permalink to this headline">¶</a></h4>
<p>Suricata can be configured to run as an alternate user by updating the
configuration file or using command line arguments.</p>
<ul>
<li><p class="first">Using the configuration file, update the <code class="docutils literal notranslate"><span class="pre">run-as</span></code> section to look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="o">-</span><span class="k">as</span><span class="p">:</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">suricata</span>
  <span class="n">group</span><span class="p">:</span> <span class="n">suricata</span>
</pre></div>
</div>
</li>
<li><p class="first">Or if using command line arguments, add the following to your command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">user</span> <span class="n">suricata</span> <span class="o">--</span><span class="n">group</span> <span class="n">suricata</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="starting-suricata">
<h4>Starting Suricata<a class="headerlink" href="#starting-suricata" title="Permalink to this headline">¶</a></h4>
<p>It is important to note that Suricata still needs to be started with
<strong>root</strong> permissions in most cases. Starting as <em>root</em> allows Suricata
to get access to the network interfaces and set the <em>capabilities</em>
required during runtime before it switches down to the configured
user.</p>
</div>
<div class="section" id="other-commands-suricata-update-suricatasc">
<h4>Other Commands: Suricata-Update, SuricataSC<a class="headerlink" href="#other-commands-suricata-update-suricatasc" title="Permalink to this headline">¶</a></h4>
<p>With the previous permissions setup, <code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> and
<code class="docutils literal notranslate"><span class="pre">suricatasc</span></code> can also be run without root or sudo. To allow a user
to access these commands, add them to the <code class="docutils literal notranslate"><span class="pre">suricata</span></code> group.</p>
</div>
</div>
<div class="section" id="containers">
<h3>Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h3>
<p>Containers such as Docker and Podman are other methods to provide
isolation between Suricata and the host machine running Suricata.
However, we still recommend running as a non-root user, even in
containers.</p>
<div class="section" id="capabilities">
<h4>Capabilities<a class="headerlink" href="#capabilities" title="Permalink to this headline">¶</a></h4>
<p>For both Docker and Podman the following capabilities should be
provided to the container running Suricata for proper operation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">cap</span><span class="o">-</span><span class="n">add</span><span class="o">=</span><span class="n">net_admin</span> <span class="o">--</span><span class="n">cap</span><span class="o">-</span><span class="n">add</span><span class="o">=</span><span class="n">net_raw</span> <span class="o">--</span><span class="n">cap</span><span class="o">-</span><span class="n">add</span><span class="o">=</span><span class="n">sys_nice</span>
</pre></div>
</div>
</div>
<div class="section" id="podman">
<h4>Podman<a class="headerlink" href="#podman" title="Permalink to this headline">¶</a></h4>
<p>Unfortunately Suricata will not work with <em>rootless</em> Podman, this is
due to Suricata's requirement to start with root privileges to gain
access to the network interfaces. However, if started with the above
capabilities, and configured to run as a non-root user, it will drop
root privileges before processing network data.</p>
</div>
</div>
</div>
<span id="document-support-status"></span><div class="section" id="support-status">
<h2>Support Status<a class="headerlink" href="#support-status" title="Permalink to this headline">¶</a></h2>
<div class="section" id="levels-of-support">
<h3>Levels of Support<a class="headerlink" href="#levels-of-support" title="Permalink to this headline">¶</a></h3>
<p>The support tiers detailed below do not represent a binding
commitment. Instead, they serve as a framework that the OISF employs
to prioritize features and functionality.</p>
<div class="section" id="tier-1">
<h4>Tier 1<a class="headerlink" href="#tier-1" title="Permalink to this headline">¶</a></h4>
<p>Tier 1 supported items are developed and supported by the Suricata
team. These items receive full CI (continuous integration)
coverage, and functional failures block git merges and releases. Tier
1 features are enabled by default on platforms that support the
feature.</p>
</div>
<div class="section" id="tier-2">
<h4>Tier 2<a class="headerlink" href="#tier-2" title="Permalink to this headline">¶</a></h4>
<p>Tier 2 supported items are developed and supported by the Suricata
team, sometimes with help from community members. Major functional
failures block git merges and releases, however less major issues
may be documented as &quot;known issues&quot; and may go into a release. Tier 2
features and functionality may be disabled by default.</p>
</div>
<div class="section" id="community">
<h4>Community<a class="headerlink" href="#community" title="Permalink to this headline">¶</a></h4>
<p>When a feature of Suricata is community supported, it means the
OISF/Suricata development team won’t directly support it. This is to
avoid overloading the team.</p>
<p>When accepting a feature into the code base anyway, it will come with
a number of limits and conditions:</p>
<ul class="simple">
<li>submitter must commit to maintaining it:<ul>
<li>make sure code compiles and correctly functions after Suricata
and/or external (e.g. library) changes.</li>
<li>support users when they encounter problems on forum and
redmine tickets.</li>
</ul>
</li>
<li>the code will be disabled by default and will not become part of the
QA setup. This means it will be enabled only by an <code class="docutils literal notranslate"><span class="pre">--enable</span></code>
configure flag.</li>
<li>the code may not have CI coverage by the OISF infrastructure.</li>
</ul>
<p>If the feature gets lots of traction, and/or if the team just
considers it very useful, it may get ‘promoted’ to being officially
supported.</p>
<p>On the other hand, the feature will be removed if the submitter stops
maintaining it and no-one steps up to take over.</p>
</div>
<div class="section" id="vendor">
<h4>Vendor<a class="headerlink" href="#vendor" title="Permalink to this headline">¶</a></h4>
<p>Vendor supported features are features specific to a certain vendor
and usually require software and/or hardware from that vendor. While
these features may exist in the main Suricata code, they rely on
support from the vendor to keep the feature in a functional state.</p>
<p>Vendor supported functionality will generally not have CI or QA
coverage by the OISF.</p>
</div>
<div class="section" id="unmaintained">
<h4>Unmaintained<a class="headerlink" href="#unmaintained" title="Permalink to this headline">¶</a></h4>
<p>When a feature is unmaintained it is very likely broken and may be
(partially) removed during cleanups and code refactoring. No end-user
support is done by the core team. If someone wants to help maintain
and support such a feature, we recommend talking to the core team
before spending a lot of time on it.</p>
<p>Please see <a class="reference internal" href="index.html#document-devguide/codebase/contributing/contribution-process"><span class="doc">Contributing to Suricata</span></a>
for more information if you wish to contribute.</p>
</div>
</div>
<div class="section" id="distributions">
<h3>Distributions<a class="headerlink" href="#distributions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>Tier 1<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>These tier 1 supported Linux distributions and operating systems
receive full CI and QA, as well as documentation.</p>
<table border="1" class="colwidths-given docutils" style="width: 100%">
<colgroup>
<col width="20%" />
<col width="15%" />
<col width="15%" />
<col width="10%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Distribution</th>
<th class="head">Version</th>
<th class="head">Support</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>RHEL/CentOS</td>
<td>7</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>RHEL/Alma/Rocky</td>
<td>8</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>RHEL/Alma/Rocky</td>
<td>9</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Ubuntu</td>
<td>20.04</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Ubuntu</td>
<td>22.04</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Debian</td>
<td>10 (Buster)</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Debian</td>
<td>11 (Bullseye)</td>
<td>OISF</td>
<td>&#160;</td>
<td>Foundation of SELKS</td>
</tr>
<tr class="row-odd"><td>Debian</td>
<td>12 (Bookworm)</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>FreeBSD</td>
<td>12</td>
<td>OISF</td>
<td>&#160;</td>
<td>Foundation of OPNsense, pfSense</td>
</tr>
<tr class="row-odd"><td>FreeBSD</td>
<td>13</td>
<td>OISF</td>
<td>&#160;</td>
<td>Foundation of OPNSense</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id2">
<h4>Tier 2<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>These tier 2 supported Linux distributions and operating systems
receive CI but not full QA (functional testing).</p>
<table border="1" class="colwidths-given docutils" style="width: 100%">
<colgroup>
<col width="20%" />
<col width="15%" />
<col width="15%" />
<col width="10%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Distribution</th>
<th class="head">Version</th>
<th class="head">Support</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CentOS</td>
<td>Stream</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Fedora</td>
<td>Active</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>OpenBSD</td>
<td>7.2</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>OpenBSD</td>
<td>7.1</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>OSX/macOS</td>
<td>??</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Windows/MinGW64</td>
<td>&#160;</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="architecture-support">
<h3>Architecture Support<a class="headerlink" href="#architecture-support" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id3">
<h4>Tier 1<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-given docutils" style="width: 100%">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Architecture</th>
<th class="head">Support</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>x86_64</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>ARM8-64bit</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h4>Tier 2<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-given docutils" style="width: 100%">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Architecture</th>
<th class="head">Support</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ARM7-32bit</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>i386</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id5">
<h4>Community<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-given docutils" style="width: 100%">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Architecture</th>
<th class="head">Support</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>PPC64el</td>
<td>&#160;</td>
<td>Part of Fedora automated QA</td>
<td>Access can be arranged through IBM dev cloud</td>
</tr>
<tr class="row-odd"><td>PPC64</td>
<td>&#160;</td>
<td>&#160;</td>
<td>No access to working hardware</td>
</tr>
<tr class="row-even"><td>PPC32</td>
<td>&#160;</td>
<td>&#160;</td>
<td>No access to working hardware</td>
</tr>
<tr class="row-odd"><td>RISC-V</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="high-level-features">
<h4>High Level Features<a class="headerlink" href="#high-level-features" title="Permalink to this headline">¶</a></h4>
<div class="section" id="capture-support">
<h5>Capture support<a class="headerlink" href="#capture-support" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id6">
<h6>Tier 1<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h6>
<table border="1" class="docutils" style="width: 100%">
<colgroup>
<col width="22%" />
<col width="34%" />
<col width="5%" />
<col width="39%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Capture Type</th>
<th class="head">Maintainer</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AF_PACKET</td>
<td>OISF</td>
<td>&#160;</td>
<td>Used by Security Onion, SELKS</td>
</tr>
<tr class="row-odd"><td>NETMAP (FreeBSD)</td>
<td>OISF</td>
<td>&#160;</td>
<td>Used by OPNsense, PFsense</td>
</tr>
<tr class="row-even"><td>NFQUEUE</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>libpcap</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id7">
<h6>Tier 2<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h6>
<table border="1" class="docutils" style="width: 100%">
<colgroup>
<col width="31%" />
<col width="39%" />
<col width="6%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Capture Type</th>
<th class="head">Maintainer</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>PF_RING</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>NETMAP (Linux)</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>DPDK</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>AF_PACKET (eBPF/XDP)</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id8">
<h6>Community<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h6>
<table border="1" class="docutils" style="width: 100%">
<colgroup>
<col width="31%" />
<col width="40%" />
<col width="6%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Capture Type</th>
<th class="head">Maintainer</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>NFLOG</td>
<td>Community</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>AF_XDP</td>
<td>Community</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id9">
<h6>Vendor<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h6>
<table border="1" class="docutils" style="width: 100%">
<colgroup>
<col width="31%" />
<col width="40%" />
<col width="6%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Capture Type</th>
<th class="head">Maintainer</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Napatech</td>
<td>Napatech / Community</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id10">
<h6>Unmaintained<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h6>
<table border="1" class="docutils" style="width: 100%">
<colgroup>
<col width="25%" />
<col width="42%" />
<col width="7%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Capture Type</th>
<th class="head">Maintainer</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>IPFW</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Endace/DAG</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="operation-modes">
<h5>Operation modes<a class="headerlink" href="#operation-modes" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id11">
<h6>Tier 1<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h6>
<table border="1" class="colwidths-given docutils" style="width: 100%">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="10%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Mode</th>
<th class="head">Maintainer</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>IDS (passive)</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>IPS (active)</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Offline pcap file</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id12">
<h6>Tier 2<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h6>
<table border="1" class="colwidths-given docutils" style="width: 100%">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="10%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Mode</th>
<th class="head">Maintainer</th>
<th class="head">QA</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Unix socket mode</td>
<td>OISF</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>IDS (active)</td>
<td>OISF</td>
<td>&#160;</td>
<td>Active responses, reject keyword</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<span id="document-command-line-options"></span><div class="section" id="command-line-options">
<h2>Command Line Options<a class="headerlink" href="#command-line-options" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
</div>
<p>Suricata's command line options:</p>
<dl class="option">
<dt id="cmdoption-h">
<code class="descname">-h</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-h" title="Permalink to this definition">¶</a></dt>
<dd><p>Display a brief usage overview.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-v">
<code class="descname">-V</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-v" title="Permalink to this definition">¶</a></dt>
<dd><p>Displays the version of Suricata.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-c">
<code class="descname">-c</code><code class="descclassname"> &lt;path&gt;</code><a class="headerlink" href="#cmdoption-c" title="Permalink to this definition">¶</a></dt>
<dd><p>Path to configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-include">
<code class="descname">--include</code><code class="descclassname"> &lt;path&gt;</code><a class="headerlink" href="#cmdoption-include" title="Permalink to this definition">¶</a></dt>
<dd><p>Additional configuration files to include. Multiple additional
configuration files can be provided and will be included in the
order specified on the command line.  These additional configuration
files are loaded as if they existed at the end of the main
configuration file.</p>
<p>Example including one additional file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">other</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>Example including more than one additional file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">other</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">extra</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="cmdoption-t">
<code class="descname">-T</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-t" title="Permalink to this definition">¶</a></dt>
<dd><p>Test configuration.</p>
</dd></dl>

<span class="target" id="cmdline-option-v"></span><dl class="option">
<dt id="id1">
<code class="descname">-v</code><code class="descclassname"></code><a class="headerlink" href="#id1" title="Permalink to this definition">¶</a></dt>
<dd><p>Increase the verbosity of the Suricata application logging by
increasing the log level from the default. This option can be
passed multiple times to further increase the verbosity.</p>
<ul class="simple">
<li>-v: INFO</li>
<li>-vv: PERF</li>
<li>-vvv: CONFIG</li>
<li>-vvvv: DEBUG</li>
</ul>
<p>This option will not decrease the log level set in the
configuration file if it is already more verbose than the level
requested with this option.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-r">
<code class="descname">-r</code><code class="descclassname"> &lt;path&gt;</code><a class="headerlink" href="#cmdoption-r" title="Permalink to this definition">¶</a></dt>
<dd><p>Run in pcap offline mode (replay mode) reading files from pcap file. If
&lt;path&gt; specifies a directory, all files in that directory will be processed
in order of modified time maintaining flow state between files.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-file-continuous">
<code class="descname">--pcap-file-continuous</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-pcap-file-continuous" title="Permalink to this definition">¶</a></dt>
<dd><p>Used with the -r option to indicate that the mode should stay alive until
interrupted. This is useful with directories to add new files and not reset
flow state between files.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-file-recursive">
<code class="descname">--pcap-file-recursive</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-pcap-file-recursive" title="Permalink to this definition">¶</a></dt>
<dd><p>Used with the -r option when the path provided is a directory.  This option
enables recursive traversal into subdirectories to a maximum depth of 255.
This option cannot be combined with --pcap-file-continuous.  Symlinks are
ignored.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-file-delete">
<code class="descname">--pcap-file-delete</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-pcap-file-delete" title="Permalink to this definition">¶</a></dt>
<dd><p>Used with the -r option to indicate that the mode should delete pcap files
after they have been processed. This is useful with pcap-file-continuous to
continuously feed files to a directory and have them cleaned up when done. If
this option is not set, pcap files will not be deleted after processing.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-i">
<code class="descname">-i</code><code class="descclassname"> &lt;interface&gt;</code><a class="headerlink" href="#cmdoption-i" title="Permalink to this definition">¶</a></dt>
<dd><p>After the -i option you can enter the interface card you would like
to use to sniff packets from.  This option will try to use the best
capture method available. Can be used several times to sniff packets from
several interfaces.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap">
<code class="descname">--pcap[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-pcap" title="Permalink to this definition">¶</a></dt>
<dd><p>Run in PCAP mode. If no device is provided the interfaces
provided in the <em>pcap</em> section of the configuration file will be
used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-af-packet">
<code class="descname">--af-packet[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-af-packet" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable capture of packet using AF_PACKET on Linux. If no device is
supplied, the list of devices from the af-packet section in the
yaml is used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-af-xdp">
<code class="descname">--af-xdp[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-af-xdp" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable capture of packet using AF_XDP on Linux. If no device is
supplied, the list of devices from the af-xdp section in the
yaml is used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-q">
<code class="descname">-q</code><code class="descclassname"> &lt;queue id&gt;</code><a class="headerlink" href="#cmdoption-q" title="Permalink to this definition">¶</a></dt>
<dd><p>Run inline of the NFQUEUE queue ID provided. May be provided
multiple times.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-s">
<code class="descname">-s</code><code class="descclassname"> &lt;filename.rules&gt;</code><a class="headerlink" href="#cmdoption-s" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -s option you can set a file with signatures, which will
be loaded together with the rules set in the yaml.</p>
<p>It is possible to use globbing when specifying rules files.
For example, <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">'/path/to/rules/*.rules'</span></code></p>
</dd></dl>

<dl class="option">
<dt id="id2">
<code class="descname">-S</code><code class="descclassname"> &lt;filename.rules&gt;</code><a class="headerlink" href="#id2" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -S option you can set a file with signatures, which will
be loaded exclusively, regardless of the rules set in the yaml.</p>
<p>It is possible to use globbing when specifying rules files.
For example, <code class="docutils literal notranslate"><span class="pre">-S</span> <span class="pre">'/path/to/rules/*.rules'</span></code></p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-l">
<code class="descname">-l</code><code class="descclassname"> &lt;directory&gt;</code><a class="headerlink" href="#cmdoption-l" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -l option you can set the default log directory. If you
already have the default-log-dir set in yaml, it will not be used
by Suricata if you use the -l option. It will use the log dir that
is set with the -l option. If you do not set a directory with
the -l option, Suricata will use the directory that is set in yaml.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-d">
<code class="descname">-D</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-d" title="Permalink to this definition">¶</a></dt>
<dd><p>Normally if you run Suricata on your console, it keeps your console
occupied. You can not use it for other purposes, and when you close
the window, Suricata stops running.  If you run Suricata as daemon
(using the -D option), it runs at the background and you will be
able to use the console for other tasks without disturbing the
engine running.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-runmode">
<code class="descname">--runmode</code><code class="descclassname"> &lt;runmode&gt;</code><a class="headerlink" href="#cmdoption-runmode" title="Permalink to this definition">¶</a></dt>
<dd><p>With the <em>--runmode</em> option you can set the runmode that you would
like to use. This command line option can override the yaml runmode
option.</p>
<p>Runmodes are: <em>workers</em>, <em>autofp</em> and <em>single</em>.</p>
<p>For more information about runmodes see <a class="reference internal" href="index.html#document-performance/runmodes"><span class="doc">Runmodes</span></a> in the user guide.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-f">
<code class="descname">-F</code><code class="descclassname"> &lt;bpf filter file&gt;</code><a class="headerlink" href="#cmdoption-f" title="Permalink to this definition">¶</a></dt>
<dd><p>Use BPF filter from file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-k">
<code class="descname">-k</code><code class="descclassname"> [all|none]</code><a class="headerlink" href="#cmdoption-k" title="Permalink to this definition">¶</a></dt>
<dd><p>Force (all) the checksum check or disable (none) all checksum
checks.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-user">
<code class="descname">--user</code><code class="descclassname">=&lt;user&gt;</code><a class="headerlink" href="#cmdoption-user" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the process user after initialization. Overrides the user
provided in the <em>run-as</em> section of the configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-group">
<code class="descname">--group</code><code class="descclassname">=&lt;group&gt;</code><a class="headerlink" href="#cmdoption-group" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the process group to group after initialization. Overrides the
group provided in the <em>run-as</em> section of the configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pidfile">
<code class="descname">--pidfile</code><code class="descclassname"> &lt;file&gt;</code><a class="headerlink" href="#cmdoption-pidfile" title="Permalink to this definition">¶</a></dt>
<dd><p>Write the process ID to file. Overrides the <em>pid-file</em> option in
the configuration file and forces the file to be written when not
running as a daemon.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-init-errors-fatal">
<code class="descname">--init-errors-fatal</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-init-errors-fatal" title="Permalink to this definition">¶</a></dt>
<dd><p>Exit with a failure when errors are encountered loading signatures.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-strict-rule-keywords">
<code class="descname">--strict-rule-keywords[</code><code class="descclassname">=all|&lt;keyword&gt;|&lt;keywords(csv)]</code><a class="headerlink" href="#cmdoption-strict-rule-keywords" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies to: classtype, reference and app-layer-event.</p>
<p>By default missing reference or classtype values are warnings and
not errors. Additionally, loading outdated app-layer-event events are
also not treated as errors, but as warnings instead.</p>
<p>If this option is enabled these warnings are considered errors.</p>
<p>If no value, or the value 'all', is specified, the option applies to
all of the keywords above. Alternatively, a comma separated list can
be supplied with the keyword names it should apply to.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-disable-detection">
<code class="descname">--disable-detection</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-disable-detection" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable the detection engine.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-disable-hashing">
<code class="descname">--disable-hashing</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-disable-hashing" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable support for hash algorithms such as md5, sha1 and sha256.</p>
<p>By default hashing is enabled. Disabling hashing will also disable some
Suricata features such as the filestore, ja3, and rule keywords that use hash
algorithms.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dump-config">
<code class="descname">--dump-config</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-dump-config" title="Permalink to this definition">¶</a></dt>
<dd><p>Dump the configuration loaded from the configuration file to the
terminal and exit.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dump-features">
<code class="descname">--dump-features</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-dump-features" title="Permalink to this definition">¶</a></dt>
<dd><p>Dump the features provided by Suricata modules and exit. Features
list (a subset of) the configuration values and are intended to
assist with comparing provided features with those required by
one or more rules.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-build-info">
<code class="descname">--build-info</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-build-info" title="Permalink to this definition">¶</a></dt>
<dd><p>Display the build information the Suricata was built with.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-app-layer-protos">
<code class="descname">--list-app-layer-protos</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-list-app-layer-protos" title="Permalink to this definition">¶</a></dt>
<dd><p>List all supported application layer protocols.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-keywords">
<code class="descname">--list-keywords</code><code class="descclassname">=[all|csv|&lt;kword&gt;]</code><a class="headerlink" href="#cmdoption-list-keywords" title="Permalink to this definition">¶</a></dt>
<dd><p>List all supported rule keywords.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-runmodes">
<code class="descname">--list-runmodes</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-list-runmodes" title="Permalink to this definition">¶</a></dt>
<dd><p>List all supported run modes.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-set">
<code class="descname">--set</code><code class="descclassname"> &lt;key&gt;=&lt;value&gt;</code><a class="headerlink" href="#cmdoption-set" title="Permalink to this definition">¶</a></dt>
<dd><p>Set a configuration value. Useful for overriding basic
configuration parameters. For example, to change the default log
directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="nb">set</span> <span class="n">default</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="nb">dir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span>
</pre></div>
</div>
<p>This option cannot be used to add new entries to a list in the
configuration file, such as a new output. It can only be used to
modify a value in a list that already exists.</p>
<p>For example, to disable the <code class="docutils literal notranslate"><span class="pre">eve-log</span></code> in the default
configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="nb">set</span> <span class="n">outputs</span><span class="mf">.1</span><span class="o">.</span><span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">no</span>
</pre></div>
</div>
<p>Also note that the index values may change as the <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code>
is updated.</p>
<p>See the output of <code class="docutils literal notranslate"><span class="pre">--dump-config</span></code> for existing values that could
be modified with their index.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-engine-analysis">
<code class="descname">--engine-analysis</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-engine-analysis" title="Permalink to this definition">¶</a></dt>
<dd><p>Print reports on analysis of different sections in the engine and
exit. Please have a look at the conf parameter engine-analysis on
what reports can be printed</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-unix-socket">
<code class="descname">--unix-socket</code><code class="descclassname">=&lt;file&gt;</code><a class="headerlink" href="#cmdoption-unix-socket" title="Permalink to this definition">¶</a></dt>
<dd><p>Use file as the Suricata unix control socket. Overrides the
<em>filename</em> provided in the <em>unix-command</em> section of the
configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-reject-dev">
<code class="descname">--reject-dev</code><code class="descclassname">=&lt;device&gt;</code><a class="headerlink" href="#cmdoption-reject-dev" title="Permalink to this definition">¶</a></dt>
<dd><p>Use <em>device</em> to send out RST / ICMP error packets with
the <em>reject</em> keyword.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-buffer-size">
<code class="descname">--pcap-buffer-size</code><code class="descclassname">=&lt;size&gt;</code><a class="headerlink" href="#cmdoption-pcap-buffer-size" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the size of the PCAP buffer (0 - 2147483647).</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-netmap">
<code class="descname">--netmap[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-netmap" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable capture of packet using NETMAP on FreeBSD or Linux. If no
device is supplied, the list of devices from the netmap section
in the yaml is used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pfring">
<code class="descname">--pfring[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-pfring" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable PF_RING packet capture. If no device provided, the devices in
the Suricata configuration will be used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pfring-cluster-id">
<code class="descname">--pfring-cluster-id</code><code class="descclassname"> &lt;id&gt;</code><a class="headerlink" href="#cmdoption-pfring-cluster-id" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the PF_RING cluster ID.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pfring-cluster-type">
<code class="descname">--pfring-cluster-type</code><code class="descclassname"> &lt;type&gt;</code><a class="headerlink" href="#cmdoption-pfring-cluster-type" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the PF_RING cluster type (cluster_round_robin, cluster_flow).</p>
</dd></dl>

<dl class="option">
<dt id="id3">
<code class="descname">-d</code><code class="descclassname"> &lt;divert-port&gt;</code><a class="headerlink" href="#id3" title="Permalink to this definition">¶</a></dt>
<dd><p>Run inline using IPFW divert mode.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dag">
<code class="descname">--dag</code><code class="descclassname"> &lt;device&gt;</code><a class="headerlink" href="#cmdoption-dag" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable packet capture off a DAG card. If capturing off a specific
stream the stream can be select using a device name like
&quot;dag0:4&quot;. This option may be provided multiple times read off
multiple devices and/or streams.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-napatech">
<code class="descname">--napatech</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-napatech" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable packet capture using the Napatech Streams API.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-erf-in">
<code class="descname">--erf-in</code><code class="descclassname">=&lt;file&gt;</code><a class="headerlink" href="#cmdoption-erf-in" title="Permalink to this definition">¶</a></dt>
<dd><p>Run in offline mode reading the specific ERF file (Endace
extensible record format).</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-simulate-ips">
<code class="descname">--simulate-ips</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-simulate-ips" title="Permalink to this definition">¶</a></dt>
<dd><p>Simulate IPS mode when running in a non-IPS mode.</p>
</dd></dl>

<div class="section" id="unit-tests">
<h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h3>
<p>The builtin unittests are only available when Suricata has been configured and built with
<code class="docutils literal notranslate"><span class="pre">--enable-unittests</span></code>.</p>
<p>Running unittests does not require a configuration file. Use -l to supply
an output directory.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">u</span>
</pre></div>
</div>
<dl class="option">
<dt id="cmdoption-u">
<code class="descname">-u</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-u" title="Permalink to this definition">¶</a></dt>
<dd><p>Run the unit tests and exit. Requires that Suricata be configured
with <em>--enable-unittests</em>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-unittest-filter">
<code class="descname">-U</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">--unittest-filter</code><code class="descclassname">=REGEX</code><a class="headerlink" href="#cmdoption-unittest-filter" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -U option you can select which of the unit tests you want
to run. This option uses REGEX. Example of use: suricata -u -U
http</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-unittests">
<code class="descname">--list-unittests</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-list-unittests" title="Permalink to this definition">¶</a></dt>
<dd><p>Lists available unit tests.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-fatal-unittests">
<code class="descname">--fatal-unittests</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-fatal-unittests" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables fatal failure on a unit test error. Suricata will exit
instead of continuing more tests.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-unittests-coverage">
<code class="descname">--unittests-coverage</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-unittests-coverage" title="Permalink to this definition">¶</a></dt>
<dd><p>Display unit test coverage report.</p>
</dd></dl>

</div>
</div>
<span id="document-rules/index"></span><div class="section" id="suricata-rules">
<h2>Suricata Rules<a class="headerlink" href="#suricata-rules" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-rules/intro"></span><div class="section" id="rules-format">
<h3>Rules Format<a class="headerlink" href="#rules-format" title="Permalink to this headline">¶</a></h3>
<p>Signatures play a very important role in Suricata. In most occasions
people are using existing rulesets.</p>
<p>The official way to install rulesets is described in <a class="reference internal" href="index.html#document-rule-management/suricata-update"><span class="doc">Rule Management with Suricata-Update</span></a>.</p>
<p>There are a number of free rulesets that can be used via suricata-update.
To aid in learning about writing rules, the Emerging Threats Open ruleset
is free and a good reference that has a wide range of signature examples.</p>
<p>This Suricata Rules document explains all about signatures; how to
read, adjust and create them.</p>
<p>A rule/signature consists of the following:</p>
<ul class="simple">
<li>The <strong>action</strong>, determining what happens when the rule matches.</li>
<li>The <strong>header</strong>, defining the protocol, IP addresses, ports and direction of
the rule.</li>
<li>The <strong>rule options</strong>, defining the specifics of the rule.</li>
</ul>
<p>An example of a rule is as follows:</p>
<div class="example-rule docutils container">
<span class="example-rule-action">alert</span> <span class="example-rule-header">http $HOME_NET any -&gt; $EXTERNAL_NET any</span>  <span class="example-rule-options">(msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; rev:1;)</span></div>
<p>In this example, <span class="example-rule-action">red</span> is the action,
<span class="example-rule-header">green</span> is the header and <span class="example-rule-options">blue</span>
are the options.</p>
<p>We will be using the above signature as an example throughout
this section, highlighting the different parts of the signature.</p>
<div class="section" id="action">
<span id="actions"></span><h4>Action<a class="headerlink" href="#action" title="Permalink to this headline">¶</a></h4>
<div class="example-rule docutils container">
<span class="example-rule-emphasis">alert</span> http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; rev:1;)</div>
<p>Valid actions are:</p>
<ul class="simple">
<li>alert - generate an alert.</li>
<li>pass - stop further inspection of the packet.</li>
<li>drop - drop packet and generate alert.</li>
<li>reject - send RST/ICMP unreach error to the sender of the matching packet.</li>
<li>rejectsrc - same as just <cite>reject</cite>.</li>
<li>rejectdst - send RST/ICMP error packet to receiver of the matching packet.</li>
<li>rejectboth - send RST/ICMP error packets to both sides of the conversation.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In IPS mode, using any of the <cite>reject</cite> actions also enables <cite>drop</cite>.</p>
</div>
<p>For more information see <a class="reference internal" href="index.html#suricata-yaml-action-order"><span class="std std-ref">Action-order</span></a>.</p>
</div>
<div class="section" id="protocol">
<h4>Protocol<a class="headerlink" href="#protocol" title="Permalink to this headline">¶</a></h4>
<div class="example-rule docutils container">
alert <span class="example-rule-emphasis">http</span> $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; rev:1;)</div>
<p>This keyword in a signature tells Suricata which protocol it
concerns. You can choose between four basic protocols:</p>
<ul class="simple">
<li>tcp (for tcp-traffic)</li>
<li>udp</li>
<li>icmp</li>
<li>ip (ip stands for 'all' or 'any')</li>
</ul>
<p>There are a couple of additional TCP related protocol options:</p>
<ul class="simple">
<li>tcp-pkt (for matching content in individual tcp packets)</li>
<li>tcp-stream (for matching content only in a reassembled tcp stream)</li>
</ul>
<p>There are also a few so-called application layer protocols, or layer 7 protocols
you can pick from. These are:</p>
<ul class="simple">
<li>http (either HTTP1 or HTTP2)</li>
<li>http1</li>
<li>http2</li>
<li>ftp</li>
<li>tls (this includes ssl)</li>
<li>smb</li>
<li>dns</li>
<li>dcerpc</li>
<li>dhcp</li>
<li>ssh</li>
<li>smtp</li>
<li>imap</li>
<li>modbus (disabled by default)</li>
<li>dnp3 (disabled by default)</li>
<li>enip (disabled by default)</li>
<li>nfs</li>
<li>ike</li>
<li>krb5</li>
<li>bittorrent-dht</li>
<li>ntp</li>
<li>dhcp</li>
<li>rfb</li>
<li>rdp</li>
<li>snmp</li>
<li>tftp</li>
<li>sip</li>
</ul>
<p>The availability of these protocols depends on whether the protocol
is enabled in the configuration file, suricata.yaml.</p>
<p>If you have a signature with the protocol declared as 'http', Suricata makes
sure the signature will only match if the TCP stream contains http traffic.</p>
</div>
<div class="section" id="source-and-destination">
<h4>Source and destination<a class="headerlink" href="#source-and-destination" title="Permalink to this headline">¶</a></h4>
<div class="example-rule docutils container">
alert http <span class="example-rule-emphasis">$HOME_NET</span> any -&gt; <span class="example-rule-emphasis">$EXTERNAL_NET</span> any (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; rev:1;)</div>
<p><em>The first emphasized part is the traffic source, the second is the traffic destination (note the direction of the directional arrow).</em></p>
<p>With the source and destination, you specify the source of the traffic and the
destination of the traffic, respectively. You can assign IP addresses,
(both IPv4 and IPv6 are supported) and IP ranges. These can be combined with
operators:</p>
<table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operator</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>../..</td>
<td>IP ranges (CIDR notation)</td>
</tr>
<tr class="row-odd"><td>!</td>
<td>exception/negation</td>
</tr>
<tr class="row-even"><td>[.., ..]</td>
<td>grouping</td>
</tr>
</tbody>
</table>
<p>Normally, you would also make use of variables, such as <code class="docutils literal notranslate"><span class="pre">$HOME_NET</span></code> and
<code class="docutils literal notranslate"><span class="pre">$EXTERNAL_NET</span></code>. The suricata.yaml configuration file specifies the IP addresses these
concern. The respective <code class="docutils literal notranslate"><span class="pre">$HOME_NET</span></code> and <code class="docutils literal notranslate"><span class="pre">$EXTERNAL_NET</span></code> settings will be used in place of the variables in your rules.</p>
<p>See <a class="reference internal" href="index.html#suricata-yaml-rule-vars"><span class="std std-ref">Rule-vars</span></a> for more information.</p>
<p>Rule usage examples:</p>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Example</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>!1.1.1.1</td>
<td>Every IP address but 1.1.1.1</td>
</tr>
<tr class="row-odd"><td>![1.1.1.1, 1.1.1.2]</td>
<td>Every IP address but 1.1.1.1 and 1.1.1.2</td>
</tr>
<tr class="row-even"><td>$HOME_NET</td>
<td>Your setting of HOME_NET in yaml</td>
</tr>
<tr class="row-odd"><td>[$EXTERNAL_NET, !$HOME_NET]</td>
<td>EXTERNAL_NET and not HOME_NET</td>
</tr>
<tr class="row-even"><td>[10.0.0.0/24, !10.0.0.5]</td>
<td>10.0.0.0/24 except for 10.0.0.5</td>
</tr>
<tr class="row-odd"><td>[..., [....]]</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>[..., ![.....]]</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>If you set your configuration to something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>HOME_NET: any
EXTERNAL_NET: !$HOME_NET
</pre></div>
</div>
<p class="last">You cannot write a signature using <code class="docutils literal notranslate"><span class="pre">$EXTERNAL_NET</span></code> because it evaluates to
'not any', which is an invalid value.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please note that the source and destination address can also be matched via the <code class="docutils literal notranslate"><span class="pre">ip.src</span></code> and <code class="docutils literal notranslate"><span class="pre">ip.dst</span></code> keywords (See <a class="reference internal" href="index.html#ipaddr"><span class="std std-ref">IP Addresses Match</span></a>). These
keywords are mostly used in conjunction with the dataset feature (<a class="reference internal" href="index.html#datasets"><span class="std std-ref">Datasets</span></a>).</p>
</div>
</div>
<div class="section" id="ports-source-and-destination">
<h4>Ports (source and destination)<a class="headerlink" href="#ports-source-and-destination" title="Permalink to this headline">¶</a></h4>
<div class="example-rule docutils container">
alert http $HOME_NET <span class="example-rule-emphasis">any</span> -&gt; $EXTERNAL_NET <span class="example-rule-emphasis">any</span> (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; rev:1;)</div>
<p><em>The first emphasized part is the source port, the second is the destination port (note the direction of the directional arrow).</em></p>
<p>Traffic comes in and goes out through ports. Different protocols have
different port numbers. For example, the default port for HTTP is 80 while 443 is
typically the port for HTTPS. Note, however, that the port does not
dictate which protocol is used in the communication. Rather, it determines which
application is receiving the data.</p>
<p>The ports mentioned above are typically the destination ports. Source ports,
i.e. the application that sent the packet, typically get assigned a random
port by the operating system. When writing a rule for your own HTTP service,
you would typically write <code class="docutils literal notranslate"><span class="pre">any</span> <span class="pre">-&gt;</span> <span class="pre">80</span></code>, since that would mean any packet from
any source port to your HTTP application (running on port 80) is matched.</p>
<p>In setting ports you can make use of special operators as well. Operators such as:</p>
<table border="1" class="docutils">
<colgroup>
<col width="44%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operator</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>:</td>
<td>port ranges</td>
</tr>
<tr class="row-odd"><td>!</td>
<td>exception/negation</td>
</tr>
<tr class="row-even"><td>[.., ..]</td>
<td>grouping</td>
</tr>
</tbody>
</table>
<p>Rule usage examples:</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Example</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>[80, 81, 82]</td>
<td>port 80, 81 and 82</td>
</tr>
<tr class="row-odd"><td>[80: 82]</td>
<td>Range from 80 till 82</td>
</tr>
<tr class="row-even"><td>[1024: ]</td>
<td>From 1024 till the highest port-number</td>
</tr>
<tr class="row-odd"><td>!80</td>
<td>Every port but 80</td>
</tr>
<tr class="row-even"><td>[80:100,!99]</td>
<td>Range from 80 till 100 but 99 excluded</td>
</tr>
<tr class="row-odd"><td>[1:80,![2,4]]</td>
<td>Range from 1-80, except ports 2 and 4</td>
</tr>
<tr class="row-even"><td>[.., [..,..]]</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="direction">
<h4>Direction<a class="headerlink" href="#direction" title="Permalink to this headline">¶</a></h4>
<div class="example-rule docutils container">
alert http $HOME_NET any <span class="example-rule-emphasis">-&gt;</span> $EXTERNAL_NET any (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; rev:1;)</div>
<p>The directional arrow indicates which way the signature will be evaluated.
In most signatures an arrow to the right (<code class="docutils literal notranslate"><span class="pre">-&gt;</span></code>) is used. This means that only
packets with the same direction can match. However, it is also possible to
have a rule match both directions (<code class="docutils literal notranslate"><span class="pre">&lt;&gt;</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">-&gt;</span> <span class="n">destination</span>
<span class="n">source</span> <span class="o">&lt;&gt;</span> <span class="n">destination</span>  <span class="p">(</span><span class="n">both</span> <span class="n">directions</span><span class="p">)</span>
</pre></div>
</div>
<p>The following example illustrates direction. In this example there is a client
with IP address 1.2.3.4 using port 1024. A server with IP address 5.6.7.8,
listening on port 80 (typically HTTP). The client sends a message to the server
and the server replies with its answer.</p>
<img alt="_images/TCP-session.png" src="_images/TCP-session.png" />
<p>Now, let's say we have a rule with the following header:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="mf">1.2.3.4</span> <span class="mi">1024</span> <span class="o">-&gt;</span> <span class="mf">5.6.7.8</span> <span class="mi">80</span>
</pre></div>
</div>
<p>Only the traffic from the client to the server will be matched by this rule,
as the direction specifies that we do not want to evaluate the response packet.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There is no 'reverse' style direction, i.e. there is no <code class="docutils literal notranslate"><span class="pre">&lt;-</span></code>.</p>
</div>
</div>
<div class="section" id="rule-options">
<h4>Rule options<a class="headerlink" href="#rule-options" title="Permalink to this headline">¶</a></h4>
<p>The rest of the rule consists of options. These are enclosed by parenthesis
and separated by semicolons. Some options have settings (such as <code class="docutils literal notranslate"><span class="pre">msg</span></code>),
which are specified by the keyword of the option, followed by a colon,
followed by the settings. Others have no settings; they are simply the
keyword (such as <code class="docutils literal notranslate"><span class="pre">nocase</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">keyword</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">settings</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">&lt;</span><span class="n">keyword</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Rule options have a specific ordering and changing their order would change the
meaning of the rule.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The characters <code class="docutils literal notranslate"><span class="pre">;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;</span></code> have special meaning in the
Suricata rule language and must be escaped when used in a
rule option value. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Message with semicolon\;&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p class="last">As a consequence, you must also escape the backslash, as it functions
as an escape character.</p>
</div>
<p>The rest of this chapter in the documentation documents the use of the various
keywords.</p>
<p>Some generic details about keywords follow.</p>
<div class="section" id="modifier-keywords">
<span id="rules-modifiers"></span><h5>Modifier Keywords<a class="headerlink" href="#modifier-keywords" title="Permalink to this headline">¶</a></h5>
<p>Some keywords function act as modifiers. There are two types of modifiers.</p>
<ul>
<li><p class="first">The older style <strong>'content modifiers'</strong> look back in the rule, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;index.php&quot;</span><span class="p">;</span> <span class="n">http_uri</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>In the above example the pattern 'index.php' is modified to inspect the HTTP uri buffer.</p>
</li>
<li><p class="first">The more recent type is called the <strong>'sticky buffer'</strong>. It places the buffer
name first and all keywords following it apply to that buffer, for instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http_response_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;403 Forbidden&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>In the above example the pattern '403 Forbidden' is inspected against the HTTP
response line because it follows the <code class="docutils literal notranslate"><span class="pre">http_response_line</span></code> keyword.</p>
</li>
</ul>
</div>
<div class="section" id="normalized-buffers">
<span id="rules-normalized-buffers"></span><h5>Normalized Buffers<a class="headerlink" href="#normalized-buffers" title="Permalink to this headline">¶</a></h5>
<p>A packet consists of raw data. HTTP and reassembly make a copy of
those kinds of packets data. They erase anomalous content, combine
packets etcetera. What remains is a called the 'normalized buffer':</p>
<img alt="_images/normalization1.png" src="_images/normalization1.png" />
<p>Because the data is being normalized, it is not what it used to be; it
is an interpretation.  Normalized buffers are: all HTTP-keywords,
reassembled streams, TLS-, SSL-, SSH-, FTP- and dcerpc-buffers.</p>
<p>Note that there are some exceptions, e.g. the <code class="docutils literal notranslate"><span class="pre">http_raw_uri</span></code> keyword.
See <a class="reference internal" href="index.html#rules-http-uri-normalization"><span class="std std-ref">http.uri and http.uri.raw</span></a> for more information.</p>
</div>
</div>
</div>
<span id="document-rules/meta"></span><div class="section" id="meta-keywords">
<h3>Meta Keywords<a class="headerlink" href="#meta-keywords" title="Permalink to this headline">¶</a></h3>
<p>Meta keywords have no effect on Suricata's inspection of network traffic;
they do have an effect on the way Suricata reports events/alerts.</p>
<div class="section" id="msg-message">
<h4>msg (message)<a class="headerlink" href="#msg-message" title="Permalink to this headline">¶</a></h4>
<p>The keyword msg gives contextual information about the signature and the possible alert.</p>
<p>The format of msg is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="p">:</span> <span class="s2">&quot;some description&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;ET MALWARE Win32/RecordBreaker CnC Checkin&quot;</span><span class="p">;</span>
<span class="n">msg</span><span class="p">:</span><span class="s2">&quot;ET EXPLOIT SMB-DS DCERPC PnP bind attempt&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>To continue the example from the previous chapter, the msg component of the
signature is emphasized below:</p>
<div class="example-rule docutils container">
alert http $HOME_NET any -&gt; $EXTERNAL_NET any (<span class="example-rule-emphasis">msg:&quot;HTTP GET Request Containing Rule in URI&quot;;</span> flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; rev:1;)</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>It is a standard practice in rule writing to make the first part of the
signature msg uppercase and to indicate the class of the signature.</p>
<p class="last">It is also standard practice that <code class="docutils literal notranslate"><span class="pre">msg</span></code> is the first keyword in the signature.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following characters must be escaped inside the msg:
<code class="docutils literal notranslate"><span class="pre">;</span></code> <code class="docutils literal notranslate"><span class="pre">\</span></code> <code class="docutils literal notranslate"><span class="pre">&quot;</span></code></p>
</div>
</div>
<div class="section" id="sid-signature-id">
<h4>sid (signature ID)<a class="headerlink" href="#sid-signature-id" title="Permalink to this headline">¶</a></h4>
<p>The keyword sid gives every signature its own id. This id is stated with a number
greater than zero. The format of sid is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sid</span><span class="p">:</span><span class="mi">123</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of sid in a signature:</p>
<div class="example-rule docutils container">
alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; <span class="example-rule-emphasis">sid:123;</span> rev:1;)</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>It is a standard practice in rule writing that the signature <code class="docutils literal notranslate"><span class="pre">sid</span></code> is
provided as the last keyword (or second-to-last if there is a <code class="docutils literal notranslate"><span class="pre">rev</span></code>)
of the signature.</p>
<p class="last">There are reserved ranges of sids, the reservations are recorded
at <a class="reference external" href="https://sidallocation.org/">https://sidallocation.org/</a> .</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This value must be unique for all rules within the same <a class="reference internal" href="#gid"><span class="std std-ref">rule group</span></a> (<code class="docutils literal notranslate"><span class="pre">gid</span></code>).</p>
<p class="last">As Suricata-update currently considers the rule's <code class="docutils literal notranslate"><span class="pre">sid</span></code> only (cf. <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/5447">Bug#5447</a>), it is advisable
to opt for a completely unique <code class="docutils literal notranslate"><span class="pre">sid</span></code> altogether.</p>
</div>
</div>
<div class="section" id="rev-revision">
<h4>rev (revision)<a class="headerlink" href="#rev-revision" title="Permalink to this headline">¶</a></h4>
<p>The sid keyword is commonly accompanied by the rev keyword. Rev
represents the version of the signature. If a signature is modified,
the number of rev will be incremented by the signature writers. The
format of rev is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rev</span><span class="p">:</span><span class="mi">123</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of rev in a signature:</p>
<div class="example-rule docutils container">
alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; classtype:bad-unknown; sid:123; <span class="example-rule-emphasis">rev:1;</span>)</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It is a standard practice in rule writing that the rev keyword
is expressed after the sid keyword. The sid and rev keywords
are commonly put as the last two keywords in a signature.</p>
</div>
</div>
<div class="section" id="gid-group-id">
<span id="gid"></span><h4>gid (group ID)<a class="headerlink" href="#gid-group-id" title="Permalink to this headline">¶</a></h4>
<p>The gid keyword can be used to give different groups of
signatures another id value (like in sid). Suricata by default uses gid 1.
It is possible to modify the default value. In most cases, it will be
unnecessary to change the default gid value. Changing the gid value
has no technical implications, the value is only noted in alert data.</p>
<p>Example of the gid value in an alert entry in the fast.log file.
In the part [1:123], the first 1 is the gid (123 is the sid and 1 is the rev).</p>
<div class="example-rule docutils container">
07/12/2022-21:59:26.713297  [**] [<span class="example-rule-emphasis">1</span>:123:1] HTTP GET Request Containing Rule in URI [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 192.168.225.121:12407 -&gt; 172.16.105.84:80</div>
</div>
<div class="section" id="classtype">
<h4>classtype<a class="headerlink" href="#classtype" title="Permalink to this headline">¶</a></h4>
<p>The classtype keyword gives information about the classification of
rules and alerts. It consists of a short name, a long name and a
priority. It can tell for example whether a rule is just informational
or is about a CVE. For each classtype, the classification.config has a
priority that will be used in the rule.</p>
<p>Example classtype definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="n">classification</span><span class="p">:</span> <span class="n">web</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">attack</span><span class="p">,</span><span class="n">Web</span> <span class="n">Application</span> <span class="n">Attack</span><span class="p">,</span><span class="mi">1</span>
<span class="n">config</span> <span class="n">classification</span><span class="p">:</span> <span class="ow">not</span><span class="o">-</span><span class="n">suspicious</span><span class="p">,</span><span class="n">Not</span> <span class="n">Suspicious</span> <span class="n">Traffic</span><span class="p">,</span><span class="mi">3</span>
</pre></div>
</div>
<p>Once we have defined the classification in the configuration file,
we can use the classtypes in our rules. A rule with classtype web-application-attack
will be assigned a priority of 1 and the alert will contain 'Web Application Attack'
in the Suricata logs:</p>
<table border="1" class="docutils">
<colgroup>
<col width="41%" />
<col width="39%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">classtype</th>
<th class="head">Alert</th>
<th class="head">Priority</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>web-application-attack</td>
<td>Web Application Attack</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>not-suspicious</td>
<td>Not Suspicious Traffic</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>Our continuing example also has a classtype: bad-unknown:</p>
<div class="example-rule docutils container">
alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;HTTP GET Request Containing Rule in URI&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;; http.uri; content:&quot;rule&quot;; fast_pattern; <span class="example-rule-emphasis">classtype:bad-unknown;</span> sid:123; rev:1;)</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It is a standard practice in rule writing that the classtype keyword comes
before the sid and rev keywords (as shown in the example rule).</p>
</div>
</div>
<div class="section" id="reference">
<h4>reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h4>
<p>The reference keyword is used to document where information about the
signature and about the problem the signature tries to address can be
found. The reference keyword can appear multiple times in a signature.
This keyword is meant for signature-writers and analysts who
investigate why a signature has matched. It has the following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reference</span><span class="p">:</span><span class="nb">type</span><span class="p">,</span><span class="n">reference</span>
</pre></div>
</div>
<p>A typical reference to www.info.com would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reference</span><span class="p">:</span><span class="n">url</span><span class="p">,</span><span class="n">www</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>There are several systems that can be used as a reference. A
commonly known example is the CVE-database, which assigns numbers to
vulnerabilities, to prevent having to type the same URL over and over
again. An example reference of a CVE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reference</span><span class="p">:</span><span class="n">cve</span><span class="p">,</span><span class="n">CVE</span><span class="o">-</span><span class="mi">2014</span><span class="o">-</span><span class="mi">1234</span>
</pre></div>
</div>
<p>This would make a reference to <a class="reference external" href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1234">http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1234</a>.</p>
<p>All the reference types are defined in the reference.config configuration file.</p>
</div>
<div class="section" id="priority">
<h4>priority<a class="headerlink" href="#priority" title="Permalink to this headline">¶</a></h4>
<p>The priority keyword comes with a mandatory numeric value which can
range from 1 to 255. The values 1 through 4 are commonly used.
The highest priority is 1. Signatures with a higher priority will
be examined first. Normally signatures have a priority determined through
a classtype definition. The classtype definition can be overridden
by defining the priority keyword in the signature.
The format of priority is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">priority</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="metadata">
<h4>metadata<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h4>
<p>The metadata keyword allows additional, non-functional, information to
be added to the signature. While the format is free-form, it is
recommended to stick to <cite>[key, value]</cite> pairs as Suricata can include these
in eve alerts. The format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span><span class="p">:</span> <span class="n">key</span> <span class="n">value</span><span class="p">;</span>
<span class="n">metadata</span><span class="p">:</span> <span class="n">key</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span> <span class="n">value</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="target">
<h4>target<a class="headerlink" href="#target" title="Permalink to this headline">¶</a></h4>
<p>The target keyword allows the rules writer to specify which side of the
alert is the target of the attack. If specified, the alert event is enhanced
to contain information about source and target.</p>
<p>The format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">target</span><span class="p">:[</span><span class="n">src_ip</span><span class="o">|</span><span class="n">dest_ip</span><span class="p">]</span>
</pre></div>
</div>
<p>If the value is src_ip then the source IP in the generated event (src_ip
field in JSON) is the target of the attack. If target is set to dest_ip
then the target is the destination IP in the generated event.</p>
</div>
</div>
<span id="document-rules/header-keywords"></span><div class="section" id="ip-keywords">
<h3>IP Keywords<a class="headerlink" href="#ip-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="ttl">
<h4>ttl<a class="headerlink" href="#ttl" title="Permalink to this headline">¶</a></h4>
<p>The ttl keyword is used to check for a specific IP time-to-live value
in the header of a packet. The format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttl</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttl</span><span class="p">:</span><span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>At the end of the ttl keyword you can enter the value on which you
want to match. The Time-to-live value determines the maximal amount
of time a packet can be in the Internet-system. If this field is set
to 0, then the packet has to be destroyed. The time-to-live is based
on hop count. Each hop/router the packet passes subtracts one from the
packet TTL counter. The purpose of this mechanism is to limit the
existence of packets so that packets can not end up in infinite
routing loops.</p>
<p>Example of the ttl keyword in a rule:</p>
<div class="example-rule docutils container">
alert ip $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;IP Packet With TTL 0&quot;;
<span class="example-rule-emphasis">ttl:0;</span> classtype:misc-activity; sid:1; rev:1;)</div>
</div>
<div class="section" id="ipopts">
<h4>ipopts<a class="headerlink" href="#ipopts" title="Permalink to this headline">¶</a></h4>
<p>With the ipopts keyword you can check if a specific IP option is
set. Ipopts has to be used at the beginning of a rule. You can only
match on one option per rule. There are several options on which can
be matched. These are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">IP Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>rr</td>
<td>Record Route</td>
</tr>
<tr class="row-odd"><td>eol</td>
<td>End of List</td>
</tr>
<tr class="row-even"><td>nop</td>
<td>No Op</td>
</tr>
<tr class="row-odd"><td>ts</td>
<td>Time Stamp</td>
</tr>
<tr class="row-even"><td>sec</td>
<td>IP Security</td>
</tr>
<tr class="row-odd"><td>esec</td>
<td>IP Extended Security</td>
</tr>
<tr class="row-even"><td>lsrr</td>
<td>Loose Source Routing</td>
</tr>
<tr class="row-odd"><td>ssrr</td>
<td>Strict Source Routing</td>
</tr>
<tr class="row-even"><td>satid</td>
<td>Stream Identifier</td>
</tr>
<tr class="row-odd"><td>any</td>
<td>any IP options are set</td>
</tr>
</tbody>
</table>
<p>Format of the ipopts keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipopts</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipopts</span><span class="p">:</span> <span class="n">ts</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of ipopts in a rule:</p>
<div class="example-rule docutils container">
alert ip $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;IP Packet with timestamp option&quot;; <span class="example-rule-emphasis">ipopts:ts;</span> classtype:misc-activity; sid:2; rev:1;)</div>
</div>
<div class="section" id="sameip">
<h4>sameip<a class="headerlink" href="#sameip" title="Permalink to this headline">¶</a></h4>
<p>Every packet has a source IP-address and a destination IP-address. It
can be that the source IP is the same as the destination IP. With the
sameip keyword you can check if the IP address of the source is the
same as the IP address of the destination. The format of the sameip
keyword is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sameip</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of sameip in a rule:</p>
<div class="example-rule docutils container">
alert ip any any -&gt; any any (msg:&quot;IP Packet with the same source and destination IP&quot;; <span class="example-rule-emphasis">sameip;</span> classtype:bad-unknown; sid:3; rev:1;)</div>
</div>
<div class="section" id="ip-proto">
<h4>ip_proto<a class="headerlink" href="#ip-proto" title="Permalink to this headline">¶</a></h4>
<p>With the ip_proto keyword you can match on the IP protocol in the
packet-header. You can use the name or the number of the protocol.
You can match for example on the following protocols:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">1</span>     <span class="n">ICMP</span>        <span class="n">Internet</span> <span class="n">Control</span> <span class="n">Message</span>
 <span class="mi">6</span>     <span class="n">TCP</span>         <span class="n">Transmission</span> <span class="n">Control</span> <span class="n">Protocol</span>
<span class="mi">17</span>     <span class="n">UDP</span>         <span class="n">User</span> <span class="n">Datagram</span>
<span class="mi">47</span>     <span class="n">GRE</span>         <span class="n">General</span> <span class="n">Routing</span> <span class="n">Encapsulation</span>
<span class="mi">50</span>     <span class="n">ESP</span>         <span class="n">Encap</span> <span class="n">Security</span> <span class="n">Payload</span> <span class="k">for</span> <span class="n">IPv6</span>
<span class="mi">51</span>     <span class="n">AH</span>          <span class="n">Authentication</span> <span class="n">Header</span> <span class="k">for</span> <span class="n">Ipv6</span>
<span class="mi">58</span>     <span class="n">IPv6</span><span class="o">-</span><span class="n">ICMP</span>   <span class="n">ICMP</span> <span class="k">for</span> <span class="n">Ipv6</span>
</pre></div>
</div>
<p>For the complete list of protocols and their numbers see
<a class="reference external" href="http://en.wikipedia.org/wiki/List_of_IP_protocol_numbers">http://en.wikipedia.org/wiki/List_of_IP_protocol_numbers</a></p>
<p>Example of ip_proto in a rule:</p>
<div class="example-rule docutils container">
alert ip any any -&gt; any any (msg:&quot;IP Packet with protocol 1&quot;; <span class="example-rule-emphasis">ip_proto:1;</span> classtype:bad-unknown; sid:5; rev:1;)</div>
<p>The named variant of that example would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip_proto</span><span class="p">:</span><span class="n">ICMP</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="ipv4-hdr">
<h4>ipv4.hdr<a class="headerlink" href="#ipv4-hdr" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on content contained within an IPv4 header.</p>
<p>Example rule:</p>
<div class="example-rule docutils container">
alert ip any any -&gt; any any (msg:&quot;IPv4 header keyword example&quot;; <span class="example-rule-emphasis">ipv4.hdr; content:&quot;|06|&quot;; offset:9; depth:1;</span> sid:1; rev:1;)</div>
<p>This example looks if byte 10 of IPv4 header has value 06, which indicates that
the IPv4 protocol is TCP.</p>
</div>
<div class="section" id="ipv6-hdr">
<h4>ipv6.hdr<a class="headerlink" href="#ipv6-hdr" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on content contained within an IPv6 header.</p>
<p>Example rule:</p>
<div class="example-rule docutils container">
alert ip any any -&gt; any any (msg:&quot;IPv6 header keyword example&quot;; <span class="example-rule-emphasis">ipv6.hdr; content:&quot;|06|&quot;; offset:6; depth:1;</span> sid:1; rev:1;)</div>
<p>This example looks if byte 7 of IP64 header has value 06, which indicates that
the IPv6 protocol is TCP.</p>
</div>
<div class="section" id="id">
<h4>id<a class="headerlink" href="#id" title="Permalink to this headline">¶</a></h4>
<p>With the id keyword, you can match on a specific IP ID value. The ID
identifies each packet sent by a host and increments usually with one
with each packet that is being send. The IP ID is used as a fragment
identification number. Each packet has an IP ID, and when the packet
becomes fragmented, all fragments of this packet have the same ID. In
this way, the receiver of the packet knows which fragments belong to
the same packet. (IP ID does not take care of the order, in that case
offset is used. It clarifies the order of the fragments.)</p>
<p>Format of id:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of id in a rule:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;id keyword example&quot;; <span class="example-rule-emphasis">id:1;</span> content:&quot;content|3a 20|&quot;; fast_pattern; classtype:misc-activity; sid:12; rev:1;)</div>
</div>
<div class="section" id="geoip">
<h4>geoip<a class="headerlink" href="#geoip" title="Permalink to this headline">¶</a></h4>
<p>The geoip keyword enables matching on the source, destination or
source and destination IPv4 addresses of network traffic, and to see to
which country it belongs. To be able to do this, Suricata uses the GeoIP2
API of MaxMind.</p>
<p>The syntax of geoip:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geoip</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span><span class="n">RU</span><span class="p">;</span>
<span class="n">geoip</span><span class="p">:</span> <span class="n">both</span><span class="p">,</span><span class="n">CN</span><span class="p">,</span><span class="n">RU</span><span class="p">;</span>
<span class="n">geoip</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span><span class="n">CN</span><span class="p">,</span><span class="n">RU</span><span class="p">,</span><span class="n">IR</span><span class="p">;</span>
<span class="n">geoip</span><span class="p">:</span> <span class="n">both</span><span class="p">,</span><span class="n">US</span><span class="p">,</span><span class="n">CA</span><span class="p">,</span><span class="n">UK</span><span class="p">;</span>
<span class="n">geoip</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span><span class="n">CN</span><span class="p">,</span><span class="n">IR</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="93%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>both</td>
<td>Both source and destination have to match with the given geoip(s)</td>
</tr>
<tr class="row-odd"><td>any</td>
<td>Either the source or the destination has to match with the given geoip(s).</td>
</tr>
<tr class="row-even"><td>dest</td>
<td>The destination matches with the given geoip.</td>
</tr>
<tr class="row-odd"><td>src</td>
<td>The source matches with the given geoip.</td>
</tr>
</tbody>
</table>
<p>geoip currently only supports IPv4. As it uses the GeoIP2 API of MaxMind,
libmaxminddb must be compiled in. You must download and install the
GeoIP2 or GeoLite2 database editions desired. Visit the MaxMind site
at <a class="reference external" href="https://dev.maxmind.com/geoip/geolite2-free-geolocation-data">https://dev.maxmind.com/geoip/geolite2-free-geolocation-data</a> for details.</p>
<p>You must also supply the location of the GeoIP2 or GeoLite2 database
file on the local system in the YAML-file configuration (for example):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geoip</span><span class="o">-</span><span class="n">database</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">GeoIP</span><span class="o">/</span><span class="n">GeoLite2</span><span class="o">-</span><span class="n">Country</span><span class="o">.</span><span class="n">mmdb</span>
</pre></div>
</div>
</div>
<div class="section" id="fragbits-ip-fragmentation">
<h4>fragbits (IP fragmentation)<a class="headerlink" href="#fragbits-ip-fragmentation" title="Permalink to this headline">¶</a></h4>
<p>With the fragbits keyword, you can check if the fragmentation and
reserved bits are set in the IP header. The fragbits keyword should be
placed at the beginning of a rule. Fragbits is used to modify the
fragmentation mechanism. During routing of messages from one Internet
module to the other, it can occur that a packet is bigger than the
maximal packet size a network can process. In that case, a packet can
be send in fragments. This maximum of the packet size is called
Maximal Transmit Unit (MTU).</p>
<p>You can match on the following bits:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">-</span> <span class="n">More</span> <span class="n">Fragments</span>
<span class="n">D</span> <span class="o">-</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">Fragment</span>
<span class="n">R</span> <span class="o">-</span> <span class="n">Reserved</span> <span class="n">Bit</span>
</pre></div>
</div>
<p>Matching on this bits can be more specified with the following
modifiers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+         match on the specified bits, plus any others
*         match if any of the specified bits are set
!         match if the specified bits are not set
</pre></div>
</div>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>fragbits:[*+!]&lt;[MDR]&gt;;
</pre></div>
</div>
<p>Example of fragbits in a rule:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;fragbits keyword example non-fragmented packet with fragment offset&gt;0&quot;; <span class="example-rule-emphasis">fragbits:M;</span> fragoffset:&gt;0; classtype:bad-unknown; sid:123; rev:1;)</div>
</div>
<div class="section" id="fragoffset">
<h4>fragoffset<a class="headerlink" href="#fragoffset" title="Permalink to this headline">¶</a></h4>
<p>With the fragoffset keyword you can match on specific decimal values
of the IP fragment offset field. If you would like to check the first
fragments of a session, you have to combine fragoffset 0 with the More
Fragment option. The fragmentation offset field is convenient for
reassembly. The id is used to determine which fragments belong to
which packet and the fragmentation offset field clarifies the order of
the fragments.</p>
<p>You can use the following modifiers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;       match if the value is smaller than the specified value
&gt;       match if the value is greater than the specified value
!       match if the specified value is not present
</pre></div>
</div>
<p>Format of fragoffset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>fragoffset:[!|&lt;|&gt;]&lt;number&gt;;
</pre></div>
</div>
<p>Example of fragoffset in a rule:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;fragoffset keyword example invalid non-fragmented packet with fragment offset&gt;0&quot;; fragbits:M; <span class="example-rule-emphasis">fragoffset:&gt;0;</span> classtype:bad-unknown; sid:13; rev:1;)</div>
</div>
<div class="section" id="tos">
<h4>tos<a class="headerlink" href="#tos" title="Permalink to this headline">¶</a></h4>
<p>The tos keyword can match on specific decimal values of the IP header TOS
field. The tos keyword can have a value from 0 - 255. This field of the
IP header has been updated by <a class="reference external" href="https://tools.ietf.org/html/rfc2474">rfc2474</a>
to include functionality for
<a class="reference external" href="https://en.wikipedia.org/wiki/Differentiated_services">Differentiated services</a>.
Note that the value of the field has been defined with the right-most 2 bits having
the value 0. When specifying a value for tos, ensure that the value follows this.</p>
<p>E.g, instead of specifying the decimal value 34 (hex 22), right shift twice and use
decimal 136 (hex 88).</p>
<p>You can specify hexadecimal values with a leading <cite>x</cite>, e.g, <cite>x88</cite>.</p>
<p>Format of tos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tos:[!]&lt;number&gt;;
</pre></div>
</div>
<p>Example of tos in a rule:</p>
<div class="example-rule docutils container">
alert ip any any -&gt; any any (msg:&quot;tos keyword example tos value 8&quot;; flow:established; <span class="example-rule-emphasis">tos:8;</span> classtype:not-suspicious; sid:123; rev:1;)</div>
<p>Example of tos with a negated value:</p>
<div class="example-rule docutils container">
alert ip any any -&gt; any any (msg:&quot;tos keyword example with negated content&quot;; flow:established,to_server; <span class="example-rule-emphasis">tos:!8;</span> classtype:bad-unknown; sid:14; rev:1;)</div>
</div>
</div>
<div class="section" id="tcp-keywords">
<h3>TCP keywords<a class="headerlink" href="#tcp-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="seq">
<h4>seq<a class="headerlink" href="#seq" title="Permalink to this headline">¶</a></h4>
<p>The seq keyword can be used in a signature to check for a specific TCP
sequence number. A sequence number is a number that is generated
practically at random by both endpoints of a TCP-connection. The
client and the server both create a sequence number, which increases
with one with every byte that they send. So this sequence number is
different for both sides. This sequence number has to be acknowledged
by both sides of the connection. Through sequence numbers, TCP
handles acknowledgement, order and retransmission. Its number
increases with every data-byte the sender has send. The seq helps
keeping track of to what place in a data-stream a byte belongs. If the
SYN flag is set at 1, than the sequence number of the first byte of
the data is this number plus 1 (so, 2).</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of seq in a signature:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;GPL SCAN NULL&quot;; flow:stateless; ack:0; flags:0; <span class="example-rule-emphasis">seq:0;</span> reference:arachnids,4; classtype:attempted-recon; sid:2100623; rev:7;)</div>
<p>Example of seq in a packet (Wireshark):</p>
<img alt="_images/Wireshark_seq.png" src="_images/Wireshark_seq.png" />
</div>
<div class="section" id="ack">
<h4>ack<a class="headerlink" href="#ack" title="Permalink to this headline">¶</a></h4>
<p>The ack is the acknowledgement of the receipt of all previous
(data)-bytes send by the other side of the TCP-connection. In most
occasions every packet of a TCP connection has an ACK flag after the
first SYN and a ack-number which increases with the receipt of every
new data-byte. The ack keyword can be used in a signature to check
for a specific TCP acknowledgement number.</p>
<p>Format of ack:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ack</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of ack in a signature:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;GPL SCAN NULL&quot;; flow:stateless; <span class="example-rule-emphasis">ack:0;</span> flags:0; seq:0; reference:arachnids,4; classtype:attempted-recon; sid:2100623; rev:7;)</div>
<p>Example of ack in a packet (Wireshark):</p>
<img alt="_images/Wireshark_ack.png" src="_images/Wireshark_ack.png" />
</div>
<div class="section" id="window">
<h4>window<a class="headerlink" href="#window" title="Permalink to this headline">¶</a></h4>
<p>The window keyword is used to check for a specific TCP window size.
The TCP window size is a mechanism that has control of the
data-flow. The window is set by the receiver (receiver advertised
window size) and indicates the amount of bytes that can be
received. This amount of data has to be acknowledged by the receiver
first, before the sender can send the same amount of new data. This
mechanism is used to prevent the receiver from being overflowed by
data. The value of the window size is limited and can be 2 to 65.535
bytes. To make more use of your bandwidth you can use a bigger
TCP-window.</p>
<p>The format of the window keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>window:[!]&lt;number&gt;;
</pre></div>
</div>
<p>Example of window in a rule:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;GPL DELETED typot trojan traffic&quot;; flow:stateless; flags:S,12; <span class="example-rule-emphasis">window:55808;</span> reference:mcafee,100406; classtype:trojan-activity; sid:2182; rev:8;)</div>
</div>
<div class="section" id="tcp-mss">
<h4>tcp.mss<a class="headerlink" href="#tcp-mss" title="Permalink to this headline">¶</a></h4>
<p>Match on the TCP MSS option value. Will not match if the option is not
present.</p>
<p>The format of the keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tcp</span><span class="o">.</span><span class="n">mss</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">min</span><span class="o">&gt;-&lt;</span><span class="nb">max</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">mss</span><span class="p">:[</span><span class="o">&lt;|&gt;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">mss</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example rule:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (flow:stateless; flags:S,12; <span class="example-rule-emphasis">tcp.mss:&lt;536;</span> sid:1234; rev:5;)</div>
</div>
<div class="section" id="tcp-hdr">
<h4>tcp.hdr<a class="headerlink" href="#tcp-hdr" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the whole TCP header.</p>
<p>Example rule:</p>
<div class="example-rule docutils container">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (flags:S,12; <span class="example-rule-emphasis">tcp.hdr; content:&quot;|02 04|&quot;; offset:20; byte_test:2,&lt;,536,0,big,relative;</span> sid:1234; rev:5;)</div>
<p>This example starts looking after the fixed portion of the header, so
into the variable sized options. There it will look for the MSS option
(type 2, option len 4) and using a byte_test determine if the value of
the option is lower than 536. The <cite>tcp.mss</cite> option will be more efficient,
so this keyword is meant to be used in cases where no specific keyword
is available.</p>
</div>
</div>
<div class="section" id="udp-keywords">
<h3>UDP keywords<a class="headerlink" href="#udp-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="udp-hdr">
<h4>udp.hdr<a class="headerlink" href="#udp-hdr" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the whole UDP header.</p>
<p>Example rule:</p>
<div class="example-rule docutils container">
alert udp any any -&gt; any any (<span class="example-rule-emphasis">udp.hdr; content:&quot;|00 08|&quot;; offset:4; depth:2;</span> sid:1234; rev:5;)</div>
<p>This example matches on the length field of the UDP header. In this
case the length of 8 means that there is no payload. This can also
be matched using <cite>dsize:0;</cite>.</p>
</div>
</div>
<div class="section" id="icmp-keywords">
<h3>ICMP keywords<a class="headerlink" href="#icmp-keywords" title="Permalink to this headline">¶</a></h3>
<p>ICMP (Internet Control Message Protocol) is a part of IP. IP at itself
is not reliable when it comes to delivering data (datagram). ICMP
gives feedback in case problems occur. It does not prevent problems
from happening, but helps in understanding what went wrong and
where. If reliability is necessary, protocols that use IP have to take
care of reliability themselves. In different situations ICMP messages
will be send. For instance when the destination is unreachable, if
there is not enough buffer-capacity to forward the data, or when a
datagram is send fragmented when it should not be, etcetera. More can
be found in the list with message-types.</p>
<p>There are four important contents of a ICMP message on which can be
matched with corresponding ICMP-keywords. These are: the type, the
code, the id and the sequence of a message.</p>
<div class="section" id="itype">
<h4>itype<a class="headerlink" href="#itype" title="Permalink to this headline">¶</a></h4>
<p>The itype keyword is for matching on a specific ICMP type (number).
ICMP has several kinds of messages and uses codes to clarify those
messages. The different messages are distinct by different names, but
more important by numeric values. For more information see the table
with message-types and codes.</p>
<p>The format of the itype keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">itype</span><span class="p">:</span><span class="nb">min</span><span class="o">&lt;&gt;</span><span class="nb">max</span><span class="p">;</span>
<span class="n">itype</span><span class="p">:[</span><span class="o">&lt;|&gt;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example
This example looks for an ICMP type greater than 10:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">itype</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of the itype keyword in a signature:</p>
<div class="example-rule docutils container">
alert icmp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;GPL SCAN Broadscan Smurf Scanner&quot;; dsize:4; icmp_id:0; icmp_seq:0; <span class="example-rule-emphasis">itype:8;</span> classtype:attempted-recon; sid:2100478; rev:4;)</div>
<p>The following lists all ICMP types known at the time of writing. A recent table can be found <a class="reference external" href="https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml">at the website of IANA</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ICMP Type</th>
<th class="head">Name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>Echo Reply</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>Destination Unreachable</td>
</tr>
<tr class="row-even"><td>4</td>
<td>Source Quench</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>Redirect</td>
</tr>
<tr class="row-even"><td>6</td>
<td>Alternate Host Address</td>
</tr>
<tr class="row-odd"><td>8</td>
<td>Echo</td>
</tr>
<tr class="row-even"><td>9</td>
<td>Router Advertisement</td>
</tr>
<tr class="row-odd"><td>10</td>
<td>Router Solicitation</td>
</tr>
<tr class="row-even"><td>11</td>
<td>Time Exceeded</td>
</tr>
<tr class="row-odd"><td>12</td>
<td>Parameter Problem</td>
</tr>
<tr class="row-even"><td>13</td>
<td>Timestamp</td>
</tr>
<tr class="row-odd"><td>14</td>
<td>Timestamp Reply</td>
</tr>
<tr class="row-even"><td>15</td>
<td>Information Request</td>
</tr>
<tr class="row-odd"><td>16</td>
<td>Information Reply</td>
</tr>
<tr class="row-even"><td>17</td>
<td>Address Mask Request</td>
</tr>
<tr class="row-odd"><td>18</td>
<td>Address Mask Reply</td>
</tr>
<tr class="row-even"><td>30</td>
<td>Traceroute</td>
</tr>
<tr class="row-odd"><td>31</td>
<td>Datagram Conversion Error</td>
</tr>
<tr class="row-even"><td>32</td>
<td>Mobile Host Redirect</td>
</tr>
<tr class="row-odd"><td>33</td>
<td>IPv6 Where-Are-You</td>
</tr>
<tr class="row-even"><td>34</td>
<td>IPv6 I-Am-Here</td>
</tr>
<tr class="row-odd"><td>35</td>
<td>Mobile Registration Request</td>
</tr>
<tr class="row-even"><td>36</td>
<td>Mobile Registration Reply</td>
</tr>
<tr class="row-odd"><td>37</td>
<td>Domain Name Request</td>
</tr>
<tr class="row-even"><td>38</td>
<td>Domain Name Reply</td>
</tr>
<tr class="row-odd"><td>39</td>
<td>SKIP</td>
</tr>
<tr class="row-even"><td>40</td>
<td>Photuris</td>
</tr>
<tr class="row-odd"><td>41</td>
<td>Experimental mobility protocols such as Seamoby</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="icode">
<h4>icode<a class="headerlink" href="#icode" title="Permalink to this headline">¶</a></h4>
<p>With the icode keyword you can match on a specific ICMP code. The
code of a ICMP message clarifies the message. Together with the
ICMP-type it indicates with what kind of problem you are dealing with.
A code has a different purpose with every ICMP-type.</p>
<p>The format of the icode keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icode</span><span class="p">:</span><span class="nb">min</span><span class="o">&lt;&gt;</span><span class="nb">max</span><span class="p">;</span>
<span class="n">icode</span><span class="p">:[</span><span class="o">&lt;|&gt;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example:
This example looks for an ICMP code greater than 5:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icode</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of the icode keyword in a rule:</p>
<div class="example-rule docutils container">
alert icmp $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;GPL MISC Time-To-Live Exceeded in Transit&quot;; <span class="example-rule-emphasis">icode:0;</span> itype:11; classtype:misc-activity; sid:2100449; rev:7;)</div>
<p>The following lists the meaning of all ICMP types. When a code is not listed,
only type 0 is defined and has the meaning of the ICMP code, in the table above.
A recent table can be found <a class="reference external" href="https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml">at the website of IANA</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="12%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ICMP Code</th>
<th class="head">ICMP Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td rowspan="16">3</td>
<td>0</td>
<td>Net Unreachable</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>Host Unreachable</td>
</tr>
<tr class="row-even"><td>2</td>
<td>Protocol Unreachable</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>Port Unreachable</td>
</tr>
<tr class="row-even"><td>4</td>
<td>Fragmentation Needed and Don't Fragment was Set</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>Source Route Failed</td>
</tr>
<tr class="row-even"><td>6</td>
<td>Destination Network Unknown</td>
</tr>
<tr class="row-odd"><td>7</td>
<td>Destination Host Unknown</td>
</tr>
<tr class="row-even"><td>8</td>
<td>Source Host Isolated</td>
</tr>
<tr class="row-odd"><td>9</td>
<td>Communication with Destination Network is Administratively Prohibited</td>
</tr>
<tr class="row-even"><td>10</td>
<td>Communication with Destination Host is Administratively Prohibited</td>
</tr>
<tr class="row-odd"><td>11</td>
<td>Destination Network Unreachable for Type of Service</td>
</tr>
<tr class="row-even"><td>12</td>
<td>Destination Host Unreachable for Type of Service</td>
</tr>
<tr class="row-odd"><td>13</td>
<td>Communication Administratively Prohibited</td>
</tr>
<tr class="row-even"><td>14</td>
<td>Host Precedence Violation</td>
</tr>
<tr class="row-odd"><td>15</td>
<td>Precedence cutoff in effect</td>
</tr>
<tr class="row-even"><td rowspan="4">5</td>
<td>0</td>
<td>Redirect Datagram for the Network (or subnet)</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>Redirect Datagram for the Host</td>
</tr>
<tr class="row-even"><td>2</td>
<td>Redirect Datagram for the Type of Service and Network</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>Redirect Datagram for the Type of Service and Host</td>
</tr>
<tr class="row-even"><td rowspan="2">9</td>
<td>0</td>
<td>Normal router advertisement</td>
</tr>
<tr class="row-odd"><td>16</td>
<td>Doesn't route common traffic</td>
</tr>
<tr class="row-even"><td rowspan="2">11</td>
<td>0</td>
<td>Time to Live exceeded in Transit</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>Fragment Reassembly Time Exceeded</td>
</tr>
<tr class="row-even"><td rowspan="3">12</td>
<td>0</td>
<td>Pointer indicates the error</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>Missing a Required Option</td>
</tr>
<tr class="row-even"><td>2</td>
<td>Bad Length</td>
</tr>
<tr class="row-odd"><td rowspan="6">40</td>
<td>0</td>
<td>Bad SPI</td>
</tr>
<tr class="row-even"><td>1</td>
<td>Authentication Failed</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>Decompression Failed</td>
</tr>
<tr class="row-even"><td>3</td>
<td>Decryption Failed</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>Need Authentication</td>
</tr>
<tr class="row-even"><td>5</td>
<td>Need Authorization</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="icmp-id">
<h4>icmp_id<a class="headerlink" href="#icmp-id" title="Permalink to this headline">¶</a></h4>
<p>With the icmp_id keyword you can match on specific ICMP id-values.
Every ICMP-packet gets an id when it is being send. At the moment the
receiver has received the packet, it will send a reply using the same
id so the sender will recognize it and connects it with the correct
ICMP-request.</p>
<p>Format of the icmp_id keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icmp_id</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example:
This example looks for an ICMP ID of 0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icmp_id</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of the icmp_id keyword in a rule:</p>
<div class="example-rule docutils container">
alert icmp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;GPL SCAN Broadscan Smurf Scanner&quot;; dsize:4; <span class="example-rule-emphasis">icmp_id:0;</span> icmp_seq:0; itype:8; classtype:attempted-recon; sid:2100478; rev:4;)</div>
</div>
<div class="section" id="icmp-seq">
<h4>icmp_seq<a class="headerlink" href="#icmp-seq" title="Permalink to this headline">¶</a></h4>
<p>You can use the icmp_seq keyword to check for a ICMP sequence number.
ICMP messages all have sequence numbers. This can be useful (together
with the id) for checking which reply message belongs to which request
message.</p>
<p>Format of the icmp_seq keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icmp_seq</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example:
This example looks for an ICMP Sequence of 0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icmp_seq</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of icmp_seq in a rule:</p>
<div class="example-rule docutils container">
alert icmp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;GPL SCAN Broadscan Smurf Scanner&quot;; dsize:4; icmp_id:0; <span class="example-rule-emphasis">icmp_seq:0;</span> itype:8; classtype:attempted-recon; sid:2100478; rev:4;)</div>
</div>
<div class="section" id="icmpv4-hdr">
<h4>icmpv4.hdr<a class="headerlink" href="#icmpv4-hdr" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the whole ICMPv4 header.</p>
</div>
<div class="section" id="icmpv6-hdr">
<h4>icmpv6.hdr<a class="headerlink" href="#icmpv6-hdr" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the whole ICMPv6 header.</p>
</div>
<div class="section" id="icmpv6-mtu">
<h4>icmpv6.mtu<a class="headerlink" href="#icmpv6-mtu" title="Permalink to this headline">¶</a></h4>
<p>Match on the ICMPv6 MTU optional value. Will not match if the MTU is not
present.</p>
<p>The format of the keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icmpv6</span><span class="o">.</span><span class="n">mtu</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">min</span><span class="o">&gt;-&lt;</span><span class="nb">max</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">icmpv6</span><span class="o">.</span><span class="n">mtu</span><span class="p">:[</span><span class="o">&lt;|&gt;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">icmpv6</span><span class="o">.</span><span class="n">mtu</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example rule:</p>
<div class="example-rule docutils container">
alert ip $EXTERNAL_NET any -&gt; $HOME_NET any (<span class="example-rule-emphasis">icmpv6.mtu:&lt;1280;</span> sid:1234; rev:5;)</div>
</div>
</div>
<span id="document-rules/payload-keywords"></span><div class="section" id="payload-keywords">
<h3>Payload Keywords<a class="headerlink" href="#payload-keywords" title="Permalink to this headline">¶</a></h3>
<p>Payload keywords inspect the content of the payload of a packet or
stream.</p>
<div class="section" id="content">
<h4>content<a class="headerlink" href="#content" title="Permalink to this headline">¶</a></h4>
<p>The content keyword is very important in signatures. Between the
quotation marks you can write on what you would like the signature to
match. The most simple format of content is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span> <span class="s2">&quot;............&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>It is possible to use several contents in a signature.</p>
<p>Contents match on bytes. There are 256 different values of a byte
(0-255). You can match on all characters; from a till z, upper case
and lower case and also on all special signs. But not all of the bytes
are printable characters. For these bytes heximal notations are
used. Many programming languages use 0x00 as a notation, where 0x
means it concerns a binary value, however the rule language uses
<code class="docutils literal notranslate"><span class="pre">|00|</span></code> as a notation.  This kind of notation can also be used for
printable characters.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>|61| is a
|61 61| is aa
|41| is A
|21| is !
|0D| is carriage return
|0A| is line feed
</pre></div>
</div>
<p>There are characters you can not use in the content because they are
already important in the signature. For matching on these characters
you should use the heximal notation. These are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;     |22|</span>
<span class="p">;</span>     <span class="o">|</span><span class="mi">3</span><span class="n">B</span><span class="o">|</span>
<span class="p">:</span>     <span class="o">|</span><span class="mi">3</span><span class="n">A</span><span class="o">|</span>
<span class="o">|</span>     <span class="o">|</span><span class="mi">7</span><span class="n">C</span><span class="o">|</span>
</pre></div>
</div>
<p>It is a convention to write the heximal notation in upper case characters.</p>
<p>To write for instance <code class="docutils literal notranslate"><span class="pre">http://</span></code> in the content of a signature, you
should write it like this: <code class="docutils literal notranslate"><span class="pre">content:</span> <span class="pre">&quot;http|3A|//&quot;;</span></code> If you use a
heximal notation in a signature, make sure you always place it between
pipes. Otherwise the notation will be taken literally as part of the
content.</p>
<p>A few examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;a|0D|bc&quot;</span><span class="p">;</span>
<span class="n">content</span><span class="p">:</span><span class="s2">&quot;|61 0D 62 63|&quot;</span><span class="p">;</span>
<span class="n">content</span><span class="p">:</span><span class="s2">&quot;a|0D|b|63|&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>It is possible to let a signature check the whole payload for a match with the content or to let it check specific parts of the payload. We come to that later.
If you add nothing special to the signature, it will try to find a match in all the bytes of the payload.</p>
<div class="example-rule docutils container">
drop tcp $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;ET TROJAN Likely Bot Nick in IRC (USA +..)&quot;; flow:established,to_server; flowbits:isset,is_proto_irc; <span class="example-rule-emphasis">content:&quot;NICK &quot;;</span> pcre:&quot;/NICK .*USA.*[0-9]{3,}/i&quot;; reference:url,doc.emergingthreats.net/2008124; classtype:trojan-activity; sid:2008124; rev:2;)</div>
<p>By default the pattern-matching is case sensitive. The content has to
be accurate, otherwise there will not be a match.</p>
<img alt="_images/content2.png" src="_images/content2.png" />
<p>Legend:</p>
<img alt="_images/Legenda_rules1.png" src="_images/Legenda_rules1.png" />
<p>It is possible to use the ! for exceptions in contents as well.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;Outdated Firefox on
Windows&quot;; content:&quot;User-Agent|3A| Mozilla/5.0 |28|Windows|3B| &quot;;
content:&quot;Firefox/3.&quot;; distance:0; content:!&quot;Firefox/3.6.13&quot;;
distance:-10; sid:9000000; rev:1;)
</pre></div>
</div>
<p>You see <code class="docutils literal notranslate"><span class="pre">content:!&quot;Firefox/3.6.13&quot;;</span></code>. This means an alert will be
generated if the used version of Firefox is not 3.6.13.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following characters must be escaped inside the content:
<code class="docutils literal notranslate"><span class="pre">;</span></code> <code class="docutils literal notranslate"><span class="pre">\</span></code> <code class="docutils literal notranslate"><span class="pre">&quot;</span></code></p>
</div>
</div>
<div class="section" id="nocase">
<h4>nocase<a class="headerlink" href="#nocase" title="Permalink to this headline">¶</a></h4>
<p>If you do not want to make a distinction between uppercase and
lowercase characters, you can use nocase. The keyword nocase is a
content modifier.</p>
<p>The format of this keyword is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nocase</span><span class="p">;</span>
</pre></div>
</div>
<p>You have to place it after the content you want to modify, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span> <span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span>
</pre></div>
</div>
<p>Example nocase:</p>
<img alt="_images/content3.png" src="_images/content3.png" />
<p>It has no influence on other contents in the signature.</p>
</div>
<div class="section" id="depth">
<h4>depth<a class="headerlink" href="#depth" title="Permalink to this headline">¶</a></h4>
<p>The depth keyword is a absolute content modifier. It comes after the
content. The depth content modifier comes with a mandatory numeric
value, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">depth</span><span class="p">:</span><span class="mi">12</span><span class="p">;</span>
</pre></div>
</div>
<p>The number after depth designates how many bytes from the beginning of
the payload will be checked.</p>
<p>Example:</p>
<img alt="_images/content4.png" src="_images/content4.png" />
</div>
<div class="section" id="startswith">
<h4>startswith<a class="headerlink" href="#startswith" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">startswith</span></code> keyword is similar to <code class="docutils literal notranslate"><span class="pre">depth</span></code>. It takes no arguments
and must follow a <code class="docutils literal notranslate"><span class="pre">content</span></code> keyword. It modifies the <code class="docutils literal notranslate"><span class="pre">content</span></code> to match
exactly at the start of a buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;GET|20|&quot;</span><span class="p">;</span> <span class="n">startswith</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">startswith</span></code> is a short hand notation for:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;GET|20|&quot;</span><span class="p">;</span> <span class="n">depth</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">startswith</span></code> cannot be mixed with <code class="docutils literal notranslate"><span class="pre">depth</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">within</span></code> or
<code class="docutils literal notranslate"><span class="pre">distance</span></code> for the same pattern.</p>
</div>
<div class="section" id="endswith">
<h4>endswith<a class="headerlink" href="#endswith" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">endswith</span></code> keyword is similar to <code class="docutils literal notranslate"><span class="pre">isdataat:!1,relative;</span></code>. It takes no
arguments and must follow a <code class="docutils literal notranslate"><span class="pre">content</span></code> keyword. It modifies the <code class="docutils literal notranslate"><span class="pre">content</span></code> to
match exactly at the end of a buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;.php&quot;</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">endswith</span></code> is a short hand notation for:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>content:&quot;.php&quot;; isdataat:!1,relative;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">endswith</span></code> cannot be mixed with <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">within</span></code> or
<code class="docutils literal notranslate"><span class="pre">distance</span></code> for the same pattern.</p>
</div>
<div class="section" id="offset">
<h4>offset<a class="headerlink" href="#offset" title="Permalink to this headline">¶</a></h4>
<p>The offset keyword designates from which byte in the payload will be
checked to find a match.  For instance offset:3; checks the fourth
byte and further.</p>
<img alt="_images/content5.png" src="_images/content5.png" />
<p>The keywords offset and depth can be combined and are often used together.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;def&quot;</span><span class="p">;</span> <span class="n">offset</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span> <span class="n">depth</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span>
</pre></div>
</div>
<p>If this was used in a signature, it would check the payload from the
third byte till the sixth byte.</p>
<img alt="_images/content6.png" src="_images/content6.png" />
</div>
<div class="section" id="distance">
<h4>distance<a class="headerlink" href="#distance" title="Permalink to this headline">¶</a></h4>
<p>The keyword distance is a relative content modifier. This means it
indicates a relation between this content keyword and the content
preceding it. Distance has its influence after the preceding match.
The keyword distance comes with a mandatory numeric value. The value
you give distance, determines the byte in the payload from which will
be checked for a match relative to the previous match.  Distance only
determines where Suricata will start looking for a pattern.  So,
distance:5; means the pattern can be anywhere after the previous
match + 5 bytes. For limiting how far after the last match Suricata
needs to look, use 'within'.</p>
<p>The absolute value for distance must be less than or equal to 1MB (1048576).</p>
<p>Examples of distance:</p>
<img alt="_images/distance5.png" src="_images/distance5.png" />
<img alt="_images/distance4.png" src="_images/distance4.png" />
<img alt="_images/distance.png" src="_images/distance.png" />
<img alt="_images/distance1.png" src="_images/distance1.png" />
<p>Distance can also be a negative number. It can be used to check for
matches with partly the same content (see example) or for a content
even completely before it. This is not very often used though. It is
possible to attain the same results with other keywords.</p>
<img alt="_images/distance3.png" src="_images/distance3.png" />
</div>
<div class="section" id="within">
<h4>within<a class="headerlink" href="#within" title="Permalink to this headline">¶</a></h4>
<p>The keyword within is relative to the preceding match. The keyword
within comes with a mandatory numeric value. Using within makes sure
there will only be a match if the content matches with the payload
within the set amount of bytes. Within can not be 0 (zero)</p>
<p>The absolute value for within must be less than or equal to 1MB (1048576).</p>
<p>Example:</p>
<img alt="_images/within2.png" src="_images/within2.png" />
<p>Example of matching with within:</p>
<img alt="_images/within1.png" src="_images/within1.png" />
<p>The second content has to fall/come 'within 3 ' from the first content.</p>
<p>As mentioned before, distance and within can be very well combined in
a signature. If you want Suricata to check a specific part of the
payload for a match, use within.</p>
<img alt="_images/within_distance.png" src="_images/within_distance.png" />
<img alt="_images/within_distance2.png" src="_images/within_distance2.png" />
</div>
<div class="section" id="rawbytes">
<h4>rawbytes<a class="headerlink" href="#rawbytes" title="Permalink to this headline">¶</a></h4>
<p>The rawbytes keyword has no effect but is included to be compatible with
signatures that use it, for example signatures used with Snort.</p>
</div>
<div class="section" id="isdataat">
<h4>isdataat<a class="headerlink" href="#isdataat" title="Permalink to this headline">¶</a></h4>
<p>The purpose of the isdataat keyword is to look if there is still data
at a specific part of the payload.  The keyword starts with a number
(the position) and then optional followed by 'relative' separated by a
comma and the option rawbytes.  You use the word 'relative' to know if
there is still data at a specific part of the payload relative to the
last match.</p>
<p>So you can use both examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">isdataat</span><span class="p">:</span><span class="mi">512</span><span class="p">;</span>

<span class="n">isdataat</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span> <span class="n">relative</span><span class="p">;</span>
</pre></div>
</div>
<p>The first example illustrates a signature which searches for byte 512
of the payload. The second example illustrates a signature searching
for byte 50 after the last match.</p>
<p>You can also use the negation (!) before isdataat.</p>
<img alt="_images/isdataat1.png" src="_images/isdataat1.png" />
</div>
<div class="section" id="bsize">
<h4>bsize<a class="headerlink" href="#bsize" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">bsize</span></code> keyword, you can match on the length of the buffer. This adds
precision to the content match, previously this could have been done with <code class="docutils literal notranslate"><span class="pre">isdataat</span></code>.</p>
<p>An optional operator can be specified; if no operator is present, the operator will
default to '='. When a relational operator is used, e.g., '&lt;', '&gt;' or '&lt;&gt;' (range),
the bsize value will be compared using the relational operator. Ranges are inclusive.</p>
<p>If one or more <code class="docutils literal notranslate"><span class="pre">content</span></code> keywords precedes <code class="docutils literal notranslate"><span class="pre">bsize</span></code>, each occurrence of <code class="docutils literal notranslate"><span class="pre">content</span></code>
will be inspected and an error will be raised if the content length and the bsize
value prevent a match.</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bsize</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">bsize</span><span class="o">:=&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">bsize</span><span class="p">:</span><span class="o">&lt;&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">bsize</span><span class="p">:</span><span class="o">&gt;&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">bsize</span><span class="p">:</span><span class="o">&lt;</span><span class="n">lo</span><span class="o">-</span><span class="n">number</span><span class="o">&gt;&lt;&gt;&lt;</span><span class="n">hi</span><span class="o">-</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Examples of <code class="docutils literal notranslate"><span class="pre">bsize</span></code> in a rule:</p>
<div class="example-rule docutils container">
<p>alert dns any any -&gt; any any (msg:&quot;bsize exact buffer size&quot;; dns.query; content:&quot;google.com&quot;; bsize:10; sid:1; rev:1;)</p>
<p>alert dns any any -&gt; any any (msg:&quot;bsize less than value&quot;; dns.query; content:&quot;google.com&quot;; bsize:&lt;25; sid:2; rev:1;)</p>
<p>alert dns any any -&gt; any any (msg:&quot;bsize buffer less than or equal value&quot;; dns.query; content:&quot;google.com&quot;; bsize:&lt;=20; sid:3; rev:1;)</p>
<p>alert dns any any -&gt; any any (msg:&quot;bsize buffer greater than value&quot;; dns.query; content:&quot;google.com&quot;; bsize:&gt;8; sid:4; rev:1;)</p>
<p>alert dns any any -&gt; any any (msg:&quot;bsize buffer greater than or equal value&quot;; dns.query; content:&quot;google.com&quot;; bsize:&gt;=8; sid:5; rev:1;)</p>
<p>alert dns any any -&gt; any any (msg:&quot;bsize buffer range value&quot;; dns.query; content:&quot;google.com&quot;; bsize:8&lt;&gt;20; sid:6; rev:1;)</p>
</div>
<div class="example-rule docutils container">
alert dns any any -&gt; any any (msg:&quot;test bsize rule&quot;; dns.query; content:&quot;short&quot;; bsize:&lt;10; sid:124; rev:1;)</div>
<div class="example-rule docutils container">
alert dns any any -&gt; any any (msg:&quot;test bsize rule&quot;; dns.query; content:&quot;longer string&quot;; bsize:&gt;10; sid:125; rev:1;)</div>
<div class="example-rule docutils container">
alert dns any any -&gt; any any (msg:&quot;test bsize rule&quot;; dns.query; content:&quot;middle&quot;; bsize:6&lt;&gt;15; sid:126; rev:1;)</div>
</div>
<div class="section" id="dsize">
<h4>dsize<a class="headerlink" href="#dsize" title="Permalink to this headline">¶</a></h4>
<p>With the dsize keyword, you can match on the size of the packet
payload/data. You can use the keyword for example to look for abnormal
sizes of payloads which are equal to some n i.e. 'dsize:n'
not equal 'dsize:!n' less than 'dsize:&lt;n' or greater than 'dsize:&gt;n'
This may be convenient in detecting buffer overflows.</p>
<p>dsize cannot be used when using app/streamlayer protocol keywords (i.e. http.uri)</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dsize:[&lt;&gt;!]number; || dsize:min&lt;&gt;max;
</pre></div>
</div>
<p>Examples of dsize values:</p>
<div class="example-rule docutils container">
<p>alert tcp any any -&gt; any any (msg:&quot;dsize exact size&quot;; dsize:10; sid:1; rev:1;)</p>
<p>alert tcp any any -&gt; any any (msg:&quot;dsize less than value&quot;; dsize:&lt;10; sid:2; rev:1;)</p>
<p>alert tcp any any -&gt; any any (msg:&quot;dsize less than or equal value&quot;; dsize:&lt;=10; sid:3; rev:1;)</p>
<p>alert tcp any any -&gt; any any (msg:&quot;dsize greater than value&quot;; dsize:&gt;8; sid:4; rev:1;)</p>
<p>alert tcp any any -&gt; any any (msg:&quot;dsize greater than or equal value&quot;; dsize:&gt;=10; sid:5; rev:1;)</p>
<p>alert tcp any any -&gt; any any (msg:&quot;dsize range value&quot;; dsize:8&lt;&gt;20; sid:6; rev:1;)</p>
<p>alert tcp any any -&gt; any any (msg:&quot;dsize not equal value&quot;; dsize:!9; sid:7; rev:1;)</p>
</div>
</div>
<div class="section" id="byte-test">
<h4>byte_test<a class="headerlink" href="#byte-test" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">byte_test</span></code> keyword extracts <code class="docutils literal notranslate"><span class="pre">&lt;num</span> <span class="pre">of</span> <span class="pre">bytes&gt;</span></code> and performs an operation selected
with <code class="docutils literal notranslate"><span class="pre">&lt;operator&gt;</span></code> against the value in <code class="docutils literal notranslate"><span class="pre">&lt;test</span> <span class="pre">value&gt;</span></code> at a particular <code class="docutils literal notranslate"><span class="pre">&lt;offset&gt;</span></code>.
The <code class="docutils literal notranslate"><span class="pre">&lt;bitmask</span> <span class="pre">value&gt;</span></code> is applied to the extracted bytes (before the operator is applied),
and the final result will be right shifted one bit for each trailing <code class="docutils literal notranslate"><span class="pre">0</span></code> in
the <code class="docutils literal notranslate"><span class="pre">&lt;bitmask</span> <span class="pre">value&gt;</span></code>.</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>byte_test:&lt;num of bytes&gt; | &lt;variable_name&gt;, [!]&lt;operator&gt;, &lt;test value&gt;, &lt;offset&gt; [,relative] \
[,&lt;endian&gt;][, string, &lt;num type&gt;][, dce][, bitmask &lt;bitmask value&gt;];
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&lt;num of bytes&gt;</td>
<td>The number of bytes selected from the packet to be converted
or the name of a byte_extract/byte_math variable.</td>
</tr>
<tr class="row-even"><td>&lt;operator&gt;</td>
<td><ul class="first last simple">
<li>[!] Negation can prefix other operators</li>
<li>&lt; less than</li>
<li>&gt; greater than</li>
<li>= equal</li>
<li>&lt;= less than or equal</li>
<li>&gt;= greater than or equal</li>
<li>&amp; bitwise AND</li>
<li>^ bitwise OR</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>&lt;value&gt;</td>
<td>Value to test the converted value against [hex or decimal accepted]</td>
</tr>
<tr class="row-even"><td>&lt;offset&gt;</td>
<td>Number of bytes into the payload</td>
</tr>
<tr class="row-odd"><td>[relative]</td>
<td>Offset relative to last content match</td>
</tr>
<tr class="row-even"><td>[endian]</td>
<td>Type of number being read:
- big (Most significant byte at lowest address)
- little (Most significant byte at the highest address)</td>
</tr>
<tr class="row-odd"><td>[string] &lt;num&gt;</td>
<td><ul class="first last simple">
<li>hex - Converted string represented in hex</li>
<li>dec - Converted string represented in decimal</li>
<li>oct - Converted string represented in octal</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>[dce]</td>
<td>Allow the DCE module to determine the byte order</td>
</tr>
<tr class="row-odd"><td>[bitmask]</td>
<td>Applies the AND operator on the bytes converted</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Test Example - Num = Value&quot;</span><span class="p">;</span> \
       <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 01 00 02|&quot;</span><span class="p">;</span> <span class="n">byte_test</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="o">=</span><span class="p">,</span><span class="mh">0x01</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Test Example - Num = Value relative to content&quot;</span><span class="p">;</span> \
       <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 01 00 02|&quot;</span><span class="p">;</span> <span class="n">byte_test</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="o">=</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="n">relative</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Test Example - Num != Value&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 01 00 02|&quot;</span><span class="p">;</span> \
       <span class="n">byte_test</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="o">!=</span><span class="p">,</span><span class="mh">0x06</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Test Example - Detect Large Values&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 01 00 02|&quot;</span><span class="p">;</span> \
       <span class="n">byte_test</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="n">relative</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Test Example - Lowest bit is set&quot;</span><span class="p">;</span> \
       <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 01 00 02|&quot;</span><span class="p">;</span> <span class="n">byte_test</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="o">&amp;</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="n">relative</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Test Example - Compare to String&quot;</span><span class="p">;</span> \
       <span class="n">content</span><span class="p">:</span><span class="s2">&quot;foobar&quot;</span><span class="p">;</span> <span class="n">byte_test</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="o">=</span><span class="p">,</span><span class="mi">1337</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">relative</span><span class="p">,</span><span class="n">string</span><span class="p">,</span><span class="n">dec</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="byte-math">
<h4>byte_math<a class="headerlink" href="#byte-math" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">byte_math</span></code> keyword adds the capability to perform mathematical operations on extracted values with
an existing variable or a specified value.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">relative</span></code> is included, there must be a previous <code class="docutils literal notranslate"><span class="pre">content</span></code> or <code class="docutils literal notranslate"><span class="pre">pcre</span></code> match.</p>
<p>Note: if <code class="docutils literal notranslate"><span class="pre">oper</span></code> is <code class="docutils literal notranslate"><span class="pre">/</span></code> and the divisor is 0, there will never be a match on the <code class="docutils literal notranslate"><span class="pre">byte_math</span></code> keyword.</p>
<p>The result can be stored in a result variable and referenced by
other rule options later in the rule.</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Keyword</th>
<th class="head">Modifier</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>content</td>
<td>offset,depth,distance,within</td>
</tr>
<tr class="row-odd"><td>byte_test</td>
<td>offset,value</td>
</tr>
<tr class="row-even"><td>byte_jump</td>
<td>offset</td>
</tr>
<tr class="row-odd"><td>isdataat</td>
<td>offset</td>
</tr>
</tbody>
</table>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte_math</span><span class="p">:</span><span class="nb">bytes</span> <span class="o">&lt;</span><span class="n">num</span> <span class="n">of</span> <span class="nb">bytes</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">variable</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span> <span class="p">,</span> <span class="n">offset</span> <span class="o">&lt;</span><span class="n">offset</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">oper</span> <span class="o">&lt;</span><span class="n">operator</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">rvalue</span> <span class="o">&lt;</span><span class="n">rvalue</span><span class="o">&gt;</span><span class="p">,</span> \
      <span class="n">result</span> <span class="o">&lt;</span><span class="n">result_var</span><span class="o">&gt;</span> <span class="p">[,</span> <span class="n">relative</span><span class="p">]</span> <span class="p">[,</span> <span class="n">endian</span> <span class="o">&lt;</span><span class="n">endian</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[,</span> <span class="n">string</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">-</span><span class="nb">type</span><span class="o">&gt;</span><span class="p">]</span> \
      <span class="p">[,</span> <span class="n">dce</span><span class="p">]</span> <span class="p">[,</span> <span class="n">bitmask</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">];</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&lt;num of bytes&gt;</td>
<td>The number of bytes selected from the packet
or the name of a byte_extract variable.</td>
</tr>
<tr class="row-even"><td>&lt;offset&gt;</td>
<td>Number of bytes into the payload</td>
</tr>
<tr class="row-odd"><td>oper &lt;operator&gt;</td>
<td>Mathematical operation to perform: +, -, *, /, &lt;&lt;, &gt;&gt;</td>
</tr>
<tr class="row-even"><td>rvalue &lt;rvalue&gt;</td>
<td>Value to perform the math operation with</td>
</tr>
<tr class="row-odd"><td>result &lt;result-var&gt;</td>
<td>Where to store the computed value</td>
</tr>
<tr class="row-even"><td>[relative]</td>
<td>Offset relative to last content match</td>
</tr>
<tr class="row-odd"><td>[endian &lt;type&gt;]</td>
<td><ul class="first last simple">
<li>big (Most significant byte at lowest address)</li>
<li>little (Most significant byte at the highest address)</li>
<li>dce (Allow the DCE module to determine the byte order)</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>[string &lt;num_type&gt;]</td>
<td><ul class="first last simple">
<li>hex Converted data is represented in hex</li>
<li>dec Converted data is represented in decimal</li>
<li>oct Converted data is represented as octal</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>[dce]</td>
<td>Allow the DCE module to determine the byte order</td>
</tr>
<tr class="row-even"><td>[bitmask] &lt;value&gt;</td>
<td>The AND operator will be applied to the extracted value
The result will be right shifted by the number of bits equal to the
number of trailing zeros in the mask</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
  <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Testing bytemath_body&quot;</span><span class="p">;</span> \
  <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 04 93 F3|&quot;</span><span class="p">;</span> \
  <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 00 00 07|&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span> <span class="n">within</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span> \
  <span class="n">byte_math</span><span class="p">:</span><span class="nb">bytes</span> <span class="mi">4</span><span class="p">,</span> <span class="n">offset</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oper</span> <span class="o">+</span><span class="p">,</span> <span class="n">rvalue</span> \
  <span class="mi">248</span><span class="p">,</span> <span class="n">result</span> <span class="n">var</span><span class="p">,</span> <span class="n">relative</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">udp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
  <span class="p">(</span><span class="n">byte_extract</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extracted_val</span><span class="p">,</span> <span class="n">relative</span><span class="p">;</span> \
  <span class="n">byte_math</span><span class="p">:</span> <span class="nb">bytes</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span> <span class="mi">1</span><span class="p">,</span> <span class="n">oper</span> <span class="o">+</span><span class="p">,</span> <span class="n">rvalue</span> <span class="n">extracted_val</span><span class="p">,</span> <span class="n">result</span> <span class="n">var</span><span class="p">;</span> \
  <span class="n">byte_test</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="o">=</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="mi">13</span><span class="p">;</span> \
  <span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte extract and byte math with byte test verification&quot;</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="byte-jump">
<h4>byte_jump<a class="headerlink" href="#byte-jump" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">byte_jump</span></code> keyword allows for the ability to select a <code class="docutils literal notranslate"><span class="pre">&lt;num</span> <span class="pre">of</span> <span class="pre">bytes&gt;</span></code> from an <code class="docutils literal notranslate"><span class="pre">&lt;offset&gt;</span></code> and moves the detection pointer to that position.  Content matches will then be based off the new position.</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte_jump</span><span class="p">:</span><span class="o">&lt;</span><span class="n">num</span> <span class="n">of</span> <span class="nb">bytes</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">variable</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">offset</span><span class="o">&gt;</span> <span class="p">[,</span> <span class="n">relative</span><span class="p">][,</span> <span class="n">multiplier</span> <span class="o">&lt;</span><span class="n">mult_value</span><span class="o">&gt;</span><span class="p">]</span> \
      <span class="p">[,</span> <span class="o">&lt;</span><span class="n">endian</span><span class="o">&gt;</span><span class="p">][,</span> <span class="n">string</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">num_type</span><span class="o">&gt;</span><span class="p">][,</span> <span class="n">align</span><span class="p">][,</span> <span class="n">from_beginning</span><span class="p">][,</span> <span class="n">from_end</span><span class="p">]</span> \
      <span class="p">[,</span> <span class="n">post_offset</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">][,</span> <span class="n">dce</span><span class="p">][,</span> <span class="n">bitmask</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">];</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&lt;num of bytes&gt;</td>
<td>The number of bytes selected from the packet to be converted
or the name of a byte_extract/byte_math variable.</td>
</tr>
<tr class="row-even"><td>&lt;offset&gt;</td>
<td>Number of bytes into the payload</td>
</tr>
<tr class="row-odd"><td>[relative]</td>
<td>Offset relative to last content match</td>
</tr>
<tr class="row-even"><td>[multiplier] &lt;value&gt;</td>
<td>Multiple the converted byte by the &lt;value&gt;</td>
</tr>
<tr class="row-odd"><td>[endian]</td>
<td><ul class="first last simple">
<li>big (Most significant byte at lowest address)</li>
<li>little (Most significant byte at the highest address)</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>[string] &lt;num_type&gt;</td>
<td><ul class="first last simple">
<li>hex Converted data is represented in hex</li>
<li>dec Converted data is represented in decimal</li>
<li>oct Converted data is represented as octal</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>[align]</td>
<td>Rounds the number up to the next 32bit boundary</td>
</tr>
<tr class="row-even"><td>[from_beginning]</td>
<td>Jumps forward from the beginning of the packet, instead of
where the detection pointer is set</td>
</tr>
<tr class="row-odd"><td>[from_end]</td>
<td>Jump will begin at the end of the payload, instead of
where the detection point is set</td>
</tr>
<tr class="row-even"><td>[post_offset] &lt;value&gt;</td>
<td>After the jump operation has been performed, it will
jump an additional number of bytes specified by &lt;value&gt;</td>
</tr>
<tr class="row-odd"><td>[dce]</td>
<td>Allow the DCE module to determine the byte order</td>
</tr>
<tr class="row-even"><td>[bitmask] &lt;value&gt;</td>
<td>The AND operator will be applied by &lt;value&gt; and the
converted bytes, then jump operation is performed</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
      <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Jump Example&quot;</span><span class="p">;</span> \
      <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Alice&quot;</span><span class="p">;</span> <span class="n">byte_jump</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Bob&quot;</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
      <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Jump Multiple Jumps&quot;</span><span class="p">;</span> \
      <span class="n">byte_jump</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">;</span> <span class="n">byte_jump</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">relative</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;foobar&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span> <span class="n">within</span><span class="p">:</span><span class="mi">6</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
      <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Jump From the End -8 Bytes&quot;</span><span class="p">;</span> \
      <span class="n">byte_jump</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">from_end</span><span class="p">,</span> <span class="n">post_offset</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span> \
      <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|6c 33 33 74|&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="mi">0</span> <span class="n">within</span><span class="p">:</span><span class="mi">4</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="byte-extract">
<h4>byte_extract<a class="headerlink" href="#byte-extract" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> keyword extracts <code class="docutils literal notranslate"><span class="pre">&lt;num</span> <span class="pre">of</span> <span class="pre">bytes&gt;</span></code> at a particular <code class="docutils literal notranslate"><span class="pre">&lt;offset&gt;</span></code> and stores it in <code class="docutils literal notranslate"><span class="pre">&lt;var_name&gt;</span></code>. The value in <code class="docutils literal notranslate"><span class="pre">&lt;var_name&gt;</span></code> can be used in any modifier that takes a number as an option and in the case of <code class="docutils literal notranslate"><span class="pre">byte_test</span></code> it can be used as a value.</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte_extract</span><span class="p">:</span><span class="o">&lt;</span><span class="n">num</span> <span class="n">of</span> <span class="nb">bytes</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">offset</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">var_name</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[,</span><span class="n">relative</span><span class="p">]</span> <span class="p">[,</span><span class="n">multiplier</span> <span class="o">&lt;</span><span class="n">mult</span><span class="o">-</span><span class="n">value</span><span class="o">&gt;</span><span class="p">]</span> \
      <span class="p">[,</span><span class="o">&lt;</span><span class="n">endian</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[,</span> <span class="n">dce</span><span class="p">]</span> <span class="p">[,</span> <span class="n">string</span> <span class="p">[,</span> <span class="o">&lt;</span><span class="n">num_type</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[,</span> <span class="n">align</span> <span class="o">&lt;</span><span class="n">align</span><span class="o">-</span><span class="n">value</span><span class="p">];</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&lt;num of bytes&gt;</td>
<td>The number of bytes selected from the packet to be extracted</td>
</tr>
<tr class="row-even"><td>&lt;offset&gt;</td>
<td>Number of bytes into the payload</td>
</tr>
<tr class="row-odd"><td>&lt;var_name&gt;</td>
<td>The name of the variable in which to store the value</td>
</tr>
<tr class="row-even"><td>[relative]</td>
<td>Offset relative to last content match</td>
</tr>
<tr class="row-odd"><td>multiplier &lt;value&gt;</td>
<td>multiply the extracted bytes by &lt;mult-value&gt; before storing</td>
</tr>
<tr class="row-even"><td>[endian]</td>
<td>Type of number being read:
- big (Most significant byte at lowest address)
- little (Most significant byte at the highest address)</td>
</tr>
<tr class="row-odd"><td>[string] &lt;num&gt;</td>
<td><ul class="first last simple">
<li>hex - Converted string represented in hex</li>
<li>dec - Converted string represented in decimal</li>
<li>oct - Converted string represented in octal</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>[dce]</td>
<td>Allow the DCE module to determine the byte order</td>
</tr>
<tr class="row-odd"><td>align &lt;align-value&gt;</td>
<td>Round the extracted value up to the next
&lt;align-value&gt; byte boundary post-multiplication (if any)
; &lt;align-value&gt; may be 2 or 4</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Keyword</th>
<th class="head">Modifier</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>content</td>
<td>offset,depth,distance,within</td>
</tr>
<tr class="row-odd"><td>byte_test</td>
<td>offset,value</td>
</tr>
<tr class="row-even"><td>byte_math</td>
<td>rvalue</td>
</tr>
<tr class="row-odd"><td>byte_jump</td>
<td>offset</td>
</tr>
<tr class="row-even"><td>isdataat</td>
<td>offset</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Extract Example Using distance&quot;</span><span class="p">;</span> \
       <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Alice&quot;</span><span class="p">;</span> <span class="n">byte_extract</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Bob&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="n">size</span><span class="p">;</span> <span class="n">within</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Extract Example Using within&quot;</span><span class="p">;</span> \
       <span class="n">flow</span><span class="p">:</span><span class="n">established</span><span class="p">,</span><span class="n">to_server</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 FF|&quot;</span><span class="p">;</span> \
       <span class="n">byte_extract</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">,</span><span class="n">relative</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|5c 00|&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span> <span class="n">within</span><span class="p">:</span><span class="nb">len</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> \
       <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Byte_Extract Example Comparing Bytes&quot;</span><span class="p">;</span> \
       <span class="n">flow</span><span class="p">:</span><span class="n">established</span><span class="p">,</span><span class="n">to_server</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|00 FF|&quot;</span><span class="p">;</span> \
       <span class="n">byte_extract</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cmp_ver</span><span class="p">,</span><span class="n">relative</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;FooBar&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span> <span class="n">byte_test</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="o">=</span><span class="p">,</span><span class="n">cmp_ver</span><span class="p">,</span><span class="mi">0</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="rpc">
<h4>rpc<a class="headerlink" href="#rpc" title="Permalink to this headline">¶</a></h4>
<p>The rpc keyword can be used to match in the SUNRPC CALL on the RPC
procedure numbers and the RPC version.</p>
<p>You can modify the keyword by using a wild-card, defined with * With
this wild-card you can match on all version and/or procedure numbers.</p>
<p>RPC (Remote Procedure Call) is an application that allows a computer
program to execute a procedure on another computer (or address
space). It is used for inter-process communication. See
<a class="reference external" href="http://en.wikipedia.org/wiki/Inter-process_communication">http://en.wikipedia.org/wiki/Inter-process_communication</a></p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpc</span><span class="p">:</span><span class="o">&lt;</span><span class="n">application</span> <span class="n">number</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">version</span> <span class="n">number</span><span class="o">&gt;|*</span><span class="p">],</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">procedure</span> <span class="n">number</span><span class="o">&gt;|*</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of the rpc keyword in a rule:</p>
<div class="example-rule docutils container">
alert udp $EXTERNAL_NET any -&gt; $HOME_NET 111 (msg:&quot;RPC portmap request yppasswdd&quot;; <span class="example-rule-emphasis">rpc:100009,*,*;</span> reference:bugtraq,2763; classtype:rpc-portmap-decode; sid:1296; rev:4;)</div>
</div>
<div class="section" id="replace">
<h4>replace<a class="headerlink" href="#replace" title="Permalink to this headline">¶</a></h4>
<p>The replace content modifier can only be used in ips. It adjusts
network traffic.  It changes the content it follows ('abc') into
another ('def'), see example:</p>
<img alt="_images/replace.png" src="_images/replace.png" />
<img alt="_images/replace1.png" src="_images/replace1.png" />
<p>The replace modifier has to contain as many characters as the content
it replaces.  It can only be used with individual packets. It will not
work for <a class="reference internal" href="index.html#rules-normalized-buffers"><span class="std std-ref">Normalized Buffers</span></a> like HTTP uri or a content match in
the reassembled stream.</p>
<p>The checksums will be recalculated by Suricata and changed after the
replace keyword is being used.</p>
</div>
<div class="section" id="pcre-perl-compatible-regular-expressions">
<h4>pcre (Perl Compatible Regular Expressions)<a class="headerlink" href="#pcre-perl-compatible-regular-expressions" title="Permalink to this headline">¶</a></h4>
<p>The keyword pcre matches specific on regular expressions. More
information about regular expressions can be found here
<a class="reference external" href="http://en.wikipedia.org/wiki/Regular_expression">http://en.wikipedia.org/wiki/Regular_expression</a>.</p>
<p>The complexity of pcre comes with a high price though: it has a
negative influence on performance. So, to mitigate Suricata from
having to check pcre often, pcre is mostly combined with 'content'. In
that case, the content has to match first, before pcre will be
checked.</p>
<p>Format of pcre:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/&lt;regex&gt;/opts&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of pcre. In this example there will be a match if the payload contains six
numbers following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/[0-9]</span><span class="si">{6}</span><span class="s2">/&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of pcre in a signature:</p>
<div class="example-rule docutils container">
drop tcp $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;ET TROJAN Likely Bot Nick in IRC (USA +..)&quot;; flow:established,to_server; flowbits:isset,is_proto_irc; content:&quot;NICK &quot;; <span class="example-rule-emphasis">pcre:&quot;/NICK .*USA.*[0-9]{3,}/i&quot;;</span> reference:url,doc.emergingthreats.net/2008124; classtype:trojan-activity; sid:2008124; rev:2;)</div>
<p>There are a few qualities of pcre which can be modified:</p>
<ul class="simple">
<li>By default pcre is case-sensitive.</li>
<li>The . (dot) is a part of regex. It matches on every byte except for
newline characters.</li>
<li>By default the payload will be inspected as one line.</li>
</ul>
<p>These qualities can be modified with the following characters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span>    <span class="n">pcre</span> <span class="ow">is</span> <span class="n">case</span> <span class="n">insensitive</span>
<span class="n">s</span>    <span class="n">pcre</span> <span class="n">does</span> <span class="n">check</span> <span class="n">newline</span> <span class="n">characters</span>
<span class="n">m</span>    <span class="n">can</span> <span class="n">make</span> <span class="n">one</span> <span class="n">line</span> <span class="p">(</span><span class="n">of</span> <span class="n">the</span> <span class="n">payload</span><span class="p">)</span> <span class="n">count</span> <span class="k">as</span> <span class="n">two</span> <span class="n">lines</span>
</pre></div>
</div>
<p>These options are perl compatible modifiers. To use these modifiers,
you should add them to pcre, behind regex. Like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcre</span><span class="p">:</span> <span class="s2">&quot;/&lt;regex&gt;/i&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><em>Pcre compatible modifiers</em></p>
<p>There are a few pcre compatible modifiers which can change the
qualities of pcre as well.  These are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">A</span></code>: A pattern has to match at the beginning of a buffer. (In pcre
^ is similar to A.)</li>
<li><code class="docutils literal notranslate"><span class="pre">E</span></code>: Ignores newline characters at the end of the buffer/payload.</li>
<li><code class="docutils literal notranslate"><span class="pre">G</span></code>: Inverts the greediness.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following characters must be escaped inside the content:
<code class="docutils literal notranslate"><span class="pre">;</span></code> <code class="docutils literal notranslate"><span class="pre">\</span></code> <code class="docutils literal notranslate"><span class="pre">&quot;</span></code></p>
</div>
<div class="section" id="suricata-s-modifiers">
<h5>Suricata's modifiers<a class="headerlink" href="#suricata-s-modifiers" title="Permalink to this headline">¶</a></h5>
<p>Suricata has its own specific pcre modifiers. These are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">R</span></code>: Match relative to the last pattern match. It is similar to distance:0;</li>
<li><code class="docutils literal notranslate"><span class="pre">U</span></code>: Makes pcre match on the normalized uri. It matches on the
uri_buffer just like uricontent and content combined with http_uri.U
can be combined with /R. Note that R is relative to the previous
match so both matches have to be in the HTTP-uri buffer. Read more
about <a class="reference internal" href="index.html#rules-http-uri-normalization"><span class="std std-ref">HTTP URI Normalization</span></a>.</li>
</ul>
<img alt="_images/pcre3.png" src="_images/pcre3.png" />
<img alt="_images/pcre4.png" src="_images/pcre4.png" />
<img alt="_images/pcre5.png" src="_images/pcre5.png" />
<img alt="_images/pcre6.png" src="_images/pcre6.png" />
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">I</span></code>: Makes pcre match on the HTTP-raw-uri. It matches on the same
buffer as http_raw_uri.  I can be combined with /R. Note that R is
relative to the previous match so both matches have to be in the
HTTP-raw-uri buffer. Read more about <a class="reference internal" href="index.html#rules-http-uri-normalization"><span class="std std-ref">HTTP URI Normalization</span></a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">P</span></code>: Makes pcre match on the HTTP- request-body. So, it matches on
the same buffer as http_client_body. P can be combined with /R. Note
that R is relative to the previous match so both matches have to be
in the HTTP-request body.</li>
<li><code class="docutils literal notranslate"><span class="pre">Q</span></code>: Makes pcre match on the HTTP- response-body. So, it matches
on the same buffer as http_server_body. Q can be combined with
/R. Note that R is relative to the previous match so both matches
have to be in the HTTP-response body.</li>
<li><code class="docutils literal notranslate"><span class="pre">H</span></code>: Makes pcre match on the HTTP-header.  H can be combined with
/R. Note that R is relative to the previous match so both matches have
to be in the HTTP-header body.</li>
<li><code class="docutils literal notranslate"><span class="pre">D</span></code>: Makes pcre match on the unnormalized header. So, it matches
on the same buffer as http_raw_header.  D can be combined with
/R. Note that R is relative to the previous match so both matches
have to be in the HTTP-raw-header.</li>
<li><code class="docutils literal notranslate"><span class="pre">M</span></code>: Makes pcre match on the request-method. So, it matches on the
same buffer as http_method.  M can be combined with /R. Note that R
is relative to the previous match so both matches have to be in the
HTTP-method buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">C</span></code>: Makes pcre match on the HTTP-cookie. So, it matches on the
same buffer as http_cookie.  C can be combined with /R. Note that R
is relative to the previous match so both matches have to be in the
HTTP-cookie buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">S</span></code>: Makes pcre match on the HTTP-stat-code. So, it matches on the
same buffer as http_stat_code.  S can be combined with /R. Note that
R is relative to the previous match so both matches have to be in
the HTTP-stat-code buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">Y</span></code>: Makes pcre match on the HTTP-stat-msg. So, it matches on the
same buffer as http_stat_msg.  Y can be combined with /R. Note that
R is relative to the previous match so both matches have to be in
the HTTP-stat-msg buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">B</span></code>: You can encounter B in signatures but this is just for
compatibility. So, Suricata does not use B but supports it so it
does not cause errors.</li>
<li><code class="docutils literal notranslate"><span class="pre">O</span></code>: Overrides the configures pcre match limit.</li>
<li><code class="docutils literal notranslate"><span class="pre">V</span></code>: Makes pcre match on the HTTP-User-Agent. So, it matches on
the same buffer as http_user_agent.  V can be combined with /R. Note
that R is relative to the previous match so both matches have to be
in the HTTP-User-Agent buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">W</span></code>: Makes pcre match on the HTTP-Host. So, it matches on the same
buffer as http_host.  W can be combined with /R. Note that R is
relative to the previous match so both matches have to be in the
HTTP-Host buffer.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="changes-from-pcre1-to-pcre2">
<span id="pcre-update-v1-to-v2"></span><h3>Changes from PCRE1 to PCRE2<a class="headerlink" href="#changes-from-pcre1-to-pcre2" title="Permalink to this headline">¶</a></h3>
<p>The upgrade from PCRE1 to PCRE2 changes the behavior for some
PCRE expressions.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">\I</span></code> is a valid pcre in PCRE1, with a useless escape, so
equivalent to <code class="docutils literal notranslate"><span class="pre">I</span></code>, but it is no longer the case in PCRE2.
There are other characters than I exhibiting this pattern</li>
<li><code class="docutils literal notranslate"><span class="pre">[\d-a]</span></code> is a valid pcre in PCRE1, with either a digit,
a dash or the character <code class="docutils literal notranslate"><span class="pre">a</span></code>, but the dash must now be escaped
with PCRE2 as <code class="docutils literal notranslate"><span class="pre">[\d\-a]</span></code> to get the same behavior</li>
<li><code class="docutils literal notranslate"><span class="pre">pcre2_substring_copy_bynumber</span></code> now returns an error
<code class="docutils literal notranslate"><span class="pre">PCRE2_ERROR_UNSET</span></code> instead of <code class="docutils literal notranslate"><span class="pre">pcre_copy_substring</span></code> returning
no error and giving an empty string. If the behavior of some use
case is no longer the expected one, please let us know.</li>
</ul>
</div>
<span id="document-rules/transforms"></span><div class="section" id="transformations">
<h3>Transformations<a class="headerlink" href="#transformations" title="Permalink to this headline">¶</a></h3>
<p>Transformation keywords turn the data at a sticky buffer into something else. Some transformations
support options for greater control over the transformation process</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">file_data</span><span class="p">;</span> <span class="n">strip_whitespace</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;window.navigate(&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>This example will match on traffic even if there are one or more spaces between
the <code class="docutils literal notranslate"><span class="pre">navigate</span></code> and <code class="docutils literal notranslate"><span class="pre">(</span></code>.</p>
<p>The transforms can be chained. They are processed in the order in which they
appear in a rule. Each transform's output acts as input for the next one.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http_request_line</span><span class="p">;</span> <span class="n">compress_whitespace</span><span class="p">;</span> <span class="n">to_sha256</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|54A9 7A8A B09C 1B81 3725 2214 51D3 F997 F015 9DD7 049E E5AD CED3 945A FC79 7401|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">not all sticky buffers support transformations yet</p>
</div>
<div class="section" id="dotprefix">
<h4>dotprefix<a class="headerlink" href="#dotprefix" title="Permalink to this headline">¶</a></h4>
<p>Takes the buffer, and prepends a <code class="docutils literal notranslate"><span class="pre">.</span></code> character to help facilitate concise domain checks. For example,
an input string of <code class="docutils literal notranslate"><span class="pre">hello.google.com</span></code> would be modified and become <code class="docutils literal notranslate"><span class="pre">.hello.google.com</span></code>. Additionally,
adding the dot allows <code class="docutils literal notranslate"><span class="pre">google.com</span></code> to match against <code class="docutils literal notranslate"><span class="pre">content:&quot;.google.com&quot;</span></code></p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">dns</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">dotprefix</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;.microsoft.com&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>This example will match on <code class="docutils literal notranslate"><span class="pre">windows.update.microsoft.com</span></code> and
<code class="docutils literal notranslate"><span class="pre">maps.microsoft.com.au</span></code> but not <code class="docutils literal notranslate"><span class="pre">windows.update.fakemicrosoft.com</span></code>.</p>
<p>This rule can be used to match on the domain only; example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">dns</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">dotprefix</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;.microsoft.com&quot;</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>This example will match on <code class="docutils literal notranslate"><span class="pre">windows.update.microsoft.com</span></code> but not
<code class="docutils literal notranslate"><span class="pre">windows.update.microsoft.com.au</span></code>.</p>
<p>Finally, this rule can be used to match on the TLD only; example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">dns</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">dotprefix</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;.co.uk&quot;</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>This example will match on <code class="docutils literal notranslate"><span class="pre">maps.google.co.uk</span></code> but not
<code class="docutils literal notranslate"><span class="pre">maps.google.co.nl</span></code>.</p>
</div>
<div class="section" id="strip-whitespace">
<h4>strip_whitespace<a class="headerlink" href="#strip-whitespace" title="Permalink to this headline">¶</a></h4>
<p>Strips all whitespace as considered by the <code class="docutils literal notranslate"><span class="pre">isspace()</span></code> call in C.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">file_data</span><span class="p">;</span> <span class="n">strip_whitespace</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;window.navigate(&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="compress-whitespace">
<h4>compress_whitespace<a class="headerlink" href="#compress-whitespace" title="Permalink to this headline">¶</a></h4>
<p>Compresses all consecutive whitespace into a single space.</p>
</div>
<div class="section" id="to-md5">
<h4>to_md5<a class="headerlink" href="#to-md5" title="Permalink to this headline">¶</a></h4>
<p>Takes the buffer, calculates the MD5 hash and passes the raw hash value
on.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http_request_line</span><span class="p">;</span> <span class="n">to_md5</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|54 A9 7A 8A B0 9C 1B 81 37 25 22 14 51 D3 F9 97|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="to-sha1">
<h4>to_sha1<a class="headerlink" href="#to-sha1" title="Permalink to this headline">¶</a></h4>
<p>Takes the buffer, calculates the SHA-1 hash and passes the raw hash value
on.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http_request_line</span><span class="p">;</span> <span class="n">to_sha1</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|54A9 7A8A B09C 1B81 3725 2214 51D3 F997 F015 9DD7|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="to-sha256">
<h4>to_sha256<a class="headerlink" href="#to-sha256" title="Permalink to this headline">¶</a></h4>
<p>Takes the buffer, calculates the SHA-256 hash and passes the raw hash value
on.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http_request_line</span><span class="p">;</span> <span class="n">to_sha256</span><span class="p">;</span> \
    <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|54A9 7A8A B09C 1B81 3725 2214 51D3 F997 F015 9DD7 049E E5AD CED3 945A FC79 7401|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="pcrexform">
<h4>pcrexform<a class="headerlink" href="#pcrexform" title="Permalink to this headline">¶</a></h4>
<p>Takes the buffer, applies the required regular expression, and outputs the <em>first captured expression</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">this transform requires a mandatory option string containing a regular expression.</p>
</div>
<p>This example alerts if <code class="docutils literal notranslate"><span class="pre">http.request_line</span></code> contains <code class="docutils literal notranslate"><span class="pre">/dropper.php</span></code>
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;HTTP with pcrexform&quot;</span><span class="p">;</span> <span class="n">http</span><span class="o">.</span><span class="n">request_line</span><span class="p">;</span> \
    <span class="n">pcrexform</span><span class="p">:</span><span class="s2">&quot;[a-zA-Z]+\s+(.*)\s+HTTP&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;/dropper.php&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="url-decode">
<h4>url_decode<a class="headerlink" href="#url-decode" title="Permalink to this headline">¶</a></h4>
<p>Decodes url-encoded data, ie replacing '+' with space and '%HH' with its value.
This does not decode unicode '%uZZZZ' encoding</p>
</div>
<div class="section" id="xor">
<h4>xor<a class="headerlink" href="#xor" title="Permalink to this headline">¶</a></h4>
<p>Takes the buffer, applies xor decoding.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">this transform requires a mandatory option which is the hexadecimal encoded xor key.</p>
</div>
<p>This example alerts if <code class="docutils literal notranslate"><span class="pre">http.uri</span></code> contains <code class="docutils literal notranslate"><span class="pre">password=</span></code> xored with 4-bytes key <code class="docutils literal notranslate"><span class="pre">0d0ac8ff</span></code>
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;HTTP with xor&quot;</span><span class="p">;</span> <span class="n">http</span><span class="o">.</span><span class="n">uri</span><span class="p">;</span> \
    <span class="n">xor</span><span class="p">:</span><span class="s2">&quot;0d0ac8ff&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;password=&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-rules/prefilter-keywords"></span><div class="section" id="prefiltering-keywords">
<h3>Prefiltering Keywords<a class="headerlink" href="#prefiltering-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="fast-pattern">
<span id="rules-keyword-fast-pattern"></span><h4>fast_pattern<a class="headerlink" href="#fast-pattern" title="Permalink to this headline">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-rules/fast-pattern-explained"></span><div class="section" id="suricata-fast-pattern-determination-explained">
<h5>Suricata Fast Pattern Determination Explained<a class="headerlink" href="#suricata-fast-pattern-determination-explained" title="Permalink to this headline">¶</a></h5>
<p>If the 'fast_pattern' keyword is explicitly set in a rule, Suricata
will use that as the fast pattern match. The 'fast_pattern' keyword
can only be set once per rule. If 'fast_pattern' is not set, Suricata
automatically determines the content to use as the fast pattern match.</p>
<p>The following explains the logic Suricata uses to automatically
determine the fast pattern match to use.</p>
<p>Be aware that if there are positive (i.e. non-negated) content
matches, then negated content matches are ignored for fast pattern
determination. Otherwise, negated content matches are considered.</p>
<p>The fast_pattern selection criteria are as follows:</p>
<ol class="arabic simple">
<li>Suricata first identifies all content matches that have the highest
&quot;priority&quot; that are used in the signature.  The priority is based
off of the buffer being matched on and generally 'http_*' buffers
have a higher priority (lower number is higher priority).  See
<a class="reference internal" href="#fast-pattern-explained-appendix-b"><span class="std std-ref">Appendix B</span></a> for details
on which buffers have what priority.</li>
<li>Within the content matches identified in step 1 (the highest
priority content matches), the longest (in terms of character/byte
length) content match is used as the fast pattern match.</li>
<li>If multiple content matches have the same highest priority and
qualify for the longest length, the one with the highest
character/byte diversity score (&quot;Pattern Strength&quot;) is used as the
fast pattern match.  See <a class="reference internal" href="#fast-pattern-explained-appendix-c"><span class="std std-ref">Appendix C</span></a> for details on the algorithm
used to determine Pattern Strength.</li>
<li>If multiple content matches have the same highest priority, qualify
for the longest length, and the same highest Pattern Strength, the
buffer (&quot;list_id&quot;) that was <em>registered last</em> is used as the fast
pattern match.  See <a class="reference internal" href="#fast-pattern-explained-appendix-b"><span class="std std-ref">Appendix B</span></a> for the registration order of
the different buffers/lists.</li>
<li>If multiple content matches have the same highest priority, qualify
for the longest length, the same highest Pattern Strength, and have
the same list_id (i.e. are looking in the same buffer), then the
one that comes first (from left-to-right) in the rule is used as
the fast pattern match.</li>
</ol>
<p>It is worth noting that for content matches that have the same
priority, length, and Pattern Strength, 'http_stat_msg',
'http_stat_code', and 'http_method' take precedence over regular
'content' matches.</p>
<div class="section" id="appendices">
<h6>Appendices<a class="headerlink" href="#appendices" title="Permalink to this headline">¶</a></h6>
<div class="section" id="appendix-a-buffers-list-id-values-and-registration-order-for-suricata-1-3-4">
<span id="fast-pattern-explained-appendix-a"></span><h7>Appendix A - Buffers, list_id values, and Registration Order for Suricata 1.3.4<a class="headerlink" href="#appendix-a-buffers-list-id-values-and-registration-order-for-suricata-1-3-4" title="Permalink to this headline">¶</a></h7>
<p>This should be pretty much the same for Suricata 1.1.x - 1.4.x.</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="38%" />
<col width="30%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">list_id</th>
<th class="head">Content Modifier Keyword</th>
<th class="head">Buffer Name</th>
<th class="head">Registration Order</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>&lt;none&gt; (regular content match)</td>
<td>DETECT_SM_LIST_PMATCH</td>
<td>1 (first)</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>http_uri</td>
<td>DETECT_SM_LIST_UMATCH</td>
<td>2</td>
</tr>
<tr class="row-even"><td>6</td>
<td>http_client_body</td>
<td>DETECT_SM_LIST_HCBDMATCH</td>
<td>3</td>
</tr>
<tr class="row-odd"><td>7</td>
<td>http_server_body</td>
<td>DETECT_SM_LIST_HSBDMATCH</td>
<td>4</td>
</tr>
<tr class="row-even"><td>8</td>
<td>http_header</td>
<td>DETECT_SM_LIST_HHDMATCH</td>
<td>5</td>
</tr>
<tr class="row-odd"><td>9</td>
<td>http_raw_header</td>
<td>DETECT_SM_LIST_HRHDMATCH</td>
<td>6</td>
</tr>
<tr class="row-even"><td>10</td>
<td>http_method</td>
<td>DETECT_SM_LIST_HMDMATCH</td>
<td>7</td>
</tr>
<tr class="row-odd"><td>11</td>
<td>http_cookie</td>
<td>DETECT_SM_LIST_HCDMATCH</td>
<td>8</td>
</tr>
<tr class="row-even"><td>12</td>
<td>http_raw_uri</td>
<td>DETECT_SM_LIST_HRUDMATCH</td>
<td>9</td>
</tr>
<tr class="row-odd"><td>13</td>
<td>http_stat_msg</td>
<td>DETECT_SM_LIST_HSMDMATCH</td>
<td>10</td>
</tr>
<tr class="row-even"><td>14</td>
<td>http_stat_code</td>
<td>DETECT_SM_LIST_HSCDMATCH</td>
<td>11</td>
</tr>
<tr class="row-odd"><td>15</td>
<td>http_user_agent</td>
<td>DETECT_SM_LIST_HUADMATCH</td>
<td>12 (last)</td>
</tr>
</tbody>
</table>
<p>Note: registration order doesn't matter when it comes to determining the fast pattern match for Suricata 1.3.4 but list_id value does.</p>
</div>
<div class="section" id="appendix-b-buffers-list-id-values-priorities-and-registration-order-for-suricata-2-0-7">
<span id="fast-pattern-explained-appendix-b"></span><h7>Appendix B - Buffers, list_id values, Priorities, and Registration Order for Suricata 2.0.7<a class="headerlink" href="#appendix-b-buffers-list-id-values-priorities-and-registration-order-for-suricata-2-0-7" title="Permalink to this headline">¶</a></h7>
<p>This should be pretty much the same for Suricata 2.0.x.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="14%" />
<col width="24%" />
<col width="23%" />
<col width="6%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Priority (lower number is higher priority)</th>
<th class="head">Registration Order</th>
<th class="head">Content Modifier Keyword</th>
<th class="head">Buffer Name</th>
<th class="head">list_id</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>3</td>
<td>11</td>
<td>&lt;none&gt; (regular content match)</td>
<td>DETECT_SM_LIST_PMATCH</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>12</td>
<td>http_method</td>
<td>DETECT_SM_LIST_HMDMATCH</td>
<td>12</td>
</tr>
<tr class="row-even"><td>3</td>
<td>13</td>
<td>http_stat_code</td>
<td>DETECT_SM_LIST_HSCDMATCH</td>
<td>9</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>14</td>
<td>http_stat_msg</td>
<td>DETECT_SM_LIST_HSMDMATCH</td>
<td>8</td>
</tr>
<tr class="row-even"><td>2</td>
<td>1 (first)</td>
<td>http_client_body</td>
<td>DETECT_SM_LIST_HCBDMATCH</td>
<td>4</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>2</td>
<td>http_server_body</td>
<td>DETECT_SM_LIST_HSBDMATCH</td>
<td>5</td>
</tr>
<tr class="row-even"><td>2</td>
<td>3</td>
<td>http_header</td>
<td>DETECT_SM_LIST_HHDMATCH</td>
<td>6</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>4</td>
<td>http_raw_header</td>
<td>DETECT_SM_LIST_HRHDMATCH</td>
<td>7</td>
</tr>
<tr class="row-even"><td>2</td>
<td>5</td>
<td>http_uri</td>
<td>DETECT_SM_LIST_UMATCH</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>6</td>
<td>http_raw_uri</td>
<td>DETECT_SM_LIST_HRUDMATCH</td>
<td>3</td>
</tr>
<tr class="row-even"><td>2</td>
<td>7</td>
<td>http_host</td>
<td>DETECT_SM_LIST_HHHDMATCH</td>
<td>10</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>8</td>
<td>http_raw_host</td>
<td>DETECT_SM_LIST_HRHHDMATCH</td>
<td>11</td>
</tr>
<tr class="row-even"><td>2</td>
<td>9</td>
<td>http_cookie</td>
<td>DETECT_SM_LIST_HCDMATCH</td>
<td>13</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>10</td>
<td>http_user_agent</td>
<td>DETECT_SM_LIST_HUADMATCH</td>
<td>14</td>
</tr>
<tr class="row-even"><td>2</td>
<td>15 (last)</td>
<td>dns_query</td>
<td>DETECT_SM_LIST_DNSQUERY_MATCH</td>
<td>20</td>
</tr>
</tbody>
</table>
<p>Note: list_id value doesn't matter when it comes to determining the
fast pattern match for Suricata 2.0.7 but registration order does.</p>
</div>
<div class="section" id="appendix-c-pattern-strength-algorithm">
<span id="fast-pattern-explained-appendix-c"></span><h7>Appendix C - Pattern Strength Algorithm<a class="headerlink" href="#appendix-c-pattern-strength-algorithm" title="Permalink to this headline">¶</a></h7>
<p>From detect-engine-mpm.c. Basically the Pattern Strength &quot;score&quot;
starts at zero and looks at each character/byte in the passed in byte
array from left to right. If the character/byte has not been seen
before in the array, it adds 3 to the score if it is an alpha
character; else it adds 4 to the score if it is a printable character,
0x00, 0x01, or 0xFF; else it adds 6 to the score. If the
character/byte has been seen before it adds 1 to the score. The final
score is returned.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** \brief Predict a strength value for patterns</span>
<span class="cm"> *</span>
<span class="cm"> *  Patterns with high character diversity score higher.</span>
<span class="cm"> *  Alpha chars score not so high</span>
<span class="cm"> *  Other printable + a few common codes a little higher</span>
<span class="cm"> *  Everything else highest.</span>
<span class="cm"> *  Longer patterns score better than short patters.</span>
<span class="cm"> *</span>
<span class="cm"> *  \param pat pattern</span>
<span class="cm"> *  \param patlen length of the pattern</span>
<span class="cm"> *</span>
<span class="cm"> *  \retval s pattern score</span>
<span class="cm"> */</span>
<span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">PatternStrength</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pat</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">patlen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">     </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
<span class="w">     </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">     </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">patlen</span><span class="p">;</span><span class="w"> </span><span class="n">u</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isalpha</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
<span class="w">                 </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">             </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isprint</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">u</span><span class="p">])</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pat</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pat</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pat</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">                 </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">             </span><span class="k">else</span>
<span class="w">                 </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="w">             </span><span class="n">a</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<p>Only one content of a signature will be used in the Multi Pattern
Matcher (MPM). If there are multiple contents, then Suricata uses the
'strongest' content. This means a combination of length, how varied a
content is, and what buffer it is looking in. Generally, the longer
and more varied the better. For full details on how Suricata
determines the fast pattern match, see <a class="reference internal" href="index.html#document-rules/fast-pattern-explained"><span class="doc">Suricata Fast Pattern Determination Explained</span></a>.</p>
<p>Sometimes a signature writer concludes he wants Suricata to use
another content than it does by default.</p>
<p>For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">-</span><span class="n">agent</span><span class="p">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="n">Badness</span><span class="p">;</span>

<span class="n">content</span><span class="p">:</span><span class="s2">&quot;User-Agent|3A|&quot;</span><span class="p">;</span>
<span class="n">content</span><span class="p">:</span><span class="s2">&quot;Badness&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>In this example you see the first content is longer and more varied
than the second one, so you know Suricata will use this content for
the MPM.  Because 'User-Agent:' will be a match very often, and
'Badness' appears less often in network traffic, you can make Suricata
use the second content by using 'fast_pattern'.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;User-Agent|3A|&quot;</span><span class="p">;</span>
<span class="n">content</span><span class="p">:</span><span class="s2">&quot;Badness&quot;</span><span class="p">;</span> <span class="n">distance</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span> <span class="n">fast_pattern</span><span class="p">;</span>
</pre></div>
</div>
<p>The keyword fast_pattern modifies the content previous to it.</p>
<img alt="_images/fast_pattern.png" src="_images/fast_pattern.png" />
<p>Fast-pattern can also be combined with all previous mentioned
keywords, and all mentioned HTTP-modifiers.</p>
<div class="section" id="fast-pattern-only">
<h5>fast_pattern:only<a class="headerlink" href="#fast-pattern-only" title="Permalink to this headline">¶</a></h5>
<p>Sometimes a signature contains only one content. In that case it is
not necessary Suricata will check it any further after a match has
been found in MPM. If there is only one content, the whole signature
matches. Suricata notices this automatically. In some signatures this
is still indicated with 'fast_pattern:only;'. Although Suricata does
not need fast_pattern:only, it does support it.</p>
</div>
<div class="section" id="fast-pattern-chop">
<h5>fast_pattern:'chop'<a class="headerlink" href="#fast-pattern-chop" title="Permalink to this headline">¶</a></h5>
<p>If you do not want the MPM to use the whole content, you can use
fast_pattern 'chop'.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span> <span class="s2">&quot;aaaaaaaaabc&quot;</span><span class="p">;</span> <span class="n">fast_pattern</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">;</span>
</pre></div>
</div>
<p>This way, MPM uses only the last four characters.</p>
</div>
</div>
<div class="section" id="prefilter">
<h4>prefilter<a class="headerlink" href="#prefilter" title="Permalink to this headline">¶</a></h4>
<p>The prefilter engines for other non-MPM keywords can be enabled in specific rules by using the 'prefilter' keyword.</p>
<p>In the following rule the TTL test will be used in prefiltering instead of the single byte pattern:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ip</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">ttl</span><span class="p">:</span><span class="mi">123</span><span class="p">;</span> <span class="n">prefilter</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;a&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>For more information on how to configure the prefilter engines, see <a class="reference internal" href="index.html#suricata-yaml-prefilter"><span class="std std-ref">Prefilter Engines</span></a></p>
</div>
</div>
<span id="document-rules/flow-keywords"></span><div class="section" id="flow-keywords">
<h3>Flow Keywords<a class="headerlink" href="#flow-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="flowbits">
<h4>flowbits<a class="headerlink" href="#flowbits" title="Permalink to this headline">¶</a></h4>
<p>Flowbits consists of two parts. The first part describes the action it
is going to perform, the second part is the name of the flowbit.</p>
<p>There are multiple packets that belong to one flow. Suricata keeps
those flows in memory. For more information see
<a class="reference internal" href="index.html#suricata-yaml-flow-settings"><span class="std std-ref">Flow Settings</span></a>.  Flowbits can make sure an alert
will be generated when for example two different packets match.  An
alert will only be generated when both packets match. So, when the
second packet matches, Suricata has to know if the first packet was a
match too. Flowbits marks the flow if a packet matches so Suricata
'knows' it should generate an alert when the second packet matches as
well.</p>
<p>Flowbits have different actions. These are:</p>
<dl class="docutils">
<dt>flowbits: set, name</dt>
<dd>Will set the condition/'name', if present, in the flow.</dd>
<dt>flowbits: isset, name</dt>
<dd>Can be used in the rule to make sure it generates an alert when the
rule matches and the condition is set in the flow.</dd>
<dt>flowbits: toggle, name</dt>
<dd>Reverses the present setting. So for example if a condition is set,
it will be unset and vice-versa.</dd>
<dt>flowbits: unset, name</dt>
<dd>Can be used to unset the condition in the flow.</dd>
<dt>flowbits: isnotset, name</dt>
<dd>Can be used in the rule to make sure it generates an alert when it
matches and the condition is not set in the flow.</dd>
<dt>flowbits: noalert</dt>
<dd>No alert will be generated by this rule.</dd>
</dl>
<p>Example:</p>
<img alt="_images/Flowbit_3.png" src="_images/Flowbit_3.png" />
<p>When you take a look at the first rule you will notice it would
generate an alert if it would match, if it were not for the 'flowbits:
noalert' at the end of that rule. The purpose of this rule is to check
for a match on 'userlogin' and mark that in the flow. So, there is no
need for generating an alert.  The second rule has no effect without
the first rule. If the first rule matches, the flowbits sets that
specific condition to be present in the flow. Now with the second rule
there can be checked whether or not the previous packet fulfills the
first condition. If at that point the second rule matches, an alert
will be generated.</p>
<p>It is possible to use flowbits several times in a rule and combine the
different functions.</p>
<p>It is also possible to perform an <cite>OR</cite> operation with flowbits with <cite>|</cite> op.</p>
<dl class="docutils">
<dt>Example::</dt>
<dd>alert http any any -&gt; any any (msg: &quot;User1 or User2 logged in&quot;; content:&quot;login&quot;; flowbits:isset,user1|user2; sid:1;)</dd>
</dl>
<p>This can be used with either <cite>isset</cite> or <cite>isnotset</cite> action.</p>
</div>
<div class="section" id="flow">
<h4>flow<a class="headerlink" href="#flow" title="Permalink to this headline">¶</a></h4>
<p>The flow keyword can be used to match on direction of the flow, so to/from
client or to/from server. It can also match if the flow is established or not.
The flow keyword can also be used to say the signature has to match on stream
only (only_stream) or on packet only (no_stream).</p>
<p>So with the flow keyword you can match on:</p>
<dl class="docutils">
<dt>to_client</dt>
<dd>Match on packets from server to client.</dd>
<dt>to_server</dt>
<dd>Match on packets from client to server.</dd>
<dt>from_client</dt>
<dd>Match on packets from client to server (same as to_server).</dd>
<dt>from_server</dt>
<dd>Match on packets from server to client (same as to_client).</dd>
<dt>established</dt>
<dd>Match on established connections.</dd>
<dt>not_established</dt>
<dd>Match on packets that are not part of an established connection.</dd>
<dt>stateless</dt>
<dd>Match on packets that are and are not part of an established connection.</dd>
<dt>only_stream</dt>
<dd>Match on packets that have been reassembled by the stream engine.</dd>
<dt>no_stream</dt>
<dd>Match on packets that have not been reassembled by the stream
engine. Will not match packets that have been reassembled.</dd>
<dt>only_frag</dt>
<dd>Match packets that have been reassembled from fragments.</dd>
<dt>no_frag</dt>
<dd>Match packets that have not been reassembled from fragments.</dd>
</dl>
<p>Multiple flow options can be combined, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="p">:</span><span class="n">to_client</span><span class="p">,</span> <span class="n">established</span>
<span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">,</span> <span class="n">established</span><span class="p">,</span> <span class="n">only_stream</span>
<span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">,</span> <span class="n">not_established</span><span class="p">,</span> <span class="n">no_frag</span>
</pre></div>
</div>
<p>The determination of <em>established</em> depends on the protocol:</p>
<ul>
<li><p class="first">For TCP a connection will be established after a three way
handshake.</p>
<img alt="_images/Flow1.png" src="_images/Flow1.png" />
</li>
<li><p class="first">For other protocols (for example UDP), the connection will be
considered established after seeing traffic from both sides of the
connection.</p>
<img alt="_images/Flow2.png" src="_images/Flow2.png" />
</li>
</ul>
</div>
<div class="section" id="flowint">
<h4>flowint<a class="headerlink" href="#flowint" title="Permalink to this headline">¶</a></h4>
<p>Flowint allows storage and mathematical operations using variables. It
operates much like flowbits but with the addition of mathematical
capabilities and the fact that an integer can be stored and
manipulated, not just a flag set. We can use this for a number of very
useful things, such as counting occurrences, adding or subtracting
occurrences, or doing thresholding within a stream in relation to
multiple factors. This will be expanded to a global context very soon,
so users can perform these operations between streams.</p>
<p>The syntax is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowint</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="n">modifier</span><span class="p">[,</span> <span class="n">value</span><span class="p">];</span>
</pre></div>
</div>
<p>Define a var (not required), or check that one is set or not set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowint</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="o">&lt;</span> <span class="o">+</span><span class="p">,</span><span class="o">-</span><span class="p">,</span><span class="o">=</span><span class="p">,</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="p">,</span><span class="o">&gt;=</span><span class="p">,</span><span class="o">&lt;=</span><span class="p">,</span><span class="o">==</span><span class="p">,</span> <span class="o">!=</span> <span class="o">&gt;</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
<span class="n">flowint</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">isset</span><span class="o">|</span><span class="n">isnotset</span><span class="p">);</span>
</pre></div>
</div>
<p>Compare or alter a var. Add, subtract, compare greater than or less
than, greater than or equal to, and less than or equal to are
available. The item to compare with can be an integer or another
variable.</p>
<hr class="docutils" />
<p>For example, if you want to count how many times a username is seen in
a particular stream and alert if it is over 5.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Counting Usernames&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;jonkman&quot;</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span> <span class="n">usernamecount</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="n">noalert</span><span class="p">;)</span>
</pre></div>
</div>
<p>This will count each occurrence and increment the var usernamecount
and not generate an alert for each.</p>
<p>Now say we want to generate an alert if there are more than five hits
in the stream.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;More than Five Usernames!&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;jonkman&quot;</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span> <span class="n">usernamecount</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">usernamecount</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">5</span><span class="p">;)</span>
</pre></div>
</div>
<p>So we'll get an alert ONLY if usernamecount is over five.</p>
<p>So now let's say we want to get an alert as above but NOT if there
have been more occurrences of that username logging out. Assuming this
particular protocol indicates a log out with &quot;jonkman logout&quot;, let's
try:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Username Logged out&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;logout jonkman&quot;</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span> <span class="n">usernamecount</span><span class="p">,</span> <span class="o">-</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">usernamecount</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">5</span><span class="p">;)</span>
</pre></div>
</div>
<p>So now we'll get an alert ONLY if there are more than five active
logins for this particular username.</p>
<p>This is a rather simplistic example, but I believe it shows the power
of what such a simple function can do for rule writing. I see a lot of
applications in things like login tracking, IRC state machines,
malware tracking, and brute force login detection.</p>
<p>Let's say we're tracking a protocol that normally allows five login
fails per connection, but we have vulnerability where an attacker can
continue to login after that five attempts and we need to know about
it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Start a login count&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;login failed&quot;</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span><span class="n">loginfail</span><span class="p">,</span> <span class="n">notset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">loginfail</span><span class="p">,</span> <span class="o">=</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="n">noalert</span><span class="p">;)</span>
</pre></div>
</div>
<p>So we detect the initial fail if the variable is not yet set and set
it to 1 if so. Our first hit.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Counting Logins&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;login failed&quot;</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span><span class="n">loginfail</span><span class="p">,</span> <span class="n">isset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">loginfail</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="n">noalert</span><span class="p">;)</span>
</pre></div>
</div>
<p>We are now incrementing the counter if it's set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;More than Five login fails in a Stream&quot;</span><span class="p">;</span> \
      <span class="n">content</span><span class="p">:</span><span class="s2">&quot;login failed&quot;</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">loginfail</span><span class="p">,</span> <span class="n">isset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">loginfail</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">5</span><span class="p">;)</span>
</pre></div>
</div>
<p>Now we'll generate an alert if we cross five login fails in the same
stream.</p>
<p>But let's also say we also need alert if there are two successful
logins and a failed login after that.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Counting Good Logins&quot;</span><span class="p">;</span>             \
      <span class="n">content</span><span class="p">:</span><span class="s2">&quot;login successful&quot;</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">loginsuccess</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="n">noalert</span><span class="p">;)</span>
</pre></div>
</div>
<p>Here we're counting good logins, so now we'll count good logins
relevant to fails:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Login fail after two successes&quot;</span><span class="p">;</span>   \
      <span class="n">content</span><span class="p">:</span><span class="s2">&quot;login failed&quot;</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">loginsuccess</span><span class="p">,</span> <span class="n">isset</span><span class="p">;</span>            \
      <span class="n">flowint</span><span class="p">:</span><span class="n">loginsuccess</span><span class="p">,</span> <span class="o">=</span><span class="p">,</span> <span class="mi">2</span><span class="p">;)</span>
</pre></div>
</div>
<p>Here are some other general examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Setting a flowint counter&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;GET&quot;</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span><span class="n">myvar</span><span class="p">,</span> <span class="n">notset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">maxvar</span><span class="p">,</span><span class="n">notset</span><span class="p">;</span>                           \
      <span class="n">flowint</span><span class="p">:</span><span class="n">myvar</span><span class="p">,</span><span class="o">=</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span> <span class="n">maxvar</span><span class="p">,</span><span class="o">=</span><span class="p">,</span><span class="mi">6</span><span class="p">;)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Adding to flowint counter&quot;</span><span class="p">;</span>                \
      <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">myvar</span><span class="p">,</span><span class="n">isset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span> <span class="n">myvar</span><span class="p">,</span><span class="o">+</span><span class="p">,</span><span class="mi">2</span><span class="p">;)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;when flowint counter is 3 create new counter&quot;</span><span class="p">;</span> \
      <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">myvar</span><span class="p">,</span> <span class="n">isset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">myvar</span><span class="p">,</span><span class="o">==</span><span class="p">,</span><span class="mi">3</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span><span class="n">cntpackets</span><span class="p">,</span><span class="n">notset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">cntpackets</span><span class="p">,</span> <span class="o">=</span><span class="p">,</span> <span class="mi">0</span><span class="p">;)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;count the rest without generating alerts&quot;</span><span class="p">;</span> \
      <span class="n">flowint</span><span class="p">:</span><span class="n">cntpackets</span><span class="p">,</span><span class="n">isset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span><span class="n">cntpackets</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="n">noalert</span><span class="p">;)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;fire this when it reach 6&quot;</span><span class="p">;</span>                \
      <span class="n">flowint</span><span class="p">:</span> <span class="n">cntpackets</span><span class="p">,</span> <span class="n">isset</span><span class="p">;</span>                                             \
      <span class="n">flowint</span><span class="p">:</span> <span class="n">maxvar</span><span class="p">,</span><span class="n">isset</span><span class="p">;</span> <span class="n">flowint</span><span class="p">:</span> <span class="n">cntpackets</span><span class="p">,</span> <span class="o">==</span><span class="p">,</span> <span class="n">maxvar</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="stream-size">
<h4>stream_size<a class="headerlink" href="#stream-size" title="Permalink to this headline">¶</a></h4>
<p>The stream size option matches on traffic according to the registered
amount of bytes by the sequence numbers.  There are several modifiers
to this keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span>      <span class="n">greater</span> <span class="n">than</span>
<span class="o">&lt;</span>      <span class="n">less</span> <span class="n">than</span>
<span class="o">=</span>      <span class="n">equal</span>
<span class="o">!=</span>     <span class="ow">not</span> <span class="n">equal</span>
<span class="o">&gt;=</span>    <span class="n">greater</span> <span class="n">than</span> <span class="ow">or</span> <span class="n">equal</span>
<span class="o">&lt;=</span>    <span class="n">less</span> <span class="n">than</span> <span class="ow">or</span> <span class="n">equal</span>
</pre></div>
</div>
<p>Format</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream_size</span><span class="p">:</span><span class="o">&lt;</span><span class="n">server</span><span class="o">|</span><span class="n">client</span><span class="o">|</span><span class="n">both</span><span class="o">|</span><span class="n">either</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">modifier</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Example of the stream-size keyword in a rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">stream_size</span><span class="p">:</span><span class="n">both</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="flow-age">
<h4>flow.age<a class="headerlink" href="#flow-age" title="Permalink to this headline">¶</a></h4>
<p>Flow age in seconds (integer)</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="o">.</span><span class="n">age</span><span class="p">:</span> <span class="p">[</span><span class="n">op</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The time can be matched exactly, or compared using the _op_ setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="o">.</span><span class="n">age</span><span class="p">:</span><span class="mi">3</span>    <span class="c1"># exactly 3</span>
<span class="n">flow</span><span class="o">.</span><span class="n">age</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span>   <span class="c1"># smaller than 3 seconds</span>
<span class="n">flow</span><span class="o">.</span><span class="n">age</span><span class="p">:</span><span class="o">&gt;=</span><span class="mi">2</span>  <span class="c1"># greater or equal than 2 seconds</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Flow longer than one hour&quot;</span><span class="p">;</span> <span class="n">flow</span><span class="o">.</span><span class="n">age</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">3600</span><span class="p">;</span> <span class="n">flowbits</span><span class="p">:</span> <span class="n">isnotset</span><span class="p">,</span> <span class="n">onehourflow</span><span class="p">;</span> <span class="n">flowbits</span><span class="p">:</span> <span class="n">onehourflow</span><span class="p">,</span> <span class="n">name</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>In this example, we combine <cite>flow.age</cite> and <cite>flowbits</cite> to get an alert on the first packet after the flow's age is older than one hour.</p>
</div>
</div>
<span id="document-rules/bypass-keyword"></span><div class="section" id="bypass-keyword">
<h3>Bypass Keyword<a class="headerlink" href="#bypass-keyword" title="Permalink to this headline">¶</a></h3>
<p>Suricata has a <code class="docutils literal notranslate"><span class="pre">bypass</span></code> keyword that can be used in signatures to exclude traffic from further evaluation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">bypass</span></code> keyword is useful in cases where there is a large flow expected (e.g. Netflix, Spotify, YouTube).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">bypass</span></code> keyword is considered a post-match keyword.</p>
<div class="section" id="bypass">
<h4>bypass<a class="headerlink" href="#bypass" title="Permalink to this headline">¶</a></h4>
<p>Bypass a flow on matching http traffic.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;suricata.io&quot;</span><span class="p">;</span> \
    <span class="n">http_host</span><span class="p">;</span> <span class="n">bypass</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">10001</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-rules/http-keywords"></span><div class="section" id="http-keywords">
<h3>HTTP Keywords<a class="headerlink" href="#http-keywords" title="Permalink to this headline">¶</a></h3>
<p>Using the HTTP specific sticky buffers provides a way to efficiently
inspect specific fields of the HTTP protocol. After specifying a
sticky buffer in a rule it should be followed by one or more <a class="reference internal" href="index.html#document-rules/payload-keywords"><span class="doc">Payload Keywords</span></a>.</p>
<p>Many of the sticky buffers have legacy variants in the older &quot;content modifier&quot;
notation. See <a class="reference internal" href="index.html#rules-modifiers"><span class="std std-ref">Modifier Keywords</span></a> for more information. As a
refresher:</p>
<ul>
<li><p class="first"><strong>'sticky buffers'</strong> are placed first and all keywords following it apply to that buffer, for instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">response_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;403 Forbidden&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Sticky buffers apply to all &quot;payload&quot; keywords following it. E.g. <cite>content</cite>, <cite>isdataat</cite>, <cite>byte_test</cite>, <cite>pcre</cite>.</p>
</li>
<li><p class="first"><strong>'content modifiers'</strong> look back in the rule, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;index.php&quot;</span><span class="p">;</span> <span class="n">http_uri</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Content modifiers only apply to the preceding <cite>content</cite> keyword.</p>
</li>
</ul>
<p>The following <strong>request</strong> keywords are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="33%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Keyword</th>
<th class="head">Legacy Content Modifier</th>
<th class="head">Direction</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>http.uri</td>
<td>http_uri</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>http.uri.raw</td>
<td>http_raw_uri</td>
<td>Request</td>
</tr>
<tr class="row-even"><td>http.method</td>
<td>http_method</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>http.request_line</td>
<td>http_request_line (*)</td>
<td>Request</td>
</tr>
<tr class="row-even"><td>http.request_body</td>
<td>http_client_body</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>http.header</td>
<td>http_header</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.header.raw</td>
<td>http_raw_header</td>
<td>Both</td>
</tr>
<tr class="row-odd"><td>http.cookie</td>
<td>http_cookie</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.user_agent</td>
<td>http_user_agent</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>http.host</td>
<td>http_host</td>
<td>Request</td>
</tr>
<tr class="row-even"><td>http.host.raw</td>
<td>http_raw_host</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>http.accept</td>
<td>http_accept (*)</td>
<td>Request</td>
</tr>
<tr class="row-even"><td>http.accept_lang</td>
<td>http_accept_lang (*)</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>http.accept_enc</td>
<td>http_accept_enc (*)</td>
<td>Request</td>
</tr>
<tr class="row-even"><td>http.referer</td>
<td>http_referer (*)</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>http.connection</td>
<td>http_connection (*)</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>file.data</td>
<td>file_data (*)</td>
<td>Both</td>
</tr>
<tr class="row-odd"><td>http.content_type</td>
<td>http_content_type (*)</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.content_len</td>
<td>http_content_len (*)</td>
<td>Both</td>
</tr>
<tr class="row-odd"><td>http.start</td>
<td>http_start (*)</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.protocol</td>
<td>http_protocol (*)</td>
<td>Both</td>
</tr>
<tr class="row-odd"><td>http.header_names</td>
<td>http_header_names (*)</td>
<td>Both</td>
</tr>
</tbody>
</table>
<p>*) sticky buffer</p>
<p>The following <strong>response</strong> keywords are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="33%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Keyword</th>
<th class="head">Legacy Content Modifier</th>
<th class="head">Direction</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>http.stat_msg</td>
<td>http_stat_msg</td>
<td>Response</td>
</tr>
<tr class="row-odd"><td>http.stat_code</td>
<td>http_stat_code</td>
<td>Response</td>
</tr>
<tr class="row-even"><td>http.response_line</td>
<td>http_response_line (*)</td>
<td>Response</td>
</tr>
<tr class="row-odd"><td>http.header</td>
<td>http_header</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.header.raw</td>
<td>http_raw_header</td>
<td>Both</td>
</tr>
<tr class="row-odd"><td>http.cookie</td>
<td>http_cookie</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.response_body</td>
<td>http_server_body</td>
<td>Response</td>
</tr>
<tr class="row-odd"><td>http.server</td>
<td>N/A</td>
<td>Response</td>
</tr>
<tr class="row-even"><td>http.location</td>
<td>N/A</td>
<td>Response</td>
</tr>
<tr class="row-odd"><td>file.data</td>
<td>file_data (*)</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.content_type</td>
<td>http_content_type (*)</td>
<td>Both</td>
</tr>
<tr class="row-odd"><td>http.content_len</td>
<td>http_content_len (*)</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.start</td>
<td>http_start (*)</td>
<td>Both</td>
</tr>
<tr class="row-odd"><td>http.protocol</td>
<td>http_protocol (*)</td>
<td>Both</td>
</tr>
<tr class="row-even"><td>http.header_names</td>
<td>http_header_names (*)</td>
<td>Both</td>
</tr>
</tbody>
</table>
<p>*) sticky buffer</p>
<div class="section" id="http-primer">
<h4>HTTP Primer<a class="headerlink" href="#http-primer" title="Permalink to this headline">¶</a></h4>
<p>It is important to understand the structure of HTTP requests and
responses. A simple example of a HTTP request and response follows:</p>
<p><strong>HTTP request</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span>\<span class="n">r</span>\<span class="n">n</span>
</pre></div>
</div>
<p>GET is the request <strong>method</strong>.  Examples of methods are: GET, POST, PUT,
HEAD, etc. The URI path is <code class="docutils literal notranslate"><span class="pre">/index.html</span></code> and the HTTP version is
<code class="docutils literal notranslate"><span class="pre">HTTP/1.0</span></code>. Several HTTP versions have been used over the years; of
the versions 0.9, 1.0 and 1.1, 1.0 and 1.1 are the most commonly used
today.</p>
<p>Example request with keywords:</p>
<table border="1" class="docutils">
<colgroup>
<col width="64%" />
<col width="36%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>HTTP</td>
<td>Keyword</td>
</tr>
<tr class="row-even"><td>GET /index.html HTTP/1.1\r\n</td>
<td>http.request_line</td>
</tr>
<tr class="row-odd"><td>Host: www.oisf.net\r\n</td>
<td>http.header</td>
</tr>
<tr class="row-even"><td>Cookie: <strong>&lt;cookie data&gt;</strong></td>
<td>http.cookie</td>
</tr>
</tbody>
</table>
<p>Example request with finer grained keywords:</p>
<table border="1" class="docutils">
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>HTTP</td>
<td>Keyword</td>
</tr>
<tr class="row-even"><td><strong>GET</strong> <em>/index.html</em> <strong>HTTP/1.1</strong>\r\n</td>
<td><strong>http.method</strong>
<em>http.uri</em>
<strong>http.protocol</strong></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p class="first">Host: <strong>www.oisf.net</strong>\r\n</p>
<p class="last">User-Agent: <strong>Mozilla/5.0</strong>\r\n</p>
</td>
<td><strong>http.host</strong></td>
</tr>
<tr class="row-even"><td><strong>http.user_agent</strong></td>
</tr>
<tr class="row-odd"><td>Cookie: <strong>&lt;cookie data&gt;</strong></td>
<td><strong>http.cookie</strong></td>
</tr>
</tbody>
</table>
<p><strong>HTTP response</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>\<span class="n">r</span>\<span class="n">n</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span> <span class="n">some</span> <span class="n">page</span> <span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">HTML</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>In this example, HTTP/1.0 is the HTTP version, 200 the response status
code and OK the response status message.</p>
<p>Although cookies are sent in an HTTP header, you can not match on them
with the <code class="docutils literal notranslate"><span class="pre">http.header</span></code> keyword. Cookies are matched with their own
keyword, namely <code class="docutils literal notranslate"><span class="pre">http.cookie</span></code>.</p>
<p>Each part of the table belongs to a so-called <em>buffer</em>. The HTTP
method belongs to the method buffer, HTTP headers to the header buffer
etc. A buffer is a specific portion of the request or response that
Suricata extracts in memory for inspection.</p>
<p>All previous described keywords can be used in combination with a
buffer in a signature. The keywords <code class="docutils literal notranslate"><span class="pre">distance</span></code> and <code class="docutils literal notranslate"><span class="pre">within</span></code> are
relative modifiers, so they may only be used within the same
buffer. You can not relate content matches against different buffers
with relative modifiers.</p>
</div>
<div class="section" id="http-method">
<h4>http.method<a class="headerlink" href="#http-method" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.method</span></code> sticky buffer, it is possible to match
specifically and only on the HTTP method buffer. The keyword can be
used in combination with all previously mentioned content modifiers
such as: <code class="docutils literal notranslate"><span class="pre">depth</span></code>, <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code> and <code class="docutils literal notranslate"><span class="pre">within</span></code>.</p>
<p>Examples of methods are: <strong>GET</strong>, <strong>POST</strong>, <strong>PUT</strong>, <strong>HEAD</strong>,
<strong>DELETE</strong>, <strong>TRACE</strong>, <strong>OPTIONS</strong>, <strong>CONNECT</strong> and <strong>PATCH</strong>.</p>
<p>Example of a method in a HTTP request:</p>
<img alt="_images/method2.png" src="_images/method2.png" />
<p>Example of the purpose of method:</p>
<img alt="_images/method.png" src="_images/method.png" />
<img alt="_images/Legenda_rules.png" src="_images/Legenda_rules.png" />
<img alt="_images/method1.png" src="_images/method1.png" />
</div>
<div class="section" id="http-uri-and-http-uri-raw">
<span id="rules-http-uri-normalization"></span><h4>http.uri and http.uri.raw<a class="headerlink" href="#http-uri-and-http-uri-raw" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.uri</span></code> and the <code class="docutils literal notranslate"><span class="pre">http.uri.raw</span></code> sticky buffers, it
is possible to match specifically and only on the request URI
buffer. The keyword can be used in combination with all previously
mentioned content modifiers like <code class="docutils literal notranslate"><span class="pre">depth</span></code>, <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>,
<code class="docutils literal notranslate"><span class="pre">nocase</span></code> and <code class="docutils literal notranslate"><span class="pre">within</span></code>.</p>
<p>The uri has two appearances in Suricata: the uri.raw and the
normalized uri. The space for example can be indicated with the
heximal notation %20. To convert this notation in a space, means
normalizing it. It is possible though to match specific on the
characters %20 in a uri. This means matching on the uri.raw. The
uri.raw and the normalized uri are separate buffers. So, the uri.raw
inspects the uri.raw buffer and can not inspect the normalized buffer.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">uri.raw never has any spaces in it.
With this request line <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/uid=0(root)</span> <span class="pre">gid=0(root)</span> <span class="pre">HTTP/1.1</span></code>,
the <code class="docutils literal notranslate"><span class="pre">http.uri.raw</span></code> will match <code class="docutils literal notranslate"><span class="pre">/uid=0(root)</span></code>
and <code class="docutils literal notranslate"><span class="pre">http.protocol</span></code> will match <code class="docutils literal notranslate"><span class="pre">gid=0(root)</span> <span class="pre">HTTP/1.1</span></code>
Reference: <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/2881">https://redmine.openinfosecfoundation.org/issues/2881</a></p>
</div>
<p>Example of the URI in a HTTP request:</p>
<img alt="_images/uri1.png" src="_images/uri1.png" />
<p>Example of the purpose of <code class="docutils literal notranslate"><span class="pre">http.uri</span></code>:</p>
<img alt="_images/uri.png" src="_images/uri.png" />
</div>
<div class="section" id="uricontent">
<h4>uricontent<a class="headerlink" href="#uricontent" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">uricontent</span></code> keyword has the exact same effect as the
<code class="docutils literal notranslate"><span class="pre">http.uri</span></code> sticky buffer. <code class="docutils literal notranslate"><span class="pre">uricontent</span></code> is a deprecated
(although still supported) way to match specifically and only on the
request URI buffer.</p>
<p>Example of <code class="docutils literal notranslate"><span class="pre">uricontent</span></code>:</p>
<div class="example-rule docutils container">
alert tcp $HOME_NET any -&gt; $EXTERNAL_NET $HTTP_PORTS (msg:&quot;ET TROJAN Possible Vundo Trojan Variant reporting to Controller&quot;; flow:established,to_server; content:&quot;POST &quot;; depth:5; <span class="example-rule-emphasis">uricontent:&quot;/frame.html?&quot;;</span> urilen: &gt; 80; classtype:trojan-activity; reference:url,doc.emergingthreats.net/2009173; reference:url,www.emergingthreats.net/cgi-bin/cvsweb.cgi/sigs/VIRUS/TROJAN_Vundo; sid:2009173; rev:2;)</div>
<p>The difference between <code class="docutils literal notranslate"><span class="pre">http.uri</span></code> and <code class="docutils literal notranslate"><span class="pre">uricontent</span></code> is the syntax:</p>
<img alt="_images/uricontent1.png" src="_images/uricontent1.png" />
<img alt="_images/http_uri.png" src="_images/http_uri.png" />
<p>When authoring new rules, it is recommended that the <code class="docutils literal notranslate"><span class="pre">http.uri</span></code>
content sticky buffer be used rather than the deprecated <code class="docutils literal notranslate"><span class="pre">uricontent</span></code>
keyword.</p>
</div>
<div class="section" id="urilen">
<h4>urilen<a class="headerlink" href="#urilen" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">urilen</span></code> keyword is used to match on the length of the request
URI. It is possible to use the <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> operators, which
indicate respectively <em>smaller than</em> and <em>larger than</em>.</p>
<p>The format of <code class="docutils literal notranslate"><span class="pre">urilen</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urilen</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span>
</pre></div>
</div>
<p>Other possibilities are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urilen</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<span class="n">urilen</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">;</span>
<span class="n">urilen</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span>
<span class="n">urilen</span><span class="p">:</span><span class="mi">10</span><span class="o">&lt;&gt;</span><span class="mi">20</span><span class="p">;</span>        <span class="p">(</span><span class="n">bigger</span> <span class="n">than</span> <span class="mi">10</span><span class="p">,</span> <span class="n">smaller</span> <span class="n">than</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>Example:</p>
<img alt="_images/urilen.png" src="_images/urilen.png" />
<p>Example of <code class="docutils literal notranslate"><span class="pre">urilen</span></code> in a signature:</p>
<div class="example-rule docutils container">
alert tcp $HOME_NET any -&gt; $EXTERNAL_NET $HTTP_PORTS (msg:&quot;ET TROJAN Possible Vundo Trojan Variant reporting to Controller&quot;; flow:established,to_server; content:&quot;POST &quot;; depth:5; uricontent:&quot;/frame.html?&quot;; <span class="example-rule-emphasis">urilen: &gt; 80;</span> classtype:trojan-activity; reference:url,doc.emergingthreats.net/2009173; reference:url,www.emergingthreats.net/cgi-bin/cvsweb.cgi/sigs/VIRUS/TROJAN_Vundo; sid:2009173; rev:2;)</div>
<p>You can also append <code class="docutils literal notranslate"><span class="pre">norm</span></code> or <code class="docutils literal notranslate"><span class="pre">raw</span></code> to define what sort of buffer you want
to use (normalized or raw buffer).</p>
</div>
<div class="section" id="http-protocol">
<h4>http.protocol<a class="headerlink" href="#http-protocol" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">http.protocol</span></code> inspects the protocol field from the HTTP request or
response line. If the request line is 'GET / HTTP/1.0rn', then this buffer
will contain 'HTTP/1.0'.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">;</span> <span class="n">http</span><span class="o">.</span><span class="n">protocol</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;HTTP/1.0&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">http.protocol</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">`http_protocol</span></code>. You may continue to use the previous name, but it's recommended that rules be converted to use the new name.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">;</span> <span class="n">http</span><span class="o">.</span><span class="n">protocol</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;HTTP/1.0&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-request-line">
<h4>http.request_line<a class="headerlink" href="#http-request-line" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">http.request_line</span></code> forces the whole HTTP request line to be inspected.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">request_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;GET / HTTP/1.0&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-header-and-http-header-raw">
<h4>http.header and http.header.raw<a class="headerlink" href="#http-header-and-http-header-raw" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.header</span></code> sticky buffer, it is possible to match
specifically and only on the HTTP header buffer. This contains all of
the extracted headers in a single buffer, except for those indicated
in the documentation that are not able to match by this buffer and
have their own sticky buffer (e.g. <code class="docutils literal notranslate"><span class="pre">http.cookie</span></code>). The sticky buffer
can be used in combination with all previously mentioned content
modifiers, like <code class="docutils literal notranslate"><span class="pre">depth</span></code>, <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code> and
<code class="docutils literal notranslate"><span class="pre">within</span></code>.</p>
<blockquote>
<div><strong>Note</strong>: the header buffer is <em>normalized</em>. Any trailing
whitespace and tab characters are removed. See:
<a class="reference external" href="https://lists.openinfosecfoundation.org/pipermail/oisf-users/2011-October/000935.html">https://lists.openinfosecfoundation.org/pipermail/oisf-users/2011-October/000935.html</a>.
If there are multiple values for the same header name, they are
concatenated with a comma and space (&quot;, &quot;) between each of them.
See RFC 2616 4.2 Message Headers.
To avoid that, use the <code class="docutils literal notranslate"><span class="pre">http.header.raw</span></code> keyword.</div></blockquote>
<p>Example of a header in a HTTP request:</p>
<img alt="_images/header.png" src="_images/header.png" />
<p>Example of the purpose of <code class="docutils literal notranslate"><span class="pre">http.header</span></code>:</p>
<img alt="_images/header1.png" src="_images/header1.png" />
</div>
<div class="section" id="http-cookie">
<h4>http.cookie<a class="headerlink" href="#http-cookie" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.cookie</span></code> sticky buffer it is possible to match
specifically on the HTTP cookie contents. Keywords like <code class="docutils literal notranslate"><span class="pre">depth</span></code>,
<code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code> and <code class="docutils literal notranslate"><span class="pre">within</span></code> can be used
with <code class="docutils literal notranslate"><span class="pre">http.cookie</span></code>.</p>
<p>Note that cookies are passed in HTTP headers but Suricata extracts
the cookie data to <code class="docutils literal notranslate"><span class="pre">http.cookie</span></code> and will not match cookie content
put in the <code class="docutils literal notranslate"><span class="pre">http.header</span></code> sticky buffer.</p>
<p>Example of a cookie in a HTTP request:</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">Cookie</span><span class="p">:</span> <span class="n">PHPSESSIONID</span><span class="o">=</span><span class="mi">1234</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
</pre></div>
</div>
<p>Example <code class="docutils literal notranslate"><span class="pre">http.cookie</span></code> keyword in a signature:</p>
<div class="example-rule docutils container">
alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;HTTP Request
with Cookie&quot;; flow:established,to_server; http.method; content:&quot;GET&quot;;
http.uri; content:&quot;/&quot;; fast_pattern; <span class="example-rule-emphasis">http.cookie;
content:&quot;PHPSESSIONID=&quot;; startswith;</span> classtype:bad-unknown; sid:123;
rev:1;)</div>
</div>
<div class="section" id="http-user-agent">
<h4>http.user_agent<a class="headerlink" href="#http-user-agent" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code> sticky buffer is part of the HTTP request
header. It makes it possible to match specifically on the value of the
User-Agent header. It is normalized in the sense that it does not
include the _&quot;User-Agent: &quot;_ header name and separator, nor does it
contain the trailing carriage return and line feed (CRLF). The keyword
can be used in combination with all previously mentioned content
modifiers like <code class="docutils literal notranslate"><span class="pre">depth</span></code>, <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code> and
<code class="docutils literal notranslate"><span class="pre">within</span></code>. Note that the <code class="docutils literal notranslate"><span class="pre">pcre</span></code> keyword can also inspect this
buffer when using the <code class="docutils literal notranslate"><span class="pre">/V</span></code> modifier.</p>
<p>Normalization: leading spaces <strong>are not</strong> part of this buffer. So
&quot;User-Agent: rn&quot; will result in an empty <code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code> buffer.</p>
<p>Example of the User-Agent header in a HTTP request:</p>
<img alt="_images/user_agent.png" src="_images/user_agent.png" />
<p>Example of the purpose of <code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code>:</p>
<img alt="_images/user_agent_match.png" src="_images/user_agent_match.png" />
<div class="section" id="notes">
<h5>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code> buffer will NOT include the header name,
colon, or leading whitespace.  i.e. it will not include
&quot;User-Agent: &quot;.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code> buffer does not include a CRLF (0x0D
0x0A) at the end.  If you want to match the end of the buffer, use a
relative <code class="docutils literal notranslate"><span class="pre">isdataat</span></code> or a PCRE (although PCRE will be worse on
performance).</p>
</li>
<li><p class="first">If a request contains multiple &quot;User-Agent&quot; headers, the values will
be concatenated in the <code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code> buffer, in the order
seen from top to bottom, with a comma and space (&quot;, &quot;) between each
of them.</p>
<p>Example request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">SuriTester</span><span class="o">/</span><span class="mf">0.8</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">GGGG</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code> buffer contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SuriTester</span><span class="o">/</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">GGGG</span>
</pre></div>
</div>
</li>
<li><p class="first">Corresponding PCRE modifier: <code class="docutils literal notranslate"><span class="pre">V</span></code></p>
</li>
<li><p class="first">Using the <code class="docutils literal notranslate"><span class="pre">http.user_agent</span></code> buffer is more efficient when it
comes to performance than using the <code class="docutils literal notranslate"><span class="pre">http.header</span></code> buffer (~10%
better).</p>
</li>
<li><p class="first"><a class="reference external" href="https://blog.inliniac.net/2012/07/09/suricata-http_user_agent-vs-http_header/">https://blog.inliniac.net/2012/07/09/suricata-http_user_agent-vs-http_header/</a></p>
</li>
</ul>
</div>
</div>
<div class="section" id="http-accept">
<h4>http.accept<a class="headerlink" href="#http-accept" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Accept header. Only contains the header
value. The \r\n after the header are not part of the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">accept</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;image/gif&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-accept-enc">
<h4>http.accept_enc<a class="headerlink" href="#http-accept-enc" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Accept-Encoding header. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">accept_enc</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;gzip&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-accept-lang">
<h4>http.accept_lang<a class="headerlink" href="#http-accept-lang" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Accept-Language header. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">accept_lang</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;en-us&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-connection">
<h4>http.connection<a class="headerlink" href="#http-connection" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Connection header. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">connection</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;keep-alive&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-content-type">
<h4>http.content_type<a class="headerlink" href="#http-content-type" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Content-Type headers. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Use flow:to_server or flow:to_client to force inspection of request or response.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">;</span> \
        <span class="n">http</span><span class="o">.</span><span class="n">content_type</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;x-www-form-urlencoded&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_client</span><span class="p">;</span> \
        <span class="n">http</span><span class="o">.</span><span class="n">content_type</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-content-len">
<h4>http.content_len<a class="headerlink" href="#http-content-len" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Content-Length headers. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Use flow:to_server or flow:to_client to force inspection of request or response.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">;</span> \
        <span class="n">http</span><span class="o">.</span><span class="n">content_len</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;666&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>

<span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_client</span><span class="p">;</span> \
        <span class="n">http</span><span class="o">.</span><span class="n">content_len</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;555&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
</pre></div>
</div>
<p>To do a numeric inspection of the content length, <code class="docutils literal notranslate"><span class="pre">byte_test</span></code> can be used.</p>
<p>Example, match if C-L is equal to or bigger than 8079:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_client</span><span class="p">;</span> \
        <span class="n">http</span><span class="o">.</span><span class="n">content_len</span><span class="p">;</span> <span class="n">byte_test</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="o">&gt;=</span><span class="p">,</span><span class="mi">8079</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">string</span><span class="p">,</span><span class="n">dec</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-referer">
<h4>http.referer<a class="headerlink" href="#http-referer" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Referer header. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">referer</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;.php&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-start">
<h4>http.start<a class="headerlink" href="#http-start" title="Permalink to this headline">¶</a></h4>
<p>Inspect the start of a HTTP request or response. This will contain the
request/response line plus the request/response headers. Use flow:to_server
or flow:to_client to force inspection of request or response.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">start</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;HTTP/1.1|0d 0a|User-Agent&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>The buffer contains the normalized headers and is terminated by an extra
\r\n to indicate the end of the headers.</p>
</div>
<div class="section" id="http-header-names">
<h4>http.header_names<a class="headerlink" href="#http-header-names" title="Permalink to this headline">¶</a></h4>
<p>Inspect a buffer only containing the names of the HTTP headers. Useful
for making sure a header is not present or testing for a certain order
of headers.</p>
<p>Buffer starts with a \r\n and ends with an extra \r\n.</p>
<p>Example buffer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\\<span class="n">r</span>\\<span class="n">nHost</span>\\<span class="n">r</span>\\<span class="n">n</span>\\<span class="n">r</span>\\<span class="n">n</span>
</pre></div>
</div>
<p>Example rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">header_names</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|0d 0a|Host|0d 0a|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Example to make sure <em>only</em> Host is present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">header_names</span><span class="p">;</span> \
        <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|0d 0a|Host|0d 0a 0d 0a|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Example to make sure <em>User-Agent</em> is directly after <em>Host</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">header_names</span><span class="p">;</span> \
        <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|0d 0a|Host|0d 0a|User-Agent|0d 0a|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Example to make sure <em>User-Agent</em> is after <em>Host</em>, but not necessarily directly after:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">header_names</span><span class="p">;</span> \
        <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|0d 0a|Host|0d 0a|&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|0a 0d|User-Agent|0d 0a|&quot;</span><span class="p">;</span> \
        <span class="n">distance</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-request-body">
<h4>http.request_body<a class="headerlink" href="#http-request-body" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.request_body</span></code> sticky buffer, it is possible to
match specifically and only on the HTTP request body. The keyword can
be used in combination with all previously mentioned content modifiers
like <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code>, <code class="docutils literal notranslate"><span class="pre">within</span></code>, etc.</p>
<p>Example of <code class="docutils literal notranslate"><span class="pre">http.request_body</span></code> in a HTTP request:</p>
<img alt="_images/client_body.png" src="_images/client_body.png" />
<p>Example of the purpose of <code class="docutils literal notranslate"><span class="pre">http.client_body</span></code>:</p>
<img alt="_images/client_body1.png" src="_images/client_body1.png" />
<p>Note: how much of the request/client body is inspected is controlled
in the <a class="reference internal" href="index.html#suricata-yaml-configure-libhtp"><span class="std std-ref">libhtp configuration section</span></a> via the <code class="docutils literal notranslate"><span class="pre">request-body-limit</span></code>
setting.</p>
<p><code class="docutils literal notranslate"><span class="pre">http.request_body</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">`http_client_body</span></code>. You may continue
+to use the previous name, but it's recommended that rules be converted to use
+the new name.</p>
</div>
<div class="section" id="http-stat-code">
<h4>http.stat_code<a class="headerlink" href="#http-stat-code" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.stat_code</span></code> sticky buffer, it is possible to match
specifically and only on the HTTP status code buffer. The keyword can
be used in combination with all previously mentioned content modifiers
like <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code>, <code class="docutils literal notranslate"><span class="pre">within</span></code>, etc.</p>
<p>Example of <code class="docutils literal notranslate"><span class="pre">http.stat_code</span></code> in a HTTP response:</p>
<img alt="_images/stat_code.png" src="_images/stat_code.png" />
<p>Example of the purpose of <code class="docutils literal notranslate"><span class="pre">http.stat_code</span></code>:</p>
<img alt="_images/stat-code1.png" src="_images/stat-code1.png" />
</div>
<div class="section" id="http-stat-msg">
<h4>http.stat_msg<a class="headerlink" href="#http-stat-msg" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.stat_msg</span></code> sticky buffer, it is possible to match
specifically and only on the HTTP status message buffer. The keyword
can be used in combination with all previously mentioned content
modifiers like <code class="docutils literal notranslate"><span class="pre">depth</span></code>, <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code> and
<code class="docutils literal notranslate"><span class="pre">within</span></code>.</p>
<p>Example of <code class="docutils literal notranslate"><span class="pre">http.stat_msg</span></code> in a HTTP response:</p>
<img alt="_images/stat_msg.png" src="_images/stat_msg.png" />
<p>Example of the purpose of <code class="docutils literal notranslate"><span class="pre">http.stat_msg</span></code>:</p>
<img alt="_images/stat_msg_1.png" src="_images/stat_msg_1.png" />
</div>
<div class="section" id="http-response-line">
<h4>http.response_line<a class="headerlink" href="#http-response-line" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">http.response_line</span></code> forces the whole HTTP response line to be inspected.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">response_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;HTTP/1.0 200 OK&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-response-body">
<h4>http.response_body<a class="headerlink" href="#http-response-body" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.response_body</span></code> sticky buffer, it is possible to
match specifically and only on the HTTP response body. The keyword can
be used in combination with all previously mentioned content modifiers
like <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code>, <code class="docutils literal notranslate"><span class="pre">within</span></code>, etc.</p>
<p>Note: how much of the response/server body is inspected is controlled
in your <a class="reference internal" href="index.html#suricata-yaml-configure-libhtp"><span class="std std-ref">libhtp configuration section</span></a> via the <code class="docutils literal notranslate"><span class="pre">response-body-limit</span></code>
setting.</p>
<div class="section" id="id1">
<h5>Notes<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Using <code class="docutils literal notranslate"><span class="pre">http.response_body</span></code> is similar to having content matches
that come after <code class="docutils literal notranslate"><span class="pre">file.data</span></code> except that it doesn't permanently
(unless reset) set the detection pointer to the beginning of the
server response body. i.e. it is not a sticky buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">http.response_body</span></code> will match on gzip decoded data just like
<code class="docutils literal notranslate"><span class="pre">file.data</span></code> does.</li>
<li>Since <code class="docutils literal notranslate"><span class="pre">http.response_body</span></code> matches on a server response, it
can't be used with the <code class="docutils literal notranslate"><span class="pre">to_server</span></code> or <code class="docutils literal notranslate"><span class="pre">from_client</span></code> flow
directives.</li>
<li>Corresponding PCRE modifier: <code class="docutils literal notranslate"><span class="pre">Q</span></code></li>
<li>further notes at the <code class="docutils literal notranslate"><span class="pre">file.data</span></code> section below.</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">http.response_body</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">`http_server_body</span></code>. You may continue
+to use the previous name, but it's recommended that rules be converted to use
+the new name.</p>
</div>
</div>
<div class="section" id="http-server">
<h4>http.server<a class="headerlink" href="#http-server" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Server headers. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_client</span><span class="p">;</span> \
        <span class="n">http</span><span class="o">.</span><span class="n">server</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Microsoft-IIS/6.0&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-location">
<h4>http.location<a class="headerlink" href="#http-location" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer to match on the HTTP Location headers. Only contains the
header value. The \r\n after the header are not part of the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">flow</span><span class="p">:</span><span class="n">to_client</span><span class="p">;</span> \
        <span class="n">http</span><span class="o">.</span><span class="n">location</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;http://www.google.com&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-host-and-http-host-raw">
<h4>http.host and http.host.raw<a class="headerlink" href="#http-host-and-http-host-raw" title="Permalink to this headline">¶</a></h4>
<p>With the <code class="docutils literal notranslate"><span class="pre">http.host</span></code> sticky buffer, it is possible to
match specifically and only the normalized hostname.
The <code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code> inspects the raw hostname.</p>
<p>The keyword can be used in combination with most of the content modifiers
like <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">offset</span></code>, <code class="docutils literal notranslate"><span class="pre">within</span></code>, etc.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">nocase</span></code> keyword is not allowed anymore. Keep in mind that you need
to specify a lowercase pattern.</p>
</div>
<div class="section" id="http-request-header">
<h4>http.request_header<a class="headerlink" href="#http-request-header" title="Permalink to this headline">¶</a></h4>
<p>Match on the name and value of a HTTP request header (HTTP1 or HTTP2).</p>
<p>For HTTP2, name and value get concatenated by &quot;: &quot;, colon and space.
To detect if a http2 header name contains ':',
the keyword <code class="docutils literal notranslate"><span class="pre">http2.header_name</span></code> can be used.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="o">.</span><span class="n">request_header</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;agent: nghttp2&quot;</span><span class="p">;</span>
<span class="n">http</span><span class="o">.</span><span class="n">request_header</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;custom-header: I love::colons&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">http.request_header</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">http.request_header</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="http-response-header">
<h4>http.response_header<a class="headerlink" href="#http-response-header" title="Permalink to this headline">¶</a></h4>
<p>Match on the name and value of a HTTP response header (HTTP1 or HTTP2).</p>
<p>For HTTP2, name and value get concatenated by &quot;: &quot;, colon and space.
To detect if a http2 header name contains ':',
the keyword <code class="docutils literal notranslate"><span class="pre">http2.header_name</span></code> can be used.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="o">.</span><span class="n">response_header</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;server: nghttp2&quot;</span><span class="p">;</span>
<span class="n">http</span><span class="o">.</span><span class="n">response_header</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;custom-header: I love::colons&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">http.response_header</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">http.response_header</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<div class="section" id="id2">
<h5>Notes<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">http.host</span></code> does not contain the port associated with
the host (i.e. abc.com:1234). To match on the host and port
or negate a host and port use <code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code>.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http.host</span></code> and <code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code> buffers are populated
from either the URI (if the full URI is present in the request like
in a proxy request) or the HTTP Host header. If both are present, the
URI is used.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http.host</span></code> and <code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code> buffers will NOT
include the header name, colon, or leading whitespace if populated
from the Host header.  i.e. they will not include &quot;Host: &quot;.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http.host</span></code> and <code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code> buffers do not
include a CRLF (0x0D 0x0A) at the end.  If you want to match the end
of the buffer, use a relative 'isdataat' or a PCRE (although PCRE
will be worse on performance).</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http.host</span></code> buffer is normalized to be all lower case.</p>
</li>
<li><p class="first">The content match that <code class="docutils literal notranslate"><span class="pre">http.host</span></code> applies to must be all lower
case or have the <code class="docutils literal notranslate"><span class="pre">nocase</span></code> flag set.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code> matches the unnormalized buffer so matching
will be case-sensitive (unless <code class="docutils literal notranslate"><span class="pre">nocase</span></code> is set).</p>
</li>
<li><p class="first">If a request contains multiple &quot;Host&quot; headers, the values will be
concatenated in the <code class="docutils literal notranslate"><span class="pre">http.host</span></code> and <code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code>
buffers, in the order seen from top to bottom, with a comma and space
(&quot;, &quot;) between each of them.</p>
<p>Example request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">ABC</span><span class="o">.</span><span class="n">com</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">efg</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">http.host</span></code> buffer contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">abc</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">efg</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">http.host.raw</span></code> buffer contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ABC</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">efg</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
</li>
<li><p class="first">Corresponding PCRE modifier (<code class="docutils literal notranslate"><span class="pre">http_host</span></code>): <code class="docutils literal notranslate"><span class="pre">W</span></code></p>
</li>
<li><p class="first">Corresponding PCRE modifier (<code class="docutils literal notranslate"><span class="pre">http_raw_host</span></code>): <code class="docutils literal notranslate"><span class="pre">Z</span></code></p>
</li>
</ul>
</div>
</div>
<div class="section" id="file-data">
<h4>file.data<a class="headerlink" href="#file-data" title="Permalink to this headline">¶</a></h4>
<p>With <code class="docutils literal notranslate"><span class="pre">file.data</span></code>, the HTTP response body is inspected, just like
with <code class="docutils literal notranslate"><span class="pre">http.response_body</span></code>. The <code class="docutils literal notranslate"><span class="pre">file.data</span></code> keyword is a sticky buffer.
<code class="docutils literal notranslate"><span class="pre">file.data</span></code> also works for HTTP request body and can be used in other
protocols than HTTP1.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">data</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;xyz&quot;</span><span class="p">;)</span>
</pre></div>
</div>
<img alt="_images/file_data.png" src="_images/file_data.png" />
<p>The <code class="docutils literal notranslate"><span class="pre">file.data</span></code> keyword affects all following content matches, until
the <code class="docutils literal notranslate"><span class="pre">pkt_data</span></code> keyword is encountered or it reaches the end of the
rule. This makes it a useful shortcut for applying many content
matches to the HTTP response body, eliminating the need to modify each
content match individually.</p>
<p>As the body of a HTTP response can be very large, it is inspected in
smaller chunks.</p>
<p>How much of the response/server body is inspected is controlled
in your <a class="reference internal" href="index.html#suricata-yaml-configure-libhtp"><span class="std std-ref">libhtp configuration section</span></a> via the <code class="docutils literal notranslate"><span class="pre">response-body-limit</span></code>
setting.</p>
<p>If the HTTP body is a flash file compressed with 'deflate' or 'lzma',
it can be decompressed and <code class="docutils literal notranslate"><span class="pre">file.data</span></code> can match on the decompress data.
Flash decompression must be enabled under <code class="docutils literal notranslate"><span class="pre">libhtp</span></code> configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Decompress SWF files.</span>
<span class="c1"># 2 types: &#39;deflate&#39;, &#39;lzma&#39;, &#39;both&#39; will decompress deflate and lzma</span>
<span class="c1"># compress-depth:</span>
<span class="c1"># Specifies the maximum amount of data to decompress,</span>
<span class="c1"># set 0 for unlimited.</span>
<span class="c1"># decompress-depth:</span>
<span class="c1"># Specifies the maximum amount of decompressed data to obtain,</span>
<span class="c1"># set 0 for unlimited.</span>
<span class="n">swf</span><span class="o">-</span><span class="n">decompression</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">both</span>
  <span class="n">compress</span><span class="o">-</span><span class="n">depth</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">decompress</span><span class="o">-</span><span class="n">depth</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<div class="section" id="id3">
<h5>Notes<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>file.data is the preferred notation, however, file_data is still
recognized by the engine and works as well.</li>
<li>If a HTTP body is using gzip or deflate, <code class="docutils literal notranslate"><span class="pre">file.data</span></code> will match
on the decompressed data.</li>
<li>Negated matching is affected by the chunked inspection. E.g.
'content:!&quot;&lt;html&quot;;' could not match on the first chunk, but would
then possibly match on the 2nd. To avoid this, use a depth setting.
The depth setting takes the body size into account.
Assuming that the <code class="docutils literal notranslate"><span class="pre">response-body-minimal-inspect-size</span></code> is bigger
than 1k, 'content:!&quot;&lt;html&quot;; depth:1024;' can only match if the
pattern '&lt;html' is absent from the first inspected chunk.</li>
<li><code class="docutils literal notranslate"><span class="pre">file.data</span></code> can also be used with SMTP</li>
</ul>
</div>
<div class="section" id="multiple-buffer-matching">
<h5>Multiple Buffer Matching<a class="headerlink" href="#multiple-buffer-matching" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">file.data</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
</div>
</div>
<span id="document-rules/file-keywords"></span><div class="section" id="file-keywords">
<h3>File Keywords<a class="headerlink" href="#file-keywords" title="Permalink to this headline">¶</a></h3>
<p>Suricata comes with several rule keywords to match on various file
properties. They depend on properly configured
<a class="reference internal" href="index.html#document-file-extraction/file-extraction"><span class="doc">File Extraction</span></a>.</p>
<div class="section" id="file-name">
<h4>file.name<a class="headerlink" href="#file-name" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">file.name</span></code> is a sticky buffer that is used to look at filenames
that are seen in flows that Suricata evaluates. The various payload
keywords can be used (e.g. <code class="docutils literal notranslate"><span class="pre">startswith</span></code>, <code class="docutils literal notranslate"><span class="pre">nocase</span></code> and <code class="docutils literal notranslate"><span class="pre">bsize</span></code>)
with <code class="docutils literal notranslate"><span class="pre">file.name</span></code>.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;examplefilename&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">file.name</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
<p><strong>Note</strong> <code class="docutils literal notranslate"><span class="pre">filename</span></code> can still be used. A notable difference between
<code class="docutils literal notranslate"><span class="pre">file.name</span></code> and <code class="docutils literal notranslate"><span class="pre">filename</span></code> is that <code class="docutils literal notranslate"><span class="pre">filename</span></code> assumes <code class="docutils literal notranslate"><span class="pre">nocase</span></code>
by default. In the example below the two signatures are considered
the same.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span><span class="p">:</span><span class="s2">&quot;examplefilename&quot;</span><span class="p">;</span>

<span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;examplefilename&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="fileext">
<h4>fileext<a class="headerlink" href="#fileext" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">fileext</span></code> is used to look at individual file extensions that are
seen in flows that Suricata evaluates.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fileext</span><span class="p">:</span><span class="s2">&quot;pdf&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">fileext</span></code> does not allow partial matches. For example, if
a PDF file (.pdf) is seen by a Suricata signature with
fileext:&quot;pd&quot;; the signature will not produce an alert.</p>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">fileext</span></code> assumes <code class="docutils literal notranslate"><span class="pre">nocase</span></code> by default. This means
that a file with the extension .PDF will be seen the same as if
the file had an extension of .pdf.</p>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">fileext</span></code> and <code class="docutils literal notranslate"><span class="pre">file.name</span></code> can both be used to match on
file extensions. In the example below the two signatures are
considered the same.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fileext</span><span class="p">:</span><span class="s2">&quot;pdf&quot;</span><span class="p">;</span>

<span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;.pdf&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Note</strong>: While``fileeext`` and <code class="docutils literal notranslate"><span class="pre">file.name</span></code> can both be used
to match on file extensions, <code class="docutils literal notranslate"><span class="pre">file.name</span></code> allows for partial
matching on file extensions. The following would match on a file
with the extension of .pd as well as .pdf.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;.pd&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="file-magic">
<h4>file.magic<a class="headerlink" href="#file-magic" title="Permalink to this headline">¶</a></h4>
<p>Matches on the information libmagic returns about a file.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span><span class="o">.</span><span class="n">magic</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;executable for MS Windows&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Note</strong> <code class="docutils literal notranslate"><span class="pre">filemagic</span></code> can still be used. The only difference between
<code class="docutils literal notranslate"><span class="pre">file.magic</span></code> and <code class="docutils literal notranslate"><span class="pre">file.magic</span></code> is that <code class="docutils literal notranslate"><span class="pre">filemagic</span></code> assumes <code class="docutils literal notranslate"><span class="pre">nocase</span></code>
by default. In the example below the two signatures are considered
the same.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filemagic</span><span class="p">:</span><span class="s2">&quot;executable for MS Windows&quot;</span><span class="p">;</span>

<span class="n">file</span><span class="o">.</span><span class="n">magic</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;executable for MS Windows&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span>
</pre></div>
</div>
<p>Note: Suricata currently uses its underlying operating systems
version/implementation of libmagic. Different versions and
implementations of libmagic do not return the same information.
Additionally there are varying Suricata performance impacts
based on the version and implementation of libmagic.
Additional information about Suricata and libmagic can be found
here: <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/437">https://redmine.openinfosecfoundation.org/issues/437</a></p>
<p><code class="docutils literal notranslate"><span class="pre">file.magic</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="filestore">
<h4>filestore<a class="headerlink" href="#filestore" title="Permalink to this headline">¶</a></h4>
<p>Stores files to disk if the signature matched.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filestore</span><span class="p">:</span><span class="o">&lt;</span><span class="n">direction</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">scope</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>direction can be:</p>
<ul class="simple">
<li>request/to_server: store a file in the request / to_server direction</li>
<li>response/to_client: store a file in the response / to_client direction</li>
<li>both: store both directions</li>
</ul>
<p>scope can be:</p>
<ul class="simple">
<li>file: only store the matching file (for filename,fileext,filemagic matches)</li>
<li>tx: store all files from the matching HTTP transaction</li>
<li>ssn/flow: store all files from the TCP session/flow.</li>
</ul>
<p>If direction and scope are omitted, the direction will be the same as
the rule and the scope will be per file.</p>
</div>
<div class="section" id="filemd5">
<h4>filemd5<a class="headerlink" href="#filemd5" title="Permalink to this headline">¶</a></h4>
<p>Match file <a class="reference internal" href="index.html#md5"><span class="std std-ref">MD5</span></a> against list of MD5 checksums.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filemd5:[!]filename;
</pre></div>
</div>
<p>The filename is expanded to include the rule dir. In the default case
it will become /etc/suricata/rules/filename. Use the exclamation mark
to get a negated match. This allows for white listing.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filemd5:md5-blacklist;
filemd5:!md5-whitelist;
</pre></div>
</div>
<p><em>File format</em></p>
<p>The file format is simple. It's a text file with a single md5 per
line, at the start of the line, in hex notation. If there is extra
info on the line it is ignored.</p>
<p>Output from md5sum is fine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="n">f8d0355f0032c3e6311c6408d7c2dc2</span>  <span class="n">util</span><span class="o">-</span><span class="n">path</span><span class="o">.</span><span class="n">c</span>
<span class="n">b9cf5cf347a70e02fde975fc4e117760</span>  <span class="n">util</span><span class="o">-</span><span class="n">pidfile</span><span class="o">.</span><span class="n">c</span>
<span class="mi">02</span><span class="n">aaa6c3f4dbae65f5889eeb8f2bbb8d</span>  <span class="n">util</span><span class="o">-</span><span class="n">pool</span><span class="o">.</span><span class="n">c</span>
<span class="n">dd5fc1ee7f2f96b5f12d1a854007a818</span>  <span class="n">util</span><span class="o">-</span><span class="nb">print</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
<p>Just MD5's are good as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="n">f8d0355f0032c3e6311c6408d7c2dc2</span>
<span class="n">b9cf5cf347a70e02fde975fc4e117760</span>
<span class="mi">02</span><span class="n">aaa6c3f4dbae65f5889eeb8f2bbb8d</span>
<span class="n">dd5fc1ee7f2f96b5f12d1a854007a818</span>
</pre></div>
</div>
<p><em>Memory requirements</em></p>
<p>Each MD5 uses 16 bytes of memory. 20 Million MD5's use about 310 MiB of memory.</p>
<p>See also: <a class="reference external" href="https://blog.inliniac.net/2012/06/09/suricata-md5-blacklisting/">https://blog.inliniac.net/2012/06/09/suricata-md5-blacklisting/</a></p>
</div>
<div class="section" id="filesha1">
<h4>filesha1<a class="headerlink" href="#filesha1" title="Permalink to this headline">¶</a></h4>
<p>Match file SHA1 against list of SHA1 checksums.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filesha1:[!]filename;
</pre></div>
</div>
<p>The filename is expanded to include the rule dir. In the default case
it will become /etc/suricata/rules/filename. Use the exclamation mark
to get a negated match. This allows for white listing.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filesha1:sha1-blacklist;
filesha1:!sha1-whitelist;
</pre></div>
</div>
<p><em>File format</em></p>
<p>Same as md5 file format.</p>
</div>
<div class="section" id="filesha256">
<h4>filesha256<a class="headerlink" href="#filesha256" title="Permalink to this headline">¶</a></h4>
<p>Match file SHA256 against list of SHA256 checksums.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filesha256:[!]filename;
</pre></div>
</div>
<p>The filename is expanded to include the rule dir. In the default case
it will become /etc/suricata/rules/filename. Use the exclamation mark
to get a negated match. This allows for white listing.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filesha256:sha256-blacklist;
filesha256:!sha256-whitelist;
</pre></div>
</div>
<p><em>File format</em></p>
<p>Same as md5 file format.</p>
</div>
<div class="section" id="filesize">
<h4>filesize<a class="headerlink" href="#filesize" title="Permalink to this headline">¶</a></h4>
<p>Match on the size of the file as it is being transferred.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filesize</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Possible units are KB, MB and GB, without any unit the default is bytes.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filesize</span><span class="p">:</span><span class="mi">100</span><span class="p">;</span> <span class="c1"># exactly 100 bytes</span>
<span class="n">filesize</span><span class="p">:</span><span class="mi">100</span><span class="o">&lt;&gt;</span><span class="mi">200</span><span class="p">;</span> <span class="c1"># greater than 100 and smaller than 200</span>
<span class="n">filesize</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">100</span><span class="n">MB</span><span class="p">;</span> <span class="c1"># greater than 100 megabytes</span>
<span class="n">filesize</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">100</span><span class="n">MB</span><span class="p">;</span> <span class="c1"># smaller than 100 megabytes</span>
</pre></div>
</div>
<p><strong>Note</strong>: For files that are not completely tracked because of packet
loss or stream.reassembly.depth being reached on the &quot;greater than&quot; is
checked. This is because Suricata can know a file is bigger than a
value (it has seen some of it already), but it can't know if the final
size would have been within a range, an exact value or smaller than a
value.</p>
</div>
</div>
<span id="document-rules/dns-keywords"></span><div class="section" id="dns-keywords">
<h3>DNS Keywords<a class="headerlink" href="#dns-keywords" title="Permalink to this headline">¶</a></h3>
<p>There are some more content modifiers (If you are unfamiliar with
content modifiers, please visit the page <a class="reference internal" href="index.html#document-rules/payload-keywords"><span class="doc">Payload Keywords</span></a> These
ones make sure the signature checks a specific part of the
network-traffic.</p>
<div class="section" id="dns-opcode">
<h4>dns.opcode<a class="headerlink" href="#dns-opcode" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches on the <strong>opcode</strong> found in the DNS header flags.</p>
<div class="section" id="syntax">
<h5>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dns.opcode:[!]&lt;number&gt;
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h5>
<p>Match on DNS requests and responses with <strong>opcode</strong> 4:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>
</pre></div>
</div>
<p>Match on DNS requests where the <strong>opcode</strong> is NOT 0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dns.opcode:!0;
</pre></div>
</div>
</div>
</div>
<div class="section" id="dns-query">
<h4>dns.query<a class="headerlink" href="#dns-query" title="Permalink to this headline">¶</a></h4>
<p>With <strong>dns.query</strong> the DNS request queries are inspected. The dns.query
keyword works a bit different from the normal content modifiers. When
used in a rule all contents following it are affected by it.  Example:</p>
<blockquote>
<div>alert dns any any -&gt; any any (msg:&quot;Test dns.query option&quot;;
dns.query; content:&quot;google&quot;; nocase; sid:1;)</div></blockquote>
<img alt="_images/dns_query.png" src="_images/dns_query.png" />
<p>The <strong>dns.query</strong> keyword affects all following contents, until pkt_data
is used or it reaches the end of the rule.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>dns.query</strong> is equivalent to the older <strong>dns_query</strong>.</p>
</div>
<div class="section" id="normalized-buffer">
<h5>Normalized Buffer<a class="headerlink" href="#normalized-buffer" title="Permalink to this headline">¶</a></h5>
<p>Buffer contains literal domain name</p>
<ul class="simple">
<li>&lt;length&gt; values (as seen in a raw DNS request)
are literal '.' characters</li>
<li>no leading &lt;length&gt; value</li>
<li>No terminating NULL (0x00) byte (use a negated relative <code class="docutils literal notranslate"><span class="pre">isdataat</span></code>
to match the end)</li>
</ul>
<p>Example DNS request for &quot;mail.google.com&quot; (for readability, hex
values are encoded between pipes):</p>
<p>DNS query on the wire (snippet):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span><span class="mi">04</span><span class="o">|</span><span class="n">mail</span><span class="o">|</span><span class="mi">06</span><span class="o">|</span><span class="n">google</span><span class="o">|</span><span class="mi">03</span><span class="o">|</span><span class="n">com</span><span class="o">|</span><span class="mi">00</span><span class="o">|</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">dns.query</span></code> buffer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mail</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-buffer-matching">
<h5>Multiple Buffer Matching<a class="headerlink" href="#multiple-buffer-matching" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">dns.query</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
</div>
</div>
<span id="document-rules/tls-keywords"></span><div class="section" id="ssl-tls-keywords">
<h3>SSL/TLS Keywords<a class="headerlink" href="#ssl-tls-keywords" title="Permalink to this headline">¶</a></h3>
<p>Suricata comes with several rule keywords to match on various properties of TLS/SSL handshake. Matches are string inclusion matches.</p>
<div class="section" id="tls-cert-subject">
<h4>tls.cert_subject<a class="headerlink" href="#tls-cert-subject" title="Permalink to this headline">¶</a></h4>
<p>Match TLS/SSL certificate Subject field.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tls.cert_subject; content:&quot;CN=*.googleusercontent.com&quot;; isdataat:!1,relative;
tls.cert_subject; content:&quot;google.com&quot;; nocase; pcre:&quot;/google\.com$/&quot;;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_subject</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_subject</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_subject</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
<div class="section" id="tls-subject">
<h5>tls.subject<a class="headerlink" href="#tls-subject" title="Permalink to this headline">¶</a></h5>
<p>Legacy keyword to match TLS/SSL certificate Subject field.</p>
<p>example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tls</span><span class="o">.</span><span class="n">subject</span><span class="p">:</span><span class="s2">&quot;CN=*.googleusercontent.com&quot;</span>
</pre></div>
</div>
<p>Case sensitive, can't use 'nocase', or other modifiers.</p>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">tls.cert_subject</span></code> replaces the following legacy keywords: <code class="docutils literal notranslate"><span class="pre">tls_cert_subject</span></code> and <code class="docutils literal notranslate"><span class="pre">tls.subject</span></code>.
It's recommended that rules be converted to use the new one.</p>
</div>
</div>
<div class="section" id="tls-cert-issuer">
<h4>tls.cert_issuer<a class="headerlink" href="#tls-cert-issuer" title="Permalink to this headline">¶</a></h4>
<p>Match TLS/SSL certificate Issuer field.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tls.cert_issuer; content:&quot;WoSign&quot;; nocase; isdataat:!1,relative;
tls.cert_issuer; content:&quot;StartCom&quot;; nocase; pcre:&quot;/StartCom$/&quot;;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_issuer</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_issuer</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<div class="section" id="tls-issuerdn">
<h5>tls.issuerdn<a class="headerlink" href="#tls-issuerdn" title="Permalink to this headline">¶</a></h5>
<p>Legacy keyword to match TLS/SSL certificate IssuerDN field</p>
<p>example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tls.issuerdn:!&quot;CN=Google-Internet-Authority&quot;
</pre></div>
</div>
<p>Case sensitive, can't use 'nocase', or other modifiers.</p>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">tls.cert_issuer</span></code> replaces the following legacy keywords: <code class="docutils literal notranslate"><span class="pre">tls_cert_issuer</span></code> and <code class="docutils literal notranslate"><span class="pre">tls.issuerdn</span></code>.
It's recommended that rules be converted to use the new one.</p>
</div>
</div>
<div class="section" id="tls-cert-serial">
<h4>tls.cert_serial<a class="headerlink" href="#tls-cert-serial" title="Permalink to this headline">¶</a></h4>
<p>Match on the serial number in a certificate.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match cert serial&quot;</span><span class="p">;</span> \
  <span class="n">tls</span><span class="o">.</span><span class="n">cert_serial</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;5C:19:B7:B1:32:3B:1C:A1&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">200012</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_serial</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_serial</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_serial</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">tls_cert_serial</span></code>. You may continue
to use the previous name, but it's recommended that rules be converted to use
the new name.</p>
</div>
<div class="section" id="tls-cert-fingerprint">
<h4>tls.cert_fingerprint<a class="headerlink" href="#tls-cert-fingerprint" title="Permalink to this headline">¶</a></h4>
<p>Match on the SHA-1 fingerprint of the certificate.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match cert fingerprint&quot;</span><span class="p">;</span> \
  <span class="n">tls</span><span class="o">.</span><span class="n">cert_fingerprint</span><span class="p">;</span> \
  <span class="n">content</span><span class="p">:</span><span class="s2">&quot;4a:a3:66:76:82:cb:6b:23:bb:c3:58:47:23:a4:63:a7:78:a4:a1:18&quot;</span><span class="p">;</span> \
  <span class="n">sid</span><span class="p">:</span><span class="mi">200023</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_fingerprint</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_fingerprint</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.cert_fingerprint</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">tls_cert_fingerprint</span></code> may continue
to use the previous name, but it's recommended that rules be converted to use
the new name.</p>
</div>
<div class="section" id="tls-sni">
<h4>tls.sni<a class="headerlink" href="#tls-sni" title="Permalink to this headline">¶</a></h4>
<p>Match TLS/SSL Server Name Indication field.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tls.sni; content:&quot;oisf.net&quot;; nocase; isdataat:!1,relative;
tls.sni; content:&quot;oisf.net&quot;; nocase; pcre:&quot;/oisf.net$/&quot;;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.sni</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.sni</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.sni</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">tls_sni</span></code>. You may continue
to use the previous name, but it's recommended that rules be converted to use
the new name.</p>
</div>
<div class="section" id="tls-cert-notbefore">
<h4>tls_cert_notbefore<a class="headerlink" href="#tls-cert-notbefore" title="Permalink to this headline">¶</a></h4>
<p>Match on the NotBefore field in a certificate.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match cert NotBefore&quot;</span><span class="p">;</span> \
  <span class="n">tls_cert_notbefore</span><span class="p">:</span><span class="mi">1998</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span><span class="o">&lt;&gt;</span><span class="mi">2008</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">200005</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="tls-cert-notafter">
<h4>tls_cert_notafter<a class="headerlink" href="#tls-cert-notafter" title="Permalink to this headline">¶</a></h4>
<p>Match on the NotAfter field in a certificate.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match cert NotAfter&quot;</span><span class="p">;</span> \
  <span class="n">tls_cert_notafter</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">2015</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">200006</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="tls-cert-expired">
<h4>tls_cert_expired<a class="headerlink" href="#tls-cert-expired" title="Permalink to this headline">¶</a></h4>
<p>Match returns true if certificate is expired. It evaluates the validity date
from the certificate.</p>
<p>Usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tls_cert_expired</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="tls-cert-valid">
<h4>tls_cert_valid<a class="headerlink" href="#tls-cert-valid" title="Permalink to this headline">¶</a></h4>
<p>Match returns true if certificate is not expired. It only evaluates the
validity date. It does <em>not</em> do cert chain validation. It is the opposite
of <code class="docutils literal notranslate"><span class="pre">tls_cert_expired</span></code>.</p>
<p>Usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tls_cert_valid</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="tls-certs">
<h4>tls.certs<a class="headerlink" href="#tls-certs" title="Permalink to this headline">¶</a></h4>
<p>Do a &quot;raw&quot; match on each of the certificates in the TLS certificate chain.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match bytes in TLS cert&quot;</span><span class="p">;</span> <span class="n">tls</span><span class="o">.</span><span class="n">certs</span><span class="p">;</span> \
  <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|06 09 2a 86|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">200070</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.certs</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.certs</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">tls.certs</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="tls-version">
<h4>tls.version<a class="headerlink" href="#tls-version" title="Permalink to this headline">¶</a></h4>
<p>Match on negotiated TLS/SSL version.</p>
<p>Supported values: &quot;1.0&quot;, &quot;1.1&quot;, &quot;1.2&quot;, &quot;1.3&quot;</p>
<p>It is also possible to match versions using a hex string.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tls</span><span class="o">.</span><span class="n">version</span><span class="p">:</span><span class="mf">1.2</span><span class="p">;</span>
<span class="n">tls</span><span class="o">.</span><span class="n">version</span><span class="p">:</span><span class="mh">0x7f12</span><span class="p">;</span>
</pre></div>
</div>
<p>The first example matches TLSv1.2, whilst the last example matches TLSv1.3
draft 16.</p>
</div>
<div class="section" id="ssl-version">
<h4>ssl_version<a class="headerlink" href="#ssl-version" title="Permalink to this headline">¶</a></h4>
<p>Match version of SSL/TLS record.</p>
<p>Supported values &quot;sslv2&quot;, &quot;sslv3&quot;, &quot;tls1.0&quot;, &quot;tls1.1&quot;, &quot;tls1.2&quot;, &quot;tls1.3&quot;</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match TLSv1.2&quot;</span><span class="p">;</span> \
  <span class="n">ssl_version</span><span class="p">:</span><span class="n">tls1</span><span class="mf">.2</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">200030</span><span class="p">;)</span>
</pre></div>
</div>
<p>It is also possible to match on several versions at the same time.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match SSLv2 and SSLv3&quot;</span><span class="p">;</span> \
  <span class="n">ssl_version</span><span class="p">:</span><span class="n">sslv2</span><span class="p">,</span><span class="n">sslv3</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">200031</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="tls-fingerprint">
<h4>tls.fingerprint<a class="headerlink" href="#tls-fingerprint" title="Permalink to this headline">¶</a></h4>
<p>match TLS/SSL certificate SHA1 fingerprint</p>
<p>example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tls.fingerprint:!&quot;f3:40:21:48:70:2c:31:bc:b5:aa:22:ad:63:d6:bc:2e:b3:46:e2:5a&quot;
</pre></div>
</div>
<p>Case sensitive, can't use 'nocase'.</p>
<p>The tls.fingerprint buffer is lower case so you must use lower case letters for this to match.</p>
</div>
<div class="section" id="tls-store">
<h4>tls.store<a class="headerlink" href="#tls-store" title="Permalink to this headline">¶</a></h4>
<p>store TLS/SSL certificate on disk.
The location can be specified in the <cite>output.tls-store.certs-log-dir</cite> parameter of the yaml configuration file, cf <a class="reference internal" href="index.html#suricata-yaml-outputs-tls"><span class="std std-ref">TLS parameters and certificates logging (tls.log)</span></a>..</p>
</div>
<div class="section" id="ssl-state">
<h4>ssl_state<a class="headerlink" href="#ssl-state" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">ssl_state</span></code> keyword matches the state of the SSL connection. The possible states
are <code class="docutils literal notranslate"><span class="pre">client_hello</span></code>, <code class="docutils literal notranslate"><span class="pre">server_hello</span></code>, <code class="docutils literal notranslate"><span class="pre">client_keyx</span></code>, <code class="docutils literal notranslate"><span class="pre">server_keyx</span></code> and <code class="docutils literal notranslate"><span class="pre">unknown</span></code>.
You can specify several states with <code class="docutils literal notranslate"><span class="pre">|</span></code> (OR) to check for any of the specified states.</p>
</div>
<div class="section" id="tls-random">
<h4>tls.random<a class="headerlink" href="#tls-random" title="Permalink to this headline">¶</a></h4>
<p>Matches on the 32 bytes of the TLS random field.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;TLS random test&quot;</span><span class="p">;</span> \
  <span class="n">tls</span><span class="o">.</span><span class="n">random</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|9b ce 7a 5e 57 5d 77 02 07 c2 9d be 24 01 cc f0 5d cd e1 d2 a5 86 9c 4a 3e ee 38 db 55 1a d9 bc|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span> <span class="mi">200074</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.random</span></code> is a sticky buffer.</p>
</div>
<div class="section" id="tls-random-time">
<h4>tls.random_time<a class="headerlink" href="#tls-random-time" title="Permalink to this headline">¶</a></h4>
<p>Matches on the first 4 bytes of the TLS random field.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;TLS random_time test&quot;</span><span class="p">;</span> \
  <span class="n">tls</span><span class="o">.</span><span class="n">random_time</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|9b ce 7a 5e|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span> <span class="mi">200075</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.random_time</span></code> is a sticky buffer.</p>
</div>
<div class="section" id="tls-random-bytes">
<h4>tls.random_bytes<a class="headerlink" href="#tls-random-bytes" title="Permalink to this headline">¶</a></h4>
<p>Matches on the last 28 bytes of the TLS random field.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;TLS random_bytes test&quot;</span><span class="p">;</span> \
  <span class="n">tls</span><span class="o">.</span><span class="n">random_bytes</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|57 5d 77 02 07 c2 9d be 24 01 cc f0 5d cd e1 d2 a5 86 9c 4a 3e ee 38 db 55 1a d9 bc|&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span> <span class="mi">200076</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tls.random_bytes</span></code> is a sticky buffer.</p>
</div>
</div>
<span id="document-rules/ssh-keywords"></span><div class="section" id="ssh-keywords">
<h3>SSH Keywords<a class="headerlink" href="#ssh-keywords" title="Permalink to this headline">¶</a></h3>
<p>Suricata has several rule keywords to match on different elements of SSH
connections.</p>
<div class="section" id="ssh-proto">
<h4>ssh.proto<a class="headerlink" href="#ssh-proto" title="Permalink to this headline">¶</a></h4>
<p>Match on the version of the SSH protocol used. <code class="docutils literal notranslate"><span class="pre">ssh.proto</span></code> is a sticky buffer,
and can be used as a fast pattern. <code class="docutils literal notranslate"><span class="pre">ssh.proto</span></code> replaces the previous buffer
name: <code class="docutils literal notranslate"><span class="pre">ssh_proto</span></code>. You may continue to use the previous name, but it's
recommended that existing rules be converted to use the new name.</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">.</span><span class="n">proto</span><span class="p">;</span>
</pre></div>
</div>
<p>Example:</p>
<div class="example-rule docutils container">
alert ssh any any -&gt; any any (msg:&quot;match SSH protocol version&quot;; <span class="example-rule-emphasis">ssh.proto;</span> content:&quot;2.0&quot;; sid:1000010;)</div>
<p>The example above matches on SSH connections with SSH version 2.0.</p>
</div>
<div class="section" id="ssh-software">
<h4>ssh.software<a class="headerlink" href="#ssh-software" title="Permalink to this headline">¶</a></h4>
<p>Match on the software string from the SSH banner. <code class="docutils literal notranslate"><span class="pre">ssh.software</span></code> is a sticky
buffer, and can be used as fast pattern.</p>
<p><code class="docutils literal notranslate"><span class="pre">ssh.software</span></code> replaces the previous keyword names: <code class="docutils literal notranslate"><span class="pre">ssh_software</span></code> &amp;
<code class="docutils literal notranslate"><span class="pre">ssh.softwareversion</span></code>. You may continue to use the previous name, but it's
recommended that rules be converted to use the new name.</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">.</span><span class="n">software</span><span class="p">;</span>
</pre></div>
</div>
<p>Example:</p>
<div class="example-rule docutils container">
alert ssh any any -&gt; any any (msg:&quot;match SSH software string&quot;; <span class="example-rule-emphasis">ssh.software;</span> content:&quot;openssh&quot;; nocase; sid:1000020;)</div>
<p>The example above matches on SSH connections where the software string contains
&quot;openssh&quot;.</p>
</div>
<div class="section" id="ssh-protoversion">
<h4>ssh.protoversion<a class="headerlink" href="#ssh-protoversion" title="Permalink to this headline">¶</a></h4>
<p>Matches on the version of the SSH protocol used. A value of <code class="docutils literal notranslate"><span class="pre">2_compat</span></code>
includes SSH version 1.99.</p>
<p>Format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ssh.protoversion:[0-9](\.[0-9])?|2_compat;
</pre></div>
</div>
<p>Example:</p>
<div class="example-rule docutils container">
alert ssh any any -&gt; any any (msg:&quot;SSH v2 compatible&quot;; <span class="example-rule-emphasis">ssh.protoversion:2_compat;</span> sid:1;)</div>
<p>The example above matches on SSH connections with SSH version 2 or 1.99.</p>
<div class="example-rule docutils container">
alert ssh any any -&gt; any any (msg:&quot;SSH v1.10&quot;; <span class="example-rule-emphasis">ssh.protoversion:1.10;</span> sid:1;)</div>
<p>The example above matches on SSH connections with SSH version 1.10 only.</p>
</div>
<div class="section" id="ssh-softwareversion">
<h4>ssh.softwareversion<a class="headerlink" href="#ssh-softwareversion" title="Permalink to this headline">¶</a></h4>
<p>This keyword has been deprecated. Please use <code class="docutils literal notranslate"><span class="pre">ssh.software</span></code> instead. Matches
on the software string from the SSH banner.</p>
<p>Example:</p>
<div class="example-rule docutils container">
alert ssh any any -&gt; any any (msg:&quot;match SSH software string&quot;; <span class="example-rule-emphasis">ssh.softwareversion:&quot;OpenSSH&quot;;</span> sid:10000040;)</div>
<p>Suricata comes with a Hassh integration (<a class="reference external" href="https://github.com/salesforce/hassh">https://github.com/salesforce/hassh</a>). Hassh is used to fingerprint ssh clients and servers.</p>
<p>Hassh must be enabled in the Suricata config file (set 'app-layer.protocols.ssh.hassh' to 'yes').</p>
</div>
<div class="section" id="ssh-hassh">
<h4>ssh.hassh<a class="headerlink" href="#ssh-hassh" title="Permalink to this headline">¶</a></h4>
<p>Match on hassh (md5 of of hassh algorithms of client).</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ssh</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match hassh&quot;</span><span class="p">;</span> \
    <span class="n">ssh</span><span class="o">.</span><span class="n">hassh</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;ec7378c1a92f5a8dde7e8b7a1ddf33d1&quot;</span><span class="p">;</span>\
    <span class="n">sid</span><span class="p">:</span><span class="mi">1000010</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="ssh-hassh-string">
<h4>ssh.hassh.string<a class="headerlink" href="#ssh-hassh-string" title="Permalink to this headline">¶</a></h4>
<p>Match on Hassh string (hassh algorithms of client).</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ssh</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match hassh-string&quot;</span><span class="p">;</span> \
    <span class="n">ssh</span><span class="o">.</span><span class="n">hassh</span><span class="o">.</span><span class="n">string</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;none,zlib@openssh.com,zlib&quot;</span><span class="p">;</span> \
    <span class="n">sid</span><span class="p">:</span><span class="mi">1000030</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh.string</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh.string</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="ssh-hassh-server">
<h4>ssh.hassh.server<a class="headerlink" href="#ssh-hassh-server" title="Permalink to this headline">¶</a></h4>
<p>Match on hassh (md5 of hassh algorithms of server).</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ssh</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match SSH hash-server&quot;</span><span class="p">;</span> \
    <span class="n">ssh</span><span class="o">.</span><span class="n">hassh</span><span class="o">.</span><span class="n">server</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;b12d2871a1189eff20364cf5333619ee&quot;</span><span class="p">;</span> \
    <span class="n">sid</span><span class="p">:</span><span class="mi">1000020</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh.server</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh.server</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="ssh-hassh-server-string">
<h4>ssh.hassh.server.string<a class="headerlink" href="#ssh-hassh-server-string" title="Permalink to this headline">¶</a></h4>
<p>Match on hassh string (hassh algorithms of server).</p>
<dl class="docutils">
<dt>Example::</dt>
<dd><dl class="first last docutils">
<dt>alert ssh any any -&gt; any any (msg:&quot;match SSH hash-server-string&quot;; </dt>
<dd>ssh.hassh.server.string; content:&quot;<a class="reference external" href="mailto:umac-64-etm&#37;&#52;&#48;openssh&#46;com">umac-64-etm<span>&#64;</span>openssh<span>&#46;</span>com</a>,umac-<a class="reference external" href="mailto:128-etm&#37;&#52;&#48;openssh&#46;com">128-etm<span>&#64;</span>openssh<span>&#46;</span>com</a>&quot;; sid:1000040;)</dd>
</dl>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh.server.string</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ssh.hassh.server.string</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
</div>
<span id="document-rules/ja3-keywords"></span><div class="section" id="ja3-keywords">
<h3>JA3 Keywords<a class="headerlink" href="#ja3-keywords" title="Permalink to this headline">¶</a></h3>
<p>Suricata comes with a JA3 integration (<a class="reference external" href="https://github.com/salesforce/ja3">https://github.com/salesforce/ja3</a>). JA3 is used to fingerprint TLS clients.</p>
<p>JA3 must be enabled in the Suricata config file (set 'app-layer.protocols.tls.ja3-fingerprints' to 'yes').</p>
<div class="section" id="ja3-hash">
<h4>ja3.hash<a class="headerlink" href="#ja3-hash" title="Permalink to this headline">¶</a></h4>
<p>Match on JA3 hash (md5).</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match JA3 hash&quot;</span><span class="p">;</span> \
    <span class="n">ja3</span><span class="o">.</span><span class="n">hash</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;e7eca2baf4458d095b7f45da28c16c34&quot;</span><span class="p">;</span> \
    <span class="n">sid</span><span class="p">:</span><span class="mi">100001</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ja3.hash</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ja3.hash</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">ja3.hash</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">ja3_hash</span></code>. You may continue
to use the previous name, but it's recommended that rules be converted to use
the new name.</p>
</div>
<div class="section" id="ja3-string">
<h4>ja3.string<a class="headerlink" href="#ja3-string" title="Permalink to this headline">¶</a></h4>
<p>Match on JA3 string.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match JA3 string&quot;</span><span class="p">;</span> \
    <span class="n">ja3</span><span class="o">.</span><span class="n">string</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;19-20-21-22&quot;</span><span class="p">;</span> \
    <span class="n">sid</span><span class="p">:</span><span class="mi">100002</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ja3.string</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ja3.string</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">ja3.string</span></code> replaces the previous keyword name: <code class="docutils literal notranslate"><span class="pre">ja3_string</span></code>. You may continue
to use the previous name, but it's recommended that rules be converted to use
the new name.</p>
</div>
<div class="section" id="ja3s-hash">
<h4>ja3s.hash<a class="headerlink" href="#ja3s-hash" title="Permalink to this headline">¶</a></h4>
<p>Match on JA3S hash (md5).</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match JA3S hash&quot;</span><span class="p">;</span> \
    <span class="n">ja3s</span><span class="o">.</span><span class="n">hash</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;b26c652e0a402a24b5ca2a660e84f9d5&quot;</span><span class="p">;</span> \
    <span class="n">sid</span><span class="p">:</span><span class="mi">100003</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ja3s.hash</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ja3s.hash</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="ja3s-string">
<h4>ja3s.string<a class="headerlink" href="#ja3s-string" title="Permalink to this headline">¶</a></h4>
<p>Match on JA3S string.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tls</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;match on JA3S string&quot;</span><span class="p">;</span> \
    <span class="n">ja3s</span><span class="o">.</span><span class="n">string</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;771,23-35&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">100004</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ja3s.string</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ja3s.string</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
</div>
<span id="document-rules/modbus-keyword"></span><div class="section" id="modbus-keyword">
<h3>Modbus Keyword<a class="headerlink" href="#modbus-keyword" title="Permalink to this headline">¶</a></h3>
<p>The modbus keyword can be used for matching on various properties of
Modbus requests.</p>
<p>There are three ways of using this keyword:</p>
<ul class="simple">
<li>matching on functions properties with the setting &quot;function&quot;;</li>
<li>matching on directly on data access with the setting &quot;access&quot;;</li>
<li>matching on unit identifier with the setting &quot;unit&quot; only or with the previous setting &quot;function&quot; or &quot;access&quot;.</li>
</ul>
<p>With the setting <strong>function</strong>, you can match on:</p>
<ul class="simple">
<li>an action based on a function code field and a sub-function code when applicable;</li>
<li>one of three categories of Modbus functions;</li>
<li>public functions that are publicly defined (setting &quot;public&quot;)</li>
<li>user-defined functions (setting &quot;user&quot;)</li>
<li>reserved functions that are dedicated to proprietary extensions of Modbus (keyword &quot;reserved&quot;)</li>
<li>one of the two sub-groups of public functions:<ul>
<li>assigned functions whose definition is already given in the Modbus specification (keyword &quot;assigned&quot;);</li>
<li>unassigned functions, which are reserved for future use (keyword &quot;unassigned&quot;).</li>
</ul>
</li>
</ul>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>modbus: function &lt;value&gt;
modbus: function &lt;value&gt;, subfunction &lt;value&gt;
modbus: function [!] &lt;assigned | unassigned | public | user | reserved | all&gt;
</pre></div>
</div>
<p>Sign '!' is negation</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>modbus: function 21                # Write File record function
modbus: function 4, subfunction 4  # Force Listen Only Mode (Diagnostics) function
modbus: function assigned          # defined by Modbus Application Protocol Specification V1.1b3
modbus: function public            # validated by the Modbus.org community
modbus: function user              # internal use and not supported by the specification
modbus: function reserved          # used by some companies for legacy products and not available for public use
modbus: function !reserved         # every function but reserved function
</pre></div>
</div>
<p>With the <strong>access</strong> setting, you can match on:</p>
<ul class="simple">
<li>a type of data access (read or write);</li>
<li>one of primary tables access (Discretes Input, Coils, Input Registers and Holding Registers);</li>
<li>a range of addresses access;</li>
<li>a written value.</li>
</ul>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="o">&lt;</span><span class="n">read</span> <span class="o">|</span> <span class="n">write</span><span class="o">&gt;</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">read</span> <span class="o">&lt;</span><span class="n">discretes</span> <span class="o">|</span> <span class="n">coils</span> <span class="o">|</span> <span class="nb">input</span> <span class="o">|</span> <span class="n">holding</span><span class="o">&gt;</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">read</span> <span class="o">&lt;</span><span class="n">discretes</span> <span class="o">|</span> <span class="n">coils</span> <span class="o">|</span> <span class="nb">input</span> <span class="o">|</span> <span class="n">holding</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">address</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">write</span> <span class="o">&lt;</span> <span class="n">coils</span> <span class="o">|</span> <span class="n">holding</span><span class="o">&gt;</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">write</span> <span class="o">&lt;</span> <span class="n">coils</span> <span class="o">|</span> <span class="n">holding</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">address</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">write</span> <span class="o">&lt;</span> <span class="n">coils</span> <span class="o">|</span> <span class="n">holding</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">address</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">value</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>With _&lt;value&gt;_ setting matches on the address or value as it is being
accessed or written as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">address</span> <span class="mi">100</span>      <span class="c1"># exactly address 100</span>
<span class="n">address</span> <span class="mi">100</span><span class="o">&lt;&gt;</span><span class="mi">200</span> <span class="c1"># greater than address 100 and smaller than address 200</span>
<span class="n">address</span> <span class="o">&gt;</span><span class="mi">100</span>     <span class="c1"># greater than address 100</span>
<span class="n">address</span> <span class="o">&lt;</span><span class="mi">100</span>     <span class="c1"># smaller than address 100</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">read</span>                                    <span class="c1"># Read access</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">write</span>                                   <span class="c1"># Write access</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">read</span> <span class="nb">input</span>                              <span class="c1"># Read access to Discretes Input table</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">write</span> <span class="n">coils</span>                             <span class="c1"># Write access to Coils table</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">read</span> <span class="n">discretes</span><span class="p">,</span> <span class="n">address</span> <span class="o">&lt;</span><span class="mi">100</span>            <span class="c1"># Read access at address smaller than 100 of Discretes Input table</span>
<span class="n">modbus</span><span class="p">:</span> <span class="n">access</span> <span class="n">write</span> <span class="n">holding</span><span class="p">,</span> <span class="n">address</span> <span class="mi">500</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;</span><span class="mi">200</span>  <span class="c1"># Write value greater than 200 at address 500 of Holding Registers table</span>
</pre></div>
</div>
<p>With the setting <strong>unit</strong>, you can match on:</p>
<ul class="simple">
<li>a MODBUS slave address of a remote device connected on the sub-network behind a bridge or a gateway. The destination IP address identifies the bridge itself and the bridge uses the MODBUS unit identifier to forward the request to the right slave device.</li>
</ul>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>modbus: unit &lt;value&gt;
modbus: unit &lt;value&gt;, function &lt;value&gt;
modbus: unit &lt;value&gt;, function &lt;value&gt;, subfunction &lt;value&gt;
modbus: unit &lt;value&gt;, function [!] &lt;assigned | unassigned | public | user | reserved | all&gt;
modbus: unit &lt;value&gt;, access &lt;read | write&gt;
modbus: unit &lt;value&gt;, access read &lt;discretes | coils | input | holding&gt;
modbus: unit &lt;value&gt;, access read &lt;discretes | coils | input | holding&gt;, address &lt;value&gt;
modbus: unit &lt;value&gt;, access write &lt; coils | holding&gt;
modbus: unit &lt;value&gt;, access write &lt; coils | holding&gt;, address &lt;value&gt;
modbus: unit &lt;value&gt;, access write &lt; coils | holding&gt;, address &lt;value&gt;, value &lt;value&gt;
</pre></div>
</div>
<p>With _&lt;value&gt;_ setting matches on the address or value as it is being
accessed or written as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unit</span> <span class="mi">10</span>     <span class="c1"># exactly unit identifier 10</span>
<span class="n">unit</span> <span class="mi">10</span><span class="o">&lt;&gt;</span><span class="mi">20</span> <span class="c1"># greater than unit identifier 10 and smaller than unit identifier 20</span>
<span class="n">unit</span> <span class="o">&gt;</span><span class="mi">10</span>    <span class="c1"># greater than unit identifier 10</span>
<span class="n">unit</span> <span class="o">&lt;</span><span class="mi">10</span>    <span class="c1"># smaller than unit identifier 10</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>modbus: unit 10                                                       # Unit identifier 10
modbus: unit 10, function 21                                          # Unit identifier 10 and write File record function
modbus: unit 10, function 4, subfunction 4                            # Unit identifier 10 and force Listen Only Mode (Diagnostics) function
modbus: unit 10, function assigned                                    # Unit identifier 10 and assigned function
modbus: unit 10, function !reserved                                   # Unit identifier 10 and every function but reserved function
modbus: unit 10, access read                                          # Unit identifier 10 and Read access
modbus: unit 10, access write coils                                   # Unit identifier 10 and Write access to Coils table
modbus: unit &gt;10, access read discretes, address &lt;100                 # Greater than unit identifier 10 and Read access at address smaller than 100 of Discretes Input table
modbus: unit 10&lt;&gt;20, access write holding, address 500, value &gt;200    # Greater than unit identifier 10 and smaller than unit identifier 20 and Write value greater than 200 at address 500 of Holding Registers table
</pre></div>
</div>
<p>(cf. <a class="reference external" href="http://www.modbus.org/docs/Modbus_Application_Protocol_V1_1b3.pdf">http://www.modbus.org/docs/Modbus_Application_Protocol_V1_1b3.pdf</a>)</p>
<p><strong>Note:</strong> Address of read and write are starting at 1. So if your system
is using a start at 0, you need to add 1 the address values.</p>
<p><strong>Note:</strong> According to MODBUS Messaging on TCP/IP Implementation Guide
V1.0b, it is recommended to keep the TCP connection opened with a
remote device and not to open and close it for each MODBUS/TCP
transaction. In that case, it is important to set the depth of the
stream reassembling as unlimited (stream.reassembly.depth: 0)</p>
<p><strong>Note:</strong> According to MODBUS Messaging on TCP/IP Implementation Guide
V1.0b, the MODBUS slave device addresses on serial line are assigned from 1 to
247 (decimal). Address 0 is used as broadcast address.</p>
<p>(cf. <a class="reference external" href="http://www.modbus.org/docs/Modbus_Messaging_Implementation_Guide_V1_0b.pdf">http://www.modbus.org/docs/Modbus_Messaging_Implementation_Guide_V1_0b.pdf</a>)</p>
<p>Paper and presentation (in french) on Modbus support are available :
<a class="reference external" href="http://www.ssi.gouv.fr/agence/publication/detection-dintrusion-dans-les-systemes-industriels-suricata-et-le-cas-modbus/">http://www.ssi.gouv.fr/agence/publication/detection-dintrusion-dans-les-systemes-industriels-suricata-et-le-cas-modbus/</a></p>
</div>
<span id="document-rules/dcerpc-keywords"></span><div class="section" id="dcerpc-keywords">
<h3>DCERPC Keywords<a class="headerlink" href="#dcerpc-keywords" title="Permalink to this headline">¶</a></h3>
<p>Following keywords can be used for matching on fields in headers and payloads
of DCERPC packets over UDP, TCP and SMB.</p>
<div class="section" id="dcerpc-iface">
<h4>dcerpc.iface<a class="headerlink" href="#dcerpc-iface" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the interface UUID in a DCERPC header. If <cite>any_frag</cite> option
is given, the match shall be done on all fragments. If it's not, the match shall
only happen on the first fragment.</p>
<p>The format of the keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dcerpc.iface:&lt;uuid&gt;;
dcerpc.iface:&lt;uuid&gt;,[&gt;,&lt;,!,=]&lt;iface_version&gt;;
dcerpc.iface:&lt;uuid&gt;,any_frag;
dcerpc.iface:&lt;uuid&gt;,[&gt;,&lt;,!,=]&lt;iface_version&gt;,any_frag;
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dcerpc.iface:367abb81-9844-35f1-ad32-98f038001003;
dcerpc.iface:367abb81-9844-35f1-ad32-98f038001003,!10;
dcerpc.iface:367abb81-9844-35f1-ad32-98f038001003,any_frag;
dcerpc.iface:367abb81-9844-35f1-ad32-98f038001003,&gt;1,any_frag;
</pre></div>
</div>
<p>ET Open rule example:</p>
<div class="example-rule docutils container">
alert tcp any any -&gt; $HOME_NET any (msg:&quot;ET NETBIOS DCERPC WMI Remote Process Execution&quot;; flow:to_server,established; dce_iface:00000143-0000-0000-c000-000000000046; classtype:bad-unknown; sid:2027167; rev:1; metadata:affected_product Windows_XP_Vista_7_8_10_Server_32_64_Bit, attack_target Client_Endpoint, created_at 2019_04_09, deployment Internal, former_category NETBIOS, signature_severity Informational, updated_at 2019_04_09;)</div>
</div>
<div class="section" id="dcerpc-opnum">
<h4>dcerpc.opnum<a class="headerlink" href="#dcerpc-opnum" title="Permalink to this headline">¶</a></h4>
<p>Match on one or many operation numbers and/or operation number range within the
interface in a DCERPC header.</p>
<p>The format of the keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dcerpc.opnum:&lt;u16&gt;;
dcerpc.opnum:[&gt;,&lt;,!,=]&lt;u16&gt;;
dcerpc.opnum:&lt;u16&gt;,&lt;u16&gt;,&lt;u16&gt;....;
dcerpc.opnum:&lt;u16&gt;-&lt;u16&gt;;
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dcerpc</span><span class="o">.</span><span class="n">opnum</span><span class="p">:</span><span class="mi">15</span><span class="p">;</span>
<span class="n">dcerpc</span><span class="o">.</span><span class="n">opnum</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">;</span>
<span class="n">dcerpc</span><span class="o">.</span><span class="n">opnum</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">61</span><span class="p">;</span>
<span class="n">dcerpc</span><span class="o">.</span><span class="n">opnum</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span><span class="mi">5</span><span class="p">;</span>
<span class="n">dcerpc</span><span class="o">.</span><span class="n">opnum</span><span class="p">:</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">62</span><span class="o">-</span><span class="mi">78</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="dcerpc-stub-data">
<h4>dcerpc.stub_data<a class="headerlink" href="#dcerpc-stub-data" title="Permalink to this headline">¶</a></h4>
<p>Match on the stub data in a given DCERPC packet. It is a 'sticky buffer'.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dcerpc</span><span class="o">.</span><span class="n">stub_data</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-information">
<h4>Additional information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h4>
<p>More information on the protocol can be found here:</p>
<ul class="simple">
<li>DCERPC: <a class="reference external" href="https://pubs.opengroup.org/onlinepubs/9629399/chap1.htm">https://pubs.opengroup.org/onlinepubs/9629399/chap1.htm</a></li>
</ul>
</div>
</div>
<span id="document-rules/dhcp-keywords"></span><div class="section" id="dhcp-keywords">
<h3>DHCP keywords<a class="headerlink" href="#dhcp-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dhcp-leasetime">
<h4>dhcp.leasetime<a class="headerlink" href="#dhcp-leasetime" title="Permalink to this headline">¶</a></h4>
<p>DHCP lease time (integer).</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">.</span><span class="n">leasetime</span><span class="p">:[</span><span class="n">op</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The time can be matched exactly, or compared using the _op_ setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">.</span><span class="n">leasetime</span><span class="p">:</span><span class="mi">3</span>    <span class="c1"># exactly 3</span>
<span class="n">dhcp</span><span class="o">.</span><span class="n">leasetime</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span>   <span class="c1"># smaller than 3</span>
<span class="n">dhcp</span><span class="o">.</span><span class="n">leasetime</span><span class="p">:</span><span class="o">&gt;=</span><span class="mi">2</span>  <span class="c1"># greater or equal than 2</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">dhcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;small DHCP lease time (&lt;3)&quot;</span><span class="p">;</span> <span class="n">dhcp</span><span class="o">.</span><span class="n">leasetime</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="dhcp-rebinding-time">
<h4>dhcp.rebinding_time<a class="headerlink" href="#dhcp-rebinding-time" title="Permalink to this headline">¶</a></h4>
<p>DHCP rebinding time (integer).</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">.</span><span class="n">rebinding_time</span><span class="p">:[</span><span class="n">op</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The time can be matched exactly, or compared using the _op_ setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">.</span><span class="n">rebinding_time</span><span class="p">:</span><span class="mi">3</span>    <span class="c1"># exactly 3</span>
<span class="n">dhcp</span><span class="o">.</span><span class="n">rebinding_time</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span>   <span class="c1"># smaller than 3</span>
<span class="n">dhcp</span><span class="o">.</span><span class="n">rebinding_time</span><span class="p">:</span><span class="o">&gt;=</span><span class="mi">2</span>  <span class="c1"># greater or equal than 2</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">dhcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;small DHCP rebinding time (&lt;3)&quot;</span><span class="p">;</span> <span class="n">dhcp</span><span class="o">.</span><span class="n">rebinding_time</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="dhcp-renewal-time">
<h4>dhcp.renewal_time<a class="headerlink" href="#dhcp-renewal-time" title="Permalink to this headline">¶</a></h4>
<p>DHCP renewal time (integer).</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">.</span><span class="n">renewal_time</span><span class="p">:[</span><span class="n">op</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The time can be matched exactly, or compared using the _op_ setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">.</span><span class="n">renewal_time</span><span class="p">:</span><span class="mi">3</span>    <span class="c1"># exactly 3</span>
<span class="n">dhcp</span><span class="o">.</span><span class="n">renewal_time</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span>   <span class="c1"># smaller than 3</span>
<span class="n">dhcp</span><span class="o">.</span><span class="n">renewal_time</span><span class="p">:</span><span class="o">&gt;=</span><span class="mi">2</span>  <span class="c1"># greater or equal than 2</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">dhcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;small DHCP renewal time (&lt;3)&quot;</span><span class="p">;</span> <span class="n">dhcp</span><span class="o">.</span><span class="n">renewal_time</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-rules/dnp3-keywords"></span><div class="section" id="dnp3-keywords">
<h3>DNP3 Keywords<a class="headerlink" href="#dnp3-keywords" title="Permalink to this headline">¶</a></h3>
<p>The DNP3 keywords can be used to match on fields in decoded DNP3
messages. The keywords are based on Snort's DNP3 keywords and aim to
be 100% compatible.</p>
<div class="section" id="dnp3-func">
<h4>dnp3_func<a class="headerlink" href="#dnp3-func" title="Permalink to this headline">¶</a></h4>
<p>This keyword will match on the application function code found in DNP3
request and responses.  It can be specified as the integer value or
the symbolic name of the function code.</p>
<div class="section" id="syntax">
<h5>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnp3_func</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Where value is one of:</p>
<ul class="simple">
<li>An integer value between 0 and 255 inclusive.</li>
<li>Function code name:<ul>
<li>confirm</li>
<li>read</li>
<li>write</li>
<li>select</li>
<li>operate</li>
<li>direct_operate</li>
<li>direct_operate_nr</li>
<li>immed_freeze</li>
<li>immed_freeze_nr</li>
<li>freeze_clear</li>
<li>freeze_clear_nr</li>
<li>freeze_at_time</li>
<li>freeze_at_time_nr</li>
<li>cold_restart</li>
<li>warm_restart</li>
<li>initialize_data</li>
<li>initialize_appl</li>
<li>start_appl</li>
<li>stop_appl</li>
<li>save_config</li>
<li>enable_unsolicited</li>
<li>disable_unsolicited</li>
<li>assign_class</li>
<li>delay_measure</li>
<li>record_current_time</li>
<li>open_file</li>
<li>close_file</li>
<li>delete_file</li>
<li>get_file_info</li>
<li>authenticate_file</li>
<li>abort_file</li>
<li>activate_config</li>
<li>authenticate_req</li>
<li>authenticate_err</li>
<li>response</li>
<li>unsolicited_response</li>
<li>authenticate_resp</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="dnp3-ind">
<h4>dnp3_ind<a class="headerlink" href="#dnp3-ind" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches on the DNP3 internal indicator flags in the
response application header.</p>
<div class="section" id="id1">
<h5>Syntax<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnp3_ind</span><span class="p">:</span><span class="o">&lt;</span><span class="n">flag</span><span class="o">&gt;</span><span class="p">{,</span><span class="o">&lt;</span><span class="n">flag</span><span class="o">&gt;...</span><span class="p">}</span>
</pre></div>
</div>
<p>Where flag is the name of the internal indicator:</p>
<ul class="simple">
<li>all_stations</li>
<li>class_1_events</li>
<li>class_2_events</li>
<li>class_3_events</li>
<li>need_time</li>
<li>local_control</li>
<li>device_trouble</li>
<li>device_restart</li>
<li>no_func_code_support</li>
<li>object_unknown</li>
<li>parameter_error</li>
<li>event_buffer_overflow</li>
<li>already_executing</li>
<li>config_corrupt</li>
<li>reserved_2</li>
<li>reserved_1</li>
</ul>
<p>This keyword will match of any of the flags listed are set. To match
on multiple flags (AND type match), use dnp3_ind for each flag that
must be set.</p>
</div>
<div class="section" id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnp3_ind</span><span class="p">:</span><span class="n">all_stations</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnp3_ind</span><span class="p">:</span><span class="n">class_1_events</span><span class="p">,</span><span class="n">class_2_events</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dnp3-obj">
<h4>dnp3_obj<a class="headerlink" href="#dnp3-obj" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches on the DNP3 application data objects.</p>
<div class="section" id="id2">
<h5>Syntax<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnp3_obj</span><span class="p">:</span><span class="o">&lt;</span><span class="n">group</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">variation</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Where &lt;group&gt; and &lt;variation&gt; are integer values between 0 and 255 inclusive.</p>
</div>
</div>
<div class="section" id="dnp3-data">
<h4>dnp3_data<a class="headerlink" href="#dnp3-data" title="Permalink to this headline">¶</a></h4>
<p>This keyword will cause the following content options to match on the
re-assembled application buffer. The reassembled application buffer is
a DNP3 fragment with CRCs removed (which occur every 16 bytes), and
will be the complete fragment, possibly reassembled from multiple DNP3
link layer frames.</p>
<div class="section" id="id3">
<h5>Syntax<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnp3_data</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="example">
<h5>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnp3_data</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|c3 06|&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-rules/enip-keyword"></span><div class="section" id="enip-cip-keywords">
<h3>ENIP/CIP Keywords<a class="headerlink" href="#enip-cip-keywords" title="Permalink to this headline">¶</a></h3>
<p>The enip_command and cip_service keywords can be used for matching on various properties of
ENIP requests.</p>
<p>There are three ways of using this keyword:</p>
<ul class="simple">
<li>matching on ENIP command with the setting &quot;enip_command&quot;;</li>
<li>matching on CIP Service with the setting &quot;cip_service&quot;.</li>
<li>matching both the ENIP command and the CIP Service with &quot;enip_command&quot; and &quot;cip_service&quot; together</li>
</ul>
<p>For the ENIP command, we are matching against the command field found in the ENIP encapsulation.</p>
<p>For the CIP Service, we use a maximum of 3 comma separated values representing the Service, Class and Attribute.
These values are described in the CIP specification. CIP Classes are associated with their Service, and CIP Attributes
are associated with their Service. If you only need to match up until the Service, then only provide the Service value.
If you want to match to the CIP Attribute, then you must provide all 3 values.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enip_command</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
<span class="n">cip_service</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">enip_command</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">cip_service</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enip_command</span><span class="p">:</span><span class="mi">99</span>
<span class="n">cip_service</span><span class="p">:</span><span class="mi">75</span>
<span class="n">cip_service</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="mi">246</span><span class="p">,</span><span class="mi">6</span>
<span class="n">enip_command</span><span class="p">:</span><span class="mi">111</span><span class="p">,</span> <span class="n">cip_service</span><span class="p">:</span><span class="mi">5</span>
</pre></div>
</div>
<p>(cf. <a class="reference external" href="http://read.pudn.com/downloads166/ebook/763211/EIP-CIP-V1-1.0.pdf">http://read.pudn.com/downloads166/ebook/763211/EIP-CIP-V1-1.0.pdf</a>)</p>
<p>Information on the protocol can be found here:
<a class="reference external" href="http://literature.rockwellautomation.com/idc/groups/literature/documents/wp/enet-wp001_-en-p.pdf">http://literature.rockwellautomation.com/idc/groups/literature/documents/wp/enet-wp001_-en-p.pdf</a></p>
</div>
<span id="document-rules/ftp-keywords"></span><div class="section" id="ftp-ftp-data-keywords">
<h3>FTP/FTP-DATA Keywords<a class="headerlink" href="#ftp-ftp-data-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="ftpdata-command">
<h4>ftpdata_command<a class="headerlink" href="#ftpdata-command" title="Permalink to this headline">¶</a></h4>
<p>Filter ftp-data channel based on command used on the FTP command channel.
Currently supported commands are RETR (get on a file) and STOR (put on a
file).</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ftpdata_command</span><span class="p">:(</span><span class="n">retr</span><span class="o">|</span><span class="n">stor</span><span class="p">)</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ftpdata_command</span><span class="p">:</span><span class="n">retr</span>
<span class="n">ftpdata_command</span><span class="p">:</span><span class="n">stor</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ftp</span><span class="o">-</span><span class="n">data</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;FTP store password&quot;</span><span class="p">;</span> <span class="n">filestore</span><span class="p">;</span> <span class="n">filename</span><span class="p">:</span><span class="s2">&quot;password&quot;</span><span class="p">;</span> <span class="n">ftpdata_command</span><span class="p">:</span><span class="n">stor</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="ftpbounce">
<h4>ftpbounce<a class="headerlink" href="#ftpbounce" title="Permalink to this headline">¶</a></h4>
<p>Detect FTP bounce attacks.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ftpbounce</span>
</pre></div>
</div>
</div>
</div>
<span id="document-rules/kerberos-keywords"></span><div class="section" id="kerberos-keywords">
<h3>Kerberos Keywords<a class="headerlink" href="#kerberos-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="krb5-msg-type">
<h4>krb5_msg_type<a class="headerlink" href="#krb5-msg-type" title="Permalink to this headline">¶</a></h4>
<p>This keyword allows to match the Kerberos messages by its type (integer).
It is possible to specify the following values defined in RFC4120:</p>
<ul class="simple">
<li>10 (AS-REQ)</li>
<li>11 (AS-REP)</li>
<li>12 (TGS-REQ)</li>
<li>13 (TGS-REP)</li>
<li>30 (ERROR)</li>
</ul>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">krb5_msg_type</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Signature examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 AS-REQ message&quot;</span><span class="p">;</span> <span class="n">krb5_msg_type</span><span class="p">:</span><span class="mi">10</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 AS-REP message&quot;</span><span class="p">;</span> <span class="n">krb5_msg_type</span><span class="p">:</span><span class="mi">11</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 TGS-REQ message&quot;</span><span class="p">;</span> <span class="n">krb5_msg_type</span><span class="p">:</span><span class="mi">12</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">5</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 TGS-REP message&quot;</span><span class="p">;</span> <span class="n">krb5_msg_type</span><span class="p">:</span><span class="mi">13</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">6</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 ERROR message&quot;</span><span class="p">;</span> <span class="n">krb5_msg_type</span><span class="p">:</span><span class="mi">30</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">7</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">AP-REQ and AP-REP are not currently supported since those messages
are embedded in other application protocols.</p>
</div>
</div>
<div class="section" id="krb5-cname">
<h4>krb5_cname<a class="headerlink" href="#krb5-cname" title="Permalink to this headline">¶</a></h4>
<p>Kerberos client name, provided in the ticket (for AS-REQ and TGS-REQ messages).</p>
<p>If the client name from the Kerberos message is composed of several parts, the
name is compared to each part and the match will succeed if any is identical.</p>
<p>Comparison is case-sensitive.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">krb5_cname</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;name&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 des server name&quot;</span><span class="p">;</span> <span class="n">krb5_cname</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;des&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">krb5_cname</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">krb5_cname</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">krb5.cname</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="krb5-sname">
<h4>krb5_sname<a class="headerlink" href="#krb5-sname" title="Permalink to this headline">¶</a></h4>
<p>Kerberos server name, provided in the ticket (for AS-REQ and TGS-REQ messages)
or in the error message.</p>
<p>If the server name from the Kerberos message is composed of several parts, the
name is compared to each part and the match will succeed if any is identical.</p>
<p>Comparison is case-sensitive.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">krb5_sname</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;name&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 krbtgt server name&quot;</span><span class="p">;</span> <span class="n">krb5_sname</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;krbtgt&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">5</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">krb5_sname</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">krb5_sname</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">krb5.sname</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="krb5-err-code">
<h4>krb5_err_code<a class="headerlink" href="#krb5-err-code" title="Permalink to this headline">¶</a></h4>
<p>Kerberos error code (integer). This field is matched in Kerberos error messages only.</p>
<p>For a list of error codes, refer to RFC4120 section 7.5.9.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">krb5_err_code</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Kerberos 5 error C_PRINCIPAL_UNKNOWN&quot;</span><span class="p">;</span> <span class="n">krb5_err_code</span><span class="p">:</span><span class="mi">6</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">6</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="krb5-weak-encryption-event">
<h4>krb5.weak_encryption (event)<a class="headerlink" href="#krb5-weak-encryption-event" title="Permalink to this headline">¶</a></h4>
<p>Event raised if the encryption parameters selected by the server are weak or
deprecated. For example, using a key size smaller than 128, or using deprecated
ciphers like DES.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="o">-</span><span class="n">event</span><span class="p">:</span><span class="n">krb5</span><span class="o">.</span><span class="n">weak_encryption</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;SURICATA Kerberos 5 weak encryption parameters&quot;</span><span class="p">;</span> <span class="n">flow</span><span class="p">:</span><span class="n">to_client</span><span class="p">;</span> <span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="o">-</span><span class="n">event</span><span class="p">:</span><span class="n">krb5</span><span class="o">.</span><span class="n">weak_encryption</span><span class="p">;</span> <span class="n">classtype</span><span class="p">:</span><span class="n">protocol</span><span class="o">-</span><span class="n">command</span><span class="o">-</span><span class="n">decode</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2226001</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="krb5-malformed-data-event">
<h4>krb5.malformed_data (event)<a class="headerlink" href="#krb5-malformed-data-event" title="Permalink to this headline">¶</a></h4>
<p>Event raised in case of a protocol decoding error.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="o">-</span><span class="n">event</span><span class="p">:</span><span class="n">krb5</span><span class="o">.</span><span class="n">malformed_data</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;SURICATA Kerberos 5 malformed request data&quot;</span><span class="p">;</span> <span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">;</span> <span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="o">-</span><span class="n">event</span><span class="p">:</span><span class="n">krb5</span><span class="o">.</span><span class="n">malformed_data</span><span class="p">;</span> <span class="n">classtype</span><span class="p">:</span><span class="n">protocol</span><span class="o">-</span><span class="n">command</span><span class="o">-</span><span class="n">decode</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2226000</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="krb5-ticket-encryption">
<h4>krb5.ticket_encryption<a class="headerlink" href="#krb5-ticket-encryption" title="Permalink to this headline">¶</a></h4>
<p>Kerberos ticket encryption (enumeration).</p>
<p>For a list of encryption types, refer to RFC3961 section 8.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>krb5.ticket_encryption: (!)&quot;weak&quot; or (space or comma)-separated list of integer or string values for an encryption type
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">krb5</span><span class="o">.</span><span class="n">ticket_encryption</span><span class="p">:</span> <span class="n">weak</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">krb5</span><span class="o">.</span><span class="n">ticket_encryption</span><span class="p">:</span> <span class="mi">23</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">krb5</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">krb5</span><span class="o">.</span><span class="n">ticket_encryption</span><span class="p">:</span> <span class="n">rc4</span><span class="o">-</span><span class="n">hmac</span><span class="p">,</span><span class="n">rc4</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">exp</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-rules/smb-keywords"></span><div class="section" id="smb-keywords">
<h3>SMB Keywords<a class="headerlink" href="#smb-keywords" title="Permalink to this headline">¶</a></h3>
<p>SMB keywords used in both SMB1 and SMB2 protocols.</p>
<div class="section" id="smb-named-pipe">
<h4>smb.named_pipe<a class="headerlink" href="#smb-named-pipe" title="Permalink to this headline">¶</a></h4>
<p>Match on SMB named pipe in tree connect.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smb</span><span class="o">.</span><span class="n">named_pipe</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;IPC&quot;</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span>
<span class="n">smb</span><span class="o">.</span><span class="n">named_pipe</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;strange&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/really$/&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">smb.named_pipe</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">smb.named_pipe</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="smb-share">
<h4>smb.share<a class="headerlink" href="#smb-share" title="Permalink to this headline">¶</a></h4>
<p>Match on SMB share name in tree connect.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smb</span><span class="o">.</span><span class="n">share</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;shared&quot;</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span>
<span class="n">smb</span><span class="o">.</span><span class="n">share</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;strange&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/really$/&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">smb.share</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">smb.share</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="smb-ntlmssp-user">
<h4>smb.ntlmssp_user<a class="headerlink" href="#smb-ntlmssp-user" title="Permalink to this headline">¶</a></h4>
<p>Match on SMB ntlmssp user in session setup.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smb</span><span class="o">.</span><span class="n">ntlmssp_user</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;doe&quot;</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span>
<span class="n">smb</span><span class="o">.</span><span class="n">ntlmssp_user</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;doe&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/j(ohn|ane).*doe$/&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">smb.ntlmssp_user</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">smb.ntlmssp_user</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="smb-ntlmssp-domain">
<h4>smb.ntlmssp_domain<a class="headerlink" href="#smb-ntlmssp-domain" title="Permalink to this headline">¶</a></h4>
<p>Match on SMB ntlmssp domain in session setup.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smb</span><span class="o">.</span><span class="n">ntlmssp_domain</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;home&quot;</span><span class="p">;</span> <span class="n">endswith</span><span class="p">;</span>
<span class="n">smb</span><span class="o">.</span><span class="n">ntlmssp_domain</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;home&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/home(sweet)*$/&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">smb.ntlmssp_domain</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">smb.ntlmssp_domain</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
</div>
<span id="document-rules/snmp-keywords"></span><div class="section" id="snmp-keywords">
<h3>SNMP keywords<a class="headerlink" href="#snmp-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="snmp-version">
<h4>snmp.version<a class="headerlink" href="#snmp-version" title="Permalink to this headline">¶</a></h4>
<p>SNMP protocol version (integer). Expected values are 1, 2 (for version 2c) or 3.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snmp</span><span class="o">.</span><span class="n">version</span><span class="p">:[</span><span class="n">op</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The version can be matched exactly, or compared using the _op_ setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snmp</span><span class="o">.</span><span class="n">version</span><span class="p">:</span><span class="mi">3</span>    <span class="c1"># exactly 3</span>
<span class="n">snmp</span><span class="o">.</span><span class="n">version</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span>   <span class="c1"># smaller than 3</span>
<span class="n">snmp</span><span class="o">.</span><span class="n">version</span><span class="p">:</span><span class="o">&gt;=</span><span class="mi">2</span>  <span class="c1"># greater or equal than 2</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">snmp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;old SNMP version (&lt;3)&quot;</span><span class="p">;</span> <span class="n">snmp</span><span class="o">.</span><span class="n">version</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="snmp-community">
<h4>snmp.community<a class="headerlink" href="#snmp-community" title="Permalink to this headline">¶</a></h4>
<p>SNMP community strings are like passwords for SNMP messages in version 1 and 2c.
In version 3, the community string is likely to be encrypted. This keyword will not
match if the value is not accessible.</p>
<p>The default value for the read-only community string is often &quot;public&quot;, and
&quot;private&quot; for the read-write community string.</p>
<p>Comparison is case-sensitive.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snmp</span><span class="o">.</span><span class="n">community</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;private&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">snmp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;SNMP community private&quot;</span><span class="p">;</span> <span class="n">snmp</span><span class="o">.</span><span class="n">community</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;private&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">snmp.community</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">snmp.community</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="snmp-usm">
<h4>snmp.usm<a class="headerlink" href="#snmp-usm" title="Permalink to this headline">¶</a></h4>
<p>SNMP User-based Security Model (USM) is used in version 3.
It corresponds to the user name.</p>
<p>Comparison is case-sensitive.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snmp</span><span class="o">.</span><span class="n">usm</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;admin&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">snmp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;SNMP usm admin&quot;</span><span class="p">;</span> <span class="n">snmp</span><span class="o">.</span><span class="n">usm</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;admin&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">snmp.usm</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">snmp.usm</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="snmp-pdu-type">
<h4>snmp.pdu_type<a class="headerlink" href="#snmp-pdu-type" title="Permalink to this headline">¶</a></h4>
<p>SNMP PDU type (integer).</p>
<p>Common values are:</p>
<blockquote>
<div><ul class="simple">
<li>0: GetRequest</li>
<li>1: GetNextRequest</li>
<li>2: Response</li>
<li>3: SetRequest</li>
<li>4: TrapV1 (obsolete, was the old Trap-PDU in SNMPv1)</li>
<li>5: GetBulkRequest</li>
<li>6: InformRequest</li>
<li>7: TrapV2</li>
<li>8: Report</li>
</ul>
</div></blockquote>
<p>This keyword will not match if the value is not accessible within (for ex, an encrypted
SNMP v3 message).</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snmp</span><span class="o">.</span><span class="n">pdu_type</span><span class="p">:</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Signature example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">snmp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;SNMP response&quot;</span><span class="p">;</span> <span class="n">snmp</span><span class="o">.</span><span class="n">pdu_type</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-rules/base64-keywords"></span><div class="section" id="base64-keywords">
<h3>Base64 keywords<a class="headerlink" href="#base64-keywords" title="Permalink to this headline">¶</a></h3>
<p>Suricata supports decoding base64 encoded data from buffers and matching on the decoded data.</p>
<p>This is achieved by using two keywords, <code class="docutils literal notranslate"><span class="pre">base64_decode</span></code> and <code class="docutils literal notranslate"><span class="pre">base64_data</span></code>. Both keywords must be used in order to generate an alert.</p>
<div class="section" id="base64-decode">
<h4>base64_decode<a class="headerlink" href="#base64-decode" title="Permalink to this headline">¶</a></h4>
<p>Decodes base64 data from a buffer and makes it available for the base64_data function.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">base64_decode</span><span class="p">:</span><span class="nb">bytes</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">relative</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">bytes</span></code> option specifies how many bytes Suricata should decode and make available for base64_data.
The decoding will stop at the end of the buffer.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">offset</span></code> option specifies how many bytes Suricata should skip before decoding.
Bytes are skipped relative to the start of the payload buffer if the <code class="docutils literal notranslate"><span class="pre">relative</span></code> is not set.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">relative</span></code> option makes the decoding start relative to the previous content match. Default behavior is to start at the beginning of the buffer.
This option makes <code class="docutils literal notranslate"><span class="pre">offset</span></code> skip bytes relative to the previous match.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Regarding <code class="docutils literal notranslate"><span class="pre">relative</span></code> and <code class="docutils literal notranslate"><span class="pre">base64_decode</span></code>:</p>
<p class="last">The content match that you want to decode relative to must be the first match in the stream.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">base64_decode</span></code> follows RFC 4648 by default i.e. encounter with any character that is not found in the base64 alphabet leads to rejection of that character and the rest of the string.</p>
<p class="last">See Redmine Bug 5223: <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/5223">https://redmine.openinfosecfoundation.org/issues/5223</a> and RFC 4648: <a class="reference external" href="https://www.rfc-editor.org/rfc/rfc4648#section-3.3">https://www.rfc-editor.org/rfc/rfc4648#section-3.3</a></p>
</div>
</div>
<div class="section" id="base64-data">
<h4>base64_data<a class="headerlink" href="#base64-data" title="Permalink to this headline">¶</a></h4>
<p>base64_data is a <code class="docutils literal notranslate"><span class="pre">sticky</span> <span class="pre">buffer</span></code>.</p>
<p>Enables content matching on the data previously decoded by base64_decode.</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>Here is an example of a rule matching on the base64 encoded string &quot;test&quot; that is found inside the http_uri buffer.</p>
<p>It starts decoding relative to the known string &quot;somestring&quot; with the known offset of 1. This must be the first occurrence of &quot;somestring&quot; in the buffer.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Buffer</span> <span class="n">content</span><span class="p">:</span>
<span class="n">http_uri</span> <span class="o">=</span> <span class="s2">&quot;GET /en/somestring&amp;dGVzdAo=&amp;not_base64&quot;</span>

<span class="n">Rule</span><span class="p">:</span>
<span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Example&quot;</span><span class="p">;</span> <span class="n">http</span><span class="o">.</span><span class="n">uri</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;somestring&quot;</span><span class="p">;</span> \
     <span class="n">base64_decode</span><span class="p">:</span><span class="nb">bytes</span> <span class="mi">8</span><span class="p">,</span> <span class="n">offset</span> <span class="mi">1</span><span class="p">,</span> <span class="n">relative</span><span class="p">;</span> \
     <span class="n">base64_data</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;test&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">10001</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>

<span class="n">Buffer</span> <span class="n">content</span><span class="p">:</span>
<span class="n">http_uri</span> <span class="o">=</span> <span class="s2">&quot;GET /en/somestring&amp;dGVzdAo=&amp;not_base64&quot;</span>

<span class="n">Rule</span><span class="p">:</span>
<span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Example&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;somestring&quot;</span><span class="p">;</span> <span class="n">http_uri</span><span class="p">;</span> \
     <span class="n">base64_decode</span><span class="p">:</span><span class="nb">bytes</span> <span class="mi">8</span><span class="p">,</span> <span class="n">offset</span> <span class="mi">1</span><span class="p">,</span> <span class="n">relative</span><span class="p">;</span> \
     <span class="n">base64_data</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;test&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">10001</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-rules/sip-keywords"></span><div class="section" id="sip-keywords">
<h3>SIP Keywords<a class="headerlink" href="#sip-keywords" title="Permalink to this headline">¶</a></h3>
<p>The SIP keywords are implemented as sticky buffers and can be used to match on fields in SIP messages.</p>
<table border="1" class="docutils">
<colgroup>
<col width="63%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Keyword</th>
<th class="head">Direction</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>sip.method</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>sip.uri</td>
<td>Request</td>
</tr>
<tr class="row-even"><td>sip.request_line</td>
<td>Request</td>
</tr>
<tr class="row-odd"><td>sip.stat_code</td>
<td>Response</td>
</tr>
<tr class="row-even"><td>sip.stat_msg</td>
<td>Response</td>
</tr>
<tr class="row-odd"><td>sip.response_line</td>
<td>Response</td>
</tr>
<tr class="row-even"><td>sip.protocol</td>
<td>Both</td>
</tr>
</tbody>
</table>
<div class="section" id="sip-method">
<h4>sip.method<a class="headerlink" href="#sip-method" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches on the method found in a SIP request.</p>
<div class="section" id="syntax">
<h5>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">method</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="o">&lt;</span><span class="n">method</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Examples of methods are:</p>
<ul class="simple">
<li>INVITE</li>
<li>BYE</li>
<li>REGISTER</li>
<li>CANCEL</li>
<li>ACK</li>
<li>OPTIONS</li>
</ul>
</div>
<div class="section" id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">method</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;INVITE&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sip-uri">
<h4>sip.uri<a class="headerlink" href="#sip-uri" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches on the uri found in a SIP request.</p>
<div class="section" id="id1">
<h5>Syntax<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">uri</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="o">&lt;</span><span class="n">uri</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Where &lt;uri&gt; is an uri that follows the SIP URI scheme.</p>
</div>
<div class="section" id="id2">
<h5>Examples<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">uri</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;sip:sip.url.org&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sip-request-line">
<h4>sip.request_line<a class="headerlink" href="#sip-request-line" title="Permalink to this headline">¶</a></h4>
<p>This keyword forces the whole SIP request line to be inspected.</p>
<div class="section" id="id3">
<h5>Syntax<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">request_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="o">&lt;</span><span class="n">request_line</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Where &lt;request_line&gt; is a partial or full line.</p>
</div>
<div class="section" id="id4">
<h5>Examples<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">request_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;REGISTER sip:sip.url.org SIP/2.0&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sip-stat-code">
<h4>sip.stat_code<a class="headerlink" href="#sip-stat-code" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches on the status code found in a SIP response.</p>
<div class="section" id="id5">
<h5>Syntax<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">stat_code</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="o">&lt;</span><span class="n">stat_code</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Where &lt;status_code&gt; belongs to one of the following groups of codes:</p>
<ul class="simple">
<li>1xx - Provisional Responses</li>
<li>2xx - Successful Responses</li>
<li>3xx - Redirection Responses</li>
<li>4xx - Client Failure Responses</li>
<li>5xx - Server Failure Responses</li>
<li>6xx - Global Failure Responses</li>
</ul>
</div>
<div class="section" id="id6">
<h5>Examples<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">stat_code</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;100&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sip-stat-msg">
<h4>sip.stat_msg<a class="headerlink" href="#sip-stat-msg" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches on the status message found in a SIP response.</p>
<div class="section" id="id7">
<h5>Syntax<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">stat_msg</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="o">&lt;</span><span class="n">stat_msg</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Where &lt;stat_msg&gt; is a reason phrase associated to a status code.</p>
</div>
<div class="section" id="id8">
<h5>Examples<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">stat_msg</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Trying&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sip-response-line">
<h4>sip.response_line<a class="headerlink" href="#sip-response-line" title="Permalink to this headline">¶</a></h4>
<p>This keyword forces the whole SIP response line to be inspected.</p>
<div class="section" id="id9">
<h5>Syntax<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">response_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="o">&lt;</span><span class="n">response_line</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Where &lt;response_line&gt; is a partial or full line.</p>
</div>
<div class="section" id="id10">
<h5>Examples<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">response_line</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;SIP/2.0 100 OK&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sip-protocol">
<h4>sip.protocol<a class="headerlink" href="#sip-protocol" title="Permalink to this headline">¶</a></h4>
<p>This keyword matches the protocol field from a SIP request or response line.</p>
<p>If the response line is 'SIP/2.0 100 OK', then this buffer will contain 'SIP/2.0'</p>
<div class="section" id="id11">
<h5>Syntax<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">protocol</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="o">&lt;</span><span class="n">protocol</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Where &lt;protocol&gt; is the SIP protocol version.</p>
</div>
<div class="section" id="example">
<h5>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sip</span><span class="o">.</span><span class="n">protocol</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;SIP/2.0&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-rules/rfb-keywords"></span><div class="section" id="rfb-keywords">
<h3>RFB Keywords<a class="headerlink" href="#rfb-keywords" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">rfb.name</span></code> and <code class="docutils literal notranslate"><span class="pre">rfb.sectype</span></code> keywords can be used for matching on various properties of
RFB (Remote Framebuffer, i.e. VNC) handshakes.</p>
<div class="section" id="rfb-name">
<h4>rfb.name<a class="headerlink" href="#rfb-name" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the RFB desktop name field.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rfb</span><span class="o">.</span><span class="n">name</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Alice&#39;s desktop&quot;</span><span class="p">;</span>
<span class="n">rfb</span><span class="o">.</span><span class="n">name</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/.* \(screen [0-9]\)$/&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">rfb.name</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">rfb.name</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="rfb-secresult">
<h4>rfb.secresult<a class="headerlink" href="#rfb-secresult" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the RFB security result, e.g. <code class="docutils literal notranslate"><span class="pre">ok</span></code>, <code class="docutils literal notranslate"><span class="pre">fail</span></code>, <code class="docutils literal notranslate"><span class="pre">toomany</span></code> or <code class="docutils literal notranslate"><span class="pre">unknown</span></code>.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rfb</span><span class="o">.</span><span class="n">secresult</span><span class="p">:</span> <span class="n">ok</span><span class="p">;</span>
<span class="n">rfb</span><span class="o">.</span><span class="n">secresult</span><span class="p">:</span> <span class="n">unknown</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="rfb-sectype">
<h4>rfb.sectype<a class="headerlink" href="#rfb-sectype" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the RFB security type field, e.g. <code class="docutils literal notranslate"><span class="pre">2</span></code> for VNC challenge-response authentication, <code class="docutils literal notranslate"><span class="pre">0</span></code> for no authentication, and <code class="docutils literal notranslate"><span class="pre">30</span></code> for Apple's custom Remote Desktop authentication.</p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&gt;=</span></code> (greater than or equal)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> (less than or equal)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rfb</span><span class="o">.</span><span class="n">sectype</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span>
<span class="n">rfb</span><span class="o">.</span><span class="n">sectype</span><span class="p">:</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-information">
<h4>Additional information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h4>
<p>More information on the protocol can be found here:
<a class="reference external" href="https://tools.ietf.org/html/rfc6143">https://tools.ietf.org/html/rfc6143</a></p>
</div>
</div>
<span id="document-rules/mqtt-keywords"></span><div class="section" id="mqtt-keywords">
<h3>MQTT Keywords<a class="headerlink" href="#mqtt-keywords" title="Permalink to this headline">¶</a></h3>
<p>Various keywords can be used for matching on fields in fixed and variable headers of MQTT messages as well as payload values.</p>
<div class="section" id="mqtt-protocol-version">
<h4>mqtt.protocol_version<a class="headerlink" href="#mqtt-protocol-version" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the MQTT protocol version field in the fixed header.</p>
<p>The format of the keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">min</span><span class="o">&gt;-&lt;</span><span class="nb">max</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">:[</span><span class="o">&lt;|&gt;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">:</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Examples:</p>
<blockquote>
<div>mqtt.protocol_version:5;</div></blockquote>
</div>
<div class="section" id="mqtt-type">
<h4>mqtt.type<a class="headerlink" href="#mqtt-type" title="Permalink to this headline">¶</a></h4>
<p>Match on the MQTT message type (also: control packet type).
Valid values are :</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">CONNECT</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">CONNACK</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PUBLISH</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PUBACK</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PUBREC</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PUBREL</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PUBCOMP</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">SUBSCRIBE</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">SUBACK</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">UNSUBSCRIBE</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">UNSUBACK</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PINGREQ</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PINGRESP</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">DISCONNECT</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">AUTH</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">UNASSIGNED</span></code></li>
</ul>
<p>where <code class="docutils literal notranslate"><span class="pre">UNASSIGNED</span></code> refers to message type code 0.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">type</span><span class="p">:</span><span class="n">CONNECT</span><span class="p">;</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">type</span><span class="p">:</span><span class="n">PUBLISH</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-flags">
<h4>mqtt.flags<a class="headerlink" href="#mqtt-flags" title="Permalink to this headline">¶</a></h4>
<p>Match on a combination of MQTT header flags, separated by commas (<code class="docutils literal notranslate"><span class="pre">,</span></code>). Flags may be prefixed by <code class="docutils literal notranslate"><span class="pre">!</span></code> to indicate negation, i.e. a flag prefixed by <code class="docutils literal notranslate"><span class="pre">!</span></code> must <cite>not</cite> be set to match.</p>
<p>Valid flags are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">dup</span></code> (duplicate message)</li>
<li><code class="docutils literal notranslate"><span class="pre">retain</span></code> (message should be retained on the broker)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mqtt.flags:dup,!retain;
mqtt.flags:retain;
</pre></div>
</div>
</div>
<div class="section" id="mqtt-qos">
<h4>mqtt.qos<a class="headerlink" href="#mqtt-qos" title="Permalink to this headline">¶</a></h4>
<p>Match on the Quality of Service request code in the MQTT fixed header.
Valid values are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">0</span></code> (fire and forget)</li>
<li><code class="docutils literal notranslate"><span class="pre">1</span></code> (at least one delivery)</li>
<li><code class="docutils literal notranslate"><span class="pre">2</span></code> (exactly one delivery)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">qos</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">qos</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-reason-code">
<h4>mqtt.reason_code<a class="headerlink" href="#mqtt-reason-code" title="Permalink to this headline">¶</a></h4>
<p>Match on the numeric value of the reason code that is used in MQTT 5.0 for some message types. Please refer to the specification for the meaning of these values, which are often specific to the message type in question.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># match on attempts to unsubscribe from a non-subscribed topic</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">type</span><span class="p">:</span><span class="n">UNSUBACK</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">reason_code</span><span class="p">:</span><span class="mi">17</span><span class="p">;</span>

<span class="c1"># match on publications that were accepted but there were no subscribers</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">type</span><span class="p">:</span><span class="n">PUBACK</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">reason_code</span><span class="p">:</span><span class="mi">16</span><span class="p">;</span>

<span class="c1"># match on connection attempts by banned clients</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">CONNACK</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">reason_code</span><span class="p">:</span><span class="mi">138</span><span class="p">;</span>

<span class="c1"># match on failed connection attempts due to bad credentials</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">CONNACK</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">reason_code</span><span class="p">:</span><span class="mi">134</span><span class="p">;</span>

<span class="c1"># match on connections terminated by server shutdowns</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">DISCONNECT</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">reason_code</span><span class="p">:</span><span class="mi">139</span><span class="p">;</span>
</pre></div>
</div>
<p>This keyword is also available under the alias <code class="docutils literal notranslate"><span class="pre">mqtt.connack.return_code</span></code> for completeness.</p>
</div>
<div class="section" id="mqtt-connack-session-present">
<h4>mqtt.connack.session_present<a class="headerlink" href="#mqtt-connack-session-present" title="Permalink to this headline">¶</a></h4>
<p>Match on the MQTT CONNACK <code class="docutils literal notranslate"><span class="pre">session_present</span></code> flag. Values can be <code class="docutils literal notranslate"><span class="pre">yes</span></code>, <code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">no</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">CONNACK</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">connack</span><span class="o">.</span><span class="n">session_present</span><span class="p">:</span><span class="n">true</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-connect-clientid">
<h4>mqtt.connect.clientid<a class="headerlink" href="#mqtt-connect-clientid" title="Permalink to this headline">¶</a></h4>
<p>Match on the self-assigned client ID in the MQTT CONNECT message.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">clientid</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/^mosq.*/&quot;</span><span class="p">;</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">clientid</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;myclient&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.connect.clientid</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="mqtt-connect-flags">
<h4>mqtt.connect.flags<a class="headerlink" href="#mqtt-connect-flags" title="Permalink to this headline">¶</a></h4>
<p>Match on a combination of MQTT CONNECT flags, separated by commas (<code class="docutils literal notranslate"><span class="pre">,</span></code>). Flags may be prefixed by <code class="docutils literal notranslate"><span class="pre">!</span></code> to indicate negation, i.e. a flag prefixed by <code class="docutils literal notranslate"><span class="pre">!</span></code> must <cite>not</cite> be set to match.</p>
<p>Valid flags are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">username</span></code> (message contains a username)</li>
<li><code class="docutils literal notranslate"><span class="pre">password</span></code> (message contains a password)</li>
<li><code class="docutils literal notranslate"><span class="pre">will</span></code> (message contains a will definition)</li>
<li><code class="docutils literal notranslate"><span class="pre">will_retain</span></code> (will should be retained on broker)</li>
<li><code class="docutils literal notranslate"><span class="pre">clean_session</span></code> (start with a clean session)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mqtt.connect.flags:username,password,!will;
mqtt.connect.flags:username,!password;
mqtt.connect.flags:clean_session;
</pre></div>
</div>
</div>
<div class="section" id="mqtt-connect-password">
<h4>mqtt.connect.password<a class="headerlink" href="#mqtt-connect-password" title="Permalink to this headline">¶</a></h4>
<p>Match on the password credential in the MQTT CONNECT message.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">password</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/^123[0-9]*/&quot;</span><span class="p">;</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">password</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;swordfish&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.connect.password</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="mqtt-connect-username">
<h4>mqtt.connect.username<a class="headerlink" href="#mqtt-connect-username" title="Permalink to this headline">¶</a></h4>
<p>Match on the username credential in the MQTT CONNECT message.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">username</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;benson&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.connect.username</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="mqtt-connect-willmessage">
<h4>mqtt.connect.willmessage<a class="headerlink" href="#mqtt-connect-willmessage" title="Permalink to this headline">¶</a></h4>
<p>Match on the will message in the MQTT CONNECT message, if a will is defined.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">willmessage</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/^fooba[rz]/&quot;</span><span class="p">;</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">willmessage</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;hunter2&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.connect.willmessage</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="mqtt-connect-willtopic">
<h4>mqtt.connect.willtopic<a class="headerlink" href="#mqtt-connect-willtopic" title="Permalink to this headline">¶</a></h4>
<p>Match on the will topic in the MQTT CONNECT message, if a will is defined.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">willtopic</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/^hunter[0-9]/&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.connect.willtopic</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="mqtt-publish-message">
<h4>mqtt.publish.message<a class="headerlink" href="#mqtt-publish-message" title="Permalink to this headline">¶</a></h4>
<p>Match on the payload to be published in the MQTT PUBLISH message.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">type</span><span class="p">:</span><span class="n">PUBLISH</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">publish</span><span class="o">.</span><span class="n">message</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/uid=[0-9]+/&quot;</span><span class="p">;</span>
<span class="c1"># match on published JPEG images</span>
<span class="n">mqtt</span><span class="o">.</span><span class="n">type</span><span class="p">:</span><span class="n">PUBLISH</span><span class="p">;</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">publish</span><span class="o">.</span><span class="n">message</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|FF D8 FF E0|&quot;</span><span class="p">;</span> <span class="n">startswith</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.publish.message</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="mqtt-publish-topic">
<h4>mqtt.publish.topic<a class="headerlink" href="#mqtt-publish-topic" title="Permalink to this headline">¶</a></h4>
<p>Match on the topic to be published to in the MQTT PUBLISH message.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">publish</span><span class="o">.</span><span class="n">topic</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;mytopic&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.publish.topic</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="mqtt-subscribe-topic">
<h4>mqtt.subscribe.topic<a class="headerlink" href="#mqtt-subscribe-topic" title="Permalink to this headline">¶</a></h4>
<p>Match on any of the topics subscribed to in a MQTT SUBSCRIBE message.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">subscribe</span><span class="o">.</span><span class="n">topic</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;mytopic&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.subscribe.topic</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.subscribe.topic</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="mqtt-unsubscribe-topic">
<h4>mqtt.unsubscribe.topic<a class="headerlink" href="#mqtt-unsubscribe-topic" title="Permalink to this headline">¶</a></h4>
<p>Match on any of the topics unsubscribed from in a MQTT UNSUBSCRIBE message.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="o">.</span><span class="n">unsubscribe</span><span class="o">.</span><span class="n">topic</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;mytopic&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.unsubscribe.topic</span></code> is a 'sticky buffer' and can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">mqtt.unsubscribe.topic</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="additional-information">
<h4>Additional information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h4>
<p>More information on the protocol can be found here:</p>
<ul class="simple">
<li>MQTT 3.1: <a class="reference external" href="https://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html">https://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html</a></li>
<li>MQTT 3.1.1: <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html">https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html</a></li>
<li>MQTT 5.0: <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html">https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html</a></li>
</ul>
</div>
</div>
<span id="document-rules/ike-keywords"></span><div class="section" id="ike-keywords">
<h3>IKE Keywords<a class="headerlink" href="#ike-keywords" title="Permalink to this headline">¶</a></h3>
<p>The keywords</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">ike.init_spi</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.resp_spi</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.chosen_sa_attribute</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.exchtype</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.vendor</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.key_exchange_payload</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.key_exchange_payload_length</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.nonce_payload</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.nonce_payload_length</span></code></li>
</ul>
<p>can be used for matching on various properties of IKE connections.</p>
<div class="section" id="ike-init-spi-ike-resp-spi">
<h4>ike.init_spi, ike.resp_spi<a class="headerlink" href="#ike-init-spi-ike-resp-spi" title="Permalink to this headline">¶</a></h4>
<p>Match on an exact value of the Security Parameter Index (SPI) for the Initiator or Responder.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">init_spi</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;18fe9b731f9f8034&quot;</span><span class="p">;</span>
<span class="n">ike</span><span class="o">.</span><span class="n">resp_spi</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;a00b8ef0902bb8ec&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ike.init_spi</span></code> and <code class="docutils literal notranslate"><span class="pre">ike.resp_spi</span></code> are 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ike.init_spi</span></code> and <code class="docutils literal notranslate"><span class="pre">ike.resp_spi</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="ike-chosen-sa-attribute">
<h4>ike.chosen_sa_attribute<a class="headerlink" href="#ike-chosen-sa-attribute" title="Permalink to this headline">¶</a></h4>
<p>Match on an attribute value of the chosen Security Association (SA) by the Responder. Supported for IKEv1 are:
<code class="docutils literal notranslate"><span class="pre">alg_enc</span></code>,
<code class="docutils literal notranslate"><span class="pre">alg_hash</span></code>,
<code class="docutils literal notranslate"><span class="pre">alg_auth</span></code>,
<code class="docutils literal notranslate"><span class="pre">alg_dh</span></code>,
<code class="docutils literal notranslate"><span class="pre">alg_prf</span></code>,
<code class="docutils literal notranslate"><span class="pre">sa_group_type</span></code>,
<code class="docutils literal notranslate"><span class="pre">sa_life_type</span></code>,
<code class="docutils literal notranslate"><span class="pre">sa_life_duration</span></code>,
<code class="docutils literal notranslate"><span class="pre">sa_key_length</span></code> and
<code class="docutils literal notranslate"><span class="pre">sa_field_size</span></code>.
IKEv2 supports <code class="docutils literal notranslate"><span class="pre">alg_enc</span></code>, <code class="docutils literal notranslate"><span class="pre">alg_auth</span></code>, <code class="docutils literal notranslate"><span class="pre">alg_prf</span></code> and <code class="docutils literal notranslate"><span class="pre">alg_dh</span></code>.</p>
<p>If there is more than one chosen SA the event <code class="docutils literal notranslate"><span class="pre">MultipleServerProposal</span></code> is set. The attributes of the first SA are used for this keyword.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">chosen_sa_attribute</span><span class="p">:</span><span class="n">alg_hash</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="n">ike</span><span class="o">.</span><span class="n">chosen_sa_attribute</span><span class="p">:</span><span class="n">sa_key_length</span><span class="o">=</span><span class="mi">128</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="ike-exchtype">
<h4>ike.exchtype<a class="headerlink" href="#ike-exchtype" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the Exchange Type.</p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&gt;=</span></code> (greater than or equal)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> (less than or equal)</li>
<li><code class="docutils literal notranslate"><span class="pre">arg1-arg2</span></code> (range)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">exchtype</span><span class="p">:</span><span class="mi">5</span><span class="p">;</span>
<span class="n">ike</span><span class="o">.</span><span class="n">exchtype</span><span class="p">:</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="ike-vendor">
<h4>ike.vendor<a class="headerlink" href="#ike-vendor" title="Permalink to this headline">¶</a></h4>
<p>Match a vendor ID against the list of collected vendor IDs.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">vendor</span><span class="p">:</span><span class="mi">4</span><span class="n">a131c81070358455c5728f20e95452f</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ike.vendor</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="ike-key-exchange-payload">
<h4>ike.key_exchange_payload<a class="headerlink" href="#ike-key-exchange-payload" title="Permalink to this headline">¶</a></h4>
<p>Match against the public key exchange payload (e.g. Diffie-Hellman) of the server or client.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">key_exchange_payload</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|6d026d5616c45be05e5b898411e9|&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ike.key_exchange_payload</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ike.key_exchange_payload</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="ike-key-exchange-payload-length">
<h4>ike.key_exchange_payload_length<a class="headerlink" href="#ike-key-exchange-payload-length" title="Permalink to this headline">¶</a></h4>
<p>Match against the length of the public key exchange payload (e.g. Diffie-Hellman) of the server or client.</p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&gt;=</span></code> (greater than or equal)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> (less than or equal)</li>
<li><code class="docutils literal notranslate"><span class="pre">arg1-arg2</span></code> (range)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">key_exchange_payload_length</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">132</span>
</pre></div>
</div>
</div>
<div class="section" id="ike-nonce-payload">
<h4>ike.nonce_payload<a class="headerlink" href="#ike-nonce-payload" title="Permalink to this headline">¶</a></h4>
<p>Match against the nonce of the server or client.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">nonce_payload</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|6d026d5616c45be05e5b898411e9|&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ike.nonce_payload</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">ike.nonce_payload</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
</div>
<div class="section" id="ike-nonce-payload-length">
<h4>ike.nonce_payload_length<a class="headerlink" href="#ike-nonce-payload-length" title="Permalink to this headline">¶</a></h4>
<p>Match against the length of the nonce of the server or client.</p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&gt;=</span></code> (greater than or equal)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> (less than or equal)</li>
<li><code class="docutils literal notranslate"><span class="pre">arg1-arg2</span></code> (range)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ike</span><span class="o">.</span><span class="n">nonce_payload_length</span><span class="p">:</span><span class="mi">132</span>
<span class="n">ike</span><span class="o">.</span><span class="n">nonce_payload_length</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">132</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-information">
<h4>Additional information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h4>
<p>More information on the protocol and the data contained in it can be found here:
<a class="reference external" href="https://tools.ietf.org/html/rfc2409">https://tools.ietf.org/html/rfc2409</a></p>
</div>
</div>
<span id="document-rules/http2-keywords"></span><div class="section" id="http2-keywords">
<h3>HTTP2 Keywords<a class="headerlink" href="#http2-keywords" title="Permalink to this headline">¶</a></h3>
<p>HTTP2 frames are grouped into transactions based on the stream identifier it it is not 0.
For frames with stream identifier 0, whose effects are global for the connection, a transaction is created for each frame.</p>
<div class="section" id="http2-frametype">
<h4>http2.frametype<a class="headerlink" href="#http2-frametype" title="Permalink to this headline">¶</a></h4>
<p>Match on the frame type present in a transaction.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http2</span><span class="o">.</span><span class="n">frametype</span><span class="p">:</span><span class="n">GOAWAY</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="http2-errorcode">
<h4>http2.errorcode<a class="headerlink" href="#http2-errorcode" title="Permalink to this headline">¶</a></h4>
<p>Match on the error code in a GOWAY or RST_STREAM frame</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http2</span><span class="o">.</span><span class="n">errorcode</span><span class="p">:</span> <span class="n">NO_ERROR</span><span class="p">;</span>
<span class="n">http2</span><span class="o">.</span><span class="n">errorcode</span><span class="p">:</span> <span class="n">INADEQUATE_SECURITY</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="http2-priority">
<h4>http2.priority<a class="headerlink" href="#http2-priority" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the HTTP2 priority field present in a PRIORITY or HEADERS frame.</p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">x-y</span></code> (range between values x and y)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http2</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span>
<span class="n">http2</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">;</span>
<span class="n">http2</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span><span class="mi">32</span><span class="o">-</span><span class="mi">64</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="http2-window">
<h4>http2.window<a class="headerlink" href="#http2-window" title="Permalink to this headline">¶</a></h4>
<p>Match on the value of the HTTP2 value field present in a WINDOWUPDATE frame.</p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">x-y</span></code> (range between values x and y)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http2</span><span class="o">.</span><span class="n">window</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<span class="n">http2</span><span class="o">.</span><span class="n">window</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">100000</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="http2-size-update">
<h4>http2.size_update<a class="headerlink" href="#http2-size-update" title="Permalink to this headline">¶</a></h4>
<p>Match on the size of the HTTP2 Dynamic Headers Table.
More information on the protocol can be found here:
<a class="reference external" href="https://tools.ietf.org/html/rfc7541#section-6.3">https://tools.ietf.org/html/rfc7541#section-6.3</a></p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">x-y</span></code> (range between values x and y)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http2</span><span class="o">.</span><span class="n">size_update</span><span class="p">:</span><span class="mi">1234</span><span class="p">;</span>
<span class="n">http2</span><span class="o">.</span><span class="n">size_update</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">4096</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="http2-settings">
<h4>http2.settings<a class="headerlink" href="#http2-settings" title="Permalink to this headline">¶</a></h4>
<p>Match on the name and value of a HTTP2 setting from a SETTINGS frame.</p>
<p>This keyword takes a numeric argument after a colon and supports additional qualifiers, such as:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> (greater than)</li>
<li><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> (less than)</li>
<li><code class="docutils literal notranslate"><span class="pre">x-y</span></code> (range between values x and y)</li>
</ul>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http2</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span><span class="n">SETTINGS_ENABLE_PUSH</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">http2</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span><span class="n">SETTINGS_HEADER_TABLE_SIZE</span><span class="o">&gt;</span><span class="mi">4096</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="http2-header-name">
<h4>http2.header_name<a class="headerlink" href="#http2-header-name" title="Permalink to this headline">¶</a></h4>
<p>Match on the name of a HTTP2 header from a HEADER frame (or PUSH_PROMISE or CONTINUATION).</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http2</span><span class="o">.</span><span class="n">header_name</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;agent&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">http2.header_name</span></code> is a 'sticky buffer'.</p>
<p><code class="docutils literal notranslate"><span class="pre">http2.header_name</span></code> can be used as <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">http2.header_name</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="additional-information">
<h4>Additional information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h4>
<p>More information on the protocol can be found here:
<a class="reference external" href="https://tools.ietf.org/html/rfc7540">https://tools.ietf.org/html/rfc7540</a></p>
</div>
</div>
<span id="document-rules/quic-keywords"></span><div class="section" id="quic-keywords">
<h3>Quic Keywords<a class="headerlink" href="#quic-keywords" title="Permalink to this headline">¶</a></h3>
<p>Suricata implements initial support for Quic by parsing the Quic version.</p>
<p>Suricata also derives a CYU hash for earlier versions of Quic.</p>
<p>Quic app-layer parsing must be enabled in the Suricata config file (set 'app-layer.protocols.quic.enabled' to 'yes').</p>
<div class="section" id="quic-cyu-hash">
<h4>quic.cyu.hash<a class="headerlink" href="#quic-cyu-hash" title="Permalink to this headline">¶</a></h4>
<p>Match on the CYU hash</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">quic</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;QUIC CYU HASH&quot;</span><span class="p">;</span> \
  <span class="n">quic</span><span class="o">.</span><span class="n">cyu</span><span class="o">.</span><span class="n">hash</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;7b3ceb1adc974ad360cfa634e8d0a730&quot;</span><span class="p">;</span> \
  <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">quic.cyu.hash</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="quic-cyu-string">
<h4>quic.cyu.string<a class="headerlink" href="#quic-cyu-string" title="Permalink to this headline">¶</a></h4>
<p>Match on the CYU string</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">quic</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;QUIC CYU STRING&quot;</span><span class="p">;</span> \
  <span class="n">quic</span><span class="o">.</span><span class="n">cyu</span><span class="o">.</span><span class="n">string</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;46,PAD-SNI-VER-CCS-UAID-TCID-PDMD-SMHL-ICSL-NONP-MIDS-SCLS-CSCT-COPT-IRTT-CFCW-SFCW&quot;</span><span class="p">;</span> \
  <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">quic.cyu.string</span></code> supports multiple buffer matching, see <a class="reference internal" href="index.html#document-rules/multi-buffer-matching"><span class="doc">Multiple Buffer Matching</span></a>.</p>
</div>
<div class="section" id="quic-version">
<h4>quic.version<a class="headerlink" href="#quic-version" title="Permalink to this headline">¶</a></h4>
<p>Sticky buffer for matching on the Quic header version in long headers.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">quic</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;QUIC VERSION&quot;</span><span class="p">;</span> \
  <span class="n">quic</span><span class="o">.</span><span class="n">version</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;Q046&quot;</span><span class="p">;</span> \
  <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-information">
<h4>Additional information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h4>
<p>More information on CYU Hash can be found here:
<a class="reference external" href="https://engineering.salesforce.com/gquic-protocol-analysis-and-fingerprinting-in-zeek-a4178855d75f">https://engineering.salesforce.com/gquic-protocol-analysis-and-fingerprinting-in-zeek-a4178855d75f</a></p>
<p>More information on the protocol can be found here:
<a class="reference external" href="https://datatracker.ietf.org/doc/html/draft-ietf-quic-transport-17">https://datatracker.ietf.org/doc/html/draft-ietf-quic-transport-17</a></p>
</div>
</div>
<span id="document-rules/app-layer"></span><div class="section" id="generic-app-layer-keywords">
<h3>Generic App Layer Keywords<a class="headerlink" href="#generic-app-layer-keywords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="app-layer-protocol">
<h4>app-layer-protocol<a class="headerlink" href="#app-layer-protocol" title="Permalink to this headline">¶</a></h4>
<p>Match on the detected app-layer protocol.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>app-layer-protocol:[!]&lt;protocol&gt;;
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>app-layer-protocol:ssh;
app-layer-protocol:!tls;
app-layer-protocol:failed;
</pre></div>
</div>
<p>A special value 'failed' can be used for matching on flows in which
protocol detection failed. This can happen if Suricata doesn't know
the protocol or when certain 'bail out' conditions happen.</p>
<div class="section" id="bail-out-conditions">
<span id="proto-detect-bail-out"></span><h5>Bail out conditions<a class="headerlink" href="#bail-out-conditions" title="Permalink to this headline">¶</a></h5>
<p>Protocol detection gives up in several cases:</p>
<ul class="simple">
<li>both sides are inspected and no match was found</li>
<li>side A detection failed, side B has no traffic at all (e.g. FTP data channel)</li>
<li>side A detection failed, side B has so little data detection is inconclusive</li>
</ul>
<p>In these last 2 cases the <code class="docutils literal notranslate"><span class="pre">app-layer-event:applayer_proto_detection_skipped</span></code>
is set.</p>
</div>
</div>
<div class="section" id="app-layer-event">
<h4>app-layer-event<a class="headerlink" href="#app-layer-event" title="Permalink to this headline">¶</a></h4>
<p>Match on events generated by the App Layer Parsers and the protocol detection
engine.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="o">-</span><span class="n">event</span><span class="p">:</span><span class="o">&lt;</span><span class="n">event</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="o">-</span><span class="n">event</span><span class="p">:</span><span class="n">applayer_mismatch_protocol_both_directions</span><span class="p">;</span>
<span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="o">-</span><span class="n">event</span><span class="p">:</span><span class="n">http</span><span class="o">.</span><span class="n">gzip_decompression_failed</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="protocol-detection">
<h5>Protocol Detection<a class="headerlink" href="#protocol-detection" title="Permalink to this headline">¶</a></h5>
<div class="section" id="applayer-mismatch-protocol-both-directions">
<h6>applayer_mismatch_protocol_both_directions<a class="headerlink" href="#applayer-mismatch-protocol-both-directions" title="Permalink to this headline">¶</a></h6>
<p>The toserver and toclient directions have different protocols. For example a
client talking HTTP to a SSH server.</p>
</div>
<div class="section" id="applayer-wrong-direction-first-data">
<h6>applayer_wrong_direction_first_data<a class="headerlink" href="#applayer-wrong-direction-first-data" title="Permalink to this headline">¶</a></h6>
<p>Some protocol implementations in Suricata have a requirement with regards to
the first data direction. The HTTP parser is an example of this.</p>
<p><a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/993">https://redmine.openinfosecfoundation.org/issues/993</a></p>
</div>
<div class="section" id="applayer-detect-protocol-only-one-direction">
<h6>applayer_detect_protocol_only_one_direction<a class="headerlink" href="#applayer-detect-protocol-only-one-direction" title="Permalink to this headline">¶</a></h6>
<p>Protocol detection only succeeded in one direction. For FTP and SMTP this is
expected.</p>
</div>
<div class="section" id="applayer-proto-detection-skipped">
<h6>applayer_proto_detection_skipped<a class="headerlink" href="#applayer-proto-detection-skipped" title="Permalink to this headline">¶</a></h6>
<p>Protocol detection was skipped because of <a class="reference internal" href="#proto-detect-bail-out"><span class="std std-ref">Bail out conditions</span></a>.</p>
</div>
</div>
</div>
</div>
<span id="document-rules/xbits"></span><div class="section" id="xbits-keyword">
<h3>Xbits Keyword<a class="headerlink" href="#xbits-keyword" title="Permalink to this headline">¶</a></h3>
<p>Set, unset, toggle and check for bits stored per host or ip_pair.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xbits</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">set</span><span class="o">|</span><span class="n">unset</span><span class="o">|</span><span class="n">isset</span><span class="o">|</span><span class="n">isnotset</span><span class="o">|</span><span class="n">toggle</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="n">track</span> <span class="o">&lt;</span><span class="n">ip_src</span><span class="o">|</span><span class="n">ip_dst</span><span class="o">|</span><span class="n">ip_pair</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">xbits</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">set</span><span class="o">|</span><span class="n">unset</span><span class="o">|</span><span class="n">isset</span><span class="o">|</span><span class="n">toggle</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="n">track</span> <span class="o">&lt;</span><span class="n">ip_src</span><span class="o">|</span><span class="n">ip_dst</span><span class="o">|</span><span class="n">ip_pair</span><span class="o">&gt;</span> \
    <span class="p">[,</span><span class="n">expire</span> <span class="o">&lt;</span><span class="n">seconds</span><span class="o">&gt;</span><span class="p">];</span>
<span class="n">xbits</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">set</span><span class="o">|</span><span class="n">unset</span><span class="o">|</span><span class="n">isset</span><span class="o">|</span><span class="n">toggle</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="n">track</span> <span class="o">&lt;</span><span class="n">ip_src</span><span class="o">|</span><span class="n">ip_dst</span><span class="o">|</span><span class="n">ip_pair</span><span class="o">&gt;</span> \
    <span class="p">[,</span><span class="n">expire</span> <span class="o">&lt;</span><span class="n">seconds</span><span class="o">&gt;</span><span class="p">];</span>
</pre></div>
</div>
<div class="section" id="notes">
<h4>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>No difference between using <code class="docutils literal notranslate"><span class="pre">hostbits</span></code> and <code class="docutils literal notranslate"><span class="pre">xbits</span></code>
with <code class="docutils literal notranslate"><span class="pre">track</span> <span class="pre">ip_&lt;src|dst&gt;</span></code></li>
<li>If you <code class="docutils literal notranslate"><span class="pre">set</span></code> on a client request and use
<code class="docutils literal notranslate"><span class="pre">track</span> <span class="pre">ip_dst</span></code>, if you want to match on the server response,
you check it (<code class="docutils literal notranslate"><span class="pre">isset</span></code>) with <code class="docutils literal notranslate"><span class="pre">track</span> <span class="pre">ip_src</span></code>.</li>
<li>To not alert, use <code class="docutils literal notranslate"><span class="pre">noalert;</span></code></li>
<li>the <code class="docutils literal notranslate"><span class="pre">toggle</span></code> option will flip the value of the xbits.</li>
<li>See also:<ul>
<li><a class="reference external" href="https://blog.inliniac.net/2014/12/21/crossing-the-streams-in-suricata/">https://blog.inliniac.net/2014/12/21/crossing-the-streams-in-suricata/</a></li>
<li><a class="reference external" href="http://www.cipherdyne.org/blog/2013/07/crossing-the-streams-in-ids-signature-languages.html">http://www.cipherdyne.org/blog/2013/07/crossing-the-streams-in-ids-signature-languages.html</a></li>
</ul>
</li>
</ul>
<div class="section" id="yaml-settings">
<h5>YAML settings<a class="headerlink" href="#yaml-settings" title="Permalink to this headline">¶</a></h5>
<p>Bits that are stored per host are stored in the Host table. This means that
host table settings affect hostsbits and xbits per host.</p>
<p>Bits that are stored per IP pair are stored in the IPPair table. This means
that ippair table settings, especially memcap, affect xbits per ip_pair.</p>
</div>
<div class="section" id="threading">
<h5>Threading<a class="headerlink" href="#threading" title="Permalink to this headline">¶</a></h5>
<p>Due to subtle timing issues between threads the order of sets and checks
can be slightly unpredictable.</p>
</div>
<div class="section" id="unix-socket">
<h5>Unix Socket<a class="headerlink" href="#unix-socket" title="Permalink to this headline">¶</a></h5>
<p>Hostbits can be added, removed and listed through the unix socket.</p>
<p>Add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;add-hostbit &lt;ip&gt; &lt;bit name&gt; &lt;expire in seconds&gt;&quot;</span>
<span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;add-hostbit 1.2.3.4 blacklist 3600&quot;</span>
</pre></div>
</div>
<p>If a hostbit is added for an existing hostbit, it's expiry timer is updated.</p>
<p>Remove:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;remove-hostbit &lt;ip&gt; &lt;bit name&gt;&quot;</span>
<span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;remove-hostbit 1.2.3.4 blacklist&quot;</span>
</pre></div>
</div>
<p>List:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;list-hostbit &lt;ip&gt;&quot;</span>
<span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;list-hostbit 1.2.3.4&quot;</span>
</pre></div>
</div>
<p>This results in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;message&quot;</span><span class="p">:</span>
    <span class="p">{</span>
       <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
       <span class="s2">&quot;hostbits&quot;</span><span class="p">:</span>
            <span class="p">[{</span>
                <span class="s2">&quot;expire&quot;</span><span class="p">:</span> <span class="mi">89</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;blacklist&quot;</span>
            <span class="p">}]</span>
    <span class="p">},</span>
    <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h5>
<div class="section" id="creating-a-ssh-blacklist">
<h6>Creating a SSH blacklist<a class="headerlink" href="#creating-a-ssh-blacklist" title="Permalink to this headline">¶</a></h6>
<p>Below is an example of rules incoming to a SSH server.</p>
<p>The first 2 rules match on a SSH software version often used in bots.
They drop the traffic and create an 'xbit' 'badssh' for the source ip.
It expires in an hour:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>drop ssh any any -&gt; $MYSERVER 22 (msg:&quot;DROP libssh incoming&quot;;   \
  flow:to_server,established; ssh.softwareversion:&quot;libssh&quot;;     \
  xbits:set, badssh, track ip_src, expire 3600; sid:4000000005;)
drop ssh any any -&gt; $MYSERVER 22 (msg:&quot;DROP PUTTY incoming&quot;;    \
  flow:to_server,established; ssh.softwareversion:&quot;PUTTY&quot;;      \
  xbits:set, badssh, track ip_src, expire 3600; sid:4000000007;)
</pre></div>
</div>
<p>Then the following rule simply drops any incoming traffic to that server
that is on that 'badssh' list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>drop ssh any any -&gt; $MYSERVER 22 (msg:&quot;DROP BLACKLISTED&quot;;       \
  xbits:isset, badssh, track ip_src; sid:4000000006;)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-rules/thresholding"></span><div class="section" id="thresholding-keywords">
<h3>Thresholding Keywords<a class="headerlink" href="#thresholding-keywords" title="Permalink to this headline">¶</a></h3>
<p>Thresholding can be configured per rule and also globally, see
<a class="reference internal" href="index.html#document-configuration/global-thresholds"><span class="doc">Global-Thresholds</span></a>.</p>
<p><em>Note: mixing rule and global thresholds is not supported in 1.3 and
before. See bug #425.</em> For the state of the support in 1.4 see
<a class="reference internal" href="index.html#global-thresholds-vs-rule-thresholds"><span class="std std-ref">Global thresholds vs rule thresholds</span></a></p>
<div class="section" id="threshold">
<h4>threshold<a class="headerlink" href="#threshold" title="Permalink to this headline">¶</a></h4>
<p>The threshold keyword can be used to control the rule's alert
frequency. It has 3 modes: threshold, limit and both.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">threshold</span><span class="p">:</span> <span class="nb">type</span> <span class="o">&lt;</span><span class="n">threshold</span><span class="o">|</span><span class="n">limit</span><span class="o">|</span><span class="n">both</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">track</span> <span class="o">&lt;</span><span class="n">by_src</span><span class="o">|</span><span class="n">by_dst</span><span class="o">|</span><span class="n">by_rule</span><span class="o">|</span><span class="n">by_both</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">count</span> <span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="section" id="type-threshold">
<h5>type &quot;threshold&quot;<a class="headerlink" href="#type-threshold" title="Permalink to this headline">¶</a></h5>
<p>This type can be used to set a minimum threshold for a rule before it
generates alerts. A threshold setting of N means on the Nth time the
rule matches an alert is generated.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp !$HOME_NET any -&gt; $HOME_NET 25 (msg:&quot;ET POLICY Inbound Frequent Emails - Possible Spambot Inbound&quot;; \
flow:established; content:&quot;mail from|3a|&quot;; nocase;                                                       \
threshold: type threshold, track by_src, count 10, seconds 60;                                           \
reference:url,doc.emergingthreats.net/2002087; classtype:misc-activity; sid:2002087; rev:10;)
</pre></div>
</div>
<p>This signature only generates an alert if we get 10 inbound emails or
more from the same server in a time period of one minute.</p>
<p>If a signature sets a flowbit, flowint, etc. those actions are still
performed for each of the matches.</p>
<blockquote>
<div><em>Rule actions drop (IPS mode) and reject are applied to each packet
(not only the one that meets the threshold condition).</em></div></blockquote>
</div>
<div class="section" id="type-limit">
<h5>type &quot;limit&quot;<a class="headerlink" href="#type-limit" title="Permalink to this headline">¶</a></h5>
<p>This type can be used to make sure you're not getting flooded with
alerts. If set to limit N, it alerts at most N times.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert http $HOME_NET any -&gt; any $HTTP_PORTS (msg:&quot;ET USER_AGENTS Internet Explorer 6 in use - Significant Security Risk&quot;; \
flow:to_server,established; content:&quot;|0d 0a|User-Agent|3a| Mozilla/4.0 (compatible|3b| MSIE 6.0|3b|&quot;;                \
threshold: type limit, track by_src, seconds 180, count 1;                                                           \
reference:url,doc.emergingthreats.net/2010706; classtype:policy-violation; sid:2010706; rev:7;)
</pre></div>
</div>
<p>In this example at most 1 alert is generated per host within a period
of 3 minutes if MSIE 6.0 is detected.</p>
<p>If a signature sets a flowbit, flowint, etc. those actions are still
performed for each of the matches.</p>
<blockquote>
<div><em>Rule actions drop (IPS mode) and reject are applied to each packet
(not only the one that meets the limit condition).</em></div></blockquote>
</div>
<div class="section" id="type-both">
<h5>type &quot;both&quot;<a class="headerlink" href="#type-both" title="Permalink to this headline">¶</a></h5>
<p>This type is a combination of the &quot;threshold&quot; and &quot;limit&quot; types. It
applies both thresholding and limiting.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp $HOME_NET 5060 -&gt; $EXTERNAL_NET any (msg:&quot;ET VOIP Multiple Unauthorized SIP Responses TCP&quot;; \
flow:established,from_server; content:&quot;SIP/2.0 401 Unauthorized&quot;; depth:24;                      \
threshold: type both, track by_src, count 5, seconds 360;                                        \
reference:url,doc.emergingthreats.net/2003194; classtype:attempted-dos; sid:2003194; rev:6;)
</pre></div>
</div>
<p>This alert will only generate an alert if within 6 minutes there have
been 5 or more &quot;SIP/2.0 401 Unauthorized&quot; responses, and it will alert
only once in that 6 minutes.</p>
<p>If a signature sets a flowbit, flowint, etc. those actions are still
performed for each of the matches.</p>
<blockquote>
<div><em>Rule actions drop (IPS mode) and reject are applied to each packet.</em></div></blockquote>
</div>
</div>
<div class="section" id="detection-filter">
<h4>detection_filter<a class="headerlink" href="#detection-filter" title="Permalink to this headline">¶</a></h4>
<p>The detection_filter keyword can be used to alert on every match after
a threshold has been reached. It differs from the threshold with type
threshold in that it generates an alert for each rule match after the
initial threshold has been reached, where the latter will reset it's
internal counter and alert again when the threshold has been reached
again.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detection_filter</span><span class="p">:</span> <span class="n">track</span> <span class="o">&lt;</span><span class="n">by_src</span><span class="o">|</span><span class="n">by_dst</span><span class="o">|</span><span class="n">by_rule</span><span class="o">|</span><span class="n">by_both</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">count</span> <span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert http $EXTERNAL_NET any -&gt; $HOME_NET any \
     (msg:&quot;ET WEB_SERVER WebResource.axd access without t (time) parameter - possible ASP padding-oracle exploit&quot;; \
     flow:established,to_server; content:&quot;GET&quot;; http_method; content:&quot;WebResource.axd&quot;; http_uri; nocase;          \
     content:!&quot;&amp;t=&quot;; http_uri; nocase; content:!&quot;&amp;amp|3b|t=&quot;; http_uri; nocase;                                    \
     detection_filter:track by_src,count 15,seconds 2;                                                             \
     reference:url,netifera.com/research/; reference:url,www.microsoft.com/technet/security/advisory/2416728.mspx; \
     classtype:web-application-attack; sid:2011807; rev:5;)
</pre></div>
</div>
<p>Alerts each time after 15 or more matches have occurred within 2 seconds.</p>
<p>If a signature sets a flowbit, flowint, etc. those actions are still
performed for each of the matches.</p>
<blockquote>
<div><em>Rule actions drop (IPS mode) and reject are applied to each packet
that generate an alert</em></div></blockquote>
</div>
</div>
<span id="document-rules/ip-reputation-rules"></span><div class="section" id="ip-reputation-keyword">
<h3>IP Reputation Keyword<a class="headerlink" href="#ip-reputation-keyword" title="Permalink to this headline">¶</a></h3>
<p>IP Reputation can be used in rules through a new rule keyword &quot;iprep&quot;.</p>
<p>For more information about IP Reputation see <a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-config"><span class="doc">IP Reputation Config</span></a> and <a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-format"><span class="doc">IP Reputation Format</span></a>.</p>
<div class="section" id="iprep">
<h4>iprep<a class="headerlink" href="#iprep" title="Permalink to this headline">¶</a></h4>
<p>The iprep directive matches on the IP reputation information for a host.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iprep</span><span class="p">:</span><span class="o">&lt;</span><span class="n">side</span> <span class="n">to</span> <span class="n">check</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">category</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">operator</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">reputation</span> <span class="n">score</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>side to check: &lt;any|src|dst|both&gt;</p>
<p>category: the category short name</p>
<p>operator: &lt;, &gt;, =</p>
<p>reputation score: 1-127</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert ip $HOME_NET any -&gt; any any (msg:&quot;IPREP internal host talking to CnC server&quot;; flow:to_server; iprep:dst,CnC,&gt;,30; sid:1; rev:1;)
</pre></div>
</div>
<p>This rule will alert when a system in $HOME_NET acts as a client while communicating with any IP in the CnC category that has a reputation score set to greater than 30.</p>
<div class="section" id="ip-only">
<h5>IP-only<a class="headerlink" href="#ip-only" title="Permalink to this headline">¶</a></h5>
<p>The &quot;iprep&quot; keyword is compatible to &quot;IP-only&quot; rules. This means that a rule like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ip</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;IPREP High Value CnC&quot;</span><span class="p">;</span> <span class="n">iprep</span><span class="p">:</span><span class="n">src</span><span class="p">,</span><span class="n">CnC</span><span class="p">,</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">100</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>will only be checked once per flow-direction.</p>
</div>
</div>
</div>
<span id="document-rules/ipaddr"></span><div class="section" id="ip-addresses-match">
<span id="ipaddr"></span><h3>IP Addresses Match<a class="headerlink" href="#ip-addresses-match" title="Permalink to this headline">¶</a></h3>
<p>Matching on IP addresses can be done via the IP tuple parameters or via the iprep keywords (see <a class="reference internal" href="index.html#document-rules/ip-reputation-rules"><span class="doc">IP Reputation Keyword</span></a>).
Some keywords providing interaction with datasets are also available.</p>
<div class="section" id="ip-src">
<h4>ip.src<a class="headerlink" href="#ip-src" title="Permalink to this headline">¶</a></h4>
<p>The <cite>ip.src</cite> keyword is a sticky buffer to match on source IP address. It matches on the binary representation
and is compatible with datasets of types <cite>ip</cite> and <cite>ipv4</cite>.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp $EXTERNAL_NET any -&gt; $HOME_NET any (msg:&quot;Inbound bad list&quot;; flow:to_server; ip.src; dataset:isset,badips,type ip,load badips.list; sid:1; rev:1;)
</pre></div>
</div>
</div>
<div class="section" id="ip-dst">
<h4>ip.dst<a class="headerlink" href="#ip-dst" title="Permalink to this headline">¶</a></h4>
<p>The <cite>ip.dst</cite> keyword is a sticky buffer to match on destination IP address. It matches on the binary representation
and is compatible with the dataset of type <cite>ip</cite> and <cite>ipv4</cite>.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp $HOME_NET any -&gt; any any (msg:&quot;Outbound bad list&quot;; flow:to_server; ip.dst; dataset:isset,badips,type ip,load badips.list; sid:1; rev:1;)
</pre></div>
</div>
</div>
</div>
<span id="document-rules/config"></span><div class="section" id="config-rules">
<h3>Config Rules<a class="headerlink" href="#config-rules" title="Permalink to this headline">¶</a></h3>
<p>Config rules are rules that when matching, will change the configuration of
Suricata for a flow, transaction, packet or other unit.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="n">dns</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;suricata&quot;</span><span class="p">;</span> <span class="n">config</span><span class="p">:</span> <span class="n">logging</span> <span class="n">disable</span><span class="p">,</span> <span class="nb">type</span> <span class="n">tx</span><span class="p">,</span> <span class="n">scope</span> <span class="n">tx</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>This example will detect if a DNS query contains the string <cite>suricata</cite> and if
so disable the DNS transaction logging. This means that <cite>eve.json</cite> records,
but also Lua output, will not be generated/triggered for this DNS transaction.</p>
<div class="section" id="keyword">
<h4>Keyword<a class="headerlink" href="#keyword" title="Permalink to this headline">¶</a></h4>
<p>The <cite>config</cite> rule keyword provides the setting and the scope of the change.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">:</span><span class="o">&lt;</span><span class="n">subsys</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">action</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">&lt;</span><span class="nb">type</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">scope</span> <span class="o">&lt;</span><span class="n">scope</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p><cite>subsys</cite> can be set to:</p>
<ul class="simple">
<li><cite>logging</cite> setting affects logging.</li>
</ul>
<p><cite>type</cite> can be set to:</p>
<ul class="simple">
<li><cite>tx</cite> sub type of the <cite>subsys</cite>. If <cite>subsys</cite> is set to <cite>logging</cite>, setting the <cite>type</cite> to <cite>tx</cite> means transaction logging is affected.</li>
</ul>
<p><cite>scope</cite> can be set to:</p>
<ul class="simple">
<li><cite>tx</cite> setting affects the matching transaction.</li>
</ul>
<p>The <cite>action</cite> in <cite>&lt;subsys&gt;</cite> is currently limited to <cite>disable</cite>.</p>
</div>
<div class="section" id="action">
<h4>Action<a class="headerlink" href="#action" title="Permalink to this headline">¶</a></h4>
<p>Config rules can, but don't have to, use the <cite>config</cite> rule action. The <cite>config</cite>
rule action won't generate an alert when the rule matches, but the rule actions
will still be applied. It is equivalent to <cite>alert ... (noalert; ...)</cite>.</p>
</div>
</div>
<span id="document-rules/datasets"></span><div class="section" id="datasets">
<span id="id1"></span><h3>Datasets<a class="headerlink" href="#datasets" title="Permalink to this headline">¶</a></h3>
<p>Using the <code class="docutils literal notranslate"><span class="pre">dataset</span></code> and <code class="docutils literal notranslate"><span class="pre">datarep</span></code> keyword it is possible to match on
large amounts of data against any sticky buffer.</p>
<p>For example, to match against a DNS black list called <code class="docutils literal notranslate"><span class="pre">dns-bl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">dataset</span><span class="p">:</span><span class="n">isset</span><span class="p">,</span><span class="n">dns</span><span class="o">-</span><span class="n">bl</span><span class="p">;</span>
</pre></div>
</div>
<p>These keywords are aware of transforms. So to look up a DNS query against
a MD5 black list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">to_md5</span><span class="p">;</span> <span class="n">dataset</span><span class="p">:</span><span class="n">isset</span><span class="p">,</span><span class="n">dns</span><span class="o">-</span><span class="n">bl</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="global-config-optional">
<h4>Global config (optional)<a class="headerlink" href="#global-config-optional" title="Permalink to this headline">¶</a></h4>
<p>Datasets can optionally be defined in the main config. Sets can also be
declared from the rule syntax.</p>
<p>Example of sets for tracking unique values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span><span class="p">:</span>
  <span class="n">ua</span><span class="o">-</span><span class="n">seen</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">string</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">ua</span><span class="o">-</span><span class="n">seen</span><span class="o">.</span><span class="n">lst</span>
  <span class="n">dns</span><span class="o">-</span><span class="n">sha256</span><span class="o">-</span><span class="n">seen</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">sha256</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">dns</span><span class="o">-</span><span class="n">sha256</span><span class="o">-</span><span class="n">seen</span><span class="o">.</span><span class="n">lst</span>
</pre></div>
</div>
<p>Rules to go with the above:</p>
<div class="example-rule docutils container">
alert dns any any -&gt; any any (msg:&quot;dns list test&quot;; dns.query; to_sha256; dataset:isset,dns-sha256-seen; sid:123; rev:1;)</div>
<div class="example-rule docutils container">
alert http any any -&gt; any any (msg: &quot;http user-agent test&quot;; http.user_agent; dataset:set,ua-seen; sid:234; rev:1;)</div>
<p>It is also possible to optionally define global default memcap and hashsize.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span><span class="p">:</span>
  <span class="n">defaults</span><span class="p">:</span>
    <span class="n">memcap</span><span class="p">:</span> <span class="mi">100</span><span class="n">mb</span>
    <span class="n">hashsize</span><span class="p">:</span> <span class="mi">2048</span>
  <span class="n">ua</span><span class="o">-</span><span class="n">seen</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">string</span>
    <span class="n">load</span><span class="p">:</span> <span class="n">ua</span><span class="o">-</span><span class="n">seen</span><span class="o">.</span><span class="n">lst</span>
</pre></div>
</div>
<p>or define memcap and hashsize per dataset.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span><span class="p">:</span>
  <span class="n">ua</span><span class="o">-</span><span class="n">seen</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">string</span>
    <span class="n">load</span><span class="p">:</span> <span class="n">ua</span><span class="o">-</span><span class="n">seen</span><span class="o">.</span><span class="n">lst</span>
    <span class="n">memcap</span><span class="p">:</span> <span class="mi">10</span><span class="n">mb</span>
    <span class="n">hashsize</span><span class="p">:</span> <span class="mi">1024</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <cite>hashsize</cite> should be close to the amount of entries in the dataset to avoid collisions. If it's set too low, this could result in rather long startup time.</p>
</div>
</div>
<div class="section" id="rule-keywords">
<h4>Rule keywords<a class="headerlink" href="#rule-keywords" title="Permalink to this headline">¶</a></h4>
<div class="section" id="dataset">
<h5>dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">¶</a></h5>
<p>Datasets are binary: something is in the set or it's not.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">:</span><span class="o">&lt;</span><span class="n">cmd</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">dataset</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">set</span><span class="o">|</span><span class="n">isset</span><span class="o">|</span><span class="n">isnotset</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span> \
    <span class="p">[,</span> <span class="nb">type</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">|</span><span class="n">md5</span><span class="o">|</span><span class="n">sha256</span><span class="o">|</span><span class="n">ipv4</span><span class="o">|</span><span class="n">ip</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">save</span> <span class="o">&lt;</span><span class="n">file</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">load</span> <span class="o">&lt;</span><span class="n">file</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">state</span> <span class="o">&lt;</span><span class="n">file</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">memcap</span> <span class="o">&lt;</span><span class="n">size</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">hashsize</span> <span class="o">&lt;</span><span class="n">size</span><span class="o">&gt;</span><span class="p">];</span>
</pre></div>
</div>
<dl class="docutils">
<dt>type &lt;type&gt;</dt>
<dd>the data type: string, md5, sha256, ipv4, ip</dd>
<dt>load &lt;file name&gt;</dt>
<dd>file name for load the data when Suricata starts up</dd>
<dt>state</dt>
<dd>sets file name for loading and saving a dataset</dd>
<dt>save &lt;file name&gt;</dt>
<dd>advanced option to set the file name for saving the in-memory data
when Suricata exits.</dd>
<dt>memcap &lt;size&gt;</dt>
<dd>maximum memory limit for the respective dataset</dd>
<dt>hashsize &lt;size&gt;</dt>
<dd>allowed size of the hash for the respective dataset</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">'type' is mandatory and needs to be set.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">'load' and 'state' or 'save' and 'state' cannot be mixed.</p>
</div>
<p>Example rules could look like:</p>
<ol class="arabic simple">
<li>Detect unique User-Agents:</li>
</ol>
<div class="example-rule docutils container">
alert http any any -&gt; any any (msg:&quot;LOCAL HTTP new UA&quot;; http.user_agent; dataset:set,http-ua-seen, type string, state http-ua-seen.csv; sid:8000001; rev:1;)</div>
<ol class="arabic simple" start="2">
<li>Detect unique TLDs:</li>
</ol>
<div class="example-rule docutils container">
alert dns $HOME_NET any -&gt; any any (msg:&quot;LOCAL DNS unique TLD&quot;; dns.query; pcrexform:&quot;\.([^\.]+)$&quot;; dataset:set,dns-tld-seen, type string, state dns-tld-seen.csv; sid:8000002; rev:1;)</div>
<p>Following image is a pictorial representation of how the <code class="docutils literal notranslate"><span class="pre">pcrexform</span></code> works
on domain names to find TLDs in the dataset <code class="docutils literal notranslate"><span class="pre">dns-tld-seen</span></code>:</p>
<img alt="_images/detect-unique-tlds.png" src="_images/detect-unique-tlds.png" />
<p>Notice how it is not possible to do certain operations alone with datasets
(example 2 above), but, it is possible to use a combination of other rule
keywords. Keep in mind the cost of additional keywords though e.g. in the
second example rule above, negative performance impact can be expected due
to <code class="docutils literal notranslate"><span class="pre">pcrexform</span></code>.</p>
</div>
<div class="section" id="datarep">
<h5>datarep<a class="headerlink" href="#datarep" title="Permalink to this headline">¶</a></h5>
<p>Data Reputation allows matching data against a reputation list.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datarep</span><span class="p">:</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">operator</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> \
    <span class="p">[,</span> <span class="n">load</span> <span class="o">&lt;</span><span class="n">file</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">|</span><span class="n">md5</span><span class="o">|</span><span class="n">sha256</span><span class="o">|</span><span class="n">ipv4</span><span class="o">|</span><span class="n">ip</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">memcap</span> <span class="o">&lt;</span><span class="n">size</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">hashsize</span> <span class="o">&lt;</span><span class="n">size</span><span class="o">&gt;</span><span class="p">];</span>
</pre></div>
</div>
<p>Example rules could look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">dns</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">to_md5</span><span class="p">;</span> <span class="n">datarep</span><span class="p">:</span><span class="n">dns_md5</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">load</span> <span class="n">dns_md5</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="nb">type</span> <span class="n">md5</span><span class="p">,</span> <span class="n">memcap</span> <span class="mi">100</span><span class="n">mb</span><span class="p">,</span> <span class="n">hashsize</span> <span class="mi">2048</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">dns</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">to_sha256</span><span class="p">;</span> <span class="n">datarep</span><span class="p">:</span><span class="n">dns_sha256</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">load</span> <span class="n">dns_sha256</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="nb">type</span> <span class="n">sha256</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
<span class="n">alert</span> <span class="n">dns</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">;</span> <span class="n">datarep</span><span class="p">:</span><span class="n">dns_string</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">load</span> <span class="n">dns_string</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span> <span class="nb">type</span> <span class="n">string</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;)</span>
</pre></div>
</div>
<p>In these examples the DNS query string is checked against three different
reputation lists. A MD5 list, a SHA256 list, and a raw string (buffer) list.
The rules will only match if the data is in the list and the reputation
value is higher than 200.</p>
</div>
</div>
<div class="section" id="rule-reloads">
<h4>Rule Reloads<a class="headerlink" href="#rule-reloads" title="Permalink to this headline">¶</a></h4>
<p>Sets that are defined in the yaml, or sets that only use <cite>state</cite> or <cite>save</cite>, are
considered <cite>dynamic</cite> sets. These are not reloaded during rule reloads.</p>
<p>Sets that are defined in rules using only <cite>load</cite> are considered <cite>static</cite> tests.
These are not expected to change during runtime. During rule reloads these are
reloaded from disk. This reload is effective when the complete rule reload
process is complete.</p>
</div>
<div class="section" id="unix-socket">
<h4>Unix Socket<a class="headerlink" href="#unix-socket" title="Permalink to this headline">¶</a></h4>
<div class="section" id="dataset-add">
<h5>dataset-add<a class="headerlink" href="#dataset-add" title="Permalink to this headline">¶</a></h5>
<p>Unix Socket command to add data to a set. On success, the addition becomes
active instantly.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">-</span><span class="n">add</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="nb">type</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">data</span><span class="o">&gt;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>set name</dt>
<dd>Name of an already defined dataset</dd>
<dt>type</dt>
<dd>Data type: string, md5, sha256, ipv4, ip</dd>
<dt>data</dt>
<dd>Data to add in serialized form (base64 for string, hex notation for md5/sha256, string representation for ipv4/ip)</dd>
</dl>
<p>Example adding 'google.com' to set 'myset':</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">-</span><span class="n">add</span> <span class="n">myset</span> <span class="n">string</span> <span class="n">Z29vZ2xlLmNvbQ</span><span class="o">==</span>
</pre></div>
</div>
</div>
<div class="section" id="dataset-remove">
<h5>dataset-remove<a class="headerlink" href="#dataset-remove" title="Permalink to this headline">¶</a></h5>
<p>Unix Socket command to remove data from a set. On success, the removal becomes
active instantly.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">-</span><span class="n">remove</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="nb">type</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">data</span><span class="o">&gt;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>set name</dt>
<dd>Name of an already defined dataset</dd>
<dt>type</dt>
<dd>Data type: string, md5, sha256, ipv4, ip</dd>
<dt>data</dt>
<dd>Data to remove in serialized form (base64 for string, hex notation for md5/sha256, string representation for ipv4/ip)</dd>
</dl>
</div>
<div class="section" id="dataset-clear">
<h5>dataset-clear<a class="headerlink" href="#dataset-clear" title="Permalink to this headline">¶</a></h5>
<p>Unix Socket command to remove all data from a set. On success, the removal becomes
active instantly.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">-</span><span class="n">clear</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="nb">type</span><span class="o">&gt;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>set name</dt>
<dd>Name of an already defined dataset</dd>
<dt>type</dt>
<dd>Data type: string, md5, sha256, ipv4, ip</dd>
</dl>
</div>
<div class="section" id="dataset-lookup">
<h5>dataset-lookup<a class="headerlink" href="#dataset-lookup" title="Permalink to this headline">¶</a></h5>
<p>Unix Socket command to test if data is in a set.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">-</span><span class="n">lookup</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nb">set</span> <span class="nb">type</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">data</span><span class="o">&gt;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>set name</dt>
<dd>Name of an already defined dataset</dd>
<dt>type</dt>
<dd>Data type: string, md5, sha256, ipv4, ip</dd>
<dt>data</dt>
<dd>Data to test in serialized form (base64 for string, hex notation for md5/sha256, string notation for ipv4/ip)</dd>
</dl>
<p>Example testing if 'google.com' is in the set 'myset':</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">-</span><span class="n">lookup</span> <span class="n">myset</span> <span class="n">string</span> <span class="n">Z29vZ2xlLmNvbQ</span><span class="o">==</span>
</pre></div>
</div>
</div>
<div class="section" id="dataset-dump">
<h5>dataset-dump<a class="headerlink" href="#dataset-dump" title="Permalink to this headline">¶</a></h5>
<p>Unix socket command to trigger a dump of datasets to disk.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">-</span><span class="n">dump</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="file-formats">
<h4>File formats<a class="headerlink" href="#file-formats" title="Permalink to this headline">¶</a></h4>
<p>Datasets use a simple CSV format where data is per line in the file.</p>
<div class="section" id="data-types">
<h5>data types<a class="headerlink" href="#data-types" title="Permalink to this headline">¶</a></h5>
<dl class="docutils">
<dt>string</dt>
<dd>in the file as base64 encoded string</dd>
<dt>md5</dt>
<dd>in the file as hex encoded string</dd>
<dt>sha256</dt>
<dd>in the file as hex encoded string</dd>
<dt>ipv4</dt>
<dd>in the file as string</dd>
<dt>ip</dt>
<dd>in the file as string, it can be IPv6 or IPv4 address (standard notation or IPv4 in IPv6 one)</dd>
</dl>
</div>
<div class="section" id="id2">
<h5>dataset<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<p>Datasets have a simple structure, where there is one piece of data
per line in the file.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">data</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>e.g. for ua-seen with type string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TW96aWxsYS80LjAgKGNvbXBhdGlibGU7ICk</span><span class="o">=</span>
</pre></div>
</div>
<p>which when piped to <code class="docutils literal notranslate"><span class="pre">base64</span> <span class="pre">-d</span></code> reveals its value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">4.0</span> <span class="p">(</span><span class="n">compatible</span><span class="p">;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h5>datarep<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<p>The datarep format follows the dataset, expect that there are 1 more CSV
field:</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">data</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="file-locations">
<span id="datasets-file-locations"></span><h4>File Locations<a class="headerlink" href="#file-locations" title="Permalink to this headline">¶</a></h4>
<p>Dataset filenames configured in the <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> can exist
anywhere on your filesytem.</p>
<p>When a dataset filename is specified in rule, the following <em>rules</em>
are applied:</p>
<ul class="simple">
<li>For <code class="docutils literal notranslate"><span class="pre">load</span></code>, the filename is opened relative to the rule file
containing the rule. Absolute filenames and parent directory
traversals are allowed.</li>
<li>For <code class="docutils literal notranslate"><span class="pre">save</span></code> and <code class="docutils literal notranslate"><span class="pre">state</span></code> the filename is relative to
<code class="docutils literal notranslate"><span class="pre">$LOCALSTATEDIR/suricata/data</span></code>. On many installs this will be
<code class="docutils literal notranslate"><span class="pre">/var/lib/suricata/data</span></code>, but run <code class="docutils literal notranslate"><span class="pre">suricata</span> <span class="pre">--build-info</span></code> and
check the value of <code class="docutils literal notranslate"><span class="pre">--localstatedir</span></code> to verify this location onn
your installation.<ul>
<li>Absolute filenames, or filenames containing parent directory
traversal (<code class="docutils literal notranslate"><span class="pre">..</span></code>) are not allowed unless the configuration
paramater <code class="docutils literal notranslate"><span class="pre">datasets.allow-absolute-filenames</span></code> is set to
<code class="docutils literal notranslate"><span class="pre">true</span></code>.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="security">
<span id="datasets-security"></span><h4>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h4>
<p>As datasets potentially allow a rule distributor write access to your
system with <code class="docutils literal notranslate"><span class="pre">save</span></code> and <code class="docutils literal notranslate"><span class="pre">state</span></code> dataset rules, the locations
allowed are strict by default, however there are two dataset options
to tune the security of rules utilizing dataset filenames:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span><span class="p">:</span>
  <span class="n">rules</span><span class="p">:</span>
    <span class="c1"># Set to true to allow absolute filenames and filenames that use</span>
    <span class="c1"># &quot;..&quot; components to reference parent directories in rules that specify</span>
    <span class="c1"># their filenames.</span>
    <span class="n">allow</span><span class="o">-</span><span class="n">absolute</span><span class="o">-</span><span class="n">filenames</span><span class="p">:</span> <span class="n">false</span>

    <span class="c1"># Allow datasets in rules write access for &quot;save&quot; and</span>
    <span class="c1"># &quot;state&quot;. This is enabled by default, however write access is</span>
    <span class="c1"># limited to the data directory.</span>
    <span class="n">allow</span><span class="o">-</span><span class="n">write</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p>By setting <code class="docutils literal notranslate"><span class="pre">datasets.rules.allow-write</span></code> to false, all <code class="docutils literal notranslate"><span class="pre">save</span></code> and
<code class="docutils literal notranslate"><span class="pre">state</span></code> rules will fail to load. This option is enabled by default
to preserve compatiblity with previous 6.0 Suricata releases, however
may change in a future major release.</p>
<p>Pre-Suricata 6.0.13 behavior can be restored by setting
<code class="docutils literal notranslate"><span class="pre">datasets.rules.allow-absolute-filenames</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>, however
allowing so will allow any rule to overwrite any file on your system
that Suricata has write access to.</p>
</div>
</div>
<span id="document-rules/lua-detection"></span><div class="section" id="lua-scripting-for-detection">
<span id="lua-detection"></span><h3>Lua Scripting for Detection<a class="headerlink" href="#lua-scripting-for-detection" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lua is disabled by default for use in rules, it must be
enabled in the configuration file. See the <code class="docutils literal notranslate"><span class="pre">security.lua</span></code>
section of <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> and enable <code class="docutils literal notranslate"><span class="pre">allow-rules</span></code>.</p>
</div>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lua:[!]&lt;scriptfilename&gt;;
</pre></div>
</div>
<p>The script filename will be appended to your default rules location.</p>
<p>The script has 2 parts, an init function and a match function. First, the init.</p>
<div class="section" id="init-function">
<h4>Init function<a class="headerlink" href="#init-function" title="Permalink to this headline">¶</a></h4>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;http.request_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">needs</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>The init function registers the buffer(s) that need
inspection. Currently the following are available:</p>
<ul class="simple">
<li>packet -- entire packet, including headers</li>
<li>payload -- packet payload (not stream)</li>
<li>buffer -- the current sticky buffer</li>
<li>stream</li>
<li>dnp3</li>
<li>dns.request</li>
<li>dns.response</li>
<li>dns.rrname</li>
<li>ssh</li>
<li>smtp</li>
<li>tls</li>
<li>http.uri</li>
<li>http.uri.raw</li>
<li>http.request_line</li>
<li>http.request_headers</li>
<li>http.request_headers.raw</li>
<li>http.request_cookie</li>
<li>http.request_user_agent</li>
<li>http.request_body</li>
<li>http.response_headers</li>
<li>http.response_headers.raw</li>
<li>http.response_body</li>
<li>http.response_cookie</li>
</ul>
<p>All the HTTP buffers have a limitation: only one can be inspected by a
script at a time.</p>
</div>
<div class="section" id="match-function">
<h4>Match function<a class="headerlink" href="#match-function" title="Permalink to this headline">¶</a></h4>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">match</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;http.request_line&quot;</span><span class="p">])</span>
    <span class="kr">if</span> <span class="o">#</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span>
        <span class="kr">if</span> <span class="n">a</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;^POST%s+/.*%.php%s+HTTP/1.0$&quot;</span><span class="p">)</span> <span class="kr">then</span>
            <span class="kr">return</span> <span class="mi">1</span>
        <span class="kr">end</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="mi">0</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>The script can return 1 or 0. It should return 1 if the condition(s)
it checks for match, 0 if not.</p>
<p>Entire script:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;http.request_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">needs</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">match</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;http.request_line&quot;</span><span class="p">])</span>
    <span class="kr">if</span> <span class="o">#</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span>
        <span class="kr">if</span> <span class="n">a</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;^POST%s+/.*%.php%s+HTTP/1.0$&quot;</span><span class="p">)</span> <span class="kr">then</span>
            <span class="kr">return</span> <span class="mi">1</span>
        <span class="kr">end</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="mi">0</span>
<span class="kr">end</span>

<span class="kr">return</span> <span class="mi">0</span>
</pre></div>
</div>
<p>A comprehensive list of existing lua functions -  with examples - can be found at <a class="reference internal" href="index.html#lua-functions"><span class="std std-ref">Lua functions</span></a> (some of them, however,
work only for the lua-output functionality).</p>
</div>
</div>
<span id="document-rules/differences-from-snort"></span><div class="section" id="differences-from-snort">
<h3>Differences From Snort<a class="headerlink" href="#differences-from-snort" title="Permalink to this headline">¶</a></h3>
<p>This document is intended to highlight the major differences between Suricata
and Snort that apply to rules and rule writing.</p>
<p>Where not specified, the statements below apply to Suricata.  In general,
references to Snort refer to the version 2.9 branch.</p>
<div class="section" id="automatic-protocol-detection">
<h4>Automatic Protocol Detection<a class="headerlink" href="#automatic-protocol-detection" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Suricata does automatic protocol detection of the following
application layer protocols:</p>
<ul class="simple">
<li>dcerpc</li>
<li>dnp3</li>
<li>dns</li>
<li>http</li>
<li>imap (detection only by default; no parsing)</li>
<li>ftp</li>
<li>modbus (disabled by default; minimalist probe parser; can lead to false positives)</li>
<li>smb</li>
<li>smb2 (disabled internally inside the engine)</li>
<li>smtp</li>
<li>ssh</li>
<li>tls (SSLv2, SSLv3, TLSv1, TLSv1.1 and TLSv1.2)</li>
</ul>
</li>
<li><p class="first">In Suricata, protocol detection is port agnostic (in most cases). In
Snort, in order for the <code class="docutils literal notranslate"><span class="pre">http_inspect</span></code> and other preprocessors to be
applied to traffic, it has to be over a configured port.</p>
<ul class="simple">
<li>Some configurations for app-layer in the Suricata yaml can/do by default
specify specific destination ports (e.g. DNS)</li>
<li><strong>You can look on 'any' port without worrying about the
performance impact that you would have to be concerned about with
Snort.</strong></li>
</ul>
</li>
<li><p class="first">If the traffic is detected as HTTP by Suricata, the <code class="docutils literal notranslate"><span class="pre">http_*</span></code>
buffers are populated and can be used, regardless of port(s)
specified in the rule.</p>
</li>
<li><p class="first">You don't have to check for the http protocol (i.e.
<code class="docutils literal notranslate"><span class="pre">alert</span> <span class="pre">http</span> <span class="pre">...</span></code>) to use the <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffers although it
is recommended.</p>
</li>
<li><p class="first">If you are trying to detect legitimate (supported) application layer
protocol traffic and don't want to look on specific port(s), the rule
should be written as <code class="docutils literal notranslate"><span class="pre">alert</span> <span class="pre">&lt;protocol&gt;</span> <span class="pre">...</span></code> with <code class="docutils literal notranslate"><span class="pre">any</span></code> in
place of the usual protocol port(s).  For example, when you want to
detect HTTP traffic and don't want to limit detection to a particular
port or list of ports, the rules should be written as
<code class="docutils literal notranslate"><span class="pre">alert</span> <span class="pre">http</span> <span class="pre">...</span></code> with <code class="docutils literal notranslate"><span class="pre">any</span></code> in place of
<code class="docutils literal notranslate"><span class="pre">$HTTP_PORTS</span></code>.</p>
<ul class="simple">
<li>You can also use <code class="docutils literal notranslate"><span class="pre">app-layer-protocol:&lt;protocol&gt;;</span></code> inside the rule instead.</li>
</ul>
<p>So, instead of this Snort rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET $HTTP_PORTS ...
</pre></div>
</div>
<p>Do this for Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert http $HOME_NET -&gt; $EXTERNAL_NET any ...
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET any (app-layer-protocol:http; ...
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="urilen-keyword">
<h4><code class="docutils literal notranslate"><span class="pre">urilen</span></code> Keyword<a class="headerlink" href="#urilen-keyword" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Ranges given in the <code class="docutils literal notranslate"><span class="pre">urilen</span></code> keyword are inclusive for Snort
but not inclusive for Suricata.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">urilen:2&lt;&gt;10</span></code></p>
<blockquote>
<div><ul class="simple">
<li>Snort interprets this as, &quot;the URI length must be <strong>greater than
or equal to</strong> 2, and <strong>less than or equal to</strong> 10&quot;.</li>
<li>Suricata interprets this as &quot;the URI length must be <strong>greater
than</strong> 2 and <strong>less than</strong> 10&quot;.</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>There is a request to have Suricata behave like Snort in future
versions –
<a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/1416">https://redmine.openinfosecfoundation.org/issues/1416</a><ul>
<li>Currently on hold</li>
</ul>
</li>
</ul>
</li>
<li><p class="first">By default, with <em>Suricata</em>, <code class="docutils literal notranslate"><span class="pre">urilen</span></code> applies to the
<strong>normalized</strong> buffer</p>
<ul class="simple">
<li>Use <code class="docutils literal notranslate"><span class="pre">,raw</span></code> for raw buffer</li>
<li>e.g. <code class="docutils literal notranslate"><span class="pre">urilen:&gt;20,raw;</span></code></li>
</ul>
</li>
<li><p class="first">By default, with <em>Snort</em>, <code class="docutils literal notranslate"><span class="pre">urilen</span></code> applies to the <strong>raw</strong>
buffer</p>
<ul class="simple">
<li>Use <code class="docutils literal notranslate"><span class="pre">,norm</span></code> for normalized buffer</li>
<li>e.g. <code class="docutils literal notranslate"><span class="pre">urilen:&gt;20,norm;</span></code></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="http-uri-buffer">
<h4><code class="docutils literal notranslate"><span class="pre">http_uri</span></code> Buffer<a class="headerlink" href="#http-uri-buffer" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>In Snort, the <code class="docutils literal notranslate"><span class="pre">http_uri</span></code> buffer normalizes '+' characters
(0x2B) to spaces (0x20).<ul>
<li>Suricata can do this as well but you have to explicitly
set <code class="docutils literal notranslate"><span class="pre">query-plusspace-decode:</span> <span class="pre">yes</span></code> in the <code class="docutils literal notranslate"><span class="pre">libhtp</span></code> section of Suricata's yaml file.</li>
</ul>
</li>
<li><a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/1035">https://redmine.openinfosecfoundation.org/issues/1035</a></li>
<li><a class="reference external" href="https://github.com/inliniac/suricata/pull/620">https://github.com/inliniac/suricata/pull/620</a></li>
</ul>
</div>
<div class="section" id="http-header-buffer">
<h4><code class="docutils literal notranslate"><span class="pre">http_header</span></code> Buffer<a class="headerlink" href="#http-header-buffer" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">In Snort, the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer includes the CRLF CRLF (0x0D
0x0A 0x0D 0x0A) that separates the end of the last HTTP header from
the beginning of the HTTP body.  Suricata includes a CRLF after the
last header in the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer but not an extra one
like Snort does.  If you want to match the end of the buffer, use
either the <code class="docutils literal notranslate"><span class="pre">http_raw_header</span></code> buffer, a relative
<code class="docutils literal notranslate"><span class="pre">isdataat</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">isdataat:!1,relative</span></code>) or a PCRE
(although PCRE will be worse on performance).</p>
</li>
<li><p class="first">Suricata <em>will</em> include CRLF CRLF at the end of the <code class="docutils literal notranslate"><span class="pre">http_raw_header</span></code>
buffer like Snort does.</p>
</li>
<li><p class="first">Snort will include a <em>leading</em> CRLF in the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer of
<em>server responses</em> (but not client requests).  Suricata does not have
the leading CRLF in the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer of the server response
or client request.</p>
</li>
<li><p class="first">In the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer, Suricata will normalize HTTP header lines
such that there is a single space (0x20) after the colon (':') that
separates the header name from the header value; this single space
replaces zero or more whitespace characters (including tabs) that may be
present in the raw HTTP header line immediately after the colon.  If the
extra whitespace (or lack thereof) is important for matching, use
the <code class="docutils literal notranslate"><span class="pre">http_raw_header</span></code> buffer instead of the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer.</p>
</li>
<li><p class="first">Snort will also normalize superfluous whitespace between the header name
and header value like Suricata does but only if there is at least one space
character (0x20 only so not 0x90) immediately after the colon.  This means
that, unlike Suricata, if there is no space (or if there is a tab)
immediately after the colon before the header value, the content of the
header line will remain unchanged in the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer.</p>
</li>
<li><p class="first">When there are duplicate HTTP headers (referring to the header name
only, not the value), the normalized buffer (<code class="docutils literal notranslate"><span class="pre">http_header</span></code>)
will concatenate the values in the order seen (from top to
bottom), with a comma and space (&quot;, &quot;) between each of them.  If this
hinders detection, use the <code class="docutils literal notranslate"><span class="pre">http_raw_header</span></code> buffer instead.</p>
<p>Example request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">44</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">55</span>
</pre></div>
</div>
<p>The Content-Length header line becomes this in the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">55</span>
</pre></div>
</div>
</li>
<li><p class="first">The HTTP 'Cookie' and 'Set-Cookie' headers are <strong>NOT</strong> included in
the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer; instead they are extracted and put into
their own buffer – <code class="docutils literal notranslate"><span class="pre">http_cookie</span></code>. See the <a class="reference internal" href="#http-cookie-buffer">http_cookie Buffer</a>
section.</p>
</li>
<li><p class="first">The HTTP 'Cookie' and 'Set-Cookie' headers <strong>ARE</strong> included in the
<code class="docutils literal notranslate"><span class="pre">http_raw_header</span></code> buffer so if you are trying to match on
something like particular header ordering involving (or not
involving) the HTTP Cookie headers, use the <code class="docutils literal notranslate"><span class="pre">http_raw_header</span></code>
buffer.</p>
</li>
<li><p class="first">If 'enable_cookie' is set for Snort, the HTTP Cookie header names
and trailing CRLF (i.e. &quot;Cookie: \r\n&quot; and &quot;Set-Cooke \r\n&quot;) are
kept in the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer.  This is not the case for
Suricata which removes the entire &quot;Cookie&quot; or &quot;Set-Cookie&quot; line from
the <code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer.</p>
</li>
<li><p class="first">Other HTTP headers that have their own buffer
(<code class="docutils literal notranslate"><span class="pre">http_user_agent</span></code>, <code class="docutils literal notranslate"><span class="pre">http_host</span></code>) are not removed from the
<code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer like the Cookie headers are.</p>
</li>
<li><p class="first">When inspecting server responses and <code class="docutils literal notranslate"><span class="pre">file_data</span></code> is used,
content matches in <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffers should come before
<code class="docutils literal notranslate"><span class="pre">file_data</span></code> unless you use <code class="docutils literal notranslate"><span class="pre">pkt_data</span></code> to reset the cursor
before matching in <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffers.  Snort will not complain if
you use <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffers after <code class="docutils literal notranslate"><span class="pre">file_data</span></code> is set.</p>
</li>
</ul>
</div>
<div class="section" id="http-cookie-buffer">
<h4><code class="docutils literal notranslate"><span class="pre">http_cookie</span></code> Buffer<a class="headerlink" href="#http-cookie-buffer" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http_cookie</span></code> buffer will NOT include the header name,
colon, or leading whitespace.  i.e. it will not include &quot;Cookie: &quot; or &quot;Set-Cookie: &quot;.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">http_cookie</span></code> buffer does not include a CRLF (0x0D 0x0A) at
the end.  If you want to match the end of the buffer, use a relative
<code class="docutils literal notranslate"><span class="pre">isdataat</span></code> or a PCRE (although PCRE will be worse on
performance).</p>
</li>
<li><p class="first">There is no <code class="docutils literal notranslate"><span class="pre">http_raw_cookie</span></code> buffer in Suricata.  Use
<code class="docutils literal notranslate"><span class="pre">http_raw_header</span></code> instead.</p>
</li>
<li><p class="first">You do not have to configure anything special to use the
'http_cookie' buffer in Suricata.  This is different from Snort
where you have to set <code class="docutils literal notranslate"><span class="pre">enable_cookie</span></code> in the
<code class="docutils literal notranslate"><span class="pre">http_inspect_server</span></code> preprocessor config in order to have the
<code class="docutils literal notranslate"><span class="pre">http_cookie</span></code> buffer treated separate from the
<code class="docutils literal notranslate"><span class="pre">http_header</span></code> buffer.</p>
</li>
<li><p class="first">If Snort has 'enable_cookie' set and multiple &quot;Cookie&quot; or
&quot;Set-Cookie&quot; headers are seen, it will concatenate them together
(with no separator between them) in the order seen from top to
bottom.</p>
</li>
<li><p class="first">If a request contains multiple &quot;Cookie&quot; or &quot;Set-Cookie&quot; headers, the
values will be concatenated in the Suricata <code class="docutils literal notranslate"><span class="pre">http_cookie</span></code>
buffer, in the order seen from top to bottom, with a comma and space
(&quot;, &quot;) between each of them.</p>
<p>Example request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Cookie</span><span class="p">:</span> <span class="n">monster</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<span class="n">Cookie</span><span class="p">:</span> <span class="n">elmo</span>
</pre></div>
</div>
<p>Suricata <code class="docutils literal notranslate"><span class="pre">http_cookie</span></code> buffer contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">monster</span><span class="p">,</span> <span class="n">elmo</span>
</pre></div>
</div>
<p>Snort <code class="docutils literal notranslate"><span class="pre">http_cookie</span></code> buffer contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">monsterelmo</span>
</pre></div>
</div>
</li>
<li><p class="first">Corresponding PCRE modifier: <code class="docutils literal notranslate"><span class="pre">C</span></code> (same as Snort)</p>
</li>
</ul>
</div>
<div class="section" id="new-http-keywords">
<h4>New HTTP keywords<a class="headerlink" href="#new-http-keywords" title="Permalink to this headline">¶</a></h4>
<p>Suricata supports several HTTP keywords that Snort doesn't have.</p>
<p>Examples are <code class="docutils literal notranslate"><span class="pre">http_user_agent</span></code>, <code class="docutils literal notranslate"><span class="pre">http_host</span></code> and <code class="docutils literal notranslate"><span class="pre">http_content_type</span></code>.</p>
<p>See <a class="reference internal" href="index.html#document-rules/http-keywords"><span class="doc">HTTP Keywords</span></a> for all HTTP keywords.</p>
</div>
<div class="section" id="byte-extract-keyword">
<h4><code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> Keyword<a class="headerlink" href="#byte-extract-keyword" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Suricata supports
<code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> from <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffers, including
<code class="docutils literal notranslate"><span class="pre">http_header</span></code> which does not always work as expected in Snort.</li>
<li>In Suricata, variables extracted using <code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> must be used
in the same buffer, otherwise they will have the value &quot;0&quot; (zero). Snort
does allow cross-buffer byte extraction and usage.</li>
<li>Be sure to always positively and negatively test Suricata rules that
use <code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> and <code class="docutils literal notranslate"><span class="pre">byte_test</span></code> to verify that they
work as expected.</li>
</ul>
</div>
<div class="section" id="byte-jump-keyword">
<h4><code class="docutils literal notranslate"><span class="pre">byte_jump</span></code> Keyword<a class="headerlink" href="#byte-jump-keyword" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Suricata allows a variable name from <code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> or
<code class="docutils literal notranslate"><span class="pre">byte_math</span></code> to be specified for the <code class="docutils literal notranslate"><span class="pre">nbytes</span></code> value. The
value of <code class="docutils literal notranslate"><span class="pre">nbytes</span></code> must adhere to the same constraints
as if it were supplied directly in the rule.</li>
</ul>
</div>
<div class="section" id="byte-math-keyword">
<h4><code class="docutils literal notranslate"><span class="pre">byte_math</span></code> Keyword<a class="headerlink" href="#byte-math-keyword" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Suricata accepts <code class="docutils literal notranslate"><span class="pre">dce</span></code> as an endian value or as a separate keyword.
<code class="docutils literal notranslate"><span class="pre">endian</span> <span class="pre">dce</span></code> or <code class="docutils literal notranslate"><span class="pre">dce</span></code> are equivalent.</li>
<li>Suricata's rule parser rejects rules that repeat keywords in a single
rule. E.g., <code class="docutils literal notranslate"><span class="pre">byte_math:</span> <span class="pre">endian</span> <span class="pre">big,</span> <span class="pre">endian</span> <span class="pre">little</span></code>.</li>
<li>Suricata's rule parser accepts <code class="docutils literal notranslate"><span class="pre">rvalue</span></code> values of <code class="docutils literal notranslate"><span class="pre">0</span></code> to the maximum
uint32 value. Snort rejects <code class="docutils literal notranslate"><span class="pre">rvalue</span></code> values of <code class="docutils literal notranslate"><span class="pre">0</span></code> and requires
values to be between <code class="docutils literal notranslate"><span class="pre">[1..max-uint32</span> <span class="pre">value]</span></code>.</li>
<li>Suricata will never match if there's a zero divisor. Division by 0 is undefined.</li>
</ul>
</div>
<div class="section" id="byte-test-keyword">
<h4><code class="docutils literal notranslate"><span class="pre">byte_test</span></code> Keyword<a class="headerlink" href="#byte-test-keyword" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Suricata allows a variable name from <code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> or <code class="docutils literal notranslate"><span class="pre">byte_math</span></code>
to be specified for the <code class="docutils literal notranslate"><span class="pre">nbytes</span></code> value. The value of <code class="docutils literal notranslate"><span class="pre">nbytes</span></code> must adhere
to the same constraints as though a value was directly supplied by the rule.</li>
<li>Suricata allows a variable name from <code class="docutils literal notranslate"><span class="pre">byte_extract</span></code> to be specified for
the <code class="docutils literal notranslate"><span class="pre">nbytes</span></code> value. The value of <code class="docutils literal notranslate"><span class="pre">nbytes</span></code> must adhere to the same constraints
as if it were supplied directly in the rule.</li>
</ul>
</div>
<div class="section" id="isdataat-keyword">
<h4><code class="docutils literal notranslate"><span class="pre">isdataat</span></code> Keyword<a class="headerlink" href="#isdataat-keyword" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">rawbytes</span></code> keyword is supported in the Suricata syntax but
doesn't actually do anything.</p>
</li>
<li><p class="first">Absolute <code class="docutils literal notranslate"><span class="pre">isdataat</span></code> checks will succeed if the offset used is
<strong>less than</strong> the size of the inspection buffer.  This is true for
Suricata and Snort.</p>
</li>
<li><p class="first">For <em>relative</em> <code class="docutils literal notranslate"><span class="pre">isdataat</span></code> checks, there is a <strong>1 byte difference</strong>
in the way Snort and Suricata do the comparisons.</p>
<ul class="simple">
<li>Suricata will succeed if the relative offset is <strong>less than or
equal to</strong> the size of the inspection buffer. This is different
from absolute <code class="docutils literal notranslate"><span class="pre">isdataat</span></code> checks.</li>
<li>Snort will succeed if the relative offset is <strong>less than</strong> the
size of the inspection buffer, just like absolute <code class="docutils literal notranslate"><span class="pre">isdataat</span></code>
checks.</li>
<li>Example - to check that there is no data in the inspection buffer
after the last content match:<ul>
<li>Snort:        <code class="docutils literal notranslate"><span class="pre">isdataat:!0,relative;</span></code></li>
<li>Suricata:     <code class="docutils literal notranslate"><span class="pre">isdataat:!1,relative;</span></code></li>
</ul>
</li>
</ul>
</li>
<li><p class="first">With Snort, the &quot;inspection buffer&quot; used when checking an
<code class="docutils literal notranslate"><span class="pre">isdataat</span></code> keyword is generally the packet/segment with some
exceptions:</p>
<ul class="simple">
<li>With PAF enabled the PDU is examined instead of the
packet/segment.  When <code class="docutils literal notranslate"><span class="pre">file_data</span></code> or <code class="docutils literal notranslate"><span class="pre">base64_data</span></code> has
been set, it is those buffers (unless <code class="docutils literal notranslate"><span class="pre">rawbytes</span></code> is set).</li>
<li>With some preprocessors - modbus, gtp, sip, dce2, and dnp3 - the
buffer can be particular portions of those protocols (unless
<code class="docutils literal notranslate"><span class="pre">rawbytes</span></code> is set).</li>
<li>With some preprocessors - rpc_decode, ftp_telnet, smtp, and dnp3
- the buffer can be particular <em>decoded</em> portions of those
protocols (unless <code class="docutils literal notranslate"><span class="pre">rawbytes</span></code> is set).</li>
</ul>
</li>
<li><p class="first">With Suricata, the &quot;inspection buffer&quot; used when checking an absolute
<code class="docutils literal notranslate"><span class="pre">isdataat</span></code> keyword is the packet/segment if looking at a packet
(e.g. <code class="docutils literal notranslate"><span class="pre">alert</span> <span class="pre">tcp-pkt...</span></code>) or the reassembled stream segments.</p>
</li>
<li><p class="first">In Suricata, a <em>relative</em> <code class="docutils literal notranslate"><span class="pre">isdataat</span></code> keyword <strong>will apply to the
buffer of the previous content match</strong>.  So if the previous content
match is a <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffer, the relative <code class="docutils literal notranslate"><span class="pre">isdataat</span></code>
applies to that buffer, starting from the end of the previous content
match in that buffer.  <em>Snort does not behave like this!</em></p>
</li>
<li><p class="first">For example, this Suricata rule looks for the string &quot;.exe&quot; at the
end of the URI; to do the same thing in the normalized URI buffer in
Snort you would have to use a PCRE – <code class="docutils literal notranslate"><span class="pre">pcre:&quot;/\x2Eexe$/U&quot;;</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;.EXE File Download Request&quot;; flow:established,to_server; content:&quot;GET&quot;; http_method; content:&quot;.exe&quot;; http_uri; isdataat:!1,relative; priority:3; sid:18332111;)
</pre></div>
</div>
</li>
<li><p class="first">If you are unclear about behavior in a particular instance, you are
encouraged to positively and negatively test your rules that use an
<code class="docutils literal notranslate"><span class="pre">isdataat</span></code> keyword.</p>
</li>
</ul>
</div>
<div class="section" id="relative-pcre">
<h4>Relative PCRE<a class="headerlink" href="#relative-pcre" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">You can do relative PCRE matches in normalized/special buffers with Suricata.  Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;.php?sign=&quot;</span><span class="p">;</span> <span class="n">http_uri</span><span class="p">;</span> <span class="n">pcre</span><span class="p">:</span><span class="s2">&quot;/^[a-zA-Z0-9]</span><span class="si">{8}</span><span class="s2">$/UR&quot;</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">With Snort you can't combine the &quot;relative&quot; PCRE option ('R') with other buffer options like normalized URI ('U') – you get a syntax error.</p>
</li>
</ul>
</div>
<div class="section" id="tls-keywords">
<h4><code class="docutils literal notranslate"><span class="pre">tls*</span></code> Keywords<a class="headerlink" href="#tls-keywords" title="Permalink to this headline">¶</a></h4>
<p>In addition to TLS protocol identification, Suricata supports the storing of
certificates to disk, verifying the validity dates on certificates, matching
against the calculated SHA1 fingerprint of certificates, and
matching on certain TLS/SSL certificate fields including the following:</p>
<ul class="simple">
<li>Negotiated TLS/SSL version.</li>
<li>Certificate Subject field.</li>
<li>Certificate Issuer field.</li>
<li>Certificate SNI Field</li>
</ul>
<p>For details see <a class="reference internal" href="index.html#document-rules/tls-keywords"><span class="doc">SSL/TLS Keywords</span></a>.</p>
</div>
<div class="section" id="dns-query-keyword">
<h4><code class="docutils literal notranslate"><span class="pre">dns_query</span></code> Keyword<a class="headerlink" href="#dns-query-keyword" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Sets the detection pointer to the DNS query.</li>
<li>Works like <code class="docutils literal notranslate"><span class="pre">file_data</span></code> does (&quot;sticky buffer&quot;) but for a DNS
request query.</li>
<li>Use <code class="docutils literal notranslate"><span class="pre">pkt_data</span></code> to reset the detection pointer to the beginning of
the packet payload.</li>
<li>See <a class="reference internal" href="index.html#document-rules/dns-keywords"><span class="doc">DNS Keywords</span></a> for details.</li>
</ul>
</div>
<div class="section" id="ip-reputation-and-iprep-keyword">
<h4>IP Reputation and <code class="docutils literal notranslate"><span class="pre">iprep</span></code> Keyword<a class="headerlink" href="#ip-reputation-and-iprep-keyword" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Snort has the &quot;reputation&quot; preprocessor that can be used to define
whitelist and blacklist files of IPs which are used generate GID 136
alerts as well as block/drop/pass traffic from listed IPs depending
on how it is configured.</li>
<li>Suricata also has the concept of files with IPs in them but provides
the ability to assign them:<ul>
<li>Categories</li>
<li>Reputation score</li>
</ul>
</li>
<li>Suricata rules can leverage these IP lists with the <code class="docutils literal notranslate"><span class="pre">iprep</span></code>
keyword that can be configured to match on:<ul>
<li>Direction</li>
<li>Category</li>
<li>Value (reputation score)</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#document-reputation/index"><span class="doc">Reputation</span></a></li>
<li><a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-config"><span class="doc">IP Reputation Config</span></a></li>
<li><a class="reference internal" href="index.html#document-rules/ip-reputation-rules"><span class="doc">IP Reputation Keyword</span></a></li>
<li><a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-format"><span class="doc">IP Reputation Format</span></a></li>
<li><a class="reference external" href="https://blog.inliniac.net/2012/11/21/ip-reputation-in-suricata/">https://blog.inliniac.net/2012/11/21/ip-reputation-in-suricata/</a></li>
</ul>
</div>
<div class="section" id="flowbits">
<h4>Flowbits<a class="headerlink" href="#flowbits" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Suricata fully supports the setting and checking of flowbits
(including the same flowbit) on the same packet/stream.  Snort does
not always allow for this.</li>
<li>In Suricata, <code class="docutils literal notranslate"><span class="pre">flowbits:isset</span></code> is checked after the fast pattern
match but before other <code class="docutils literal notranslate"><span class="pre">content</span></code> matches. In Snort,
<code class="docutils literal notranslate"><span class="pre">flowbits:isset</span></code> is checked in the order it appears in the
rule, from left to right.</li>
<li>If there is a chain of flowbits where multiple rules set flowbits and
they are dependent on each other, then the order of the rules or the
<code class="docutils literal notranslate"><span class="pre">sid</span></code> values can make a
difference in the rules being evaluated in the proper order and
generating alerts as expected.  See bug 1399 -
<a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/1399">https://redmine.openinfosecfoundation.org/issues/1399</a>.</li>
<li><a class="reference internal" href="index.html#document-rules/flow-keywords"><span class="doc">Flow Keywords</span></a></li>
</ul>
</div>
<div class="section" id="flowbits-noalert">
<h4>flowbits:noalert;<a class="headerlink" href="#flowbits-noalert" title="Permalink to this headline">¶</a></h4>
<p>A common pattern in existing rules is to use <code class="docutils literal notranslate"><span class="pre">flowbits:noalert;</span></code> to make
sure a rule doesn't generate an alert if it matches.</p>
<p>Suricata allows using just <code class="docutils literal notranslate"><span class="pre">noalert;</span></code> as well. Both have an identical meaning
in Suricata.</p>
</div>
<div class="section" id="negated-content-match-special-case">
<h4>Negated Content Match Special Case<a class="headerlink" href="#negated-content-match-special-case" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">For Snort, a <em>negated</em> content match where the starting point for
searching is at or beyond the end of the inspection buffer will never
return true.</p>
<ul class="simple">
<li>For negated matches, you want it to return true if the content is
not found.</li>
<li>This is believed to be a Snort bug rather than an engine difference
but it was reported to Sourcefire and acknowledged many years ago
indicating that perhaps it is by design.</li>
<li>This is not the case for Suricata which behaves as
expected.</li>
</ul>
<blockquote>
<div><p>Example HTTP request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">9</span>

<span class="n">user</span><span class="o">=</span><span class="n">suri</span>
</pre></div>
</div>
<p>This rule snippet will never return true in Snort but will in
Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>content:!&quot;snort&quot;; offset:10; http_client_body;
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="file-extraction">
<h4>File Extraction<a class="headerlink" href="#file-extraction" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Suricata has the ability to match on files from FTP, HTTP and SMTP streams and
log them to disk.</li>
<li>Snort has the &quot;file&quot; preprocessor that can do something similar
but it is experimental, development of it
has been stagnant for years, and it is not something that should be used
in a production environment.</li>
<li>Files can be matched on using a number of keywords including:<ul>
<li><code class="docutils literal notranslate"><span class="pre">filename</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">fileext</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">filemagic</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">filesize</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">filemd5</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">filesha1</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">filesha256</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">filesize</span></code></li>
<li>See <a class="reference internal" href="index.html#document-rules/file-keywords"><span class="doc">File Keywords</span></a> for a full list.</li>
</ul>
</li>
<li>The <code class="docutils literal notranslate"><span class="pre">filestore</span></code> keyword tells Suricata to save the file to
disk.</li>
<li>Extracted files are logged to disk with meta data that includes
things like timestamp, src/dst IP, protocol, src/dst port, HTTP URI,
HTTP Host, HTTP Referer, filename, file magic, md5sum, size, etc.</li>
<li>There are a number of configuration options and considerations (such
as stream reassembly depth and libhtp body-limit) that should be
understood if you want fully utilize file extraction in Suricata.</li>
<li><a class="reference internal" href="index.html#document-rules/file-keywords"><span class="doc">File Keywords</span></a></li>
<li><a class="reference internal" href="index.html#document-file-extraction/file-extraction"><span class="doc">File Extraction</span></a></li>
<li><a class="reference external" href="https://blog.inliniac.net/2011/11/29/file-extraction-in-suricata/">https://blog.inliniac.net/2011/11/29/file-extraction-in-suricata/</a></li>
<li><a class="reference external" href="https://blog.inliniac.net/2014/11/11/smtp-file-extraction-in-suricata/">https://blog.inliniac.net/2014/11/11/smtp-file-extraction-in-suricata/</a></li>
</ul>
</div>
<div class="section" id="lua-scripting">
<h4>Lua Scripting<a class="headerlink" href="#lua-scripting" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Suricata has the <code class="docutils literal notranslate"><span class="pre">lua</span></code> (or <code class="docutils literal notranslate"><span class="pre">luajit</span></code>) keyword which allows for a
rule to reference a Lua script that can access the packet, payload,
HTTP buffers, etc.</li>
<li>Provides powerful flexibility and capabilities that Snort does
not have.</li>
<li>More details in: <a class="reference internal" href="index.html#lua-detection"><span class="std std-ref">Lua Scripting for Detection</span></a></li>
</ul>
</div>
<div class="section" id="fast-pattern">
<h4>Fast Pattern<a class="headerlink" href="#fast-pattern" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Snort's fast pattern matcher is always case insensitive; Suricata's
is case sensitive unless 'nocase' is set on the content match used by
the fast pattern matcher.</li>
<li>Snort will truncate fast pattern matches based on the
<code class="docutils literal notranslate"><span class="pre">max-pattern-len</span></code> config (default no limit) unless
<code class="docutils literal notranslate"><span class="pre">fast_pattern:only</span></code> is used in the rule. Suricata does not do any
automatic fast pattern truncation cannot be configured to do so.</li>
<li>Just like in Snort, in Suricata you can specify a substring of the
content string to be use as the fast pattern match. e.g.
<code class="docutils literal notranslate"><span class="pre">fast_pattern:5,20;</span></code></li>
<li>In Snort, leading NULL bytes (0x00) will be removed from content
matches when determining/using the longest content match unless
<code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code> is explicitly set. Suricata does not truncate
anything, including NULL bytes.</li>
<li>Snort does not allow for all <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffers to be used for
the fast pattern match (e.g. <code class="docutils literal notranslate"><span class="pre">http_raw_*</span></code>, <code class="docutils literal notranslate"><span class="pre">http_method</span></code>,
<code class="docutils literal notranslate"><span class="pre">http_cookie</span></code>, etc.).  Suricata lets you use any 'http_*'
buffer you want for the fast pattern match, including
<code class="docutils literal notranslate"><span class="pre">http_raw_*'</span> <span class="pre">and</span> <span class="pre">``http_cookie</span></code> buffers.</li>
<li>Suricata supports the <code class="docutils literal notranslate"><span class="pre">fast_pattern:only</span></code> syntax but
technically it is not really implemented; the <code class="docutils literal notranslate"><span class="pre">only</span></code> is
silently ignored when encountered in a rule.  It is still recommended
that you use <code class="docutils literal notranslate"><span class="pre">fast_pattern:only</span></code> where appropriate in case this
gets implemented in the future and/or if the rule will be used by
Snort as well.</li>
<li>With Snort, unless <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code> is explicitly set, content
matches in normalized HTTP Inspect buffers (e.g. http content
modifiers such <code class="docutils literal notranslate"><span class="pre">http_uri</span></code>, <code class="docutils literal notranslate"><span class="pre">http_header</span></code>, etc.) take
precedence over non-HTTP Inspect content matches, even if they are
shorter.  Suricata does the same thing and gives a higher 'priority'
(precedence) to <code class="docutils literal notranslate"><span class="pre">http_*</span></code> buffers (except for <code class="docutils literal notranslate"><span class="pre">http_method</span></code>,
<code class="docutils literal notranslate"><span class="pre">http_stat_code</span></code>, and <code class="docutils literal notranslate"><span class="pre">http_stat_msg</span></code>).</li>
<li>See <a class="reference internal" href="index.html#document-rules/fast-pattern-explained"><span class="doc">Suricata Fast Pattern Determination Explained</span></a> for full details on how Suricata
automatically determines which content to use as the fast pattern match.</li>
<li>When in doubt about what is going to be use as the fast pattern match
by Suricata, set <code class="docutils literal notranslate"><span class="pre">fast_pattern</span></code> explicitly in the rule and/or
run Suricata with the <code class="docutils literal notranslate"><span class="pre">--engine-analysis</span></code> switch and view the
generated file (<code class="docutils literal notranslate"><span class="pre">rules_fast_pattern.txt</span></code>).</li>
<li>Like Snort, the fast pattern match is checked before <code class="docutils literal notranslate"><span class="pre">flowbits</span></code>
in Suricata.</li>
<li>Using Hyperscan as the MPM matcher (<code class="docutils literal notranslate"><span class="pre">mpm-algo</span></code> setting) for Suricata
can greatly improve performance, especially when it comes to fast pattern
matching.  Hyperscan will also take into account depth and offset
when doing fast pattern matching, something the other algorithms and
Snort do not do.</li>
<li><a class="reference internal" href="index.html#rules-keyword-fast-pattern"><span class="std std-ref">fast_pattern</span></a></li>
</ul>
</div>
<div class="section" id="don-t-cross-the-streams">
<h4>Don't Cross The Streams<a class="headerlink" href="#don-t-cross-the-streams" title="Permalink to this headline">¶</a></h4>
<p>Suricata will examine network traffic as individual packets and, in the
case of TCP, as part of a (reassembled) stream.  However, there are
certain rule keywords that only apply to packets only (<code class="docutils literal notranslate"><span class="pre">dsize</span></code>,
<code class="docutils literal notranslate"><span class="pre">flags</span></code>, <code class="docutils literal notranslate"><span class="pre">ttl</span></code>) and certain ones that only apply to streams
only (<code class="docutils literal notranslate"><span class="pre">http_*</span></code>) and you can't mix packet and stream keywords. Rules
that use packet keywords will inspect individual packets only and
rules that use stream keywords will inspect streams only.  Snort is a
little more forgiving when you mix these – for example, in Snort you can
use <code class="docutils literal notranslate"><span class="pre">dsize</span></code> (a packet keyword) with <code class="docutils literal notranslate"><span class="pre">http_*</span></code> (stream
keywords) and Snort will allow it although, because of <code class="docutils literal notranslate"><span class="pre">dsize</span></code>, it
will only apply detection to individual packets (unless PAF is enabled
then it will apply it to the PDU).</p>
<p>If <code class="docutils literal notranslate"><span class="pre">dsize</span></code> is in a rule that also looks for a stream-based
application layer protocol (e.g. <code class="docutils literal notranslate"><span class="pre">http</span></code>), Suricata will not match on
the <em>first application layer packet</em> since <code class="docutils literal notranslate"><span class="pre">dsize</span></code> make Suricata
evaluate the packet and protocol detection doesn't happen until after
the protocol is checked for that packet; <em>subsequent</em> packets in that
flow should have the application protocol set appropriately and will
match rules using <code class="docutils literal notranslate"><span class="pre">dsize</span></code> and a stream-based application layer
protocol.</p>
<p>If you need to check sizes on a stream in a rule that uses a stream
keyword, or in a rule looking for a stream-based application layer
protocol, consider using the <code class="docutils literal notranslate"><span class="pre">stream_size</span></code> keyword and/or
<code class="docutils literal notranslate"><span class="pre">isdataat</span></code>.</p>
<p>Suricata also supports these protocol values being used in rules and
Snort does not:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">tcp-pkt</span></code> – example:<ul>
<li><code class="docutils literal notranslate"><span class="pre">alert</span> <span class="pre">tcp-pkt</span> <span class="pre">...</span></code></li>
<li>This tells Suricata to only apply the rule to TCP packets and not
the (reassembled) stream.</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">tcp-stream</span></code> – example:<ul>
<li><code class="docutils literal notranslate"><span class="pre">alert</span> <span class="pre">tcp-stream</span> <span class="pre">...</span></code></li>
<li>This tells Suricata to inspect the (reassembled) TCP stream only.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="alerts">
<h4>Alerts<a class="headerlink" href="#alerts" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>In Snort, the number of alerts generated for a packet/stream can be
limited by the <code class="docutils literal notranslate"><span class="pre">event_queue</span></code> configuration.</li>
<li>Suricata has an internal hard-coded limit of 15 alerts per packet/stream (and
this cannot be configured); all rules that match on the traffic being
analyzed will fire up to that limit.</li>
<li>Sometimes Suricata will generate what appears to be two alerts for
the same TCP packet.  This happens when Suricata evaluates the packet
by itself and as part of a (reassembled) stream.</li>
</ul>
</div>
<div class="section" id="buffer-reference-chart">
<h4>Buffer Reference Chart<a class="headerlink" href="#buffer-reference-chart" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="28%" />
<col width="29%" />
<col width="5%" />
<col width="11%" />
<col width="12%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Buffer</th>
<th class="head">Snort 2.9.x
Support?</th>
<th class="head">Suricata
Support?</th>
<th class="head">PCRE
flag</th>
<th class="head">Can be used as
Fast Pattern?</th>
<th class="head">Suricata Fast
Pattern Priority
(lower number is
higher priority)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>content (no modifier)</td>
<td>YES</td>
<td>YES</td>
<td>&lt;none&gt;</td>
<td>YES</td>
<td>3</td>
</tr>
<tr class="row-odd"><td>http_method</td>
<td>YES</td>
<td>YES</td>
<td>M</td>
<td>Suricata only</td>
<td>3</td>
</tr>
<tr class="row-even"><td>http_stat_code</td>
<td>YES</td>
<td>YES</td>
<td>S</td>
<td>Suricata only</td>
<td>3</td>
</tr>
<tr class="row-odd"><td>http_stat_msg</td>
<td>YES</td>
<td>YES</td>
<td>Y</td>
<td>Suricata only</td>
<td>3</td>
</tr>
<tr class="row-even"><td>uricontent</td>
<td>YES but deprecated, use http_uri instead</td>
<td>YES but deprecated, use http_uri instead</td>
<td>U</td>
<td>YES</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>http_uri</td>
<td>YES</td>
<td>YES</td>
<td>U</td>
<td>YES</td>
<td>2</td>
</tr>
<tr class="row-even"><td>http_raw_uri</td>
<td>YES</td>
<td>YES</td>
<td>I</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>http_header</td>
<td>YES</td>
<td>YES</td>
<td>H</td>
<td>YES</td>
<td>2</td>
</tr>
<tr class="row-even"><td>http_raw_header</td>
<td>YES</td>
<td>YES</td>
<td>D</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>http_cookie</td>
<td>YES</td>
<td>YES</td>
<td>C</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-even"><td>http_raw_cookie</td>
<td>YES</td>
<td>NO (use http_raw_header instead)</td>
<td>K</td>
<td>NO</td>
<td>n/a</td>
</tr>
<tr class="row-odd"><td>http_host</td>
<td>NO</td>
<td>YES</td>
<td>W</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-even"><td>http_raw_host</td>
<td>NO</td>
<td>YES</td>
<td>Z</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>http_client_body</td>
<td>YES</td>
<td>YES</td>
<td>P</td>
<td>YES</td>
<td>2</td>
</tr>
<tr class="row-even"><td>http_server_body</td>
<td>NO</td>
<td>YES</td>
<td>Q</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>http_user_agent</td>
<td>NO</td>
<td>YES</td>
<td>V</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-even"><td>dns_query</td>
<td>NO</td>
<td>YES</td>
<td>n/a*</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>tls_sni</td>
<td>NO</td>
<td>YES</td>
<td>n/a*</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-even"><td>tls_cert_issuer</td>
<td>NO</td>
<td>YES</td>
<td>n/a*</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>tls_cert_subject</td>
<td>NO</td>
<td>YES</td>
<td>n/a*</td>
<td>Suricata only</td>
<td>2</td>
</tr>
<tr class="row-even"><td>file_data</td>
<td>YES</td>
<td>YES</td>
<td>n/a*</td>
<td>YES</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>* Sticky buffer</p>
</div>
</div>
<span id="document-rules/multi-buffer-matching"></span><div class="section" id="multiple-buffer-matching">
<h3>Multiple Buffer Matching<a class="headerlink" href="#multiple-buffer-matching" title="Permalink to this headline">¶</a></h3>
<p>Suricata 7 and newer now supports matching contents in multiple
buffers within the same transaction.</p>
<p>For example a single DNS transaction that has two queries in it:</p>
<p>query 1: example.net
query 2: something.com</p>
<p>Example rule:</p>
<div class="example-rule docutils container">
<cite>alert dns $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;DNS Multiple Question Example Rule&quot;; dns.query; content:&quot;example&quot;; dns.query; content:&quot;.com&quot;; classtype:misc-activity; sid:1; rev:1;)</cite></div>
<p>Within the single DNS query transaction, there are two queries
and Suricata will set up two instances of a dns.query buffer.</p>
<p>The first <code class="docutils literal notranslate"><span class="pre">dns.query</span></code> buffer will look for content:&quot;example&quot;;</p>
<p>The second <code class="docutils literal notranslate"><span class="pre">dns.query</span></code> buffer will look for content:&quot;.com&quot;;</p>
<p>The example rule will alert on the example query since all the
content matches are satisfied for the rule.</p>
<p>For matching multiple headers in HTTP2 traffic a rule using the
new functionality would look like:</p>
<div class="example-rule docutils container">
<cite>alert http2 any any -&gt; any any (msg:&quot;HTTP2 Multiple Header Buffer Example&quot;; flow:established,to_server; http.request_header; content:&quot;method|3a 20|GET&quot;; http.request_header; content:&quot;authority|3a 20|example.com&quot;; classtype:misc-activity; sid:1; rev:1;)</cite></div>
<p>With HTTP2 there are multiple headers seen in the same flow record.
We now have a way to write a rule in a more efficient way using the
multiple buffer capability.</p>
<p><strong>Note</strong> Existing behavior when using sticky buffers still applies:</p>
<p>Example rule:</p>
<div class="example-rule docutils container">
<cite>alert dns $HOME_NET any -&gt; $EXTERNAL_NET any (msg:&quot;DNS Query Sticky Buffer Classic Example Rule&quot;; dns.query; content:&quot;example&quot;; content:&quot;.net&quot;; classtype:misc-activity; sid:1; rev:1;)</cite></div>
<p>The above rule will alert on a single dns query containing
&quot;example.net&quot; or &quot;example.domain.net&quot; since the rule content
matches are within a single <code class="docutils literal notranslate"><span class="pre">dns.query</span></code> buffer and all
content match requirements of the rule are met.</p>
<p><strong>Note:</strong> This is new behavior. In versions of Suricata prior to
version 7 multiple statements of the same sticky buffer did not
make a second instance of the buffer. For example:</p>
<p>dns.query; content:&quot;example&quot;; dns.query; content:&quot;.com&quot;;</p>
<p>would be equivalent to:</p>
<p>dns.query; content:&quot;example&quot;; content:&quot;.com&quot;;</p>
<p>Using our example from above, the first query is for example.net
which matches content:&quot;example&quot;; but does not match content:&quot;.com&quot;;</p>
<p>The second query is for something.com which would match on the
content:&quot;.com&quot;; but not the content:&quot;example&quot;;</p>
<p>So with the Suricata behavior prior to Suricata 7, the signature
would not fire in this case since both content conditions will
not be met.</p>
<p>Multiple buffer matching is currently enabled for use with the
following keywords:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">dns.query</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">file.data</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">file.magic</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">file.name</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">http.request_header</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">http.response_header</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">http2.header_name</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ike.vendor</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">krb5_cname</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">krb5_sname</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mqtt.subscribe.topic</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mqtt.unsubscribe.topic</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">quic.cyu.hash</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">quic.cyu.string</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">tls.certs</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">tls.cert_subject</span></code></li>
</ul>
</div>
</div>
</div>
<span id="document-rule-management/index"></span><div class="section" id="rule-management">
<h2>Rule Management<a class="headerlink" href="#rule-management" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-rule-management/suricata-update"></span><div class="section" id="rule-management-with-suricata-update">
<h3>Rule Management with Suricata-Update<a class="headerlink" href="#rule-management-with-suricata-update" title="Permalink to this headline">¶</a></h3>
<p>While it is possible to download and install rules manually, it is
recommended to use a management tool for this. <code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> is the
official way to update and manage rules for Suricata.</p>
<p><code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> is bundled with Suricata and is normally installed
with it. For instructions on installing manually, see <a class="reference external" href="http://suricata-update.readthedocs.io/en/latest/quickstart.html#install-suricata-update">http://suricata-update.readthedocs.io/en/latest/quickstart.html#install-suricata-update</a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> is bundled with Suricata version 4.1 and
later. It can be used with older versions as well. It will
have to be installed separately in that case.</p>
</div>
<p>To download the Emerging Threats Open ruleset, it is enough to simply run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>This will download the ruleset into <cite>/var/lib/suricata/rules/</cite></p>
<p>Suricata's configuration will have to be updated to have a rules config like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">rules</span>
<span class="n">rule</span><span class="o">-</span><span class="n">files</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">suricata</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
<p>Now (re)start Suricata.</p>
<div class="section" id="updating-your-rules">
<h4>Updating your rules<a class="headerlink" href="#updating-your-rules" title="Permalink to this headline">¶</a></h4>
<p>To update the rules, simply run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>It is recommended to update your rules frequently.</p>
</div>
<div class="section" id="using-other-rulesets">
<h4>Using other rulesets<a class="headerlink" href="#using-other-rulesets" title="Permalink to this headline">¶</a></h4>
<p>Suricata-Update is capable of making other rulesets accessible as well.</p>
<p>To see what is available, fetch the master index from the OISF hosts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span> <span class="n">update</span><span class="o">-</span><span class="n">sources</span>
</pre></div>
</div>
<p>Then have a look at what is available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span> <span class="nb">list</span><span class="o">-</span><span class="n">sources</span>
</pre></div>
</div>
<p>This will give a result similar to</p>
<img alt="_images/suricata-update.png" src="_images/suricata-update.png" />
<p>Each of the rulesets has a name that has a 'vendor' prefix, followed by a
set name. For example, OISF's traffic id ruleset is called 'oisf/trafficid'.</p>
<p>To enable 'oisf/trafficid', enter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span> <span class="n">enable</span><span class="o">-</span><span class="n">source</span> <span class="n">oisf</span><span class="o">/</span><span class="n">trafficid</span>
<span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>Now restart Suricata again and the rules from the OISF TrafficID ruleset are loaded.</p>
<p>To see which rulesets are currently active, use &quot;list-enabled-sources&quot;.</p>
</div>
<div class="section" id="controlling-which-rules-are-used">
<h4>Controlling which rules are used<a class="headerlink" href="#controlling-which-rules-are-used" title="Permalink to this headline">¶</a></h4>
<p>By default <code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> will merge all rules into a single file
&quot;/var/lib/suricata/rules/suricata.rules&quot;.</p>
<p>To enable rules that are disabled by default, use <cite>/etc/suricata/enable.conf</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2019401</span>                   <span class="c1"># enable signature with this sid</span>
<span class="n">group</span><span class="p">:</span><span class="n">emerging</span><span class="o">-</span><span class="n">icmp</span><span class="o">.</span><span class="n">rules</span> <span class="c1"># enable this rulefile</span>
<span class="n">re</span><span class="p">:</span><span class="n">trojan</span>                 <span class="c1"># enable all rules with this string</span>
</pre></div>
</div>
<p>Similarly, to disable rules use <cite>/etc/suricata/disable.conf</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2019401</span>                   <span class="c1"># disable signature with this sid</span>
<span class="n">group</span><span class="p">:</span><span class="n">emerging</span><span class="o">-</span><span class="n">info</span><span class="o">.</span><span class="n">rules</span> <span class="c1"># disable this rulefile</span>
<span class="n">re</span><span class="p">:</span><span class="n">heartbleed</span>             <span class="c1"># disable all rules with this string</span>
</pre></div>
</div>
<p>After updating these files, rerun <code class="docutils literal notranslate"><span class="pre">suricata-update</span></code> again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>Finally restart Suricata.</p>
</div>
<div class="section" id="further-reading">
<h4>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h4>
<p>See <a class="reference external" href="https://suricata-update.readthedocs.io/en/latest/">https://suricata-update.readthedocs.io/en/latest/</a></p>
</div>
</div>
<span id="document-rule-management/adding-your-own-rules"></span><div class="section" id="adding-your-own-rules">
<h3>Adding Your Own Rules<a class="headerlink" href="#adding-your-own-rules" title="Permalink to this headline">¶</a></h3>
<p>If you would like to create a rule yourself and use it with Suricata,
this guide might be helpful.</p>
<p>Start creating a file for your rule. Use one of the following examples in
your console/terminal window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="n">local</span><span class="o">.</span><span class="n">rules</span>
<span class="n">sudo</span> <span class="n">vim</span> <span class="n">local</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
<p>Write your rule, see <a class="reference internal" href="index.html#document-rules/intro"><span class="doc">Rules Format</span></a> and save it.</p>
<p>Update the Suricata configuration file so your rule is included. Use
one of the following examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">sudo</span> <span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>and make sure your local.rules file is added to the list of rules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">rules</span>

<span class="n">rule</span><span class="o">-</span><span class="n">files</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">suricata</span><span class="o">.</span><span class="n">rules</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
<p>Now, run Suricata and see if your rule is being loaded.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">wlan0</span>
</pre></div>
</div>
<p>If the rule failed to load, Suricata will display as much information as
it has when it deemed the rule un-loadable. Pay special attention to the
details: look for mistakes in special characters, spaces, capital characters,
etc.</p>
<p>Next, check if your log-files are enabled in the Suricata configuration file
<code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code>.</p>
<p>If you had to correct your rule and/or modify Suricata's YAML configuration
file, you'll have to restart Suricata.</p>
<p>If you see your rule is successfully loaded, you can double check your
rule by doing something that should trigger it.</p>
<p>By default, Suricata will log alerts to two places</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">eve.json</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">fast.log</span></code></li>
</ul>
<p>These files will be located in the log output directory which is set by
one of two methods:</p>
<ol class="arabic simple">
<li>Suricata configuration file: see <code class="docutils literal notranslate"><span class="pre">default-log-dir</span></code> for the name of the directory</li>
<li>Suricata command line: Using <code class="docutils literal notranslate"><span class="pre">-l</span> <span class="pre">/path/to/log-dir</span></code> creates log files in the named
directory.</li>
</ol>
<p>The following example assumes that the log directory is named <code class="docutils literal notranslate"><span class="pre">/var/log/suricata</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">fast</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>If you would make a rule like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Do not read gossip during work&quot;</span><span class="p">;</span>
<span class="n">content</span><span class="p">:</span><span class="s2">&quot;Scarlett&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span> <span class="n">classtype</span><span class="p">:</span><span class="n">policy</span><span class="o">-</span><span class="n">violation</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Your alert should look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">09</span><span class="o">/</span><span class="mi">15</span><span class="o">/</span><span class="mi">2011</span><span class="o">-</span><span class="mi">16</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mf">27.725288</span>  <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">read</span> <span class="n">gossip</span> <span class="n">during</span> <span class="n">work</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span>
<span class="p">[</span><span class="n">Classification</span><span class="p">:</span> <span class="n">Potential</span> <span class="n">Corporate</span> <span class="n">Privacy</span> <span class="n">Violation</span><span class="p">]</span> <span class="p">[</span><span class="n">Priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span><span class="n">TCP</span><span class="p">}</span> <span class="mf">192.168.0.32</span><span class="p">:</span><span class="mi">55604</span> <span class="o">-&gt;</span> <span class="mf">68.67.185.210</span><span class="p">:</span><span class="mi">80</span>
</pre></div>
</div>
</div>
<span id="document-rule-management/rule-reload"></span><div class="section" id="rule-reloads">
<h3>Rule Reloads<a class="headerlink" href="#rule-reloads" title="Permalink to this headline">¶</a></h3>
<p>Suricata can reload the rules without restarting. This way, there
is minimal service disruption.</p>
<p>This works by sending Suricata a signal or by using the unix socket. When Suricata is told to reload the rules these are the basic steps it takes:</p>
<ul class="simple">
<li>Load new config to update rule variables and values.</li>
<li>Load new rules</li>
<li>Construct new detection engine</li>
<li>Swap old and new detection engines</li>
<li>Make sure all threads are updated</li>
<li>Free old detection engine</li>
</ul>
<p>Suricata will continue to process packets normally during this process. Keep in mind though, that the system should have enough memory for both detection engines.</p>
<p>Signal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kill -USR2 $(pidof suricata)
</pre></div>
</div>
<p>There are two methods available when using the Unix socket.</p>
<p>Blocking reload</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">reload</span><span class="o">-</span><span class="n">rules</span>
</pre></div>
</div>
<p>Non blocking reload</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ruleset</span><span class="o">-</span><span class="n">reload</span><span class="o">-</span><span class="n">nonblocking</span>
</pre></div>
</div>
<p>It is also possible to get information about the last reload via dedicated commands. See <a class="reference internal" href="index.html#standard-unix-socket-commands"><span class="std std-ref">Commands in standard running mode</span></a> for more information.</p>
</div>
<span id="document-rule-management/rule-profiling"></span><div class="section" id="rules-profiling">
<h3>Rules Profiling<a class="headerlink" href="#rules-profiling" title="Permalink to this headline">¶</a></h3>
<p>If Suricata is built with the <cite>--enable-profiling-rules</cite> then the ruleset profiling
can be activated on demand from the unix socket and dumped from it.</p>
<p>To start profiling</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">surictasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ruleset</span><span class="o">-</span><span class="n">profile</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<p>To stop profiling</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">surictasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ruleset</span><span class="o">-</span><span class="n">profile</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<p>To dump profiling</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ruleset</span><span class="o">-</span><span class="n">profile</span>
</pre></div>
</div>
<p>A typical scenario to get rules performance would be</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">surictasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ruleset</span><span class="o">-</span><span class="n">profile</span><span class="o">-</span><span class="n">start</span>
<span class="n">sleep</span> <span class="mi">30</span>
<span class="n">surictasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ruleset</span><span class="o">-</span><span class="n">profile</span><span class="o">-</span><span class="n">stop</span>
<span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ruleset</span><span class="o">-</span><span class="n">profile</span>
</pre></div>
</div>
<p>On busy systems, using the sampling capability to capture performance
on a subset of packets can be obtained via the <cite>sample-rate</cite> variable
in the <cite>profiling</cite> section in the <cite>suricata.yaml</cite> file.</p>
</div>
</div>
</div>
<span id="document-make-sense-alerts"></span><div class="section" id="making-sense-out-of-alerts">
<h2>Making sense out of Alerts<a class="headerlink" href="#making-sense-out-of-alerts" title="Permalink to this headline">¶</a></h2>
<p>When an alert happens it's important to figure out what it means. Is it
serious? Relevant? A false positive?</p>
<p>To find out more about the rule that fired, it's always a good idea to
look at the actual rule.</p>
<p>The first thing to look at in a rule is the description that follows
the <code class="docutils literal notranslate"><span class="pre">msg</span></code> keyword. Let's consider an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;ET SCAN sipscan probe&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>The &quot;ET&quot; indicates the rule came from the Emerging Threats (Proofpoint)
project. &quot;SCAN&quot; indicates the purpose of the rule is to match on some
form of scanning. Following that, a more or less detailed description
is given.</p>
<p>Most rules contain some pointers to more information in the form of
the &quot;reference&quot; keyword.</p>
<p>Consider the following example rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET $HTTP_PORTS \
  (msg:&quot;ET CURRENT_EVENTS Adobe 0day Shovelware&quot;; \
  flow:established,to_server; content:&quot;GET &quot;; nocase; depth:4; \
  content:!&quot;|0d 0a|Referer\:&quot;; nocase; \
  uricontent:&quot;/ppp/listdir.php?dir=&quot;; \
  pcre:&quot;/\/[a-z]{2}\/[a-z]{4}01\/ppp\/listdir\.php\?dir=/U&quot;; \
  classtype:trojan-activity; \
  reference:url,isc.sans.org/diary.html?storyid=7747; \
  reference:url,doc.emergingthreats.net/2010496; \
  reference:url,www.emergingthreats.net/cgi-bin/cvsweb.cgi/sigs/CURRENT_EVENTS/CURRENT_Adobe; \
  sid:2010496; rev:2;)
</pre></div>
</div>
<p>In this rule, the reference keyword indicates 3 urls to visit for more
information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>isc.sans.org/diary.html?storyid=7747
doc.emergingthreats.net/2010496
www.emergingthreats.net/cgi-bin/cvsweb.cgi/sigs/CURRENT_EVENTS/CURRENT_Adobe
</pre></div>
</div>
<p>Some rules contain a reference like: <code class="docutils literal notranslate"><span class="pre">&quot;reference:cve,2009-3958;&quot;</span></code> should
allow you to find info about the specific CVE using your favorite
search engine.</p>
<p>It's not always straight forward and sometimes not all of that
information is available publicly. Usually asking about it on the
signature support channel can be helpful.</p>
<p>In <a class="reference internal" href="index.html#document-rule-management/suricata-update"><span class="doc">Rule Management with Suricata-Update</span></a> more information on the rule
sources and their documentation and support methods can be found.</p>
<p>In many cases, looking at just the alert and the packet that triggered
it won't be enough to be conclusive. When using the default Eve settings
a lot of metadata will be added to the alert.</p>
<p>For example, if a rule fired that indicates your web application is
attacked, looking at the metadata might reveal that the web
application replied with <code class="docutils literal notranslate"><span class="pre">404</span> <span class="pre">not</span> <span class="pre">found</span></code>. This will usually mean the
attack failed but not always.</p>
<p>Not every protocol leads to metadata generation, so when running an
IDS engine like Suricata, it's often recommended to combine it with
full packet capture. Using tools like Evebox, Sguil or Snorby, the
full TCP session or UDP flow can be inspected.</p>
<p>Obviously there is a lot more to Incidence Response, but this should
get you started.</p>
</div>
<span id="document-performance/index"></span><div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-performance/runmodes"></span><div class="section" id="runmodes">
<h3>Runmodes<a class="headerlink" href="#runmodes" title="Permalink to this headline">¶</a></h3>
<p>Suricata consists of several 'building blocks' called threads,
thread-modules and queues.  A thread is like a process that runs on a
computer. Suricata is multi-threaded, so multiple threads are active
at once.  A thread-module is a part of a functionality. One module is
for example for decoding a packet, another is the detect-module and
another one the output-module.  A packet can be processed by more than
one thread. The packet will then be passed on to the next thread through
a queue. Packets will be processed by one thread at a time, but there
can be multiple packets being processed at a time by the engine (see
<a class="reference internal" href="index.html#suricata-yaml-max-pending-packets"><span class="std std-ref">Max-pending-packets</span></a>). A thread can have one or
more thread-modules. If they have more modules, they can only be
active one a a time.  The way threads, modules and queues are arranged
together is called the &quot;Runmode&quot;.</p>
<div class="section" id="different-runmodes">
<h4>Different runmodes<a class="headerlink" href="#different-runmodes" title="Permalink to this headline">¶</a></h4>
<p>You can choose a runmode out of several predefined runmodes. The
command line option <code class="docutils literal notranslate"><span class="pre">--list-runmodes</span></code> shows all available runmodes. All
runmodes have a name: single, workers, autofp.</p>
<p>Generally, the <code class="docutils literal notranslate"><span class="pre">workers</span></code> runmode performs the best. In this mode the
NIC/driver makes sure packets are properly balanced over Suricata's
processing threads. Each packet processing thread then contains the
full packet pipeline.</p>
<img alt="_images/workers.png" src="_images/workers.png" />
<p>For processing PCAP files, or in case of certain IPS setups (like NFQ),
<code class="docutils literal notranslate"><span class="pre">autofp</span></code> is used. Here there are one or more capture threads, that
capture the packet and do the packet decoding, after which it is passed
on to the <code class="docutils literal notranslate"><span class="pre">flow</span> <span class="pre">worker</span></code> threads.</p>
<img alt="_images/autofp1.png" src="_images/autofp1.png" />
<img alt="_images/autofp2.png" src="_images/autofp2.png" />
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">single</span></code> runmode is the same as the <code class="docutils literal notranslate"><span class="pre">workers</span></code> mode,
however there is only a single packet processing thread. This is mostly
useful during development.</p>
<img alt="_images/single.png" src="_images/single.png" />
<p>For more information about the command line options concerning the
runmode, see <a class="reference internal" href="index.html#document-command-line-options"><span class="doc">Command Line Options</span></a>.</p>
</div>
<div class="section" id="load-balancing">
<h4>Load balancing<a class="headerlink" href="#load-balancing" title="Permalink to this headline">¶</a></h4>
<p>Suricata may use different ways to load balance the packets to process
between different threads with the configuration option <cite>autofp-scheduler</cite>.</p>
<p>The default value is <cite>hash</cite>, which means the packet is assigned to threads
using the 5-7 tuple hash, which is also used anyways to store the flows
in memory.</p>
<p>This option can also be set to
- <cite>ippair</cite> : packets are assigned to threads using addresses only.
- <cite>ftp-hash</cite> : same as <cite>hash</cite> except for flows that may be ftp or ftp-data
so that these flows get processed by the same thread. Like so, there is no
concurrency issue in recognizing ftp-data flows due to processing them
before the ftp flow got processed. In case of such a flow, a variant of the
hash is used.</p>
</div>
</div>
<span id="document-performance/packet-capture"></span><div class="section" id="packet-capture">
<h3>Packet Capture<a class="headerlink" href="#packet-capture" title="Permalink to this headline">¶</a></h3>
<div class="section" id="load-balancing">
<h4>Load balancing<a class="headerlink" href="#load-balancing" title="Permalink to this headline">¶</a></h4>
<p>To get the best performance, Suricata will need to run in 'workers' mode. This effectively means that there are multiple threads, each running a full packet pipeline and each receiving packets from the capture method. This means that we rely on the capture method to distribute the packets over the various threads. One critical aspect of this is that Suricata needs to get both sides of a flow in the same thread, in the correct order.</p>
<p>The AF_PACKET and PF_RING capture methods both have options to select the 'cluster-type'. These default to 'cluster_flow' which instructs the capture method to hash by flow (5 tuple). This hash is symmetric. Netmap does not have a cluster_flow mode built-in. It can be added separately by using the &quot;'lb' tool&quot;:<a class="reference external" href="https://github.com/luigirizzo/netmap/tree/master/apps/lb">https://github.com/luigirizzo/netmap/tree/master/apps/lb</a></p>
<p>On multi-queue NICs, which is almost any modern NIC, RSS settings need to be considered.</p>
</div>
<div class="section" id="rss">
<h4>RSS<a class="headerlink" href="#rss" title="Permalink to this headline">¶</a></h4>
<p>Receive Side Scaling is a technique used by network cards to distribute incoming traffic over various queues on the NIC. This is meant to improve performance but it is important to realize that it was designed for normal traffic, not for the IDS packet capture scenario. RSS using a hash algorithm to distribute the incoming traffic over the various queues. This hash is normally <em>not</em> symmetrical. This means that when receiving both sides of a flow, each side may end up in a different queue. Sadly, when deploying Suricata, this is the common scenario when using span ports or taps.</p>
<p>The problem here is that by having both sides of the traffic in different queues, the order of processing of packets becomes unpredictable. Timing differences on the NIC, the driver, the kernel and in Suricata will lead to a high chance of packets coming in at a different order than on the wire. This is specifically about a mismatch between the two traffic directions. For example, Suricata tracks the TCP 3-way handshake. Due to this timing issue, the SYN/ACK may only be received by Suricata long after the client to server side has already started sending data. Suricata would see this traffic as invalid.</p>
<p>None of the supported capture methods like AF_PACKET, PF_RING or NETMAP can fix this problem for us. It would require buffering and packet reordering which is expensive.</p>
<p>To see how many queues are configured:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ethtool -l ens2f1
Channel parameters for ens2f1:
Pre-set maximums:
RX:             0
TX:             0
Other:          1
Combined:       64
Current hardware settings:
RX:             0
TX:             0
Other:          1
Combined:       8
</pre></div>
</div>
<p>Some NIC's allow you to set it into a symmetric mode. The Intel X(L)710 card can do this in theory, but the drivers aren't capable of enabling this yet (work is underway to try to address this). Another way to address is by setting a special &quot;Random Secret Key&quot; that will make the RSS symmetrical. See <a class="reference external" href="http://www.ndsl.kaist.edu/~kyoungsoo/papers/TR-symRSS.pdf">http://www.ndsl.kaist.edu/~kyoungsoo/papers/TR-symRSS.pdf</a> (PDF).</p>
<p>In most scenario's however, the optimal solution is to reduce the number of RSS queues to 1:</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Intel X710 with i40e driver:
ethtool -L $DEV combined 1
</pre></div>
</div>
<p>Some drivers do not support setting the number of queues through ethtool. In some cases there is a module load time option. Read the driver docs for the specifics.</p>
</div>
<div class="section" id="offloading">
<h4>Offloading<a class="headerlink" href="#offloading" title="Permalink to this headline">¶</a></h4>
<p>Network cards, drivers and the kernel itself have various techniques to speed up packet handling. Generally these will all have to be disabled.</p>
<p>LRO/GRO lead to merging various smaller packets into big 'super packets'. These will need to be disabled as they break the dsize keyword as well as TCP state tracking.</p>
<p>Checksum offloading can be left enabled on AF_PACKET and PF_RING, but needs to be disabled on PCAP, NETMAP and others.</p>
</div>
<div class="section" id="recommendations">
<h4>Recommendations<a class="headerlink" href="#recommendations" title="Permalink to this headline">¶</a></h4>
<p>Read your drivers documentation! E.g. for i40e the ethtool change of RSS queues may lead to kernel panics if done wrong.</p>
<p>Generic: set RSS queues to 1 or make sure RSS hashing is symmetric. Disable NIC offloading.</p>
<p>AF_PACKET: 1 RSS queue and stay on kernel &lt;=4.2 or make sure you have &gt;=4.4.16, &gt;=4.6.5 or &gt;=4.7. Exception: if RSS is symmetric cluster-type 'cluster_qm' can be used to bind Suricata to the RSS queues. Disable NIC offloading except the rx/tx csum.</p>
<p>PF_RING: 1 RSS queue and use cluster-type 'cluster_flow'. Disable NIC offloading except the rx/tx csum.</p>
<p>NETMAP: 1 RSS queue. There is no flow based load balancing built-in, but the 'lb' tool can be helpful. Another option is to use the 'autofp' runmode. Exception: if RSS is symmetric, load balancing is based on the RSS hash and multiple RSS queues can be used. Disable all NIC offloading.</p>
</div>
</div>
<span id="document-performance/tuning-considerations"></span><div class="section" id="tuning-considerations">
<h3>Tuning Considerations<a class="headerlink" href="#tuning-considerations" title="Permalink to this headline">¶</a></h3>
<p>Settings to check for optimal performance.</p>
<div class="section" id="max-pending-packets-number">
<h4>max-pending-packets: &lt;number&gt;<a class="headerlink" href="#max-pending-packets-number" title="Permalink to this headline">¶</a></h4>
<p>This setting controls the number simultaneous packets that the engine
can handle. Setting this higher generally keeps the threads more busy,
but setting it too high will lead to degradation.</p>
<p>Suggested setting: 10000 or higher. Max is ~65000. This setting is per thread.
The memory is set up at start and the usage is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">number_of</span><span class="o">.</span><span class="n">threads</span> <span class="n">X</span> <span class="nb">max</span><span class="o">-</span><span class="n">pending</span><span class="o">-</span><span class="n">packets</span> <span class="n">X</span> <span class="p">(</span><span class="n">default</span><span class="o">-</span><span class="n">packet</span><span class="o">-</span><span class="n">size</span> <span class="o">+</span> <span class="o">~</span><span class="mi">750</span> <span class="nb">bytes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="mpm-algo-ac-hs-ac-bs-ac-ks">
<h4>mpm-algo: &lt;ac|hs|ac-bs|ac-ks&gt;<a class="headerlink" href="#mpm-algo-ac-hs-ac-bs-ac-ks" title="Permalink to this headline">¶</a></h4>
<p>Controls the pattern matcher algorithm. AC (<code class="docutils literal notranslate"><span class="pre">Aho–Corasick</span></code>) is the default.
On supported platforms, <a class="reference internal" href="index.html#document-performance/hyperscan"><span class="doc">Hyperscan</span></a> is the best option. On commodity
hardware if Hyperscan is not available the suggested setting is
<code class="docutils literal notranslate"><span class="pre">mpm-algo:</span> <span class="pre">ac-ks</span></code> (<code class="docutils literal notranslate"><span class="pre">Aho–Corasick</span></code> Ken Steele variant) as it performs better than
<code class="docutils literal notranslate"><span class="pre">mpm-algo:</span> <span class="pre">ac</span></code></p>
</div>
<div class="section" id="detect-profile-low-medium-high-custom">
<h4>detect.profile: &lt;low|medium|high|custom&gt;<a class="headerlink" href="#detect-profile-low-medium-high-custom" title="Permalink to this headline">¶</a></h4>
<p>The detection engine tries to split out separate signatures into
groups so that a packet is only inspected against signatures that can
actually match. As in large rule set this would result in way too many
groups and memory usage similar groups are merged together. The
profile setting controls how aggressive this merging is done. The default
setting of <code class="docutils literal notranslate"><span class="pre">high</span></code> usually is good enough.</p>
<p>The &quot;custom&quot; setting allows modification of the group sizes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">custom</span><span class="o">-</span><span class="n">values</span><span class="p">:</span>
  <span class="n">toclient</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span> <span class="mi">100</span>
  <span class="n">toserver</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span> <span class="mi">100</span>
</pre></div>
</div>
<p>In general, increasing will improve performance. It will lead to minimal
increase in memory usage.
The default value for <code class="docutils literal notranslate"><span class="pre">toclient-groups</span></code> and <code class="docutils literal notranslate"><span class="pre">toserver-groups</span></code> with
<code class="docutils literal notranslate"><span class="pre">detect.profile:</span> <span class="pre">high</span></code> is 75.</p>
</div>
<div class="section" id="detect-sgh-mpm-context-auto-single-full">
<h4>detect.sgh-mpm-context: &lt;auto|single|full&gt;<a class="headerlink" href="#detect-sgh-mpm-context-auto-single-full" title="Permalink to this headline">¶</a></h4>
<p>The multi pattern matcher can have it's context per signature group
(full) or globally (single). Auto selects between single and full
based on the <strong>mpm-algo</strong> selected. ac, ac-bs, ac-ks, hs default to &quot;single&quot;.
Setting this to &quot;full&quot; with <code class="docutils literal notranslate"><span class="pre">mpm-algo:</span> <span class="pre">ac</span></code> or <code class="docutils literal notranslate"><span class="pre">mpm-algo:</span> <span class="pre">ac-ks</span></code> offers
better performance. Setting this to &quot;full&quot; with <code class="docutils literal notranslate"><span class="pre">mpm-algo:</span> <span class="pre">hs</span></code> is not
recommended as it leads to much higher startup time. Instead with Hyperscan
either <code class="docutils literal notranslate"><span class="pre">detect.profile:</span> <span class="pre">high</span></code> or bigger custom group size settings can be
used as explained above which offers better performance than <code class="docutils literal notranslate"><span class="pre">ac</span></code> and
<code class="docutils literal notranslate"><span class="pre">ac-ks</span></code> even with <code class="docutils literal notranslate"><span class="pre">detect.sgh-mpm-context:</span> <span class="pre">full</span></code>.</p>
</div>
<div class="section" id="af-packet">
<h4>af-packet<a class="headerlink" href="#af-packet" title="Permalink to this headline">¶</a></h4>
<p>If using <code class="docutils literal notranslate"><span class="pre">af-packet</span></code> (default on Linux) it is recommended that af-packet v3
is used for IDS/NSM deployments. For IPS it is recommended af-packet v2. To make
sure af-packet v3 is used it can specifically be enforced it in the
<code class="docutils literal notranslate"><span class="pre">af-packet</span></code> config section of suricata.yaml like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth0</span>
   <span class="o">....</span>
   <span class="o">....</span>
   <span class="o">....</span>
   <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
   <span class="n">tpacket</span><span class="o">-</span><span class="n">v3</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
</div>
<div class="section" id="ring-size">
<h4>ring-size<a class="headerlink" href="#ring-size" title="Permalink to this headline">¶</a></h4>
<p>Ring-size is another <code class="docutils literal notranslate"><span class="pre">af-packet</span></code> variable that can be considered for tuning
and performance benefits. It basically means the buffer size for packets per
thread. So if the setting is <code class="docutils literal notranslate"><span class="pre">ring-size:</span> <span class="pre">100000</span></code> like below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth0</span>
   <span class="n">threads</span><span class="p">:</span> <span class="mi">5</span>
   <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">100000</span>
</pre></div>
</div>
<p>it means there will be 100,000 packets allowed in each buffer of the 5 threads.
If any of the buffers gets filled (for example packet processing can not keep up)
that will result in packet <code class="docutils literal notranslate"><span class="pre">drop</span></code> counters increasing in the stats logs.</p>
<p>The memory used for those is set up and dedicated at start and is calculated
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">threads</span> <span class="n">X</span> <span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">ring</span><span class="o">-</span><span class="n">size</span> <span class="n">X</span> <span class="p">(</span><span class="n">default</span><span class="o">-</span><span class="n">packet</span><span class="o">-</span><span class="n">size</span> <span class="o">+</span> <span class="o">~</span><span class="mi">750</span> <span class="nb">bytes</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">af-packet.threads</span></code>, <code class="docutils literal notranslate"><span class="pre">af-packet.ring-size</span></code>, <code class="docutils literal notranslate"><span class="pre">default-packet-size</span></code>
are the values set in suricata.yaml. Config values for example for af-packet
could be quickly displayed with on the command line as well with
<code class="docutils literal notranslate"><span class="pre">suricata</span> <span class="pre">--dump-config</span> <span class="pre">|grep</span> <span class="pre">af-packet</span></code>.</p>
</div>
<div class="section" id="stream-bypass">
<h4>stream.bypass<a class="headerlink" href="#stream-bypass" title="Permalink to this headline">¶</a></h4>
<p>Another option that can be used to improve performance is <code class="docutils literal notranslate"><span class="pre">stream.bypass</span></code>.
In the example below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="p">:</span>
 <span class="n">memcap</span><span class="p">:</span> <span class="mi">64</span><span class="n">mb</span>
 <span class="n">checksum</span><span class="o">-</span><span class="n">validation</span><span class="p">:</span> <span class="n">yes</span>      <span class="c1"># reject wrong csums</span>
 <span class="n">inline</span><span class="p">:</span> <span class="n">auto</span>                  <span class="c1"># auto will use inline mode in IPS mode, yes or no set it statically</span>
 <span class="n">bypass</span><span class="p">:</span> <span class="n">yes</span>
 <span class="n">reassembly</span><span class="p">:</span>
   <span class="n">memcap</span><span class="p">:</span> <span class="mi">256</span><span class="n">mb</span>
   <span class="n">depth</span><span class="p">:</span> <span class="mi">1</span><span class="n">mb</span>                  <span class="c1"># reassemble 1mb into a stream</span>
   <span class="n">toserver</span><span class="o">-</span><span class="n">chunk</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">2560</span>
   <span class="n">toclient</span><span class="o">-</span><span class="n">chunk</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">2560</span>
   <span class="n">randomize</span><span class="o">-</span><span class="n">chunk</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>Inspection will be skipped when <code class="docutils literal notranslate"><span class="pre">stream.reassembly.depth</span></code> of 1mb is reached for a particular flow.</p>
</div>
</div>
<span id="document-performance/hyperscan"></span><div class="section" id="hyperscan">
<h3>Hyperscan<a class="headerlink" href="#hyperscan" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>&quot;Hyperscan is a high performance regular expression matching library (...)&quot; (<a class="reference external" href="https://www.intel.com/content/www/us/en/developer/articles/technical/introduction-to-hyperscan.html">https://www.intel.com/content/www/us/en/developer/articles/technical/introduction-to-hyperscan.html</a>)</p>
<p>In Suricata it can be used to perform multi pattern matching (mpm) or single pattern matching (spm).</p>
<p>Support for hyperscan in Suricata was initially implemented by Justin Viiret and Jim Xu from Intel via <a class="reference external" href="https://github.com/OISF/suricata/pull/1965">https://github.com/OISF/suricata/pull/1965</a>.</p>
<p>Hyperscan is only for Intel x86 based processor architectures at this time. For ARM processors, vectorscan is a drop in replacement for hyperscan, <a class="reference external" href="https://github.com/VectorCamp/vectorscan">https://github.com/VectorCamp/vectorscan</a>.</p>
</div>
<div class="section" id="basic-installation-package">
<h4>Basic Installation (Package)<a class="headerlink" href="#basic-installation-package" title="Permalink to this headline">¶</a></h4>
<p>Some Linux distributions include hyperscan in their respective package collections.</p>
<p>Fedora 37+/Centos 8+: sudo dnf install hyperscan-devel
Ubuntu/Debian: sudo apt-get install libhyperscan-dev</p>
</div>
<div class="section" id="advanced-installation-source">
<h4>Advanced Installation (Source)<a class="headerlink" href="#advanced-installation-source" title="Permalink to this headline">¶</a></h4>
<p>Hyperscan has the following dependencies in order to build from
source:</p>
<ul class="simple">
<li>boost development libraries (minimum boost library version is 1.58)</li>
<li>cmake</li>
<li>C++ compiler (e.g. gcc-c++)</li>
<li>libpcap development libraries</li>
<li>pcre2 development libraries</li>
<li>python3</li>
<li>ragel</li>
<li>sqlite development libraries</li>
</ul>
<p><strong>Note:</strong> git is an additional dependency if cloning the
hyperscan GitHub repository. Otherwise downloading the
hyperscan zip from the GitHub repository will work too.</p>
<p>The steps to build and install hyperscan are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="n">hyperscan</span>
<span class="n">cd</span> <span class="n">hyperscan</span>
<span class="n">cmake</span> <span class="o">-</span><span class="n">DBUILD_STATIC_AND_SHARED</span><span class="o">=</span><span class="mi">1</span>
<span class="n">cmake</span> <span class="o">--</span><span class="n">build</span> <span class="o">./</span>
<span class="n">sudo</span> <span class="n">cmake</span> <span class="o">--</span><span class="n">install</span> <span class="o">./</span>
</pre></div>
</div>
<p><strong>Note:</strong> Hyperscan can take a a long time to build/compile.</p>
<p><strong>Note:</strong> It may be necessary to add /usr/local/lib or
/usr/local/lib64 to the <cite>ld</cite> search path. Typically this is
done by adding a file under /etc/ld.so.conf.d/ with the contents
of the directory location of libhs.so.5 (for hyperscan 5.x).</p>
</div>
<div class="section" id="using-hyperscan">
<h4>Using Hyperscan<a class="headerlink" href="#using-hyperscan" title="Permalink to this headline">¶</a></h4>
<p>Confirm that the suricata version installed has hyperscan enabled.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">info</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">Hyperscan</span>
  <span class="n">Hyperscan</span> <span class="n">support</span><span class="p">:</span>                       <span class="n">yes</span>
</pre></div>
</div>
<p>To use hyperscan support, edit the suricata.yaml.
Change the mpm-algo and spm-algo values to 'hs'.</p>
<p>Alternatively, use this command-line option: --set mpm-algo=hs --set spm-algo=hs</p>
<p><strong>Note</strong>: The default suricata.yaml configuration settings for
mpm-algo and spm-algo are &quot;auto&quot;. Suricata will use hyperscan
if it is present on the system in case of the &quot;auto&quot; setting.</p>
<p>If the current suricata installation does not have hyperscan
support, refer to <a class="reference internal" href="index.html#installation"><span class="std std-ref">Installation</span></a></p>
</div>
</div>
<span id="document-performance/high-performance-config"></span><div class="section" id="high-performance-configuration">
<h3>High Performance Configuration<a class="headerlink" href="#high-performance-configuration" title="Permalink to this headline">¶</a></h3>
<div class="section" id="nic">
<h4>NIC<a class="headerlink" href="#nic" title="Permalink to this headline">¶</a></h4>
<p>One of the major dependencies for Suricata's performance is the Network
Interface Card. There are many vendors and possibilities. Some NICs have and
require their own specific instructions and tools of how to set up the NIC.
This ensures the greatest benefit when running Suricata. Vendors like
Napatech, Netronome, Accolade, Myricom include those tools and documentation
as part of their sources.</p>
<p>For Intel, Mellanox and commodity NICs the following suggestions below could
be utilized.</p>
<p>It is recommended that the latest available stable NIC drivers are used. In
general when changing the NIC settings it is advisable to use the latest
<code class="docutils literal notranslate"><span class="pre">ethtool</span></code> version. Some NICs ship with their own <code class="docutils literal notranslate"><span class="pre">ethtool</span></code> that is
recommended to be used. Here is an example of how to set up the ethtool
if needed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="n">edge</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pub</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">ethtool</span><span class="o">/</span><span class="n">ethtool</span><span class="o">-</span><span class="mf">5.2</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">xz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">xf</span> <span class="n">ethtool</span><span class="o">-</span><span class="mf">5.2</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">xz</span>
<span class="n">cd</span> <span class="n">ethtool</span><span class="o">-</span><span class="mf">5.2</span>
<span class="o">./</span><span class="n">configure</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">clean</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">install</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">--</span><span class="n">version</span>
</pre></div>
</div>
<p>When doing high performance optimisation make sure <code class="docutils literal notranslate"><span class="pre">irqbalance</span></code> is off and
not running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">irqbalance</span> <span class="n">stop</span>
</pre></div>
</div>
<p>Depending on the NIC's available queues (for example Intel's x710/i40 has 64
available per port/interface) the worker threads can be set up accordingly.
Usually the available queues can be seen by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">l</span> <span class="n">eth1</span>
</pre></div>
</div>
<p>Some NICs - generally lower end 1Gbps - do not support symmetric hashing see
<a class="reference internal" href="index.html#document-performance/packet-capture"><span class="doc">Packet Capture</span></a>. On those systems due to considerations for out of order
packets the following setup with af-packet is suggested (the example below
uses <code class="docutils literal notranslate"><span class="pre">eth1</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">L</span> <span class="n">eth1</span> <span class="n">combined</span> <span class="mi">1</span>
</pre></div>
</div>
<p>then set up af-packet with number of desired workers threads <code class="docutils literal notranslate"><span class="pre">threads:</span> <span class="pre">auto</span></code>
(auto by default will use number of CPUs available) and
<code class="docutils literal notranslate"><span class="pre">cluster-type:</span> <span class="pre">cluster_flow</span></code> (also the default setting)</p>
<p>For higher end systems/NICs a better and more performant solution could be
utilizing the NIC itself a bit more. x710/i40 and similar Intel NICs or
Mellanox MT27800 Family [ConnectX-5] for example can easily be set up to do
a bigger chunk of the work using more RSS queues and symmetric hashing in order
to allow for increased performance on the Suricata side by using af-packet
with <code class="docutils literal notranslate"><span class="pre">cluster-type:</span> <span class="pre">cluster_qm</span></code> mode. In that mode with af-packet all packets
linked by network card to a RSS queue are sent to the same socket. Below is
an example of a suggested config set up based on a 16 core one CPU/NUMA node
socket system using x710:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rmmod</span> <span class="n">i40e</span> <span class="o">&amp;&amp;</span> <span class="n">modprobe</span> <span class="n">i40e</span>
<span class="n">ifconfig</span> <span class="n">eth1</span> <span class="n">down</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">L</span> <span class="n">eth1</span> <span class="n">combined</span> <span class="mi">16</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eth1</span> <span class="n">rxhash</span> <span class="n">on</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eth1</span> <span class="n">ntuple</span> <span class="n">on</span>
<span class="n">ifconfig</span> <span class="n">eth1</span> <span class="n">up</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">X</span> <span class="n">eth1</span> <span class="n">hkey</span> <span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span> <span class="n">equal</span> <span class="mi">16</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">A</span> <span class="n">eth1</span> <span class="n">rx</span> <span class="n">off</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">C</span> <span class="n">eth1</span> <span class="n">adaptive</span><span class="o">-</span><span class="n">rx</span> <span class="n">off</span> <span class="n">adaptive</span><span class="o">-</span><span class="n">tx</span> <span class="n">off</span> <span class="n">rx</span><span class="o">-</span><span class="n">usecs</span> <span class="mi">125</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">G</span> <span class="n">eth1</span> <span class="n">rx</span> <span class="mi">1024</span>
</pre></div>
</div>
<p>The commands above can be reviewed in detail in the help or manpages of the
<code class="docutils literal notranslate"><span class="pre">ethtool</span></code>. In brief the sequence makes sure the NIC is reset, the number of
RSS queues is set to 16, load balancing is enabled for the NIC, a low entropy
toeplitz key is inserted to allow for symmetric hashing, receive offloading is
disabled, the adaptive control is disabled for lowest possible latency and
last but not least, the ring rx descriptor size is set to 1024.
Make sure the RSS hash function is Toeplitz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">X</span> <span class="n">eth1</span> <span class="n">hfunc</span> <span class="n">toeplitz</span>
</pre></div>
</div>
<p>Let the NIC balance as much as possible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for proto in tcp4 udp4 tcp6 udp6; do
   /usr/local/sbin/ethtool -N eth1 rx-flow-hash $proto sdfn
done
</pre></div>
</div>
<p>In some cases:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/usr/local/sbin/ethtool -N eth1 rx-flow-hash $proto sd
</pre></div>
</div>
<p>might be enough or even better depending on the type of traffic. However not
all NICs allow it. The <code class="docutils literal notranslate"><span class="pre">sd</span></code> specifies the multi queue hashing algorithm of
the NIC (for the particular proto) to use src IP, dst IP only. The <code class="docutils literal notranslate"><span class="pre">sdfn</span></code>
allows for the tuple src IP, dst IP, src port, dst port to be used for the
hashing algorithm.
In the af-packet section of suricata.yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth1</span>
   <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
   <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">99</span>
   <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_qm</span>
   <span class="o">...</span>
   <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="cpu-affinity-and-numa">
<h4>CPU affinity and NUMA<a class="headerlink" href="#cpu-affinity-and-numa" title="Permalink to this headline">¶</a></h4>
<div class="section" id="intel-based-systems">
<h5>Intel based systems<a class="headerlink" href="#intel-based-systems" title="Permalink to this headline">¶</a></h5>
<p>If the system has more then one NUMA node there are some more possibilities.
In those cases it is generally recommended to use as many worker threads as
cpu cores available/possible - from the same NUMA node. The example below uses
a 72 core machine and the sniffing NIC that Suricata uses located on NUMA node 1.
In such 2 socket configurations it is recommended to have Suricata and the
sniffing NIC to be running and residing on the second NUMA node as by default
CPU 0 is widely used by many services in Linux. In a case where this is not
possible it is recommended that (via the cpu affinity config section in
suricata.yaml and the irq affinity script for the NIC) CPU 0 is never used.</p>
<p>In the case below 36 worker threads are used out of NUMA node 1's CPU,
af-packet runmode with <code class="docutils literal notranslate"><span class="pre">cluster-type:</span> <span class="pre">cluster_qm</span></code>.</p>
<p>If the CPU's NUMA set up is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lscpu</span>
<span class="n">Architecture</span><span class="p">:</span>        <span class="n">x86_64</span>
<span class="n">CPU</span> <span class="n">op</span><span class="o">-</span><span class="n">mode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>      <span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="p">,</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
<span class="n">Byte</span> <span class="n">Order</span><span class="p">:</span>          <span class="n">Little</span> <span class="n">Endian</span>
<span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>              <span class="mi">72</span>
<span class="n">On</span><span class="o">-</span><span class="n">line</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="nb">list</span><span class="p">:</span> <span class="mi">0</span><span class="o">-</span><span class="mi">71</span>
<span class="n">Thread</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">per</span> <span class="n">core</span><span class="p">:</span>  <span class="mi">2</span>
<span class="n">Core</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">per</span> <span class="n">socket</span><span class="p">:</span>  <span class="mi">18</span>
<span class="n">Socket</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>           <span class="mi">2</span>
<span class="n">NUMA</span> <span class="n">node</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>        <span class="mi">2</span>
<span class="n">Vendor</span> <span class="n">ID</span><span class="p">:</span>           <span class="n">GenuineIntel</span>
<span class="n">CPU</span> <span class="n">family</span><span class="p">:</span>          <span class="mi">6</span>
<span class="n">Model</span><span class="p">:</span>               <span class="mi">79</span>
<span class="n">Model</span> <span class="n">name</span><span class="p">:</span>          <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Xeon</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">CPU</span> <span class="n">E5</span><span class="o">-</span><span class="mi">2697</span> <span class="n">v4</span> <span class="o">@</span> <span class="mf">2.30</span><span class="n">GHz</span>
<span class="n">Stepping</span><span class="p">:</span>            <span class="mi">1</span>
<span class="n">CPU</span> <span class="n">MHz</span><span class="p">:</span>             <span class="mf">1199.724</span>
<span class="n">CPU</span> <span class="nb">max</span> <span class="n">MHz</span><span class="p">:</span>         <span class="mf">3600.0000</span>
<span class="n">CPU</span> <span class="nb">min</span> <span class="n">MHz</span><span class="p">:</span>         <span class="mf">1200.0000</span>
<span class="n">BogoMIPS</span><span class="p">:</span>            <span class="mf">4589.92</span>
<span class="n">Virtualization</span><span class="p">:</span>      <span class="n">VT</span><span class="o">-</span><span class="n">x</span>
<span class="n">L1d</span> <span class="n">cache</span><span class="p">:</span>           <span class="mi">32</span><span class="n">K</span>
<span class="n">L1i</span> <span class="n">cache</span><span class="p">:</span>           <span class="mi">32</span><span class="n">K</span>
<span class="n">L2</span> <span class="n">cache</span><span class="p">:</span>            <span class="mi">256</span><span class="n">K</span>
<span class="n">L3</span> <span class="n">cache</span><span class="p">:</span>            <span class="mi">46080</span><span class="n">K</span>
<span class="n">NUMA</span> <span class="n">node0</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>   <span class="mi">0</span><span class="o">-</span><span class="mi">17</span><span class="p">,</span><span class="mi">36</span><span class="o">-</span><span class="mi">53</span>
<span class="n">NUMA</span> <span class="n">node1</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>   <span class="mi">18</span><span class="o">-</span><span class="mi">35</span><span class="p">,</span><span class="mi">54</span><span class="o">-</span><span class="mi">71</span>
</pre></div>
</div>
<p>It is recommended that 36 worker threads are used and the NIC set up could be
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>rmmod i40e &amp;&amp; modprobe i40e
ifconfig eth1 down
/usr/local/sbin/ethtool -L eth1 combined 36
/usr/local/sbin/ethtool -K eth1 rxhash on
/usr/local/sbin/ethtool -K eth1 ntuple on
ifconfig eth1 up
./set_irq_affinity local eth1
/usr/local/sbin/ethtool -X eth1 hkey 6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A:6D:5A equal 36
/usr/local/sbin/ethtool -A eth1 rx off tx off
/usr/local/sbin/ethtool -C eth1 adaptive-rx off adaptive-tx off rx-usecs 125
/usr/local/sbin/ethtool -G eth1 rx 1024
for proto in tcp4 udp4 tcp6 udp6; do
    echo &quot;/usr/local/sbin/ethtool -N eth1 rx-flow-hash $proto sdfn&quot;
    /usr/local/sbin/ethtool -N eth1 rx-flow-hash $proto sdfn
done
</pre></div>
</div>
<p>In the example above the <code class="docutils literal notranslate"><span class="pre">set_irq_affinity</span></code> script is used from the NIC
driver's sources.
In the cpu affinity section of suricata.yaml config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Suricata is multi-threaded. Here the threading can be influenced.</span>
<span class="n">threading</span><span class="p">:</span>
 <span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
       <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;1-10&quot;</span> <span class="p">]</span>  <span class="c1"># include only these CPUs in affinity settings</span>
   <span class="o">-</span> <span class="n">receive</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
       <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;0-10&quot;</span> <span class="p">]</span>  <span class="c1"># include only these CPUs in affinity settings</span>
   <span class="o">-</span> <span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
       <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;18-35&quot;</span><span class="p">,</span> <span class="s2">&quot;54-71&quot;</span> <span class="p">]</span>
       <span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;exclusive&quot;</span>
       <span class="n">prio</span><span class="p">:</span>
         <span class="n">low</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
         <span class="n">medium</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;1&quot;</span> <span class="p">]</span>
         <span class="n">high</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;18-35&quot;</span><span class="p">,</span><span class="s2">&quot;54-71&quot;</span> <span class="p">]</span>
         <span class="n">default</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span>
</pre></div>
</div>
<p>In the af-packet section of suricata.yaml config :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth1</span>
  <span class="c1"># Number of receive threads. &quot;auto&quot; uses the number of cores</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">18</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">99</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_qm</span>
  <span class="n">defrag</span><span class="p">:</span> <span class="n">no</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">mmap</span><span class="o">-</span><span class="n">locked</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">tpacket</span><span class="o">-</span><span class="n">v3</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">100000</span>
  <span class="n">block</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">1048576</span>
<span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth1</span>
  <span class="c1"># Number of receive threads. &quot;auto&quot; uses the number of cores</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">18</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">99</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_qm</span>
  <span class="n">defrag</span><span class="p">:</span> <span class="n">no</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">mmap</span><span class="o">-</span><span class="n">locked</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">tpacket</span><span class="o">-</span><span class="n">v3</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">100000</span>
  <span class="n">block</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">1048576</span>
</pre></div>
</div>
<p>That way 36 worker threads can be mapped (18 per each af-packet interface slot)
in total per CPUs NUMA 1 range - 18-35,54-71. That part is done via the
<code class="docutils literal notranslate"><span class="pre">worker-cpu-set</span></code> affinity settings. <code class="docutils literal notranslate"><span class="pre">ring-size</span></code> and <code class="docutils literal notranslate"><span class="pre">block-size</span></code> in the
config section  above are decent default values to start with. Those can be
better adjusted if needed as explained in <a class="reference internal" href="index.html#document-performance/tuning-considerations"><span class="doc">Tuning Considerations</span></a>.</p>
</div>
<div class="section" id="amd-based-systems">
<h5>AMD based systems<a class="headerlink" href="#amd-based-systems" title="Permalink to this headline">¶</a></h5>
<p>Another example can be using an AMD based system where the architecture and
design of the system itself plus the NUMA node's interaction is different as
it is based on the HyperTransport (HT) technology. In that case per NUMA
thread/lock would not be needed. The example below shows a suggestion for such
a configuration utilising af-packet, <code class="docutils literal notranslate"><span class="pre">cluster-type:</span> <span class="pre">cluster_flow</span></code>. The
Mellanox NIC is located on NUMA 0.</p>
<p>The CPU set up is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Architecture</span><span class="p">:</span>          <span class="n">x86_64</span>
<span class="n">CPU</span> <span class="n">op</span><span class="o">-</span><span class="n">mode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>        <span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="p">,</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
<span class="n">Byte</span> <span class="n">Order</span><span class="p">:</span>            <span class="n">Little</span> <span class="n">Endian</span>
<span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>                <span class="mi">128</span>
<span class="n">On</span><span class="o">-</span><span class="n">line</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="nb">list</span><span class="p">:</span>   <span class="mi">0</span><span class="o">-</span><span class="mi">127</span>
<span class="n">Thread</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">per</span> <span class="n">core</span><span class="p">:</span>    <span class="mi">2</span>
<span class="n">Core</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">per</span> <span class="n">socket</span><span class="p">:</span>    <span class="mi">32</span>
<span class="n">Socket</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>             <span class="mi">2</span>
<span class="n">NUMA</span> <span class="n">node</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>          <span class="mi">8</span>
<span class="n">Vendor</span> <span class="n">ID</span><span class="p">:</span>             <span class="n">AuthenticAMD</span>
<span class="n">CPU</span> <span class="n">family</span><span class="p">:</span>            <span class="mi">23</span>
<span class="n">Model</span><span class="p">:</span>                 <span class="mi">1</span>
<span class="n">Model</span> <span class="n">name</span><span class="p">:</span>            <span class="n">AMD</span> <span class="n">EPYC</span> <span class="mi">7601</span> <span class="mi">32</span><span class="o">-</span><span class="n">Core</span> <span class="n">Processor</span>
<span class="n">Stepping</span><span class="p">:</span>              <span class="mi">2</span>
<span class="n">CPU</span> <span class="n">MHz</span><span class="p">:</span>               <span class="mf">1200.000</span>
<span class="n">CPU</span> <span class="nb">max</span> <span class="n">MHz</span><span class="p">:</span>           <span class="mf">2200.0000</span>
<span class="n">CPU</span> <span class="nb">min</span> <span class="n">MHz</span><span class="p">:</span>           <span class="mf">1200.0000</span>
<span class="n">BogoMIPS</span><span class="p">:</span>              <span class="mf">4391.55</span>
<span class="n">Virtualization</span><span class="p">:</span>        <span class="n">AMD</span><span class="o">-</span><span class="n">V</span>
<span class="n">L1d</span> <span class="n">cache</span><span class="p">:</span>             <span class="mi">32</span><span class="n">K</span>
<span class="n">L1i</span> <span class="n">cache</span><span class="p">:</span>             <span class="mi">64</span><span class="n">K</span>
<span class="n">L2</span> <span class="n">cache</span><span class="p">:</span>              <span class="mi">512</span><span class="n">K</span>
<span class="n">L3</span> <span class="n">cache</span><span class="p">:</span>              <span class="mi">8192</span><span class="n">K</span>
<span class="n">NUMA</span> <span class="n">node0</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">0</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="mi">64</span><span class="o">-</span><span class="mi">71</span>
<span class="n">NUMA</span> <span class="n">node1</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">8</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">72</span><span class="o">-</span><span class="mi">79</span>
<span class="n">NUMA</span> <span class="n">node2</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">16</span><span class="o">-</span><span class="mi">23</span><span class="p">,</span><span class="mi">80</span><span class="o">-</span><span class="mi">87</span>
<span class="n">NUMA</span> <span class="n">node3</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">24</span><span class="o">-</span><span class="mi">31</span><span class="p">,</span><span class="mi">88</span><span class="o">-</span><span class="mi">95</span>
<span class="n">NUMA</span> <span class="n">node4</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">32</span><span class="o">-</span><span class="mi">39</span><span class="p">,</span><span class="mi">96</span><span class="o">-</span><span class="mi">103</span>
<span class="n">NUMA</span> <span class="n">node5</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">40</span><span class="o">-</span><span class="mi">47</span><span class="p">,</span><span class="mi">104</span><span class="o">-</span><span class="mi">111</span>
<span class="n">NUMA</span> <span class="n">node6</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">48</span><span class="o">-</span><span class="mi">55</span><span class="p">,</span><span class="mi">112</span><span class="o">-</span><span class="mi">119</span>
<span class="n">NUMA</span> <span class="n">node7</span> <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>     <span class="mi">56</span><span class="o">-</span><span class="mi">63</span><span class="p">,</span><span class="mi">120</span><span class="o">-</span><span class="mi">127</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ethtool</span></code>, <code class="docutils literal notranslate"><span class="pre">show_irq_affinity.sh</span></code> and <code class="docutils literal notranslate"><span class="pre">set_irq_affinity_cpulist.sh</span></code>
tools are provided from the official driver sources.
Set up the NIC, including offloading and load balancing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="n">eno6</span> <span class="n">down</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mellanox</span><span class="o">/</span><span class="n">ethtool</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">L</span> <span class="n">eno6</span> <span class="n">combined</span> <span class="mi">15</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mellanox</span><span class="o">/</span><span class="n">ethtool</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eno6</span> <span class="n">rxhash</span> <span class="n">on</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mellanox</span><span class="o">/</span><span class="n">ethtool</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eno6</span> <span class="n">ntuple</span> <span class="n">on</span>
<span class="n">ifconfig</span> <span class="n">eno6</span> <span class="n">up</span>
<span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">set_irq_affinity_cpulist</span><span class="o">.</span><span class="n">sh</span> <span class="mi">1</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="mi">64</span><span class="o">-</span><span class="mi">71</span> <span class="n">eno6</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mellanox</span><span class="o">/</span><span class="n">ethtool</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">X</span> <span class="n">eno6</span> <span class="n">hfunc</span> <span class="n">toeplitz</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mellanox</span><span class="o">/</span><span class="n">ethtool</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">X</span> <span class="n">eno6</span> <span class="n">hkey</span> <span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span>
</pre></div>
</div>
<p>In the example above (1-7,64-71 for the irq affinity) CPU 0 is skipped as it is usually used by default on Linux systems by many applications/tools.
Let the NIC balance as much as possible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for proto in tcp4 udp4 tcp6 udp6; do
   /usr/local/sbin/ethtool -N eth1 rx-flow-hash $proto sdfn
done
</pre></div>
</div>
<p>In the cpu affinity section of suricata.yaml config :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Suricata is multi-threaded. Here the threading can be influenced.</span>
<span class="n">threading</span><span class="p">:</span>
 <span class="nb">set</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span> <span class="n">yes</span>
 <span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
       <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;120-127&quot;</span> <span class="p">]</span>  <span class="c1"># include only these cpus in affinity settings</span>
   <span class="o">-</span> <span class="n">receive</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
       <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>  <span class="c1"># include only these cpus in affinity settings</span>
   <span class="o">-</span> <span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
       <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;8-55&quot;</span> <span class="p">]</span>
       <span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;exclusive&quot;</span>
       <span class="n">prio</span><span class="p">:</span>
         <span class="n">high</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;8-55&quot;</span> <span class="p">]</span>
         <span class="n">default</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span>
</pre></div>
</div>
<p>In the af-packet section of suricata.yaml config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth1</span>
  <span class="c1"># Number of receive threads. &quot;auto&quot; uses the number of cores</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">48</span> <span class="c1"># 48 worker threads on cpus &quot;8-55&quot; above</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">99</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_flow</span>
  <span class="n">defrag</span><span class="p">:</span> <span class="n">no</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">mmap</span><span class="o">-</span><span class="n">locked</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">tpacket</span><span class="o">-</span><span class="n">v3</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">100000</span>
  <span class="n">block</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">1048576</span>
</pre></div>
</div>
<p>In the example above there are 15 RSS queues pinned to cores 1-7,64-71 on NUMA
node 0 and 40 worker threads using other CPUs on different NUMA nodes. The
reason why CPU 0 is skipped in this set up is as in Linux systems it is very
common for CPU 0 to be used by default by many tools/services. The NIC itself in
this config is positioned on NUMA 0 so starting with 15 RSS queues on that
NUMA node and keeping those off for other tools in the system could offer the
best advantage.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Performance and optimization of the whole system can be affected upon regular NIC driver and pkg/kernel upgrades so it should be monitored regularly and tested out in QA/test environments first. As a general suggestion it is always recommended to run the latest stable firmware and drivers as  instructed and provided by the particular NIC vendor.</p>
</div>
</div>
<div class="section" id="other-considerations">
<h5>Other considerations<a class="headerlink" href="#other-considerations" title="Permalink to this headline">¶</a></h5>
<p>Another advanced option to consider is the <code class="docutils literal notranslate"><span class="pre">isolcpus</span></code> kernel boot parameter
is a way of allowing CPU cores to be isolated for use of general system
processes. That way ensures total dedication of those CPUs/ranges for the
Suricata process only.</p>
<p><code class="docutils literal notranslate"><span class="pre">stream.wrong_thread</span></code> / <code class="docutils literal notranslate"><span class="pre">tcp.pkt_on_wrong_thread</span></code> are counters available
in <code class="docutils literal notranslate"><span class="pre">stats.log</span></code> or <code class="docutils literal notranslate"><span class="pre">eve.json</span></code> as <code class="docutils literal notranslate"><span class="pre">event_type:</span> <span class="pre">stats</span></code> that indicate issues with
the load balancing. There could be traffic/NICs settings related as well. In
very high/heavily increasing counter values it is recommended to experiment
with a different load balancing method either via the NIC or for example using
XDP/eBPF. There is an issue open
<a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/2725">https://redmine.openinfosecfoundation.org/issues/2725</a> that is a placeholder
for feedback and findings.</p>
</div>
</div>
</div>
<span id="document-performance/statistics"></span><div class="section" id="statistics">
<h3>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h3>
<p>The stats.log produces statistics records on a fixed interval, by
default every 8 seconds.</p>
<div class="section" id="stats-log-file">
<h4>stats.log file<a class="headerlink" href="#stats-log-file" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-------------------------------------------------------------------</span>
<span class="n">Counter</span>                   <span class="o">|</span> <span class="n">TM</span> <span class="n">Name</span>                   <span class="o">|</span> <span class="n">Value</span>
<span class="o">-------------------------------------------------------------------</span>
<span class="n">flow_mgr</span><span class="o">.</span><span class="n">closed_pruned</span>    <span class="o">|</span> <span class="n">FlowManagerThread</span>         <span class="o">|</span> <span class="mi">154033</span>
<span class="n">flow_mgr</span><span class="o">.</span><span class="n">new_pruned</span>       <span class="o">|</span> <span class="n">FlowManagerThread</span>         <span class="o">|</span> <span class="mi">67800</span>
<span class="n">flow_mgr</span><span class="o">.</span><span class="n">est_pruned</span>       <span class="o">|</span> <span class="n">FlowManagerThread</span>         <span class="o">|</span> <span class="mi">100921</span>
<span class="n">flow</span><span class="o">.</span><span class="n">memuse</span>               <span class="o">|</span> <span class="n">FlowManagerThread</span>         <span class="o">|</span> <span class="mi">6557568</span>
<span class="n">flow</span><span class="o">.</span><span class="n">spare</span>                <span class="o">|</span> <span class="n">FlowManagerThread</span>         <span class="o">|</span> <span class="mi">10002</span>
<span class="n">flow</span><span class="o">.</span><span class="n">emerg_mode_entered</span>   <span class="o">|</span> <span class="n">FlowManagerThread</span>         <span class="o">|</span> <span class="mi">0</span>
<span class="n">flow</span><span class="o">.</span><span class="n">emerg_mode_over</span>      <span class="o">|</span> <span class="n">FlowManagerThread</span>         <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">pkts</span>              <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">450001754</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">bytes</span>             <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">409520714250</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">ipv4</span>              <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">449584047</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">ipv6</span>              <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">9212</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">ethernet</span>          <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">450001754</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">raw</span>               <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">sll</span>               <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">tcp</span>               <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">448124337</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">udp</span>               <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">542040</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">sctp</span>              <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">icmpv4</span>            <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">82292</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">icmpv6</span>            <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">9164</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">ppp</span>               <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">pppoe</span>             <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">gre</span>               <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">vlan</span>              <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">avg_pkt_size</span>      <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">910</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">max_pkt_size</span>      <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">1514</span>
<span class="n">defrag</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">fragments</span>     <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">4</span>
<span class="n">defrag</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">reassembled</span>   <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">1</span>
<span class="n">defrag</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">timeouts</span>      <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">defrag</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">fragments</span>     <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">defrag</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">reassembled</span>   <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">defrag</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">timeouts</span>      <span class="o">|</span> <span class="n">RxPcapem21</span>                <span class="o">|</span> <span class="mi">0</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">sessions</span>              <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">41184</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">ssn_memcap_drop</span>       <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">0</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">pseudo</span>                <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">2087</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">invalid_checksum</span>      <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">8358</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">no_flow</span>               <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">0</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">reused_ssn</span>            <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">11</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">memuse</span>                <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">36175872</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">syn</span>                   <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">85902</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">synack</span>                <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">83385</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">rst</span>                   <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">84326</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">segment_memcap_drop</span>   <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">0</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">stream_depth_reached</span>  <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">109</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">reassembly_memuse</span>     <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">67755264</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">reassembly_gap</span>        <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">789</span>
<span class="n">detect</span><span class="o">.</span><span class="n">alert</span>              <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">14721</span>
</pre></div>
</div>
<div class="section" id="detecting-packet-loss">
<h5>Detecting packet loss<a class="headerlink" href="#detecting-packet-loss" title="Permalink to this headline">¶</a></h5>
<p>At shut down, Suricata reports the packet loss statistics it gets from
pcap, pfring or afpacket</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">18088</span><span class="p">]</span> <span class="mi">30</span><span class="o">/</span><span class="mi">5</span><span class="o">/</span><span class="mi">2012</span> <span class="o">--</span> <span class="mi">07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">18</span> <span class="o">-</span> <span class="p">(</span><span class="n">RxPcapem21</span><span class="p">)</span> <span class="n">Packets</span> <span class="mi">451595939</span><span class="p">,</span> <span class="nb">bytes</span> <span class="mi">410869083410</span>
<span class="p">[</span><span class="mi">18088</span><span class="p">]</span> <span class="mi">30</span><span class="o">/</span><span class="mi">5</span><span class="o">/</span><span class="mi">2012</span> <span class="o">--</span> <span class="mi">07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">18</span> <span class="o">-</span> <span class="p">(</span><span class="n">RxPcapem21</span><span class="p">)</span> <span class="n">Pcap</span> <span class="n">Total</span><span class="p">:</span><span class="mi">451674222</span> <span class="n">Recv</span><span class="p">:</span><span class="mi">451596129</span> <span class="n">Drop</span><span class="p">:</span><span class="mi">78093</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">%</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>Usually, this is not the complete story though. These are kernel drop
stats, but the NIC may also have dropped packets. Use ethtool to get
to those:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ethtool -S em2</span>
<span class="n">NIC</span> <span class="n">statistics</span><span class="p">:</span>
     <span class="n">rx_packets</span><span class="p">:</span> <span class="mi">35430208463</span>
     <span class="n">tx_packets</span><span class="p">:</span> <span class="mi">216072</span>
     <span class="n">rx_bytes</span><span class="p">:</span> <span class="mi">32454370137414</span>
     <span class="n">tx_bytes</span><span class="p">:</span> <span class="mi">53624450</span>
     <span class="n">rx_broadcast</span><span class="p">:</span> <span class="mi">17424355</span>
     <span class="n">tx_broadcast</span><span class="p">:</span> <span class="mi">133508</span>
     <span class="n">rx_multicast</span><span class="p">:</span> <span class="mi">5332175</span>
     <span class="n">tx_multicast</span><span class="p">:</span> <span class="mi">82564</span>
     <span class="n">rx_errors</span><span class="p">:</span> <span class="mi">47</span>
     <span class="n">tx_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_dropped</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">multicast</span><span class="p">:</span> <span class="mi">5332175</span>
     <span class="n">collisions</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_length_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_over_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_crc_errors</span><span class="p">:</span> <span class="mi">51</span>
     <span class="n">rx_frame_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_no_buffer_count</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_missed_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_aborted_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_carrier_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_fifo_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_heartbeat_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_window_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_abort_late_coll</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_deferred_ok</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_single_coll_ok</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_multi_coll_ok</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_timeout_count</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_restart_queue</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_long_length_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_short_length_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_align_errors</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_tcp_seg_good</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_tcp_seg_failed</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_flow_control_xon</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_flow_control_xoff</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_flow_control_xon</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_flow_control_xoff</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_long_byte_count</span><span class="p">:</span> <span class="mi">32454370137414</span>
     <span class="n">rx_csum_offload_good</span><span class="p">:</span> <span class="mi">35270755306</span>
     <span class="n">rx_csum_offload_errors</span><span class="p">:</span> <span class="mi">65076</span>
     <span class="n">alloc_rx_buff_failed</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">tx_smbus</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">rx_smbus</span><span class="p">:</span> <span class="mi">0</span>
     <span class="n">dropped_smbus</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="kernel-drops">
<h4>Kernel drops<a class="headerlink" href="#kernel-drops" title="Permalink to this headline">¶</a></h4>
<p>stats.log contains interesting information in the
capture.kernel_packets and capture.kernel_drops. The meaning of them
is different following the capture mode.</p>
<p>In AF_PACKET mode:</p>
<ul class="simple">
<li>kernel_packets is the number of packets correctly sent to userspace</li>
<li>kernel_drops is the number of packets that have been discarded instead of being sent to userspace</li>
</ul>
<p>In PF_RING mode:</p>
<ul class="simple">
<li>kernel_packets is the total number of packets seen by pf_ring</li>
<li>kernel_drops is the number of packets that have been discarded instead of being sent to userspace</li>
</ul>
<p>In the Suricata stats.log the TCP data gap counter is also an
indicator, as it accounts missing data packets in TCP streams:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tcp</span><span class="o">.</span><span class="n">reassembly_gap</span>        <span class="o">|</span> <span class="n">Detect</span>                    <span class="o">|</span> <span class="mi">789</span>
</pre></div>
</div>
<p>Ideally, this number is 0. Not only pkt loss affects it though, also
bad checksums and stream engine running out of memory.</p>
</div>
<div class="section" id="tools-to-plot-graphs">
<h4>Tools to plot graphs<a class="headerlink" href="#tools-to-plot-graphs" title="Permalink to this headline">¶</a></h4>
<p>Some people made nice tools to plot graphs of the statistics file.</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/regit/suri-stats">ipython and matplotlib script</a></li>
<li><a class="reference external" href="http://christophe.vandeplas.com/2013/11/suricata-monitoring-with-zabbix-or-other.html">Monitoring with Zabbix or other</a> and <a class="reference external" href="https://github.com/cvandeplas/suricata_stats">Code on GitHub</a></li>
</ul>
</div>
</div>
<span id="document-performance/ignoring-traffic"></span><div class="section" id="ignoring-traffic">
<h3>Ignoring Traffic<a class="headerlink" href="#ignoring-traffic" title="Permalink to this headline">¶</a></h3>
<p>In some cases there are reasons to ignore certain traffic. Certain hosts
may be trusted, or perhaps a backup stream should be ignored.</p>
<div class="section" id="capture-filters-bpf">
<h4>capture filters (BPF)<a class="headerlink" href="#capture-filters-bpf" title="Permalink to this headline">¶</a></h4>
<p>Through BPFs the capture methods pcap, af-packet, netmap  and pf_ring can be
told what to send to Suricata, and what not. For example a simple
filter 'tcp' will only capture tcp packets.</p>
<p>If some hosts and or nets need to be ignored, use something like &quot;not
(host IP1 or IP2 or IP3 or net NET/24)&quot;.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ow">not</span> <span class="n">host</span> <span class="mf">1.2.3.4</span>
</pre></div>
</div>
<p>Capture filters are specified on the command-line after all other options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">v</span> <span class="ow">not</span> <span class="n">host</span> <span class="mf">1.2.3.4</span>
<span class="n">suricata</span> <span class="o">-</span><span class="n">i</span> <span class="n">eno1</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="n">tcp</span> <span class="ow">or</span> <span class="n">udp</span>
</pre></div>
</div>
<p>Capture filters can be set per interface in the pcap, af-packet, netmap
and pf_ring sections. It can also be put in a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;not host 1.2.3.4&quot;</span> <span class="o">&gt;</span> <span class="n">capture</span><span class="o">-</span><span class="nb">filter</span><span class="o">.</span><span class="n">bpf</span>
<span class="n">suricata</span> <span class="o">-</span><span class="n">i</span> <span class="n">ens5f0</span> <span class="o">-</span><span class="n">F</span> <span class="n">capture</span><span class="o">-</span><span class="nb">filter</span><span class="o">.</span><span class="n">bpf</span>
</pre></div>
</div>
<p>Using a capture filter limits what traffic Suricata processes. So the
traffic not seen by Suricata will not be inspected, logged or otherwise
recorded.</p>
<div class="section" id="bpf-and-ips">
<h5>BPF and IPS<a class="headerlink" href="#bpf-and-ips" title="Permalink to this headline">¶</a></h5>
<p>In case of IPS modes using af-packet and netmap, BPFs affect how traffic
is forwarded. If a capture NIC does not capture a packet because of a BPF,
it will also not be forwarded to the peering NIC.</p>
<p>So in the example of <cite>not host 1.2.3.4</cite>, traffic to and from the IP <cite>1.2.3.4</cite>
is effectively dropped.</p>
</div>
</div>
<div class="section" id="pass-rules">
<h4>pass rules<a class="headerlink" href="#pass-rules" title="Permalink to this headline">¶</a></h4>
<p>Pass rules are Suricata rules that if matching, pass the packet and in
case of TCP the rest of the flow. They look like normal rules, except
that instead of <cite>alert</cite> or <cite>drop</cite> they use <cite>pass</cite> as the action.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">pass</span> <span class="n">ip</span> <span class="mf">1.2.3.4</span> <span class="nb">any</span> <span class="o">&lt;&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;pass all traffic from/to 1.2.3.4&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>A big difference with capture filters is that logs such as Eve or http.log
are still generated for this traffic.</p>
</div>
<div class="section" id="suppress">
<h4>suppress<a class="headerlink" href="#suppress" title="Permalink to this headline">¶</a></h4>
<p>Suppress rules can be used to make sure no alerts are generated for a
host. This is not efficient however, as the suppression is only
considered post-matching. In other words, Suricata first inspects a
rule, and only then will it consider per-host suppressions.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suppress</span> <span class="n">gen_id</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">0</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">ip</span> <span class="mf">1.2.3.4</span>
</pre></div>
</div>
</div>
<div class="section" id="encrypted-traffic">
<h4>encrypted traffic<a class="headerlink" href="#encrypted-traffic" title="Permalink to this headline">¶</a></h4>
<p>The TLS app layer parser has the ability to stop processing encrypted traffic
after the initial handshake. By setting the <cite>app-layer.protocols.tls.encryption-handling</cite>
option to <cite>bypass</cite> the rest of this flow is ignored. If flow bypass is enabled,
the bypass is done in the kernel or in hardware.</p>
</div>
<div class="section" id="bypassing-traffic">
<span id="bypass"></span><h4>bypassing traffic<a class="headerlink" href="#bypassing-traffic" title="Permalink to this headline">¶</a></h4>
<p>Aside from using the <code class="docutils literal notranslate"><span class="pre">bypass</span></code> keyword in rules, there are three other ways
to bypass traffic.</p>
<ul class="simple">
<li>Within suricata (local bypass). Suricata reads a packet, decodes it, checks
it in the flow table. If the corresponding flow is local bypassed then it
simply skips all streaming, detection and output and the packet goes directly
out in IDS mode and to verdict in IPS mode.</li>
<li>Within the kernel (capture bypass). When Suricata decides to bypass it calls
a function provided by the capture method to declare the bypass in the
capture. For NFQ this is a simple mark that will be used by the
iptables/nftablesruleset. For AF_PACKET this will be a call to add an element
in an eBPF hash table stored in kernel.</li>
<li>Within the NIC driver. This method relies upon XDP, XDP can process the
traffic prior to reaching the kernel.</li>
</ul>
<p>Additional bypass documentation:</p>
<p><a class="reference external" href="https://suricon.net/wp-content/uploads/2017/12/SuriCon17-Manev_Purzynski.pdf">https://suricon.net/wp-content/uploads/2017/12/SuriCon17-Manev_Purzynski.pdf</a>
<a class="reference external" href="https://www.stamus-networks.com/2016/09/28/suricata-bypass-feature/">https://www.stamus-networks.com/2016/09/28/suricata-bypass-feature/</a></p>
</div>
</div>
<span id="document-performance/packet-profiling"></span><div class="section" id="packet-profiling">
<h3>Packet Profiling<a class="headerlink" href="#packet-profiling" title="Permalink to this headline">¶</a></h3>
<p>In this guide will be explained how to enable packet profiling and use
it with the most recent code of Suricata on Ubuntu. It is based on the
assumption that you have already installed Suricata once from the GIT
repository.</p>
<p>Packet profiling is convenient in case you would like to know how long
packets take to be processed. It is a way to figure out why certain
packets are being processed quicker than others, and this way a good
tool for developing Suricata.</p>
<p>Update Suricata by following the steps from <a class="reference internal" href="index.html#installation-from-git"><span class="std std-ref">Installation from GIT</span></a>. Start
at the end at</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span>
<span class="n">git</span> <span class="n">pull</span>
</pre></div>
</div>
<p>And follow the described next steps. To enable packet profiling, make
sure you enter the following during the configuring stage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">profiling</span>
</pre></div>
</div>
<p>Find a folder in which you have pcaps. If you do not have pcaps yet,
you can get these with Wireshark. See <a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Sniffing_Packets_with_Wireshark">Sniffing Packets with Wireshark</a>.</p>
<p>Go to the directory of your pcaps. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span>  <span class="o">~/</span><span class="n">Desktop</span>
</pre></div>
</div>
<p>With the ls command you can see the content of the folder.  Choose a
folder and a pcap file</p>
<p>for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2011</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span>
</pre></div>
</div>
<p>Run Suricata with that pcap:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">r</span> <span class="n">log</span><span class="o">.</span><span class="n">pcap</span><span class="o">.</span><span class="p">(</span><span class="n">followed</span> <span class="n">by</span> <span class="n">the</span> <span class="n">number</span><span class="o">/</span><span class="n">name</span> <span class="n">of</span> <span class="n">your</span> <span class="n">pcap</span><span class="p">)</span>
</pre></div>
</div>
<p>for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">r</span> <span class="n">log</span><span class="o">.</span><span class="n">pcap</span><span class="mf">.1304589204</span>
</pre></div>
</div>
</div>
<span id="document-performance/rule-profiling"></span><div class="section" id="rule-profiling">
<h3>Rule Profiling<a class="headerlink" href="#rule-profiling" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--------------------------------------------------------------------------</span>
<span class="n">Date</span><span class="p">:</span> <span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="o">/</span><span class="mi">2013</span> <span class="o">--</span> <span class="mi">14</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">58</span>
<span class="o">--------------------------------------------------------------------------</span>
 <span class="n">Num</span>      <span class="n">Rule</span>         <span class="n">Gid</span>      <span class="n">Rev</span>      <span class="n">Ticks</span>        <span class="o">%</span>      <span class="n">Checks</span>   <span class="n">Matches</span>  <span class="n">Max</span> <span class="n">Ticks</span>   <span class="n">Avg</span> <span class="n">Ticks</span>   <span class="n">Avg</span> <span class="n">Match</span>   <span class="n">Avg</span> <span class="n">No</span> <span class="n">Match</span>
<span class="o">--------</span> <span class="o">------------</span> <span class="o">--------</span> <span class="o">--------</span> <span class="o">------------</span> <span class="o">------</span> <span class="o">--------</span> <span class="o">--------</span> <span class="o">-----------</span> <span class="o">-----------</span> <span class="o">-----------</span> <span class="o">--------------</span>
<span class="mi">1</span>        <span class="mi">2210021</span>      <span class="mi">1</span>        <span class="mi">3</span>        <span class="mi">12037</span>        <span class="mf">4.96</span>   <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">12037</span>       <span class="mf">12037.00</span>    <span class="mf">12037.00</span>    <span class="mf">0.00</span>
<span class="mi">2</span>        <span class="mi">2210054</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">107479</span>       <span class="mf">44.26</span>  <span class="mi">12</span>       <span class="mi">0</span>        <span class="mi">35805</span>       <span class="mf">8956.58</span>     <span class="mf">0.00</span>        <span class="mf">8956.58</span>
<span class="mi">3</span>        <span class="mi">2210053</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">4513</span>         <span class="mf">1.86</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">4513</span>        <span class="mf">4513.00</span>     <span class="mf">0.00</span>        <span class="mf">4513.00</span>
<span class="mi">4</span>        <span class="mi">2210023</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">3077</span>         <span class="mf">1.27</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">3077</span>        <span class="mf">3077.00</span>     <span class="mf">0.00</span>        <span class="mf">3077.00</span>
<span class="mi">5</span>        <span class="mi">2210008</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">3028</span>         <span class="mf">1.25</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">3028</span>        <span class="mf">3028.00</span>     <span class="mf">0.00</span>        <span class="mf">3028.00</span>
<span class="mi">6</span>        <span class="mi">2210009</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">2945</span>         <span class="mf">1.21</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">2945</span>        <span class="mf">2945.00</span>     <span class="mf">0.00</span>        <span class="mf">2945.00</span>
<span class="mi">7</span>        <span class="mi">2210055</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">2945</span>         <span class="mf">1.21</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">2945</span>        <span class="mf">2945.00</span>     <span class="mf">0.00</span>        <span class="mf">2945.00</span>
<span class="mi">8</span>        <span class="mi">2210007</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">2871</span>         <span class="mf">1.18</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">2871</span>        <span class="mf">2871.00</span>     <span class="mf">0.00</span>        <span class="mf">2871.00</span>
<span class="mi">9</span>        <span class="mi">2210005</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">2871</span>         <span class="mf">1.18</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">2871</span>        <span class="mf">2871.00</span>     <span class="mf">0.00</span>        <span class="mf">2871.00</span>
<span class="mi">10</span>       <span class="mi">2210024</span>      <span class="mi">1</span>        <span class="mi">1</span>        <span class="mi">2846</span>         <span class="mf">1.17</span>   <span class="mi">1</span>        <span class="mi">0</span>        <span class="mi">2846</span>        <span class="mf">2846.00</span>     <span class="mf">0.00</span>        <span class="mf">2846.00</span>
</pre></div>
</div>
<p>The meaning of the individual fields:</p>
<ul class="simple">
<li>Ticks -- total ticks spent on this rule, so a sum of all inspections</li>
<li>% -- share of this single sig in the total cost of inspection</li>
<li>Checks -- number of times a signature was inspected</li>
<li>Matches -- number of times it matched. This may not have resulted in an alert due to suppression and thresholding.</li>
<li>Max ticks -- single most expensive inspection</li>
<li>Avg ticks -- per inspection average, so &quot;ticks&quot; / &quot;checks&quot;.</li>
<li>Avg match -- avg ticks spent resulting in match</li>
<li>Avg No Match -- avg ticks spent resulting in no match.</li>
</ul>
<p>The &quot;ticks&quot; are CPU clock ticks: <a class="reference external" href="http://en.wikipedia.org/wiki/CPU_time">http://en.wikipedia.org/wiki/CPU_time</a></p>
</div>
<span id="document-performance/tcmalloc"></span><div class="section" id="tcmalloc">
<h3>Tcmalloc<a class="headerlink" href="#tcmalloc" title="Permalink to this headline">¶</a></h3>
<p>'tcmalloc' is a library Google created as part of the google-perftools
suite for improving memory handling in a threaded program. It's very
simple to use and does work fine with Suricata. It leads to minor
speed ups and also reduces memory usage quite a bit.</p>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>On Ubuntu, install the libtcmalloc-minimal4 package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libtcmalloc</span><span class="o">-</span><span class="n">minimal4</span>
</pre></div>
</div>
<p>On Fedora, install the gperftools-libs package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">gperftools</span><span class="o">-</span><span class="n">libs</span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>Use the tcmalloc by preloading it:</p>
<p>Ubuntu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4&quot;</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span>
</pre></div>
</div>
<p>Fedora:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;/usr/lib64/libtcmalloc_minimal.so.4&quot;</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span>
</pre></div>
</div>
</div>
</div>
<span id="document-performance/analysis"></span><div class="section" id="performance-analysis">
<h3>Performance Analysis<a class="headerlink" href="#performance-analysis" title="Permalink to this headline">¶</a></h3>
<p>There are many potential causes for performance issues. In this section we
will guide you through some options. The first part will cover basic steps and
introduce some helpful tools. The second part will cover more in-depth
explanations and corner cases.</p>
<div class="section" id="system-load">
<h4>System Load<a class="headerlink" href="#system-load" title="Permalink to this headline">¶</a></h4>
<p>The first step should be to check the system load. Run a top tool like <strong>htop</strong>
to get an overview of the system load and if there is a bottleneck with the
traffic distribution. For example if you can see that only a small number of
cpu cores hit 100% all the time and others don't, it could be related to a bad
traffic distribution or elephant flows like in the screenshot where one core
peaks due to one big elephant flow.</p>
<img alt="_images/htopelephantflow.png" src="_images/htopelephantflow.png" />
<p>If all cores are at peak load the system might be too slow for the traffic load
or it might be misconfigured. Also keep an eye on memory usage, if the actual
memory usage is too high and the system needs to swap it will result in very
poor performance.</p>
<p>The load will give you a first indication where to start with the debugging at
specific parts we describe in more detail in the second part.</p>
</div>
<div class="section" id="logfiles">
<h4>Logfiles<a class="headerlink" href="#logfiles" title="Permalink to this headline">¶</a></h4>
<p>The next step would be to check all the log files with a focus on <strong>stats.log</strong>
and <strong>suricata.log</strong> if any obvious issues are seen. The most obvious indicator
is the <strong>capture.kernel_drops</strong> value that ideally would not even show up but
should be below 1% of the <strong>capture.kernel_packets</strong> value as high drop rates
could lead to a reduced amount of events and alerts.</p>
<p>If <strong>memcap</strong> is seen in the stats the memcap values in the configuration could
be increased. This can result to higher memory usage and should be taken into
account when the settings are changed.</p>
<p>Don't forget to check any system logs as well, even a <strong>dmesg</strong> run can show
potential issues.</p>
</div>
<div class="section" id="suricata-load">
<h4>Suricata Load<a class="headerlink" href="#suricata-load" title="Permalink to this headline">¶</a></h4>
<p>Besides the system load, another indicator for potential performance issues is
the load of Suricata itself.  A helpful tool for that is <strong>perf</strong> which helps
to spot performance issues. Make sure you have it installed and also the debug
symbols installed for Suricata or the output won't be very helpful. This output
is also helpful when you report performance issues as the Suricata Development
team can narrow down possible issues with that.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo perf top -p $(pidof suricata)
</pre></div>
</div>
<p>If you see specific function calls at the top in red it's a hint that those are
the bottlenecks. For example if you see <strong>IPOnlyMatchPacket</strong> it can be either
a result of high drop rates or incomplete flows which result in decreased
performance. To look into the performance issues on a specific thread you can
pass <strong>-t TID</strong> to perf top. In other cases you can see functions that give you
a hint that a specific protocol parser is used a lot and can either try to
debug a performance bug or try to filter related traffic.</p>
<img alt="_images/perftop.png" src="_images/perftop.png" />
<p>In general try to play around with the different configuration options that
Suricata does provide with a focus on the options described in
<a class="reference internal" href="index.html#document-performance/high-performance-config"><span class="doc">High Performance Configuration</span></a>.</p>
</div>
<div class="section" id="traffic">
<h4>Traffic<a class="headerlink" href="#traffic" title="Permalink to this headline">¶</a></h4>
<p>In most cases where the hardware is fast enough to handle the traffic but the
drop rate is still high it's related to specific traffic issues.</p>
<div class="section" id="basics">
<h5>Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h5>
<p>Some of the basic checks are:</p>
<ul class="simple">
<li>Check if the traffic is bidirectional, if it's mostly unidirectional you're
missing relevant parts of the flow (see <strong>tshark</strong> example at the bottom).
Another indicator could be a big discrepancy between SYN and SYN-ACK as well
as RST counter in the Suricata stats.</li>
<li>Check for encapsulated traffic, while GRE, MPLS etc. are supported they could
also lead to performance issues. Especially if there are several layers of
encapsulation.</li>
<li>Use tools like <strong>iftop</strong> to spot elephant flows. Flows that have a rate of
over 1Gbit/s for a long time can result in one cpu core peak at 100% all the
time and increasing the droprate while it might not make sense to dig deep
into this traffic.</li>
<li>Another approach to narrow down issues is the usage of <strong>bpf filter</strong>. For
example filter all HTTPS traffic with <strong>not port 443</strong> to exclude traffic
that might be problematic or just look into one specific port <strong>port 25</strong> if
you expect some issues with a specific protocol. See <a class="reference internal" href="index.html#document-performance/ignoring-traffic"><span class="doc">Ignoring Traffic</span></a>
for more details.</li>
<li>If VLAN is used it might help to disable <strong>vlan.use-for-tracking</strong> in
scenarios where only one direction of the flow has the VLAN tag.</li>
</ul>
</div>
<div class="section" id="advanced">
<h5>Advanced<a class="headerlink" href="#advanced" title="Permalink to this headline">¶</a></h5>
<p>There are several advanced steps and corner cases when it comes to a deep dive
into the traffic.</p>
<p>If VLAN QinQ (IEEE 802.1ad) is used be very cautious if you use <strong>cluster_qm</strong>
in combination with Intel drivers and AF_PACKET runmode. While the RFC expects
ethertype 0x8100 and 0x88A8 in this case (see
<a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_802.1ad">https://en.wikipedia.org/wiki/IEEE_802.1ad</a>) most implementations only add
0x8100 on each layer. If the first seen layer has the same VLAN tag but the
inner one has different VLAN tags it will still end up in the same queue in
<strong>cluster_qm</strong> mode. This was observed with the i40e driver up to 2.8.20 and
the firmware version up to 7.00, feel free to report if newer versions have
fixed this (see <a class="reference external" href="https://suricata.io/support/">https://suricata.io/support/</a>).</p>
<p>If you want to use <strong>tshark</strong> to get an overview of the traffic direction use
this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo tshark -i $INTERFACE -q -z conv,ip -a duration:10
</pre></div>
</div>
<p>The output will show you all flows within 10s and if you see 0 for one
direction you have unidirectional traffic, thus you don't see the ACK packets
for example. Since Suricata is trying to work on flows this will have a rather
big impact on the visibility. Focus on fixing the unidirectional traffic. If
it's not possible at all you can enable <strong>async-oneside</strong> in the <strong>stream</strong>
configuration setting.</p>
<p>Check for other unusual or complex protocols that aren't supported very well.
You can try to filter those to see if it has any impact on the performance.  In
this example we filter Cisco Fabric Path (ethertype 0x8903) with the bpf filter
<strong>not ether proto 0x8903</strong> as it's assumed to be a performance issue (see
<a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/3637">https://redmine.openinfosecfoundation.org/issues/3637</a>)</p>
</div>
<div class="section" id="elephant-flows">
<h5>Elephant Flows<a class="headerlink" href="#elephant-flows" title="Permalink to this headline">¶</a></h5>
<p>The so called Elephant Flows or traffic spikes are quite difficult to deal
with. In most cases those are big file transfers or backup traffic and it's not
feasible to decode the whole traffic. From a network security monitoring
perspective it's often enough to log the metadata of that flow and do a packet
inspection at the beginning but not the whole flow.</p>
<p>If you can spot specific flows as described above then try to filter those. The
easiest solution would be a bpf filter but that would still result in a
performance impact. Ideally you can filter such traffic even sooner on driver
or NIC level (see eBPF/XDP) or even before it reaches the system where Suricata
is running. Some commercial packet broker support such filtering where it's
called <strong>Flow Shunting</strong> or <strong>Flow Slicing</strong>.</p>
</div>
</div>
<div class="section" id="rules">
<h4>Rules<a class="headerlink" href="#rules" title="Permalink to this headline">¶</a></h4>
<p>The Ruleset plays an important role in the detection but also in the
performance capability of Suricata. Thus it's recommended to look into the
impact of enabled rules as well.</p>
<p>If you run into performance issues and struggle to narrow it down start with
running Suricata without any rules enabled and use the tools again that have
been explained at the first part. Keep in mind that even without signatures
enabled Suricata still does most of the decoding and traffic analysis, so a
fair amount of load should still be seen. If the load is still very high and
drops are seen and the hardware should be capable to deal with such traffic
loads you should deep dive if there is any specific traffic issue (see above)
or report the performance issue so it can be investigated (see
<a class="reference external" href="https://suricata.io/join-our-community/">https://suricata.io/join-our-community/</a>).</p>
<p>Suricata also provides several specific traffic related signatures in the rules
folder that could be enabled for testing to spot specific traffic issues. Those
are found the <strong>rules</strong> and you should start with <strong>decoder-events.rules</strong>,
<strong>stream-events.rules</strong> and <strong>app-layer-events.rules</strong>.</p>
<p>It can also be helpful to use <a class="reference internal" href="index.html#document-performance/rule-profiling"><span class="doc">Rule Profiling</span></a> and/or
<a class="reference internal" href="index.html#document-performance/packet-profiling"><span class="doc">Packet Profiling</span></a> to find problematic rules or traffic pattern. This is
achieved by compiling Suricata with <strong>--enable-profiling</strong> but keep in mind
that this has an impact on performance and should only be used for
troubleshooting.</p>
</div>
</div>
</div>
</div>
<span id="document-configuration/index"></span><div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-configuration/suricata-yaml"></span><div class="section" id="suricata-yaml">
<h3>Suricata.yaml<a class="headerlink" href="#suricata-yaml" title="Permalink to this headline">¶</a></h3>
<p>Suricata uses the Yaml format for configuration. The Suricata.yaml
file included in the source code, is the example configuration of
Suricata. This document will explain each option.</p>
<p>At the top of the YAML-file you will find % YAML 1.1.  Suricata reads
the file and identifies the file as YAML.</p>
<div class="section" id="max-pending-packets">
<span id="suricata-yaml-max-pending-packets"></span><h4>Max-pending-packets<a class="headerlink" href="#max-pending-packets" title="Permalink to this headline">¶</a></h4>
<p>With the max-pending-packets setting you can set the number of packets
you allow Suricata to process simultaneously. This can range from one
packet to tens of thousands/hundreds of thousands of packets. It is a
trade of higher performance and the use of more memory (RAM), or lower
performance and less use of memory. A high number of packets being
processed results in a higher performance and the use of more
memory. A low number of packets, results in lower performance and less
use of memory. Choosing a low number of packets being processed while
having many CPU's/CPU cores, can result in not making use of the whole
computer-capacity. (For instance: using one core while having three
waiting for processing packets.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">max</span><span class="o">-</span><span class="n">pending</span><span class="o">-</span><span class="n">packets</span><span class="p">:</span> <span class="mi">1024</span>
</pre></div>
</div>
</div>
<div class="section" id="runmodes">
<h4>Runmodes<a class="headerlink" href="#runmodes" title="Permalink to this headline">¶</a></h4>
<p>By default the runmode option is disabled. With the runmodes setting
you can set the runmode you would like to use. For all runmodes
available, enter <strong>--list-runmodes</strong> in your command line. For more
information, see <a class="reference internal" href="index.html#document-performance/runmodes"><span class="doc">Runmodes</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">runmode</span><span class="p">:</span> <span class="n">autofp</span>
</pre></div>
</div>
</div>
<div class="section" id="default-packet-size">
<h4>Default-packet-size<a class="headerlink" href="#default-packet-size" title="Permalink to this headline">¶</a></h4>
<p>For the max-pending-packets option, Suricata has to keep packets in
memory. With the default-packet-size option, you can set the size of
the packets on your network. It is possible that bigger packets have
to be processed sometimes. The engine can still process these bigger
packets, but processing it will lower the performance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">packet</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">1514</span>
</pre></div>
</div>
</div>
<div class="section" id="user-and-group">
<h4>User and group<a class="headerlink" href="#user-and-group" title="Permalink to this headline">¶</a></h4>
<p>It is possible to set the user and group to run Suricata as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="o">-</span><span class="k">as</span><span class="p">:</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">suri</span>
  <span class="n">group</span><span class="p">:</span> <span class="n">suri</span>
</pre></div>
</div>
</div>
<div class="section" id="pid-file">
<h4>PID File<a class="headerlink" href="#pid-file" title="Permalink to this headline">¶</a></h4>
<p>This option sets the name of the PID file when Suricata is run in
daemon mode. This file records the Suricata process ID.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pid</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">pid</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This configuration file option only sets the PID file when
running in daemon mode. To force creation of a PID file when
not running in daemon mode, use the <a class="reference internal" href="index.html#cmdoption-pidfile"><code class="xref std std-option docutils literal notranslate"><span class="pre">--pidfile</span></code></a>
command line option.</p>
<p class="last">Also, if running more than one Suricata process, each
process will need to specify a different pid-file location.</p>
</div>
</div>
<div class="section" id="action-order">
<span id="suricata-yaml-action-order"></span><h4>Action-order<a class="headerlink" href="#action-order" title="Permalink to this headline">¶</a></h4>
<p>All signatures have different properties. One of those is the Action
property. This one determines what will happen when a signature
matches. There are four types of Action. A summary of what will
happen when a signature matches and contains one of those Actions:</p>
<ol class="arabic simple">
<li>Pass</li>
</ol>
<p>If a signature matches and contains pass, Suricata stops scanning the
packet and skips to the end of all rules (only for the current
packet). If the signature matches on a TCP connection, the entire
flow will be passed but details of the flow will still be logged.</p>
<ol class="arabic simple" start="2">
<li>Drop</li>
</ol>
<p>This only concerns the IPS/inline mode. If the program finds a
signature that matches, containing drop, it stops immediately. The
packet will not be sent any further. Drawback: The receiver does not
receive a message of what is going on, resulting in a time-out
(certainly with TCP). Suricata generates an alert for this packet.</p>
<ol class="arabic simple" start="3">
<li>Reject</li>
</ol>
<p>This is an active rejection of the packet. Both receiver and sender
receive a reject packet. There are two types of reject packets that
will be automatically selected. If the offending packet concerns TCP,
it will be a Reset-packet. For all other protocols it will be an
ICMP-error packet. Suricata also generates an alert. When in
Inline/IPS mode, the offending packet will also be dropped like with
the 'drop' action.</p>
<ol class="arabic simple" start="4">
<li>Alert</li>
</ol>
<p>If a signature matches and contains alert, the packet will be treated
like any other non-threatening packet, except for this one an alert
will be generated by Suricata. Only the system administrator can
notice this alert.</p>
<p>Inline/IPS can block network traffic in two ways. One way is by drop
and the other by reject.</p>
<p>Rules will be loaded in the order of which they appear in files. But
they will be processed in a different order. Signatures have different
priorities. The most important signatures will be scanned first. There
is a possibility to change the order of priority. The default order
is: pass, drop, reject, alert.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">action</span><span class="o">-</span><span class="n">order</span><span class="p">:</span>
 <span class="o">-</span> <span class="k">pass</span>
 <span class="o">-</span> <span class="n">drop</span>
 <span class="o">-</span> <span class="n">reject</span>
 <span class="o">-</span> <span class="n">alert</span>
</pre></div>
</div>
<p>This means a pass rule is considered before a drop rule, a drop rule
before a reject rule and so on.</p>
</div>
<div class="section" id="packet-alert-queue-settings">
<h4>Packet alert queue settings<a class="headerlink" href="#packet-alert-queue-settings" title="Permalink to this headline">¶</a></h4>
<p>It is possible to configure the size of the alerts queue that is used to append alerts triggered by each packet.</p>
<p>This will influence how many alerts would be perceived to have matched against a given packet.
The default value is 15. If an invalid setting or no value is provided, the engine will fall
back to the default.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Define maximum number of possible alerts that can be triggered for the same</span>
<span class="c1"># packet. Default is 15</span>
<span class="n">packet</span><span class="o">-</span><span class="n">alert</span><span class="o">-</span><span class="nb">max</span><span class="p">:</span> <span class="mi">15</span>
</pre></div>
</div>
<p>We recommend that you use the default value for this setting unless you are seeing a high number of discarded alerts
(<code class="docutils literal notranslate"><span class="pre">alert_queue_overflow</span></code>) - see the <a class="reference internal" href="#discarded-and-suppressed-alerts-stats">Discarded and Suppressed Alerts Stats</a> section for more details.</p>
<div class="section" id="impact-on-engine-behavior">
<h5>Impact on engine behavior<a class="headerlink" href="#impact-on-engine-behavior" title="Permalink to this headline">¶</a></h5>
<p>Internally, the Suricata engine represents each packet with a data structure that has its own alert queue. The max size
of the queue is defined by <code class="docutils literal notranslate"><span class="pre">packet-alert-max</span></code>. The same rule can be triggered by the same packet multiple times. As
long as there is still space in the alert queue, those are appended.</p>
<p>Rules that have the <code class="docutils literal notranslate"><span class="pre">noalert</span></code> keyword will be checked - in case their signatures have actions that must be applied to the Packet or Flow, then suppressed. They have no effect in the final alert queue.</p>
<p>Rules are queued by priority: higher priority rules may be kept instead of lower priority ones that may have been triggered earlier, if Suricata reaches <code class="docutils literal notranslate"><span class="pre">packet-alert-max</span></code> for a given packet (a.k.a. packet alert queue overflow).</p>
<div class="section" id="packet-alert-queue-overflow">
<h6>Packet alert queue overflow<a class="headerlink" href="#packet-alert-queue-overflow" title="Permalink to this headline">¶</a></h6>
<p>Once the alert queue reaches its max size, we are potentially at packet alert queue overflow, so new alerts will only be appended in case their rules have a higher priority id (this is the internal id attributed by the engine, not the signature id).</p>
<p>This may happen in two different situations:</p>
<ul class="simple">
<li>a higher priority rule is triggered after a lower priority one: the lower priority rule is replaced in the queue;</li>
<li>a lower priority rule is triggered: the rule is just discarded.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This behavior does not mean that triggered <code class="docutils literal notranslate"><span class="pre">drop</span></code> rules would have their action ignored, in IPS mode.</p>
</div>
</div>
</div>
<div class="section" id="discarded-and-suppressed-alerts-stats">
<span id="alerts-stats"></span><h5>Discarded and Suppressed Alerts Stats<a class="headerlink" href="#discarded-and-suppressed-alerts-stats" title="Permalink to this headline">¶</a></h5>
<p>Both scenarios previously described will be logged as <em>detect.alert_queue_overflow</em> in the stats logs (in stats.log and eve-log's stats event).</p>
<p>When <code class="docutils literal notranslate"><span class="pre">noalert</span></code> rules match, they appear in the stats logs as <em>detect.alerts_suppressed</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Date</span><span class="p">:</span> <span class="mi">4</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="mi">2022</span> <span class="o">--</span> <span class="mi">17</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">08</span> <span class="p">(</span><span class="n">uptime</span><span class="p">:</span> <span class="mi">0</span><span class="n">d</span><span class="p">,</span> <span class="mi">00</span><span class="n">h</span> <span class="mi">00</span><span class="n">m</span> <span class="mi">00</span><span class="n">s</span><span class="p">)</span>
<span class="o">------------------------------------------------------------------------------------</span>
<span class="n">Counter</span>                                       <span class="o">|</span> <span class="n">TM</span> <span class="n">Name</span>                   <span class="o">|</span> <span class="n">Value</span>
<span class="o">------------------------------------------------------------------------------------</span>
<span class="n">detect</span><span class="o">.</span><span class="n">alert</span>                                  <span class="o">|</span> <span class="n">Total</span>                     <span class="o">|</span> <span class="mi">3</span>
<span class="n">detect</span><span class="o">.</span><span class="n">alert_queue_overflow</span>                   <span class="o">|</span> <span class="n">Total</span>                     <span class="o">|</span> <span class="mi">4</span>
<span class="n">detect</span><span class="o">.</span><span class="n">alerts_suppressed</span>                      <span class="o">|</span> <span class="n">Total</span>                     <span class="o">|</span> <span class="mi">1</span>
</pre></div>
</div>
<p>In this example from a stats.log, we read that 8 alerts were generated: 3 were kept in the packet queue while 4
were discarded due to packets having reached max size for the alert queue, and 1 was suppressed due to coming from a <code class="docutils literal notranslate"><span class="pre">noalert</span></code>
rule.</p>
</div>
</div>
<div class="section" id="splitting-configuration-in-multiple-files">
<h4>Splitting configuration in multiple files<a class="headerlink" href="#splitting-configuration-in-multiple-files" title="Permalink to this headline">¶</a></h4>
<p>Some users might have a need or a wish to split their suricata.yaml
file into separate files, this is available via the 'include' and
'!include' keyword. The first example is of taking the contents of the
outputs section and storing them in outputs.yaml.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># outputs.yaml</span>
<span class="o">-</span> <span class="n">fast</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">fast</span><span class="o">.</span><span class="n">log</span>
    <span class="n">append</span><span class="p">:</span> <span class="n">yes</span>

<span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># suricata.yaml
...

outputs: !include outputs.yaml

...
</pre></div>
</div>
<p>The second scenario is where multiple sections are migrated to a
different YAML file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># host_1.yaml</span>

<span class="nb">max</span><span class="o">-</span><span class="n">pending</span><span class="o">-</span><span class="n">packets</span><span class="p">:</span> <span class="mi">2048</span>

<span class="n">outputs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">fast</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">fast</span><span class="o">.</span><span class="n">log</span>
        <span class="n">append</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># suricata.yaml</span>

<span class="n">include</span><span class="p">:</span> <span class="n">host_1</span><span class="o">.</span><span class="n">yaml</span>

<span class="o">...</span>
</pre></div>
</div>
<p>If the same section, say outputs is later redefined after the include
statement it will overwrite the included file. Therefore any include
statement at the end of the document will overwrite the already
configured sections.</p>
</div>
<div class="section" id="event-output">
<h4>Event output<a class="headerlink" href="#event-output" title="Permalink to this headline">¶</a></h4>
<div class="section" id="default-logging-directory">
<h5>Default logging directory<a class="headerlink" href="#default-logging-directory" title="Permalink to this headline">¶</a></h5>
<p>In the /var/log/suricata directory, all of Suricata's output (alerts
and events) will be stored.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="nb">dir</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span>
</pre></div>
</div>
<p>This directory can be overridden by entering the -l command line
parameter or by changing the directory directly in Yaml. To change it
with the -l command line parameter, enter the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">-</span><span class="n">logs</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="stats">
<span id="suricata-yaml-outputs"></span><h5>Stats<a class="headerlink" href="#stats" title="Permalink to this headline">¶</a></h5>
<p>Engine statistics such as packet counters, memory use counters and others
can be logged in several ways. A separate text log 'stats.log' and an EVE
record type 'stats' are enabled by default.</p>
<p>The stats have a global configuration and a per logger configuration. Here
the global config is documented.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># global stats configuration</span>
<span class="n">stats</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1"># The interval field (in seconds) controls at what interval</span>
  <span class="c1"># the loggers are invoked.</span>
  <span class="n">interval</span><span class="p">:</span> <span class="mi">8</span>
  <span class="c1"># Add decode events as stats.</span>
  <span class="c1">#decoder-events: true</span>
  <span class="c1"># Decoder event prefix in stats. Has been &#39;decoder&#39; before, but that leads</span>
  <span class="c1"># to missing events in the eve.stats records. See issue #2225.</span>
  <span class="c1">#decoder-events-prefix: &quot;decoder.event&quot;</span>
  <span class="c1"># Add stream events as stats.</span>
  <span class="c1">#stream-events: false</span>
</pre></div>
</div>
<p>Statistics can be <cite>enabled</cite> or disabled here.</p>
<p>Statistics are dumped on an <cite>interval</cite>. Setting this below 3 or 4 seconds is
not useful due to how threads are synchronized internally.</p>
<p>The decoder events that the decoding layer generates, can create a counter per
event type. This behaviour is enabled by default. The <cite>decoder-events</cite> option
can be set to <cite>false</cite> to disable.</p>
<p>In 4.1.x there was a naming clash between the regular decoder counters and
the decoder-event counters. This lead to a fair amount of decoder-event
counters not being shown in the EVE.stats records. To address this without
breaking existing setups, a config option <cite>decoder-events-prefix</cite> was added
to change the naming of the decoder-events from decoder.&lt;proto&gt;.&lt;event&gt; to
decoder.event.&lt;proto&gt;.&lt;event&gt;. In 5.0 this became the default.
See <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/2225">issue 2225</a>.</p>
<p>Similar to the <cite>decoder-events</cite> option, the <cite>stream-events</cite> option controls
whether the stream-events are added as counters as well. This is disabled by
default.</p>
</div>
<div class="section" id="outputs">
<h5>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline">¶</a></h5>
<p>There are several types of output. The general structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">fast</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">fast</span><span class="o">.</span><span class="n">log</span>
    <span class="n">append</span><span class="p">:</span> <span class="n">yes</span><span class="o">/</span><span class="n">no</span>
</pre></div>
</div>
<p>Enabling all of the logs, will result in a much lower performance and
the use of more disc space, so enable only the outputs you need.</p>
</div>
<div class="section" id="line-based-alerts-log-fast-log">
<h5>Line based alerts log (fast.log)<a class="headerlink" href="#line-based-alerts-log-fast-log" title="Permalink to this headline">¶</a></h5>
<p>This log contains alerts consisting of a single line. Example of the
appearance of a single fast.log-file line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">10</span><span class="o">/</span><span class="mi">05</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mf">59.667372</span>  <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2009187</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="n">ET</span> <span class="n">WEB_CLIENT</span> <span class="n">ACTIVEX</span> <span class="n">iDefense</span>
  <span class="n">COMRaider</span> <span class="n">ActiveX</span> <span class="n">Control</span> <span class="n">Arbitrary</span> <span class="n">File</span> <span class="n">Deletion</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="p">[</span><span class="n">Classification</span><span class="p">:</span> <span class="n">Web</span>
  <span class="n">Application</span> <span class="n">Attack</span><span class="p">]</span> <span class="p">[</span><span class="n">Priority</span><span class="p">:</span> <span class="mi">3</span><span class="p">]</span> <span class="p">{</span><span class="n">TCP</span><span class="p">}</span> <span class="n">xx</span><span class="o">.</span><span class="n">xx</span><span class="mf">.232.144</span><span class="p">:</span><span class="mi">80</span> <span class="o">-&gt;</span> <span class="mf">192.168.1.4</span><span class="p">:</span><span class="mi">56068</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">fast</span><span class="p">:</span>                    <span class="c1">#The log-name.</span>
   <span class="n">enabled</span><span class="p">:</span><span class="n">yes</span>            <span class="c1">#This log is enabled. Set to &#39;no&#39; to disable.</span>
   <span class="n">filename</span><span class="p">:</span> <span class="n">fast</span><span class="o">.</span><span class="n">log</span>     <span class="c1">#The name of the file in the default logging directory.</span>
   <span class="n">append</span><span class="p">:</span> <span class="n">yes</span><span class="o">/</span><span class="n">no</span>         <span class="c1">#If this option is set to yes, the last filled fast.log-file will not be</span>
                          <span class="c1">#overwritten while restarting Suricata.</span>
</pre></div>
</div>
</div>
<div class="section" id="eve-extensible-event-format">
<span id="suricata-yaml-outputs-eve"></span><h5>Eve (Extensible Event Format)<a class="headerlink" href="#eve-extensible-event-format" title="Permalink to this headline">¶</a></h5>
<p>This is an JSON output for alerts and events. It allows for easy
integration with 3rd party tools like logstash.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="c1"># Extensible Event Format (nicknamed EVE) event log in JSON format</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">filetype</span><span class="p">:</span> <span class="n">regular</span> <span class="c1">#regular|syslog|unix_dgram|unix_stream|redis</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
      <span class="c1"># Enable for multi-threaded eve.json output; output files are amended</span>
      <span class="c1"># with an identifier, e.g., eve.9.json</span>
      <span class="c1">#threaded: false</span>
      <span class="c1">#prefix: &quot;@cee: &quot; # prefix to prepend to each log entry</span>
      <span class="c1"># the following are valid when type: syslog above</span>
      <span class="c1">#identity: &quot;suricata&quot;</span>
      <span class="c1">#facility: local5</span>
      <span class="c1">#level: Info ## possible levels: Emergency, Alert, Critical,</span>
                   <span class="c1">## Error, Warning, Notice, Info, Debug</span>
      <span class="c1">#redis:</span>
      <span class="c1">#  server: 127.0.0.1</span>
      <span class="c1">#  port: 6379</span>
      <span class="c1">#  async: true ## if redis replies are read asynchronously</span>
      <span class="c1">#  mode: list ## possible values: list|lpush (default), rpush, channel|publish</span>
      <span class="c1">#             ## lpush and rpush are using a Redis list. &quot;list&quot; is an alias for lpush</span>
      <span class="c1">#             ## publish is using a Redis channel. &quot;channel&quot; is an alias for publish</span>
      <span class="c1">#  key: suricata ## key or channel to use (default to suricata)</span>
      <span class="c1"># Redis pipelining set up. This will enable to only do a query every</span>
      <span class="c1"># &#39;batch-size&#39; events. This should lower the latency induced by network</span>
      <span class="c1"># connection at the cost of some memory. There is no flushing implemented</span>
      <span class="c1"># so this setting as to be reserved to high traffic suricata.</span>
      <span class="c1">#  pipelining:</span>
      <span class="c1">#    enabled: yes ## set enable to yes to enable query pipelining</span>
      <span class="c1">#    batch-size: 10 ## number of entry to keep in buffer</span>

      <span class="c1"># Include top level metadata. Default yes.</span>
      <span class="c1">#metadata: no</span>

      <span class="n">types</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">alert</span><span class="p">:</span>
            <span class="c1"># payload: yes             # enable dumping payload in Base64</span>
            <span class="c1"># payload-buffer-size: 4kb # max size of payload buffer to output in eve-log</span>
            <span class="c1"># payload-printable: yes   # enable dumping payload in printable (lossy) format</span>
            <span class="c1"># packet: yes              # enable dumping of packet (without stream segments)</span>
            <span class="c1"># http-body: yes           # Requires metadata; enable dumping of http body in Base64</span>
            <span class="c1"># http-body-printable: yes # Requires metadata; enable dumping of http body in printable format</span>

            <span class="c1"># Enable the logging of tagged packets for rules using the</span>
            <span class="c1"># &quot;tag&quot; keyword.</span>
            <span class="n">tagged</span><span class="o">-</span><span class="n">packets</span><span class="p">:</span> <span class="n">yes</span>

            <span class="c1"># Configure the metadata to be logged along with an</span>
            <span class="c1"># alert. The following shows the default configuration</span>
            <span class="c1"># which is used if this field is not provided or simply</span>
            <span class="c1"># set to a truthful value. Setting of this section is only</span>
            <span class="c1"># required if you wish to enable/disable specific fields.</span>
            <span class="c1">#metadata:</span>

              <span class="c1"># Include the decoded application layer (ie. http, dns)</span>
              <span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="p">:</span> <span class="n">true</span>

              <span class="c1"># Log the current state of the flow record.</span>
              <span class="n">flow</span><span class="p">:</span> <span class="n">true</span>

              <span class="n">rule</span><span class="p">:</span>
                <span class="c1"># Log the metadata field from the rule in a structured</span>
                <span class="c1"># format.</span>
                <span class="n">metadata</span><span class="p">:</span> <span class="n">true</span>

                <span class="c1"># Log the raw rule text.</span>
                <span class="n">raw</span><span class="p">:</span> <span class="n">false</span>

            <span class="c1"># HTTP X-Forwarded-For support by adding an extra field or overwriting</span>
            <span class="c1"># the source or destination IP address (depending on flow direction)</span>
            <span class="c1"># with the one reported in the X-Forwarded-For HTTP header. This is</span>
            <span class="c1"># helpful when reviewing alerts for traffic that is being reverse</span>
            <span class="c1"># or forward proxied.</span>
            <span class="n">xff</span><span class="p">:</span>
              <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>
              <span class="c1"># Two operation modes are available, &quot;extra-data&quot; and &quot;overwrite&quot;.</span>
              <span class="n">mode</span><span class="p">:</span> <span class="n">extra</span><span class="o">-</span><span class="n">data</span>
              <span class="c1"># Two proxy deployments are supported, &quot;reverse&quot; and &quot;forward&quot;. In</span>
              <span class="c1"># a &quot;reverse&quot; deployment the IP address used is the last one, in a</span>
              <span class="c1"># &quot;forward&quot; deployment the first IP address is used.</span>
              <span class="n">deployment</span><span class="p">:</span> <span class="n">reverse</span>
              <span class="c1"># Header name where the actual IP address will be reported, if more</span>
              <span class="c1"># than one IP address is present, the last IP address will be the</span>
              <span class="c1"># one taken into consideration.</span>
              <span class="n">header</span><span class="p">:</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span>
        <span class="o">-</span> <span class="n">http</span><span class="p">:</span>
            <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable this for extended logging information</span>
            <span class="c1"># custom allows additional http fields to be included in eve-log</span>
            <span class="c1"># the example below adds three additional fields when uncommented</span>
            <span class="c1">#custom: [Accept-Encoding, Accept-Language, Authorization]</span>
        <span class="o">-</span> <span class="n">dns</span><span class="p">:</span>
            <span class="c1"># Use version 2 logging with the new format:</span>
            <span class="c1"># dns answers will be logged in one single event</span>
            <span class="c1"># rather than an event for each of the answers.</span>
            <span class="c1"># Without setting a version the version</span>
            <span class="c1"># will fallback to 1 for backwards compatibility.</span>
            <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>

            <span class="c1"># Enable/disable this logger. Default: enabled.</span>
            <span class="c1">#enabled: no</span>

            <span class="c1"># Control logging of requests and responses:</span>
            <span class="c1"># - requests: enable logging of DNS queries</span>
            <span class="c1"># - responses: enable logging of DNS answers</span>
            <span class="c1"># By default both requests and responses are logged.</span>
            <span class="c1">#requests: no</span>
            <span class="c1">#responses: no</span>

            <span class="c1"># Format of answer logging:</span>
            <span class="c1"># - detailed: array item per answer</span>
            <span class="c1"># - grouped: answers aggregated by type</span>
            <span class="c1"># Default: all</span>
            <span class="c1">#answer-format: [detailed, grouped]</span>

            <span class="c1"># Answer types to log.</span>
            <span class="c1"># Default: all</span>
            <span class="c1">#answer-types: [a, aaaa, cname, mx, ns, ptr, txt]</span>
        <span class="o">-</span> <span class="n">dns</span><span class="p">:</span>
            <span class="c1"># Version 1 DNS logger.</span>
            <span class="c1"># Deprecated: Will be removed by May 2022.</span>
            <span class="n">version</span><span class="p">:</span> <span class="mi">1</span>

            <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>
            <span class="c1"># control logging of queries and answers</span>
            <span class="c1"># default yes, no to disable</span>
            <span class="n">query</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable logging of DNS queries</span>
            <span class="n">answer</span><span class="p">:</span> <span class="n">yes</span>    <span class="c1"># enable logging of DNS answers</span>
            <span class="c1"># control which RR types are logged</span>
            <span class="c1"># all enabled if custom not specified</span>
            <span class="c1">#custom: [a, aaaa, cname, mx, ns, ptr, txt]</span>
        <span class="o">-</span> <span class="n">tls</span><span class="p">:</span>
            <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable this for extended logging information</span>
            <span class="c1"># output TLS transaction where the session is resumed using a</span>
            <span class="c1"># session id</span>
            <span class="c1">#session-resumption: no</span>
            <span class="c1"># custom allows to control which tls fields that are included</span>
            <span class="c1"># in eve-log</span>
            <span class="c1">#custom: [subject, issuer, session_resumed, serial, fingerprint, sni, version, not_before, not_after, certificate, chain]</span>
        <span class="o">-</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">force</span><span class="o">-</span><span class="n">magic</span><span class="p">:</span> <span class="n">no</span>   <span class="c1"># force logging magic on all logged files</span>
            <span class="c1"># force logging of checksums, available hash functions are md5,</span>
            <span class="c1"># sha1 and sha256</span>
            <span class="c1">#force-hash: [md5]</span>
        <span class="c1">#- drop:</span>
        <span class="c1">#    alerts: yes      # log alerts that caused drops</span>
        <span class="c1">#    flows: all       # start or all: &#39;start&#39; logs only a single drop</span>
        <span class="c1">#                     # per flow direction. All logs each dropped pkt.</span>
        <span class="o">-</span> <span class="n">smtp</span><span class="p">:</span>
            <span class="c1">#extended: yes # enable this for extended logging information</span>
            <span class="c1"># this includes: bcc, message-id, subject, x_mailer, user-agent</span>
            <span class="c1"># custom fields logging from the list:</span>
            <span class="c1">#  reply-to, bcc, message-id, subject, x-mailer, user-agent, received,</span>
            <span class="c1">#  x-originating-ip, in-reply-to, references, importance, priority,</span>
            <span class="c1">#  sensitivity, organization, content-md5, date</span>
            <span class="c1">#custom: [received, x-mailer, x-originating-ip, relays, reply-to, bcc]</span>
            <span class="c1"># output md5 of fields: body, subject</span>
            <span class="c1"># for the body you need to set app-layer.protocols.smtp.mime.body-md5</span>
            <span class="c1"># to yes</span>
            <span class="c1">#md5: [body, subject]</span>

        <span class="c1"># NFS logging.</span>
        <span class="o">-</span> <span class="n">nfs</span>
        <span class="c1"># IKE logging.</span>
        <span class="o">-</span> <span class="n">ike</span>
        <span class="c1"># BitTorrent DHT logging.</span>
        <span class="o">-</span> <span class="n">bittorrent</span><span class="o">-</span><span class="n">dht</span>
        <span class="o">-</span> <span class="n">ssh</span>
        <span class="o">-</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">totals</span><span class="p">:</span> <span class="n">yes</span>       <span class="c1"># stats for all threads merged together</span>
            <span class="n">threads</span><span class="p">:</span> <span class="n">no</span>       <span class="c1"># per thread stats</span>
            <span class="n">deltas</span><span class="p">:</span> <span class="n">no</span>        <span class="c1"># include delta values</span>
        <span class="o">-</span> <span class="n">dhcp</span><span class="p">:</span>
            <span class="c1"># DHCP logging.</span>
            <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
            <span class="c1"># When extended mode is on, all DHCP messages are logged</span>
            <span class="c1"># with full detail. When extended mode is off (the</span>
            <span class="c1"># default), just enough information to map a MAC address</span>
            <span class="c1"># to an IP address is logged.</span>
            <span class="n">extended</span><span class="p">:</span> <span class="n">no</span>
        <span class="c1"># bi-directional flows</span>
        <span class="o">-</span> <span class="n">flow</span>
        <span class="c1"># uni-directional flows</span>
        <span class="c1">#- netflow</span>

        <span class="c1"># An event for logging metadata, specifically pktvars when</span>
        <span class="c1"># they are set, but will also include the full metadata object.</span>
        <span class="c1">#- metadata</span>
</pre></div>
</div>
<p>For more advanced configuration options, see <a class="reference internal" href="index.html#eve-json-output"><span class="std std-ref">Eve JSON Output</span></a>.</p>
<p>The format is documented in <a class="reference internal" href="index.html#eve-json-format"><span class="std std-ref">Eve JSON Format</span></a>.</p>
</div>
<div class="section" id="tls-parameters-and-certificates-logging-tls-log">
<span id="suricata-yaml-outputs-tls"></span><h5>TLS parameters and certificates logging (tls.log)<a class="headerlink" href="#tls-parameters-and-certificates-logging-tls-log" title="Permalink to this headline">¶</a></h5>
<p>The TLS handshake parameters can be logged in a line based log as well.
By default, the logfile is <cite>tls.log</cite> in the suricata log directory.
See <a class="reference internal" href="index.html#output-custom-tls-logging"><span class="std std-ref">Custom TLS logging</span></a> for details
about the configuration and customization of the log format.</p>
<p>Furthermore there is an output module to store TLS certificate files to
disk. This is similar to <a class="reference internal" href="#suricata-yaml-file-store"><span class="std std-ref">File-store (File Extraction)</span></a>, but for TLS certificates.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># output module to store certificates chain to disk</span>
<span class="o">-</span> <span class="n">tls</span><span class="o">-</span><span class="n">store</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
    <span class="c1">#certs-log-dir: certs # directory to store the certificates files</span>
</pre></div>
</div>
</div>
<div class="section" id="a-line-based-log-of-http-requests-http-log">
<h5>A line based log of HTTP requests (http.log)<a class="headerlink" href="#a-line-based-log-of-http-requests-http-log" title="Permalink to this headline">¶</a></h5>
<p>This log keeps track of all HTTP-traffic events. It contains the HTTP
request, hostname, URI and the User-Agent. This information will be
stored in the http.log (default name, in the suricata log
directory). This logging can also be performed through the use of the
<a class="reference internal" href="index.html#eve-json-format"><span class="std std-ref">Eve-log capability</span></a>.</p>
<p>Example of a HTTP-log line with non-extended logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">07</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">2014</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">14.338309</span> <span class="n">vg</span><span class="o">.</span><span class="n">no</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="o">/</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10_9_2</span><span class="p">)</span>
<span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">35.0.1916.114</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span>
<span class="mf">192.168.1.6</span><span class="p">:</span><span class="mi">64685</span> <span class="o">-&gt;</span> <span class="mf">195.88.54.16</span><span class="p">:</span><span class="mi">80</span>
</pre></div>
</div>
<p>Example of a HTTP-log line with extended logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">07</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">2014</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">06.994705</span> <span class="n">vg</span><span class="o">.</span><span class="n">no</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="o">/</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10_9_2</span><span class="p">)</span>
<span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">35.0.1916.114</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">no</span> <span class="n">referer</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span>
<span class="n">GET</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="mi">301</span> <span class="o">=&gt;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">vg</span><span class="o">.</span><span class="n">no</span><span class="o">/</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="mi">239</span> <span class="nb">bytes</span> <span class="p">[</span><span class="o">**</span><span class="p">]</span> <span class="mf">192.168.1.6</span><span class="p">:</span><span class="mi">64726</span> <span class="o">-&gt;</span> <span class="mf">195.88.54.16</span><span class="p">:</span><span class="mi">80</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">http</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>                     <span class="c1">#The log-name.</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>                <span class="c1">#This log is enabled. Set &#39;no&#39; to disable.</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">http</span><span class="o">.</span><span class="n">log</span>          <span class="c1">#The name of the file in the default logging directory.</span>
    <span class="n">append</span><span class="p">:</span> <span class="n">yes</span><span class="o">/</span><span class="n">no</span>              <span class="c1">#If this option is set to yes, the last filled http.log-file will not be</span>
                                <span class="c1"># overwritten while restarting Suricata.</span>
    <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>               <span class="c1"># If set to yes more information is written about the event.</span>
</pre></div>
</div>
</div>
<div class="section" id="packet-log-pcap-log">
<span id="suricata-yaml-pcap-log"></span><h5>Packet log (pcap-log)<a class="headerlink" href="#packet-log-pcap-log" title="Permalink to this headline">¶</a></h5>
<p>With the pcap-log option you can save all packets, that are registered
by Suricata, in a log file named _log.pcap_. This way, you can take a
look at all packets whenever you want.  In the normal mode a pcap file
is created in the default-log-dir. It can also be created elsewhere if
a absolute path is set in the yaml-file.</p>
<p>The file that is saved in example the default -log-dir
/var/log/suricata, can be be opened with every program which supports
the pcap file format. This can be Wireshark, TCPdump, Suricata, Snort
and many others.</p>
<p>The pcap-log option can be enabled and disabled.</p>
<p>There is a size limit for the pcap-log file that can be set. The
default limit is 32 MB. If the log-file reaches this limit, the file
will be rotated and a new one will be created. The pcap-log option
has an extra functionality for &quot;Sguil&quot;:<a class="reference external" href="http://sguil.sourceforge.net/">http://sguil.sourceforge.net/</a>
that can be enabled in the 'mode' option. In the sguil mode the
&quot;sguil_base_dir&quot; indicates the base directory. In this base dir the
pcaps are created in a Sguil-specific directory structure that is
based on the day:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$sguil_base_dir/YYYY-MM-DD/$filename.&lt;timestamp&gt;
</pre></div>
</div>
<p>If you would like to use Suricata with Sguil, do not forget to enable
(and if necessary modify) the base dir in the suricata.yaml file.
Remember that in the 'normal' mode, the file will be saved in
default-log-dir or in the absolute path (if set).</p>
<p>The pcap files can be compressed before being written to disk by setting
the compression option to lz4. This option is incompatible with sguil
mode. Note: On Windows, this option increases disk I/O instead of
reducing it. When using lz4 compression, you can enable checksums using
the lz4-checksum option, and you can set the compression level lz4-level
to a value between 0 and 16, where higher levels result in higher
compression.</p>
<p>By default all packets are logged except:</p>
<ul class="simple">
<li>TCP streams beyond stream.reassembly.depth</li>
<li>encrypted streams after the key exchange</li>
</ul>
<p>It is possible to do conditional pcap logging by using the <cite>conditional</cite>
option in the pcap-log section. By default the variable is set to <cite>all</cite>
so all packets are logged. If the variable is set to <cite>alerts</cite> then only
the flow with alerts will be logged. If the variable is set to <cite>tag</cite>
then only packets tagged by signatures using the <cite>tag</cite> keyword will
be logged to the pcap file. Please note that if <cite>alerts</cite> or <cite>tag</cite> is
used, then in the case of TCP session, Suricata will use available
information from the streaming engine to log data that have triggered
the alert.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">pcap</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span>  <span class="n">yes</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">pcap</span>

    <span class="c1"># Limit in MB.</span>
    <span class="n">limit</span><span class="p">:</span> <span class="mi">32</span>

    <span class="n">mode</span><span class="p">:</span> <span class="n">sguil</span> <span class="c1"># &quot;normal&quot; (default) or sguil.</span>
    <span class="n">sguil_base_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">nsm_data</span><span class="o">/</span>
    <span class="n">conditional</span><span class="p">:</span> <span class="n">alerts</span>
</pre></div>
</div>
</div>
<div class="section" id="verbose-alerts-log-alert-debug-log">
<h5>Verbose Alerts Log (alert-debug.log)<a class="headerlink" href="#verbose-alerts-log-alert-debug-log" title="Permalink to this headline">¶</a></h5>
<p>This is a log type that gives supplementary information about an
alert. It is particularly convenient for people who investigate false
positives and who write signatures. However, it lowers the performance
because of the amount of information it has to store.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">alert</span><span class="o">-</span><span class="n">debug</span><span class="p">:</span>                  <span class="c1">#The log-name.</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>                 <span class="c1">#This log is not enabled. Set &#39;yes&#39; to enable.</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">alert</span><span class="o">-</span><span class="n">debug</span><span class="o">.</span><span class="n">log</span>   <span class="c1">#The name of the file in the default logging directory.</span>
    <span class="n">append</span><span class="p">:</span> <span class="n">yes</span><span class="o">/</span><span class="n">no</span>              <span class="c1">#If this option is set to yes, the last filled fast.log-file will not be</span>
                                <span class="c1"># overwritten while restarting Suricata.</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h5>Stats<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<p>In stats you can set the options for stats.log.  When enabling
stats.log you can set the amount of time in seconds after which you
want the output-data to be written to the log file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">stats</span><span class="p">:</span>
     <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>               <span class="c1">#By default, the stats-option is enabled</span>
     <span class="n">filename</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">log</span>        <span class="c1">#The log-name. Combined with the default logging directory</span>
                                <span class="c1">#(default-log-dir) it will result in /var/log/suricata/stats.log.</span>
                                <span class="c1">#This directory can be overruled with a absolute path. (A</span>
                                <span class="c1">#directory starting with / ).</span>
     <span class="n">append</span><span class="p">:</span> <span class="n">yes</span><span class="o">/</span><span class="n">no</span>             <span class="c1">#If this option is set to yes, the last filled fast.log-file will not be</span>
                                <span class="c1">#overwritten while restarting Suricata.</span>
</pre></div>
</div>
<p>The interval and several other options depend on the global stats
section as described above.</p>
</div>
<div class="section" id="syslog">
<h5>Syslog<a class="headerlink" href="#syslog" title="Permalink to this headline">¶</a></h5>
<p>With this option it is possible to send all alert and event output to syslog.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">syslog</span><span class="p">:</span>                       <span class="c1">#This is a output-module to direct log-output to several directions.</span>
     <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>                <span class="c1">#The use of this output-module is not enabled.</span>
     <span class="n">facility</span><span class="p">:</span> <span class="n">local5</span>           <span class="c1">#In this option you can set a syslog facility.</span>
     <span class="n">level</span><span class="p">:</span> <span class="n">Info</span>                <span class="c1">#In this option you can set the level of output. The possible levels are:</span>
                                <span class="c1">#Emergency, Alert, Critical, Error, Warning, Notice, Info and Debug.</span>
</pre></div>
</div>
</div>
<div class="section" id="file-store-file-extraction">
<span id="suricata-yaml-file-store"></span><h5>File-store (File Extraction)<a class="headerlink" href="#file-store-file-extraction" title="Permalink to this headline">¶</a></h5>
<p>The <cite>file-store</cite> output enables storing of extracted files to disk and
configures where they are stored.</p>
<p>The following shows the configuration options for version 2 of the
<cite>file-store</cite> output.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">file-store</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># This configures version 2 of the file-store.</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>

<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>

<span class="w">    </span><span class="c1"># Set the directory for the filestore. If the path is not</span>
<span class="w">    </span><span class="c1"># absolute will be be relative to the default-log-dir.</span>
<span class="w">    </span><span class="c1">#dir: filestore</span>

<span class="w">    </span><span class="c1"># Write out a fileinfo record for each occurrence of a</span>
<span class="w">    </span><span class="c1"># file. Disabled by default as each occurrence is already logged</span>
<span class="w">    </span><span class="c1"># as a fileinfo record to the main eve-log.</span>
<span class="w">    </span><span class="c1">#write-fileinfo: yes</span>

<span class="w">    </span><span class="c1"># Force storing of all files. Default: no.</span>
<span class="w">    </span><span class="c1">#force-filestore: yes</span>

<span class="w">    </span><span class="c1"># Override the global stream-depth for sessions in which we want</span>
<span class="w">    </span><span class="c1"># to perform file extraction. Set to 0 for unlimited; otherwise,</span>
<span class="w">    </span><span class="c1"># must be greater than the global stream-depth value to be used.</span>
<span class="w">    </span><span class="c1">#stream-depth: 0</span>

<span class="w">    </span><span class="c1"># Uncomment the following variable to define how many files can</span>
<span class="w">    </span><span class="c1"># remain open for filestore by Suricata. Default value is 0 which</span>
<span class="w">    </span><span class="c1"># means files get closed after each write</span>
<span class="w">    </span><span class="c1">#max-open-files: 1000</span>

<span class="w">    </span><span class="c1"># Force logging of checksums, available hash functions are md5,</span>
<span class="w">    </span><span class="c1"># sha1 and sha256. Note that SHA256 is automatically forced by</span>
<span class="w">    </span><span class="c1"># the use of this output module as it uses the SHA256 as the</span>
<span class="w">    </span><span class="c1"># file naming scheme.</span>
<span class="w">    </span><span class="c1">#force-hash: [sha1, md5]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="detection-engine">
<h4>Detection engine<a class="headerlink" href="#detection-engine" title="Permalink to this headline">¶</a></h4>
<div class="section" id="inspection-configuration">
<h5>Inspection configuration<a class="headerlink" href="#inspection-configuration" title="Permalink to this headline">¶</a></h5>
<p>The detection-engine builds internal groups of signatures. Suricata loads signatures, with which the network traffic will be compared. The fact is, that many rules certainly will not be necessary. (For instance: if there appears a packet with the UDP-protocol, all signatures for the TCP-protocol won't be needed.) For that reason, all signatures will be divided in groups. However, a distribution containing many groups will make use of a lot of memory. Not every type of signature gets its own group. There is a possibility that different signatures with several properties in common, will be placed together in a group. The quantity of groups will determine the balance between memory and performance. A small amount of groups will lower the performance yet uses little memory. The opposite counts for a higher amount of groups. The engine allows you to manage the balance between memory and performance. To manage this, (by determining the amount of groups) there are several general options: high for good performance and more use of memory, low for low performance and little use of memory. The option medium is the balance between performance and memory usage. This is the default setting. The option custom is for advanced users. This option has values which can be managed by the user.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detect</span><span class="p">:</span>
  <span class="n">profile</span><span class="p">:</span> <span class="n">medium</span>
  <span class="n">custom</span><span class="o">-</span><span class="n">values</span><span class="p">:</span>
    <span class="n">toclient</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">toserver</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span> <span class="mi">25</span>
  <span class="n">sgh</span><span class="o">-</span><span class="n">mpm</span><span class="o">-</span><span class="n">context</span><span class="p">:</span> <span class="n">auto</span>
  <span class="n">inspection</span><span class="o">-</span><span class="n">recursion</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">3000</span>
</pre></div>
</div>
<p>At all of these options, you can add (or change) a value. Most
signatures have the adjustment to focus on one direction, meaning
focusing exclusively on the server, or exclusively on the client.</p>
<p>If you take a look at example 4, <em>the Detection-engine grouping tree</em>,
you see it has many branches. At the end of each branch, there is
actually a 'sig group head'. Within that sig group head there is a
container which contains a list with signatures that are significant
for that specific group/that specific end of the branch. Also within
the sig group head the settings for Multi-Pattern-Matcher (MPM) can be
found: the MPM-context.</p>
<p>As will be described again at the part 'Pattern matching settings',
there are several MPM-algorithms of which can be chosen from. Because
every sig group head has its own MPM-context, some algorithms use a
lot of memory. For that reason there is the option sgh-mpm-context to
set whether the groups share one MPM-context, or to set that every
group has its own MPM-context.</p>
<p>For setting the option sgh-mpm-context, you can choose from auto, full
or single. The default setting is 'auto', meaning Suricata selects
full or single based on the algorithm you use. 'Full' means that every
group has its own MPM-context, and 'single' that all groups share one
MPM-context. The two algorithms ac and ac-gfbs are new in 1.03. These
algorithms use a single MPM-context if the Sgh-MPM-context setting is
'auto'. The rest of the algorithms use full in that case.</p>
<p>The inspection-recursion-limit option has to mitigate that possible
bugs in Suricata cause big problems. Often Suricata has to deal with
complicated issues. It could end up in an 'endless loop' due to a bug,
meaning it will repeat its actions over and over again. With the
option inspection-recursion-limit you can limit this action.</p>
<p><em>Example 4      Detection-engine grouping tree</em></p>
<img alt="_images/grouping_tree.png" src="_images/grouping_tree.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">src</span>             <span class="n">Stands</span> <span class="k">for</span> <span class="n">source</span> <span class="n">IP</span><span class="o">-</span><span class="n">address</span><span class="o">.</span>
<span class="n">dst</span>             <span class="n">Stands</span> <span class="k">for</span> <span class="n">destination</span> <span class="n">IP</span><span class="o">-</span><span class="n">address</span><span class="o">.</span>
<span class="n">sp</span>              <span class="n">Stands</span> <span class="k">for</span> <span class="n">source</span> <span class="n">port</span><span class="o">.</span>
<span class="n">dp</span>              <span class="n">Stands</span> <span class="k">for</span> <span class="n">destination</span> <span class="n">port</span><span class="o">.</span>
</pre></div>
</div>
<p><em>Example 5       Detail grouping tree</em></p>
<img alt="_images/grouping_tree_detail.png" src="_images/grouping_tree_detail.png" />
</div>
<div class="section" id="prefilter-engines">
<span id="suricata-yaml-prefilter"></span><h5>Prefilter Engines<a class="headerlink" href="#prefilter-engines" title="Permalink to this headline">¶</a></h5>
<p>The concept of prefiltering is that there are far too many rules to inspect individually. The approach prefilter takes is that from each rule one condition is added to prefilter, which is then checked in one step. The most common example is MPM (also known as fast_pattern). This takes a single pattern per rule and adds it to the MPM. Only for those rules that have at least one pattern match in the MPM stage, individual inspection is performed.</p>
<p>Next to MPM, other types of keywords support prefiltering. ICMP itype, icode, icmp_seq and icmp_id for example. TCP window, IP TTL are other examples.</p>
<p>For a full list of keywords that support prefilter, see:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">keywords</span><span class="o">=</span><span class="nb">all</span>
</pre></div>
</div>
<p>Suricata can automatically select prefilter options, or it can be set manually.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detect</span><span class="p">:</span>
  <span class="n">prefilter</span><span class="p">:</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">mpm</span>
</pre></div>
</div>
<p>By default, only MPM/fast_pattern is used.</p>
<p>The prefilter engines for other non-MPM keywords can then be enabled in specific rules by using the 'prefilter' keyword.</p>
<p>E.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">ip</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">ttl</span><span class="p">:</span><span class="mi">123</span><span class="p">;</span> <span class="n">prefilter</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>To let Suricata make these decisions set default to 'auto':</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detect</span><span class="p">:</span>
  <span class="n">prefilter</span><span class="p">:</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">auto</span>
</pre></div>
</div>
</div>
<div class="section" id="pattern-matcher-settings">
<h5>Pattern matcher settings<a class="headerlink" href="#pattern-matcher-settings" title="Permalink to this headline">¶</a></h5>
<p>The multi-pattern-matcher (MPM) is a part of the detection engine
within Suricata that searches for multiple patterns at
once. Often, signatures have one or more patterns. Of each
signature, one pattern is used by the multi-pattern-matcher. That way
Suricata can exclude many signatures from being examined, because a
signature can only match when all its patterns match.</p>
<p>These are the proceedings:</p>
<ol class="arabic simple">
<li>A packet comes in.</li>
<li>The packed will be analyzed by the Multi-pattern-matcher in search of patterns that match.</li>
<li>All patterns that match, will be further processed by Suricata (signatures).</li>
</ol>
<p><em>Example 8      Multi-pattern-matcher</em></p>
<img alt="_images/MPM2.png" src="_images/MPM2.png" />
<p>Suricata offers various implementations of different
multi-pattern-matcher algorithm's. These can be found below.</p>
<p>To set the multi-pattern-matcher algorithm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpm</span><span class="o">-</span><span class="n">algo</span><span class="p">:</span> <span class="n">ac</span>
</pre></div>
</div>
<p>After 'mpm-algo', you can enter one of the following algorithms: ac, hs and ac-ks.</p>
<p>On <cite>x86_64</cite> hs (Hyperscan) should be used for best performance.</p>
</div>
</div>
<div class="section" id="threading">
<span id="suricata-yaml-threading"></span><h4>Threading<a class="headerlink" href="#threading" title="Permalink to this headline">¶</a></h4>
<p>Suricata is multi-threaded. Suricata uses multiple CPUs/CPU cores so
it can process a lot of network packets simultaneously. (In a
single-core engine, the packets will be processed one at a time.)</p>
<p>There are four thread-modules: Packet acquisition, decode and stream
application layer, detection, and outputs.</p>
<p># The packet acquisition module reads packets from the network.</p>
<p># The decode module decodes the packets and the stream application
application layer has three tasks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">First</span><span class="p">:</span> <span class="n">it</span> <span class="n">performs</span> <span class="n">stream</span><span class="o">-</span><span class="n">tracking</span><span class="p">,</span> <span class="n">meaning</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">making</span> <span class="n">sure</span> <span class="nb">all</span> <span class="n">steps</span> <span class="n">will</span> <span class="n">be</span> <span class="n">taken</span> <span class="n">to</span> <span class="n">make</span> <span class="n">a</span> <span class="n">correct</span> <span class="n">network</span><span class="o">-</span><span class="n">connection</span><span class="o">.</span>
<span class="n">Second</span><span class="p">:</span> <span class="n">TCP</span><span class="o">-</span><span class="n">network</span> <span class="n">traffic</span> <span class="n">comes</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">packets</span><span class="o">.</span> <span class="n">The</span> <span class="n">Stream</span><span class="o">-</span><span class="n">Assembly</span> <span class="n">engine</span> <span class="n">reconstructs</span> <span class="n">the</span> <span class="n">original</span> <span class="n">stream</span><span class="o">.</span>
<span class="n">Finally</span><span class="p">:</span> <span class="n">the</span> <span class="n">application</span> <span class="n">layer</span> <span class="n">will</span> <span class="n">be</span> <span class="n">inspected</span><span class="o">.</span> <span class="n">HTTP</span> <span class="ow">and</span> <span class="n">DCERPC</span> <span class="n">will</span> <span class="n">be</span> <span class="n">analyzed</span><span class="o">.</span>
</pre></div>
</div>
<p># The detection threads will compare signatures. There can be several detection threads so they can operate simultaneously.</p>
<p># In Outputs all alerts and events will be processed.</p>
<p><em>Example 6      Threading</em></p>
<img alt="_images/threading.png" src="_images/threading.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Packet</span> <span class="n">acquisition</span><span class="p">:</span>             <span class="n">Reads</span> <span class="n">packets</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">network</span>
<span class="n">Decode</span><span class="p">:</span>                         <span class="n">Decodes</span> <span class="n">packets</span><span class="o">.</span>
<span class="n">Stream</span> <span class="n">app</span><span class="o">.</span> <span class="n">Layer</span><span class="p">:</span>              <span class="n">Performs</span> <span class="n">stream</span><span class="o">-</span><span class="n">tracking</span> <span class="ow">and</span> <span class="n">reassembly</span><span class="o">.</span>
<span class="n">Detect</span><span class="p">:</span>                         <span class="n">Compares</span> <span class="n">signatures</span><span class="o">.</span>
<span class="n">Outputs</span><span class="p">:</span>                        <span class="n">Processes</span> <span class="nb">all</span> <span class="n">events</span> <span class="ow">and</span> <span class="n">alerts</span><span class="o">.</span>
</pre></div>
</div>
<p>Most computers have multiple CPU's/ CPU cores. By default the
operating system determines which core works on which thread. When a
core is already occupied, another one will be designated to work on
the thread. So, which core works on which thread, can differ from time
to time.</p>
<p>There is an option within threading:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<p>With this option you can cause Suricata setting fixed cores for every
thread. In that case 1, 2 and 4 are at core 0 (zero). Each core has
its own detect thread. The detect thread running on core 0 has a lower
priority than the other threads running on core 0. If these other
cores are to occupied, the detect thread on core 0 has not much
packets to process. The detect threads running on other cores will
process more packets. This is only the case after setting the option
to 'yes'.</p>
<p><em>Example 7      Balancing workload</em></p>
<img alt="_images/balancing_workload.png" src="_images/balancing_workload.png" />
<p>You can set the detect-thread-ratio:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detect</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="n">ratio</span><span class="p">:</span> <span class="mf">1.5</span>
</pre></div>
</div>
<p>The detect thread-ratio will determine the amount of detect
threads. By default it will be 1.5 x the amount of CPU's/CPU cores
present at your computer. This will result in having more detection
threads then CPU's/ CPU cores. Meaning you are oversubscribing the
amount of cores. This may be convenient at times when there have to be
waited for a detection thread. The remaining detection thread can
become active.</p>
<p>You can alter the per-thread stack-size if the default provided by
your build system is too small. The default value is provided by
your build system; we suggest setting the value to 8MB if the default
value is too small.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stack</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">8</span><span class="n">MB</span>
</pre></div>
</div>
<p>In the option 'cpu affinity' you can set which CPU's/cores work on which
thread. In this option there are several sets of threads. The management-,
receive-, worker- and verdict-set. These are fixed names and can not be
changed. For each set there are several options: cpu, mode, and prio. In the
option 'cpu' you can set the numbers of the CPU's/cores which will run the
threads from that set. You can set this option to 'all', use a range (0-3) or a
comma separated list (0,1).  The option 'mode' can be set to 'balanced' or
'exclusive'. When set to 'balanced', the individual threads can be processed by
all cores set in the option 'cpu'. If the option 'mode' is set to 'exclusive',
there will be fixed cores for each thread. As mentioned before, threads can
have different priority's. In the option 'prio' you can set a priority for each
thread. This priority can be low, medium, high or you can set the priority to
'default'. If you do not set a priority for a CPU, than the settings in
'default' will count. By default Suricata creates one 'detect' (worker) thread
per available CPU/CPU core.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The 'prio' settings could overwrite each other, make sure to not
include the same CPU core in different 'prio' settings.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
      <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>  <span class="c1"># include only these cpus in affinity settings</span>
  <span class="o">-</span> <span class="n">receive</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
      <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>  <span class="c1"># include only these cpus in affinity settings</span>
  <span class="o">-</span> <span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
      <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;all&quot;</span> <span class="p">]</span>
      <span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;exclusive&quot;</span>
      <span class="c1"># Use explicitly 3 threads and don&#39;t compute number by using</span>
      <span class="c1"># detect-thread-ratio variable:</span>
      <span class="c1"># threads: 3</span>
      <span class="n">prio</span><span class="p">:</span>
        <span class="n">low</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
        <span class="n">medium</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;1-2&quot;</span> <span class="p">]</span>
        <span class="n">high</span><span class="p">:</span> <span class="p">[</span> <span class="mi">3</span> <span class="p">]</span>
        <span class="n">default</span><span class="p">:</span> <span class="s2">&quot;medium&quot;</span>
  <span class="o">-</span> <span class="n">verdict</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
      <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
      <span class="n">prio</span><span class="p">:</span>
        <span class="n">default</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span>
</pre></div>
</div>
<div class="section" id="relevant-cpu-affinity-settings-for-ids-ips-modes">
<h5>Relevant cpu-affinity settings for IDS/IPS modes<a class="headerlink" href="#relevant-cpu-affinity-settings-for-ids-ips-modes" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="ids-mode">
<h5>IDS mode<a class="headerlink" href="#ids-mode" title="Permalink to this headline">¶</a></h5>
<p>Runmode AutoFp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">management</span> <span class="p">(</span><span class="n">example</span> <span class="o">-</span> <span class="n">flow</span><span class="o">.</span><span class="n">managers</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">recyclers</span><span class="p">)</span>
<span class="n">receive</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">receive</span> <span class="ow">and</span> <span class="n">decode</span>
<span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">streamtcp</span><span class="p">,</span><span class="n">detect</span><span class="p">,</span><span class="n">output</span><span class="p">(</span><span class="n">logging</span><span class="p">),</span><span class="n">reject</span>
</pre></div>
</div>
<p>Rumode Workers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">management</span> <span class="p">(</span><span class="n">example</span> <span class="o">-</span> <span class="n">flow</span><span class="o">.</span><span class="n">managers</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">recyclers</span><span class="p">)</span>
<span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">receive</span><span class="p">,</span><span class="n">streamtcp</span><span class="p">,</span><span class="n">decode</span><span class="p">,</span><span class="n">detect</span><span class="p">,</span><span class="n">output</span><span class="p">(</span><span class="n">logging</span><span class="p">),</span><span class="n">respond</span><span class="o">/</span><span class="n">reject</span>
</pre></div>
</div>
</div>
<div class="section" id="ips-mode">
<h5>IPS mode<a class="headerlink" href="#ips-mode" title="Permalink to this headline">¶</a></h5>
<p>Runmode AutoFp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">management</span> <span class="p">(</span><span class="n">example</span> <span class="o">-</span> <span class="n">flow</span><span class="o">.</span><span class="n">managers</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">recyclers</span><span class="p">)</span>
<span class="n">receive</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">receive</span> <span class="ow">and</span> <span class="n">decode</span>
<span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">streamtcp</span><span class="p">,</span><span class="n">detect</span><span class="p">,</span><span class="n">output</span><span class="p">(</span><span class="n">logging</span><span class="p">)</span>
<span class="n">verdict</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">verdict</span> <span class="ow">and</span> <span class="n">respond</span><span class="o">/</span><span class="n">reject</span>
</pre></div>
</div>
<p>Runmode Workers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">management</span> <span class="p">(</span><span class="n">example</span> <span class="o">-</span> <span class="n">flow</span><span class="o">.</span><span class="n">managers</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">recyclers</span><span class="p">)</span>
<span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span> <span class="o">-</span> <span class="n">used</span> <span class="k">for</span> <span class="n">receive</span><span class="p">,</span><span class="n">streamtcp</span><span class="p">,</span><span class="n">decode</span><span class="p">,</span><span class="n">detect</span><span class="p">,</span><span class="n">output</span><span class="p">(</span><span class="n">logging</span><span class="p">),</span><span class="n">respond</span><span class="o">/</span><span class="n">reject</span><span class="p">,</span> <span class="n">verdict</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ip-defrag">
<h4>IP Defrag<a class="headerlink" href="#ip-defrag" title="Permalink to this headline">¶</a></h4>
<p>Occasionally network packets appear fragmented. On some networks it
occurs more often than on others. Fragmented packets exist of many
parts. Before Suricata is able to inspect these kind of packets
accurately, the packets have to be reconstructed. This will be done by
a component of Suricata; the defragment-engine. After a fragmented
packet is reconstructed by the defragment-engine, the engine sends on
the reassembled packet to rest of Suricata.</p>
<p>At the moment Suricata receives a fragment of a packet, it
keeps in memory that other fragments of that packet will appear soon
to complete the packet. However, there is a possibility that one of
the fragments does not appear. To prevent Suricata for keeping waiting
for that packet (thereby using memory) there is a timespan after which
Suricata discards the fragments (timeout). This occurs by default after 60
seconds.</p>
<p>In IPS mode, it is possible to tell the engine what to do in case the memcap for
the defrag engine is reached: &quot;drop-packet&quot;, &quot;pass-packet&quot;, or &quot;ignore&quot; (default
behavior).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defrag</span><span class="p">:</span>
  <span class="n">memcap</span><span class="p">:</span> <span class="mi">32</span><span class="n">mb</span>
  <span class="n">memcap</span><span class="o">-</span><span class="n">policy</span><span class="p">:</span> <span class="n">ignore</span>  <span class="c1"># in IPS mode, what to do if memcap is reached</span>
  <span class="nb">hash</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">65536</span>
  <span class="n">trackers</span><span class="p">:</span> <span class="mi">65535</span>        <span class="c1"># number of defragmented flows to follow</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">frags</span><span class="p">:</span> <span class="mi">65535</span>       <span class="c1"># number of fragments do keep (higher than trackers)</span>
  <span class="n">prealloc</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">timeout</span><span class="p">:</span> <span class="mi">60</span>
</pre></div>
</div>
</div>
<div class="section" id="flow-and-stream-handling">
<h4>Flow and Stream handling<a class="headerlink" href="#flow-and-stream-handling" title="Permalink to this headline">¶</a></h4>
<div class="section" id="flow-settings">
<span id="suricata-yaml-flow-settings"></span><h5>Flow Settings<a class="headerlink" href="#flow-settings" title="Permalink to this headline">¶</a></h5>
<p>Within Suricata, Flows are very important. They play a big part in the
way Suricata organizes data internally. A flow is a bit similar to a
connection, except a flow is more general. All packets having the same
Tuple (protocol, source IP, destination IP, source-port,
destination-port), belong to the same flow. Packets belonging to a
flow are connected to it internally.</p>
<p><em>Example 9      Flow</em></p>
<img alt="_images/flow.png" src="_images/flow.png" />
<p><em>Example 10     Tuple</em></p>
<img alt="_images/Tuple1.png" src="_images/Tuple1.png" />
<p>Keeping track of all these flows, uses memory. The more flows, the
more memory it will cost.</p>
<p>To keep control over memory usage, there are several options:</p>
<p>The option memcap for setting the maximum amount of bytes the
flow-engine will use, hash-size for setting the size of the hash-table
and prealloc for the following:</p>
<blockquote>
<div>For packets not yet belonging to a flow, Suricata creates a
new flow. This is a relative expensive action. The risk coming
with it, is that attackers /hackers can a attack the engine
system at this part. When they make sure a computer gets a lot
of packets with different tuples, the engine has to make a lot
of new flows. This way, an attacker could flood the system. To
mitigate the engine from being overloaded, this option
instructs Suricata to keep a number of flows ready in
memory. This way Suricata is less vulnerable to these kind of
attacks.</div></blockquote>
<p>The flow-engine has a management thread that operates independent from
the packet processing. This thread is called the flow-manager. This
thread ensures that wherever possible and within the memcap. There
will be 10000 flows prepared.</p>
<p>In IPS mode, a memcap-policy exception policy can be set, telling Suricata
what to do in case memcap is hit: 'drop-packet', 'pass-packet', 'reject', or
'ignore'.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="p">:</span>
  <span class="n">memcap</span><span class="p">:</span> <span class="mi">33554432</span>              <span class="c1">#The maximum amount of bytes the flow-engine will make use of.</span>
  <span class="n">memcap</span><span class="o">-</span><span class="n">policy</span><span class="p">:</span> <span class="n">bypass</span>         <span class="c1">#How to handle the flow if memcap is reached (IPS mode)</span>
  <span class="n">hash_size</span><span class="p">:</span> <span class="mi">65536</span>              <span class="c1">#Flows will be organized in a hash-table. With this option you can set the</span>
                                <span class="c1">#size of the hash-table.</span>
  <span class="n">Prealloc</span><span class="p">:</span> <span class="mi">10000</span>               <span class="c1">#The amount of flows Suricata has to keep ready in memory.</span>
</pre></div>
</div>
<p>At the point the memcap will still be reached, despite prealloc, the
flow-engine goes into the emergency-mode. In this mode, the engine
will make use of shorter time-outs. It lets flows expire in a more
aggressive manner so there will be more space for new Flows.</p>
<p>There are two options: emergency_recovery and prune_flows. The
emergency recovery is set on 30. This is the percentage of prealloc'd
flows after which the flow-engine will be back to normal (when 30
percent of the 10000 flows is completed).</p>
<blockquote>
<div>If during the emergency-mode, the aggressive time-outs do not
have the desired result, this option is the final resort. It
ends some flows even if they have not reached their time-outs
yet. The prune-flows option shows how many flows there will be
terminated at each time a new flow is set up.</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">emergency_recovery</span><span class="p">:</span> <span class="mi">30</span>                  <span class="c1">#Percentage of 1000 prealloc&#39;d flows.</span>
<span class="n">prune_flows</span><span class="p">:</span> <span class="mi">5</span>                          <span class="c1">#Amount of flows being terminated during the emergency mode.</span>
</pre></div>
</div>
</div>
<div class="section" id="flow-time-outs">
<h5>Flow Time-Outs<a class="headerlink" href="#flow-time-outs" title="Permalink to this headline">¶</a></h5>
<p>The amount of time Suricata keeps a flow in memory is determined by
the Flow time-out.</p>
<p>There are different states in which a flow can be. Suricata
distinguishes three flow-states for TCP and two for UDP. For TCP,
these are: New, Established and Closed,for UDP only new and
established. For each of these states Suricata can employ different
timeouts.</p>
<p>The state new in a TCP-flow, means the period during the three way
handshake. The state established is the state when the three way
handshake is completed. The state closed in the TCP-flow: there a
several ways to end a flow. This is by means of Reset or the Four-way
FIN handshake.</p>
<p>New in a UDP-flow: the state in which packets are send from only one
direction.</p>
<p>Established in a UDP-flow: packets are send from both directions.</p>
<p>In the example configuration the are settings for each protocol. TCP,
UDP, ICMP and default (all other protocols).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="o">-</span><span class="n">timeouts</span><span class="p">:</span>

  <span class="n">default</span><span class="p">:</span>
    <span class="n">new</span><span class="p">:</span> <span class="mi">30</span>                     <span class="c1">#Time-out in seconds after the last activity in this flow in a New state.</span>
    <span class="n">established</span><span class="p">:</span> <span class="mi">300</span>            <span class="c1">#Time-out in seconds after the last activity in this flow in a Established</span>
                                <span class="c1">#state.</span>
    <span class="n">emergency_new</span><span class="p">:</span> <span class="mi">10</span>           <span class="c1">#Time-out in seconds after the last activity in this flow in a New state</span>
                                <span class="c1">#during the emergency mode.</span>
    <span class="n">emergency_established</span><span class="p">:</span> <span class="mi">100</span>  <span class="c1">#Time-out in seconds after the last activity in this flow in a Established</span>
                                <span class="c1">#state in the emergency mode.</span>
  <span class="n">tcp</span><span class="p">:</span>
    <span class="n">new</span><span class="p">:</span> <span class="mi">60</span>
    <span class="n">established</span><span class="p">:</span> <span class="mi">3600</span>
    <span class="n">closed</span><span class="p">:</span> <span class="mi">120</span>
    <span class="n">emergency_new</span><span class="p">:</span> <span class="mi">10</span>
    <span class="n">emergency_established</span><span class="p">:</span> <span class="mi">300</span>
    <span class="n">emergency_closed</span><span class="p">:</span> <span class="mi">20</span>
  <span class="n">udp</span><span class="p">:</span>
    <span class="n">new</span><span class="p">:</span> <span class="mi">30</span>
    <span class="n">established</span><span class="p">:</span> <span class="mi">300</span>
    <span class="n">emergency_new</span><span class="p">:</span> <span class="mi">10</span>
    <span class="n">emergency_established</span><span class="p">:</span> <span class="mi">100</span>
  <span class="n">icmp</span><span class="p">:</span>
    <span class="n">new</span><span class="p">:</span> <span class="mi">30</span>
    <span class="n">established</span><span class="p">:</span> <span class="mi">300</span>
    <span class="n">emergency_new</span><span class="p">:</span> <span class="mi">10</span>
    <span class="n">emergency_established</span><span class="p">:</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="section" id="stream-engine">
<h5>Stream-engine<a class="headerlink" href="#stream-engine" title="Permalink to this headline">¶</a></h5>
<p>The Stream-engine keeps track of the TCP-connections. The engine
exists of two parts: The stream tracking- and the reassembly-engine.</p>
<p>The stream-tracking engine monitors the state of a connection. The
reassembly-engine reconstructs the flow as it used to be, so it will
be recognized by Suricata.</p>
<p>The stream-engine has two memcaps that can be set. One for the
stream-tracking-engine and one for the reassembly-engine. For both cases,
in IPS mode, an exception policy (memcap-policy) can be set, telling Suricata
what to do in case memcap is hit: 'drop-flow', 'drop-packet', 'pass-flow',
'pass-packet', 'bypass', 'reject', or 'ignore'.</p>
<p>The stream-tracking-engine keeps information of the flow in
memory. Information about the state, TCP-sequence-numbers and the TCP
window. For keeping this information, it can make use of the capacity
the memcap allows.</p>
<p>TCP packets have a so-called checksum. This is an internal code which
makes it possible to see if a packet has arrived in a good state. The
stream-engine will not process packets with a wrong checksum. This
option can be set off by entering 'no' instead of 'yes'.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="p">:</span>
  <span class="n">memcap</span><span class="p">:</span> <span class="mi">64</span><span class="n">mb</span>                <span class="c1"># Max memory usage (in bytes) for TCP session tracking</span>
  <span class="n">memcap</span><span class="o">-</span><span class="n">policy</span><span class="p">:</span> <span class="n">ignore</span>       <span class="c1"># In IPS mode, call memcap policy if memcap is reached</span>
  <span class="n">checksum_validation</span><span class="p">:</span> <span class="n">yes</span>    <span class="c1"># Validate packet checksum, reject packets with invalid checksums.</span>
</pre></div>
</div>
<p>To mitigate Suricata from being overloaded by fast session creation,
the option prealloc_sessions instructs Suricata to keep a number of
sessions ready in memory.</p>
<p>A TCP-session starts with the three-way-handshake. After that, data
can be sent and received. A session can last a long time. It can happen
that Suricata will be started after a few TCP sessions have already been
started. This way, Suricata misses the original setup of those
sessions. This setup always includes a lot of information. If you want
Suricata to check the stream from that time on, you can do so by
setting the option 'midstream' to 'true'. The default setting is
'false'. In IPS mode, it is possible to define a 'midstream-policy',
indicating whether Suricata should drop-flow, drop-packet, pass-flow,
pass-packet, reject, or bypass a midstream flow. The default is ignore.
Normally Suricata is able to see all packets of a connection. Some networks
make it more complicated though. Some of the network-traffic follows a
different route than the other part, in other words: the traffic goes
asynchronous. To make sure Suricata will check the one part it does see,
instead of getting confused, the option 'async-oneside' is brought to life. By
default the option is set to 'false'.</p>
<p>Suricata inspects content in the normal/IDS mode in chunks. In the
inline/IPS mode it does that on the sliding window way (see example
..) In the case Suricata is set in inline mode, it has to inspect
packets immediately before sending it to the receiver. This way
Suricata is able to drop a packet directly if needed.(see example …)
It is important for Suricata to note which operating system it is
dealing with, because operating systems differ in the way they process
anomalies in streams. See <a class="reference internal" href="#host-os-policy"><span class="std std-ref">Host-os-policy</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prealloc_sessions</span><span class="p">:</span> <span class="mi">32768</span>     <span class="c1"># 32k sessions prealloc&#39;d</span>
<span class="n">midstream</span><span class="p">:</span> <span class="n">false</span>             <span class="c1"># do not allow midstream session pickups</span>
<span class="n">midstream</span><span class="o">-</span><span class="n">policy</span><span class="p">:</span> <span class="n">drop</span><span class="o">-</span><span class="n">flow</span>  <span class="c1"># in IPS mode, drop flows that start midstream</span>
<span class="n">async_oneside</span><span class="p">:</span> <span class="n">false</span>         <span class="c1"># do not enable async stream handling</span>
<span class="n">inline</span><span class="p">:</span> <span class="n">no</span>                   <span class="c1"># stream inline mode</span>
<span class="n">drop</span><span class="o">-</span><span class="n">invalid</span><span class="p">:</span> <span class="n">yes</span>            <span class="c1"># drop invalid packets</span>
<span class="n">bypass</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">drop-invalid</span></code> option can be set to no to avoid blocking packets that are
seen invalid by the streaming engine. This can be useful to cover some weird cases
seen in some layer 2 IPS setup.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">bypass</span></code> option activates 'bypass' for a flow/session when either side
of the session reaches its <code class="docutils literal notranslate"><span class="pre">depth</span></code>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">bypass</span></code> can lead to missing important traffic. Use with care.</p>
</div>
<p><strong>Example 11   Normal/IDS mode</strong></p>
<p>Suricata inspects traffic in chunks.</p>
<img alt="_images/normal_ids.png" src="_images/normal_ids.png" />
<p><strong>Example 12     Inline/IPS Sliding Window</strong></p>
<p>Suricata inspects traffic in a sliding window manner.</p>
<img alt="_images/inline_mode.png" src="_images/inline_mode.png" />
<p><strong>Example 13     Normal/IDS (reassembly on ACK'D data)</strong></p>
<img alt="_images/Normal_ids_ack_d.png" src="_images/Normal_ids_ack_d.png" />
<p><strong>Example 14 Inline/IPS (reassembly on UNACK'D data)</strong></p>
<img alt="_images/Inline_reassembly_unackd_data.png" src="_images/Inline_reassembly_unackd_data.png" />
<p>The reassembly-engine has to keep data segments in memory in order to
be able to reconstruct a stream. To avoid resource starvation a memcap
is used to limit the memory used. In IPS mode, an exception policy
(memcap-policy) can be set, telling Suricata what to do in case memcap
is hit: 'drop-flow', 'drop-packet', 'pass-flow', 'pass-packet',  'bypass',
'reject', or 'ignore'.</p>
<p>Reassembling a stream is an expensive operation. With the option depth
you can control how far into a stream reassembly is done. By default
this is 1MB. This setting can be overridden per stream by the protocol
parsers that do file extraction.</p>
<p>Inspection of reassembled data is done in chunks. The size of these
chunks is set with <code class="docutils literal notranslate"><span class="pre">toserver_chunk_size</span></code> and <code class="docutils literal notranslate"><span class="pre">toclient_chunk_size</span></code>.
To avoid making the borders predictable, the sizes can be varied by
adding in a random factor.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reassembly</span><span class="p">:</span>
  <span class="n">memcap</span><span class="p">:</span> <span class="mi">256</span><span class="n">mb</span>             <span class="c1"># Memory reserved for stream data reconstruction (in bytes)</span>
  <span class="n">memcap</span><span class="o">-</span><span class="n">policy</span><span class="p">:</span> <span class="n">ignore</span>     <span class="c1"># What to do when memcap for reassembly is hit</span>
  <span class="n">depth</span><span class="p">:</span> <span class="mi">1</span><span class="n">mb</span>                <span class="c1"># The depth of the reassembling.</span>
  <span class="n">toserver_chunk_size</span><span class="p">:</span> <span class="mi">2560</span> <span class="c1"># inspect raw stream in chunks of at least this size</span>
  <span class="n">toclient_chunk_size</span><span class="p">:</span> <span class="mi">2560</span> <span class="c1"># inspect raw stream in chunks of at least</span>
  <span class="n">randomize</span><span class="o">-</span><span class="n">chunk</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1">#randomize-chunk-range: 10</span>
</pre></div>
</div>
<p>'Raw' reassembly is done for inspection by simple <code class="docutils literal notranslate"><span class="pre">content</span></code>, <code class="docutils literal notranslate"><span class="pre">pcre</span></code>
keywords use and other payload inspection not done on specific protocol
buffers like <code class="docutils literal notranslate"><span class="pre">http_uri</span></code>. This type of reassembly can be turned off:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reassembly</span><span class="p">:</span>
  <span class="n">raw</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<p>Incoming segments are stored in a list in the stream. To avoid constant
memory allocations a per-thread pool is used.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reassembly</span><span class="p">:</span>
  <span class="n">segment</span><span class="o">-</span><span class="n">prealloc</span><span class="p">:</span> <span class="mi">2048</span>    <span class="c1"># pre-alloc 2k segments per thread</span>
</pre></div>
</div>
<p>Resending different data on the same sequence number is a way to confuse
network inspection.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reassembly</span><span class="p">:</span>
  <span class="n">check</span><span class="o">-</span><span class="n">overlap</span><span class="o">-</span><span class="n">different</span><span class="o">-</span><span class="n">data</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p><em>Example 15        Stream reassembly</em></p>
<img alt="_images/reassembly1.png" src="_images/reassembly1.png" />
<img alt="_images/IDS_chunk_size.png" src="_images/IDS_chunk_size.png" />
</div>
</div>
<div class="section" id="application-layer-parsers">
<h4>Application Layer Parsers<a class="headerlink" href="#application-layer-parsers" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">app-layer</span></code> section holds application layer specific configurations.</p>
<p>In IPS mode, a global exception policy accessed via the <code class="docutils literal notranslate"><span class="pre">error-policy</span></code>
setting can be defined to indicate what the engine should do in case it
encounters an app-layer error. Possible values are &quot;drop-flow&quot;, &quot;pass-flow&quot;,
&quot;bypass&quot;, &quot;drop-packet&quot;, &quot;pass-packet&quot;, &quot;reject&quot; or &quot;ignore&quot; (which maintains
the default behavior).</p>
<p>Each supported protocol has a dedicated subsection under <code class="docutils literal notranslate"><span class="pre">protocols</span></code>.</p>
<div class="section" id="asn1-max-frames-new-in-1-0-3-and-1-1">
<h5>Asn1_max_frames (new in 1.0.3 and 1.1)<a class="headerlink" href="#asn1-max-frames-new-in-1-0-3-and-1-1" title="Permalink to this headline">¶</a></h5>
<p>Asn1 (<a class="reference external" href="http://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One">Abstract Syntax One</a>) is a
standard notation to structure and describe data.</p>
<p>Within Asn1_max_frames there are several frames. To protect itself,
Suricata will inspect a maximum of 256. You can set this amount
differently if wanted.</p>
<p>Application layer protocols such as X.400 electronic mail, X.500 and
LDAP directory services, H.323 (VoIP), BACnet and SNMP, use ASN.1 to
describe the protocol data units (PDUs) they exchange. It is also
extensively used in the Access and Non-Access Strata of UMTS.</p>
<p>Limit for the maximum number of asn1 frames to decode (default 256):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">asn1_max_frames</span><span class="p">:</span> <span class="mi">256</span>
</pre></div>
</div>
</div>
<div class="section" id="ftp">
<span id="suricata-yaml-configure-ftp"></span><h5>FTP<a class="headerlink" href="#ftp" title="Permalink to this headline">¶</a></h5>
<p>The FTP application layer parser is enabled by default and uses dynamic protocol
detection.</p>
<p>By default, FTP control channel commands and responses are limited to 4096
bytes, but this value can be changed. When a command request or response exceeds
the line length limit, the stored data will be truncated, however the parser
will continue to watch for the end of line and acquire the next command.
Commands that are truncated will be noted in the <em>eve</em> log file with the fields
<code class="docutils literal notranslate"><span class="pre">command_truncated</span></code> or <code class="docutils literal notranslate"><span class="pre">reply_truncated</span></code>. Please note that this affects the
control messages only, not FTP data (file transfers).</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ftp</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1">#memcap: 64mb</span>

  <span class="c1"># Maximum line length for control messages before they will be truncated.</span>
  <span class="c1">#max-line-length: 4kb</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="configure-http-libhtp">
<span id="suricata-yaml-configure-libhtp"></span><h5>Configure HTTP (libhtp)<a class="headerlink" href="#configure-http-libhtp" title="Permalink to this headline">¶</a></h5>
<p>The library Libhtp is being used by Suricata to parse HTTP-sessions.</p>
<p>While processing HTTP-traffic, Suricata has to deal with different
kind of servers which each process anomalies in HTTP-traffic
differently. The most common web-server is Apache. This is an open
source web-server program.</p>
<p>Besides Apache, IIS (Internet Information Services/Server) a web-server
program of Microsoft is also well-known.</p>
<p>Like with host-os-policy, it is important for Suricata to know which
IP-address/network-address is used by which server. In Libhtp this
assigning of web-servers to IP-and network addresses is called
personality.</p>
<p>Currently Available Personalities:</p>
<ul class="simple">
<li>Minimal</li>
<li>Generic</li>
<li>IDS (default)</li>
<li>IIS_4_0</li>
<li>IIS_5_0</li>
<li>IIS_5_1</li>
<li>IIS_6_0</li>
<li>IIS_7_0</li>
<li>IIS_7_5</li>
<li>Apache</li>
<li>Apache_2_2</li>
</ul>
<p>You can assign names to each block of settings. Which in this case
is -apache and -iis7. Under these names you can set IP-addresses,
network-addresses the personality and a set of features.</p>
<p>The version-specific personalities know exactly how web servers
behave, and emulate that. The IDS personality would try to implement
a best-effort approach that would work reasonably well in the cases
where you do not know the specifics.</p>
<p>The default configuration also applies to every IP-address for which
no specific setting is available.</p>
<p>HTTP request bodies are often big, so they take a lot of time to
process which has a significant impact on the performance. With the
option 'request-body-limit' you can set the limit (in bytes) of the
client-body that will be inspected. Setting it to 0 will inspect all
of the body.</p>
<p>The same goes for HTTP response bodies.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libhtp</span><span class="p">:</span>

  <span class="n">default</span><span class="o">-</span><span class="n">config</span><span class="p">:</span>
    <span class="n">personality</span><span class="p">:</span> <span class="n">IDS</span>
    <span class="n">request</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">3072</span>
    <span class="n">response</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">3072</span>

  <span class="n">server</span><span class="o">-</span><span class="n">config</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">apache</span><span class="p">:</span>
         <span class="n">address</span><span class="p">:</span> <span class="p">[</span><span class="mf">192.168.1.0</span><span class="o">/</span><span class="mi">24</span><span class="p">,</span> <span class="mf">127.0.0.0</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;::1&quot;</span><span class="p">]</span>
         <span class="n">personality</span><span class="p">:</span> <span class="n">Apache_2_2</span>
         <span class="n">request</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">0</span>
         <span class="n">response</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">0</span>

     <span class="o">-</span> <span class="n">iis7</span><span class="p">:</span>
         <span class="n">address</span><span class="p">:</span>
           <span class="o">-</span> <span class="mf">192.168.0.0</span><span class="o">/</span><span class="mi">24</span>
           <span class="o">-</span> <span class="mf">192.168.10.0</span><span class="o">/</span><span class="mi">24</span>
         <span class="n">personality</span><span class="p">:</span> <span class="n">IIS_7_0</span>
         <span class="n">request</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">4096</span>
         <span class="n">response</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">8192</span>
</pre></div>
</div>
<p>Suricata makes available the whole set of libhtp customisations for its users.</p>
<p>You can now use these parameters in the conf to customise suricata's
use of libhtp.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configures whether backslash characters are treated as path segment</span>
<span class="c1"># separators. They are not on Unix systems, but are on Windows systems.</span>
<span class="c1"># If this setting is enabled, a path such as &quot;/one\two/three&quot; will be</span>
<span class="c1"># converted to &quot;/one/two/three&quot;.  Accepted values - yes, no.</span>
<span class="c1">#path-convert-backslash-separators: yes</span>

<span class="c1"># Configures whether input data will be converted to lowercase.</span>
<span class="c1">#path-convert-lowercase: yes</span>

<span class="c1"># Configures how the server reacts to encoded NUL bytes.</span>
<span class="c1">#path-nul-encoded-terminates: no</span>

<span class="c1"># Configures how the server reacts to raw NUL bytes.</span>
<span class="c1">#path-nul-raw-terminates: no</span>

<span class="c1"># Configures whether consecutive path segment separators will be</span>
<span class="c1"># compressed. When enabled, a path such as &quot;/one//two&quot; will be normalized</span>
<span class="c1"># to &quot;/one/two&quot;. The backslash_separators and decode_separators</span>
<span class="c1"># parameters are used before compression takes place. For example, if</span>
<span class="c1"># backslash_separators and decode_separators are both enabled, the path</span>
<span class="c1"># &quot;/one\\/two\/%5cthree/%2f//four&quot; will be converted to</span>
<span class="c1"># &quot;/one/two/three/four&quot;.  Accepted values - yes, no.</span>
<span class="c1">#path-separators-compress: yes</span>

<span class="c1"># Configures whether encoded path segment separators will be decoded.</span>
<span class="c1"># Apache does not do this, but IIS does. If enabled, a path such as</span>
<span class="c1"># &quot;/one%2ftwo&quot; will be normalized to &quot;/one/two&quot;. If the</span>
<span class="c1"># backslash_separators option is also enabled, encoded backslash</span>
<span class="c1"># characters will be converted too (and subsequently normalized to</span>
<span class="c1"># forward slashes).  Accepted values - yes, no.</span>
<span class="c1">#path-separators-decode: yes</span>

<span class="c1"># Configures whether %u-encoded sequences in path will be decoded. Such</span>
<span class="c1"># sequences will be treated as invalid URL encoding if decoding is not</span>
<span class="c1"># desireable.  Accepted values - yes, no.</span>
<span class="c1">#path-u-encoding-decode: yes</span>

<span class="c1"># Configures how server reacts to invalid encoding in path.  Accepted</span>
<span class="c1"># values - preserve_percent, remove_percent, decode_invalid, status_400</span>
<span class="c1">#path-url-encoding-invalid-handling: preserve_percent</span>

<span class="c1"># Controls whether the data should be treated as UTF-8 and converted</span>
<span class="c1"># to a single-byte stream using best-fit mapping</span>
<span class="c1">#path-utf8-convert-bestfit:yes</span>

<span class="c1"># Sets the replacement character that will be used to in the lossy</span>
<span class="c1"># best-fit mapping from Unicode characters into single-byte streams.</span>
<span class="c1"># The question mark is the default replacement character.</span>
<span class="c1">#path-bestfit-replacement-char: ?</span>

<span class="c1"># Configures whether plus characters are converted to spaces</span>
<span class="c1"># when decoding URL-encoded strings.</span>
<span class="c1">#query-plusspace-decode: yes</span>

<span class="c1">#   response-body-decompress-layer-limit:</span>
<span class="c1">#                           Limit to how many layers of compression will be</span>
<span class="c1">#                           decompressed. Defaults to 2.</span>

<span class="c1">#   uri-include-all:        Include all parts of the URI. By default the</span>
<span class="c1">#                           &#39;scheme&#39;, username/password, hostname and port</span>
<span class="c1">#                           are excluded.</span>

<span class="c1">#   meta-field-limit:       Hard size limit for request and response size</span>
<span class="c1">#                           limits.</span>

<span class="c1"># inspection limits</span>
    <span class="n">request</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">minimal</span><span class="o">-</span><span class="n">inspect</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">32</span><span class="n">kb</span>
    <span class="n">request</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">inspect</span><span class="o">-</span><span class="n">window</span><span class="p">:</span> <span class="mi">4</span><span class="n">kb</span>
    <span class="n">response</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">minimal</span><span class="o">-</span><span class="n">inspect</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">40</span><span class="n">kb</span>
    <span class="n">response</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">inspect</span><span class="o">-</span><span class="n">window</span><span class="p">:</span> <span class="mi">16</span><span class="n">kb</span>

<span class="c1"># auto will use http-body-inline mode in IPS mode, yes or no set it statically</span>
    <span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">inline</span><span class="p">:</span> <span class="n">auto</span>

<span class="c1"># Decompress SWF files.</span>
<span class="c1"># 2 types: &#39;deflate&#39;, &#39;lzma&#39;, &#39;both&#39; will decompress deflate and lzma</span>
<span class="c1"># compress-depth:</span>
<span class="c1"># Specifies the maximum amount of data to decompress,</span>
<span class="c1"># set 0 for unlimited.</span>
<span class="c1"># decompress-depth:</span>
<span class="c1"># Specifies the maximum amount of decompressed data to obtain,</span>
<span class="c1"># set 0 for unlimited.</span>
    <span class="n">swf</span><span class="o">-</span><span class="n">decompression</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">both</span>
      <span class="n">compress</span><span class="o">-</span><span class="n">depth</span><span class="p">:</span> <span class="mi">0</span>
      <span class="n">decompress</span><span class="o">-</span><span class="n">depth</span><span class="p">:</span> <span class="mi">0</span>

<span class="c1"># Take a random value for inspection sizes around the specified value.</span>
<span class="c1"># This lower the risk of some evasion technics but could lead</span>
<span class="c1"># detection change between runs. It is set to &#39;yes&#39; by default.</span>
<span class="c1">#randomize-inspection-sizes: yes</span>
<span class="c1"># If randomize-inspection-sizes is active, the value of various</span>
<span class="c1"># inspection size will be chosen in the [1 - range%, 1 + range%]</span>
<span class="c1"># range</span>
<span class="c1"># Default value of randomize-inspection-range is 10.</span>
<span class="c1">#randomize-inspection-range: 10</span>

<span class="c1"># Can enable LZMA decompression</span>
<span class="c1">#lzma-enabled: false</span>
<span class="c1"># Memory limit usage for LZMA decompression dictionary</span>
<span class="c1"># Data is decompressed until dictionary reaches this size</span>
<span class="c1">#lzma-memlimit: 1 Mb</span>
<span class="c1"># Maximum decompressed size with a compression ratio</span>
<span class="c1"># above 2048 (only reachable by LZMA)</span>
<span class="c1">#compression-bomb-limit: 1 Mb</span>
<span class="c1"># Maximum time spent decompressing a single transaction in usec</span>
<span class="c1">#decompression-time-limit: 100000</span>
</pre></div>
</div>
<p>Other parameters are customizable from Suricata.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#   double-decode-path:     Double decode path section of the URI</span>
<span class="c1">#   double-decode-query:    Double decode query section of the URI</span>
</pre></div>
</div>
<div class="section" id="decompression-time-limit">
<h6>decompression-time-limit<a class="headerlink" href="#decompression-time-limit" title="Permalink to this headline">¶</a></h6>
<p>decompression-time-limit was implemented to avoid DOS by resource exhaustion
on inputs such as decompression bombs (found by fuzzing).
The lower the limit, the better the protection against DOS is, but this
may also lead to false positives.
In case the time limit is reached,
the app-layer event <code class="docutils literal notranslate"><span class="pre">http.compression_bomb</span></code> is set
(this event can also set from other conditions).
This can happen on slow configurations (hardware, ASAN, etc...)</p>
</div>
</div>
<div class="section" id="configure-smb">
<h5>Configure SMB<a class="headerlink" href="#configure-smb" title="Permalink to this headline">¶</a></h5>
<p>The SMB parser will parse version 1, 2 and 3 of the SMB protocol over TCP.</p>
<p>To enable the parser add the following to the <code class="docutils literal notranslate"><span class="pre">app-layer</span></code> section of the YAML.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smb</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">detection</span><span class="o">-</span><span class="n">ports</span><span class="p">:</span>
    <span class="n">dp</span><span class="p">:</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">445</span>
</pre></div>
</div>
<p>The parser uses pattern based protocol detection and will fallback to <code class="docutils literal notranslate"><span class="pre">probing</span> <span class="pre">parsers</span></code>
if the pattern based detection fails. As usual, the pattern based detection is port
independent. The <code class="docutils literal notranslate"><span class="pre">probing</span> <span class="pre">parsers</span></code> will only run on the <code class="docutils literal notranslate"><span class="pre">detection-ports</span></code>.</p>
<p>SMB is commonly used to transfer the DCERPC protocol. This traffic is also handled by
this parser.</p>
<div class="section" id="resource-limits">
<h6>Resource limits<a class="headerlink" href="#resource-limits" title="Permalink to this headline">¶</a></h6>
<p>Several options are available for limiting record sizes and data chunk tracking.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smb</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">8</span><span class="n">mb</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">write</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">1</span><span class="n">mb</span>

  <span class="nb">max</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">16</span><span class="n">mb</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">cnt</span><span class="p">:</span> <span class="mi">16</span>

  <span class="nb">max</span><span class="o">-</span><span class="n">write</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">16</span><span class="n">mb</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">write</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">cnt</span><span class="p">:</span> <span class="mi">16</span>
</pre></div>
</div>
<p>The <cite>max-read-size</cite> option can be set to control the max size of accepted
READ records. Events will be raised if a READ request asks for too much data
and/or if READ responses are too big. A value of 0 disables the checks.</p>
<p>The <cite>max-write-size</cite> option can be set to control the max size of accepted
WRITE request records. Events will be raised if a WRITE request sends too much
data. A value of 0 disables the checks.</p>
<p>Additionally if the <cite>max-read-size</cite> or <cite>max-write-size</cite> values in the
&quot;negotiate protocol response&quot; exceeds this limit an event will also be raised.</p>
<p>For file tracking, extraction and file data inspection the parser queues up
out of order data chunks for both READs and WRITEs. To avoid using too much
memory the parser allows for limiting both the size in bytes and the number
of queued chunks.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smb</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>

  <span class="nb">max</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">16</span><span class="n">mb</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">cnt</span><span class="p">:</span> <span class="mi">16</span>

  <span class="nb">max</span><span class="o">-</span><span class="n">write</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">16</span><span class="n">mb</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">write</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">cnt</span><span class="p">:</span> <span class="mi">16</span>
</pre></div>
</div>
<p><cite>max-read-queue-size</cite> controls how many bytes can be used per SMB flow for
out of order READs. <cite>max-read-queue-cnt</cite> controls how many READ chunks can be
queued per SMB flow. Processing of these chunks will be blocked when any of
the limits are exceeded, and an event will be raised.</p>
<p><cite>max-write-queue-size</cite> and <cite>max-write-queue-cnt</cite> are as the READ variants,
but then for WRITEs.</p>
</div>
</div>
<div class="section" id="configure-http2">
<h5>Configure HTTP2<a class="headerlink" href="#configure-http2" title="Permalink to this headline">¶</a></h5>
<p>HTTP2 has 2 parameters that can be customized.
The point of these 2 parameters is to find a balance between the completeness
of analysis and the resource consumption.</p>
<p><cite>http2.max-table-size</cite> refers to <cite>SETTINGS_HEADER_TABLE_SIZE</cite> from rfc 7540 section 6.5.2.
Its default value is 4096 bytes, but it can be set to any uint32 by a flow.</p>
<p><cite>http2.max-streams</cite> refers to <cite>SETTINGS_MAX_CONCURRENT_STREAMS</cite> from rfc 7540 section 6.5.2.
Its default value is unlimited.</p>
</div>
<div class="section" id="ssl-tls">
<h5>SSL/TLS<a class="headerlink" href="#ssl-tls" title="Permalink to this headline">¶</a></h5>
<p>SSL/TLS parsers track encrypted SSLv2, SSLv3, TLSv1, TLSv1.1 and TLSv1.2
sessions.</p>
<p>Protocol detection is done using patterns and a probing parser running
on only TCP/443 by default. The pattern based protocol detection is
port independent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tls</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">detection</span><span class="o">-</span><span class="n">ports</span><span class="p">:</span>
    <span class="n">dp</span><span class="p">:</span> <span class="mi">443</span>

  <span class="c1"># What to do when the encrypted communications start:</span>
  <span class="c1"># - default: keep tracking TLS session, check for protocol anomalies,</span>
  <span class="c1">#            inspect tls_* keywords. Disables inspection of unmodified</span>
  <span class="c1">#            &#39;content&#39; signatures.</span>
  <span class="c1"># - bypass:  stop processing this flow as much as possible. No further</span>
  <span class="c1">#            TLS parsing and inspection. Offload flow bypass to kernel</span>
  <span class="c1">#            or hardware if possible.</span>
  <span class="c1"># - full:    keep tracking and inspection as normal. Unmodified content</span>
  <span class="c1">#            keyword signatures are inspected as well.</span>
  <span class="c1">#</span>
  <span class="c1"># For best performance, select &#39;bypass&#39;.</span>
  <span class="c1">#</span>
  <span class="c1">#encryption-handling: default</span>
</pre></div>
</div>
<div class="section" id="encrypted-traffic">
<h6>Encrypted traffic<a class="headerlink" href="#encrypted-traffic" title="Permalink to this headline">¶</a></h6>
<p>There is no decryption of encrypted traffic, so once the handshake is complete
continued tracking of the session is of limited use. The <code class="docutils literal notranslate"><span class="pre">encryption-handling</span></code>
option controls the behavior after the handshake.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">encryption-handling</span></code> is set to <code class="docutils literal notranslate"><span class="pre">default</span></code> (or if the option is not set),
Suricata will continue to track the SSL/TLS session. Inspection will be limited,
as raw <code class="docutils literal notranslate"><span class="pre">content</span></code> inspection will still be disabled. There is no point in doing
pattern matching on traffic known to be encrypted. Inspection for (encrypted)
Heartbleed and other protocol anomalies still happens.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">encryption-handling</span></code> is set to <code class="docutils literal notranslate"><span class="pre">bypass</span></code>, all processing of this session is
stopped. No further parsing and inspection happens. If <code class="docutils literal notranslate"><span class="pre">stream.bypass</span></code> is enabled
this will lead to the flow being bypassed, either inside Suricata or by the
capture method if it supports it and is configured for it.</p>
<p>Finally, if <code class="docutils literal notranslate"><span class="pre">encryption-handling</span></code> is set to <code class="docutils literal notranslate"><span class="pre">full</span></code>, Suricata will process the
flow as normal, without inspection limitations or bypass.</p>
<p>The option has replaced the <code class="docutils literal notranslate"><span class="pre">no-reassemble</span></code> option. If <code class="docutils literal notranslate"><span class="pre">no-reassemble</span></code> is
present, and <code class="docutils literal notranslate"><span class="pre">encryption-handling</span></code> is not, <code class="docutils literal notranslate"><span class="pre">false</span></code> is interpreted as
<code class="docutils literal notranslate"><span class="pre">encryption-handling:</span> <span class="pre">default</span></code> and <code class="docutils literal notranslate"><span class="pre">true</span></code> is interpreted as
<code class="docutils literal notranslate"><span class="pre">encryption-handling:</span> <span class="pre">bypass</span></code>.</p>
</div>
</div>
<div class="section" id="modbus">
<h5>Modbus<a class="headerlink" href="#modbus" title="Permalink to this headline">¶</a></h5>
<p>According to MODBUS Messaging on TCP/IP Implementation Guide V1.0b, it
is recommended to keep the TCP connection opened with a remote device
and not to open and close it for each MODBUS/TCP transaction.
In that case, it is important to set the stream-depth of the modbus as
unlimited.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modbus</span><span class="p">:</span>
  <span class="c1"># Stream reassembly size for modbus, default is 0</span>
  <span class="n">stream</span><span class="o">-</span><span class="n">depth</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt">
<h5>MQTT<a class="headerlink" href="#mqtt" title="Permalink to this headline">¶</a></h5>
<p>The maximum size of a MQTT message is 256MB, potentially containing a lot of
payload data (such as properties, topics, or published payloads) that would end
up parsed and logged. To acknowledge the fact that most MQTT messages, however,
will be quite small and to reduce the potential for denial of service issues,
it is possible to limit the maximum length of a message that Suricata should
parse. Any message larger than the limit will just be logged with reduced
metadata, and rules will only be evaluated against a subset of fields. The
default is 1 MB.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="p">:</span>
  <span class="nb">max</span><span class="o">-</span><span class="n">msg</span><span class="o">-</span><span class="n">length</span><span class="p">:</span> <span class="mi">1</span><span class="n">mb</span>
</pre></div>
</div>
</div>
<div class="section" id="smtp">
<h5>SMTP<a class="headerlink" href="#smtp" title="Permalink to this headline">¶</a></h5>
<p>SMTP parsers can extract files from attachments.
It is also possible to extract raw conversations as files with the
key <code class="docutils literal notranslate"><span class="pre">raw-extraction</span></code>. Note that in this case the whole conversation
will be stored as a file, including SMTP headers and body content. The filename
will be set to &quot;rawmsg&quot;. Usual file-related signatures will match on the raw
content of the email.
This configuration parameter has a <code class="docutils literal notranslate"><span class="pre">false</span></code> default value. It is
incompatible with <code class="docutils literal notranslate"><span class="pre">decode-mime</span></code>. If both are enabled,
<code class="docutils literal notranslate"><span class="pre">raw-extraction</span></code> will be automatically disabled.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">smtp</span><span class="p">:</span>
  <span class="c1"># extract messages in raw format from SMTP</span>
  <span class="n">raw</span><span class="o">-</span><span class="n">extraction</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="maximum-transactions">
<h5>Maximum transactions<a class="headerlink" href="#maximum-transactions" title="Permalink to this headline">¶</a></h5>
<p>MQTT, FTP, PostgreSQL, SMB, DCERPC and NFS have each a <cite>max-tx</cite> parameter that can be customized.
<cite>max-tx</cite> refers to the maximum number of live transactions for each flow.
An app-layer event <cite>protocol.too_many_transactions</cite> is triggered when this value is reached.
The point of this parameter is to find a balance between the completeness of analysis
and the resource consumption.</p>
<p>For HTTP2, this parameter is named <cite>max-streams</cite> as an HTTP2 stream will get translated
into one Suricata transaction. This configuration parameter is used whatever the
value of <cite>SETTINGS_MAX_CONCURRENT_STREAMS</cite> negotiated between a client and a server
in a specific flow is.</p>
</div>
</div>
<div class="section" id="engine-logging">
<h4>Engine Logging<a class="headerlink" href="#engine-logging" title="Permalink to this headline">¶</a></h4>
<p>The engine logging system logs information about the application such
as errors and other diagnostic information during startup, runtime and
shutdown of the Suricata engine. This does not include Suricata
generated alerts and events.</p>
<p>The engine logging system has the following log levels:</p>
<ul class="simple">
<li>error</li>
<li>warning</li>
<li>notice</li>
<li>info</li>
<li>perf</li>
<li>config</li>
<li>debug</li>
</ul>
<p>Note that debug level logging will only be emitted if Suricata was
compiled with the <code class="docutils literal notranslate"><span class="pre">--enable-debug</span></code> configure option.</p>
<p>The first option within the logging configuration is the
default-log-level. This option determines the severity/importance
level of information that will be displayed. Messages of lower levels
than the one set here, will not be shown. The default setting is
Info. This means that error, warning and info will be shown and the
other levels won't be.</p>
<div class="section" id="default-configuration-example">
<h5>Default Configuration Example<a class="headerlink" href="#default-configuration-example" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Logging configuration.  This is not about logging IDS alerts/events, but</span>
<span class="c1"># output about what Suricata is doing, like startup messages, errors, etc.</span>
<span class="n">logging</span><span class="p">:</span>
  <span class="c1"># The default log level, can be overridden in an output section.</span>
  <span class="c1"># Note that debug level logging will only be emitted if Suricata was</span>
  <span class="c1"># compiled with the --enable-debug configure option.</span>
  <span class="c1">#</span>
  <span class="c1"># This value is overridden by the SC_LOG_LEVEL env var.</span>
  <span class="n">default</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">level</span><span class="p">:</span> <span class="n">notice</span>

  <span class="c1"># The default output format.  Optional parameter, should default to</span>
  <span class="c1"># something reasonable if not provided.  Can be overridden in an</span>
  <span class="c1"># output section.  You can leave this out to get the default.</span>
  <span class="c1">#</span>
  <span class="c1"># This console log format value can be overridden by the SC_LOG_FORMAT env var.</span>
  <span class="c1">#default-log-format: &quot;%D: %S: %M&quot;</span>
  <span class="c1">#</span>
  <span class="c1"># For the pre-7.0 log format use:</span>
  <span class="c1">#default-log-format: &quot;[%i] %t [%S] - (%f:%l) &lt;%d&gt; (%n) -- &quot;</span>

  <span class="c1"># A regex to filter output.  Can be overridden in an output section.</span>
  <span class="c1"># Defaults to empty (no filter).</span>
  <span class="c1">#</span>
  <span class="c1"># This value is overridden by the SC_LOG_OP_FILTER env var.</span>
  <span class="n">default</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="nb">filter</span><span class="p">:</span>

  <span class="c1"># Define your logging outputs.  If none are defined, or they are all</span>
  <span class="c1"># disabled you will get the default - console output.</span>
  <span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">console</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="c1"># type: json</span>
  <span class="o">-</span> <span class="n">file</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">level</span><span class="p">:</span> <span class="n">info</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">suricata</span><span class="o">.</span><span class="n">log</span>
      <span class="c1"># format: &quot;[%i - %m] %z %d: %S: %M&quot;</span>
      <span class="c1"># type: json</span>
  <span class="o">-</span> <span class="n">syslog</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">facility</span><span class="p">:</span> <span class="n">local5</span>
      <span class="nb">format</span><span class="p">:</span> <span class="s2">&quot;[</span><span class="si">%i</span><span class="s2">] &lt;</span><span class="si">%d</span><span class="s2">&gt; -- &quot;</span>
      <span class="c1"># type: json</span>
</pre></div>
</div>
</div>
<div class="section" id="default-log-level">
<h5>Default Log Level<a class="headerlink" href="#default-log-level" title="Permalink to this headline">¶</a></h5>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="p">:</span>
  <span class="n">default</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">level</span><span class="p">:</span> <span class="n">info</span>
</pre></div>
</div>
<p>This option sets the default log level. The default log level is
<cite>notice</cite>. This value will be used in the individual logging
configuration (console, file, syslog) if not otherwise set.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">-v</span></code> command line option can be used to quickly
increase the log level at runtime. See <a class="reference internal" href="index.html#cmdline-option-v"><span class="std std-ref">the -v command
line option</span></a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">default-log-level</span></code> set in the configuration value can be
overridden by the <code class="docutils literal notranslate"><span class="pre">SC_LOG_LEVEL</span></code> environment variable.</p>
</div>
<div class="section" id="default-log-format">
<h5>Default Log Format<a class="headerlink" href="#default-log-format" title="Permalink to this headline">¶</a></h5>
<p>A logging line exists of two parts. First it displays meta information
(thread id, date etc.), and finally the actual log message. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[27708] 15/10/2010 -- 11:40:07 - (suricata.c:425) &lt;Info&gt; (main) – This is Suricata version 1.0.2
</pre></div>
</div>
<p>(Here the part until the – is the meta info, &quot;This is Suricata 1.0.2&quot;
is the actual message.)</p>
<p>It is possible to determine which information will be displayed in
this line and (the manner how it will be displayed) in which format it
will be displayed. This option is the so called format string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="nb">format</span><span class="p">:</span> <span class="s2">&quot;[</span><span class="si">%i</span><span class="s2">] %t - (</span><span class="si">%f</span><span class="s2">:%l) &lt;</span><span class="si">%d</span><span class="s2">&gt; (%n) -- &quot;</span>
</pre></div>
</div>
<p>The % followed by a character has a special meaning. There are thirteen
specified signs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="p">:</span>      <span class="n">ISO</span><span class="o">-</span><span class="n">like</span> <span class="n">formatted</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span> <span class="n">HH</span><span class="p">:</span><span class="n">MM</span><span class="p">:</span><span class="n">SS</span>
<span class="n">t</span><span class="p">:</span>      <span class="n">Original</span> <span class="n">Suricata</span> <span class="n">log</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">DD</span><span class="o">/</span><span class="n">MM</span><span class="o">/</span><span class="n">YYYY</span> <span class="o">--</span> <span class="n">HH</span><span class="p">:</span><span class="n">MM</span><span class="p">::</span><span class="n">SS</span>
<span class="n">p</span><span class="p">:</span>      <span class="n">Process</span> <span class="n">ID</span><span class="o">.</span> <span class="n">Suricata</span><span class="s1">&#39;s whole processing consists of multiple threads.</span>
<span class="n">i</span><span class="p">:</span>      <span class="n">Thread</span> <span class="n">ID</span><span class="o">.</span> <span class="n">ID</span> <span class="n">of</span> <span class="n">individual</span> <span class="n">threads</span><span class="o">.</span>
<span class="n">m</span><span class="p">:</span>      <span class="n">Thread</span> <span class="n">module</span> <span class="n">name</span><span class="o">.</span> <span class="p">(</span><span class="n">Outputs</span><span class="p">,</span> <span class="n">Detect</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
<span class="n">d</span><span class="p">:</span>      <span class="n">Log</span><span class="o">-</span><span class="n">level</span> <span class="n">of</span> <span class="n">specific</span> <span class="n">log</span><span class="o">-</span><span class="n">event</span><span class="o">.</span> <span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">debug</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
<span class="n">D</span><span class="p">:</span>      <span class="n">Compact</span> <span class="n">log</span> <span class="nb">format</span> <span class="p">(</span><span class="n">E</span> <span class="k">for</span> <span class="n">Error</span><span class="p">,</span> <span class="n">i</span> <span class="k">for</span> <span class="n">info</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
<span class="n">S</span><span class="p">:</span>      <span class="n">Subsystem</span> <span class="n">name</span><span class="o">.</span>
<span class="n">T</span><span class="p">:</span>      <span class="n">Thread</span> <span class="n">name</span><span class="o">.</span>
<span class="n">M</span><span class="p">:</span>      <span class="n">Log</span> <span class="n">message</span> <span class="n">body</span><span class="o">.</span>
<span class="n">f</span><span class="p">:</span>      <span class="n">Filename</span><span class="o">.</span> <span class="n">Name</span> <span class="n">of</span> <span class="n">C</span><span class="o">-</span><span class="n">file</span> <span class="p">(</span><span class="n">source</span> <span class="n">code</span><span class="p">)</span> <span class="n">where</span> <span class="n">log</span><span class="o">-</span><span class="n">event</span> <span class="ow">is</span> <span class="n">generated</span><span class="o">.</span>
<span class="n">l</span><span class="p">:</span>      <span class="n">Line</span><span class="o">-</span><span class="n">number</span> <span class="n">within</span> <span class="n">the</span> <span class="n">filename</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">log</span><span class="o">-</span><span class="n">event</span> <span class="ow">is</span> <span class="n">generated</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">source</span><span class="o">-</span><span class="n">code</span><span class="o">.</span>
<span class="n">n</span><span class="p">:</span>      <span class="n">Function</span><span class="o">-</span><span class="n">name</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">C</span><span class="o">-</span><span class="n">code</span> <span class="p">(</span><span class="n">source</span> <span class="n">code</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>The last three options, f, l and n, are mainly convenient for developers.</p>
<p>The log-format can be overridden in the command line by the
environment variable: SC_LOG_FORMAT</p>
</div>
<div class="section" id="output-filter">
<h5>Output Filter<a class="headerlink" href="#output-filter" title="Permalink to this headline">¶</a></h5>
<p>Within logging you can set an output-filter. With this output-filter
you can set which part of the event-logs should be displayed. You can
supply a regular expression (Regex). A line will be shown if the regex
matches.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="nb">filter</span><span class="p">:</span>               <span class="c1">#In this option the regular expression can be entered.</span>
</pre></div>
</div>
<p>This value is overridden by the environment var: SC_LOG_OP_FILTER</p>
</div>
<div class="section" id="logging-outputs">
<h5>Logging Outputs<a class="headerlink" href="#logging-outputs" title="Permalink to this headline">¶</a></h5>
<p>There are different ways of displaying output. The output can appear
directly on your screen, it can be placed in a file or via syslog. The
last mentioned is an advanced tool for log-management. The tool can be
used to direct log-output to different locations (files, other
computers etc.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">console</span><span class="p">:</span>                                    <span class="c1">#Output on your screen.</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>                              <span class="c1">#This option is enabled.</span>
      <span class="c1">#level: notice                            #Use a different level than the default.</span>
  <span class="o">-</span> <span class="n">file</span><span class="p">:</span>                                       <span class="c1">#Output stored in a file.</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>                               <span class="c1">#This option is not enabled.</span>
      <span class="n">filename</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">log</span>           <span class="c1">#Filename and location on disc.</span>
      <span class="n">level</span><span class="p">:</span> <span class="n">info</span>                               <span class="c1">#Use a different level than the default.</span>
  <span class="o">-</span> <span class="n">syslog</span><span class="p">:</span>                                     <span class="c1">#This is a program to direct log-output to several directions.</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>                               <span class="c1">#The use of this program is not enabled.</span>
      <span class="n">facility</span><span class="p">:</span> <span class="n">local5</span>                          <span class="c1">#In this option you can set a syslog facility.</span>
      <span class="nb">format</span><span class="p">:</span> <span class="s2">&quot;[</span><span class="si">%i</span><span class="s2">] &lt;</span><span class="si">%d</span><span class="s2">&gt; -- &quot;</span>                   <span class="c1">#The option to set your own format.</span>
      <span class="c1">#level: notice                            #Use a different level than the default.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="packet-acquisition">
<h4>Packet Acquisition<a class="headerlink" href="#packet-acquisition" title="Permalink to this headline">¶</a></h4>
<div class="section" id="data-plane-development-kit-dpdk">
<span id="dpdk-capture-module"></span><h5>Data Plane Development Kit (DPDK)<a class="headerlink" href="#data-plane-development-kit-dpdk" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://www.dpdk.org/">Data Plane Development Kit</a> is a framework for fast
packet processing in data plane applications running on a wide variety of CPU
architectures. DPDK's <a class="reference external" href="https://doc.dpdk.org/guides/prog_guide/env_abstraction_layer.html">Environment Abstraction Layer (EAL)</a>
provides a generic interface to low-level resources. It is a unique way how
DPDK libraries access NICs. EAL creates an API for an application to access NIC
resources from the userspace level. In DPDK, packets are not retrieved via
interrupt handling. Instead, the application <a class="reference external" href="https://doc.dpdk.org/guides/prog_guide/poll_mode_drv.html">polls</a> the NIC for newly
received packets.</p>
<p>DPDK allows the user space application to directly access memory where the NIC
stores the packets. As a result, neither DPDK nor the application copies the
packets for the inspection. The application directly processes packets via
passed packet descriptors.</p>
<div class="align-center figure" id="id3">
<img alt="DPDK basic architecture" src="_images/dpdk.png" />
<p class="caption"><span class="caption-text"><cite>High-level overview of DPDK application</cite></span></p>
</div>
<p>To use DPDK capture module, Suricata must be compiled with DPDK option enabled.
Support for DPDK can be enabled in configure step of the build process such as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./configure<span class="w"> </span>--enable-dpdk
</pre></div>
</div>
<p>Suricata makes use of DPDK for packet acquisition in workers runmode.
The whole DPDK configuration resides in the <cite>dpdk:</cite> node. This node encapsulates
2 main subnodes, and those are eal-params and interfaces.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dpdk</span><span class="p">:</span>
  <span class="n">eal</span><span class="o">-</span><span class="n">params</span><span class="p">:</span>
    <span class="n">proc</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">primary</span>
    <span class="n">allow</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0000:3b:00.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0000:3b:00.1&quot;</span><span class="p">]</span>
  <span class="n">interfaces</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">3</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span>
      <span class="n">threads</span><span class="p">:</span> <span class="n">auto</span>
      <span class="n">promisc</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">multicast</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">checksum</span><span class="o">-</span><span class="n">checks</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">checksum</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">offload</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">mtu</span><span class="p">:</span> <span class="mi">1500</span>
      <span class="n">mempool</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">65535</span>
      <span class="n">mempool</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">257</span>
      <span class="n">rx</span><span class="o">-</span><span class="n">descriptors</span><span class="p">:</span> <span class="mi">1024</span>
      <span class="n">tx</span><span class="o">-</span><span class="n">descriptors</span><span class="p">:</span> <span class="mi">1024</span>
      <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">none</span>
      <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">none</span> <span class="c1"># or PCIe address of the second interface</span>
</pre></div>
</div>
<p>The <a class="reference external" href="https://doc.dpdk.org/guides/linux_gsg/linux_eal_parameters.html">DPDK arguments</a>, which
are typically provided through the command line, are contained in the node
<cite>dpdk.eal-params</cite>. EAL is configured and initialized using these
parameters. There are two ways to specify arguments: lengthy and short.
Dashes are omitted when describing the arguments. This setup node can be
used to set up the memory configuration, accessible NICs, and other EAL-related
parameters, among other things. The node <cite>dpdk.eal-params</cite> also supports
multiple arguments of the same type. This can be useful for EAL arguments
such as <cite>--vdev</cite>, <cite>--allow</cite>, or <cite>--block</cite>. Values for these EAL arguments
are specified as a comma-separated list.
An example of such usage can be found in the example above where the <cite>allow</cite>
argument only makes <cite>0000:3b:00.0</cite> and <cite>0000:3b:00.1</cite> accessible to Suricata.
arguments with list node. such as --vdev, --allow, --block eal options.
The definition of lcore affinity as an EAL
parameter is a standard practice. However, lcore parameters like <cite>-l</cite>, <cite>-c</cite>,
and <cite>--lcores`</cite> are specified within the <a class="reference internal" href="#suricata-yaml-threading">suricata-yaml-threading</a> section
to prevent configuration overlap.</p>
<p>The node <cite>dpdk.interfaces</cite> wraps a list of interface configurations. Items on
the list follow the structure that can be found in other capture interfaces.
The individual items contain the usual configuration options
such as <cite>threads</cite>/<cite>copy-mode</cite>/<cite>checksum-checks</cite> settings. Other capture
interfaces, such as AF_PACKET, rely on the user to ensure that NICs are
appropriately configured.
Configuration through the kernel does not apply to applications running under
DPDK. The application is solely responsible for the initialization of the NICs
it is using. So, before the start of Suricata, the NICs that Suricata uses,
must undergo the process of initialization.
As a result, there are extra configuration options (how NICs can be
configured) in the items (interfaces) of the <cite>dpdk.interfaces</cite> list.
At the start of the configuration process, all NIC offloads are disabled to
prevent any packet modification. According to the configuration, checksum
validation offload can be enabled to drop invalid packets. Other offloads can
not currently be enabled.
Additionally, the list items in <cite>dpdk.interfaces</cite> contain DPDK specific
settings such as <cite>mempool-size</cite> or <cite>rx-descriptors</cite>. These settings adjust
individual parameters of EAL. One of the entries in <cite>dpdk.interfaces</cite> is
the <cite>default</cite> interface. When loading interface configuration and some entry is
missing, the corresponding value of the <cite>default</cite> interface is used.</p>
<p>The worker threads must be assigned to specific cores. The configuration
module <cite>threading</cite> must be used to set thread affinity.
Worker threads can be pinned to cores in the array configured in
<cite>threading.cpu-affinity[&quot;worker-cpu-set&quot;]</cite>. Performance-oriented setups have
everything (the NIC, memory, and CPU cores interacting with the NIC) based on
one NUMA node.
It is therefore required to know the layout of the server architecture to get the
best results. The CPU core ids and NUMA locations can be determined for example
from the output of <cite>/proc/cpuinfo</cite> where <cite>physical id</cite> described the NUMA
number. The NUMA node to which the NIC is connected to can be determined from
the file <cite>/sys/class/net/&lt;KERNEL NAME OF THE NIC&gt;/device/numa_node</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## Check ids and NUMA location of individual CPU cores</span>
<span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">cpuinfo</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;physical id\|processor&#39;</span>

<span class="c1">## Check NUMA node of the NIC</span>
<span class="c1">## cat /sys/class/net/&lt;KERNEL NAME OF THE NIC&gt;/device/numa_node e.g.</span>
<span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">eth1</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">numa_node</span>
</pre></div>
</div>
<p>Suricata operates in workers runmode. Packet distribution relies on Receive
Side Scaling (RSS), which distributes packets across the NIC queues.
Individual Suricata workers then poll packets from the NIC queues.
Internally, DPDK runmode uses a <a class="reference external" href="https://www.ran-lifshitz.com/2014/08/28/symmetric-rss-receive-side-scaling/">symmetric hash (0x6d5a)</a>
that redirects bi-flows to specific workers.</p>
<p>Before Suricata can be run, it is required to allocate a sufficient number of
hugepages. For efficiency, hugepages are continuous chunks of memory (pages)
that are larger (2 MB+) than what is typically used in the operating systems
(4 KB). A lower count of pages allows faster lookup of page entries. The
hugepages need to be allocated on the NUMA node where the NIC and affiniated
CPU cores reside. For example, if the hugepages are allocated only on NUMA
node 0 and the NIC is connected to NUMA node 1, then the application will fail
to start. As a result, it is advised to identify the NUMA node to which the
NIC is attached before allocating hugepages and setting CPU core affinity to
that node. In case Suricata deployment uses multiple NICs, hugepages must be
allocated on each of the NUMA nodes used by the Suricata deployment.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## To check number of allocated hugepages:</span>
<span class="n">sudo</span> <span class="n">dpdk</span><span class="o">-</span><span class="n">hugepages</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">s</span>
<span class="c1"># alternative (older) way</span>
<span class="n">grep</span> <span class="n">Huge</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span>

<span class="c1">## Allocate 2 GB in hugepages on all available NUMA nodes:</span>
<span class="c1"># (number of hugepages depend on the default size of hugepages 2 MB / 1 GB)</span>
<span class="n">sudo</span> <span class="n">dpdk</span><span class="o">-</span><span class="n">hugepages</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">setup</span> <span class="mi">2</span><span class="n">G</span>
<span class="c1"># alternative (older) way allocates 1024 2 MB hugepages but only on NUMA 0</span>
<span class="n">echo</span> <span class="mi">1024</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> \
  <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">node</span><span class="o">/</span><span class="n">node0</span><span class="o">/</span><span class="n">hugepages</span><span class="o">/</span><span class="n">hugepages</span><span class="o">-</span><span class="mi">2048</span><span class="n">kB</span><span class="o">/</span><span class="n">nr_hugepages</span>
</pre></div>
</div>
<p>DPDK memory pools hold packets received from NICs. These memory pools are
allocated in hugepages. One memory pool is allocated per interface. The size
of each memory pool can be individual and is set with the <cite>mempool-size</cite>.
Memory (in bytes) for one memory pool is calculated as: <cite>mempool-size</cite> * <cite>mtu</cite>.
The sum of memory pool requirements divided by the size of one hugepage results
in the number of required hugepages. It causes no problem to allocate more
memory than required, but it is vital for Suricata to not run out of hugepages.</p>
<p>The mempool cache is local to the individual CPU cores and holds packets that
were recently processed. As the mempool is shared among all cores, the cache
tries to minimize the required inter-process synchronization. The recommended
size of the cache is covered in the YAML file.</p>
<p>To be able to run DPDK on Intel cards, it is required to change the default
Intel driver to either <cite>vfio-pci</cite> or <cite>igb_uio</cite> driver. The process is
described in <a class="reference external" href="https://doc.dpdk.org/guides/linux_gsg/linux_drivers.html">DPDK manual page regarding Linux drivers</a>.
DPDK is natively supported by Mellanox and thus their NICs should work
&quot;out of the box&quot;.</p>
<p><strong>Current DPDK support</strong> involves Suricata running on:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>a physical machine with a physical NICs such as:</dt>
<dd><ul class="first last">
<li>mlx5 (ConnectX-4/ConnectX-5/ConnectX-6)</li>
<li>ixgbe</li>
<li>i40e</li>
<li>ice</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>a virtual machine with virtual interfaces such as:</dt>
<dd><ul class="first last">
<li>e1000</li>
<li>VMXNET3</li>
<li>virtio-net</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Other NICs using the same driver as mentioned above should work as well.
The DPDK capture interface has not been tested neither with the virtual
interfaces nor in the virtual environments like VMs, Docker or similar.</p>
<p>The minimal supported DPDK is version 19.11 which should be available in most
repositories of major distributions.
Alternatively, it is also possible to use <cite>meson</cite> and <cite>ninja</cite> to build and
install DPDK from source files.
It is required to have correctly configured tool <cite>pkg-config</cite> as it is used to
load libraries and CFLAGS during the Suricata configuration and compilation.
This can be tested by querying DPDK version as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pkg</span><span class="o">-</span><span class="n">config</span> <span class="o">--</span><span class="n">modversion</span> <span class="n">libdpdk</span>
</pre></div>
</div>
</div>
<div class="section" id="pf-ring">
<h5>Pf-ring<a class="headerlink" href="#pf-ring" title="Permalink to this headline">¶</a></h5>
<p>The Pf_ring is a library that aims to improve packet capture
performance over libcap. It performs packet acquisition. There are
three options within Pf_ring: interface, cluster-id and cluster-type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pfring</span><span class="p">:</span>
  <span class="n">interface</span><span class="p">:</span> <span class="n">eth0</span>    <span class="c1"># In this option you can set the network-interface</span>
                     <span class="c1"># on which you want the packets of the network to be read.</span>
</pre></div>
</div>
<p>Pf_ring will load balance packets based on flow. All packet
acquisition threads that will participate in the load balancing need
to have the same cluster-id. It is important to make sure this ID is
unique for this cluster of threads, so that no other engine / program
is making use of clusters with the same id.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">99</span>
</pre></div>
</div>
<p>Pf_ring can load balance traffic using pf_ring-clusters. All traffic
for pf_ring can be load balanced according to the configured cluster
type value; in a round robin manner or a per flow manner that are part
of the same cluster. All traffic for pf_ring will be load balanced across
acquisition threads of the same cluster id.</p>
<p>The &quot;inner&quot; flow means that the traffic will be load balanced based on
address tuple after the outer vlan has been removed.</p>
<table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Cluster Type</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>cluster_flow</td>
<td>src ip, src_port, dst ip, dst port, proto, vlan</td>
</tr>
<tr class="row-odd"><td>cluster_inner_flow</td>
<td>src ip, src port, dst ip, dst port, proto, vlan</td>
</tr>
<tr class="row-even"><td>cluster_inner_flow_2_tuple</td>
<td>src ip, dst ip</td>
</tr>
<tr class="row-odd"><td>cluster_inner_flow_4_tuple</td>
<td>src ip, src port, dst ip, dst port</td>
</tr>
<tr class="row-even"><td>cluster_inner_flow_5_tuple</td>
<td>src ip, src port, dst ip, dst port, proto</td>
</tr>
<tr class="row-odd"><td>cluster_round_robin</td>
<td>not recommended</td>
</tr>
</tbody>
</table>
<p>The cluster_round_robin manner is a way of distributing packets one at
a time to each thread (like distributing playing cards to fellow
players). The cluster_flow manner is a way of distributing all packets
of the same flow to the same thread. The flows itself will be
distributed to the threads in a round-robin manner.</p>
<p>If your deployment has VLANs, the cluster types with &quot;inner&quot; will use the innermost
address tuple for distribution.</p>
<p>The default cluster type is <code class="docutils literal notranslate"><span class="pre">cluster_flow</span></code>; the <code class="docutils literal notranslate"><span class="pre">cluster_round_robin</span></code> is not recommended with Suricata.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_inner_flow_5_tuple</span>
</pre></div>
</div>
</div>
<div class="section" id="nfq">
<span id="suricata-yaml-nfq"></span><h5>NFQ<a class="headerlink" href="#nfq" title="Permalink to this headline">¶</a></h5>
<p>Using NFQUEUE in iptables rules, will send packets to Suricata. If the
mode is set to 'accept', the packet that has been send to Suricata by
a rule using NFQ, will by default not be inspected by the rest of the
iptables rules after being processed by Suricata. There are a few more
options to NFQ to change this if desired.</p>
<p>If the mode is set to 'repeat', the packets will be marked by Suricata
and be re-injected at the first rule of iptables. To mitigate the
packet from being going round in circles, the rule using NFQ will be
skipped because of the mark.</p>
<p>If the mode is set to 'route', you can make sure the packet will be
send to another tool after being processed by Suricata. It is possible
to assign this tool at the mandatory option 'route_queue'. Every
engine/tool is linked to a queue-number. This number you can add to
the NFQ rule and to the route_queue option.</p>
<p>Add the numbers of the options repeat_mark and route_queue to the NFQ-rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>iptables -I FORWARD -m mark ! --mark $MARK/$MASK -j NFQUEUE
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nfq</span><span class="p">:</span>
   <span class="n">mode</span><span class="p">:</span> <span class="n">accept</span>                 <span class="c1">#By default the packet will be accepted or dropped by Suricata</span>
   <span class="n">repeat_mark</span><span class="p">:</span> <span class="mi">1</span>               <span class="c1">#If the mode is set to &#39;repeat&#39;, the packets will be marked after being</span>
                                <span class="c1">#processed by Suricata.</span>
   <span class="n">repeat_mask</span><span class="p">:</span> <span class="mi">1</span>
   <span class="n">route_queue</span><span class="p">:</span> <span class="mi">2</span>               <span class="c1">#Here you can assign the queue-number of the tool that Suricata has to</span>
                                <span class="c1">#send the packets to after processing them.</span>
</pre></div>
</div>
<p><em>Example 1 NFQ1</em></p>
<p>mode: accept</p>
<img alt="_images/NFQ.png" src="_images/NFQ.png" />
<p><em>Example 2 NFQ</em></p>
<p>mode: repeat</p>
<img alt="_images/NFQ1.png" src="_images/NFQ1.png" />
<p><em>Example 3 NFQ</em></p>
<p>mode: route</p>
<img alt="_images/NFQ2.png" src="_images/NFQ2.png" />
</div>
<div class="section" id="ipfw">
<h5>Ipfw<a class="headerlink" href="#ipfw" title="Permalink to this headline">¶</a></h5>
<p>Suricata does not only support Linux, it supports the FreeBSD
operating system (this is an open source Unix operating system) and
Mac OS X as well. The in-line mode on FreeBSD uses ipfw (IP-firewall).</p>
<p>Certain rules in ipfw send network-traffic to Suricata. Rules have
numbers. In this option you can set the rule to which the
network-traffic will be placed back. Make sure this rule comes after
the one that sends the traffic to Suricata, otherwise it will go
around in circles.</p>
<p>The following tells the engine to re-inject packets back into the ipfw
firewall at rule number 5500:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipfw</span><span class="p">:</span>
  <span class="n">ipfw</span><span class="o">-</span><span class="n">reinjection</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">number</span><span class="p">:</span> <span class="mi">5500</span>
</pre></div>
</div>
<p><em>Example 16     Ipfw-reinjection.</em></p>
<img alt="_images/ipfw_reinjection.png" src="_images/ipfw_reinjection.png" />
</div>
</div>
<div class="section" id="rules">
<h4>Rules<a class="headerlink" href="#rules" title="Permalink to this headline">¶</a></h4>
<div class="section" id="rule-files">
<h5>Rule Files<a class="headerlink" href="#rule-files" title="Permalink to this headline">¶</a></h5>
<p>Suricata by default is setup for rules to be managed by Suricata-Update with
the following rule file configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">default-rule-path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/suricata/rules</span>
<span class="nt">rule-files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">suricata.rules</span>
</pre></div>
</div>
<p>A default installation of Suricata-Update will write out the rules to
/var/lib/suricata/rules/suricata.rules.</p>
<p>You may want to edit this section if you are not using Suricata-Update or want
to add rule files that are not managed by Suricata-Update, for example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">default-rule-path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/suricata/rules</span>
<span class="nt">rule-files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">suricata.rules</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/suricata/rules/custom.rules</span>
</pre></div>
</div>
<p>File names can be specific with an absolute path, or just the base name. If
just the base name is provided it will be looked for in the
<code class="docutils literal notranslate"><span class="pre">default-rule-path</span></code>.</p>
<p>If a rule file cannot be found, Suricata will log a warning message and
continue to load, unless <code class="docutils literal notranslate"><span class="pre">--init-errors-fatal</span></code> has been specified on the
command line, in which case Suricata will exit with an error code.</p>
<p>For more information on rule management see <a class="reference internal" href="index.html#document-rule-management/index"><span class="doc">Rule Management</span></a>.</p>
</div>
<div class="section" id="threshold-file">
<h5>Threshold-file<a class="headerlink" href="#threshold-file" title="Permalink to this headline">¶</a></h5>
<p>Within this option, you can state the directory in which the
threshold-file will be stored. The default directory is:
/etc/suricata/threshold.config</p>
</div>
<div class="section" id="classifications">
<h5>Classifications<a class="headerlink" href="#classifications" title="Permalink to this headline">¶</a></h5>
<p>The Classification-file is a file which makes the purpose of rules
clear.</p>
<p>Some rules are just for providing information. Some of them are to
warn you for serious risks like when you are being hacked etc.</p>
<p>In this classification-file, there is a part submitted to the rule to
make it possible for the system-administrator to distinguish events.</p>
<p>A rule in this file exists of three parts: the short name, a
description and the priority of the rule (in which 1 has the highest
priority and 4 the lowest).</p>
<p>You can notice these descriptions returning in the rule and events / alerts.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Example:

configuration classification: misc-activity,Misc activity,3

Rule:

alert tcp $HOME_NET 21 -&gt; $EXTERNAL_NET any (msg:&quot;ET POLICY FTP Login Successful (non-anonymous)&quot;;
flow:from_server,established;flowbits:isset,ET.ftp.user.login; flowbits:isnotset,ftp.user.logged_in;
flowbits:set,ftp.user.logged_in; content:&quot;230 &quot;;pcre:!&quot;/^230(\s+USER)?\s+(anonymous|ftp)/smi&quot;;
classtype:misc-activity; reference:urldoc.emergingthreats.net/2003410,;
reference:url,www.emergingthreats.net/cgi-bin/cvsweb.cgi/sigs/POLICY/POLICY_FTP_Login; sid:2003410; rev:7;)

Event/Alert:

10/26/10-10:13:42.904785  [**] [1:2003410:7] ET POLICY FTP Login Successful (non-anonymous) [**]
 [Classification: Misc activity[Priority: 3] {TCP} 192.168.0.109:21 -&gt; x.x.x.x:34117
</pre></div>
</div>
<p>You can set the direction of the classification configuration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">classification</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">classification</span><span class="o">.</span><span class="n">config</span>
</pre></div>
</div>
</div>
<div class="section" id="rule-vars">
<span id="suricata-yaml-rule-vars"></span><h5>Rule-vars<a class="headerlink" href="#rule-vars" title="Permalink to this headline">¶</a></h5>
<p>There are variables which can be used in rules.</p>
<p>Within rules, there is a possibility to set for which IP-address the
rule should be checked and for which IP-address it should not.</p>
<p>This way, only relevant rules will be used. To prevent you from having
to set this rule by rule, there is an option in which you can set the
relevant IP-address for several rules. This option contains the
address group vars that will be passed in a rule. So, after HOME_NET
you can enter your home IP-address.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="p">:</span>
  <span class="n">address</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>
    <span class="n">HOME_NET</span><span class="p">:</span> <span class="s2">&quot;[192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]&quot;</span>        <span class="c1">#By using [], it is possible to set</span>
                                                                 <span class="c1">#complicated variables.</span>
    <span class="n">EXTERNAL_NET</span><span class="p">:</span> <span class="nb">any</span>
    <span class="n">HTTP_SERVERS</span><span class="p">:</span> <span class="s2">&quot;$HOME_NET&quot;</span>                                    <span class="c1">#The $-sign tells that what follows is</span>
                                                                 <span class="c1">#a variable.</span>
    <span class="n">SMTP_SERVERS</span><span class="p">:</span> <span class="s2">&quot;$HOME_NET&quot;</span>
    <span class="n">SQL_SERVERS</span><span class="p">:</span> <span class="s2">&quot;$HOME_NET&quot;</span>
    <span class="n">DNS_SERVERS</span><span class="p">:</span> <span class="s2">&quot;$HOME_NET&quot;</span>
    <span class="n">TELNET_SERVERS</span><span class="p">:</span> <span class="s2">&quot;$HOME_NET&quot;</span>
    <span class="n">AIM_SERVERS</span><span class="p">:</span> <span class="nb">any</span>
</pre></div>
</div>
<p>It is a convention to use upper-case characters.</p>
<p>There are two kinds of variables: Address groups and Port-groups. They
both have the same function: change the rule so it will be relevant to
your needs.</p>
<p>In a rule there is a part assigned to the address and one to the
port. Both have their variable.</p>
<p>All options have to be set. If it is not necessary to set a specific
address, you should enter 'any'.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>
  <span class="n">HTTP_PORTS</span><span class="p">:</span> <span class="s2">&quot;80&quot;</span>
  <span class="n">SHELLCODE_PORTS</span><span class="p">:</span> <span class="s2">&quot;!80&quot;</span>
  <span class="n">ORACLE_PORTS</span><span class="p">:</span> <span class="mi">1521</span>
  <span class="n">SSH_PORTS</span><span class="p">:</span> <span class="mi">22</span>
</pre></div>
</div>
</div>
<div class="section" id="host-os-policy">
<span id="id2"></span><h5>Host-os-policy<a class="headerlink" href="#host-os-policy" title="Permalink to this headline">¶</a></h5>
<p>Operating systems differ in the way they process fragmented packets
and streams. Suricata performs differently with anomalies for
different operating systems. It is important to set of which operating
system your IP-address makes use of, so Suricata knows how to process
fragmented packets and streams. For example in stream-reassembly there
can be packets with overlapping payloads.</p>
<p><em>Example 17     Overlapping payloads</em></p>
<img alt="_images/overlap.png" src="_images/overlap.png" />
<p>In the configuration-file, the operating-systems are listed. You can
add your IP-address behind the name of the operating system you make
use of.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">host</span><span class="o">-</span><span class="n">os</span><span class="o">-</span><span class="n">policy</span><span class="p">:</span>
  <span class="n">windows</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">bsd</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">bsd_right</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">old_linux</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">linux</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0.0.0</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="mf">192.168.1.100</span><span class="p">,</span> <span class="s2">&quot;8762:2352:6241:7245:E000:0000:0000:0000&quot;</span><span class="p">]</span>
  <span class="n">old_solaris</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">solaris</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;::1&quot;</span><span class="p">]</span>
  <span class="n">hpux10</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">hpux11</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">irix</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">macos</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">vista</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">windows2k3</span><span class="p">:</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="engine-analysis-and-profiling">
<h4>Engine analysis and profiling<a class="headerlink" href="#engine-analysis-and-profiling" title="Permalink to this headline">¶</a></h4>
<p>Suricata offers several ways of analyzing performance of rules and the
engine itself.</p>
<div class="section" id="engine-analysis">
<h5>Engine-analysis<a class="headerlink" href="#engine-analysis" title="Permalink to this headline">¶</a></h5>
<p>The option engine-analysis provides information for signature writers
about how Suricata organizes signatures internally.</p>
<p>Like mentioned before, signatures have zero or more patterns on which
they can match. Only one of these patterns will be used by the multi
pattern matcher (MPM). Suricata determines which patterns will be used
unless the fast-pattern rule option is used.</p>
<p>The option engine-analysis creates a new log file in the default log
dir. In this file all information about signatures and patterns can be
found so signature writers are able to see which pattern is used and
change it if desired.</p>
<p>To create this log file, you have to run Suricata with
./src/suricata -c suricata.yaml --engine-analysis.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span><span class="o">-</span><span class="n">analysis</span><span class="p">:</span>
   <span class="n">rules</span><span class="o">-</span><span class="n">fast</span><span class="o">-</span><span class="n">pattern</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">10703</span><span class="p">]</span> <span class="mi">26</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2010</span> <span class="o">--</span> <span class="mi">11</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">15</span> <span class="o">-</span> <span class="p">(</span><span class="n">detect</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">560</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Info</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">SigLoadSignatures</span><span class="p">)</span>
<span class="o">--</span> <span class="n">Engine</span><span class="o">-</span><span class="n">Analysis</span> <span class="k">for</span> <span class="n">fast_pattern</span> <span class="n">printed</span> <span class="n">to</span> <span class="n">file</span> <span class="o">-</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">rules_fast_pattern</span><span class="o">.</span><span class="n">txt</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;Volume Serial Number&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1292</span><span class="p">;)</span>

<span class="o">==</span> <span class="n">Sid</span><span class="p">:</span> <span class="mi">1292</span> <span class="o">==</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">matcher</span><span class="p">:</span> <span class="n">content</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">only</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">chop</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Content</span> <span class="n">negated</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Original</span> <span class="n">content</span><span class="p">:</span> <span class="n">Volume</span> <span class="n">Serial</span> <span class="n">Number</span>
<span class="n">Final</span> <span class="n">content</span><span class="p">:</span> <span class="n">Volume</span> <span class="n">Serial</span> <span class="n">Number</span>

<span class="o">---</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;defghi&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>

<span class="o">==</span> <span class="n">Sid</span><span class="p">:</span> <span class="mi">1</span> <span class="o">==</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">matcher</span><span class="p">:</span> <span class="n">content</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">only</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">chop</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Content</span> <span class="n">negated</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Original</span> <span class="n">content</span><span class="p">:</span> <span class="n">defghi</span>
<span class="n">Final</span> <span class="n">content</span><span class="p">:</span> <span class="n">defghi</span>

<span class="o">---</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">fast_pattern</span><span class="p">:</span><span class="n">only</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;defghi&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>

<span class="o">==</span> <span class="n">Sid</span><span class="p">:</span> <span class="mi">1</span> <span class="o">==</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">matcher</span><span class="p">:</span> <span class="n">content</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="nb">set</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">only</span> <span class="nb">set</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">chop</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Content</span> <span class="n">negated</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Original</span> <span class="n">content</span><span class="p">:</span> <span class="n">abc</span>
<span class="n">Final</span> <span class="n">content</span><span class="p">:</span> <span class="n">abc</span>

<span class="o">---</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">fast_pattern</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;defghi&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>

<span class="o">==</span> <span class="n">Sid</span><span class="p">:</span> <span class="mi">1</span> <span class="o">==</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">matcher</span><span class="p">:</span> <span class="n">content</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="nb">set</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">only</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">chop</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Content</span> <span class="n">negated</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Original</span> <span class="n">content</span><span class="p">:</span> <span class="n">abc</span>
<span class="n">Final</span> <span class="n">content</span><span class="p">:</span> <span class="n">abc</span>

<span class="o">---</span>

<span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span><span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">fast_pattern</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;defghi&quot;</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>

<span class="o">==</span> <span class="n">Sid</span><span class="p">:</span> <span class="mi">1</span> <span class="o">==</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">matcher</span><span class="p">:</span> <span class="n">content</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="nb">set</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">only</span> <span class="nb">set</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">chop</span> <span class="nb">set</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">Fast</span> <span class="n">pattern</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="n">Content</span> <span class="n">negated</span><span class="p">:</span> <span class="n">no</span>
<span class="n">Original</span> <span class="n">content</span><span class="p">:</span> <span class="n">abc</span>
<span class="n">Final</span> <span class="n">content</span><span class="p">:</span> <span class="n">bc</span>
</pre></div>
</div>
</div>
<div class="section" id="rule-and-packet-profiling-settings">
<h5>Rule and Packet Profiling settings<a class="headerlink" href="#rule-and-packet-profiling-settings" title="Permalink to this headline">¶</a></h5>
<p>Rule profiling is a part of Suricata to determine how expensive rules
are. Some rules are very expensive while inspecting traffic. Rule
profiling is convenient for people trying to track performance
problems and resolving them. Also for people writing signatures.</p>
<p>Compiling Suricata with rule-profiling will have an impact on
performance, even if the option is disabled in the configuration file.</p>
<p>To observe the rule-performance, there are several options.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">profiling</span><span class="p">:</span>
  <span class="n">rules</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>This engine is not used by default. It can only be used if Suricata is
compiled with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">enable</span><span class="o">-</span><span class="n">profiling</span>
</pre></div>
</div>
<p>At the end of each session, Suricata will display the profiling
statistics. The list will be displayed sorted.</p>
<p>This order can be changed as pleased. The choice is between ticks,
avgticks, checks, maxticks and matches. The setting of your choice
will be displayed from high to low.</p>
<p>The amount of time it takes to check the signatures, will be
administrated by Suricata. This will be counted in ticks. One tick is
one CPU computation. 3 GHz will be 3 billion ticks.</p>
<p>Beside the amount of checks, ticks and matches it will also display
the average and the maximum of a rule per session at the end of the
line.</p>
<p>The option Limit determines the amount of signatures of which the
statistics will be shown, based on the sorting.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sort</span><span class="p">:</span> <span class="n">avgticks</span>
<span class="n">limit</span><span class="p">:</span> <span class="mi">100</span>
</pre></div>
</div>
<p>Example of how the rule statistics can look like;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Rule</span>            <span class="n">Ticks</span>            <span class="o">%</span>     <span class="n">Checks</span>         <span class="n">Matches</span>           <span class="n">Max</span> <span class="n">Tick</span>         <span class="n">Avg</span>
<span class="n">Ticks</span>

<span class="mi">7560</span>            <span class="mi">107766621</span>       <span class="mf">0.02</span>    <span class="mi">138</span>             <span class="mi">37</span>              <span class="mi">105155334</span>       <span class="mf">780917.54</span>
<span class="mi">11963</span>           <span class="mi">1605394413</span>      <span class="mf">0.29</span>    <span class="mi">2623</span>             <span class="mi">1</span>              <span class="mi">144418923</span>       <span class="mf">612045.14</span>
<span class="mi">7040</span>            <span class="mi">1431034011</span>      <span class="mf">0.26</span>    <span class="mi">2500</span>             <span class="mi">0</span>              <span class="mi">106018209</span>       <span class="mf">572413.60</span>
<span class="mi">5726</span>            <span class="mi">1437574662</span>      <span class="mf">0.26</span>    <span class="mi">2623</span>             <span class="mi">1</span>              <span class="mi">115632900</span>       <span class="mf">548065.06</span>
<span class="mi">7037</span>            <span class="mi">1355312799</span>      <span class="mf">0.24</span>    <span class="mi">2562</span>             <span class="mi">0</span>              <span class="mi">116048286</span>       <span class="mf">529005.78</span>
<span class="mi">11964</span>           <span class="mi">1276449255</span>      <span class="mf">0.23</span>    <span class="mi">2623</span>             <span class="mi">1</span>              <span class="mi">96412347</span>        <span class="mf">486637.15</span>
<span class="mi">7042</span>            <span class="mi">1272562974</span>      <span class="mf">0.23</span>    <span class="mi">2623</span>             <span class="mi">1</span>              <span class="mi">96405993</span>        <span class="mf">485155.54</span>
<span class="mi">5719</span>            <span class="mi">1233969192</span>      <span class="mf">0.22</span>    <span class="mi">2562</span>             <span class="mi">0</span>              <span class="mi">106439661</span>       <span class="mf">481642.93</span>
<span class="mi">5720</span>            <span class="mi">1204053246</span>      <span class="mf">0.21</span>    <span class="mi">2562</span>             <span class="mi">0</span>              <span class="mi">125155431</span>       <span class="mf">469966.14</span>
</pre></div>
</div>
</div>
<div class="section" id="packet-profiling">
<h5>Packet Profiling<a class="headerlink" href="#packet-profiling" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">packets</span><span class="p">:</span>

  <span class="c1"># Profiling can be disabled here, but it will still have a</span>
  <span class="c1"># performance impact if compiled in.</span>


  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>                                  <span class="c1">#this option is enabled by default</span>
  <span class="n">filename</span><span class="p">:</span> <span class="n">packet_stats</span><span class="o">.</span><span class="n">log</span>                    <span class="c1">#name of the file in which packet profiling information will be</span>
                                                <span class="c1">#stored.</span>
  <span class="n">append</span><span class="p">:</span> <span class="n">yes</span>                                   <span class="c1">#If set to yes, new packet profiling information will be added to the</span>
                                                <span class="c1">#information that was saved last in the file.</span>

  <span class="c1"># per packet csv output</span>
  <span class="n">csv</span><span class="p">:</span>

    <span class="c1"># Output can be disabled here, but it will still have a</span>
    <span class="c1"># performance impact if compiled in.</span>

    <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>                                <span class="c1">#the sending of packet output to a csv-file is by default disabled.</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">packet_stats</span><span class="o">.</span><span class="n">csv</span>                 <span class="c1">#name of the file in which csv packet profiling information will be</span>
                                               <span class="c1">#stored</span>
</pre></div>
</div>
<p>Packet profiling is enabled by default in suricata.yaml but it will
only do its job if you compiled Suricata with --enable profiling.</p>
<p>The filename in which packet profiling information will be stored, is
packet-stats.log. Information in this file can be added to the last
information that was saved there, or if the append option is set to
no, the existing file will be overwritten.</p>
<p>Per packet, you can send the output to a csv-file. This file contains
one line for each packet with all profiling information of that
packet. This option can be used only if Suricata is build
with --enable-profiling and if the packet profiling option is enabled
in yaml.</p>
<p>It is best to use runmode 'single' if you would like to profile the
speed of the code.  When using a single thread, there is no situation
in which two threads have to wait for each other. When using two
threads, the time threads might have to wait for each other will be
taken in account when/during profiling packets. For more information
see <a class="reference internal" href="index.html#document-performance/packet-profiling"><span class="doc">Packet Profiling</span></a>.</p>
</div>
</div>
<div class="section" id="decoder">
<h4>Decoder<a class="headerlink" href="#decoder" title="Permalink to this headline">¶</a></h4>
<div class="section" id="teredo">
<h5>Teredo<a class="headerlink" href="#teredo" title="Permalink to this headline">¶</a></h5>
<p>The Teredo decoder can be disabled. It is enabled by default.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>decoder:
  # Teredo decoder is known to not be completely accurate
  # it will sometimes detect non-teredo as teredo.
  teredo:
    enabled: true
    # ports to look for Teredo. Max 4 ports. If no ports are given, or
    # the value is set to &#39;any&#39;, Teredo detection runs on _all_ UDP packets.
    ports: $TEREDO_PORTS # syntax: &#39;[3544, 1234]&#39;
</pre></div>
</div>
<p>Using this default configuration, Teredo detection will run on UDP port
3544. If the <cite>ports</cite> parameter is missing, or set to <cite>any</cite>, all ports will be
inspected for possible presence of Teredo.</p>
</div>
</div>
<div class="section" id="advanced-options">
<h4>Advanced Options<a class="headerlink" href="#advanced-options" title="Permalink to this headline">¶</a></h4>
<div class="section" id="stacktrace">
<h5>stacktrace<a class="headerlink" href="#stacktrace" title="Permalink to this headline">¶</a></h5>
<p>Display diagnostic stacktraces when a signal unexpectedly terminates Suricata, e.g., such as
SIGSEGV or SIGABRT. Requires the <code class="docutils literal notranslate"><span class="pre">libunwind</span></code> library to be available. The default value is
to display the diagnostic message if a signal unexpectedly terminates Suricata -- e.g.,
<code class="docutils literal notranslate"><span class="pre">SIGABRT</span></code> or <code class="docutils literal notranslate"><span class="pre">SIGSEGV</span></code> occurs while Suricata is running.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="p">:</span>
    <span class="c1"># Requires libunwind to be available when Suricata is configured and built.</span>
    <span class="c1"># If a signal unexpectedly terminates Suricata, displays a brief diagnostic</span>
    <span class="c1"># message with the offending stacktrace if enabled.</span>
    <span class="c1">#stacktrace-on-signal: on</span>
</pre></div>
</div>
</div>
<div class="section" id="luajit">
<h5>luajit<a class="headerlink" href="#luajit" title="Permalink to this headline">¶</a></h5>
<div class="section" id="states">
<h6>states<a class="headerlink" href="#states" title="Permalink to this headline">¶</a></h6>
<p>Luajit has a strange memory requirement, it's 'states' need to be in the
first 2G of the process' memory. For this reason when luajit is used the
states are allocated at the process startup. This option controls how many
states are preallocated.</p>
<p>If the pool is depleted a warning is generated. Suricata will still try to
continue, but may fail if other parts of the engine take too much memory.
If the pool was depleted a hint will be printed at the engines exit.</p>
<p>States are allocated as follows: for each detect script a state is used per
detect thread. For each output script, a single state is used. Keep in
mind that a rule reload temporary doubles the states requirement.</p>
</div>
</div>
</div>
<div class="section" id="configuration-hardening">
<span id="suricata-yaml-config-hardening"></span><h4>Configuration hardening<a class="headerlink" href="#configuration-hardening" title="Permalink to this headline">¶</a></h4>
<p>The <cite>security</cite> section of suricata.yaml is meant to provide in-depth security configuration options.</p>
<p>Besides landlock, (see <a class="reference internal" href="index.html#landlock"><span class="std std-ref">Using Landlock LSM</span></a>), one setting is available.
<cite>limit-noproc</cite> is a boolean to prevent process creation by Suricata.
If you do not need Suricata to create other processes or threads
(you may need it for LUA scripts for instance or plugins), enable this to
call <cite>setrlimit</cite> with <cite>RLIMIT_NPROC</cite> argument (see <cite>man setrlimit</cite>).
This prevents potential exploits against Suricata to fork a new process,
even if it does not prevent the call of <cite>exec</cite>.</p>
<p>Warning! This has no effect on Linux when running as root. If you want a hardened configuration,
you probably want to set <cite>run-as</cite> configuration parameter so as to drop root privileges.</p>
<p>Beyond suricata.yaml, other ways to harden Suricata are
- compilation : enabling ASLR and other exploit mitigation techniques.
- environment : running Suricata on a device that has no direct access to Internet.</p>
<div class="section" id="lua">
<h5>Lua<a class="headerlink" href="#lua" title="Permalink to this headline">¶</a></h5>
<p>Suricata 7.0 disables Lua rules by default. Lua rules can be enabled
in the <code class="docutils literal notranslate"><span class="pre">security.lua</span></code> section of the configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">security</span><span class="p">:</span>
  <span class="n">lua</span><span class="p">:</span>
    <span class="c1"># Allow Lua rules. Disabled by default.</span>
    <span class="c1">#allow-rules: false</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-configuration/global-thresholds"></span><div class="section" id="global-thresholds">
<h3>Global-Thresholds<a class="headerlink" href="#global-thresholds" title="Permalink to this headline">¶</a></h3>
<p>Thresholds can be configured in the rules themselves, see
<a class="reference internal" href="index.html#document-rules/thresholding"><span class="doc">Thresholding Keywords</span></a>. They are often set by rule writers based on
their intelligence for creating a rule combined with a judgement on how often
a rule will alert.</p>
<div class="section" id="threshold-config">
<h4>Threshold Config<a class="headerlink" href="#threshold-config" title="Permalink to this headline">¶</a></h4>
<p>Next to rule thresholding more thresholding can be configured on the sensor
using the threshold.config.</p>
<div class="section" id="threshold-event-filter">
<h5>threshold/event_filter<a class="headerlink" href="#threshold-event-filter" title="Permalink to this headline">¶</a></h5>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">threshold</span> <span class="n">gen_id</span> <span class="o">&lt;</span><span class="n">gid</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">sig_id</span> <span class="o">&lt;</span><span class="n">sid</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">&lt;</span><span class="n">threshold</span><span class="o">|</span><span class="n">limit</span><span class="o">|</span><span class="n">both</span><span class="o">&gt;</span><span class="p">,</span> \
  <span class="n">track</span> <span class="o">&lt;</span><span class="n">by_src</span><span class="o">|</span><span class="n">by_dst</span><span class="o">|</span><span class="n">by_rule</span><span class="o">|</span><span class="n">by_both</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">count</span> <span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="rate-filter">
<h5>rate_filter<a class="headerlink" href="#rate-filter" title="Permalink to this headline">¶</a></h5>
<p>Rate filters allow changing of a rule action when a rule matches.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rate_filter</span><span class="p">:</span> <span class="n">rate_filter</span> <span class="n">gen_id</span> <span class="o">&lt;</span><span class="n">gid</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">sig_id</span> <span class="o">&lt;</span><span class="n">sid</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">track</span> <span class="o">&lt;</span><span class="n">tracker</span><span class="o">&gt;</span><span class="p">,</span> \
  <span class="n">count</span> <span class="o">&lt;</span><span class="n">c</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">&lt;</span><span class="n">s</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">new_action</span> <span class="o">&lt;</span><span class="n">action</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">&lt;</span><span class="n">timeout</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rate_filter</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_rule</span><span class="p">,</span> <span class="n">count</span> <span class="mi">100</span><span class="p">,</span> <span class="n">seconds</span> <span class="mi">60</span><span class="p">,</span> \
  <span class="n">new_action</span> <span class="n">alert</span><span class="p">,</span> <span class="n">timeout</span> <span class="mi">30</span>
</pre></div>
</div>
<div class="section" id="gen-id">
<h6>gen_id<a class="headerlink" href="#gen-id" title="Permalink to this headline">¶</a></h6>
<p>Generator id. Normally 1, but if a rule uses the <code class="docutils literal notranslate"><span class="pre">gid</span></code> keyword to set
another value it has to be matched in the <code class="docutils literal notranslate"><span class="pre">gen_id</span></code>.</p>
</div>
<div class="section" id="sig-id">
<h6>sig_id<a class="headerlink" href="#sig-id" title="Permalink to this headline">¶</a></h6>
<p>Rule/signature id as set by the rule <code class="docutils literal notranslate"><span class="pre">sid</span></code> keyword.</p>
</div>
<div class="section" id="track">
<h6>track<a class="headerlink" href="#track" title="Permalink to this headline">¶</a></h6>
<p>Where to track the rule matches. When using by_src/by_dst the tracking is
done per IP-address. The Host table is used for storage. When using by_rule
it's done globally for the rule.
Option by_both used to track per IP pair of source and destination. Packets
going to opposite directions between same addresses tracked as the same pair.</p>
</div>
<div class="section" id="count">
<h6>count<a class="headerlink" href="#count" title="Permalink to this headline">¶</a></h6>
<p>Number of rule hits before the <code class="docutils literal notranslate"><span class="pre">rate_filter</span></code> is activated.</p>
</div>
<div class="section" id="seconds">
<h6>seconds<a class="headerlink" href="#seconds" title="Permalink to this headline">¶</a></h6>
<p>Time period within which the <code class="docutils literal notranslate"><span class="pre">count</span></code> needs to be reached to activate
the <code class="docutils literal notranslate"><span class="pre">rate_filter</span></code></p>
</div>
<div class="section" id="new-action">
<h6>new_action<a class="headerlink" href="#new-action" title="Permalink to this headline">¶</a></h6>
<p>New action that is applied to matching traffic when the <code class="docutils literal notranslate"><span class="pre">rate_filter</span></code>
is in place.</p>
<p>Values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">alert</span><span class="o">|</span><span class="n">drop</span><span class="o">|</span><span class="k">pass</span><span class="o">|</span><span class="n">reject</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Note: 'sdrop' and 'log' are supported by the parser but not implemented otherwise.</p>
</div>
<div class="section" id="timeout">
<h6>timeout<a class="headerlink" href="#timeout" title="Permalink to this headline">¶</a></h6>
<p>Time in seconds during which the <code class="docutils literal notranslate"><span class="pre">rate_filter</span></code> will remain active.</p>
</div>
<div class="section" id="example">
<h6>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h6>
<p>Let's say we want to limit incoming connections to our SSH server. The rule
<code class="docutils literal notranslate"><span class="pre">888</span></code> below simply alerts on SYN packets to the SSH port of our SSH server.
If an IP-address triggers this more than 10 or more with a minute, the
drop <code class="docutils literal notranslate"><span class="pre">rate_filter</span></code> is set with a timeout of 5 minutes.</p>
<p>Rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp any any -&gt; $MY_SSH_SERVER 22 (msg:&quot;Connection to SSH server&quot;; \
  flow:to_server; flags:S,12; sid:888;)
</pre></div>
</div>
<p>Rate filter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rate_filter</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">888</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">count</span> <span class="mi">10</span><span class="p">,</span> <span class="n">seconds</span> <span class="mi">60</span><span class="p">,</span> \
  <span class="n">new_action</span> <span class="n">drop</span><span class="p">,</span> <span class="n">timeout</span> <span class="mi">300</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="suppress">
<h5>suppress<a class="headerlink" href="#suppress" title="Permalink to this headline">¶</a></h5>
<p>Suppressions can be used to suppress alerts for a rule or a
host/network. Actions performed when a rule matches, such as setting a
flowbit, are still performed.</p>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suppress</span> <span class="n">gen_id</span> <span class="o">&lt;</span><span class="n">gid</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">sig_id</span> <span class="o">&lt;</span><span class="n">sid</span><span class="o">&gt;</span>
<span class="n">suppress</span> <span class="n">gen_id</span> <span class="o">&lt;</span><span class="n">gid</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">sig_id</span> <span class="o">&lt;</span><span class="n">sid</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">track</span> <span class="o">&lt;</span><span class="n">by_src</span><span class="o">|</span><span class="n">by_dst</span><span class="o">|</span><span class="n">by_either</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">ip</span> <span class="o">&lt;</span><span class="n">ip</span><span class="o">|</span><span class="n">subnet</span><span class="o">|</span><span class="n">addressvar</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suppress</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">2002087</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">ip</span> <span class="mf">209.132.180.67</span>
</pre></div>
</div>
<p>This will make sure the signature 2002087 will never match for src
host 209.132.180.67.</p>
<p>Other possibilities/examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>suppress gen_id 1, sig_id 2003614, track by_src, ip 217.110.97.128/25
suppress gen_id 1, sig_id 2003614, track by_src, ip [192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]
suppress gen_id 1, sig_id 2003614, track by_src, ip $HOME_NET
suppress gen_id 1, sig_id 2003614, track by_either, ip 217.110.97.128/25
</pre></div>
</div>
<p>In the last example above, the <code class="docutils literal notranslate"><span class="pre">by_either</span></code> tracking means that if either
the <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">ip</span></code> or <code class="docutils literal notranslate"><span class="pre">destination</span> <span class="pre">ip</span></code> matches <code class="docutils literal notranslate"><span class="pre">217.110.97.128/25</span></code> the
rule with sid 2003614 is suppressed.</p>
</div>
</div>
<div class="section" id="global-thresholds-vs-rule-thresholds">
<span id="id1"></span><h4>Global thresholds vs rule thresholds<a class="headerlink" href="#global-thresholds-vs-rule-thresholds" title="Permalink to this headline">¶</a></h4>
<p><strong>Note: this section applies to 1.4+ In 1.3 and before mixing rule and
global thresholds is not supported.</strong></p>
<p>When a rule has a threshold/detection_filter set a rule can still be
affected by the global threshold file.</p>
<p>The rule below will only fire if 10 or more emails are being
delivered/sent from a host within 60 seconds.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="mi">25</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;ET POLICY Inbound Frequent Emails - Possible Spambot Inbound&quot;</span><span class="p">;</span> \
     <span class="n">flow</span><span class="p">:</span><span class="n">established</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;mail from|3a|&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span>                                          \
     <span class="n">threshold</span><span class="p">:</span> <span class="nb">type</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">count</span> <span class="mi">10</span><span class="p">,</span> <span class="n">seconds</span> <span class="mi">60</span><span class="p">;</span>                              \
     <span class="n">reference</span><span class="p">:</span><span class="n">url</span><span class="p">,</span><span class="n">doc</span><span class="o">.</span><span class="n">emergingthreats</span><span class="o">.</span><span class="n">net</span><span class="o">/</span><span class="mi">2002087</span><span class="p">;</span> <span class="n">classtype</span><span class="p">:</span><span class="n">misc</span><span class="o">-</span><span class="n">activity</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2002087</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">10</span><span class="p">;)</span>
</pre></div>
</div>
<p>Next, we'll see how global settings affect this rule.</p>
<div class="section" id="id2">
<h5>Suppress<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<p>Suppressions can be combined with rules with
thresholds/detection_filters with no exceptions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suppress</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">2002087</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">ip</span> <span class="mf">209.132.180.67</span>
<span class="n">suppress</span> <span class="n">gen_id</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">0</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">ip</span> <span class="mf">209.132.180.67</span>
<span class="n">suppress</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">0</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">ip</span> <span class="mf">209.132.180.67</span>
</pre></div>
</div>
<p>Each of the rules above will make sure 2002087 doesn't alert when the
source of the emails is 209.132.180.67. It <strong>will</strong> alert for all other
hosts.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suppress</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">2002087</span>
</pre></div>
</div>
<p>This suppression will simply convert the rule to &quot;noalert&quot;, meaning it
will never alert in any case. If the rule sets a flowbit, that will
still happen.</p>
</div>
<div class="section" id="id3">
<h5>Threshold/event_filter<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<p>When applied to a specific signature, thresholds and event_filters
(threshold from now on) will override the signature setting. This can
be useful for when the default in a signature doesn't suit your
environment.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">threshold</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">2002087</span><span class="p">,</span> <span class="nb">type</span> <span class="n">both</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">count</span> <span class="mi">3</span><span class="p">,</span> <span class="n">seconds</span> <span class="mi">5</span>
<span class="n">threshold</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">2002087</span><span class="p">,</span> <span class="nb">type</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">count</span> <span class="mi">10</span><span class="p">,</span> <span class="n">seconds</span> <span class="mi">60</span>
<span class="n">threshold</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">2002087</span><span class="p">,</span> <span class="nb">type</span> <span class="n">limit</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">count</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seconds</span> <span class="mi">15</span>
</pre></div>
</div>
<p>Each of these will replace the threshold setting for 2002087 by the
new threshold setting.</p>
<p><strong>Note:</strong> overriding all gids or sids (by using gen_id 0 or sig_id 0)
is not supported. Bug <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/425">https://redmine.openinfosecfoundation.org/issues/425</a>.</p>
</div>
<div class="section" id="id4">
<h5>Rate_filter<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<p>see <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/425">https://redmine.openinfosecfoundation.org/issues/425</a>.</p>
</div>
</div>
</div>
<span id="document-configuration/exception-policies"></span><div class="section" id="exception-policies">
<span id="id1"></span><h3>Exception Policies<a class="headerlink" href="#exception-policies" title="Permalink to this headline">¶</a></h3>
<p>Suricata has a set of configuration variables to indicate what should the engine
do when certain exception conditions, such as hitting a memcap, are reached.</p>
<p>They are called Exception Policies and are configurable via suricata.yaml. If
enabled, the engine will call them when it reaches exception states.</p>
<p>For developers or for researching purposes, there are also simulation options
exposed in debug mode and passed via command-line. These exist to force or
simulate failures or errors and understand Suricata behavior under such conditions.</p>
<div class="section" id="id2">
<h4>Exception Policies<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="section" id="master-switch">
<span id="id3"></span><h5>Master Switch<a class="headerlink" href="#master-switch" title="Permalink to this headline">¶</a></h5>
<p>It is possible to set all configuration policies via what we call &quot;master
switch&quot;. This offers a quick way to define what the engine should do in case of
traffic exceptions, while still allowing for the flexibility of indicating a
different behavior for specific exception policies your setup/environment may
have the need to.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a common behavior for all exception policies.</span>
<span class="c1"># In IPS mode, the default is drop-flow. For cases when that&#39;s not possible, the</span>
<span class="c1"># engine will fall to drop-packet. To fallback to old behavior (setting each of</span>
<span class="c1"># them individually, or ignoring all), set this to ignore.</span>
<span class="c1"># All values available for exception policies can be used, and there is one</span>
<span class="c1"># extra option: auto - which means drop-flow or drop-packet (as explained above)</span>
<span class="c1"># in IPS mode, and ignore in IDS mode. Exception policy values are: drop-packet,</span>
<span class="c1"># drop-flow, reject, bypass, pass-packet, pass-flow, ignore (disable).</span>
<span class="n">exception</span><span class="o">-</span><span class="n">policy</span><span class="p">:</span> <span class="n">auto</span>
</pre></div>
</div>
<p>This value will be overwritten by specific exception policies whose settings are
also defined in the yaml file.</p>
<div class="section" id="auto">
<h6>Auto<a class="headerlink" href="#auto" title="Permalink to this headline">¶</a></h6>
<p><strong>In IPS mode</strong>, the default behavior for most of the exception policies is to
fail close. This means droping the flow, or the packet, when the flow action is
not supported. The default policy for the midstream exception will be ignore if
midstream flows are accepted.</p>
<p>It is possible to disable this default, by setting the exception policies'
&quot;master switch&quot; yaml config option to <code class="docutils literal notranslate"><span class="pre">ignore</span></code>.</p>
<p><strong>In IDS mode</strong>, setting <code class="docutils literal notranslate"><span class="pre">auto</span></code> mode actually means disabling the
<code class="docutils literal notranslate"><span class="pre">master-switch</span></code>, or ignoring the exception policies.</p>
</div>
</div>
<div class="section" id="specific-settings">
<h5>Specific settings<a class="headerlink" href="#specific-settings" title="Permalink to this headline">¶</a></h5>
<p>Exception policies are implemented for:</p>
<table border="1" class="colwidths-given docutils" id="id4">
<caption><span class="caption-text">Exception Policy configuration variables</span><a class="headerlink" href="#id4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="18%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Config setting</th>
<th class="head">Policy variable</th>
<th class="head">Expected behavior</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>stream.memcap</td>
<td>memcap-policy</td>
<td>If a stream memcap limit is reached, apply the memcap policy to the packet and/or
flow.</td>
</tr>
<tr class="row-odd"><td>stream.midstream</td>
<td>midstream-policy</td>
<td>If a session is picked up midstream, apply the midstream policy to the flow.</td>
</tr>
<tr class="row-even"><td>stream.reassembly.memcap</td>
<td>memcap-policy</td>
<td>If stream reassembly reaches memcap limit, apply memcap policy to the
packet and/or flow.</td>
</tr>
<tr class="row-odd"><td>flow.memcap</td>
<td>memcap-policy</td>
<td>Apply policy when the memcap limit for flows is reached and no flow could
be freed up. <strong>Policy can only be applied to the packet.</strong></td>
</tr>
<tr class="row-even"><td>defrag.memcap</td>
<td>memcap-policy</td>
<td>Apply policy when the memcap limit for defrag is reached and no tracker
could be picked up. <strong>Policy can only be applied to the packet.</strong></td>
</tr>
<tr class="row-odd"><td>app-layer</td>
<td>error-policy</td>
<td>Apply policy if a parser reaches an error state. Policy can be applied to packet and/or flow.</td>
</tr>
</tbody>
</table>
<p>To change any of these, go to the specific section in the suricata.yaml file
(for more configuration details, check the <a class="reference internal" href="index.html#document-configuration/suricata-yaml"><span class="doc">suricata.yaml's</span></a>
documentation).</p>
<p>The possible values for the exception policies, and the resulting behaviors,
are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">drop-flow</span></code>: disable inspection for the whole flow (packets, payload,
application layer protocol), drop the packet and all future packets in the
flow.</li>
<li><code class="docutils literal notranslate"><span class="pre">drop-packet</span></code>: drop the packet.</li>
<li><code class="docutils literal notranslate"><span class="pre">reject</span></code>: same as <code class="docutils literal notranslate"><span class="pre">drop-flow</span></code>, but reject the current packet as well (see
<code class="docutils literal notranslate"><span class="pre">reject</span></code> action in Rule's <a class="reference internal" href="index.html#actions"><span class="std std-ref">Action</span></a>).</li>
<li><code class="docutils literal notranslate"><span class="pre">bypass</span></code>: bypass the flow. No further inspection is done. <a class="reference internal" href="index.html#bypass"><span class="std std-ref">Bypass</span></a> may be offloaded.</li>
<li><code class="docutils literal notranslate"><span class="pre">pass-flow</span></code>: disable payload and packet detection; stream reassembly,
app-layer parsing and logging still happen.</li>
<li><code class="docutils literal notranslate"><span class="pre">pass-packet</span></code>: disable detection, still does stream updates and app-layer
parsing (depending on which policy triggered it).</li>
<li><code class="docutils literal notranslate"><span class="pre">ignore</span></code>: do not apply exception policies (default behavior).</li>
</ul>
<p>The <em>drop</em>, <em>pass</em> and <em>reject</em> are similar to the rule actions described in <a class="reference internal" href="index.html#suricata-yaml-action-order"><span class="std std-ref">rule
actions</span></a>.</p>
</div>
</div>
<div class="section" id="exception-policies-and-midstream-pick-up-sessions">
<h4>Exception Policies and Midstream Pick-up Sessions<a class="headerlink" href="#exception-policies-and-midstream-pick-up-sessions" title="Permalink to this headline">¶</a></h4>
<p>Suricata behavior can be difficult to track in case of midstream session
pick-ups. Consider this matrix illustrating the different interactions for
midstream pick-ups enabled or not and the various exception policy values:</p>
<table border="1" class="colwidths-auto docutils" id="id5">
<caption><span class="caption-text"><strong>Exception Policy Behaviors - IDS Mode</strong></span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Exception Policy</th>
<th class="head">Midstream pick-up sessions ENABLED (stream.midstream=true)</th>
<th class="head">Midstream pick-up sessions DISABLED (stream.midstream=false)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Ignore</th>
<td>Session tracket and parsed.</td>
<td>Session not tracked. No app-layer inspection or logging. No detection. No stream reassembly.</td>
</tr>
<tr class="row-odd"><th class="stub">Drop-flow</th>
<td>Not valid.*</td>
<td>Not valid.*</td>
</tr>
<tr class="row-even"><th class="stub">Drop-packet</th>
<td>Not valid.*</td>
<td>Not valid.*</td>
</tr>
<tr class="row-odd"><th class="stub">Reject</th>
<td>Not valid.*</td>
<td>Session not tracked, flow REJECTED.</td>
</tr>
<tr class="row-even"><th class="stub">Pass-flow</th>
<td>Track session, inspect and log app-layer traffic, no detection.</td>
<td>Session not tracked. No app-layer inspection or logging. No detection. No stream reassembly.</td>
</tr>
<tr class="row-odd"><th class="stub">Pass-packet</th>
<td>Not valid.*</td>
<td>Not valid.*</td>
</tr>
<tr class="row-even"><th class="stub">Bypass</th>
<td>Not valid.*</td>
<td>Session not tracked. No app-layer inspection or logging. No detection. No stream reassembly.</td>
</tr>
<tr class="row-odd"><th class="stub">Auto</th>
<td>Midstream policy applied: &quot;ignore&quot;. Same behavior.</td>
<td>Midstream policy applied: &quot;ignore&quot;. Same behavior.</td>
</tr>
</tbody>
</table>
<p>The main difference between IDS and IPS scenarios is that in IPS mode flows can
be allowed or blocked (as in with the PASS and DROP rule actions). Packet
actions are not valid, as midstream pick-up is a configuration that affects the
whole flow.</p>
<table border="1" class="colwidths-given docutils" id="id6">
<caption><span class="caption-text"><strong>Exception Policy Behaviors - IPS Mode</strong></span><a class="headerlink" href="#id6" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="15%" />
<col width="42%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Exception Policy</th>
<th class="head">Midstream pick-up sessions ENABLED (stream.midstream=true)</th>
<th class="head">Midstream pick-up sessions DISABLED (stream.midstream=false)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Ignore</th>
<td>Session tracket and parsed.</td>
<td>Session not tracked. No app-layer inspection or logging. No detection. No stream reassembly.</td>
</tr>
<tr class="row-odd"><th class="stub">Drop-flow</th>
<td>Not valid.*</td>
<td>Session not tracked. No app-layer inspection or logging. No detection. No stream reassembly.
Flow DROPPED.</td>
</tr>
<tr class="row-even"><th class="stub">Drop-packet</th>
<td>Not valid.*</td>
<td>Not valid.*</td>
</tr>
<tr class="row-odd"><th class="stub">Reject</th>
<td>Not valid.*</td>
<td>Session not tracked, flow DROPPED and REJECTED.</td>
</tr>
<tr class="row-even"><th class="stub">Pass-flow</th>
<td>Track session, inspect and log app-layer traffic, no detection.</td>
<td>Session not tracked. No app-layer inspection or logging. No detection. No stream reassembly.</td>
</tr>
<tr class="row-odd"><th class="stub">Pass-packet</th>
<td>Not valid.*</td>
<td>Not valid.*</td>
</tr>
<tr class="row-even"><th class="stub">Bypass</th>
<td>Not valid.*</td>
<td>Session not tracked. No app-layer inspection or logging. No detection. No stream reassembly.
Packets ALLOWED.</td>
</tr>
<tr class="row-odd"><th class="stub">Auto</th>
<td>Midstream policy applied: &quot;ignore&quot;. Same behavior.</td>
<td>Midstream policy applied: &quot;drop-flow&quot;. Same behavior.</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<blockquote>
<div><ul class="simple">
<li>Not valid means that Suricata will error out and won't start.</li>
<li><code class="docutils literal notranslate"><span class="pre">REJECT</span></code> will make Suricata send a Reset-packet unreach error to the sender of the matching packet.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="command-line-options-for-simulating-exceptions">
<h4>Command-line Options for Simulating Exceptions<a class="headerlink" href="#command-line-options-for-simulating-exceptions" title="Permalink to this headline">¶</a></h4>
<p>It is also possible to force specific exception scenarios, to check engine
behavior under failure or error conditions.</p>
<p>The available command-line options are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">simulate-applayer-error-at-offset-ts</span></code>: force an applayer error in the to
server direction at the given offset.</li>
<li><code class="docutils literal notranslate"><span class="pre">simulate-applayer-error-at-offset-tc</span></code>: force an applayer error in the to
client direction at the given offset.</li>
<li><code class="docutils literal notranslate"><span class="pre">simulate-packet-loss</span></code>: simulate that the packet with the given number
(<code class="docutils literal notranslate"><span class="pre">pcap_cnt</span></code>) from the session was lost.</li>
<li><code class="docutils literal notranslate"><span class="pre">simulate-packet-tcp-reassembly-memcap</span></code>: simulate that the TCP stream
reassembly reached memcap for the specified packet.</li>
<li><code class="docutils literal notranslate"><span class="pre">simulate-packet-tcp-ssn-memcap</span></code>: simulate that the TCP session hit the
memcap for the specified packet.</li>
<li><code class="docutils literal notranslate"><span class="pre">simulate-packet-flow-memcap</span></code>: force the engine to assume that flow memcap is
hit at the given packet.</li>
<li><code class="docutils literal notranslate"><span class="pre">simulate-packet-defrag-memcap</span></code>: force Suricata to assume memcap is hit when
defragmenting specified packet.</li>
<li><code class="docutils literal notranslate"><span class="pre">simulate-alert-queue-realloc-failure</span></code>: prevent the engine from dynamically
growing the temporary alert queue, during alerts processing.</li>
</ul>
</div>
<div class="section" id="common-abbreviations">
<h4>Common abbreviations<a class="headerlink" href="#common-abbreviations" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>applayer: application layer protocol</li>
<li>memcap: (maximum) memory capacity available</li>
<li>defrag: defragmentation</li>
</ul>
</div>
</div>
<span id="document-configuration/snort-to-suricata"></span><div class="section" id="snort-conf-to-suricata-yaml">
<h3>Snort.conf to Suricata.yaml<a class="headerlink" href="#snort-conf-to-suricata-yaml" title="Permalink to this headline">¶</a></h3>
<p>This guide is meant for those who are familiar with Snort and the
snort.conf configuration format. This guide will provide a 1:1 mapping
between Snort and Suricata configuration wherever possible.</p>
<div class="section" id="variables">
<h4>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h4>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ipvar HOME_NET any
ipvar EXTERNAL_NET any
...

portvar HTTP_PORTS [80,81,311,591,593,901,1220,1414,1741,1830,2301,2381,2809,3128,3702,4343,4848,5250,7001,7145,7510,7777,7779,8000,8008,8014,8028,8080,8088,8090,8118,8123,8180,8181,8243,8280,8800,8888,8899,9000,9080,9090,9091,9443,9999,11371,55555]
portvar SHELLCODE_PORTS !80
...
</pre></div>
</div>
<p>suricata.yaml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="p">:</span>
  <span class="n">address</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>

    <span class="n">HOME_NET</span><span class="p">:</span> <span class="s2">&quot;[192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]&quot;</span>
    <span class="n">EXTERNAL_NET</span><span class="p">:</span> <span class="s2">&quot;!$HOME_NET&quot;</span>

  <span class="n">port</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>
    <span class="n">HTTP_PORTS</span><span class="p">:</span> <span class="s2">&quot;80&quot;</span>
    <span class="n">SHELLCODE_PORTS</span><span class="p">:</span> <span class="s2">&quot;!80&quot;</span>
</pre></div>
</div>
<p>Note that Suricata can automatically detect HTTP traffic regardless of
the port it uses. So the HTTP_PORTS variable is not nearly as
important as it is with Snort, <strong>if</strong> you use a Suricata enabled
ruleset.</p>
</div>
<div class="section" id="decoder-alerts">
<h4>Decoder alerts<a class="headerlink" href="#decoder-alerts" title="Permalink to this headline">¶</a></h4>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stop generic decode events:</span>
<span class="n">config</span> <span class="n">disable_decode_alerts</span>

<span class="c1"># Stop Alerts on experimental TCP options</span>
<span class="n">config</span> <span class="n">disable_tcpopt_experimental_alerts</span>

<span class="c1"># Stop Alerts on obsolete TCP options</span>
<span class="n">config</span> <span class="n">disable_tcpopt_obsolete_alerts</span>

<span class="c1"># Stop Alerts on T/TCP alerts</span>
<span class="n">config</span> <span class="n">disable_tcpopt_ttcp_alerts</span>

<span class="c1"># Stop Alerts on all other TCPOption type events:</span>
<span class="n">config</span> <span class="n">disable_tcpopt_alerts</span>

<span class="c1"># Stop Alerts on invalid ip options</span>
<span class="n">config</span> <span class="n">disable_ipopt_alerts</span>
</pre></div>
</div>
<p>suricata.yaml</p>
<p>Suricata has no specific decoder options. All decoder related alerts
are controlled by rules. See #Rules below.</p>
</div>
<div class="section" id="checksum-handling">
<h4>Checksum handling<a class="headerlink" href="#checksum-handling" title="Permalink to this headline">¶</a></h4>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="n">checksum_mode</span><span class="p">:</span> <span class="nb">all</span>
</pre></div>
</div>
<p>suricata.yaml</p>
<p>Suricata's checksum handling works <em>on-demand</em>. The stream engine
checks TCP and IP checksum by default:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="p">:</span>
  <span class="n">checksum</span><span class="o">-</span><span class="n">validation</span><span class="p">:</span> <span class="n">yes</span>      <span class="c1"># reject wrong csums</span>
</pre></div>
</div>
<p>Alerting on bad checksums can be done with normal rules. See #Rules,
decoder-events.rules specifically.</p>
</div>
<div class="section" id="various-configs">
<h4>Various configs<a class="headerlink" href="#various-configs" title="Permalink to this headline">¶</a></h4>
<div class="section" id="active-response">
<h5>Active response<a class="headerlink" href="#active-response" title="Permalink to this headline">¶</a></h5>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure active response for non inline operation. For more information, see REAMDE.active</span>
<span class="c1"># config response: eth0 attempts 2</span>
</pre></div>
</div>
<p>suricata.yaml</p>
<p>Active responses are handled automatically w/o config if rules with
the &quot;reject&quot; action are used.</p>
</div>
<div class="section" id="dropping-privileges">
<h5>Dropping privileges<a class="headerlink" href="#dropping-privileges" title="Permalink to this headline">¶</a></h5>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure specific UID and GID to run snort as after dropping privs. For more information see snort -h command line options</span>
<span class="c1">#</span>
<span class="c1"># config set_gid:</span>
<span class="c1"># config set_uid:</span>
</pre></div>
</div>
<p>Suricata</p>
<p>To set the user and group use the --user &lt;username&gt; and --group
&lt;groupname&gt; command-line options.</p>
</div>
<div class="section" id="snaplen">
<h5>Snaplen<a class="headerlink" href="#snaplen" title="Permalink to this headline">¶</a></h5>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure default snaplen. Snort defaults to MTU of in use interface. For more information see README</span>
<span class="c1">#</span>
<span class="c1"># config snaplen:</span>
<span class="c1">#</span>
</pre></div>
</div>
<p>Suricata always works at full snap length to provide full traffic visibility.</p>
</div>
<div class="section" id="bpf">
<h5>Bpf<a class="headerlink" href="#bpf" title="Permalink to this headline">¶</a></h5>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure default bpf_file to use for filtering what traffic reaches snort. For more information see snort -h command line options (-F)</span>
<span class="c1">#</span>
<span class="c1"># config bpf_file:</span>
<span class="c1">#</span>
</pre></div>
</div>
<p>suricata.yaml</p>
<p>BPF filters can be set per packet acquisition method, with the &quot;bpf-filter: &lt;file&gt;&quot; yaml option and in a file using the -F command line option.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth0</span>
    <span class="c1">#buffer-size: 16777216</span>
    <span class="c1">#bpf-filter: &quot;tcp and port 25&quot;</span>
    <span class="c1">#checksum-checks: auto</span>
    <span class="c1">#threads: 16</span>
    <span class="c1">#promisc: no</span>
    <span class="c1">#snaplen: 1518</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="log-directory">
<h4>Log directory<a class="headerlink" href="#log-directory" title="Permalink to this headline">¶</a></h4>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure default log directory for snort to log to.  For more information see snort -h command line options (-l)</span>
<span class="c1">#</span>
<span class="c1"># config logdir:</span>
</pre></div>
</div>
<p>suricata.yaml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="nb">dir</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span>
</pre></div>
</div>
<p>This value is overridden by the -l command-line option.</p>
</div>
<div class="section" id="packet-acquisition">
<h4>Packet acquisition<a class="headerlink" href="#packet-acquisition" title="Permalink to this headline">¶</a></h4>
<p>snort.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure DAQ related options for inline operation. For more information, see README.daq</span>
<span class="c1">#</span>
<span class="c1"># config daq: &lt;type&gt;</span>
<span class="c1"># config daq_dir: &lt;dir&gt;</span>
<span class="c1"># config daq_mode: &lt;mode&gt;</span>
<span class="c1"># config daq_var: &lt;var&gt;</span>
<span class="c1">#</span>
<span class="c1"># &lt;type&gt; ::= pcap | afpacket | dump | nfq | ipq | ipfw</span>
<span class="c1"># &lt;mode&gt; ::= read-file | passive | inline</span>
<span class="c1"># &lt;var&gt; ::= arbitrary &lt;name&gt;=&lt;value passed to DAQ</span>
<span class="c1"># &lt;dir&gt; ::= path as to where to look for DAQ module so&#39;s</span>
</pre></div>
</div>
<p>suricata.yaml</p>
<p>Suricata has all packet acquisition support built-in. It's
configuration format is very verbose.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth0</span>
    <span class="c1">#buffer-size: 16777216</span>
    <span class="c1">#bpf-filter: &quot;tcp and port 25&quot;</span>
    <span class="c1">#checksum-checks: auto</span>
    <span class="c1">#threads: 16</span>
    <span class="c1">#promisc: no</span>
    <span class="c1">#snaplen: 1518</span>
<span class="n">pfring</span><span class="p">:</span>
<span class="n">afpacket</span><span class="p">:</span>
<span class="n">nfq</span><span class="p">:</span>
<span class="n">ipfw</span><span class="p">:</span>
</pre></div>
</div>
<p>Passive vs inline vs reading files is determined by how Suricata is
invoked on the command line.</p>
</div>
<div class="section" id="rules">
<h4>Rules<a class="headerlink" href="#rules" title="Permalink to this headline">¶</a></h4>
<p>snort.conf:</p>
<p>In snort.conf a RULE_PATH variable is set, as well as variables for
shared object (SO) rules and preprocessor rules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>var RULE_PATH ../rules
var SO_RULE_PATH ../so_rules
var PREPROC_RULE_PATH ../preproc_rules

include $RULE_PATH/local.rules
include $RULE_PATH/emerging-activex.rules
...
</pre></div>
</div>
<p>suricata.yaml:</p>
<p>In the suricata.yaml the default rule path is set followed by a list
of rule files. Suricata does not have a concept of shared object rules
or preprocessor rules. Instead of preprocessor rules, Suricata has
several rule files for events set by the decoders, stream engine, http
parser etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">rules</span>
<span class="n">rule</span><span class="o">-</span><span class="n">files</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">local</span><span class="o">.</span><span class="n">rules</span>
 <span class="o">-</span> <span class="n">emerging</span><span class="o">-</span><span class="n">activex</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
<p>The equivalent of preprocessor rules are loaded like normal rule files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span><span class="o">-</span><span class="n">files</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">decoder</span><span class="o">-</span><span class="n">events</span><span class="o">.</span><span class="n">rules</span>
 <span class="o">-</span> <span class="n">stream</span><span class="o">-</span><span class="n">events</span><span class="o">.</span><span class="n">rules</span>
 <span class="o">-</span> <span class="n">http</span><span class="o">-</span><span class="n">events</span><span class="o">.</span><span class="n">rules</span>
 <span class="o">-</span> <span class="n">smtp</span><span class="o">-</span><span class="n">events</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
</div>
</div>
<span id="document-configuration/multi-tenant"></span><div class="section" id="multi-tenancy">
<h3>Multi Tenancy<a class="headerlink" href="#multi-tenancy" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>Multi tenancy support allows different tenants to use different
rule sets with different rule variables.</p>
<p>Tenants are identified by their <cite>selector</cite>; a <cite>selector</cite> can be
a VLAN, interface/device, or from a pcap file (&quot;direct&quot;).</p>
</div>
<div class="section" id="yaml">
<h4>YAML<a class="headerlink" href="#yaml" title="Permalink to this headline">¶</a></h4>
<p>Add a new section in the main (&quot;master&quot;) Suricata configuration file -- <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> -- named <code class="docutils literal notranslate"><span class="pre">multi-detect</span></code>.</p>
<p>Settings:</p>
<ul class="simple">
<li><cite>enabled</cite>: yes/no -&gt; is multi-tenancy support enabled</li>
<li><cite>selector</cite>: direct (for unix socket pcap processing, see below), VLAN or device</li>
<li><cite>loaders</cite>: number of <cite>loader</cite> threads, for parallel tenant loading at startup</li>
<li><cite>tenants</cite>: list of tenants</li>
<li><cite>config-path</cite>: path from where the tenant yamls are loaded<ul>
<li>id: tenant id (numeric values only)</li>
<li>yaml: separate yaml file with the tenant specific settings</li>
</ul>
</li>
<li><cite>mappings</cite>:<ul>
<li>VLAN id or device: The outermost VLAN is used to match.</li>
<li>tenant id: tenant to associate with the VLAN id or device</li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">multi</span><span class="o">-</span><span class="n">detect</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1">#selector: direct # direct or vlan</span>
  <span class="n">selector</span><span class="p">:</span> <span class="n">vlan</span>
  <span class="n">loaders</span><span class="p">:</span> <span class="mi">3</span>

  <span class="n">tenants</span><span class="p">:</span>
  <span class="o">-</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">yaml</span><span class="p">:</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">1.</span><span class="n">yaml</span>
  <span class="o">-</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">yaml</span><span class="p">:</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">2.</span><span class="n">yaml</span>
  <span class="o">-</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">yaml</span><span class="p">:</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">3.</span><span class="n">yaml</span>

  <span class="n">mappings</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">vlan</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1000</span>
    <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span>
  <span class="o">-</span> <span class="n">vlan</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2000</span>
    <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2</span>
  <span class="o">-</span> <span class="n">vlan</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1112</span>
    <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span>
</pre></div>
</div>
<p>The tenant-1.yaml, tenant-2.yaml, tenant-3.yaml each contain a partial
configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the default rule path here to search for the files.</span>
<span class="c1"># if not set, it will look at the current working dir</span>
<span class="n">default</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">rules</span>
<span class="n">rule</span><span class="o">-</span><span class="n">files</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">rules1</span>

<span class="c1"># You can specify a threshold config file by setting &quot;threshold-file&quot;</span>
<span class="c1"># to the path of the threshold config file:</span>
<span class="c1"># threshold-file: /etc/suricata/threshold.config</span>

<span class="n">classification</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">classification</span><span class="o">.</span><span class="n">config</span>
<span class="n">reference</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">reference</span><span class="o">.</span><span class="n">config</span>

<span class="c1"># Holds variables that would be used by the engine.</span>
<span class="nb">vars</span><span class="p">:</span>

  <span class="c1"># Holds the address group vars that would be passed in a Signature.</span>
  <span class="c1"># These would be retrieved during the Signature address parsing stage.</span>
  <span class="n">address</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>

    <span class="n">HOME_NET</span><span class="p">:</span> <span class="s2">&quot;[192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]&quot;</span>

    <span class="n">EXTERNAL_NET</span><span class="p">:</span> <span class="s2">&quot;!$HOME_NET&quot;</span>

    <span class="o">...</span>

  <span class="n">port</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>

    <span class="n">HTTP_PORTS</span><span class="p">:</span> <span class="s2">&quot;80&quot;</span>

    <span class="n">SHELLCODE_PORTS</span><span class="p">:</span> <span class="s2">&quot;!80&quot;</span>

    <span class="o">...</span>
</pre></div>
</div>
<div class="section" id="vlan-id">
<h5>vlan-id<a class="headerlink" href="#vlan-id" title="Permalink to this headline">¶</a></h5>
<p>Assign tenants to VLAN ids. Suricata matches the outermost VLAN id with this value.
Multiple VLANs can have the same tenant id. VLAN id values must be between 1 and 4094.</p>
<p>Example of VLAN mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mappings</span><span class="p">:</span>
<span class="o">-</span> <span class="n">vlan</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1000</span>
  <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">-</span> <span class="n">vlan</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2000</span>
  <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2</span>
<span class="o">-</span> <span class="n">vlan</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1112</span>
  <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span>
</pre></div>
</div>
<p>The mappings can also be modified over the unix socket, see below.</p>
<p>Note: can only be used if <code class="docutils literal notranslate"><span class="pre">vlan.use-for-tracking</span></code> is enabled.</p>
</div>
<div class="section" id="device">
<h5>device<a class="headerlink" href="#device" title="Permalink to this headline">¶</a></h5>
<p>Assign tenants to devices. A single tenant can be assigned to a device.
Multiple devices can have the same tenant id.</p>
<p>Example of device mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mappings</span><span class="p">:</span>
<span class="o">-</span> <span class="n">device</span><span class="p">:</span> <span class="n">ens5f0</span>
  <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">-</span> <span class="n">device</span><span class="p">:</span> <span class="n">ens5f1</span>
  <span class="n">tenant</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span>
</pre></div>
</div>
<p>The mappings are static and cannot be modified over the unix socket.</p>
<p>Note: Not currently supported for IPS.</p>
<p>Note: support depends on a capture method using the 'livedev' API. Currently
these are: pcap, AF_PACKET, PF_RING and Netmap.</p>
</div>
</div>
<div class="section" id="per-tenant-settings">
<h4>Per tenant settings<a class="headerlink" href="#per-tenant-settings" title="Permalink to this headline">¶</a></h4>
<p>The following settings are per tenant:</p>
<ul class="simple">
<li>default-rule-path</li>
<li>rule-files</li>
<li>classification-file</li>
<li>reference-config-file</li>
<li>threshold-file</li>
<li>address-vars</li>
<li>port-vars</li>
</ul>
</div>
<div class="section" id="unix-socket">
<h4>Unix Socket<a class="headerlink" href="#unix-socket" title="Permalink to this headline">¶</a></h4>
<div class="section" id="registration">
<h5>Registration<a class="headerlink" href="#registration" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">register-tenant</span> <span class="pre">&lt;id&gt;</span> <span class="pre">&lt;yaml&gt;</span></code></p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">register</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">1</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">1.</span><span class="n">yaml</span>
<span class="n">register</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">2</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">2.</span><span class="n">yaml</span>
<span class="n">register</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">3</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">3.</span><span class="n">yaml</span>
<span class="n">register</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">5</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">5.</span><span class="n">yaml</span>
<span class="n">register</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">7</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">7.</span><span class="n">yaml</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">unregister-tenant</span> <span class="pre">&lt;id&gt;</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unregister</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">2</span>
<span class="n">unregister</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="unix-socket-runmode-pcap-processing">
<h5>Unix socket runmode (pcap processing)<a class="headerlink" href="#unix-socket-runmode-pcap-processing" title="Permalink to this headline">¶</a></h5>
<p>The Unix Socket <code class="docutils literal notranslate"><span class="pre">pcap-file</span></code>  command is used to associate the tenant with
the pcap:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="n">traffic1</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">logs1</span><span class="o">/</span> <span class="mi">1</span>
<span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="n">traffic2</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">logs2</span><span class="o">/</span> <span class="mi">2</span>
<span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="n">traffic3</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">logs3</span><span class="o">/</span> <span class="mi">3</span>
<span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="n">traffic4</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">logs5</span><span class="o">/</span> <span class="mi">5</span>
<span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="n">traffic5</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">logs7</span><span class="o">/</span> <span class="mi">7</span>
</pre></div>
</div>
<p>This runs the traffic1.pcap against tenant 1 and it logs into /logs1/,
traffic2.pcap against tenant 2 and logs to /logs2/ and so on.</p>
</div>
<div class="section" id="live-traffic-mode">
<h5>Live traffic mode<a class="headerlink" href="#live-traffic-mode" title="Permalink to this headline">¶</a></h5>
<p>Multi-tenancy supports both VLAN and devices with live traffic.</p>
<p>In the master configuration yaml file, specify <code class="docutils literal notranslate"><span class="pre">device</span></code> or <code class="docutils literal notranslate"><span class="pre">vlan</span></code> for the <code class="docutils literal notranslate"><span class="pre">selector</span></code> setting.</p>
</div>
<div class="section" id="id1">
<h5>Registration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<p>Tenants can be mapped to vlan ids.</p>
<p><code class="docutils literal notranslate"><span class="pre">register-tenant-handler</span> <span class="pre">&lt;tenant</span> <span class="pre">id&gt;</span> <span class="pre">vlan</span> <span class="pre">&lt;vlan</span> <span class="pre">id&gt;</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">register</span><span class="o">-</span><span class="n">tenant</span><span class="o">-</span><span class="n">handler</span> <span class="mi">1</span> <span class="n">vlan</span> <span class="mi">1000</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">unregister-tenant-handler</span> <span class="pre">&lt;tenant</span> <span class="pre">id&gt;</span> <span class="pre">vlan</span> <span class="pre">&lt;vlan</span> <span class="pre">id&gt;</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unregister</span><span class="o">-</span><span class="n">tenant</span><span class="o">-</span><span class="n">handler</span> <span class="mi">4</span> <span class="n">vlan</span> <span class="mi">1111</span>
<span class="n">unregister</span><span class="o">-</span><span class="n">tenant</span><span class="o">-</span><span class="n">handler</span> <span class="mi">1</span> <span class="n">vlan</span> <span class="mi">1000</span>
</pre></div>
</div>
<p>The registration of tenant and tenant handlers can be done on a
running engine.</p>
</div>
<div class="section" id="reloads">
<h5>Reloads<a class="headerlink" href="#reloads" title="Permalink to this headline">¶</a></h5>
<p>Reloading all tenants:</p>
<p><code class="docutils literal notranslate"><span class="pre">reload-tenants</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reload</span><span class="o">-</span><span class="n">tenants</span>
</pre></div>
</div>
<p>Reloading a single tenant:</p>
<p><code class="docutils literal notranslate"><span class="pre">reload-tenant</span> <span class="pre">&lt;tenant</span> <span class="pre">id&gt;</span> <span class="pre">[yaml</span> <span class="pre">path]</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reload</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">1</span> <span class="n">tenant</span><span class="o">-</span><span class="mf">1.</span><span class="n">yaml</span>
<span class="n">reload</span><span class="o">-</span><span class="n">tenant</span> <span class="mi">5</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">[yaml</span> <span class="pre">path]</span></code> is optional. If it isn't provided, the original path of
the tenant will be used during the reload.</p>
</div>
</div>
<div class="section" id="eve-json-output">
<h4>Eve JSON output<a class="headerlink" href="#eve-json-output" title="Permalink to this headline">¶</a></h4>
<p>When multi-tenant support is configured and the detect engine is active then
all EVE-types that report based on flows will also report the corresponding
<code class="docutils literal notranslate"><span class="pre">tenant_id</span></code> for events matching a tenant configuration.</p>
</div>
</div>
<span id="document-configuration/dropping-privileges"></span><div class="section" id="dropping-privileges-after-startup">
<h3>Dropping Privileges After Startup<a class="headerlink" href="#dropping-privileges-after-startup" title="Permalink to this headline">¶</a></h3>
<p>Currently, <code class="docutils literal notranslate"><span class="pre">libcap-ng</span></code> is needed for dropping privileges on Suricata
after startup. For libcap, see status of feature request number #276
-- Libcap support for dropping privileges.</p>
<p>Most distributions have <code class="docutils literal notranslate"><span class="pre">libcap-ng</span></code> in their repositories.</p>
<p>To download the current version of libcap-ng from upstream, see also
<a class="reference external" href="http://people.redhat.com/sgrubb/libcap-ng/ChangeLog">http://people.redhat.com/sgrubb/libcap-ng/ChangeLog</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">people</span><span class="o">.</span><span class="n">redhat</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sgrubb</span><span class="o">/</span><span class="n">libcap</span><span class="o">-</span><span class="n">ng</span><span class="o">/</span><span class="n">libcap</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="mf">0.7.8</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">xzvf</span> <span class="n">libcap</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="mf">0.7.8</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">libcap</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="mf">0.7.8</span>
<span class="o">./</span><span class="n">configure</span>
<span class="n">make</span>
<span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
<p>Download, configure, compile and install Suricata for your particular setup.
See <a class="reference internal" href="index.html#document-install"><span class="doc">Installation</span></a>. Depending on your environment, you may need to add the
--with-libpcap_ng-libraries and --with-libpcap_ng-includes options
during the configure step. e.g:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">libcap_ng</span><span class="o">-</span><span class="n">libraries</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span> \
  <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">libcap_ng</span><span class="o">-</span><span class="n">includes</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">include</span>
</pre></div>
</div>
<p>Now, when you run Suricata, tell it what user and/or group you want it
to run as after startup with the --user and --group options.
e.g. (this assumes a 'suri' user and group):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">D</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">suri</span> <span class="o">--</span><span class="n">group</span><span class="o">=</span><span class="n">suri</span>
</pre></div>
</div>
<p>You will also want to make sure your user/group permissions are set so
Suricata can still write to its log files which are usually located in
/var/log/suricata.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">root</span><span class="p">:</span><span class="n">suri</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span>
<span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="mi">775</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span>
</pre></div>
</div>
</div>
<span id="document-configuration/landlock"></span><div class="section" id="using-landlock-lsm">
<span id="landlock"></span><h3>Using Landlock LSM<a class="headerlink" href="#using-landlock-lsm" title="Permalink to this headline">¶</a></h3>
<p>Landlock is a Linux Security Module that has been introduced in Linux 5.13.
It allows an application to sandbox itself by selecting access right to
directories using a deny by default approach.</p>
<p>Given its nature, Suricata knows where it is going to read files and where
it is going to write them. So it is possible to implement an efficient
Landlock sandboxing policy.</p>
<p>Landlock is not active by default and needs to be activated in the
YAML configuration. Configuration should come with sane default (defined
at build time) and the command line options are used to dynamically add
some permissions.</p>
<p>Please note that Landlock is in blocking mode by default so careful testing
is needed in production.</p>
<p>To enable Landlock, edit the YAML and set <code class="docutils literal notranslate"><span class="pre">enabled</span></code> to <code class="docutils literal notranslate"><span class="pre">yes</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">landlock</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">directories</span><span class="p">:</span>
    <span class="n">write</span><span class="p">:</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span>
    <span class="n">read</span><span class="p">:</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span>
</pre></div>
</div>
<p>Following your running configuration you may have to add some directories.
There are two lists you can use, <code class="docutils literal notranslate"><span class="pre">write</span></code> to add directories where write is needed
and <code class="docutils literal notranslate"><span class="pre">read</span></code> for directories where read access is needed.</p>
<p>Landlock is not active in some distributions and you may need to activate it
at boot by adding <code class="docutils literal notranslate"><span class="pre">lsm=landock</span></code> to the Linux command line. For example,
on a Debian distribution with at least a linux 5.13, you can edit <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code>
and update the <code class="docutils literal notranslate"><span class="pre">GRUB_CMDLINE_LINUX_DEFAULT</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;quiet lsm=landlock&quot;</span>
</pre></div>
</div>
<p>Then run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">update-grub</span></code> and reboot.</p>
<p>You can check at boot if it is running by doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dmesg</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">landlock</span> <span class="o">||</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">kg</span> <span class="n">landlock</span>
</pre></div>
</div>
<p>If you are interested in reading more about Landlock, you can use <a class="reference external" href="https://docs.kernel.org/userspace-api/landlock.html">https://docs.kernel.org/userspace-api/landlock.html</a>
as entry point.</p>
</div>
<span id="document-configuration/systemd-notify"></span><div class="section" id="systemd-notification">
<h3>systemd notification<a class="headerlink" href="#systemd-notification" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>Suricata supports systemd notification with the aim of notifying the service manager of successful
initialisation. The purpose is to enable the ability to start upon/await successful start-up for
services/test frameworks that depend on a fully initialised Suricata .</p>
<p>During the initialisation phase Suricata synchronises the initialisation thread with all active
threads to ensure they are in a running state. Once synchronisation has been completed a <code class="docutils literal notranslate"><span class="pre">READY=1</span></code>
status notification is sent to the service manager using <code class="docutils literal notranslate"><span class="pre">sd_notify()</span></code>.</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>A test framework requires Suricata to be capturing before the tests can be carried out.
Writing a <code class="docutils literal notranslate"><span class="pre">test.service</span></code> and ensuring the correct execution order with <code class="docutils literal notranslate"><span class="pre">After=suricata.service</span></code>
forces the unit to be started after <code class="docutils literal notranslate"><span class="pre">suricata.service</span></code>. This does not enforce Suricata has fully
initialised. By configuring <code class="docutils literal notranslate"><span class="pre">suricata.service</span></code> as <code class="docutils literal notranslate"><span class="pre">Type=notify</span></code> instructs the service manager
to wait for the notification before starting <code class="docutils literal notranslate"><span class="pre">test.service</span></code>.</p>
</div>
<div class="section" id="requirements">
<h4>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h4>
<p>This feature is only supported for distributions under the following conditions:</p>
<ol class="arabic simple">
<li>Distribution contains <code class="docutils literal notranslate"><span class="pre">libsystemd</span></code></li>
<li>Any distribution that runs under <strong>systemd</strong></li>
<li>Unit file configuration: <code class="docutils literal notranslate"><span class="pre">Type=notify</span></code></li>
<li>Contains development files for systemd shared library</li>
</ol>
<p>To install development files:
Fedora:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">systemd</span><span class="o">-</span><span class="n">devel</span>
</pre></div>
</div>
<p>Ubuntu/Debian:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">systemd</span><span class="o">-</span><span class="n">dev</span>
</pre></div>
</div>
<p>This package shall be compile-time configured and therefore only built with distributions fulfilling
requirements [1, 2]. For notification to the service manager the unit file must be configured as
shown in requirement [3]. Upon all requirements being met the service manager will start and await
<code class="docutils literal notranslate"><span class="pre">READY=1</span></code> status from Suricata. Otherwise the service manager will treat the service unit as
<code class="docutils literal notranslate"><span class="pre">Type=simple</span></code> and consider it started immediately after the main process <code class="docutils literal notranslate"><span class="pre">ExecStart=</span></code> has been
forked.</p>
</div>
<div class="section" id="additional-information">
<h4>Additional Information<a class="headerlink" href="#additional-information" title="Permalink to this headline">¶</a></h4>
<p>To confirm the system is running under systemd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">headers</span> <span class="o">-</span><span class="n">o</span> <span class="n">comm</span> <span class="mi">1</span>
</pre></div>
</div>
<p>See: <a class="reference external" href="https://man7.org/linux/man-pages/man3/sd_notify.3.html">https://man7.org/linux/man-pages/man3/sd_notify.3.html</a> for a detailed description on
<code class="docutils literal notranslate"><span class="pre">sd_notify</span></code>.</p>
<p>See <a class="reference external" href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">https://www.freedesktop.org/software/systemd/man/systemd.service.html</a> for help
writing systemd unit files.</p>
</div>
</div>
<span id="document-configuration/includes"></span><div class="section" id="includes">
<span id="id1"></span><h3>Includes<a class="headerlink" href="#includes" title="Permalink to this headline">¶</a></h3>
<p>A Suricata configuration file (typically
<code class="docutils literal notranslate"><span class="pre">/etc/suricata/suricata.yaml</span></code>) may include other files allowing a
configuration file to be broken into multiple files. The <em>special</em>
field name <code class="docutils literal notranslate"><span class="pre">include</span></code> is used to include one or more files.</p>
<p>The contents of the <em>include</em> file are inlined at the level of the
<code class="docutils literal notranslate"><span class="pre">include</span></code> statement. <em>Include</em> fields may also be included at any
level within a mapping.</p>
<div class="section" id="including-a-single-file">
<h4>Including a Single File<a class="headerlink" href="#including-a-single-file" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="p">:</span> <span class="n">filename</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</div>
<div class="section" id="including-multiple-files">
<h4>Including Multiple Files<a class="headerlink" href="#including-multiple-files" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">filename1</span><span class="o">.</span><span class="n">yaml</span>
  <span class="o">-</span> <span class="n">filename2</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</div>
<div class="section" id="include-inside-a-mapping">
<h4>Include Inside a Mapping<a class="headerlink" href="#include-inside-a-mapping" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="p">:</span>
  <span class="n">address</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>
    <span class="n">include</span><span class="p">:</span> <span class="n">address</span><span class="o">-</span><span class="n">groups</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">address-groups.yaml</span></code> contains:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">YAML</span> <span class="mf">1.1</span>
<span class="o">---</span>
<span class="n">HOME_NET</span><span class="p">:</span> <span class="s2">&quot;[192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]&quot;</span>
</pre></div>
</div>
<p>is the equivalent of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="p">:</span>
  <span class="n">address</span><span class="o">-</span><span class="n">groups</span><span class="p">:</span>
    <span class="n">HOME_NET</span><span class="p">:</span> <span class="s2">&quot;[192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Suricata versions less than 7 required multiple <code class="docutils literal notranslate"><span class="pre">include</span></code>
statements to be specified to include more than one file. While
Suricata 7.0 still supports this it will issue a deprecation
warning. Suricata 8.0 will not allow multiple <code class="docutils literal notranslate"><span class="pre">include</span></code>
statements at the same level as this is not allowed by YAML.</p>
</div>
</div>
</div>
</div>
</div>
<span id="document-reputation/index"></span><div class="section" id="reputation">
<h2>Reputation<a class="headerlink" href="#reputation" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-reputation/ipreputation/ip-reputation"></span><div class="section" id="ip-reputation">
<h3>IP Reputation<a class="headerlink" href="#ip-reputation" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-reputation/ipreputation/ip-reputation-config"></span><div class="section" id="ip-reputation-config">
<h4>IP Reputation Config<a class="headerlink" href="#ip-reputation-config" title="Permalink to this headline">¶</a></h4>
<p>IP reputation has a few configuration directives, all disabled by default.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># IP Reputation</span>
<span class="c1">#reputation-categories-file: /etc/suricata/iprep/categories.txt</span>
<span class="c1">#default-reputation-path: /etc/suricata/iprep</span>
<span class="c1">#reputation-files:</span>
<span class="c1"># - reputation.list</span>
</pre></div>
</div>
<div class="section" id="reputation-categories-file">
<h5>reputation-categories-file<a class="headerlink" href="#reputation-categories-file" title="Permalink to this headline">¶</a></h5>
<p>The categories file mapping numbered category values to short names.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reputation</span><span class="o">-</span><span class="n">categories</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">iprep</span><span class="o">/</span><span class="n">categories</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div>
<div class="section" id="default-reputation-path">
<h5>default-reputation-path<a class="headerlink" href="#default-reputation-path" title="Permalink to this headline">¶</a></h5>
<p>Path where reputation files from the &quot;reputation-files&quot; directive are loaded from by default.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default</span><span class="o">-</span><span class="n">reputation</span><span class="o">-</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">iprep</span>
</pre></div>
</div>
</div>
<div class="section" id="reputation-files">
<h5>reputation-files<a class="headerlink" href="#reputation-files" title="Permalink to this headline">¶</a></h5>
<p>YAML list of file names to load. In case of a absolute path the file is loaded directly, otherwise the path from &quot;default-reputation-path&quot; is pre-pended to form the final path.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reputation</span><span class="o">-</span><span class="n">files</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">badhosts</span><span class="o">.</span><span class="n">list</span>
 <span class="o">-</span> <span class="n">knowngood</span><span class="o">.</span><span class="n">list</span>
 <span class="o">-</span> <span class="n">sharedhosting</span><span class="o">.</span><span class="n">list</span>
</pre></div>
</div>
</div>
<div class="section" id="hosts">
<h5>Hosts<a class="headerlink" href="#hosts" title="Permalink to this headline">¶</a></h5>
<p>IP reputation information is stored in the host table, so the settings of the host table affect it.</p>
<p>Depending on the number of hosts reputation information is available for, the memcap and hash size may have to be increased.</p>
</div>
<div class="section" id="reloads">
<h5>Reloads<a class="headerlink" href="#reloads" title="Permalink to this headline">¶</a></h5>
<p>Sending Suricata a USR2 signal will reload the IP reputation data, along with the normal rules reload.</p>
<p>During the reload the host table will be updated to contain the new data. The iprep information is versioned. When the reload is complete, Suricata will automatically clean up the old iprep information.</p>
<p>Only the reputation files will be reloaded, the categories file won't be. If categories change, Suricata should be restarted.</p>
</div>
<div class="section" id="file-format">
<h5>File format<a class="headerlink" href="#file-format" title="Permalink to this headline">¶</a></h5>
<p>The format of the reputation files is described in the <a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-format"><span class="doc">IP Reputation Format</span></a> page.</p>
</div>
</div>
<span id="document-reputation/ipreputation/ip-reputation-format"></span><div class="section" id="ip-reputation-format">
<h4>IP Reputation Format<a class="headerlink" href="#ip-reputation-format" title="Permalink to this headline">¶</a></h4>
<p>Description of IP Reputation file formats. For the configuration see <a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-config"><span class="doc">IP Reputation Config</span></a> and <a class="reference internal" href="index.html#document-rules/ip-reputation-rules"><span class="doc">IP Reputation Keyword</span></a> for the rule format.</p>
<div class="section" id="categories-file">
<h5>Categories file<a class="headerlink" href="#categories-file" title="Permalink to this headline">¶</a></h5>
<p>The categories file provides a mapping between a category number, short name, and long description. It's a simple CSV file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nb">id</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">short</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">description</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span><span class="n">BadHosts</span><span class="p">,</span><span class="n">Known</span> <span class="n">bad</span> <span class="n">hosts</span>
<span class="mi">2</span><span class="p">,</span><span class="n">Google</span><span class="p">,</span><span class="n">Known</span> <span class="n">google</span> <span class="n">host</span>
</pre></div>
</div>
<p>The maximum value for the category id is hard coded at 60 currently.</p>
</div>
<div class="section" id="reputation-file">
<h5>Reputation file<a class="headerlink" href="#reputation-file" title="Permalink to this headline">¶</a></h5>
<p>The reputation file lists a reputation score for hosts in the categories. It's a simple CSV file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ip</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">category</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">reputation</span> <span class="n">score</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The IP is an IPv4 address in the quad-dotted notation or an IPv6 address. Both IP types support networks in CIDR notation. The category is the number as defined in the categories file. The reputation score is the confidence that this IP is in the specified category, represented by a number between 1 and 127 (0 means no data).</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.2.3.4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span>
<span class="mf">1.1.1.0</span><span class="o">/</span><span class="mi">24</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">88</span>
</pre></div>
</div>
<p>If an IP address has a score in multiple categories it should be listed in the file multiple times.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.1.1.1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span>
<span class="mf">1.1.1.1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span>
</pre></div>
</div>
<p>This lists 1.1.1.1 in categories 1 and 2, each with a score of 10.</p>
</div>
</div>
</div>
<p>The purpose of the IP reputation component is the ranking of IP Addresses within the Suricata Engine.  It will collect, store, update and distribute reputation intelligence on IP Addresses.  The hub and spoke architecture will allows the central database (The Hub) to collect, store and compile updated IP reputation details that are then distributed to user-side sensor databases (Spokes) for inclusion in user security systems.  The reputation data update frequency and security action taken, is defined in the user security configuration.</p>
<p>The intent of IP Reputation is to allow sharing of intelligence regarding a vast number of IP addresses. This can be positive or negative intelligence classified into a number of categories. The technical implementation requires three major efforts; engine integration, the hub that redistributes reputation, and the communication protocol between hubs and sensors.  The hub will have a number of responsibilities. This will be a separate module running on a separate system as any sensor. Most often it would run on a central database that all sensors already have communication with. It will be able to subscribe to one or more external feeds.   The local admin should be able to define the feeds to be subscribed to, provide authentication credentials if required, and give a weight to that feed. The weight can be an overall number or a by category weight. This will allow the admin to minimize the influence a feed has on their overall reputation if they distrust a particular category or feed, or trust another implicitly. Feeds can be configured to accept feedback or not and will report so on connect. The admin can override and choose not to give any feedback, but the sensor should report these to the Hub upstream on connect.  The hub will take all of these feeds and aggregate them into an average single score for each IP or IP Block, and then redistribute this data to all local sensors as configured. It should receive connections from sensors. The sensor will have to provide authentication and will provide feedback. The hub should redistribute that feedback from sensors to all other sensors as well as up to any feeds that accept feedback.  The hub should also have an API to allow outside statistical analysis to be done to the database and fed back into the stream. For instance a local site may choose to change the reputation on all Russian IP blocks, etc.</p>
<p>For more information about IP Reputation see <a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-config"><span class="doc">IP Reputation Config</span></a>, <a class="reference internal" href="index.html#document-rules/ip-reputation-rules"><span class="doc">IP Reputation Keyword</span></a> and <a class="reference internal" href="index.html#document-reputation/ipreputation/ip-reputation-format"><span class="doc">IP Reputation Format</span></a>.</p>
</div>
</div>
</div>
<span id="document-initscripts"></span><div class="section" id="init-scripts">
<h2>Init Scripts<a class="headerlink" href="#init-scripts" title="Permalink to this headline">¶</a></h2>
<p>For Ubuntu with Upstart, the following can be used in <code class="docutils literal notranslate"><span class="pre">/etc/init/suricata.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># suricata
description &quot;Intrusion Detection System Daemon&quot;
start on runlevel [2345]
stop on runlevel [!2345]
expect fork
exec suricata -D --pidfile /var/run/suricata.pid -c /etc/suricata/suricata.yaml -i eth1
</pre></div>
</div>
</div>
<span id="document-setting-up-ipsinline-for-linux"></span><div class="section" id="setting-up-ips-inline-for-linux">
<h2>Setting up IPS/inline for Linux<a class="headerlink" href="#setting-up-ips-inline-for-linux" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setting-up-ips-with-netfilter">
<h3>Setting up IPS with Netfilter<a class="headerlink" href="#setting-up-ips-with-netfilter" title="Permalink to this headline">¶</a></h3>
<p>In this guide, we'll discuss how to work with Suricata in layer3 <cite>inline
mode</cite> using <code class="docutils literal notranslate"><span class="pre">iptables</span></code>.</p>
<p>First, start by compiling Suricata with NFQ support. For instructions
see <a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Ubuntu_Installation">Ubuntu Installation</a>.
For more information about NFQ and <code class="docutils literal notranslate"><span class="pre">iptables</span></code>, see
<a class="reference internal" href="index.html#suricata-yaml-nfq"><span class="std std-ref">NFQ</span></a>.</p>
<p>To check if you have NFQ enabled in your Suricata build, enter the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</div>
<p>and make sure that NFQ is listed in the output.</p>
<p>To run Suricata with the NFQ mode, you have to make use of the <code class="docutils literal notranslate"><span class="pre">-q</span></code> option. This
option tells Suricata which queue numbers it should use.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">q</span> <span class="mi">0</span>
</pre></div>
</div>
<div class="section" id="iptables-configuration">
<h4>Iptables configuration<a class="headerlink" href="#iptables-configuration" title="Permalink to this headline">¶</a></h4>
<p>First of all, it is important to know which traffic you would like to send
to Suricata. There are two choices:</p>
<ol class="arabic simple">
<li>Traffic that passes your computer</li>
<li>Traffic that is generated by your computer.</li>
</ol>
<img alt="_images/IPtables.png" src="_images/IPtables.png" />
<img alt="_images/iptables1.png" src="_images/iptables1.png" />
<p>If Suricata is running on a gateway and is meant to protect the computers
behind that gateway you are dealing with the first scenario: <em>forward_ing</em> .</p>
<p>If Suricata has to protect the computer it is running on, you are dealing
with the second scenario: <em>host</em> (see drawing 2).</p>
<p>These two ways of using Suricata can also be combined.</p>
<p>The easiest rule in case of the gateway-scenario to send traffic to Suricata is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
</pre></div>
</div>
<p>In this case, all forwarded traffic goes to Suricata.</p>
<p>In case of the host situation, these are the two most simple <code class="docutils literal notranslate"><span class="pre">iptables</span></code> rules;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
</pre></div>
</div>
<p>It is possible to set a queue number. If you do not, the queue number will
be 0 by default.</p>
<p>Imagine you want Suricata to check for example just TCP traffic, or all
incoming traffic on port 80, or all traffic on destination-port 80, you
can do so like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span>  <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
</pre></div>
</div>
<p>In this case, Suricata checks just TCP traffic.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">80</span>  <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
</pre></div>
</div>
<p>In this example, Suricata checks all packets for outgoing connections to port 80.</p>
<img alt="_images/iptables2.png" src="_images/iptables2.png" />
<img alt="_images/IPtables3.png" src="_images/IPtables3.png" />
<p>To see if you have set your <code class="docutils literal notranslate"><span class="pre">iptables</span></code> rules correct make sure Suricata is
running and enter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">vnL</span>
</pre></div>
</div>
<p>In the example you can see if packets are being logged.</p>
<img alt="_images/iptables_vnL.png" src="_images/iptables_vnL.png" />
<p>This description of the use of <code class="docutils literal notranslate"><span class="pre">iptables</span></code> is the way to use it with IPv4. To
use it with IPv6 all previous mentioned commands have to start with <code class="docutils literal notranslate"><span class="pre">ip6tables</span></code>.
It is also possible to let Suricata check both kinds of traffic.</p>
<p>There is also a way to use <code class="docutils literal notranslate"><span class="pre">iptables</span></code> with multiple networks (and interface cards). Example:</p>
<img alt="_images/iptables4.png" src="_images/iptables4.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth1</span> <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth1</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">j</span> <span class="n">NFQUEUE</span>
</pre></div>
</div>
<p>The options <code class="docutils literal notranslate"><span class="pre">-i</span></code> (input) <code class="docutils literal notranslate"><span class="pre">-o</span></code> (output) can be combined with all previous mentioned
options.</p>
<p>If you would stop Suricata and use internet, the traffic will not come through.
To make internet work correctly, first delete all <code class="docutils literal notranslate"><span class="pre">iptables</span></code> rules.</p>
<p>To erase all <code class="docutils literal notranslate"><span class="pre">iptables</span></code> rules, enter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">F</span>
</pre></div>
</div>
</div>
<div class="section" id="nftables-configuration">
<h4>NFtables configuration<a class="headerlink" href="#nftables-configuration" title="Permalink to this headline">¶</a></h4>
<p>The NFtables configuration is straight forward and allows mixing firewall rules
with IPS. The concept is to create a dedicated chain for the IPS that will
be evaluated after the firewalling rule. If your main table is named <cite>filter</cite>
it can be created like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nft</span><span class="o">&gt;</span> <span class="n">add</span> <span class="n">chain</span> <span class="nb">filter</span> <span class="n">IPS</span> <span class="p">{</span> <span class="nb">type</span> <span class="nb">filter</span> <span class="n">hook</span> <span class="n">forward</span> <span class="n">priority</span> <span class="mi">10</span><span class="p">;}</span>
</pre></div>
</div>
<p>To send all forwarded packets to Suricata one can use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nft</span><span class="o">&gt;</span> <span class="n">add</span> <span class="n">rule</span> <span class="nb">filter</span> <span class="n">IPS</span> <span class="n">queue</span>
</pre></div>
</div>
<p>To only do it for packets exchanged between eth0 and eth1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nft</span><span class="o">&gt;</span> <span class="n">add</span> <span class="n">rule</span> <span class="nb">filter</span> <span class="n">IPS</span> <span class="n">iif</span> <span class="n">eth0</span> <span class="n">oif</span> <span class="n">eth1</span> <span class="n">queue</span>
<span class="n">nft</span><span class="o">&gt;</span> <span class="n">add</span> <span class="n">rule</span> <span class="nb">filter</span> <span class="n">IPS</span> <span class="n">iif</span> <span class="n">eth1</span> <span class="n">oif</span> <span class="n">eth0</span> <span class="n">queue</span>
</pre></div>
</div>
</div>
<div class="section" id="nfqueue-advanced-options">
<h4>NFQUEUE advanced options<a class="headerlink" href="#nfqueue-advanced-options" title="Permalink to this headline">¶</a></h4>
<p>The NFQUEUE mechanism supports some interesting options. The <code class="docutils literal notranslate"><span class="pre">nftables</span></code> configuration
will be shown there but the features are also available in <code class="docutils literal notranslate"><span class="pre">iptables</span></code>.</p>
<p>The full syntax of the queuing mechanism is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nft</span> <span class="n">add</span> <span class="n">rule</span> <span class="nb">filter</span> <span class="n">IPS</span> <span class="n">queue</span> <span class="n">num</span> <span class="mi">3</span><span class="o">-</span><span class="mi">5</span> <span class="n">options</span> <span class="n">fanout</span><span class="p">,</span><span class="n">bypass</span>
</pre></div>
</div>
<p>This rule sends matching packets to 3 load-balanced queues starting at 3 and
ending at 5. To get the packets in Suricata with this setup, you need to specify
multiple queues on command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">q</span> <span class="mi">3</span> <span class="o">-</span><span class="n">q</span> <span class="mi">4</span> <span class="o">-</span><span class="n">q</span> <span class="mi">5</span>
</pre></div>
</div>
<p><cite>fanout</cite> and <cite>bypass</cite> are the two available options:</p>
<ul class="simple">
<li><cite>fanout</cite>: When used together with load balancing, this will use the CPU ID
instead of connection hash as an index to map packets to the queues. The idea
is that you can improve performance if there’s one queue per CPU. This requires
total with a number of queues superior to 1 to be specified.</li>
<li><cite>bypass</cite>: By default, if no userspace program is listening on an Netfilter
queue, then all packets that are to be queued are dropped. When this option
is used, the queue rule behaves like ACCEPT if there is no program listening,
and the packet will move on to the next table.</li>
</ul>
<p>The <cite>bypass</cite> option can be used to avoid downtime of link when Suricata is not
running but this also means that the blocking feature will not be present.</p>
</div>
</div>
<div class="section" id="setting-up-ips-at-layer-2">
<h3>Setting up IPS at Layer 2<a class="headerlink" href="#setting-up-ips-at-layer-2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="af-packet-ips-mode">
<span id="afp-ips-l2-mode"></span><h4>AF_PACKET IPS mode<a class="headerlink" href="#af-packet-ips-mode" title="Permalink to this headline">¶</a></h4>
<p>AF_PACKET capture method is supporting a IPS/Tap mode. In this mode, you just
need the interfaces to be up. Suricata will take care of copying the packets
from one interface to the other. No <code class="docutils literal notranslate"><span class="pre">iptables</span></code> or <code class="docutils literal notranslate"><span class="pre">nftables</span></code> configuration is
necessary.</p>
<p>You need to dedicate two network interfaces for this mode. The configuration
is made via configuration variable available in the description of an AF_PACKET
interface.</p>
<p>For example, the following configuration will create a Suricata acting as IPS
between interface <code class="docutils literal notranslate"><span class="pre">eth0</span></code> and <code class="docutils literal notranslate"><span class="pre">eth1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth0</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">defrag</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_flow</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">98</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">eth1</span>
    <span class="n">buffer</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">64535</span>
    <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth1</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">97</span>
    <span class="n">defrag</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_flow</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">eth0</span>
    <span class="n">buffer</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">64535</span>
    <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>This is a basic af-packet configuration using two interfaces. Interface
<code class="docutils literal notranslate"><span class="pre">eth0</span></code> will copy all received packets to <code class="docutils literal notranslate"><span class="pre">eth1</span></code> because of the <cite>copy-*</cite>
configuration variable</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
<span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">eth1</span>
</pre></div>
</div>
<p>The configuration on <code class="docutils literal notranslate"><span class="pre">eth1</span></code> is symmetric</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
<span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">eth0</span>
</pre></div>
</div>
<p>There are some important points to consider when setting up this mode:</p>
<ul class="simple">
<li>The implementation of this mode is dependent of the zero copy mode of
AF_PACKET. Thus you need to set <cite>use-mmap</cite> to <cite>yes</cite> on both interface.</li>
<li>MTU on both interfaces have to be equal: the copy from one interface to
the other is direct and packets bigger then the MTU will be dropped by kernel.</li>
<li>Set different values of <cite>cluster-id</cite> on both interfaces to avoid conflict.</li>
<li>Any network card offloading creating bigger then physical layer datagram
(like GRO, LRO, TSO) will result in dropped packets as the transmit path can not
handle them.</li>
<li>Set <cite>stream.inline</cite> to <cite>auto</cite> or <cite>yes</cite> so Suricata switches to
blocking mode.</li>
</ul>
<p>The <cite>copy-mode</cite> variable can take the following values:</p>
<ul class="simple">
<li><cite>ips</cite>: the drop keyword is honored and matching packets are dropped.</li>
<li><cite>tap</cite>: no drop occurs, Suricata acts as a bridge</li>
</ul>
<p>Some specific care must be taken to scale the capture method on multiple
threads. As we can't use defrag that will generate too big frames, the in
kernel load balancing will not be correct: the IP-only fragment will not
reach the same thread as the full featured packet of the same flow because
the port information will not be present.</p>
<p>A solution is to use eBPF load balancing to get an IP pair load balancing
without fragmentation. The AF_PACKET IPS Configuration using multiple threads
and eBPF load balancing looks like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth0</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
    <span class="n">defrag</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_ebpf</span>
    <span class="n">ebpf</span><span class="o">-</span><span class="n">lb</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">lb</span><span class="o">.</span><span class="n">bpf</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">98</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">eth1</span>
    <span class="n">buffer</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">64535</span>
    <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth1</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">97</span>
    <span class="n">defrag</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_ebpf</span>
    <span class="n">ebpf</span><span class="o">-</span><span class="n">lb</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">lb</span><span class="o">.</span><span class="n">bpf</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">eth0</span>
    <span class="n">buffer</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">64535</span>
    <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>The eBPF file <code class="docutils literal notranslate"><span class="pre">/usr/libexec/suricata/ebpf/lb.bpf</span></code> may not be present on disk.
See <a class="reference internal" href="index.html#ebpf-xdp"><span class="std std-ref">eBPF and XDP</span></a> for more information.</p>
</div>
<div class="section" id="dpdk-ips-mode">
<h4>DPDK IPS mode<a class="headerlink" href="#dpdk-ips-mode" title="Permalink to this headline">¶</a></h4>
<p>In the same way as you would configure AF_PACKET IPS mode, you can configure the DPDK capture module.
Prior to starting with IPS (inline) setup, it is recommended to go over <a class="reference internal" href="index.html#dpdk-capture-module"><span class="std std-ref">Data Plane Development Kit (DPDK)</span></a> manual page
to understand the setup essentials.</p>
<p>DPDK IPS mode, similarly to AF-Packet, uses two interfaces. Packets received on the first network interface
(<code class="docutils literal notranslate"><span class="pre">0000:3b:00.1</span></code>) are transmitted by the second network interface (<code class="docutils literal notranslate"><span class="pre">0000:3b:00.0</span></code>) and similarly,
packets received on the second interface (<code class="docutils literal notranslate"><span class="pre">0000:3b:00.0</span></code>) are transmitted
by the first interface (<code class="docutils literal notranslate"><span class="pre">0000:3b:00.1</span></code>). Packets are not altered in any way in this mode.</p>
<p>The following configuration snippet configures Suricata DPDK IPS mode between two NICs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dpdk</span><span class="p">:</span>
  <span class="n">eal</span><span class="o">-</span><span class="n">params</span><span class="p">:</span>
    <span class="n">proc</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">primary</span>

  <span class="n">interfaces</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">3</span><span class="n">b</span><span class="p">:</span><span class="mf">00.1</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">4</span>
    <span class="n">promisc</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">multicast</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">checksum</span><span class="o">-</span><span class="n">checks</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">checksum</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">offload</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">mempool</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">262143</span>
    <span class="n">mempool</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">511</span>
    <span class="n">rx</span><span class="o">-</span><span class="n">descriptors</span><span class="p">:</span> <span class="mi">4096</span>
    <span class="n">tx</span><span class="o">-</span><span class="n">descriptors</span><span class="p">:</span> <span class="mi">4096</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">3</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span>
    <span class="n">mtu</span><span class="p">:</span> <span class="mi">3000</span>

  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">3</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">4</span>
    <span class="n">promisc</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">multicast</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">checksum</span><span class="o">-</span><span class="n">checks</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">checksum</span><span class="o">-</span><span class="n">checks</span><span class="o">-</span><span class="n">offload</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">mempool</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">262143</span>
    <span class="n">mempool</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">511</span>
    <span class="n">rx</span><span class="o">-</span><span class="n">descriptors</span><span class="p">:</span> <span class="mi">4096</span>
    <span class="n">tx</span><span class="o">-</span><span class="n">descriptors</span><span class="p">:</span> <span class="mi">4096</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">3</span><span class="n">b</span><span class="p">:</span><span class="mf">00.1</span>
    <span class="n">mtu</span><span class="p">:</span> <span class="mi">3000</span>
</pre></div>
</div>
<p>The previous DPDK configuration snippet outlines several things to consider:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">copy-mode</span></code> - see Section <a class="reference internal" href="#afp-ips-l2-mode"><span class="std std-ref">AF_PACKET IPS mode</span></a> for more details.</li>
<li><code class="docutils literal notranslate"><span class="pre">copy-iface</span></code> - see Section <a class="reference internal" href="#afp-ips-l2-mode"><span class="std std-ref">AF_PACKET IPS mode</span></a> for more details.</li>
<li><code class="docutils literal notranslate"><span class="pre">threads</span></code> - all interface entries must have their thread count configured
and paired/connected interfaces must be configured with the same amount of threads.</li>
<li><code class="docutils literal notranslate"><span class="pre">mtu</span></code> - MTU must be the same on both paired interfaces.</li>
</ul>
<p>DPDK capture module also requires having CPU affinity set in the configuration file. For the best performance,
every Suricata worker should be pinned to a separate CPU core that is not shared with any other Suricata thread
(e.g. management threads).
The following snippet shows a possible <a class="reference internal" href="index.html#suricata-yaml-threading"><span class="std std-ref">Threading</span></a> configuration set-up for DPDK IPS mode.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">threading</span><span class="p">:</span>
  <span class="nb">set</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
    <span class="o">-</span> <span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">16</span> <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="netmap-ips-mode">
<h4>Netmap IPS mode<a class="headerlink" href="#netmap-ips-mode" title="Permalink to this headline">¶</a></h4>
<p>Using Netmap to support IPS requires setting up pairs of interfaces; packets are received
on one interface within the pair, inspected by Suricata, and transmitted on the other
paired interface. You can use native or host stack mode; host stack mode is used when the interface
name contains the <code class="docutils literal notranslate"><span class="pre">^</span></code> character, e.g, <code class="docutils literal notranslate"><span class="pre">enp6s0f0^</span></code>. host stack mode does not require
multiple physical network interfaces.</p>
<div class="section" id="netmap-host-stack-mode">
<h5>Netmap Host Stack Mode<a class="headerlink" href="#netmap-host-stack-mode" title="Permalink to this headline">¶</a></h5>
<p>Netmap's host stack mode allows packets that flow through Suricata to be used with other host OS applications,
e.g., a firewall or similar. Additionally, host stack mode allows traffic to be received and transmitted
on one network interface card.</p>
<p>With host stack mode, Netmap establishes a pair of host stack mode rings (one each for RX and TX). Packets
pass through the host operating system network protocol stack. Ingress network packets flow from the network
interface card to the network protocol stack and then into the host stack mode rings. Outbound packets
flow from the  host stack mode rings to the network protocol stack and finally, to the network interface card.
Suricata receives packets from the host stack mode rings and, in IPS mode, places packets to be transmitted into
the host stack mode rings. Packets transmitted by Suricata into the host stack mode rings are available for
other host OS applications.</p>
<p>Paired network interfaces are specified in the <code class="docutils literal notranslate"><span class="pre">netmap</span></code> configuration section.
For example, the following configuration will create a Suricata acting as IPS
between interface <code class="docutils literal notranslate"><span class="pre">enp6s0f0</span></code> and <code class="docutils literal notranslate"><span class="pre">enp6s0f1</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netmap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">enp6s0f0</span>
    <span class="n">threads</span><span class="p">:</span> <span class="n">auto</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">enp6s0f1</span>

  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">enp6s0f1</span>
    <span class="n">threads</span><span class="p">:</span> <span class="n">auto</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">enp6s0f0</span>
</pre></div>
</div>
<p>You can specify the <code class="docutils literal notranslate"><span class="pre">threads</span></code> value; the default value of <code class="docutils literal notranslate"><span class="pre">auto</span></code> will create a
thread for each queue supported by the NIC; restrict the thread count by specifying
a value, e.g., <code class="docutils literal notranslate"><span class="pre">threads:</span> <span class="pre">1</span></code></p>
<p>This is a basic netmap configuration using two interfaces. Suricata will copy
packets between interfaces <code class="docutils literal notranslate"><span class="pre">enp6s0f0</span></code> and <code class="docutils literal notranslate"><span class="pre">en60sf1</span></code> because of the <cite>copy-*</cite>
configuration variable in interface's <code class="docutils literal notranslate"><span class="pre">enp6s0f0</span></code> configuration</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
<span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">enp6s0f1</span>
</pre></div>
</div>
<p>The configuration on <code class="docutils literal notranslate"><span class="pre">enp6s0f1</span></code> is symmetric</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
<span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">enp6s0f0</span>
</pre></div>
</div>
<p>The host stack mode feature of Netmap can be used. host stack mode doesn't require a second network
interface.</p>
<p>This example demonstrates host stack mode with a single physical network interface <code class="docutils literal notranslate"><span class="pre">enp6s0f01</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">enp60s0f0</span>
  <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
  <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">enp6s0f0</span><span class="o">^</span>
</pre></div>
</div>
<p>The configuration on <code class="docutils literal notranslate"><span class="pre">enp6s0f0^</span></code> is symmetric</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">enp60s0f0</span><span class="o">^</span>
  <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
  <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">enp6s0f0</span>
</pre></div>
</div>
<p>Suricata will use zero-copy mode when the runmode is <code class="docutils literal notranslate"><span class="pre">workers</span></code>.</p>
<p>There are some important points to consider when setting up this mode:</p>
<ul class="simple">
<li>Any network card offloading creating bigger then physical layer datagram
(like GRO, LRO, TSO) will result in dropped packets as the transmit path can not
handle them.</li>
<li>Set <cite>stream.inline</cite> to <cite>auto</cite> or <cite>yes</cite> so Suricata switches to
blocking mode. The default value is <cite>auto</cite>.</li>
</ul>
<p>The <cite>copy-mode</cite> variable can take the following values:</p>
<ul class="simple">
<li><cite>ips</cite>: the drop keyword is honored and matching packets are dropped.</li>
<li><cite>tap</cite>: no drop occurs, Suricata acts as a bridge</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-setting-up-ipsinline-for-windows"></span><div class="section" id="setting-up-ips-inline-for-windows">
<h2>Setting up IPS/inline for Windows<a class="headerlink" href="#setting-up-ips-inline-for-windows" title="Permalink to this headline">¶</a></h2>
<p>This guide explains how to work with Suricata in layer 4 inline mode using
WinDivert on Windows.</p>
<p>First start by compiling Suricata with WinDivert support. For instructions, see
<a class="reference external" href="https://redmine.openinfosecfoundation.org/attachments/download/1175/SuricataWinInstallationGuide_v1.4.3.pdf">Windows Installation</a>.
This documentation has not yet been updated with WinDivert information, so make
sure to add the following flags before configuring Suricata with <code class="docutils literal notranslate"><span class="pre">configure</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">windivert</span><span class="o">=</span><span class="n">yes</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">windivert</span><span class="o">-</span><span class="n">include</span><span class="o">=&lt;</span><span class="n">include</span><span class="o">-</span><span class="nb">dir</span><span class="o">&gt;</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">windivert</span><span class="o">-</span><span class="n">libraries</span><span class="o">=&lt;</span><span class="n">libraries</span><span class="o">-</span><span class="nb">dir</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>WinDivert.dll and WinDivert.sys must be in the same directory as the Suricata
executable. WinDivert automatically installs the driver when it is run. For more
information about WinDivert, see <a class="reference external" href="https://www.reqrypt.org/windivert-doc.html">https://www.reqrypt.org/windivert-doc.html</a>.</p>
<p>To check if you have WinDivert enabled in your Suricata, enter the following
command in an elevated command prompt or terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">windivert</span> <span class="p">[</span><span class="nb">filter</span> <span class="n">string</span><span class="p">]</span>
</pre></div>
</div>
<p>For information on the WinDivert filter language, see
<a class="reference external" href="https://www.reqrypt.org/windivert-doc.html#filter_language">https://www.reqrypt.org/windivert-doc.html#filter_language</a></p>
<p>If Suricata is running on a gateway and is meant to protect the network behind
that gateway, you need to run WinDivert at the <cite>NETWORK_FORWARD</cite> layer. This can
be achieved using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">windivert</span><span class="o">-</span><span class="n">forward</span> <span class="p">[</span><span class="nb">filter</span> <span class="n">string</span><span class="p">]</span>
</pre></div>
</div>
<p>The filter is automatically stopped and normal traffic resumes when Suricata is
stopped.</p>
<p>A quick start is to examine all traffic, in which case you can use the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">windivert</span><span class="p">[</span><span class="o">-</span><span class="n">forward</span><span class="p">]</span> <span class="n">true</span>
</pre></div>
</div>
<p>A few additional examples:</p>
<p>Only TCP traffic:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">windivert</span> <span class="n">tcp</span>
</pre></div>
</div>
<p>Only TCP traffic on port 80:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">windivert</span> <span class="s2">&quot;tcp.DstPort == 80&quot;</span>
</pre></div>
</div>
<p>TCP and ICMP traffic:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">windivert</span> <span class="s2">&quot;tcp or icmp&quot;</span>
</pre></div>
</div>
</div>
<span id="document-output/index"></span><div class="section" id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-output/eve/index"></span><div class="section" id="eve">
<span id="id1"></span><h3>EVE<a class="headerlink" href="#eve" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-output/eve/eve-json-output"></span><div class="section" id="eve-json-output">
<span id="id1"></span><h4>Eve JSON Output<a class="headerlink" href="#eve-json-output" title="Permalink to this headline">¶</a></h4>
<p>The EVE output facility outputs alerts, anomalies, metadata, file info and protocol
specific records through JSON.</p>
<p>The most common way to use this is through 'EVE', which is a firehose approach
where all these logs go into a single file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="c1"># Extensible Event Format (nicknamed EVE) event log in JSON format</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">filetype</span><span class="p">:</span> <span class="n">regular</span> <span class="c1">#regular|syslog|unix_dgram|unix_stream|redis</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
      <span class="c1"># Enable for multi-threaded eve.json output; output files are amended</span>
      <span class="c1"># with an identifier, e.g., eve.9.json</span>
      <span class="c1">#threaded: false</span>
      <span class="c1">#prefix: &quot;@cee: &quot; # prefix to prepend to each log entry</span>
      <span class="c1"># the following are valid when type: syslog above</span>
      <span class="c1">#identity: &quot;suricata&quot;</span>
      <span class="c1">#facility: local5</span>
      <span class="c1">#level: Info ## possible levels: Emergency, Alert, Critical,</span>
                   <span class="c1">## Error, Warning, Notice, Info, Debug</span>
      <span class="c1">#redis:</span>
      <span class="c1">#  server: 127.0.0.1</span>
      <span class="c1">#  port: 6379</span>
      <span class="c1">#  async: true ## if redis replies are read asynchronously</span>
      <span class="c1">#  mode: list ## possible values: list|lpush (default), rpush, channel|publish</span>
      <span class="c1">#             ## lpush and rpush are using a Redis list. &quot;list&quot; is an alias for lpush</span>
      <span class="c1">#             ## publish is using a Redis channel. &quot;channel&quot; is an alias for publish</span>
      <span class="c1">#  key: suricata ## key or channel to use (default to suricata)</span>
      <span class="c1"># Redis pipelining set up. This will enable to only do a query every</span>
      <span class="c1"># &#39;batch-size&#39; events. This should lower the latency induced by network</span>
      <span class="c1"># connection at the cost of some memory. There is no flushing implemented</span>
      <span class="c1"># so this setting as to be reserved to high traffic suricata.</span>
      <span class="c1">#  pipelining:</span>
      <span class="c1">#    enabled: yes ## set enable to yes to enable query pipelining</span>
      <span class="c1">#    batch-size: 10 ## number of entry to keep in buffer</span>

      <span class="c1"># Include top level metadata. Default yes.</span>
      <span class="c1">#metadata: no</span>

      <span class="n">types</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">alert</span><span class="p">:</span>
            <span class="c1"># payload: yes             # enable dumping payload in Base64</span>
            <span class="c1"># payload-buffer-size: 4kb # max size of payload buffer to output in eve-log</span>
            <span class="c1"># payload-printable: yes   # enable dumping payload in printable (lossy) format</span>
            <span class="c1"># packet: yes              # enable dumping of packet (without stream segments)</span>
            <span class="c1"># http-body: yes           # Requires metadata; enable dumping of http body in Base64</span>
            <span class="c1"># http-body-printable: yes # Requires metadata; enable dumping of http body in printable format</span>

            <span class="c1"># Enable the logging of tagged packets for rules using the</span>
            <span class="c1"># &quot;tag&quot; keyword.</span>
            <span class="n">tagged</span><span class="o">-</span><span class="n">packets</span><span class="p">:</span> <span class="n">yes</span>

            <span class="c1"># Configure the metadata to be logged along with an</span>
            <span class="c1"># alert. The following shows the default configuration</span>
            <span class="c1"># which is used if this field is not provided or simply</span>
            <span class="c1"># set to a truthful value. Setting of this section is only</span>
            <span class="c1"># required if you wish to enable/disable specific fields.</span>
            <span class="c1">#metadata:</span>

              <span class="c1"># Include the decoded application layer (ie. http, dns)</span>
              <span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="p">:</span> <span class="n">true</span>

              <span class="c1"># Log the current state of the flow record.</span>
              <span class="n">flow</span><span class="p">:</span> <span class="n">true</span>

              <span class="n">rule</span><span class="p">:</span>
                <span class="c1"># Log the metadata field from the rule in a structured</span>
                <span class="c1"># format.</span>
                <span class="n">metadata</span><span class="p">:</span> <span class="n">true</span>

                <span class="c1"># Log the raw rule text.</span>
                <span class="n">raw</span><span class="p">:</span> <span class="n">false</span>

            <span class="c1"># HTTP X-Forwarded-For support by adding an extra field or overwriting</span>
            <span class="c1"># the source or destination IP address (depending on flow direction)</span>
            <span class="c1"># with the one reported in the X-Forwarded-For HTTP header. This is</span>
            <span class="c1"># helpful when reviewing alerts for traffic that is being reverse</span>
            <span class="c1"># or forward proxied.</span>
            <span class="n">xff</span><span class="p">:</span>
              <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>
              <span class="c1"># Two operation modes are available, &quot;extra-data&quot; and &quot;overwrite&quot;.</span>
              <span class="n">mode</span><span class="p">:</span> <span class="n">extra</span><span class="o">-</span><span class="n">data</span>
              <span class="c1"># Two proxy deployments are supported, &quot;reverse&quot; and &quot;forward&quot;. In</span>
              <span class="c1"># a &quot;reverse&quot; deployment the IP address used is the last one, in a</span>
              <span class="c1"># &quot;forward&quot; deployment the first IP address is used.</span>
              <span class="n">deployment</span><span class="p">:</span> <span class="n">reverse</span>
              <span class="c1"># Header name where the actual IP address will be reported, if more</span>
              <span class="c1"># than one IP address is present, the last IP address will be the</span>
              <span class="c1"># one taken into consideration.</span>
              <span class="n">header</span><span class="p">:</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span>
        <span class="o">-</span> <span class="n">http</span><span class="p">:</span>
            <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable this for extended logging information</span>
            <span class="c1"># custom allows additional http fields to be included in eve-log</span>
            <span class="c1"># the example below adds three additional fields when uncommented</span>
            <span class="c1">#custom: [Accept-Encoding, Accept-Language, Authorization]</span>
        <span class="o">-</span> <span class="n">dns</span><span class="p">:</span>
            <span class="c1"># Use version 2 logging with the new format:</span>
            <span class="c1"># dns answers will be logged in one single event</span>
            <span class="c1"># rather than an event for each of the answers.</span>
            <span class="c1"># Without setting a version the version</span>
            <span class="c1"># will fallback to 1 for backwards compatibility.</span>
            <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>

            <span class="c1"># Enable/disable this logger. Default: enabled.</span>
            <span class="c1">#enabled: no</span>

            <span class="c1"># Control logging of requests and responses:</span>
            <span class="c1"># - requests: enable logging of DNS queries</span>
            <span class="c1"># - responses: enable logging of DNS answers</span>
            <span class="c1"># By default both requests and responses are logged.</span>
            <span class="c1">#requests: no</span>
            <span class="c1">#responses: no</span>

            <span class="c1"># Format of answer logging:</span>
            <span class="c1"># - detailed: array item per answer</span>
            <span class="c1"># - grouped: answers aggregated by type</span>
            <span class="c1"># Default: all</span>
            <span class="c1">#answer-format: [detailed, grouped]</span>

            <span class="c1"># Answer types to log.</span>
            <span class="c1"># Default: all</span>
            <span class="c1">#answer-types: [a, aaaa, cname, mx, ns, ptr, txt]</span>
        <span class="o">-</span> <span class="n">dns</span><span class="p">:</span>
            <span class="c1"># Version 1 DNS logger.</span>
            <span class="c1"># Deprecated: Will be removed by May 2022.</span>
            <span class="n">version</span><span class="p">:</span> <span class="mi">1</span>

            <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>
            <span class="c1"># control logging of queries and answers</span>
            <span class="c1"># default yes, no to disable</span>
            <span class="n">query</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable logging of DNS queries</span>
            <span class="n">answer</span><span class="p">:</span> <span class="n">yes</span>    <span class="c1"># enable logging of DNS answers</span>
            <span class="c1"># control which RR types are logged</span>
            <span class="c1"># all enabled if custom not specified</span>
            <span class="c1">#custom: [a, aaaa, cname, mx, ns, ptr, txt]</span>
        <span class="o">-</span> <span class="n">tls</span><span class="p">:</span>
            <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable this for extended logging information</span>
            <span class="c1"># output TLS transaction where the session is resumed using a</span>
            <span class="c1"># session id</span>
            <span class="c1">#session-resumption: no</span>
            <span class="c1"># custom allows to control which tls fields that are included</span>
            <span class="c1"># in eve-log</span>
            <span class="c1">#custom: [subject, issuer, session_resumed, serial, fingerprint, sni, version, not_before, not_after, certificate, chain]</span>
        <span class="o">-</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">force</span><span class="o">-</span><span class="n">magic</span><span class="p">:</span> <span class="n">no</span>   <span class="c1"># force logging magic on all logged files</span>
            <span class="c1"># force logging of checksums, available hash functions are md5,</span>
            <span class="c1"># sha1 and sha256</span>
            <span class="c1">#force-hash: [md5]</span>
        <span class="c1">#- drop:</span>
        <span class="c1">#    alerts: yes      # log alerts that caused drops</span>
        <span class="c1">#    flows: all       # start or all: &#39;start&#39; logs only a single drop</span>
        <span class="c1">#                     # per flow direction. All logs each dropped pkt.</span>
        <span class="o">-</span> <span class="n">smtp</span><span class="p">:</span>
            <span class="c1">#extended: yes # enable this for extended logging information</span>
            <span class="c1"># this includes: bcc, message-id, subject, x_mailer, user-agent</span>
            <span class="c1"># custom fields logging from the list:</span>
            <span class="c1">#  reply-to, bcc, message-id, subject, x-mailer, user-agent, received,</span>
            <span class="c1">#  x-originating-ip, in-reply-to, references, importance, priority,</span>
            <span class="c1">#  sensitivity, organization, content-md5, date</span>
            <span class="c1">#custom: [received, x-mailer, x-originating-ip, relays, reply-to, bcc]</span>
            <span class="c1"># output md5 of fields: body, subject</span>
            <span class="c1"># for the body you need to set app-layer.protocols.smtp.mime.body-md5</span>
            <span class="c1"># to yes</span>
            <span class="c1">#md5: [body, subject]</span>

        <span class="c1"># NFS logging.</span>
        <span class="o">-</span> <span class="n">nfs</span>
        <span class="c1"># IKE logging.</span>
        <span class="o">-</span> <span class="n">ike</span>
        <span class="c1"># BitTorrent DHT logging.</span>
        <span class="o">-</span> <span class="n">bittorrent</span><span class="o">-</span><span class="n">dht</span>
        <span class="o">-</span> <span class="n">ssh</span>
        <span class="o">-</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">totals</span><span class="p">:</span> <span class="n">yes</span>       <span class="c1"># stats for all threads merged together</span>
            <span class="n">threads</span><span class="p">:</span> <span class="n">no</span>       <span class="c1"># per thread stats</span>
            <span class="n">deltas</span><span class="p">:</span> <span class="n">no</span>        <span class="c1"># include delta values</span>
        <span class="o">-</span> <span class="n">dhcp</span><span class="p">:</span>
            <span class="c1"># DHCP logging.</span>
            <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
            <span class="c1"># When extended mode is on, all DHCP messages are logged</span>
            <span class="c1"># with full detail. When extended mode is off (the</span>
            <span class="c1"># default), just enough information to map a MAC address</span>
            <span class="c1"># to an IP address is logged.</span>
            <span class="n">extended</span><span class="p">:</span> <span class="n">no</span>
        <span class="c1"># bi-directional flows</span>
        <span class="o">-</span> <span class="n">flow</span>
        <span class="c1"># uni-directional flows</span>
        <span class="c1">#- netflow</span>

        <span class="c1"># An event for logging metadata, specifically pktvars when</span>
        <span class="c1"># they are set, but will also include the full metadata object.</span>
        <span class="c1">#- metadata</span>
</pre></div>
</div>
<p>Each alert, http log, etc will go into this one file: 'eve.json'. This file
can then be processed by 3rd party tools like Logstash (ELK) or jq.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">ethernet</span></code> is set to yes, then ethernet headers will be added to events
if available.</p>
<div class="section" id="output-types">
<h5>Output types<a class="headerlink" href="#output-types" title="Permalink to this headline">¶</a></h5>
<p>EVE can output to multiple methods. <code class="docutils literal notranslate"><span class="pre">regular</span></code> is a normal file. Other
options are <code class="docutils literal notranslate"><span class="pre">syslog</span></code>, <code class="docutils literal notranslate"><span class="pre">unix_dgram</span></code>, <code class="docutils literal notranslate"><span class="pre">unix_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">redis</span></code>.</p>
<p>Output types:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filetype</span><span class="p">:</span> <span class="n">regular</span> <span class="c1">#regular|syslog|unix_dgram|unix_stream|redis</span>
<span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
<span class="c1"># Enable for multi-threaded eve.json output; output files are amended</span>
<span class="c1"># with an identifier, e.g., eve.9.json. Default: off</span>
<span class="c1">#threaded: off</span>
<span class="c1">#prefix: &quot;@cee: &quot; # prefix to prepend to each log entry</span>
<span class="c1"># the following are valid when type: syslog above</span>
<span class="c1">#identity: &quot;suricata&quot;</span>
<span class="c1">#facility: local5</span>
<span class="c1">#level: Info ## possible levels: Emergency, Alert, Critical,</span>
             <span class="c1">## Error, Warning, Notice, Info, Debug</span>
<span class="c1">#ethernet: no # log ethernet header in events when available</span>
<span class="c1">#redis:</span>
<span class="c1">#  server: 127.0.0.1</span>
<span class="c1">#  port: 6379</span>
<span class="c1">#  async: true ## if redis replies are read asynchronously</span>
<span class="c1">#  mode: list ## possible values: list|lpush (default), rpush, channel|publish</span>
<span class="c1">#             ## lpush and rpush are using a Redis list. &quot;list&quot; is an alias for lpush</span>
<span class="c1">#             ## publish is using a Redis channel. &quot;channel&quot; is an alias for publish</span>
<span class="c1">#  key: suricata ## key or channel to use (default to suricata)</span>
<span class="c1"># Redis pipelining set up. This will enable to only do a query every</span>
<span class="c1"># &#39;batch-size&#39; events. This should lower the latency induced by network</span>
<span class="c1"># connection at the cost of some memory. There is no flushing implemented</span>
<span class="c1"># so this setting as to be reserved to high traffic suricata.</span>
<span class="c1">#  pipelining:</span>
<span class="c1">#    enabled: yes ## set enable to yes to enable query pipelining</span>
<span class="c1">#    batch-size: 10 ## number of entry to keep in buffer</span>
</pre></div>
</div>
</div>
<div class="section" id="alerts">
<h5>Alerts<a class="headerlink" href="#alerts" title="Permalink to this headline">¶</a></h5>
<p>Alerts are event records for rule matches. They can be amended with
metadata, such as the application layer record (HTTP, DNS, etc) an
alert was generated for, and elements of the rule.</p>
<p>Metadata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">alert</span><span class="p">:</span>
    <span class="c1">#payload: yes             # enable dumping payload in Base64</span>
    <span class="c1">#payload-buffer-size: 4kb # max size of payload buffer to output in eve-log</span>
    <span class="c1">#payload-printable: yes   # enable dumping payload in printable (lossy) format</span>
    <span class="c1">#packet: yes              # enable dumping of packet (without stream segments)</span>
    <span class="c1">#http-body: yes           # Requires metadata; enable dumping of http body in Base64</span>
    <span class="c1">#http-body-printable: yes # Requires metadata; enable dumping of http body in printable format</span>

    <span class="c1"># metadata:</span>

      <span class="c1"># Include the decoded application layer (ie. http, dns)</span>
      <span class="c1">#app-layer: true</span>

      <span class="c1"># Log the current state of the flow record.</span>
      <span class="c1">#flow: true</span>

      <span class="c1">#rule:</span>
        <span class="c1"># Log the metadata field from the rule in a structured</span>
        <span class="c1"># format.</span>
        <span class="c1">#metadata: true</span>

        <span class="c1"># Log the raw rule text.</span>
        <span class="c1">#raw: false</span>
</pre></div>
</div>
</div>
<div class="section" id="anomaly">
<h5>Anomaly<a class="headerlink" href="#anomaly" title="Permalink to this headline">¶</a></h5>
<p>Anomalies are event records created when packets with unexpected or anomalous
values are handled. These events include conditions such as incorrect protocol
values, incorrect protocol length values, and other conditions which render the
packet suspect. Other conditions may occur during the normal progression of a stream;
these are termed <code class="docutils literal notranslate"><span class="pre">stream</span></code> events are include control sequences with incorrect
values or that occur out of expected sequence.</p>
<p>Anomalies are reported by and configured by type:</p>
<ul class="simple">
<li>Decode</li>
<li>Stream</li>
<li>Application layer</li>
</ul>
<p>Metadata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">anomaly</span><span class="p">:</span>
    <span class="c1"># Anomaly log records describe unexpected conditions such as truncated packets,</span>
    <span class="c1"># packets with invalid IP/UDP/TCP length values, and other events that render</span>
    <span class="c1"># the packet invalid for further processing or describe unexpected behavior on</span>
    <span class="c1"># an established stream. Networks which experience high occurrences of</span>
    <span class="c1"># anomalies may experience packet processing degradation.</span>
    <span class="c1">#</span>
    <span class="c1"># Anomalies are reported for the following:</span>
    <span class="c1"># 1. Decode: Values and conditions that are detected while decoding individual</span>
    <span class="c1">#    packets. This includes invalid or unexpected values for low-level protocol</span>
    <span class="c1">#    lengths as well.</span>
    <span class="c1"># 2. Stream: This includes stream related events (TCP 3-way handshake issues,</span>
    <span class="c1">#    unexpected sequence number, etc).</span>
    <span class="c1"># 3. Application layer: These denote application layer specific conditions that</span>
    <span class="c1">#    are unexpected, invalid or are unexpected given the application monitoring</span>
    <span class="c1">#    state.</span>
    <span class="c1">#</span>
    <span class="c1"># By default, anomaly logging is disabled. When anomaly logging is enabled,</span>
    <span class="c1"># application-layer anomaly reporting is enabled.</span>
    <span class="c1">#</span>
    <span class="c1"># Choose one or both types of anomaly logging and whether to enable</span>
    <span class="c1"># logging of the packet header for packet anomalies.</span>
    <span class="n">types</span><span class="p">:</span>
      <span class="c1">#decode: no</span>
      <span class="c1">#stream: no</span>
      <span class="c1">#applayer: yes</span>
    <span class="c1">#packethdr: no</span>
</pre></div>
</div>
</div>
<div class="section" id="http">
<h5>HTTP<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h5>
<p>HTTP transaction logging.</p>
<p>Config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">http</span><span class="p">:</span>
    <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable this for extended logging information</span>
    <span class="c1"># custom allows additional http fields to be included in eve-log</span>
    <span class="c1"># the example below adds three additional fields when uncommented</span>
    <span class="c1">#custom: [Accept-Encoding, Accept-Language, Authorization]</span>
    <span class="c1"># set this value to one among {both, request, response} to dump all</span>
    <span class="c1"># http headers for every http request and/or response</span>
    <span class="c1"># dump-all-headers: [both, request, response]</span>
</pre></div>
</div>
<p>List of custom fields:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Yaml Option</th>
<th class="head">HTTP Header</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>accept</td>
<td>accept</td>
</tr>
<tr class="row-odd"><td>accept_charset</td>
<td>accept-charset</td>
</tr>
<tr class="row-even"><td>accept_encoding</td>
<td>accept-encoding</td>
</tr>
<tr class="row-odd"><td>accept_language</td>
<td>accept-language</td>
</tr>
<tr class="row-even"><td>accept_datetime</td>
<td>accept-datetime</td>
</tr>
<tr class="row-odd"><td>authorization</td>
<td>authorization</td>
</tr>
<tr class="row-even"><td>cache_control</td>
<td>cache-control</td>
</tr>
<tr class="row-odd"><td>cookie</td>
<td>cookie</td>
</tr>
<tr class="row-even"><td>from</td>
<td>from</td>
</tr>
<tr class="row-odd"><td>max_forwards</td>
<td>max-forwards</td>
</tr>
<tr class="row-even"><td>origin</td>
<td>origin</td>
</tr>
<tr class="row-odd"><td>pragma</td>
<td>pragma</td>
</tr>
<tr class="row-even"><td>proxy_authorization</td>
<td>proxy-authorization</td>
</tr>
<tr class="row-odd"><td>range</td>
<td>range</td>
</tr>
<tr class="row-even"><td>te</td>
<td>te</td>
</tr>
<tr class="row-odd"><td>via</td>
<td>via</td>
</tr>
<tr class="row-even"><td>x_requested_with</td>
<td>x-requested-with</td>
</tr>
<tr class="row-odd"><td>dnt</td>
<td>dnt</td>
</tr>
<tr class="row-even"><td>x_forwarded_proto</td>
<td>x-forwarded-proto</td>
</tr>
<tr class="row-odd"><td>x_authenticated_user</td>
<td>x-authenticated-user</td>
</tr>
<tr class="row-even"><td>x_flash_version</td>
<td>x-flash-version</td>
</tr>
<tr class="row-odd"><td>accept_range</td>
<td>accept-range</td>
</tr>
<tr class="row-even"><td>age</td>
<td>age</td>
</tr>
<tr class="row-odd"><td>allow</td>
<td>allow</td>
</tr>
<tr class="row-even"><td>connection</td>
<td>connection</td>
</tr>
<tr class="row-odd"><td>content_encoding</td>
<td>content-encoding</td>
</tr>
<tr class="row-even"><td>content_language</td>
<td>content-language</td>
</tr>
<tr class="row-odd"><td>content_length</td>
<td>content-length</td>
</tr>
<tr class="row-even"><td>content_location</td>
<td>content-location</td>
</tr>
<tr class="row-odd"><td>content_md5</td>
<td>content-md5</td>
</tr>
<tr class="row-even"><td>content_range</td>
<td>content-range</td>
</tr>
<tr class="row-odd"><td>content_type</td>
<td>content-type</td>
</tr>
<tr class="row-even"><td>date</td>
<td>date</td>
</tr>
<tr class="row-odd"><td>etag</td>
<td>etags</td>
</tr>
<tr class="row-even"><td>expires</td>
<td>expires</td>
</tr>
<tr class="row-odd"><td>last_modified</td>
<td>last-modified</td>
</tr>
<tr class="row-even"><td>link</td>
<td>link</td>
</tr>
<tr class="row-odd"><td>location</td>
<td>location</td>
</tr>
<tr class="row-even"><td>proxy_authenticate</td>
<td>proxy-authenticate</td>
</tr>
<tr class="row-odd"><td>referer</td>
<td>referer</td>
</tr>
<tr class="row-even"><td>refresh</td>
<td>refresh</td>
</tr>
<tr class="row-odd"><td>retry_after</td>
<td>retry-after</td>
</tr>
<tr class="row-even"><td>server</td>
<td>server</td>
</tr>
<tr class="row-odd"><td>set_cookie</td>
<td>set-cookie</td>
</tr>
<tr class="row-even"><td>trailer</td>
<td>trailer</td>
</tr>
<tr class="row-odd"><td>transfer_encoding</td>
<td>transfer-encoding</td>
</tr>
<tr class="row-even"><td>upgrade</td>
<td>upgrade</td>
</tr>
<tr class="row-odd"><td>vary</td>
<td>vary</td>
</tr>
<tr class="row-even"><td>warning</td>
<td>warning</td>
</tr>
<tr class="row-odd"><td>www_authenticate</td>
<td>www-authenticate</td>
</tr>
<tr class="row-even"><td>true_client_ip</td>
<td>true-client-ip</td>
</tr>
<tr class="row-odd"><td>org_src_ip</td>
<td>org-src-ip</td>
</tr>
<tr class="row-even"><td>x_bluecoat_via</td>
<td>x-bluecoat-via</td>
</tr>
</tbody>
</table>
<p>In the <code class="docutils literal notranslate"><span class="pre">custom</span></code> option values from both columns can be used. The
<code class="docutils literal notranslate"><span class="pre">HTTP</span> <span class="pre">Header</span></code> column is case insensitive.</p>
</div>
<div class="section" id="dns">
<span id="output-eve-dns"></span><h5>DNS<a class="headerlink" href="#dns" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As of Suricata 7.0 the v1 EVE DNS format has been removed.</p>
</div>
<p>DNS records are logged as one entry for the request, and one entry for
the response.</p>
<p>YAML:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">dns</span><span class="p">:</span>
    <span class="c1">#version: 2</span>

    <span class="c1"># Enable/disable this logger. Default: enabled.</span>
    <span class="c1">#enabled: yes</span>

    <span class="c1"># Control logging of requests and responses:</span>
    <span class="c1"># - requests: enable logging of DNS queries</span>
    <span class="c1"># - responses: enable logging of DNS answers</span>
    <span class="c1"># By default both requests and responses are logged.</span>
    <span class="c1">#requests: no</span>
    <span class="c1">#responses: no</span>

    <span class="c1"># Format of answer logging:</span>
    <span class="c1"># - detailed: array item per answer</span>
    <span class="c1"># - grouped: answers aggregated by type</span>
    <span class="c1"># Default: all</span>
    <span class="c1">#formats: [detailed, grouped]</span>

    <span class="c1"># Types to log, based on the query type.</span>
    <span class="c1"># Default: all.</span>
    <span class="c1">#types: [a, aaaa, cname, mx, ns, ptr, txt]</span>
</pre></div>
</div>
</div>
<div class="section" id="tls">
<h5>TLS<a class="headerlink" href="#tls" title="Permalink to this headline">¶</a></h5>
<p>TLS records are logged one record per session.</p>
<p>YAML:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">tls</span><span class="p">:</span>
    <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable this for extended logging information</span>
    <span class="c1"># custom allows to control which tls fields that are included</span>
    <span class="c1"># in eve-log</span>
    <span class="c1">#custom: [subject, issuer, serial, fingerprint, sni, version, not_before, not_after, certificate, chain, ja3, ja3s]</span>
</pre></div>
</div>
<p>The default is to log certificate subject and issuer. If <code class="docutils literal notranslate"><span class="pre">extended</span></code> is
enabled, then the log gets more verbose.</p>
<p>By using <code class="docutils literal notranslate"><span class="pre">custom</span></code> it is possible to select which TLS fields to log.</p>
</div>
<div class="section" id="drops">
<h5>Drops<a class="headerlink" href="#drops" title="Permalink to this headline">¶</a></h5>
<p>Drops are event types logged when the engine drops a packet.</p>
<p>Config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">drop</span><span class="p">:</span>
    <span class="n">alerts</span><span class="p">:</span> <span class="n">yes</span>      <span class="c1"># log alerts that caused drops</span>
    <span class="n">flows</span><span class="p">:</span> <span class="nb">all</span>       <span class="c1"># start or all: &#39;start&#39; logs only a single drop</span>
                     <span class="c1"># per flow direction. All logs each dropped pkt.</span>
    <span class="c1"># Enable logging the final action taken on a packet by the engine</span>
    <span class="c1"># (will show more information in case of a drop caused by &#39;reject&#39;)</span>
    <span class="n">verdict</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
</div>
<div class="section" id="date-modifiers-in-filename">
<h5>Date modifiers in filename<a class="headerlink" href="#date-modifiers-in-filename" title="Permalink to this headline">¶</a></h5>
<p>It is possible to use date modifiers in the eve-log filename.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">-%</span><span class="n">s</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>The example above adds epoch time to the filename. All the date modifiers from the
C library should be supported. See the man page for <code class="docutils literal notranslate"><span class="pre">strftime</span></code> for all supported
modifiers.</p>
</div>
<div class="section" id="threaded-file-output">
<span id="output-eve-rotate"></span><h5>Threaded file output<a class="headerlink" href="#threaded-file-output" title="Permalink to this headline">¶</a></h5>
<p>By default, all output is written to the named filename in the outputs section. The <code class="docutils literal notranslate"><span class="pre">threaded</span></code> option enables
each output thread to write to individual files. In this case, the <code class="docutils literal notranslate"><span class="pre">filename</span></code> will include a unique identifier.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">threaded</span></code> enabled, the output will be split among many files -- and
the aggregate of each file's contents must be treated together.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
      <span class="n">threaded</span><span class="p">:</span> <span class="n">on</span>
</pre></div>
</div>
<p>This example will cause each Suricata thread to write to its own &quot;eve.json&quot; file. Filenames are constructed
by adding a unique identifier to the filename.  For example, <code class="docutils literal notranslate"><span class="pre">eve.7.json</span></code>.</p>
</div>
<div class="section" id="rotate-log-file">
<h5>Rotate log file<a class="headerlink" href="#rotate-log-file" title="Permalink to this headline">¶</a></h5>
<p>Eve-log can be configured to rotate based on time.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">-%</span><span class="n">Y</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">d</span><span class="o">-%</span><span class="n">H</span><span class="p">:</span><span class="o">%</span><span class="n">M</span><span class="o">.</span><span class="n">json</span>
      <span class="n">rotate</span><span class="o">-</span><span class="n">interval</span><span class="p">:</span> <span class="n">minute</span>
</pre></div>
</div>
<p>The example above creates a new log file each minute, where the filename contains
a timestamp. Other supported <code class="docutils literal notranslate"><span class="pre">rotate-interval</span></code> values are <code class="docutils literal notranslate"><span class="pre">hour</span></code> and <code class="docutils literal notranslate"><span class="pre">day</span></code>.</p>
<p>In addition to this, it is also possible to specify the <code class="docutils literal notranslate"><span class="pre">rotate-interval</span></code> as a
relative value. One example is to rotate the log file each X seconds.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">-%</span><span class="n">Y</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">d</span><span class="o">-%</span><span class="n">H</span><span class="p">:</span><span class="o">%</span><span class="n">M</span><span class="p">:</span><span class="o">%</span><span class="n">S</span><span class="o">.</span><span class="n">json</span>
      <span class="n">rotate</span><span class="o">-</span><span class="n">interval</span><span class="p">:</span> <span class="mi">30</span><span class="n">s</span>
</pre></div>
</div>
<p>The example above rotates eve-log each 30 seconds. This could be replaced with
<code class="docutils literal notranslate"><span class="pre">30m</span></code> to rotate every 30 minutes, <code class="docutils literal notranslate"><span class="pre">30h</span></code> to rotate every 30 hours, <code class="docutils literal notranslate"><span class="pre">30d</span></code>
to rotate every 30 days, or <code class="docutils literal notranslate"><span class="pre">30w</span></code> to rotate every 30 weeks.</p>
</div>
<div class="section" id="multiple-logger-instances">
<span id="multiple-eve-instances"></span><h5>Multiple Logger Instances<a class="headerlink" href="#multiple-logger-instances" title="Permalink to this headline">¶</a></h5>
<p>It is possible to have multiple 'EVE' instances, for example the following is valid:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">file</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">-</span><span class="n">ips</span><span class="o">.</span><span class="n">json</span>
      <span class="n">types</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">alert</span>
        <span class="o">-</span> <span class="n">drop</span>

  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">file</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">-</span><span class="n">nsm</span><span class="o">.</span><span class="n">json</span>
      <span class="n">types</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">http</span>
        <span class="o">-</span> <span class="n">dns</span>
        <span class="o">-</span> <span class="n">tls</span>
</pre></div>
</div>
<p>So here the alerts and drops go into 'eve-ips.json', while http, dns and tls go into 'eve-nsm.json'.</p>
<p>With the exception of <code class="docutils literal notranslate"><span class="pre">drop</span></code>, you can specify multiples of the same
logger type, however, <code class="docutils literal notranslate"><span class="pre">drop</span></code> can only be used once.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The use of independent json loggers such as alert-json-log,
dns-json-log, etc. has been deprecated and will be removed
by June 2020. Please use multiple eve-log instances as
documented above instead. Please see the <a class="reference external" href="https://suricata.io/our-story/deprecation-policy/">deprecation
policy</a> for more information.</p>
</div>
</div>
<div class="section" id="file-permissions">
<h5>File permissions<a class="headerlink" href="#file-permissions" title="Permalink to this headline">¶</a></h5>
<p>Log file permissions can be set individually for each logger. <code class="docutils literal notranslate"><span class="pre">filemode</span></code> can be used to
control the permissions of a log file, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
      <span class="n">filemode</span><span class="p">:</span> <span class="mi">600</span>
</pre></div>
</div>
<p>The example above sets the file permissions on <code class="docutils literal notranslate"><span class="pre">eve.json</span></code> to 600, which means that it is
only readable and writable by the owner of the file.</p>
</div>
<div class="section" id="json-flags">
<h5>JSON flags<a class="headerlink" href="#json-flags" title="Permalink to this headline">¶</a></h5>
<p>Several flags can be specified to control the JSON output in EVE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">json</span><span class="p">:</span>
        <span class="c1"># Sort object keys in the same order as they were inserted</span>
        <span class="n">preserve</span><span class="o">-</span><span class="n">order</span><span class="p">:</span> <span class="n">yes</span>

        <span class="c1"># Make the output more compact</span>
        <span class="n">compact</span><span class="p">:</span> <span class="n">yes</span>

        <span class="c1"># Escape all unicode characters outside the ASCII range</span>
        <span class="n">ensure</span><span class="o">-</span><span class="n">ascii</span><span class="p">:</span> <span class="n">yes</span>

        <span class="c1"># Escape the &#39;/&#39; characters in string with &#39;\/&#39;</span>
        <span class="n">escape</span><span class="o">-</span><span class="n">slash</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>All these flags are enabled by default, and can be modified per EVE instance.</p>
</div>
<div class="section" id="community-flow-id">
<h5>Community Flow ID<a class="headerlink" href="#community-flow-id" title="Permalink to this headline">¶</a></h5>
<p>Often Suricata is used in combination with other tools like Bro/Zeek. Enabling
the community-id option in the eve-log section adds a new <code class="docutils literal notranslate"><span class="pre">community_id</span></code>
field to each output.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2003-12-16T13:21:44.891921+0000&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">1332028388187153</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;alert&quot;</span><span class="p">,</span>
  <span class="o">...</span>
  <span class="s2">&quot;community_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1:LQU9qZlK+B5F3KDmev6m5PMibrg=&quot;</span><span class="p">,</span>
  <span class="s2">&quot;alert&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;allowed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gid&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;signature_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2003-12-16T13:21:45.037333+0000&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">1332028388187153</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;flow&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;pkts_toserver&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;pkts_toclient&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;bytes_toserver&quot;</span><span class="p">:</span> <span class="mi">338</span><span class="p">,</span>
    <span class="s2">&quot;bytes_toclient&quot;</span><span class="p">:</span> <span class="mi">272</span><span class="p">,</span>
    <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;2003-12-16T13:21:44.891921+0000&quot;</span><span class="p">,</span>
    <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="s2">&quot;2003-12-16T13:21:45.346457+0000&quot;</span><span class="p">,</span>
    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;closed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;alerted&quot;</span><span class="p">:</span> <span class="n">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;community_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1:LQU9qZlK+B5F3KDmev6m5PMibrg=&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="options">
<h6>Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h6>
<p>The output can be enabled per instance of the EVE logger.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">community-id</span></code> option is boolean. If set to <code class="docutils literal notranslate"><span class="pre">true</span></code> it is enabled.
The <code class="docutils literal notranslate"><span class="pre">community-id-seed</span></code> option specifies a unsigned 16 bit value that
is used a seed to the hash that is calculated for the <code class="docutils literal notranslate"><span class="pre">community-id</span></code>
output. This must be set to the same value on all tools that output this
record.</p>
<p>YAML:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
    <span class="c1"># Community Flow ID</span>
    <span class="c1"># Adds a &#39;community_id&#39; field to EVE records. These are meant to give</span>
    <span class="c1"># a records a predictable flow id that can be used to match records to</span>
    <span class="c1"># output of other tools such as Bro.</span>
    <span class="c1">#</span>
    <span class="c1"># Takes a &#39;seed&#39; that needs to be same across sensors and tools</span>
    <span class="c1"># to make the id less predictable.</span>

    <span class="c1"># enable/disable the community id feature.</span>
    <span class="n">community</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="n">false</span>
    <span class="c1"># Seed value for the ID output. Valid values are 0-65535.</span>
    <span class="n">community</span><span class="o">-</span><span class="nb">id</span><span class="o">-</span><span class="n">seed</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<div class="section" id="multi-tenancy">
<h7>Multi Tenancy<a class="headerlink" href="#multi-tenancy" title="Permalink to this headline">¶</a></h7>
<p>Suricata can be configured to support multiple tenants with different detection
engine configurations. When these tenants are configured and the detection
engine is running then all EVE logging will also report the <code class="docutils literal notranslate"><span class="pre">tenant_id</span></code> field
for traffic matching a specific tenant.</p>
</div>
</div>
</div>
</div>
<span id="document-output/eve/eve-json-format"></span><div class="section" id="eve-json-format">
<span id="id1"></span><h4>Eve JSON Format<a class="headerlink" href="#eve-json-format" title="Permalink to this headline">¶</a></h4>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-04-07T22:24:37.251547+0100&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">586497171462735</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">53381</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;alert&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.2.14&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">50096</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;209.53.113.5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;flowbits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;http.dottedquadhost&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">&quot;alert&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;allowed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gid&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;signature_id&quot;</span><span class="p">:</span> <span class="mi">2018358</span><span class="p">,</span>
    <span class="s2">&quot;rev&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;signature&quot;</span><span class="p">:</span> <span class="s2">&quot;ET HUNTING GENERIC SUSPICIOUS POST to Dotted Quad with Fake Browser 1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;Potentially Bad Traffic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">},</span>
  <span class="s2">&quot;app_proto&quot;</span><span class="p">:</span> <span class="s2">&quot;http&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="common-section">
<h5>Common Section<a class="headerlink" href="#common-section" title="Permalink to this headline">¶</a></h5>
<p>All the JSON log types share a common structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2009-11-24T21:27:09.534255&quot;</span><span class="p">,</span><span class="s2">&quot;event_type&quot;</span><span class="p">:</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span> <span class="o">...</span><span class="n">tuple</span><span class="o">...</span> <span class="p">,</span><span class="s2">&quot;TYPE&quot;</span><span class="p">:{</span> <span class="o">...</span> <span class="nb">type</span> <span class="n">specific</span> <span class="n">content</span> <span class="o">...</span> <span class="p">}}</span>
</pre></div>
</div>
<div class="section" id="event-types">
<h6>Event types<a class="headerlink" href="#event-types" title="Permalink to this headline">¶</a></h6>
<p>The common part has a field &quot;event_type&quot; to indicate the log type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;event_type&quot;</span><span class="p">:</span><span class="s2">&quot;TYPE&quot;</span>
</pre></div>
</div>
<p>When an application layer protocol event is detected, the common section will
have an <code class="docutils literal notranslate"><span class="pre">app_proto</span></code> field.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;app_proto&quot;</span><span class="p">:</span> <span class="s2">&quot;http&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="pcap-fields">
<h6>PCAP fields<a class="headerlink" href="#pcap-fields" title="Permalink to this headline">¶</a></h6>
<p>If Suricata is processing a pcap file, additional fields are added:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">123</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pcap_cnt</span></code> contains the packet number in the pcap. This can be used to look
up a packet in Wireshark for example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;pcap_filename&quot;</span><span class="p">:</span><span class="s2">&quot;/path/to/file.pcap&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pcap_filename</span></code> contains the file name and location of the pcap that
generated the event.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the pcap fields are only available on &quot;real&quot; packets, and are
omitted from internal &quot;pseudo&quot; packets such as flow timeout
packets.</p>
</div>
</div>
</div>
<div class="section" id="event-type-alert">
<h5>Event type: Alert<a class="headerlink" href="#event-type-alert" title="Permalink to this headline">¶</a></h5>
<p>This field contains data about a signature that matched, such as
<code class="docutils literal notranslate"><span class="pre">signature_id</span></code> (<code class="docutils literal notranslate"><span class="pre">sid</span></code> in the rule) and the <code class="docutils literal notranslate"><span class="pre">signature</span></code> (<code class="docutils literal notranslate"><span class="pre">msg</span></code> in the
rule).</p>
<p>It can also contain information about Source and Target of the attack in the
<code class="docutils literal notranslate"><span class="pre">alert.source</span></code> and <code class="docutils literal notranslate"><span class="pre">alert.target</span></code> field if target keyword is used in
the signature.</p>
<p>This event will also have the <code class="docutils literal notranslate"><span class="pre">pcap_cnt</span></code> field, when running in pcap mode, to
indicate which packet triggered the signature.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;alert&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;allowed&quot;</span><span class="p">,</span>
  <span class="s2">&quot;gid&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;signature_id&quot;</span><span class="p">:</span> <span class="mi">2024056</span><span class="p">,</span>
  <span class="s2">&quot;rev&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">&quot;signature&quot;</span><span class="p">:</span> <span class="s2">&quot;ET MALWARE Win32/CryptFile2 / Revenge Ransomware Checkin M3&quot;</span><span class="p">,</span>
  <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;Malware Command and Control Activity Detected&quot;</span><span class="p">,</span>
  <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;affected_product&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Windows_XP_Vista_7_8_10_Server_32_64_Bit&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;attack_target&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Client_Endpoint&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;2017_03_15&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;deployment&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Perimeter&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;former_category&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;MALWARE&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;malware_family&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;CryptFile2&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;performance_impact&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Moderate&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;signature_severity&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Major&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;2020_08_04&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
</pre></div>
</div>
<div class="section" id="action-field">
<h6>Action field<a class="headerlink" href="#action-field" title="Permalink to this headline">¶</a></h6>
<p>Possible values: &quot;allowed&quot; and &quot;blocked&quot;.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;action&quot;</span><span class="p">:</span><span class="s2">&quot;allowed&quot;</span>
</pre></div>
</div>
<p>Action is set to &quot;allowed&quot; unless a rule used the &quot;drop&quot; action and Suricata is
in IPS mode, or when the rule used the &quot;reject&quot; action. It is important to note
that this does not necessarily indicate the final verdict for a given packet or
flow, since one packet may match on several rules.</p>
</div>
<div class="section" id="verdict">
<span id="verdict-alert"></span><h6>Verdict<a class="headerlink" href="#verdict" title="Permalink to this headline">¶</a></h6>
<p>An object containning info on the final action that will be applied to a given
packet, based on all the signatures triggered by it and other possible events
(e.g., a flow drop). For that reason, it is possible for an alert with
an action <code class="docutils literal notranslate"><span class="pre">allowed</span></code> to have a verdict <code class="docutils literal notranslate"><span class="pre">drop</span></code>, in IPS mode, for instance, if
that packet was dropped due to a different alert.</p>
<ul class="simple">
<li>Action: <code class="docutils literal notranslate"><span class="pre">alert</span></code>, <code class="docutils literal notranslate"><span class="pre">pass</span></code>, <code class="docutils literal notranslate"><span class="pre">drop</span></code> (this latter only occurs in IPS mode)</li>
<li>Reject-target: <code class="docutils literal notranslate"><span class="pre">to_server</span></code>, <code class="docutils literal notranslate"><span class="pre">to_client</span></code>, <code class="docutils literal notranslate"><span class="pre">both</span></code> (only occurs for 'reject' rules)</li>
<li>Reject: an array of strings with possible reject types: <code class="docutils literal notranslate"><span class="pre">tcp-reset</span></code>,
<code class="docutils literal notranslate"><span class="pre">icmp-prohib</span></code> (only occurs for 'reject' rules)</li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;verdict&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;drop&quot;</span><span class="p">,</span>
   <span class="s2">&quot;reject-target&quot;</span><span class="p">:</span> <span class="s2">&quot;to_client&quot;</span><span class="p">,</span>
   <span class="s2">&quot;reject&quot;</span><span class="p">:</span> <span class="s2">&quot;[icmp-prohib]&quot;</span>
 <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pcap-field">
<h6>Pcap Field<a class="headerlink" href="#pcap-field" title="Permalink to this headline">¶</a></h6>
<p>If pcap log capture is active in <cite>multi</cite> mode, a <cite>capture_file</cite> key will be added to the event
with value being the full path of the pcap file where the corresponding packets
have been extracted.</p>
</div>
</div>
<div class="section" id="event-type-anomaly">
<h5>Event type: Anomaly<a class="headerlink" href="#event-type-anomaly" title="Permalink to this headline">¶</a></h5>
<p>Events with type &quot;anomaly&quot; report unexpected conditions such as truncated
packets, packets with invalid values, events that render the packet invalid
for further processing or unexpected behaviors.</p>
<p>Networks which experience high occurrences of anomalies may experience packet
processing degradation when anomaly logging is enabled.</p>
<div class="section" id="fields">
<h6>Fields<a class="headerlink" href="#fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;type&quot;: Either &quot;decode&quot;, &quot;stream&quot; or &quot;applayer&quot;. In rare cases, type will be
&quot;unknown&quot;. When this occurs, an additional field named &quot;code&quot; will be
present. Events with type
&quot;applayer&quot; are detected by the application layer parsers.</li>
<li>&quot;event&quot; The name of the anomalous event. Events of type &quot;decode&quot; are prefixed
with &quot;decoder&quot;; events of type &quot;stream&quot; are prefixed with &quot;stream&quot;.</li>
<li>&quot;code&quot; If &quot;type&quot; is &quot;unknown&quot;, than &quot;code&quot; contains the unrecognized event
code. Otherwise, this field is not present.</li>
</ul>
<p>The following field is included when &quot;type&quot; has the value &quot;applayer&quot;:</p>
<ul class="simple">
<li>&quot;layer&quot; Indicates the handling layer that detected the event. This will be
&quot;proto_parser&quot; (protocol parser), &quot;proto_detect&quot; (protocol detection) or
&quot;parser.&quot;</li>
</ul>
<p>When <code class="docutils literal notranslate"><span class="pre">packethdr</span></code> is enabled, the first 32 bytes of the packet are included
as a byte64-encoded blob in the main part of record. This applies to events
of &quot;type&quot; &quot;packet&quot; or &quot;stream&quot; only.</p>
</div>
<div class="section" id="examples">
<h6>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h6>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;decode&quot;</span><span class="p">,</span>
  <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;decoder.icmpv4.unknown_type&quot;</span>
<span class="p">}</span>

<span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;decode&quot;</span><span class="p">,</span>
  <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;decoder.udp.pkt_too_small&quot;</span>
<span class="p">}</span>

<span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;decode&quot;</span><span class="p">,</span>
  <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;decoder.ipv4.wrong_ip_version&quot;</span>
<span class="p">}</span>

<span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;stream&quot;</span><span class="p">,</span>
  <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;stream.pkt_invalid_timestamp&quot;</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1969-12-31T16:04:21.000000-0800&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">9262</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;anomaly&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;208.21.2.184&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.1.1.99&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;UDP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;packet&quot;</span><span class="p">:</span> <span class="s2">&quot;////////AQEBAQEBCABFAAA8xZ5AAP8R1+DQFQK4CgE=&quot;</span><span class="p">,</span>
  <span class="s2">&quot;packet_info&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;linktype&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;decode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;decoder.udp.pkt_too_small&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-01-11T05:10:54.612110-0800&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">412547343494194</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">1391293</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;anomaly&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.122.149&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">49324</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;69.195.71.174&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;app_proto&quot;</span><span class="p">:</span> <span class="s2">&quot;tls&quot;</span><span class="p">,</span>
  <span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;applayer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;APPLAYER_DETECT_PROTOCOL_ONLY_ONE_DIRECTION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;layer&quot;</span><span class="p">:</span> <span class="s2">&quot;proto_detect&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-01-11T05:10:52.828802-0800&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">201217772575257</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">1391281</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;anomaly&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.122.149&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">49323</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;69.195.71.174&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;app_proto&quot;</span><span class="p">:</span> <span class="s2">&quot;tls&quot;</span><span class="p">,</span>
  <span class="s2">&quot;anomaly&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;applayer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;INVALID_RECORD_TYPE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;layer&quot;</span><span class="p">:</span> <span class="s2">&quot;proto_parser&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-http">
<h5>Event type: HTTP<a class="headerlink" href="#event-type-http" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id2">
<h6>Fields<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;hostname&quot;: The hostname this HTTP event is attributed to</li>
<li>&quot;url&quot;: URL at the hostname that was accessed</li>
<li>&quot;http_user_agent&quot;: The user-agent of the software that was used</li>
<li>&quot;http_content_type&quot;: The type of data returned (ex: application/x-gzip)</li>
<li>&quot;cookie&quot;</li>
</ul>
<p>In addition to these fields, if the extended logging is enabled in the
suricata.yaml file the following fields are (can) also included:</p>
<ul class="simple">
<li>&quot;length&quot;: The content size of the HTTP body</li>
<li>&quot;status&quot;: HTTP status code</li>
<li>&quot;protocol&quot;: Protocol / Version of HTTP (ex: HTTP/1.1)</li>
<li>&quot;http_method&quot;: The HTTP method (ex: GET, POST, HEAD)</li>
<li>&quot;http_refer&quot;: The referer for this action</li>
</ul>
<p>In addition to the extended logging fields one can also choose to enable/add
from more than 50 additional custom logging HTTP fields enabled in the
suricata.yaml file. The additional fields can be enabled as following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">file</span> <span class="c1">#file|syslog|unix_dgram|unix_stream</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># the following are valid when type: syslog above</span>
    <span class="c1">#identity: &quot;suricata&quot;</span>
    <span class="c1">#facility: local5</span>
    <span class="c1">#level: Info ## possible levels: Emergency, Alert, Critical,</span>
                 <span class="c1">## Error, Warning, Notice, Info, Debug</span>
    <span class="n">types</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">alert</span>
      <span class="o">-</span> <span class="n">http</span><span class="p">:</span>
          <span class="n">extended</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># enable this for extended logging information</span>
          <span class="c1"># custom allows additional http fields to be included in eve-log</span>
          <span class="c1"># the example below adds three additional fields when uncommented</span>
          <span class="c1">#custom: [Accept-Encoding, Accept-Language, Authorization]</span>
          <span class="n">custom</span><span class="p">:</span> <span class="p">[</span><span class="n">accept</span><span class="p">,</span> <span class="n">accept</span><span class="o">-</span><span class="n">charset</span><span class="p">,</span> <span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="p">,</span> <span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="p">,</span>
          <span class="n">accept</span><span class="o">-</span><span class="n">datetime</span><span class="p">,</span> <span class="n">authorization</span><span class="p">,</span> <span class="n">cache</span><span class="o">-</span><span class="n">control</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span>
          <span class="nb">max</span><span class="o">-</span><span class="n">forwards</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">pragma</span><span class="p">,</span> <span class="n">proxy</span><span class="o">-</span><span class="n">authorization</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">te</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span>
          <span class="n">x</span><span class="o">-</span><span class="n">requested</span><span class="o">-</span><span class="k">with</span><span class="p">,</span> <span class="n">dnt</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="n">forwarded</span><span class="o">-</span><span class="n">proto</span><span class="p">,</span> <span class="n">accept</span><span class="o">-</span><span class="nb">range</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span>
          <span class="n">allow</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">content</span><span class="o">-</span><span class="n">encoding</span><span class="p">,</span> <span class="n">content</span><span class="o">-</span><span class="n">language</span><span class="p">,</span>
          <span class="n">content</span><span class="o">-</span><span class="n">length</span><span class="p">,</span> <span class="n">content</span><span class="o">-</span><span class="n">location</span><span class="p">,</span> <span class="n">content</span><span class="o">-</span><span class="n">md5</span><span class="p">,</span> <span class="n">content</span><span class="o">-</span><span class="nb">range</span><span class="p">,</span>
          <span class="n">content</span><span class="o">-</span><span class="nb">type</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">etags</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">last</span><span class="o">-</span><span class="n">modified</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span>
          <span class="n">proxy</span><span class="o">-</span><span class="n">authenticate</span><span class="p">,</span> <span class="n">referer</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">retry</span><span class="o">-</span><span class="n">after</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span>
          <span class="nb">set</span><span class="o">-</span><span class="n">cookie</span><span class="p">,</span> <span class="n">trailer</span><span class="p">,</span> <span class="n">transfer</span><span class="o">-</span><span class="n">encoding</span><span class="p">,</span> <span class="n">upgrade</span><span class="p">,</span> <span class="n">vary</span><span class="p">,</span> <span class="n">warning</span><span class="p">,</span>
          <span class="n">www</span><span class="o">-</span><span class="n">authenticate</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="n">flash</span><span class="o">-</span><span class="n">version</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="n">authenticated</span><span class="o">-</span><span class="n">user</span><span class="p">]</span>
</pre></div>
</div>
<p>The benefits here of using the extended logging is to see if this action for
example was a POST or perhaps if a download of an executable actually returned
any bytes.</p>
<p>It is also possible to dump every header for HTTP requests/responses or both
via the keyword <code class="docutils literal notranslate"><span class="pre">dump-all-headers</span></code>.</p>
</div>
<div class="section" id="id3">
<h6>Examples<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h6>
<p>Event with non-extended logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;www.digip.org&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span> <span class="p">:</span><span class="s2">&quot;\/jansson\/releases\/jansson-2.6.tar.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_user_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;User-Agent&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;application\/x-gzip&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In case the hostname shows a port number, such as in case there is a header &quot;Host: www.test.org:1337&quot;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;http_port&quot;</span><span class="p">:</span> <span class="mi">1337</span><span class="p">,</span>
    <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;www.test.org&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span> <span class="p">:</span><span class="s2">&quot;\/this\/is\/test.tar.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_user_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;User-Agent&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;application\/x-gzip&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Event with extended logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;direkte.vg.no&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="p">:</span><span class="s2">&quot;.....&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_user_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;User-Agent&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;application\/json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_refer&quot;</span><span class="p">:</span> <span class="s2">&quot;http:\/\/www.vg.no\/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP\/1.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span>
    <span class="s2">&quot;length&quot;</span><span class="p">:</span><span class="mi">310</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Event with <code class="docutils literal notranslate"><span class="pre">dump-all-headers</span></code> set to &quot;both&quot;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;test.co.uk&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="p">:</span><span class="s2">&quot;\/test\/file.json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_user_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;User-Agent&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;application\/json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_refer&quot;</span><span class="p">:</span> <span class="s2">&quot;http:\/\/www.test.com\/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http_method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP\/1.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span>
    <span class="s2">&quot;length&quot;</span><span class="p">:</span><span class="mi">310</span><span class="p">,</span>
    <span class="s2">&quot;request_headers&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;User-Agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Wget/1.13.4 (linux-gnu)&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Accept&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;*/*&quot;</span>
        <span class="p">},</span>
    <span class="p">],</span>
    <span class="s2">&quot;response_headers&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Wed, 25 Mar 2015 15:40:41 GMT&quot;</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-dns">
<h5>Event type: DNS<a class="headerlink" href="#event-type-dns" title="Permalink to this headline">¶</a></h5>
<p>A new version of dns logging has been introduced to improve how dns answers
are logged.</p>
<p>With that new version, dns answers are logged in one event
rather than an event for each answer.</p>
<p>It's possible to customize how a dns answer will be logged with the following
formats:</p>
<ul class="simple">
<li>&quot;detailed&quot;: &quot;rrname&quot;, &quot;rrtype&quot;, &quot;rdata&quot; and &quot;ttl&quot; fields are logged for each answer</li>
<li>&quot;grouped&quot;: answers logged are aggregated by their type (A, AAAA, NS, ...)</li>
</ul>
<p>It will be still possible to use the old DNS logging format, you can control it
with &quot;version&quot; option in dns configuration section.</p>
<div class="section" id="id4">
<h6>Fields<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h6>
<p>Outline of fields seen in the different kinds of DNS events:</p>
<ul class="simple">
<li>&quot;type&quot;: Indicating DNS message type, can be &quot;answer&quot; or &quot;query&quot;.</li>
<li>&quot;id&quot;: Identifier field</li>
<li>&quot;version&quot;: Indicating DNS logging version in use</li>
<li>&quot;flags&quot;: Indicating DNS answer flag, in hexadecimal (ex: 8180 , please note 0x is not output)</li>
<li>&quot;qr&quot;: Indicating in case of DNS answer flag, Query/Response flag (ex: true if set)</li>
<li>&quot;aa&quot;: Indicating in case of DNS answer flag, Authoritative Answer flag (ex: true if set)</li>
<li>&quot;tc&quot;: Indicating in case of DNS answer flag, Truncation flag (ex: true if set)</li>
<li>&quot;rd&quot;: Indicating in case of DNS answer flag, Recursion Desired flag (ex: true if set)</li>
<li>&quot;ra&quot;: Indicating in case of DNS answer flag, Recursion Available flag (ex: true if set)</li>
<li>&quot;z&quot;: Indicating in case of DNS answer flag, Reserved bit (ex: true if set)</li>
<li>&quot;rcode&quot;: (ex: NOERROR)</li>
<li>&quot;rrname&quot;: Resource Record Name (ex: a domain name)</li>
<li>&quot;rrtype&quot;: Resource Record Type (ex: A, AAAA, NS, PTR)</li>
<li>&quot;rdata&quot;: Resource Data (ex: IP that domain name resolves to)</li>
<li>&quot;ttl&quot;: Time-To-Live for this resource record</li>
</ul>
<p>More complex DNS record types may log additional fields for resource data:</p>
<ul class="simple">
<li>&quot;soa&quot;: Section containing fields for the SOA (start of authority) record type<ul>
<li>&quot;mname&quot;: Primary name server for this zone</li>
<li>&quot;rname&quot;: Authority's mailbox</li>
<li>&quot;serial&quot;: Serial version number</li>
<li>&quot;refresh&quot;: Refresh interval (seconds)</li>
<li>&quot;retry&quot;: Retry interval (seconds)</li>
<li>&quot;expire&quot;: Upper time limit until zone is no longer authoritative (seconds)</li>
<li>&quot;minimum&quot;: Minimum ttl for records in this zone (seconds)</li>
</ul>
</li>
<li>&quot;sshfp&quot;: section containing fields for the SSHFP (ssh fingerprint) record type<ul>
<li>&quot;fingerprint&quot;: Hex format of the fingerprint (ex: <code class="docutils literal notranslate"><span class="pre">12:34:56:78:9a:bc:de:...</span></code>)</li>
<li>&quot;algo&quot;: Algorithm number (ex: 1 for RSA, 2 for DSS)</li>
<li>&quot;type&quot;: Fingerprint type (ex: 1 for SHA-1)</li>
</ul>
</li>
<li>&quot;srv&quot;: section containing fields for the SRV (location of services) record type<ul>
<li>&quot;target&quot;: Domain name of the target host (ex: <code class="docutils literal notranslate"><span class="pre">foo.bar.baz</span></code>)</li>
<li>&quot;priority&quot;: Target priority (ex: 20)</li>
<li>&quot;weight&quot;: Weight for target selection (ex: 1)</li>
<li>&quot;port&quot;: Port on this target host of this service (ex: 5060)</li>
</ul>
</li>
</ul>
<p>One can control which RR types are logged by using the &quot;types&quot; field in the
suricata.yaml file. If this field is not specified, all RR types are logged.
More than 50 values can be specified with this field as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">file</span> <span class="c1">#file|syslog|unix_dgram|unix_stream</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
    <span class="c1"># the following are valid when type: syslog above</span>
    <span class="c1">#identity: &quot;suricata&quot;</span>
    <span class="c1">#facility: local5</span>
    <span class="c1">#level: Info ## possible levels: Emergency, Alert, Critical,</span>
                 <span class="c1">## Error, Warning, Notice, Info, Debug</span>
    <span class="n">types</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">alert</span>
      <span class="o">-</span> <span class="n">dns</span><span class="p">:</span>
        <span class="c1"># Control logging of requests and responses:</span>
        <span class="c1"># - requests: enable logging of DNS queries</span>
        <span class="c1"># - responses: enable logging of DNS answers</span>
        <span class="c1"># By default both requests and responses are logged.</span>
        <span class="n">requests</span><span class="p">:</span> <span class="n">yes</span>
        <span class="n">responses</span><span class="p">:</span> <span class="n">yes</span>
        <span class="c1"># DNS record types to log, based on the query type.</span>
        <span class="c1"># Default: all.</span>
        <span class="c1">#types: [a, aaaa, cname, mx, ns, ptr, txt]</span>
        <span class="n">types</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">cname</span><span class="p">,</span> <span class="n">soa</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">mg</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span>
        <span class="n">wks</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">hinfo</span><span class="p">,</span> <span class="n">minfo</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">afsdb</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="n">isdn</span><span class="p">,</span>
        <span class="n">rt</span><span class="p">,</span> <span class="n">nsap</span><span class="p">,</span> <span class="n">nsapptr</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">gpos</span><span class="p">,</span> <span class="n">aaaa</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">nxt</span><span class="p">,</span>
        <span class="n">srv</span><span class="p">,</span> <span class="n">atma</span><span class="p">,</span> <span class="n">naptr</span><span class="p">,</span> <span class="n">kx</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">apl</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span>
        <span class="n">sshfp</span><span class="p">,</span> <span class="n">ipseckey</span><span class="p">,</span> <span class="n">rrsig</span><span class="p">,</span> <span class="n">nsec</span><span class="p">,</span> <span class="n">dnskey</span><span class="p">,</span> <span class="n">dhcid</span><span class="p">,</span> <span class="n">nsec3</span><span class="p">,</span>
        <span class="n">nsec3param</span><span class="p">,</span> <span class="n">tlsa</span><span class="p">,</span> <span class="n">hip</span><span class="p">,</span> <span class="n">cds</span><span class="p">,</span> <span class="n">cdnskey</span><span class="p">,</span> <span class="n">spf</span><span class="p">,</span> <span class="n">tkey</span><span class="p">,</span>
        <span class="n">tsig</span><span class="p">,</span> <span class="n">maila</span><span class="p">,</span> <span class="nb">any</span><span class="p">,</span> <span class="n">uri</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h6>Examples<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h6>
<p>Example of a DNS query for the IPv4 address of &quot;twitter.com&quot; (resource record type 'A'):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;dns&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span>
    <span class="s2">&quot;rrname&quot;</span><span class="p">:</span> <span class="s2">&quot;twitter.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rrtype&quot;</span><span class="p">:</span><span class="s2">&quot;A&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of a DNS answer with &quot;detailed&quot; format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;dns&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;answer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">45444</span><span class="p">,</span>
    <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="s2">&quot;8180&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qr&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;rd&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;rcode&quot;</span><span class="p">:</span> <span class="s2">&quot;NOERROR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;rrname&quot;</span><span class="p">:</span> <span class="s2">&quot;www.suricata.io&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rrtype&quot;</span><span class="p">:</span> <span class="s2">&quot;CNAME&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ttl&quot;</span><span class="p">:</span> <span class="mi">3324</span><span class="p">,</span>
        <span class="s2">&quot;rdata&quot;</span><span class="p">:</span> <span class="s2">&quot;suricata.io&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;rrname&quot;</span><span class="p">:</span> <span class="s2">&quot;suricata.io&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rrtype&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ttl&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;rdata&quot;</span><span class="p">:</span> <span class="s2">&quot;192.0.78.24&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;rrname&quot;</span><span class="p">:</span> <span class="s2">&quot;suricata.io&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rrtype&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ttl&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;rdata&quot;</span><span class="p">:</span> <span class="s2">&quot;192.0.78.25&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of a DNS answer with &quot;grouped&quot; format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;dns&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;answer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">18523</span><span class="p">,</span>
    <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="s2">&quot;8180&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qr&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;rd&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;rcode&quot;</span><span class="p">:</span> <span class="s2">&quot;NOERROR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;grouped&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;192.0.78.24&quot;</span><span class="p">,</span>
        <span class="s2">&quot;192.0.78.25&quot;</span>
      <span class="p">],</span>
      <span class="s2">&quot;CNAME&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;suricata.io&quot;</span>
      <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of a old DNS answer with an IPv4 (resource record type 'A') return:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;dns&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;answer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">16000</span><span class="p">,</span>
    <span class="s2">&quot;flags&quot;</span><span class="p">:</span><span class="s2">&quot;8180&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qr&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;rd&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;ra&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;rcode&quot;</span><span class="p">:</span><span class="s2">&quot;NOERROR&quot;</span>
    <span class="s2">&quot;rrname&quot;</span><span class="p">:</span> <span class="s2">&quot;twitter.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rrtype&quot;</span><span class="p">:</span><span class="s2">&quot;A&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ttl&quot;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;rdata&quot;</span><span class="p">:</span> <span class="s2">&quot;199.16.156.6&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-ftp">
<h5>Event type: FTP<a class="headerlink" href="#event-type-ftp" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id6">
<h6>Fields<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;command&quot;: The FTP command.</li>
<li>&quot;command_data&quot;: The data accompanying the command.</li>
<li>&quot;reply&quot;: The command reply, which may contain multiple lines, in array format.</li>
<li>&quot;completion_code&quot;: The 3-digit completion code. The first digit indicates whether the response is good, bad or incomplete. This
is also in array format and may contain multiple completion codes matching multiple reply lines.</li>
<li>&quot;dynamic_port&quot;: The dynamic port established for subsequent data transfers, when applicable, with a &quot;PORT&quot; or &quot;EPRT&quot; command.</li>
<li>&quot;mode&quot;: The type of FTP connection. Most connections are &quot;passive&quot; but may be &quot;active&quot;.</li>
<li>&quot;reply_received&quot;: Indicates whether a response was matched to the command. In some non-typical cases, a command may lack a response.</li>
</ul>
</div>
<div class="section" id="id7">
<h6>Examples<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h6>
<p>Example of regular FTP logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ftp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;RETR&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command_data&quot;</span><span class="p">:</span> <span class="s2">&quot;100KB.zip&quot;</span><span class="p">,</span>
  <span class="s2">&quot;reply&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;Opening BINARY mode data connection for 100KB.zip (102400 bytes).&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Transfer complete.&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;completion_code&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;150&quot;</span><span class="p">,</span>
    <span class="s2">&quot;226&quot;</span>
  <span class="p">],</span>
</pre></div>
</div>
<p>Example showing all fields:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ftp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;EPRT&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command_data&quot;</span><span class="p">:</span> <span class="s2">&quot;|2|2a01:e34:ee97:b130:8c3e:45ea:5ac6:e301|41813|&quot;</span><span class="p">,</span>
  <span class="s2">&quot;reply&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;EPRT command successful. Consider using EPSV.&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;completion_code&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;200&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;dynamic_port&quot;</span><span class="p">:</span> <span class="mi">41813</span><span class="p">,</span>
  <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
  <span class="s2">&quot;reply_received&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-ftp-data">
<h5>Event type: FTP_DATA<a class="headerlink" href="#event-type-ftp-data" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id8">
<h6>Fields<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;command&quot;: The FTP command associated with the event.</li>
<li>&quot;filename&quot;: The name of the involved file.</li>
</ul>
</div>
<div class="section" id="id9">
<h6>Examples<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h6>
<p>Example of FTP_DATA logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ftp_data&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;temp.txt&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;RETR&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-tls">
<h5>Event type: TLS<a class="headerlink" href="#event-type-tls" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id10">
<h6>Fields<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;subject&quot;: The subject field from the TLS certificate</li>
<li>&quot;issuer&quot;: The issuer field from the TLS certificate</li>
<li>&quot;session_resumed&quot;: This field has the value of &quot;true&quot; if the TLS session was resumed via a session id. If this field appears, &quot;subject&quot; and &quot;issuer&quot; do not appear, since a TLS certificate is not seen.</li>
</ul>
<p>If extended logging is enabled the following fields are also included:</p>
<ul class="simple">
<li>&quot;serial&quot;: The serial number of the TLS certificate</li>
<li>&quot;fingerprint&quot;: The (SHA1) fingerprint of the TLS certificate</li>
<li>&quot;sni&quot;: The Server Name Indication (SNI) extension sent by the client</li>
<li>&quot;version&quot;: The SSL/TLS version used</li>
<li>&quot;not_before&quot;: The NotBefore field from the TLS certificate</li>
<li>&quot;not_after&quot;: The NotAfter field from the TLS certificate</li>
<li>&quot;ja3&quot;: The JA3 fingerprint consisting of both a JA3 hash and a JA3 string</li>
<li>&quot;ja3s&quot;: The JA3S fingerprint consisting of both a JA3 hash and a JA3 string</li>
</ul>
<p>JA3 must be enabled in the Suricata config file (set 'app-layer.protocols.tls.ja3-fingerprints' to 'yes').</p>
<p>In addition to this, custom logging also allows the following fields:</p>
<ul class="simple">
<li>&quot;certificate&quot;: The TLS certificate base64 encoded</li>
<li>&quot;chain&quot;: The entire TLS certificate chain base64 encoded</li>
</ul>
</div>
<div class="section" id="id11">
<h6>Examples<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h6>
<p>Example of regular TLS logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;tls&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;C=US, ST=California, L=Mountain View, O=Google Inc, CN=*.google.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;issuerdn&quot;</span><span class="p">:</span> <span class="s2">&quot;C=US, O=Google Inc, CN=Google Internet Authority G2&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of regular TLS logging for resumed sessions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;tls&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;session_resumed&quot;</span><span class="p">:</span> <span class="n">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of extended TLS logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;tls&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;C=US, ST=California, L=Mountain View, O=Google Inc, CN=*.google.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;issuerdn&quot;</span><span class="p">:</span> <span class="s2">&quot;C=US, O=Google Inc, CN=Google Internet Authority G2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;serial&quot;</span><span class="p">:</span> <span class="s2">&quot;0C:00:99:B7:D7:54:C9:F6:77:26:31:7E:BA:EA:7C:1C&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fingerprint&quot;</span><span class="p">:</span> <span class="s2">&quot;8f:51:12:06:a0:cc:4e:cd:e8:a3:8b:38:f8:87:59:e5:af:95:ca:cd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sni&quot;</span><span class="p">:</span> <span class="s2">&quot;calendar.google.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;TLS 1.2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;notbefore&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-01-04T10:48:43&quot;</span><span class="p">,</span>
    <span class="s2">&quot;notafter&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-03-29T10:18:00&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of certificate logging using TLS custom logging (subject, sni, certificate):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;tls&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;C=US, ST=California, L=Mountain View, O=Google Inc, CN=*.googleapis.com</span>
    <span class="s2">&quot;sni&quot;</span><span class="p">:</span> <span class="s2">&quot;www.googleapis.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;certificate&quot;</span><span class="p">:</span> <span class="s2">&quot;MIIE3TCCA8WgAwIBAgIIQPsvobRZN0gwDQYJKoZIhvcNAQELBQAwSTELMA [...]&quot;</span>
 <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-tftp">
<h5>Event type: TFTP<a class="headerlink" href="#event-type-tftp" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id12">
<h6>Fields<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;packet&quot;: The operation code, can be &quot;read&quot; or &quot;write&quot; or &quot;error&quot;</li>
<li>&quot;file&quot;: The filename transported with the tftp protocol</li>
<li>&quot;mode&quot;: The mode field, can be &quot;octet&quot; or &quot;mail&quot; or &quot;netascii&quot; (or any combination of upper and lower case)</li>
</ul>
<p>Example of TFTP logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;tftp&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;packet&quot;</span><span class="p">:</span> <span class="s2">&quot;write&quot;</span><span class="p">,</span>
    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;rfc1350.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;octet&quot;</span>
 <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-smb">
<h5>Event type: SMB<a class="headerlink" href="#event-type-smb" title="Permalink to this headline">¶</a></h5>
<div class="section" id="smb-fields">
<h6>SMB Fields<a class="headerlink" href="#smb-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;id&quot; (integer): internal transaction id</li>
<li>&quot;dialect&quot; (string): the negotiated protocol dialect, or &quot;unknown&quot; if missing</li>
<li>&quot;command&quot; (string): command name. E.g. SMB2_COMMAND_CREATE or SMB1_COMMAND_WRITE_ANDX</li>
<li>&quot;status&quot; (string): status string. Can be both NT_STATUS or DOS_ERR and other variants</li>
<li>&quot;status_code&quot; (string): status code as hex string</li>
<li>&quot;session_id&quot; (integer): SMB2+ session_id. SMB1 user id.</li>
<li>&quot;tree_id&quot; (integer): Tree ID</li>
<li>&quot;filename&quot; (string): filename for CREATE and other commands.</li>
<li>&quot;disposition&quot; (string): requested disposition. E.g. FILE_OPEN, FILE_CREATE and FILE_OVERWRITE. See <a class="reference external" href="https://msdn.microsoft.com/en-us/library/ee442175.aspx#Appendix_A_Target_119">https://msdn.microsoft.com/en-us/library/ee442175.aspx#Appendix_A_Target_119</a></li>
<li>&quot;access&quot; (string): indication of how the file was opened. &quot;normal&quot; or &quot;delete on close&quot; (field is subject to change)</li>
<li>&quot;created&quot;, &quot;accessed&quot;, &quot;modified&quot;, &quot;changed&quot; (integer): timestamps in seconds since unix epoch</li>
<li>&quot;size&quot; (integer): size of the requested file</li>
<li>&quot;fuid&quot; (string): SMB2+ file GUID. SMB1 FID as hex.</li>
<li>&quot;share&quot; (string): share name.</li>
<li>&quot;share_type&quot; (string): FILE, PIPE, PRINT or unknown.</li>
<li>&quot;client_dialects&quot; (array of strings): list of SMB dialects the client speaks.</li>
<li>&quot;client_guid&quot; (string): client GUID</li>
<li>&quot;server_guid&quot; (string): server GUID</li>
<li>&quot;request.native_os&quot; (string): SMB1 native OS string</li>
<li>&quot;request.native_lm&quot; (string): SMB1 native Lan Manager string</li>
<li>&quot;response.native_os&quot; (string): SMB1 native OS string</li>
<li>&quot;response.native_lm&quot; (string): SMB1 native Lan Manager string</li>
</ul>
<p>Examples of SMB logging:</p>
<p>Pipe open:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB2_COMMAND_CREATE&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">4398046511201</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;atsvc&quot;</span><span class="p">,</span>
  <span class="s2">&quot;disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;FILE_OPEN&quot;</span><span class="p">,</span>
  <span class="s2">&quot;access&quot;</span><span class="p">:</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span>
  <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;accessed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;modified&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;changed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;fuid&quot;</span><span class="p">:</span> <span class="s2">&quot;0000004d-0000-0000-0005-0000ffffffff&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>File/pipe close:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;2.10&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB2_COMMAND_CLOSE&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">4398046511121</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Tree connect (share open):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;2.10&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB2_COMMAND_TREE_CONNECT&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">4398046511121</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;share&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">admin-pc</span><span class="se">\\</span><span class="s2">c$&quot;</span><span class="p">,</span>
  <span class="s2">&quot;share_type&quot;</span><span class="p">:</span> <span class="s2">&quot;FILE&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Dialect negotiation from SMB1 to SMB2 dialect 2.10:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;2.??&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB1_COMMAND_NEGOTIATE_PROTOCOL&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;client_dialects&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;PC NETWORK PROGRAM 1.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LANMAN1.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Windows for Workgroups 3.1a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LM1.2X002&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LANMAN2.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NT LM 0.12&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SMB 2.002&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SMB 2.???&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;server_guid&quot;</span><span class="p">:</span> <span class="s2">&quot;aec6e793-2b11-4019-2d95-55453a0ad2f1&quot;</span>
<span class="p">}</span>
<span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;2.10&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB2_COMMAND_NEGOTIATE_PROTOCOL&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;client_dialects&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;2.02&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2.10&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;client_guid&quot;</span><span class="p">:</span> <span class="s2">&quot;601985d2-aad9-11e7-8494-00088bb57f27&quot;</span><span class="p">,</span>
  <span class="s2">&quot;server_guid&quot;</span><span class="p">:</span> <span class="s2">&quot;aec6e793-2b11-4019-2d95-55453a0ad2f1&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>SMB1 partial SMB1_COMMAND_SESSION_SETUP_ANDX:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;native_os&quot;</span><span class="p">:</span> <span class="s2">&quot;Unix&quot;</span><span class="p">,</span>
  <span class="s2">&quot;native_lm&quot;</span><span class="p">:</span> <span class="s2">&quot;Samba 3.9.0-SVN-build-11572&quot;</span>
<span class="p">},</span>
<span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;native_os&quot;</span><span class="p">:</span> <span class="s2">&quot;Windows (TM) Code Name </span><span class="se">\&quot;</span><span class="s2">Longhorn</span><span class="se">\&quot;</span><span class="s2"> Ultimate 5231&quot;</span><span class="p">,</span>
  <span class="s2">&quot;native_lm&quot;</span><span class="p">:</span> <span class="s2">&quot;Windows (TM) Code Name </span><span class="se">\&quot;</span><span class="s2">Longhorn</span><span class="se">\&quot;</span><span class="s2"> Ultimate 6.0&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="dcerpc-fields">
<h6>DCERPC fields<a class="headerlink" href="#dcerpc-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;request&quot; (string): command. E.g. REQUEST, BIND.</li>
<li>&quot;response&quot; (string): reply. E.g. RESPONSE, BINDACK or FAULT.</li>
<li>&quot;opnum&quot; (integer): the opnum</li>
<li>&quot;call_id&quot; (integer): the call id</li>
<li>&quot;frag_cnt&quot; (integer): the number of fragments for the stub data</li>
<li>&quot;stub_data_size&quot;: total stub data size</li>
<li>&quot;interfaces&quot; (array): list of interfaces</li>
<li>&quot;interfaces.uuid&quot; (string): string representation of the UUID</li>
<li>&quot;interfaces.version&quot; (string): interface version</li>
<li>&quot;interfaces.ack_result&quot; (integer): ack result</li>
<li>&quot;interfaces.ack_reason&quot; (integer): ack reason</li>
</ul>
<p>DCERPC REQUEST/RESPONSE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB2_COMMAND_IOCTL&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">4398046511201</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;dcerpc&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;REQUEST&quot;</span><span class="p">,</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="s2">&quot;RESPONSE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;opnum&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;req&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;frag_cnt&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;stub_data_size&quot;</span><span class="p">:</span> <span class="mi">136</span>
    <span class="p">},</span>
    <span class="s2">&quot;res&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;frag_cnt&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;stub_data_size&quot;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">},</span>
    <span class="s2">&quot;call_id&quot;</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>DCERPC BIND/BINDACK:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">53</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;2.10&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB2_COMMAND_WRITE&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">35184439197745</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;dcerpc&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;BIND&quot;</span><span class="p">,</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="s2">&quot;BINDACK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;interfaces&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;12345778-1234-abcd-ef00-0123456789ac&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ack_result&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;ack_reason&quot;</span><span class="p">:</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;12345778-1234-abcd-ef00-0123456789ac&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ack_result&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;ack_reason&quot;</span><span class="p">:</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;12345778-1234-abcd-ef00-0123456789ac&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ack_result&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;ack_reason&quot;</span><span class="p">:</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;call_id&quot;</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-bittorrent-dht">
<h5>Event type: BITTORRENT-DHT<a class="headerlink" href="#event-type-bittorrent-dht" title="Permalink to this headline">¶</a></h5>
<div class="section" id="common-fields">
<h6>Common fields:<a class="headerlink" href="#common-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;transaction_id&quot; (hex): the unique id of the transaction, generated by node making the request (a.k.a the querying node). Same transaction_id is echoed back by responding nodes.</li>
<li>&quot;client_version&quot; (hex): identifies the type and version of the bittorrent-dht client. Some implementations may be missing this field.</li>
</ul>
</div>
<div class="section" id="extra-fields">
<h6>Extra fields:<a class="headerlink" href="#extra-fields" title="Permalink to this headline">¶</a></h6>
<p>Packets should also contain one of either the fields:</p>
<div class="line-block">
<div class="line">error</div>
</div>
<ul class="simple">
<li><dl class="first docutils">
<dt>&quot;error&quot;: details of an error which occurred while processing the request</dt>
<dd><ul class="first last">
<li>&quot;error.num&quot; (num): the error code</li>
<li>&quot;error.msg&quot; (string): the error message</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line">request_type and request</div>
</div>
<ul class="simple">
<li>&quot;request_type&quot; (string): the type of the request (a.k.a. the query). Included if this packet was a request</li>
<li><dl class="first docutils">
<dt>&quot;request&quot;: a request (a.k.a. a query) sent by the bittorrent-dht client</dt>
<dd><ul class="first last">
<li>&quot;request.id&quot; (hex): the node ID of the node which sent the request (20 bytes in network byte order)</li>
<li>&quot;request.target&quot; (hex): the target node ID. Used by the find_node request_type</li>
<li>&quot;request.info_hash&quot; (hex): info hash of target torrent (20 bytes). Used by the get_peers and announce_peer request_types</li>
<li>&quot;request.token&quot; (hex): token key received from previous get_peers request. Used by the announce_peer request type</li>
<li>&quot;request.implied_port&quot; (num): 0 or 1, if 1 ignore provided port and use source port of UDP packet. Used by the announce_peer request_type</li>
<li>&quot;request.port&quot; (num): port on which peer will download torrent. Used by the announce_peer request_type</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line">response</div>
</div>
<ul class="simple">
<li><dl class="first docutils">
<dt>&quot;response&quot;: a response to the client's request</dt>
<dd><ul class="first last">
<li>&quot;response.id&quot; (hex): the node ID of the node which sent the response (20 bytes in network byte order)</li>
<li>&quot;response.nodes&quot; (array): find_node/get_peers - a list of info objects for target node or K(8) closest good nodes in routing table</li>
<li>&quot;response.nodes6&quot; (array): find_node/get_peers - a list of info objects for target node or K(8) closest good nodes in routing table (ipv6)</li>
<li>&quot;response.values&quot; (array): list of compact peer info strings. Used by the get_peers request_type</li>
<li>&quot;response.token&quot; (hex): token key required for sender's future announce_peer query</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line">node object</div>
</div>
<ul class="simple">
<li>&quot;id&quot; (hex): node ID</li>
<li>&quot;ip&quot; (string): IPv4 or IPv6 address of node</li>
<li>&quot;port&quot; (integer): node port</li>
</ul>
<div class="line-block">
<div class="line">peer object (values array)</div>
</div>
<ul class="simple">
<li>&quot;ip&quot; (string): IPv6 or IPv6 address of node</li>
<li>&quot;port&quot; (integer): node port</li>
</ul>
</div>
<div class="section" id="id13">
<h6>Examples:<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h6>
<p>Ping and response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0c17&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;4c540126&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request_type&quot;</span><span class="p">:</span> <span class="s2">&quot;ping&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;41aff1580119f074e2f537f231f12adf684f0d1f&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0c17&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;5554b50c&quot;</span><span class="p">,</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;42aeb304a0845b3b9ee089327b48967b8e87b2e2&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Find_node and response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;420f0000&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;5554b50c&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request_type&quot;</span><span class="p">:</span> <span class="s2">&quot;find_node&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;37579bad1bad166af4329508096fae8c553c6cf4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;37579bad1bad166af4329508096fae8c553c6cf4&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Get_peers and response with values param:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;05e4&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;4c540126&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request_type&quot;</span><span class="p">:</span> <span class="s2">&quot;get_peers&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;41aff1580119f074e2f537f231f12adf684f0d1f&quot;</span><span class="p">,</span>
    <span class="s2">&quot;info_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;19a6fcfcba6cc2c6d371eb754074d095adb5d291&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;05e4&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;555462d6&quot;</span><span class="p">,</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;19a6f98be177e32e7b5bd77276d529f03e3ba8a9&quot;</span><span class="p">,</span>
    <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;45.238.190.2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">6881</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;185.70.52.245&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">51215</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;45.21.238.247&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">55909</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;62.28.248.195&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">6881</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;c17094641ca8844d711120baecb2b5cf25435614&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Get_peers and response with nodes param:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;44e6&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;4c540126&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request_type&quot;</span><span class="p">:</span> <span class="s2">&quot;get_peers&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;41aff1580119f074e2f537f231f12adf684f0d1f&quot;</span><span class="p">,</span>
    <span class="s2">&quot;info_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;19a6fcfcba6cc2c6d371eb754074d095adb5d291&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;44e6&quot;</span><span class="p">,</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;19a7c8f4f6d14d9f87a67671720633e551f30cb7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;45.22.252.153&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">36798</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;94.41.206.37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">30850</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;84.228.120.50&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">6881</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;178.81.206.84&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">12373</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;110.188.93.186&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">22223</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;c897ee539e02a54595b4d7cfb6319ad48e71b282&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Announce_peer and response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;aa&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request_type&quot;</span><span class="p">:</span> <span class="s2">&quot;announce_peer&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;abcdefghij0123456789&quot;</span><span class="p">,</span>
    <span class="s2">&quot;info_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;mnopqrstuvwxyz123456&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;aoeusnth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">6881</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;aa&quot;</span><span class="p">,</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;mnopqrstuvwxyz123456&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Announce_peer with implied_port param and response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;7fe9&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;4c540126&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request_type&quot;</span><span class="p">:</span> <span class="s2">&quot;announce_peer&quot;</span><span class="p">,</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;51bc83f53417a62a40e8a48170cad369a13fef3c&quot;</span><span class="p">,</span>
    <span class="s2">&quot;info_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;19a6fcfcba6cc2c6d371eb754074d095adb5d291&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;cacbef35&quot;</span><span class="p">,</span>
    <span class="s2">&quot;implied_port&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">54892</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;7fe9&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="s2">&quot;4c54012f&quot;</span><span class="p">,</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;19a66dece45e0288ab75d141e0255738a1ce8508&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Sample error responses:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;aa&quot;</span><span class="p">,</span>
  <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="mi">201</span><span class="p">,</span>
    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;A Generic Error Ocurred&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="s2">&quot;bittorrent_dht&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;aa&quot;</span><span class="p">,</span>
  <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="mi">203</span><span class="p">,</span>
    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Malformed Packet&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="ntlmssp-fields">
<h6>NTLMSSP fields<a class="headerlink" href="#ntlmssp-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;domain&quot; (string): the Windows domain.</li>
<li>&quot;user&quot; (string): the user.</li>
<li>&quot;host&quot; (string): the host.</li>
<li>&quot;version&quot; (string): the client version.</li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ntlmssp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="s2">&quot;VNET3&quot;</span><span class="p">,</span>
  <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;administrator&quot;</span><span class="p">,</span>
  <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;BLU&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;60.230 build 13699 rev 188&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>More complete example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;NT LM 0.12&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB1_COMMAND_SESSION_SETUP_ANDX&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;ntlmssp&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="s2">&quot;VNET3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;administrator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;BLU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;60.230 build 13699 rev 188&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;native_os&quot;</span><span class="p">:</span> <span class="s2">&quot;Unix&quot;</span><span class="p">,</span>
    <span class="s2">&quot;native_lm&quot;</span><span class="p">:</span> <span class="s2">&quot;Samba 3.9.0-SVN-build-11572&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;native_os&quot;</span><span class="p">:</span> <span class="s2">&quot;Windows (TM) Code Name </span><span class="se">\&quot;</span><span class="s2">Longhorn</span><span class="se">\&quot;</span><span class="s2"> Ultimate 5231&quot;</span><span class="p">,</span>
    <span class="s2">&quot;native_lm&quot;</span><span class="p">:</span> <span class="s2">&quot;Windows (TM) Code Name </span><span class="se">\&quot;</span><span class="s2">Longhorn</span><span class="se">\&quot;</span><span class="s2"> Ultimate 6.0&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="kerberos-fields">
<h6>Kerberos fields<a class="headerlink" href="#kerberos-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;kerberos.realm&quot; (string): the Kerberos Realm.</li>
<li>&quot;kerberos.snames (array of strings): snames.</li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;smb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;2.10&quot;</span><span class="p">,</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;SMB2_COMMAND_SESSION_SETUP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;STATUS_SUCCESS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="mi">35184439197745</span><span class="p">,</span>
  <span class="s2">&quot;tree_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;kerberos&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;realm&quot;</span><span class="p">:</span> <span class="s2">&quot;CONTOSO.LOCAL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;snames&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;cifs&quot;</span><span class="p">,</span>
      <span class="s2">&quot;DC1.contoso.local&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-ssh">
<h5>Event type: SSH<a class="headerlink" href="#event-type-ssh" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id14">
<h6>Fields<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;proto_version&quot;: The protocol version transported with the ssh protocol (1.x, 2.x)</li>
<li>&quot;software_version&quot;: The software version used by end user</li>
<li>&quot;hassh.hash&quot;: MD5 of hassh algorithms of client or server</li>
<li>&quot;hassh.string&quot;: hassh algorithms of client or server</li>
</ul>
<p>Hassh must be enabled in the Suricata config file (set 'app-layer.protocols.ssh.hassh' to 'yes').</p>
<p>Example of SSH logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ssh&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;proto_version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;software_version&quot;</span><span class="p">:</span> <span class="s2">&quot;OpenSSH_6.7&quot;</span><span class="p">,</span>
      <span class="s2">&quot;hassh&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;ec7378c1a92f5a8dde7e8b7a1ddf33d1&quot;</span><span class="p">,</span>
          <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="s2">&quot;curve25519-sha256,diffie-hellman-group14-sha256,diffie-hellman-group14-sha1,ext-info-c&quot;</span><span class="p">,</span>
      <span class="p">}</span>
   <span class="p">},</span>
  <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;proto_version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;software_version&quot;</span><span class="p">:</span> <span class="s2">&quot;OpenSSH_6.7&quot;</span><span class="p">,</span>
      <span class="s2">&quot;hassh&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;ec7378c1a92f5a8dde7e8b7a1ddf33d1&quot;</span><span class="p">,</span>
          <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="s2">&quot;curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256&quot;</span><span class="p">,</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-flow">
<h5>Event type: Flow<a class="headerlink" href="#event-type-flow" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id15">
<h6>Fields<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;pkts_toserver&quot;: total number of packets to server, include bypassed packets</li>
<li>&quot;pkts_toclient&quot;: total number of packets to client</li>
<li>&quot;bytes_toserver&quot;: total bytes count to server</li>
<li>&quot;bytes_toclient&quot;: total bytes count to client</li>
<li>&quot;bypassed.pkts_toserver&quot;: number of bypassed packets to server</li>
<li>&quot;bypassed.pkts_toclient&quot;: number of bypassed packets to client</li>
<li>&quot;bypassed.bytes_toserver&quot;: bypassed bytes count to server</li>
<li>&quot;bypassed.bytes_toclient&quot;: bypassed bytes count to client</li>
<li>&quot;start&quot;: date of start of the flow</li>
<li>&quot;end&quot;: date of end of flow (last seen packet)</li>
<li>&quot;age&quot;: duration of the flow</li>
<li>&quot;bypass&quot;: if the flow has been bypassed, it is set to &quot;local&quot; (internal bypass) or &quot;capture&quot;</li>
<li>&quot;state&quot;: display state of the flow (include &quot;new&quot;, &quot;established&quot;, &quot;closed&quot;, &quot;bypassed&quot;)</li>
<li>&quot;reason&quot;: mechanism that did trigger the end of the flow (include &quot;timeout&quot;, &quot;forced&quot; and &quot;shutdown&quot;)</li>
<li>&quot;alerted&quot;: &quot;true&quot; or &quot;false&quot; depending if an alert has been seen on flow</li>
</ul>
<p>Example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;flow&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;pkts_toserver&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
  <span class="s2">&quot;pkts_toclient&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
  <span class="s2">&quot;bytes_toserver&quot;</span><span class="p">:</span> <span class="mi">4884</span><span class="p">,</span>
  <span class="s2">&quot;bytes_toclient&quot;</span><span class="p">:</span> <span class="mi">7392</span><span class="p">,</span>
  <span class="s2">&quot;bypassed&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;pkts_toserver&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;pkts_toclient&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;bytes_toserver&quot;</span><span class="p">:</span> <span class="mi">1305</span><span class="p">,</span>
    <span class="s2">&quot;bytes_toclient&quot;</span><span class="p">:</span> <span class="mi">984</span>
  <span class="p">},</span>
  <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-05-28T23:32:29.025256+0200&quot;</span><span class="p">,</span>
  <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-05-28T23:35:28.071281+0200&quot;</span><span class="p">,</span>
  <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">179</span><span class="p">,</span>
  <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;capture&quot;</span><span class="p">,</span>
  <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;bypassed&quot;</span><span class="p">,</span>
  <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;timeout&quot;</span><span class="p">,</span>
  <span class="s2">&quot;alerted&quot;</span><span class="p">:</span> <span class="n">false</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-rdp">
<h5>Event type: RDP<a class="headerlink" href="#event-type-rdp" title="Permalink to this headline">¶</a></h5>
<p>Initial negotiations between RDP client and server are stored as transactions and logged.</p>
<p>Each RDP record contains a per-flow incrementing &quot;tx_id&quot; field.</p>
<p>The &quot;event_type&quot; field indicates an RDP event subtype. Possible values:</p>
<ul class="simple">
<li>&quot;initial_request&quot;</li>
<li>&quot;initial_response&quot;</li>
<li>&quot;connect_request&quot;</li>
<li>&quot;connect_response&quot;</li>
<li>&quot;tls_handshake&quot;</li>
</ul>
<div class="section" id="rdp-type-initial-request">
<h6>RDP type: Initial Request<a class="headerlink" href="#rdp-type-initial-request" title="Permalink to this headline">¶</a></h6>
<p>The optional &quot;cookie&quot; field is a string identifier the RDP client has chosen to provide.</p>
<p>The optional &quot;flags&quot; field is a list of client directives. Possible values:</p>
<ul class="simple">
<li>&quot;restricted_admin_mode_required&quot;</li>
<li>&quot;redirected_authentication_mode_required&quot;</li>
<li>&quot;correlation_info_present&quot;</li>
</ul>
</div>
<div class="section" id="rdp-type-initial-response">
<h6>RDP type: Initial Response<a class="headerlink" href="#rdp-type-initial-response" title="Permalink to this headline">¶</a></h6>
<p>In the event of a standard initial response:</p>
<p>The &quot;protocol&quot; field is the selected protocol. Possible values:</p>
<ul class="simple">
<li>&quot;rdp&quot;</li>
<li>&quot;ssl&quot;</li>
<li>&quot;hybrid&quot;</li>
<li>&quot;rds_tls&quot;</li>
<li>&quot;hybrid_ex&quot;</li>
</ul>
<p>The optional &quot;flags&quot; field is a list of support server modes. Possible values:</p>
<ul class="simple">
<li>&quot;extended_client_data&quot;</li>
<li>&quot;dynvc_gfx&quot;</li>
<li>&quot;restricted_admin&quot;</li>
<li>&quot;redirected_authentication&quot;</li>
</ul>
<p>Alternatively, in the event of an error-indicating initial response:</p>
<p>There will be no &quot;protocol&quot; or &quot;flags&quot; fields.</p>
<p>The &quot;error_code&quot; field will contain the numeric code provided by the RDP server.</p>
<p>The &quot;reason&quot; field will contain a text summary of this code. Possible values:</p>
<ul class="simple">
<li>&quot;ssl required by server&quot; (error code 0x1)</li>
<li>&quot;ssl not allowed by server&quot; (error code 0x2)</li>
<li>&quot;ssl cert not on server&quot; (error code 0x3)</li>
<li>&quot;inconsistent flags&quot; (error code 0x4)</li>
<li>&quot;hybrid required by server&quot; (error code 0x5)</li>
<li>&quot;ssl with user auth required by server&quot; (error code 0x6)</li>
</ul>
</div>
<div class="section" id="rdp-type-connect-request">
<h6>RDP type: Connect Request<a class="headerlink" href="#rdp-type-connect-request" title="Permalink to this headline">¶</a></h6>
<p>The optional &quot;channel&quot; field is a list of requested data channel names.</p>
<p>Common channels:</p>
<ul class="simple">
<li>&quot;rdpdr&quot; (device redirection)</li>
<li>&quot;cliprdr&quot; (shared clipboard)</li>
<li>&quot;rdpsnd&quot; (sound)</li>
</ul>
<p>The optional &quot;client&quot; field is a sub-object that may contain the following:</p>
<ul class="simple">
<li>&quot;version&quot;: RDP protocol version. Possible values are &quot;v4&quot;, &quot;v5&quot;, &quot;v10.0&quot;, &quot;v10.1&quot;, &quot;v10.2&quot;, &quot;v10.3&quot;, &quot;v10.4&quot;, &quot;v10.5&quot;, &quot;v10.6&quot;, &quot;v10.7&quot;, &quot;unknown&quot;.</li>
<li>&quot;desktop_width&quot;: Numeric desktop width value.</li>
<li>&quot;desktop_height&quot;: Numeric desktop height value.</li>
<li>&quot;color_depth&quot;: Numeric color depth. Possible values are 4, 8, 15, 16, 24.</li>
<li>&quot;keyboard_layout&quot;: Locale identifier name, e.g., &quot;en-US&quot;.</li>
<li>&quot;build&quot;: OS and SP level, e.g., &quot;Windows XP&quot;, &quot;Windows 7 SP1&quot;.</li>
<li>&quot;client_name&quot;: Client computer name.</li>
<li>&quot;keyboard_type&quot;: Possible values are &quot;xt&quot;, &quot;ico&quot;, &quot;at&quot;, &quot;enhanced&quot;, &quot;1050&quot;, &quot;9140&quot;, &quot;jp&quot;.</li>
<li>&quot;keyboard_subtype&quot;: Numeric code for keyboard.</li>
<li>&quot;function_keys&quot;: Number of function keys on client keyboard.</li>
<li>&quot;ime&quot;: Input method editor (IME) file name.</li>
<li>&quot;product_id&quot;: Product id string.</li>
<li>&quot;serial_number&quot;: Numeric value.</li>
<li>&quot;capabilities&quot;: List of any of the following: &quot;support_errinfo_pdf&quot;, &quot;want_32bpp_session&quot;, &quot;support_statusinfo_pdu&quot;, &quot;strong_asymmetric_keys&quot;, &quot;valid_connection_type&quot;, &quot;support_monitor_layout_pdu&quot;, &quot;support_netchar_autodetect&quot;, &quot;support_dynvc_gfx_protocol&quot;, &quot;support_dynamic_time_zone&quot;, &quot;support_heartbeat_pdu&quot;.</li>
<li>&quot;id&quot;: Client product id string.</li>
<li>&quot;connection_hint&quot;: Possible values are &quot;modem&quot;, &quot;low_broadband&quot;, &quot;satellite&quot;, &quot;high_broadband&quot;, &quot;wan&quot;, &quot;lan&quot;, &quot;autodetect&quot;.</li>
<li>&quot;physical_width&quot;: Numeric physical width of display.</li>
<li>&quot;physical_height&quot;: Numeric physical height of display.</li>
<li>&quot;desktop_orientation&quot;: Numeric angle of orientation.</li>
<li>&quot;scale_factor&quot;: Numeric scale factor of desktop.</li>
<li>&quot;device_scale_factor&quot;: Numeric scale factor of display.</li>
</ul>
</div>
<div class="section" id="rdp-type-connect-response">
<h6>RDP type: Connect Response<a class="headerlink" href="#rdp-type-connect-response" title="Permalink to this headline">¶</a></h6>
<p>With this event, the initial RDP negotiation is complete in terms of tracking and logging.</p>
</div>
<div class="section" id="rdp-type-tls-handshake">
<h6>RDP type: TLS Handshake<a class="headerlink" href="#rdp-type-tls-handshake" title="Permalink to this headline">¶</a></h6>
<p>With this event, the initial RDP negotiation is complete in terms of tracking and logging.</p>
<p>The session will use TLS encryption.</p>
<p>The &quot;x509_serials&quot; field is a list of observed certificate serial numbers, e.g., &quot;16ed2aa0495f259d4f5d99edada570d1&quot;.</p>
</div>
<div class="section" id="id16">
<h6>Examples<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h6>
<p>RDP logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;rdp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;initial_request&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;A70067&quot;</span>
<span class="p">}</span>

<span class="s2">&quot;rdp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;initial_response&quot;</span>
<span class="p">}</span>

<span class="s2">&quot;rdp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;connect_request&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;v5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;desktop_width&quot;</span><span class="p">:</span> <span class="mi">1152</span><span class="p">,</span>
    <span class="s2">&quot;desktop_height&quot;</span><span class="p">:</span> <span class="mi">864</span><span class="p">,</span>
    <span class="s2">&quot;color_depth&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="s2">&quot;keyboard_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build&quot;</span><span class="p">:</span> <span class="s2">&quot;Windows XP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;client_name&quot;</span><span class="p">:</span> <span class="s2">&quot;ISD2-KM84178&quot;</span><span class="p">,</span>
    <span class="s2">&quot;keyboard_type&quot;</span><span class="p">:</span> <span class="s2">&quot;enhanced&quot;</span><span class="p">,</span>
    <span class="s2">&quot;function_keys&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;capabilities&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;support_errinfo_pdf&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;55274-OEM-0011903-00107&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;rdpdr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cliprdr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rdpsnd&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="s2">&quot;rdp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;connect_response&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>RDP logging, with transition to TLS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;rdp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;initial_request&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;AWAKECODI&quot;</span>
<span class="p">}</span>

<span class="s2">&quot;rdp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;initial_response&quot;</span><span class="p">,</span>
  <span class="s2">&quot;server_supports&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;extended_client_data&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;hybrid&quot;</span>
<span class="p">}</span>

<span class="s2">&quot;rdp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;tls_handshake&quot;</span><span class="p">,</span>
  <span class="s2">&quot;x509_serials&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;16ed2aa0495f259d4f5d99edada570d1&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-rfb">
<h5>Event type: RFB<a class="headerlink" href="#event-type-rfb" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id17">
<h6>Fields<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;server_protocol_version.major&quot;, &quot;server_protocol_version.minor&quot;: The RFB protocol version offered by the server.</li>
<li>&quot;client_protocol_version.major&quot;, &quot;client_protocol_version.minor&quot;: The RFB protocol version agreed by the client.</li>
<li>&quot;authentication.security_type&quot;: Security type agreed upon in the logged transaction, e.g. <code class="docutils literal notranslate"><span class="pre">2</span></code> is VNC auth.</li>
<li>&quot;authentication.vnc.challenge&quot;, &quot;authentication.vnc.response&quot;: Only available when security type 2 is used. Contains the challenge and response byte buffers exchanged by the server and client as hex strings.</li>
<li>&quot;authentication.security-result&quot;: Result of the authentication process (<code class="docutils literal notranslate"><span class="pre">OK</span></code>, <code class="docutils literal notranslate"><span class="pre">FAIL</span></code> or <code class="docutils literal notranslate"><span class="pre">TOOMANY</span></code>).</li>
<li>&quot;screen_shared&quot;: Boolean value describing whether the client requested screen sharing.</li>
<li>&quot;framebuffer&quot;: Contains metadata about the initial screen setup process. Only available when the handshake completed this far.</li>
<li>&quot;framebuffer.width&quot;, &quot;framebuffer.height&quot;: Screen size as offered by the server.</li>
<li>&quot;framebuffer.name&quot;: Desktop name as advertised by the server.</li>
<li>&quot;framebuffer.pixel_format&quot;: Pixel representation information, such as color depth. See RFC6143 (<a class="reference external" href="https://tools.ietf.org/html/rfc6143">https://tools.ietf.org/html/rfc6143</a>) for details.</li>
</ul>
</div>
<div class="section" id="id18">
<h6>Examples<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h6>
<p>Example of RFB logging, with full VNC style authentication parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;rfb&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;server_protocol_version&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;major&quot;</span><span class="p">:</span> <span class="s2">&quot;003&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minor&quot;</span><span class="p">:</span> <span class="s2">&quot;007&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;client_protocol_version&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;major&quot;</span><span class="p">:</span> <span class="s2">&quot;003&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minor&quot;</span><span class="p">:</span> <span class="s2">&quot;007&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;authentication&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;security_type&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;vnc&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;challenge&quot;</span><span class="p">:</span> <span class="s2">&quot;0805b790b58e967f2b350a0c99de3881&quot;</span><span class="p">,</span>
      <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="s2">&quot;aecb26faeaaa62179636a5934bac1078&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;security-result&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;screen_shared&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;framebuffer&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span>
    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;foobar@localhost.localdomain&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pixel_format&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;bits_per_pixel&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
      <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
      <span class="s2">&quot;big_endian&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;true_color&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;red_max&quot;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
      <span class="s2">&quot;green_max&quot;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
      <span class="s2">&quot;blue_max&quot;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
      <span class="s2">&quot;red_shift&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
      <span class="s2">&quot;green_shift&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
      <span class="s2">&quot;blue_shift&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-mqtt">
<h5>Event type: MQTT<a class="headerlink" href="#event-type-mqtt" title="Permalink to this headline">¶</a></h5>
<p>EVE-JSON output for MQTT consists of one object per MQTT transaction, with some common and various type-specific fields.</p>
<div class="section" id="transactions">
<h6>Transactions<a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h6>
<p>A single MQTT communication can consist of multiple messages that need to be exchanged between broker and client.
For example, some actions at higher QoS levels (&gt; 0) usually involve a combination of requests and acknowledgement
messages that are linked by a common identifier:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">CONNECT</span></code> followed by <code class="docutils literal notranslate"><span class="pre">CONNACK</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PUBLISH</span></code> followed by <code class="docutils literal notranslate"><span class="pre">PUBACK</span></code> (QoS 1) or <code class="docutils literal notranslate"><span class="pre">PUBREC</span></code>/<code class="docutils literal notranslate"><span class="pre">PUBREL</span></code>/<code class="docutils literal notranslate"><span class="pre">PUBCOMP</span></code> (QoS 2)</li>
<li><code class="docutils literal notranslate"><span class="pre">SUBSCRIBE</span></code> followed by <code class="docutils literal notranslate"><span class="pre">SUBACK</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">UNSUBSCRIBE</span></code> followed by <code class="docutils literal notranslate"><span class="pre">UNSUBACK</span></code></li>
</ul>
</div></blockquote>
<p>The MQTT parser merges individual messages into one EVE output item if they belong to one transaction. In such cases,
the source and destination information (IP/port) reflect the direction of the initial request, but contain messages
from both sides.</p>
<p>Example for a PUBLISH at QoS 2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2020-05-19T18:00:39.016985+0200&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">1454127794305760</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;mqtt&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;0000:0000:0000:0000:0000:0000:0000:0001&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">60105</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;0000:0000:0000:0000:0000:0000:0000:0001&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">1883</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;mqtt&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;house/bulbs/bulb1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;OFF&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;pubrec&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="s2">&quot;pubrel&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="s2">&quot;pubcomp&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that some message types (aka control packet types), such as <code class="docutils literal notranslate"><span class="pre">PINGREQ</span></code> and <code class="docutils literal notranslate"><span class="pre">PINGRESP</span></code>, have no type-specific
data, nor do they have information that facilitate grouping into transactions. These will be logged as single items
and only contain the common fields listed below.</p>
</div>
<div class="section" id="id19">
<h6>Common fields<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h6>
<p>Common fields from the MQTT fixed header:</p>
<ul class="simple">
<li>&quot;*.qos&quot;: Quality of service level for the message, integer between 0 and 2.</li>
<li>&quot;*.retain&quot;: Boolean value of the MQTT 'retain' flag.</li>
<li>&quot;*.dup&quot;: Boolean value of the MQTT 'dup' (duplicate) flag.</li>
</ul>
</div>
<div class="section" id="mqtt-connect-fields">
<h6>MQTT CONNECT fields<a class="headerlink" href="#mqtt-connect-fields" title="Permalink to this headline">¶</a></h6>
<ul>
<li><p class="first">&quot;connect.protocol_string&quot;: Protocol string as defined in the spec, e.g. <code class="docutils literal notranslate"><span class="pre">MQTT</span></code> (MQTT 3.1.1 and later) or <code class="docutils literal notranslate"><span class="pre">MQIsdp</span></code> (MQTT 3.1).</p>
</li>
<li><p class="first">&quot;connect.protocol_version&quot;: Protocol version as defined in the specification:</p>
<blockquote>
<div><ul class="simple">
<li>protocol version <code class="docutils literal notranslate"><span class="pre">3</span></code>: MQTT 3.1</li>
<li>protocol version <code class="docutils literal notranslate"><span class="pre">4</span></code>: MQTT 3.1.1</li>
<li>protocol version <code class="docutils literal notranslate"><span class="pre">5</span></code>: MQTT 5.0</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">&quot;connect.flags.username&quot;, &quot;connect.flags.password&quot;:  Set to <cite>true</cite> if credentials are submitted with the connect request.</p>
</li>
<li><p class="first">&quot;connect.flags.will&quot;: Set to <cite>true</cite> if a will is set.</p>
</li>
<li><p class="first">&quot;connect.flags.will_retain&quot;: Set to <cite>true</cite> if the will is to be retained on the broker.</p>
</li>
<li><p class="first">&quot;connect.will.clean_session&quot;: Set to <cite>true</cite> if the connection is to made with a clean session.</p>
</li>
<li><p class="first">&quot;connect.client_id&quot;: Client ID string submitted my the connecting client.</p>
</li>
<li><p class="first">&quot;connect.username&quot;, &quot;connect.password&quot;:  User/password authentication credentials submitted with the connect request. Passwords are only logged when the corresponding configuration setting is enabled (<code class="docutils literal notranslate"><span class="pre">mqtt.passwords:</span> <span class="pre">yes</span></code>).</p>
</li>
<li><p class="first">&quot;connect.will.topic&quot;: Topic to publish the will message to.</p>
</li>
<li><p class="first">&quot;connect.will.message&quot;: Message to be published on connection loss.</p>
</li>
<li><p class="first">&quot;connect.will.properties&quot;: (Optional, MQTT 5.0) Will properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901060">3.1.3.2 in the spec</a> for more information on will properties.</p>
</li>
<li><p class="first">&quot;connect.properties&quot;: (Optional, MQTT 5.0) CONNECT properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901046">3.1.2.11 in the spec</a> for more information on CONNECT properties.</p>
</li>
</ul>
<p>Example of MQTT CONNECT logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;connect&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;protocol_string&quot;</span><span class="p">:</span> <span class="s2">&quot;MQTT&quot;</span><span class="p">,</span>
  <span class="s2">&quot;protocol_version&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;will_retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;will&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;clean_session&quot;</span><span class="p">:</span> <span class="n">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="s2">&quot;client&quot;</span><span class="p">,</span>
  <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
  <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;pass&quot;</span><span class="p">,</span>
  <span class="s2">&quot;will&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;willtopic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;willmessage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;mywilltype&quot;</span><span class="p">,</span>
      <span class="s2">&quot;correlation_data&quot;</span><span class="p">:</span> <span class="s2">&quot;3c32aa4313b3e&quot;</span><span class="p">,</span>
      <span class="s2">&quot;message_expiry_interval&quot;</span><span class="p">:</span> <span class="mi">133</span><span class="p">,</span>
      <span class="s2">&quot;payload_format_indicator&quot;</span><span class="p">:</span> <span class="mi">144</span><span class="p">,</span>
      <span class="s2">&quot;response_topic&quot;</span><span class="p">:</span> <span class="s2">&quot;response_topic1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;userprop&quot;</span><span class="p">:</span> <span class="s2">&quot;uservalue&quot;</span><span class="p">,</span>
      <span class="s2">&quot;will_delay_interval&quot;</span><span class="p">:</span> <span class="mi">200</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;maximum_packet_size&quot;</span><span class="p">:</span> <span class="mi">11111</span><span class="p">,</span>
    <span class="s2">&quot;receive_maximum&quot;</span><span class="p">:</span> <span class="mi">222</span><span class="p">,</span>
    <span class="s2">&quot;session_expiry_interval&quot;</span><span class="p">:</span> <span class="mi">555</span><span class="p">,</span>
    <span class="s2">&quot;topic_alias_maximum&quot;</span><span class="p">:</span> <span class="mi">666</span><span class="p">,</span>
    <span class="s2">&quot;userprop1&quot;</span><span class="p">:</span> <span class="s2">&quot;userval1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;userprop2&quot;</span><span class="p">:</span> <span class="s2">&quot;userval2&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-connack-fields">
<h6>MQTT CONNACK fields<a class="headerlink" href="#mqtt-connack-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;connack.session_present&quot;: Set to <cite>true</cite> if a session is continued on connection.</li>
<li>&quot;connack.return_code&quot;: Return code/reason code for this reply. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901079">3.2.2.2 in the spec</a> for more information on these codes.</li>
<li>&quot;connect.properties&quot;: (Optional, MQTT 5.0) CONNACK properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901080">3.2.2.3 in the spec</a> for more information on CONNACK properties.</li>
</ul>
<p>Example of MQTT CONNACK logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;connack&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;session_present&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;return_code&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;topic_alias_maximum&quot;</span><span class="p">:</span> <span class="mi">10</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-publish-fields">
<h6>MQTT PUBLISH fields<a class="headerlink" href="#mqtt-publish-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;publish.topic&quot;: Topic this message is published to.</li>
<li>&quot;publish.message_id&quot;: (Only present if QOS level &gt; 0) Message ID for this publication.</li>
<li>&quot;publish.message&quot;: Message to be published.</li>
<li>&quot;publish.properties&quot;: (Optional, MQTT 5.0) PUBLISH properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901109">3.3.2.3 in the spec</a> for more information on PUBLISH properties.</li>
</ul>
<p>Example of MQTT PUBLISH logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;topic&quot;</span><span class="p">,</span>
  <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;baa baa sheep&quot;</span><span class="p">,</span>
  <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;mytype&quot;</span><span class="p">,</span>
    <span class="s2">&quot;correlation_data&quot;</span><span class="p">:</span> <span class="s2">&quot;3c32aa4313b3e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;message_expiry_interval&quot;</span><span class="p">:</span> <span class="mi">77</span><span class="p">,</span>
    <span class="s2">&quot;payload_format_indicator&quot;</span><span class="p">:</span> <span class="mi">88</span><span class="p">,</span>
    <span class="s2">&quot;response_topic&quot;</span><span class="p">:</span> <span class="s2">&quot;response_topic1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;topic_alias&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;userprop&quot;</span><span class="p">:</span> <span class="s2">&quot;userval&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-puback-pubrel-pubrec-pubcomp-fields">
<h6>MQTT PUBACK/PUBREL/PUBREC/PUBCOMP fields<a class="headerlink" href="#mqtt-puback-pubrel-pubrec-pubcomp-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;[puback|pubrel|pubrec|pubcomp].message_id&quot;: Original message ID this message refers to.</li>
<li>&quot;[puback|pubrel|pubrec|pubcomp].reason_code&quot;: Return code/reason code for this reply. See the spec for more information on these codes.</li>
<li>&quot;[puback|pubrel|pubrec|pubcomp].properties&quot;: (Optional, MQTT 5.0) Properties set on this request. See the spec for more information on these properties.</li>
</ul>
<p>Example of MQTT PUBACK/PUBREL/PUBREC/PUBCOMP logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;puback&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;reason_code&quot;</span><span class="p">:</span> <span class="mi">16</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-subscribe-fields">
<h6>MQTT SUBSCRIBE fields<a class="headerlink" href="#mqtt-subscribe-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;subscribe.message_id&quot;: (Only present if QOS level &gt; 0) Message ID for this subscription.</li>
<li>&quot;subscribe.topics&quot;: Array of pairs describing the subscribed topics:<ul>
<li>&quot;subscribe.topics[].topic&quot;: Topic to subscribe to.</li>
<li>&quot;subscribe.topics[].qos&quot;: QOS level to apply for when subscribing.</li>
</ul>
</li>
<li>&quot;subscribe.properties&quot;: (Optional, MQTT 5.0) SUBSCRIBE properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901164">3.8.2.1 in the spec</a> for more information on SUBSCRIBE properties.</li>
</ul>
<p>Example of MQTT SUBSCRIBE logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;subscribe&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;topics&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;topicX&quot;</span><span class="p">,</span>
      <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;topicY&quot;</span><span class="p">,</span>
      <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-suback-fields">
<h6>MQTT SUBACK fields<a class="headerlink" href="#mqtt-suback-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;suback.message_id&quot;: Original message ID this message refers to.</li>
<li>&quot;suback.qos_granted&quot;: Array of QOS levels granted for the subscribed topics, in the order of the original request.</li>
<li>&quot;suback.properties&quot;: (Optional, MQTT 5.0) SUBACK properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901174">3.9.2.1 in the spec</a> for more information on SUBACK properties.</li>
</ul>
<p>Example of MQTT SUBACK logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;suback&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;qos_granted&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-unsubscribe-fields">
<h6>MQTT UNSUBSCRIBE fields<a class="headerlink" href="#mqtt-unsubscribe-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;unsubscribe.message_id&quot;: (Only present if QOS level &gt; 0) Message ID for this unsubscribe action.</li>
<li>&quot;unsubscribe.topics&quot;: Array of topics to be unsubscribed from.</li>
<li>&quot;unsubscribe.properties&quot;: (Optional, MQTT 5.0) UNSUBSCRIBE properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901182">3.10.2.1 in the spec</a> for more information on UNSUBSCRIBE properties.</li>
</ul>
<p>Example of MQTT UNSUBSCRIBE logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;unsubscribe&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;topics&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;topicX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;topicY&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-unsuback-fields">
<h6>MQTT UNSUBACK fields<a class="headerlink" href="#mqtt-unsuback-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;unsuback.message_id&quot;: Original message ID this message refers to.</li>
</ul>
<p>Example of MQTT UNSUBACK logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;unsuback&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-auth-fields-mqtt-5-0">
<h6>MQTT AUTH fields (MQTT 5.0)<a class="headerlink" href="#mqtt-auth-fields-mqtt-5-0" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;auth.reason_code&quot;: Return code/reason code for this message. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901220">3.15.2.1 in the spec</a> for more information on these codes.</li>
<li>&quot;auth.properties&quot;: (Optional, MQTT 5.0) Properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901221">3.15.2.2 in the spec</a> for more information on these properties.</li>
</ul>
<p>Example of MQTT AUTH logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;reason_code&quot;</span><span class="p">:</span> <span class="mi">16</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mqtt-disconnect-fields">
<h6>MQTT DISCONNECT fields<a class="headerlink" href="#mqtt-disconnect-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;auth.reason_code&quot;: (Optional) Return code/reason code for this message. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901208">3.14.2.1 in the spec</a> for more information on these codes.</li>
<li>&quot;auth.properties&quot;: (Optional, MQTT 5.0) Properties set on this request. See <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901209">3.14.2.2 in the spec</a> for more information on DISCONNECT properties.</li>
</ul>
<p>Example of MQTT DISCONNECT logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;disconnect&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;reason_code&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;session_expiry_interval&quot;</span><span class="p">:</span> <span class="mi">122</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="truncated-mqtt-data">
<h6>Truncated MQTT data<a class="headerlink" href="#truncated-mqtt-data" title="Permalink to this headline">¶</a></h6>
<p>Messages exceeding the maximum message length limit (config setting <code class="docutils literal notranslate"><span class="pre">app-layer.protocols.mqtt.max-msg-length</span></code>)
will not be parsed entirely to reduce the danger of denial of service issues. In such cases, only reduced
metadata will be included in the EVE-JSON output. Furthermore, since no message ID is parsed, such messages
can not be placed into transactions, hence, they will always appear as a single transaction.</p>
<p>These truncated events will -- besides basic communication metadata -- only contain the following
fields:</p>
<ul class="simple">
<li>&quot;truncated&quot;: Set to <cite>true</cite> if the entry is truncated.</li>
<li>&quot;skipped_length&quot;: Size of the original message.</li>
</ul>
<p>Example of a truncated MQTT PUBLISH message (with 10000 being the maximum length):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2020-06-23T16:25:48.729785+0200&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">1872904524326406</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">107</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;mqtt&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;0000:0000:0000:0000:0000:0000:0000:0001&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">53335</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;0000:0000:0000:0000:0000:0000:0000:0001&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">1883</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;mqtt&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;retain&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;dup&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
      <span class="s2">&quot;truncated&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;skipped_length&quot;</span><span class="p">:</span> <span class="mi">100011</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-http2">
<h5>Event type: HTTP2<a class="headerlink" href="#event-type-http2" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id31">
<h6>Fields<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h6>
<p>There are the two fields &quot;request&quot; and &quot;response&quot; which can each contain the same set of fields :
* &quot;settings&quot;: a list of settings with &quot;name&quot; and &quot;value&quot;
* &quot;headers&quot;: a list of headers with either &quot;name&quot; and &quot;value&quot;, or &quot;table_size_update&quot;, or &quot;error&quot; if any
* &quot;error_code&quot;: the error code from GOAWAY or RST_STREAM, which can be &quot;NO_ERROR&quot;
* &quot;priority&quot;: the stream priority.</p>
</div>
<div class="section" id="id32">
<h6>Examples<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h6>
<p>Example of HTTP2 logging, of a settings frame:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http2&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;settings_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SETTINGSMAXCONCURRENTSTREAMS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;settings_value&quot;</span><span class="p">:</span> <span class="mi">100</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;settings_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SETTINGSINITIALWINDOWSIZE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;settings_value&quot;</span><span class="p">:</span> <span class="mi">65535</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of HTTP2 logging, of a request and response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;http2&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;:authority&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost:3000&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;:method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;:path&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;/doc/manual/html/index.html&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;:scheme&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;http&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;accept&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;*/*&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;accept-encoding&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip, deflate&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;user-agent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;nghttp2/0.5.2-DEV&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;:status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;200&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;nghttpd nghttp2/0.5.2-DEV&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;content-length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;22617&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;cache-control&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;max-age=3600&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Sat, 02 Aug 2014 10:50:25 GMT&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;last-modified&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Sat, 02 Aug 2014 07:58:59 GMT&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-pgsql">
<h5>Event type: PGSQL<a class="headerlink" href="#event-type-pgsql" title="Permalink to this headline">¶</a></h5>
<p>PGSQL eve-logs reflect the bidirectional nature of the protocol transactions. Each PGSQL event lists at most one
&quot;Request&quot; message field and one or more &quot;Response&quot; messages.</p>
<p>The PGSQL parser merges individual messages into one EVE output item if they belong to the same transaction. In such cases, the source and destination information (IP/port) reflect the direction of the initial request, but contain messages from both sides.</p>
<p>Example of <code class="docutils literal notranslate"><span class="pre">pgsql</span></code> event for a SimpleQuery transaction complete with request with a <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statement and its response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-11-24T16:56:24.403417+0000&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">1960113262002448</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">780</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pgsql&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;172.18.0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">54408</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;172.18.0.2&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pgsql&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;simple_query&quot;</span><span class="p">:</span> <span class="s2">&quot;select * from rule limit 5000;&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;field_count&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;data_rows&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
      <span class="s2">&quot;data_size&quot;</span><span class="p">:</span> <span class="mi">3035751</span><span class="p">,</span>
      <span class="s2">&quot;command_completed&quot;</span><span class="p">:</span> <span class="s2">&quot;SELECT 5000&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>While on the wire PGSQL messages follow basically two types (startup messages and regular messages), those may have different subfields and/or meanings, based on the message type. Messages are logged based on their type and relevant fields.</p>
<p>We list a few possible message types and what they mean in Suricata. For more details on message types and formats as well as what each message and field mean for PGSQL, check  <a class="reference external" href="https://www.postgresql.org/docs/14/protocol-message-formats.html">PostgreSQL's official documentation</a>.</p>
<div class="section" id="id33">
<h6>Fields<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;tx_id&quot;: internal transaction id.</li>
<li>&quot;request&quot;:  each PGSQL transaction may have up to one request message. The possible messages will be described in another section.</li>
<li>&quot;response&quot;: even when there are several &quot;Response&quot; messages, there is one <code class="docutils literal notranslate"><span class="pre">response</span></code> field that summarizes all responses for that transaction. The possible messages will be described in another section.</li>
</ul>
</div>
<div class="section" id="request-messages">
<h6>Request Messages<a class="headerlink" href="#request-messages" title="Permalink to this headline">¶</a></h6>
<p>Some of the possible request messages are:</p>
<ul class="simple">
<li>&quot;startup_message&quot;: message sent by a frontend/client process to start a new PostgreSQL connection</li>
<li>&quot;password_message&quot;: if password output for PGSQL is enabled in suricata.yaml, carries the password sent during Authentication phase</li>
<li>&quot;simple_query&quot;: issued SQL command during simple query subprotocol. PostgreSQL identifies specific sets of commands that change the set of expected messages to be exchanged as subprotocols.</li>
<li>&quot;message&quot;: frontend responses which do not have meaningful payloads are logged like this, where the field value is the message type</li>
</ul>
<p>There are several different authentication messages possible, based on selected authentication method. (e.g. the SASL authentication will have a set of authentication messages different from when <code class="docutils literal notranslate"><span class="pre">md5</span></code> authentication is chosen).</p>
</div>
<div class="section" id="response-messages">
<h6>Response Messages<a class="headerlink" href="#response-messages" title="Permalink to this headline">¶</a></h6>
<p>Some of the possible request messages are:</p>
<ul class="simple">
<li>&quot;authentication_sasl_final&quot;: final SCRAM <code class="docutils literal notranslate"><span class="pre">server-final-message</span></code>, as explained at <a class="reference external" href="https://www.postgresql.org/docs/14/sasl-authentication.html#SASL-SCRAM-SHA-256">https://www.postgresql.org/docs/14/sasl-authentication.html#SASL-SCRAM-SHA-256</a></li>
<li>&quot;message&quot;: Backend responses which do not have meaningful payloads are logged like this, where the field value is the message type</li>
<li>&quot;error_response&quot;</li>
<li>&quot;notice_response&quot;</li>
<li>&quot;notification_response&quot;</li>
<li>&quot;authentication_md5_password&quot;: a string with the <code class="docutils literal notranslate"><span class="pre">md5</span></code> salt value</li>
<li>&quot;parameter_status&quot;: logged as an array</li>
<li>&quot;backend_key_data&quot;</li>
<li>&quot;data_rows&quot;: integer. When one or many <code class="docutils literal notranslate"><span class="pre">DataRow</span></code> messages are parsed, the total returned rows</li>
<li>&quot;data_size&quot;: in bytes. When one or many <code class="docutils literal notranslate"><span class="pre">DataRow</span></code> messages are parsed, the total size in bytes of the data returned</li>
<li>&quot;command_completed&quot;: string. Informs the command just completed by the backend</li>
<li>&quot;ssl_accepted&quot;: bool. With this event, the initial PGSQL SSL Handshake negotiation is complete in terms of tracking and logging. The session will be upgraded to use TLS encryption</li>
</ul>
</div>
<div class="section" id="id34">
<h6>Examples<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h6>
<p>The two <code class="docutils literal notranslate"><span class="pre">pgsql</span></code> events in this example represent a rejected <code class="docutils literal notranslate"><span class="pre">SSL</span> <span class="pre">handshake</span></code> and a following connection request where the authentication method indicated by the backend was <code class="docutils literal notranslate"><span class="pre">md5</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-11-24T16:56:19.435242+0000&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">1960113262002448</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pgsql&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;172.18.0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">54408</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;172.18.0.2&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pgsql&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;SSL Request&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;accepted&quot;</span><span class="p">:</span> <span class="n">false</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-11-24T16:56:19.436228+0000&quot;</span><span class="p">,</span>
  <span class="s2">&quot;flow_id&quot;</span><span class="p">:</span> <span class="mi">1960113262002448</span><span class="p">,</span>
  <span class="s2">&quot;pcap_cnt&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
  <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pgsql&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;172.18.0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;src_port&quot;</span><span class="p">:</span> <span class="mi">54408</span><span class="p">,</span>
  <span class="s2">&quot;dest_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;172.18.0.2&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dest_port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
  <span class="s2">&quot;proto&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pgsql&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;tx_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;protocol_version&quot;</span><span class="p">:</span> <span class="s2">&quot;3.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;startup_parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;rules&quot;</span><span class="p">,</span>
        <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;rules&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional_parameters&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;application_name&quot;</span><span class="p">:</span> <span class="s2">&quot;psql&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;client_encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;UTF8&quot;</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;authentication_md5_password&quot;</span><span class="p">:</span> <span class="s2">&quot;Z</span><span class="se">\\</span><span class="s2">xdc</span><span class="se">\\</span><span class="s2">xfdf&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-ike">
<h5>Event type: IKE<a class="headerlink" href="#event-type-ike" title="Permalink to this headline">¶</a></h5>
<p>The parser implementations for IKEv1 and IKEv2 have a slightly different feature
set. They can be distinguished using the &quot;version_major&quot; field (which equals
either 1 or 2).
The unique properties are contained within a separate &quot;ikev1&quot; and &quot;ikev2&quot; sub-object.</p>
<div class="section" id="id35">
<h6>Fields<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;init_spi&quot;, &quot;resp_spi&quot;: The Security Parameter Index (SPI) of the initiator and responder.</li>
<li>&quot;version_major&quot;: Major version of the ISAKMP header.</li>
<li>&quot;version_minor&quot;: Minor version of the ISAKMP header.</li>
<li>&quot;payload&quot;: List of payload types in the current packet.</li>
<li>&quot;exchange_type&quot;: Type of the exchange, as numeric values.</li>
<li>&quot;exchange_type_verbose&quot;: Type of the exchange, in human-readable form. Needs <code class="docutils literal notranslate"><span class="pre">extended:</span> <span class="pre">yes</span></code> set in the <code class="docutils literal notranslate"><span class="pre">ike</span></code> EVE output option.</li>
<li>&quot;alg_enc&quot;, &quot;alg_hash&quot;, &quot;alg_auth&quot;, &quot;alg_dh&quot;, &quot;alg_esn&quot;: Properties of the chosen security association by the server.</li>
<li>&quot;ikev1.encrypted_payloads&quot;: Set to <code class="docutils literal notranslate"><span class="pre">true</span></code> if the payloads in the packet are encrypted.</li>
<li>&quot;ikev1.doi&quot;: Value of the domain of interpretation (DOI).</li>
<li>&quot;ikev1.server.key_exchange_payload&quot;, &quot;ikev1.client.key_exchange_payload&quot;: Public key exchange payloads of the server and client.</li>
<li>&quot;ikev1.server.key_exchange_payload_length&quot;, &quot;ikev1.client.key_exchange_payload_length&quot;: Length of the public key exchange payload.</li>
<li>&quot;ikev1.server.nonce_payload&quot;, &quot;ikev1.client.nonce_payload&quot;: Nonce payload of the server and client.</li>
<li>&quot;ikev1.server.nonce_payload_length&quot;, &quot;ikev1.client.nonce_payload_length&quot;: Length of the nonce payload.</li>
<li>&quot;ikev1.client.client_proposals&quot;: List of the security associations proposed to the server.</li>
<li>&quot;ikev1.vendor_ids&quot;: List of the vendor IDs observed in the communication.</li>
<li>&quot;server_proposals&quot;: List of server proposals with parameters, if there are more than one. This is a non-standard case; this field is only present if such a situation was observed in the inspected traffic.</li>
</ul>
</div>
<div class="section" id="id36">
<h6>Examples<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h6>
<p>Example of IKE logging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ike&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;version_major&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;version_minor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;init_spi&quot;</span><span class="p">:</span> <span class="s2">&quot;8511617bfea2f172&quot;</span><span class="p">,</span>
  <span class="s2">&quot;resp_spi&quot;</span><span class="p">:</span> <span class="s2">&quot;c0fc6bae013de0f5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;exchange_type&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;exchange_type_verbose&quot;</span><span class="p">:</span> <span class="s2">&quot;Identity Protection&quot;</span><span class="p">,</span>
  <span class="s2">&quot;sa_life_type&quot;</span><span class="p">:</span> <span class="s2">&quot;LifeTypeSeconds&quot;</span><span class="p">,</span>
  <span class="s2">&quot;sa_life_type_raw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;sa_life_duration&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
  <span class="s2">&quot;sa_life_duration_raw&quot;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>
  <span class="s2">&quot;alg_enc&quot;</span><span class="p">:</span> <span class="s2">&quot;EncAesCbc&quot;</span><span class="p">,</span>
  <span class="s2">&quot;alg_enc_raw&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="s2">&quot;alg_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;HashSha2_256&quot;</span><span class="p">,</span>
  <span class="s2">&quot;alg_hash_raw&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">&quot;alg_auth&quot;</span><span class="p">:</span> <span class="s2">&quot;AuthPreSharedKey&quot;</span><span class="p">,</span>
  <span class="s2">&quot;alg_auth_raw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;alg_dh&quot;</span><span class="p">:</span> <span class="s2">&quot;GroupModp2048Bit&quot;</span><span class="p">,</span>
  <span class="s2">&quot;alg_dh_raw&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
  <span class="s2">&quot;sa_key_length&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
  <span class="s2">&quot;sa_key_length_raw&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
  <span class="s2">&quot;alg_esn&quot;</span><span class="p">:</span> <span class="s2">&quot;NoESN&quot;</span><span class="p">,</span>
  <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;VendorID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Transform&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Proposal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SecurityAssociation&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;ikev1&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;encrypted_payloads&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;key_exchange_payload&quot;</span><span class="p">:</span> <span class="s2">&quot;0bf7907681a656aabed38fb1ba8918b10d707a8e635a...&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key_exchange_payload_length&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
      <span class="s2">&quot;nonce_payload&quot;</span><span class="p">:</span> <span class="s2">&quot;1427d158fc1ed6bbbc1bd81e6b74960809c87d18af5f0abef14d5274ac232904&quot;</span><span class="p">,</span>
      <span class="s2">&quot;nonce_payload_length&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
      <span class="s2">&quot;proposals&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;sa_life_type&quot;</span><span class="p">:</span> <span class="s2">&quot;LifeTypeSeconds&quot;</span><span class="p">,</span>
          <span class="s2">&quot;sa_life_type_raw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s2">&quot;sa_life_duration&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
          <span class="s2">&quot;sa_life_duration_raw&quot;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>
          <span class="s2">&quot;alg_enc&quot;</span><span class="p">:</span> <span class="s2">&quot;EncAesCbc&quot;</span><span class="p">,</span>
          <span class="s2">&quot;alg_enc_raw&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
          <span class="s2">&quot;alg_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;HashSha2_256&quot;</span><span class="p">,</span>
          <span class="s2">&quot;alg_hash_raw&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
          <span class="s2">&quot;alg_auth&quot;</span><span class="p">:</span> <span class="s2">&quot;AuthPreSharedKey&quot;</span><span class="p">,</span>
          <span class="s2">&quot;alg_auth_raw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s2">&quot;alg_dh&quot;</span><span class="p">:</span> <span class="s2">&quot;GroupModp2048Bit&quot;</span><span class="p">,</span>
          <span class="s2">&quot;alg_dh_raw&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
          <span class="s2">&quot;sa_key_length&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
          <span class="s2">&quot;sa_key_length_raw&quot;</span><span class="p">:</span> <span class="mi">256</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;key_exchange_payload&quot;</span><span class="p">:</span> <span class="s2">&quot;1e43be52b088ec840ff81865074b6d459b5ca7813b46...&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key_exchange_payload_length&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
      <span class="s2">&quot;nonce_payload&quot;</span><span class="p">:</span> <span class="s2">&quot;04d78293ead007bc1a0f0c6c821a3515286a935af12ca50e08905b15d6c8fcd4&quot;</span><span class="p">,</span>
      <span class="s2">&quot;nonce_payload_length&quot;</span><span class="p">:</span> <span class="mi">32</span>
    <span class="p">},</span>
    <span class="s2">&quot;vendor_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;4048b7d56ebce88525e7de7f00d6c2d3&quot;</span><span class="p">,</span>
      <span class="s2">&quot;4a131c81070358455c5728f20e95452f&quot;</span><span class="p">,</span>
      <span class="s2">&quot;afcad71368a1f1c96b8696fc77570100&quot;</span><span class="p">,</span>
      <span class="s2">&quot;7d9419a65310ca6f2c179d9215529d56&quot;</span><span class="p">,</span>
      <span class="s2">&quot;cd60464335df21f87cfdb2fc68b6a448&quot;</span><span class="p">,</span>
      <span class="s2">&quot;90cb80913ebb696e086381b5ec427b1f&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-modbus">
<h5>Event type: Modbus<a class="headerlink" href="#event-type-modbus" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id37">
<h6>Common fields<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;id&quot;: The unique transaction number given by Suricata</li>
</ul>
</div>
<div class="section" id="request-response-fields">
<h6>Request/Response fields<a class="headerlink" href="#request-response-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;transaction_id&quot;: The transaction id found in the packet</li>
<li>&quot;protocol_id&quot;: The modbus version</li>
<li>&quot;unit_id&quot;: ID of the remote server to interact with</li>
<li>&quot;function_raw&quot;: Raw value of the function code byte</li>
<li>&quot;function_code&quot;: Associated name of the raw function value</li>
<li>&quot;access_type&quot;: Type of access requested by the function</li>
<li>&quot;category&quot;: The function code's category</li>
<li>&quot;error_flags&quot;: Errors found in the data while parsing</li>
</ul>
</div>
<div class="section" id="exception-fields">
<h6>Exception fields<a class="headerlink" href="#exception-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;raw&quot;: Raw value of the exception code byte</li>
<li>&quot;code&quot;: Associated name of the raw exception value</li>
</ul>
</div>
<div class="section" id="diagnostic-fields">
<h6>Diagnostic fields<a class="headerlink" href="#diagnostic-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;raw&quot;: Raw value of the subfunction code bytes</li>
<li>&quot;code&quot;: Associated name of the raw subfunction value</li>
<li>&quot;data&quot;: Bytes following the subfunction code</li>
</ul>
</div>
<div class="section" id="mei-fields">
<h6>MEI fields<a class="headerlink" href="#mei-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;raw&quot;: Raw value of the mei function code bytes</li>
<li>&quot;code&quot;: Associated name of the raw mei function value</li>
<li>&quot;data&quot;: Bytes following the mei function code</li>
</ul>
</div>
<div class="section" id="read-request-fields">
<h6>Read Request fields<a class="headerlink" href="#read-request-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;address&quot;: Starting address to read from</li>
<li>&quot;quantity&quot;: Amount to read</li>
</ul>
</div>
<div class="section" id="read-response-fields">
<h6>Read Response fields<a class="headerlink" href="#read-response-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;data&quot;: Data that was read</li>
</ul>
</div>
<div class="section" id="multiple-write-request-fields">
<h6>Multiple Write Request fields<a class="headerlink" href="#multiple-write-request-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;address&quot;: Starting address to write to</li>
<li>&quot;quantity&quot;: Amount to write</li>
<li>&quot;data&quot;: Data to write</li>
</ul>
</div>
<div class="section" id="mask-write-fields">
<h6>Mask Write fields<a class="headerlink" href="#mask-write-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;address&quot;: Starting address of content modification</li>
<li>&quot;and_mask&quot;: And mask to modify content with</li>
<li>&quot;or_mask&quot;: Or mask to modify content with</li>
</ul>
</div>
<div class="section" id="other-write-fields">
<h6>Other Write fields<a class="headerlink" href="#other-write-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;address&quot;: Starting address to write to</li>
<li>&quot;data&quot;: Data to write</li>
</ul>
</div>
<div class="section" id="generic-data-fields">
<h6>Generic Data fields<a class="headerlink" href="#generic-data-fields" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;data&quot;: Data following the function code</li>
</ul>
</div>
<div class="section" id="example">
<h6>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h6>
<p>Example of Modbus logging of a request and response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;modbus&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;protocol_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;unit_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;function_raw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;function_code&quot;</span><span class="p">:</span> <span class="s2">&quot;RdCoils&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access_type&quot;</span><span class="p">:</span> <span class="s2">&quot;READ | COILS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;PUBLIC_ASSIGNED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;error_flags&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;protocol_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;unit_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;function_raw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;function_code&quot;</span><span class="p">:</span> <span class="s2">&quot;RdCoils&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access_type&quot;</span><span class="p">:</span> <span class="s2">&quot;READ | COILS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;PUBLIC_ASSIGNED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;error_flags&quot;</span><span class="p">:</span> <span class="s2">&quot;DATA_VALUE&quot;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-quic">
<h5>Event type: QUIC<a class="headerlink" href="#event-type-quic" title="Permalink to this headline">¶</a></h5>
<div class="section" id="id38">
<h6>Fields<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;version&quot;: Version of the QUIC packet if contained in the packet, 0 if not</li>
<li>&quot;cyu&quot;: List of found CYUs in the packet</li>
<li>&quot;cyu[].hash&quot;: CYU hash</li>
<li>&quot;cyu[].string&quot;: CYU string</li>
</ul>
</div>
<div class="section" id="id39">
<h6>Examples<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h6>
<p>Example of QUIC logging with a CYU hash:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;quic&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1362113590</span><span class="p">,</span>
  <span class="s2">&quot;cyu&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
          <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;7b3ceb1adc974ad360cfa634e8d0a730&quot;</span><span class="p">,</span>
          <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="s2">&quot;46,PAD-SNI-STK-SNO-VER-CCS-NONC-AEAD-UAID-SCID-TCID-PDMD-SMHL-ICSL-NONP-PUBS-MIDS-SCLS-KEXS-XLCT-CSCT-COPT-CCRT-IRTT-CFCW-SFCW&quot;</span>
      <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-type-dhcp">
<h5>Event type: DHCP<a class="headerlink" href="#event-type-dhcp" title="Permalink to this headline">¶</a></h5>
<p>The default DHCP logging level only logs enough information to map a
MAC address to an IP address. Enable extended mode to log all DHCP
message types in full detail.</p>
<div class="section" id="id40">
<h6>Fields<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>&quot;type&quot;: message type (e.g. request, reply)</li>
<li>&quot;id&quot;: DHCP transaction id</li>
<li>&quot;client_mac&quot;: client MAC address</li>
<li>&quot;assigned_ip&quot;: IP address given by DHCP server</li>
<li>&quot;client_ip&quot;: client IP address</li>
<li>&quot;dhcp_type&quot;: DHCP message type</li>
<li>&quot;client_id&quot;: DHCP client identifier</li>
<li>&quot;hostname&quot;: DHCP client host name</li>
<li>&quot;params&quot;: DHCP parameter request list</li>
<li>&quot;requested_ip&quot;: DHCP client requesting specific IP address</li>
<li>&quot;relay_ip&quot;: BOOTP relay agent IP address</li>
<li>&quot;next_server_ip&quot;: BOOTP next IP address to use for booting process</li>
<li>&quot;subnet_mask&quot;: subnet mask to use with client IP address</li>
<li>&quot;routers&quot;: IP address(es) to be used as default gateways on DHCP client</li>
<li>&quot;lease_time&quot;: Duration of IP address assignment to client</li>
<li>&quot;renewal_time&quot;: Time in seconds since client began IP address request or renewal process</li>
<li>&quot;rebinding_time&quot;: Time in seconds before the client begins to renew its IP address lease</li>
<li>&quot;dns_servers&quot;: IP address(es) of servers the client will use for DNS queries</li>
</ul>
</div>
<div class="section" id="id41">
<h6>Examples<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h6>
<p>Example of DHCP log entry (default logging level):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;dhcp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;reply&quot;</span><span class="p">,</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">755466399</span><span class="p">,</span>
  <span class="s2">&quot;client_mac&quot;</span><span class="p">:</span><span class="s2">&quot;54:ee:75:51:e0:66&quot;</span><span class="p">,</span>
  <span class="s2">&quot;assigned_ip&quot;</span><span class="p">:</span><span class="s2">&quot;100.78.202.125&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dhcp_type&quot;</span><span class="p">:</span><span class="s2">&quot;ack&quot;</span><span class="p">,</span>
  <span class="s2">&quot;renewal_time&quot;</span><span class="p">:</span><span class="mi">21600</span><span class="p">,</span>
  <span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;54:ee:75:51:e0:66&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example of DHCP log entry (extended logging enabled):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;dhcp&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;reply&quot;</span><span class="p">,</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">2787908432</span><span class="p">,</span>
  <span class="s2">&quot;client_mac&quot;</span><span class="p">:</span><span class="s2">&quot;54:ee:75:51:e0:66&quot;</span><span class="p">,</span>
  <span class="s2">&quot;assigned_ip&quot;</span><span class="p">:</span><span class="s2">&quot;192.168.1.120&quot;</span><span class="p">,</span>
  <span class="s2">&quot;client_ip&quot;</span><span class="p">:</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;relay_ip&quot;</span><span class="p">:</span><span class="s2">&quot;192.168.1.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;next_server_ip&quot;</span><span class="p">:</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dhcp_type&quot;</span><span class="p">:</span><span class="s2">&quot;offer&quot;</span><span class="p">,</span>
  <span class="s2">&quot;subnet_mask&quot;</span><span class="p">:</span><span class="s2">&quot;255.255.255.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;routers&quot;</span><span class="p">:[</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">],</span>
  <span class="s2">&quot;hostname&quot;</span><span class="p">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
  <span class="s2">&quot;lease_time&quot;</span><span class="p">:</span><span class="mi">86400</span><span class="p">,</span>
  <span class="s2">&quot;renewal_time&quot;</span><span class="p">:</span><span class="mi">21600</span><span class="p">,</span>
  <span class="s2">&quot;rebinding_time&quot;</span><span class="p">:</span><span class="mi">43200</span><span class="p">,</span>
  <span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;54:ee:75:51:e0:66&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dns_servers&quot;</span><span class="p">:[</span><span class="s2">&quot;192.168.1.50&quot;</span><span class="p">,</span><span class="s2">&quot;192.168.1.49&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-output/eve/eve-json-examplesjq"></span><div class="section" id="eve-json-jq-examples">
<h4>Eve JSON 'jq' Examples<a class="headerlink" href="#eve-json-jq-examples" title="Permalink to this headline">¶</a></h4>
<p>The jq tool is very useful for quickly parsing and filtering JSON files. This page is contains various examples of how it can be used with Suricata's Eve.json.</p>
<p>The basics are discussed here:</p>
<ul class="simple">
<li><a class="reference external" href="https://www.stamus-networks.com/2015/05/18/looking-at-suricata-json-events-on-command-line/">https://www.stamus-networks.com/2015/05/18/looking-at-suricata-json-events-on-command-line/</a></li>
</ul>
<div class="section" id="colorize-output">
<h5>Colorize output<a class="headerlink" href="#colorize-output" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;.&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="dns-nxdomain">
<h5>DNS NXDOMAIN<a class="headerlink" href="#dns-nxdomain" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span><span class="o">|</span><span class="n">jq</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;select(.dns.rcode==&quot;NXDOMAIN&quot;)&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="unique-http-user-agents">
<h5>Unique HTTP User Agents<a class="headerlink" href="#unique-http-user-agents" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;[.[]|.http.http_user_agent]|group_by(.)|map({key:.[0],value:(.|length)})|from_entries&#39;</span>
</pre></div>
</div>
<p>Source: <a class="reference external" href="https://twitter.com/mattarnao/status/601807374647750657">https://twitter.com/mattarnao/status/601807374647750657</a></p>
</div>
<div class="section" id="data-use-for-a-host">
<h5>Data use for a host<a class="headerlink" href="#data-use-for-a-host" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">n500000</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;map(select(.event_type==&quot;netflow&quot; and .dest_ip==&quot;192.168.1.3&quot;).netflow.bytes)|add&#39;</span><span class="o">|</span><span class="n">numfmt</span> <span class="o">--</span><span class="n">to</span><span class="o">=</span><span class="n">iec</span>
<span class="mf">1.3</span><span class="n">G</span>
</pre></div>
</div>
<p>Note: can use a lot of memory.
Source: <a class="reference external" href="https://twitter.com/pkt_inspector/status/605524218722148352">https://twitter.com/pkt_inspector/status/605524218722148352</a></p>
</div>
<div class="section" id="monitor-part-of-the-stats">
<h5>Monitor part of the stats<a class="headerlink" href="#monitor-part-of-the-stats" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tail -f eve.json | jq -c &#39;select(.event_type==&quot;stats&quot;)|.stats.decoder&#39;
</pre></div>
</div>
</div>
<div class="section" id="inspect-alert-data">
<h5>Inspect Alert Data<a class="headerlink" href="#inspect-alert-data" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;select(.event_type==&quot;alert&quot;)|.payload&#39;</span><span class="o">|</span><span class="n">base64</span> <span class="o">--</span><span class="n">decode</span>
</pre></div>
</div>
</div>
<div class="section" id="top-10-destination-ports">
<h5>Top 10 Destination Ports<a class="headerlink" href="#top-10-destination-ports" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;select(.event_type==&quot;flow&quot;)|[.proto, .dest_port]&#39;</span><span class="o">|</span><span class="n">sort</span> <span class="o">|</span><span class="n">uniq</span> <span class="o">-</span><span class="n">c</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">nr</span><span class="o">|</span><span class="n">head</span> <span class="o">-</span><span class="n">n10</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-output/lua-output"></span><div class="section" id="lua-output">
<span id="id1"></span><h3>Lua Output<a class="headerlink" href="#lua-output" title="Permalink to this headline">¶</a></h3>
<p>Suricata offers the possibility to get more detailed output on specific kinds of
network traffic via pluggable lua scripts. You can write these scripts yourself and only need to
define four hook functions.</p>
<p>For lua output scripts suricata offers a wide range of lua functions.
They all return information on specific engine internals and aspects of the network traffic.
They are described in the following sections, grouped by the event/traffic type.
But let's start with an example explaining the four hook functions, and how to make
suricata load a lua output script.</p>
<div class="section" id="script-structure">
<h4>Script structure<a class="headerlink" href="#script-structure" title="Permalink to this headline">¶</a></h4>
<p>A lua output script needs to define 4 hook functions: init(), setup(), log(), deinit()</p>
<ul class="simple">
<li>init() -- registers where the script hooks into the output engine</li>
<li>setup() -- does per output thread setup</li>
<li>log() -- logging function</li>
<li>deinit() -- clean up function</li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">setup</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">SCLogPath</span><span class="p">()</span> <span class="o">..</span> <span class="s2">&quot;/&quot;</span> <span class="o">..</span> <span class="n">name</span>
    <span class="n">file</span> <span class="o">=</span> <span class="k">assert</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">))</span>
    <span class="n">SCLogInfo</span><span class="p">(</span><span class="s2">&quot;HTTP Log Filename &quot;</span> <span class="o">..</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">http</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">http_uri</span> <span class="o">=</span> <span class="n">HttpGetRequestUriRaw</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">http_uri</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="n">http_uri</span> <span class="o">=</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span>
    <span class="n">end</span>
    <span class="n">http_uri</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="n">http_uri</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="n">http_host</span> <span class="o">=</span> <span class="n">HttpGetRequestHost</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">http_host</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="n">http_host</span> <span class="o">=</span> <span class="s2">&quot;&lt;hostname unknown&gt;&quot;</span>
    <span class="n">end</span>
    <span class="n">http_host</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="n">http_host</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="n">http_ua</span> <span class="o">=</span> <span class="n">HttpGetRequestHeader</span><span class="p">(</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">http_ua</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="n">http_ua</span> <span class="o">=</span> <span class="s2">&quot;&lt;useragent unknown&gt;&quot;</span>
    <span class="n">end</span>
    <span class="n">http_ua</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="n">http_ua</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="n">timestring</span> <span class="o">=</span> <span class="n">SCPacketTimeString</span><span class="p">()</span>
    <span class="n">ip_version</span><span class="p">,</span> <span class="n">src_ip</span><span class="p">,</span> <span class="n">dst_ip</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">src_port</span><span class="p">,</span> <span class="n">dst_port</span> <span class="o">=</span> <span class="n">SCFlowTuple</span><span class="p">()</span>

    <span class="n">file</span><span class="p">:</span><span class="n">write</span> <span class="p">(</span><span class="n">timestring</span> <span class="o">..</span> <span class="s2">&quot; &quot;</span> <span class="o">..</span> <span class="n">http_host</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">http_uri</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span>
           <span class="n">http_ua</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">src_ip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">src_port</span> <span class="o">..</span> <span class="s2">&quot; -&gt; &quot;</span> <span class="o">..</span>
           <span class="n">dst_ip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">dst_port</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">file</span><span class="p">:</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">http</span> <span class="o">=</span> <span class="n">http</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">deinit</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">SCLogInfo</span> <span class="p">(</span><span class="s2">&quot;HTTP transactions logged: &quot;</span> <span class="o">..</span> <span class="n">http</span><span class="p">);</span>
    <span class="n">file</span><span class="p">:</span><span class="n">close</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="yaml">
<h4>YAML<a class="headerlink" href="#yaml" title="Permalink to this headline">¶</a></h4>
<p>To enable the lua output, add the 'lua' output and add one or more
scripts like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">lua</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">scripts</span><span class="o">-</span><span class="nb">dir</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">lua</span><span class="o">-</span><span class="n">output</span><span class="o">/</span>
      <span class="n">scripts</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">tcp</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">lua</span>
        <span class="o">-</span> <span class="n">flow</span><span class="o">.</span><span class="n">lua</span>
</pre></div>
</div>
<p>The scripts-dir option is optional. It makes Suricata load the scripts
from this directory. Otherwise scripts will be loaded from the current
workdir.</p>
</div>
<div class="section" id="developing-lua-output-script">
<h4>Developing lua output script<a class="headerlink" href="#developing-lua-output-script" title="Permalink to this headline">¶</a></h4>
<p>You can use functions described in <a class="reference internal" href="index.html#lua-functions"><span class="std std-ref">Lua Functions</span></a></p>
</div>
</div>
<span id="document-output/syslog-alerting-comp"></span><div class="section" id="syslog-alerting-compatibility">
<h3>Syslog Alerting Compatibility<a class="headerlink" href="#syslog-alerting-compatibility" title="Permalink to this headline">¶</a></h3>
<p>Suricata can alert via syslog which is a very handy feature for central log collection, compliance, and reporting to a SIEM. Instructions on setting this up can be found in the .yaml file in the section where you can configure what type of alert (and other) logging you would like.</p>
<p>However, there are different syslog daemons and there can be parsing issues with the syslog format a SIEM expects and what syslog format Suricata sends. The syslog format from Suricata is dependent on the syslog daemon running on the Suricata sensor but often the format it sends is not the format the SIEM expects and cannot parse it properly.</p>
<div class="section" id="popular-syslog-daemons">
<h4>Popular syslog daemons<a class="headerlink" href="#popular-syslog-daemons" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><strong>syslogd</strong> - logs system messages</li>
<li><strong>syslog-ng</strong> - logs system messages but also supports TCP, TLS, and other enhanced enterprise features</li>
<li><strong>rsyslogd</strong> - logs system messages but also support TCP, TLS, multi-threading, and other enhanced features</li>
<li><strong>klogd</strong> - logs kernel messages</li>
<li><strong>sysklogd</strong> - basically a bundle of syslogd and klogd</li>
</ul>
<p>If the syslog format the Suricata sensor is sending is not compatible with what your SIEM or syslog collector expects, you will need to fix this. You can do this on your SIEM if it is capable of being able to be configured to interpret the message, or by configuring the syslog daemon on the Suricata sensor itself to send in a format you SIEM can parse. The latter can be done by applying a template to your syslog config file.</p>
</div>
<div class="section" id="finding-what-syslog-daemon-you-are-using">
<h4>Finding what syslog daemon you are using<a class="headerlink" href="#finding-what-syslog-daemon-you-are-using" title="Permalink to this headline">¶</a></h4>
<p>There are many ways to find out what syslog daemon you are using but here is one way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span>
<span class="n">ls</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">syslog</span>
</pre></div>
</div>
<p>You should see a file with the word syslog in it, e.g. &quot;syslog&quot;, &quot;rsyslogd&quot;, etc. Obviously if the name is &quot;rsyslogd&quot; you can be fairly confident you are running rsyslogd. If unsure or the filename is just &quot;syslog&quot;, take a look at that file. For example, if it was &quot;rsyslogd&quot;, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">less</span> <span class="n">rsyslogd</span>
</pre></div>
</div>
<p>At the top you should see a comment line that looks something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># rsyslog        Starts rsyslogd/rklogd.</span>
</pre></div>
</div>
<p>Locate those files and look at them to give you clues as to what syslog daemon you are running. Also look in the <em>start()</em> section of the file you ran &quot;less&quot; on and see what binaries get started because that can give you clues as well.</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>Here is an example where the Suricata sensor is sending syslog messages in rsyslogd format but the SIEM is expecting and parsing them in a sysklogd format. In the syslog configuration file (usually in /etc with a filename like rsyslog.conf or syslog.conf), first add the template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$template sysklogd, &quot;&lt;%PRI%&gt;%syslogtag:1:32%%msg:::sp-if-no-1st-sp%%msg%&quot;
</pre></div>
</div>
<p>Then send it to the syslog server with the template applied:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">alert</span> <span class="o">@</span><span class="mf">10.8.75.24</span><span class="p">:</span><span class="mi">514</span><span class="p">;</span><span class="n">sysklogd</span>
</pre></div>
</div>
<p>Of course this is just one example and it will probably be different in your environment depending on what syslog daemons and SIEM you use but hopefully this will point you in the right direction.</p>
</div>
</div>
<span id="document-output/custom-http-logging"></span><div class="section" id="custom-http-logging">
<h3>Custom http logging<a class="headerlink" href="#custom-http-logging" title="Permalink to this headline">¶</a></h3>
<p>As of Suricata 1.3.1 you can enable a custom http logging option.</p>
<p>In your Suricata.yaml, find the http-log section and edit as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">http</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">http</span><span class="o">.</span><span class="n">log</span>
      <span class="n">custom</span><span class="p">:</span> <span class="n">yes</span> <span class="c1"># enable the custom logging format (defined by custom format)</span>
      <span class="n">customformat</span><span class="p">:</span> <span class="s2">&quot;%{%D-%H:%M:%S}t.%z %{X-Forwarded-For}i %{User-agent}i %H %m %h </span><span class="si">%u</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> %B </span><span class="si">%a</span><span class="s2">:%p -&gt; %A:%P&quot;</span>
      <span class="n">append</span><span class="p">:</span> <span class="n">no</span>
      <span class="c1">#extended: yes     # enable this for extended logging information</span>
      <span class="c1">#filetype: regular # &#39;regular&#39;, &#39;unix_stream&#39; or &#39;unix_dgram&#39;</span>
</pre></div>
</div>
<p>And in your http.log file you would get the following, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">8</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">21.101619</span> <span class="o">-</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">X11</span><span class="p">;</span> <span class="n">Ubuntu</span><span class="p">;</span> <span class="n">Linux</span> <span class="n">i686</span><span class="p">;</span> <span class="n">rv</span><span class="p">:</span><span class="mf">11.0</span><span class="p">)</span> <span class="n">Gecko</span><span class="o">/</span><span class="mi">20100101</span> <span class="n">Firefox</span><span class="o">/</span><span class="mf">11.0</span>  <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">GET</span> <span class="n">us</span><span class="o">.</span><span class="n">cnn</span><span class="o">.</span><span class="n">com</span> <span class="o">/</span><span class="n">video</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mf">3.0</span><span class="o">/</span><span class="n">video</span><span class="o">/</span><span class="n">world</span><span class="o">/</span><span class="mi">2012</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="n">hancocks</span><span class="o">-</span><span class="n">korea</span><span class="o">-</span><span class="n">typhoon</span><span class="o">-</span><span class="n">bolavan</span><span class="o">.</span><span class="n">cnn</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">xml</span> <span class="mi">200</span> <span class="mi">16856</span> <span class="mf">192.168.1.91</span><span class="p">:</span><span class="mi">45111</span> <span class="o">-&gt;</span> <span class="mf">157.166.255.18</span><span class="p">:</span><span class="mi">80</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">08</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">30.693856</span> <span class="o">-</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">X11</span><span class="p">;</span> <span class="n">Ubuntu</span><span class="p">;</span> <span class="n">Linux</span> <span class="n">i686</span><span class="p">;</span> <span class="n">rv</span><span class="p">:</span><span class="mf">11.0</span><span class="p">)</span> <span class="n">Gecko</span><span class="o">/</span><span class="mi">20100101</span> <span class="n">Firefox</span><span class="o">/</span><span class="mf">11.0</span>  <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">GET</span> <span class="n">us</span><span class="o">.</span><span class="n">cnn</span><span class="o">.</span><span class="n">com</span> <span class="o">/</span><span class="n">video</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mf">3.0</span><span class="o">/</span><span class="n">video</span><span class="o">/</span><span class="n">showbiz</span><span class="o">/</span><span class="mi">2012</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="n">conan</span><span class="o">-</span><span class="n">reports</span><span class="o">-</span><span class="n">from</span><span class="o">-</span><span class="n">rnc</span><span class="o">-</span><span class="n">convention</span><span class="o">.</span><span class="n">teamcoco</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">xml</span> <span class="mi">200</span> <span class="mi">15789</span> <span class="mf">192.168.1.91</span><span class="p">:</span><span class="mi">45108</span> <span class="o">-&gt;</span> <span class="mf">157.166.255.18</span><span class="p">:</span><span class="mi">80</span>
</pre></div>
</div>
<p>The list of supported format strings is the following:</p>
<ul class="simple">
<li>%h - Host HTTP Header (remote host name). ie: google.com</li>
<li>%H - Request Protocol. ie: HTTP/1.1</li>
<li>%m - Request Method. ie: GET</li>
<li>%u - URL including query string. ie: /search?q=suricata</li>
<li>%{header_name}i - contents of the defined HTTP Request Header name. ie:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>%{User-agent}i: Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:11.0) Gecko/20100101 Firefox/11.0</li>
<li>%{X-Forwarded-For}i: outputs the IP address contained in the X-Forwarded-For HTTP header (inserted by a reverse proxy)</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>%s - return status code. In the case of 301 and 302 it will print the url in brackets. ie: 200</li>
<li>%B - response size in bytes. ie: 15789</li>
<li>%{header_name}o - contents of the defined HTTP Response Header name</li>
<li>%{strftime_format]t - timestamp of the HTTP transaction in the selected strftime format. ie: 08/28/12-22:14:30</li>
<li>%z - precision time in useconds. ie: 693856</li>
<li>%a - client IP address</li>
<li>%p - client port number</li>
<li>%A - server IP address</li>
<li>%P - server port number</li>
</ul>
<p>Any non printable character will be represented by its byte value in hexadecimal format (|XX|, where XX is the hex code)</p>
</div>
<span id="document-output/custom-tls-logging"></span><div class="section" id="custom-tls-logging">
<span id="output-custom-tls-logging"></span><h3>Custom tls logging<a class="headerlink" href="#custom-tls-logging" title="Permalink to this headline">¶</a></h3>
<p>In your Suricata.yaml, find the tls-log section and edit as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">tls</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>      <span class="c1"># Log TLS connections.</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">tls</span><span class="o">.</span><span class="n">log</span> <span class="c1"># File to store TLS logs.</span>
    <span class="n">append</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">custom</span><span class="p">:</span> <span class="n">yes</span>       <span class="c1"># enabled the custom logging format (defined by customformat)</span>
    <span class="n">customformat</span><span class="p">:</span> <span class="s2">&quot;%{%D-%H:%M:%S}t.%z </span><span class="si">%a</span><span class="s2">:%p -&gt; %A:%P %v %n </span><span class="si">%d</span><span class="s2"> %D&quot;</span>
</pre></div>
</div>
<p>And in your tls.log file you would get the following, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">12</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">16</span><span class="o">-</span><span class="mi">19</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">14.85859</span> <span class="mf">10.10.10.4</span><span class="p">:</span><span class="mi">58274</span> <span class="o">-&gt;</span> <span class="mf">192.0.78.24</span><span class="p">:</span><span class="mi">443</span> <span class="n">VERSION</span><span class="o">=</span><span class="s1">&#39;TLS 1.2&#39;</span> <span class="n">suricata</span><span class="o">.</span><span class="n">io</span> <span class="n">NOTBEFORE</span><span class="o">=</span><span class="s1">&#39;2016-10-27T20:36:00&#39;</span> <span class="n">NOTAFTER</span><span class="o">=</span><span class="s1">&#39;2017-01-25T20:36:00&#39;</span>
</pre></div>
</div>
<p>The list of supported format strings is the following:</p>
<ul class="simple">
<li>%n - client SNI</li>
<li>%v - TLS/SSL version</li>
<li>%d - certificate date not before</li>
<li>%D - certificate date not after</li>
<li>%f - certificate fingerprint SHA1</li>
<li>%s - certificate subject</li>
<li>%i - certificate issuer dn</li>
<li>%E - extended format</li>
<li>%{strftime_format}t - timestamp of the TLS transaction in the selected strftime format. ie: 08/28/12-22:14:30</li>
<li>%z - precision time in useconds. ie: 693856</li>
<li>%a - client IP address</li>
<li>%p - client port number</li>
<li>%A - server IP address</li>
<li>%P - server port number</li>
</ul>
<p>Any non printable character will be represented by its byte value in hexadecimal format (|XX|, where XX is the hex code)</p>
</div>
<span id="document-output/log-rotation"></span><div class="section" id="log-rotation">
<h3>Log Rotation<a class="headerlink" href="#log-rotation" title="Permalink to this headline">¶</a></h3>
<p>All outputs in the <a class="reference internal" href="index.html#suricata-yaml-outputs"><span class="std std-ref">outputs</span></a> section of
the configuration file can be subject to log rotation.</p>
<p>For most outputs an external tool like <em>logrotate</em> is required to
rotate the log files in combination with sending a SIGHUP to Suricata
to notify it that the log files have been rotated.</p>
<p>On receipt of a SIGHUP, Suricata simply closes all open log files and
then re-opens them in append mode. If the external tool has renamed
any of the log files, new files will be created, otherwise the files
will be re-opened and new data will be appended to them with no
noticeable affect.</p>
<p>The following is an example <em>logrotate</em> configuration file that will
rotate Suricata log files then send Suricata a SIGHUP triggering
Suricata to open new files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/var/log/suricata/*.log /var/log/suricata/*.json
{
    rotate 3
    missingok
    nocompress
    create
    sharedscripts
    postrotate
            /bin/kill -HUP `cat /var/run/suricata.pid 2&gt;/dev/null` 2&gt;/dev/null || true
    endscript
}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The above <em>logrotate</em> configuration file depends on the
existence of a Suricata PID file. If running in daemon mode
a PID file will be created by default, otherwise the
<a class="reference internal" href="index.html#cmdoption-pidfile"><code class="xref std std-option docutils literal notranslate"><span class="pre">--pidfile</span></code></a> option should be used to create a PID file.</p>
</div>
<p>In addition to the SIGHUP style rotation discussed above, some outputs
support their own time and date based rotation, however removal of old
log files is still the responsibility of external tools. These outputs
include:</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#output-eve-rotate"><span class="std std-ref">Eve</span></a></li>
<li><a class="reference internal" href="index.html#suricata-yaml-pcap-log"><span class="std std-ref">PCAP log</span></a></li>
</ul>
</div>
</div>
</div>
<span id="document-lua/index"></span><div class="section" id="lua-support">
<h2>Lua support<a class="headerlink" href="#lua-support" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-lua/lua-usage"></span><div class="section" id="lua-usage-in-suricata">
<h3>Lua usage in Suricata<a class="headerlink" href="#lua-usage-in-suricata" title="Permalink to this headline">¶</a></h3>
<p>Lua scripting can be used in two components of Suricata. The first is in
output and the second one in rules in the detection engine.</p>
<p>Both features are using a list of functions to access the data extracted by
Suricata. You can get the list of functions in the <a class="reference internal" href="index.html#lua-functions"><span class="std std-ref">Lua functions</span></a> page.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently, there is a difference in the <code class="docutils literal notranslate"><span class="pre">needs</span></code> key in the <code class="docutils literal notranslate"><span class="pre">init</span></code> function, depending on what is the usage: <code class="docutils literal notranslate"><span class="pre">output</span></code> or <code class="docutils literal notranslate"><span class="pre">detection</span></code>. The list of available functions may also differ.</p>
</div>
<div class="section" id="lua-output">
<h4>Lua output<a class="headerlink" href="#lua-output" title="Permalink to this headline">¶</a></h4>
<p>Lua can be used to write arbitrary output. See <a class="reference internal" href="index.html#lua-output"><span class="std std-ref">Lua Output</span></a> for more information.</p>
</div>
<div class="section" id="lua-detection">
<h4>Lua detection<a class="headerlink" href="#lua-detection" title="Permalink to this headline">¶</a></h4>
<p>Lua script can be used as a filter condition in signatures. See <a class="reference internal" href="index.html#lua-detection"><span class="std std-ref">Lua Scripting for Detection</span></a> for more information.</p>
</div>
</div>
<span id="document-lua/lua-functions"></span><div class="section" id="lua-functions">
<span id="id1"></span><h3>Lua functions<a class="headerlink" href="#lua-functions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="differences-between-output-and-detect">
<h4>Differences between <cite>output</cite> and <cite>detect</cite>:<a class="headerlink" href="#differences-between-output-and-detect" title="Permalink to this headline">¶</a></h4>
<p>Currently, the <code class="docutils literal notranslate"><span class="pre">needs</span></code> key initialization varies, depending on what is the goal of the script: output or detection.</p>
<p>If the script is for detection, the <code class="docutils literal notranslate"><span class="pre">needs</span></code> initialization should be as seen in the example below (see <a class="reference internal" href="index.html#lua-detection"><span class="std std-ref">Lua Scripting for Detection</span></a> for a complete example of a detection script):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;packet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>For output logs, follow the pattern below. (The complete script structure can be seen at <a class="reference internal" href="index.html#lua-output"><span class="std std-ref">Lua Output</span></a>:)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Do notice that the functions and protocols available for <code class="docutils literal notranslate"><span class="pre">log</span></code> and <code class="docutils literal notranslate"><span class="pre">match</span></code> may also vary. DNP3, for instance, is not
available for logging.</p>
</div>
<div class="section" id="packet">
<h4>packet<a class="headerlink" href="#packet" title="Permalink to this headline">¶</a></h4>
<p>Initialize with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;packet&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="scpackettimestamp">
<h5>SCPacketTimestamp<a class="headerlink" href="#scpackettimestamp" title="Permalink to this headline">¶</a></h5>
<p>Get packets timestamp as 2 numbers: seconds &amp; microseconds elapsed since
1970-01-01 00:00:00 UTC.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span> <span class="o">=</span> <span class="n">SCPacketTimestamp</span><span class="p">()</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="scpackettimestring">
<h5>SCPacketTimeString<a class="headerlink" href="#scpackettimestring" title="Permalink to this headline">¶</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">SCPacketTimeString</span></code> to get the packet's time string in the format:
11/24/2009-18:57:25.179869</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">SCPacketTimeString</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scpackettuple">
<h5>SCPacketTuple<a class="headerlink" href="#scpackettuple" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipver</span><span class="p">,</span> <span class="n">srcip</span><span class="p">,</span> <span class="n">dstip</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">dp</span> <span class="o">=</span> <span class="n">SCPacketTuple</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scpacketpayload">
<h5>SCPacketPayload<a class="headerlink" href="#scpacketpayload" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SCPacketPayload</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="flow">
<h4>flow<a class="headerlink" href="#flow" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;flow&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="scflowtimestamps">
<h5>SCFlowTimestamps<a class="headerlink" href="#scflowtimestamps" title="Permalink to this headline">¶</a></h5>
<p>Get timestamps (seconds and microseconds) of the first and the last packet from
the flow.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startts</span><span class="p">,</span> <span class="n">lastts</span> <span class="o">=</span> <span class="n">SCFlowTimestamps</span><span class="p">()</span>
<span class="n">startts_s</span><span class="p">,</span> <span class="n">lastts_s</span><span class="p">,</span> <span class="n">startts_us</span><span class="p">,</span> <span class="n">lastts_us</span> <span class="o">=</span> <span class="n">SCFlowTimestamps</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scflowtimestring">
<h5>SCFlowTimeString<a class="headerlink" href="#scflowtimestring" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startts</span> <span class="o">=</span> <span class="n">SCFlowTimeString</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scflowtuple">
<h5>SCFlowTuple<a class="headerlink" href="#scflowtuple" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipver</span><span class="p">,</span> <span class="n">srcip</span><span class="p">,</span> <span class="n">dstip</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">dp</span> <span class="o">=</span> <span class="n">SCFlowTuple</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scflowapplayerproto">
<h5>SCFlowAppLayerProto<a class="headerlink" href="#scflowapplayerproto" title="Permalink to this headline">¶</a></h5>
<p>Get alproto as a string from the flow. If a alproto is not (yet) known, it
returns &quot;unknown&quot;.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">alproto</span> <span class="o">=</span> <span class="n">SCFlowAppLayerProto</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">alproto</span> <span class="o">~=</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">alproto</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Returns 5 values: &lt;alproto&gt; &lt;alproto_ts&gt; &lt;alproto_tc&gt; &lt;alproto_orig&gt; &lt;alproto_expect&gt;</p>
<p>Orig and expect are used when changing and upgrading protocols. In a SMTP STARTTLS
case, orig would normally be set to &quot;smtp&quot; and expect to &quot;tls&quot;.</p>
</div>
<div class="section" id="scflowhasalerts">
<h5>SCFlowHasAlerts<a class="headerlink" href="#scflowhasalerts" title="Permalink to this headline">¶</a></h5>
<p>Returns true if flow has alerts.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">has_alerts</span> <span class="o">=</span> <span class="n">SCFlowHasAlerts</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">has_alerts</span> <span class="n">then</span>
        <span class="o">--</span> <span class="n">do</span> <span class="n">something</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="scflowstats">
<h5>SCFlowStats<a class="headerlink" href="#scflowstats" title="Permalink to this headline">¶</a></h5>
<p>Gets the packet and byte counts per flow.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tscnt</span><span class="p">,</span> <span class="n">tsbytes</span><span class="p">,</span> <span class="n">tccnt</span><span class="p">,</span> <span class="n">tcbytes</span> <span class="o">=</span> <span class="n">SCFlowStats</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scflowid">
<h5>SCFlowId<a class="headerlink" href="#scflowid" title="Permalink to this headline">¶</a></h5>
<p>Gets the flow id.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">SCFlowId</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that simply printing 'id' will likely result in printing a scientific
notation. To avoid that, simply do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">SCFlowId</span><span class="p">()</span>
<span class="n">idstr</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Flow ID: &quot;</span> <span class="o">..</span> <span class="n">idstr</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="http">
<h4>http<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h4>
<p>For output, init with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>For detection, use the specific buffer (cf <a class="reference internal" href="index.html#lua-detection"><span class="std std-ref">Lua Scripting for Detection</span></a> for a complete list), as with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;http.uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="httpgetrequestbody-and-httpgetresponsebody">
<h5>HttpGetRequestBody and HttpGetResponseBody.<a class="headerlink" href="#httpgetrequestbody-and-httpgetresponsebody" title="Permalink to this headline">¶</a></h5>
<p>Make normalized body data available to the script through
HttpGetRequestBody and HttpGetResponseBody.</p>
<p>There no guarantees that all of the body will be available.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">HttpGetResponseBody</span><span class="p">();</span>
    <span class="o">--</span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;offset &quot;</span> <span class="o">..</span> <span class="n">o</span> <span class="o">..</span> <span class="s2">&quot; end &quot;</span> <span class="o">..</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">do</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrequesthost">
<h5>HttpGetRequestHost<a class="headerlink" href="#httpgetrequesthost" title="Permalink to this headline">¶</a></h5>
<p>Get the host from libhtp's tx-&gt;request_hostname, which can either be
the host portion of the url or the host portion of the Host header.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http_host</span> <span class="o">=</span> <span class="n">HttpGetRequestHost</span><span class="p">()</span>
<span class="k">if</span> <span class="n">http_host</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="n">http_host</span> <span class="o">=</span> <span class="s2">&quot;&lt;hostname unknown&gt;&quot;</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrequestheader">
<h5>HttpGetRequestHeader<a class="headerlink" href="#httpgetrequestheader" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http_ua</span> <span class="o">=</span> <span class="n">HttpGetRequestHeader</span><span class="p">(</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">http_ua</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="n">http_ua</span> <span class="o">=</span> <span class="s2">&quot;&lt;useragent unknown&gt;&quot;</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetresponseheader">
<h5>HttpGetResponseHeader<a class="headerlink" href="#httpgetresponseheader" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">server</span> <span class="o">=</span> <span class="n">HttpGetResponseHeader</span><span class="p">(</span><span class="s2">&quot;Server&quot;</span><span class="p">);</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Server: &quot;</span> <span class="o">..</span> <span class="n">server</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrequestline">
<h5>HttpGetRequestLine<a class="headerlink" href="#httpgetrequestline" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rl</span> <span class="o">=</span> <span class="n">HttpGetRequestLine</span><span class="p">();</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Request Line: &quot;</span> <span class="o">..</span> <span class="n">rl</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetresponseline">
<h5>HttpGetResponseLine<a class="headerlink" href="#httpgetresponseline" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rsl</span> <span class="o">=</span> <span class="n">HttpGetResponseLine</span><span class="p">();</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Response Line: &quot;</span> <span class="o">..</span> <span class="n">rsl</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrawrequestheaders">
<h5>HttpGetRawRequestHeaders<a class="headerlink" href="#httpgetrawrequestheaders" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rh</span> <span class="o">=</span> <span class="n">HttpGetRawRequestHeaders</span><span class="p">();</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Raw Request Headers: &quot;</span> <span class="o">..</span> <span class="n">rh</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrawresponseheaders">
<h5>HttpGetRawResponseHeaders<a class="headerlink" href="#httpgetrawresponseheaders" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rh</span> <span class="o">=</span> <span class="n">HttpGetRawResponseHeaders</span><span class="p">();</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Raw Response Headers: &quot;</span> <span class="o">..</span> <span class="n">rh</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrequesturiraw">
<h5>HttpGetRequestUriRaw<a class="headerlink" href="#httpgetrequesturiraw" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http_uri</span> <span class="o">=</span> <span class="n">HttpGetRequestUriRaw</span><span class="p">()</span>
<span class="k">if</span> <span class="n">http_uri</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="n">http_uri</span> <span class="o">=</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrequesturinormalized">
<h5>HttpGetRequestUriNormalized<a class="headerlink" href="#httpgetrequesturinormalized" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http_uri</span> <span class="o">=</span> <span class="n">HttpGetRequestUriNormalized</span><span class="p">()</span>
<span class="k">if</span> <span class="n">http_uri</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="n">http_uri</span> <span class="o">=</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetrequestheaders">
<h5>HttpGetRequestHeaders<a class="headerlink" href="#httpgetrequestheaders" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">HttpGetRequestHeaders</span><span class="p">();</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="httpgetresponseheaders">
<h5>HttpGetResponseHeaders<a class="headerlink" href="#httpgetresponseheaders" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">HttpGetResponseHeaders</span><span class="p">();</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dns">
<h4>DNS<a class="headerlink" href="#dns" title="Permalink to this headline">¶</a></h4>
<p>If your purpose is to create a logging script, initialize the buffer as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
   <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dns&quot;</span>
   <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>If you are going to use the script for rule matching, choose one of the available DNS buffers listed in
<a class="reference internal" href="index.html#lua-detection"><span class="std std-ref">Lua Scripting for Detection</span></a> and follow the pattern:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
   <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;dns.rrname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="dnsgetqueries">
<h5>DnsGetQueries<a class="headerlink" href="#dnsgetqueries" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns_query</span> <span class="o">=</span> <span class="n">DnsGetQueries</span><span class="p">();</span>
<span class="k">if</span> <span class="n">dns_query</span> <span class="o">~=</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">dns_query</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">rrname</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;rrname&quot;</span><span class="p">]</span>
        <span class="n">rrtype</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;QUERY: &quot;</span> <span class="o">..</span> <span class="n">ts</span> <span class="o">..</span> <span class="s2">&quot; &quot;</span> <span class="o">..</span> <span class="n">rrname</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">rrtype</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span>
               <span class="s2">&quot;TODO&quot;</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">srcip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">sp</span> <span class="o">..</span> <span class="s2">&quot; -&gt; &quot;</span> <span class="o">..</span>
               <span class="n">dstip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">dp</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>returns a table of tables</p>
</div>
<div class="section" id="dnsgetanswers">
<h5>DnsGetAnswers<a class="headerlink" href="#dnsgetanswers" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns_answers</span> <span class="o">=</span> <span class="n">DnsGetAnswers</span><span class="p">();</span>
<span class="k">if</span> <span class="n">dns_answers</span> <span class="o">~=</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">dns_answers</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">rrname</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;rrname&quot;</span><span class="p">]</span>
        <span class="n">rrtype</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">]</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;ANSWER: &quot;</span> <span class="o">..</span> <span class="n">ts</span> <span class="o">..</span> <span class="s2">&quot; &quot;</span> <span class="o">..</span> <span class="n">rrname</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">rrtype</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span>
               <span class="n">ttl</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">srcip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">sp</span> <span class="o">..</span> <span class="s2">&quot; -&gt; &quot;</span> <span class="o">..</span>
               <span class="n">dstip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">dp</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>returns a table of tables</p>
</div>
<div class="section" id="dnsgetauthorities">
<h5>DnsGetAuthorities<a class="headerlink" href="#dnsgetauthorities" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns_auth</span> <span class="o">=</span> <span class="n">DnsGetAuthorities</span><span class="p">();</span>
<span class="k">if</span> <span class="n">dns_auth</span> <span class="o">~=</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">dns_auth</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">rrname</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;rrname&quot;</span><span class="p">]</span>
        <span class="n">rrtype</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">]</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;AUTHORITY: &quot;</span> <span class="o">..</span> <span class="n">ts</span> <span class="o">..</span> <span class="s2">&quot; &quot;</span> <span class="o">..</span> <span class="n">rrname</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">rrtype</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span>
               <span class="n">ttl</span> <span class="o">..</span> <span class="s2">&quot; [**] &quot;</span> <span class="o">..</span> <span class="n">srcip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">sp</span> <span class="o">..</span> <span class="s2">&quot; -&gt; &quot;</span> <span class="o">..</span>
               <span class="n">dstip</span> <span class="o">..</span> <span class="s2">&quot;:&quot;</span> <span class="o">..</span> <span class="n">dp</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>returns a table of tables</p>
</div>
<div class="section" id="dnsgetrcode">
<h5>DnsGetRcode<a class="headerlink" href="#dnsgetrcode" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rcode</span> <span class="o">=</span> <span class="n">DnsGetRcode</span><span class="p">();</span>
<span class="k">if</span> <span class="n">rcode</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">rcode</span><span class="p">)</span>
</pre></div>
</div>
<p>returns a lua string with the error message, or nil</p>
</div>
<div class="section" id="dnsgetrecursiondesired">
<h5>DnsGetRecursionDesired<a class="headerlink" href="#dnsgetrecursiondesired" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">DnsGetRecursionDesired</span><span class="p">()</span> <span class="o">==</span> <span class="n">true</span> <span class="n">then</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;RECURSION DESIRED&quot;</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>returns a bool</p>
</div>
</div>
<div class="section" id="tls">
<h4>TLS<a class="headerlink" href="#tls" title="Permalink to this headline">¶</a></h4>
<p>For log output, initialize with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tls&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>For detection, initialization is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;tls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="tlsgetversion">
<h5>TlsGetVersion<a class="headerlink" href="#tlsgetversion" title="Permalink to this headline">¶</a></h5>
<p>Get the negotiated version in a TLS session as a string through TlsGetVersion.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">TlsGetVersion</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="n">then</span>
        <span class="o">--</span> <span class="n">do</span> <span class="n">something</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="tlsgetcertinfo">
<h5>TlsGetCertInfo<a class="headerlink" href="#tlsgetcertinfo" title="Permalink to this headline">¶</a></h5>
<p>Make certificate information available to the script through TlsGetCertInfo.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">version</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">TlsGetCertInfo</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="tlsgetcertchain">
<h5>TlsGetCertChain<a class="headerlink" href="#tlsgetcertchain" title="Permalink to this headline">¶</a></h5>
<p>Make certificate chain available to the script through TlsGetCertChain.</p>
<p>The output is an array of certificate with each certificate being an hash
with <cite>data</cite> and <cite>length</cite> keys.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">Use</span> <span class="n">debian</span> <span class="n">lua</span><span class="o">-</span><span class="n">luaossl</span> <span class="n">coming</span> <span class="kn">from</span> <span class="nn">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">wahern</span><span class="o">/</span><span class="n">luaossl</span>
<span class="n">local</span> <span class="n">x509</span> <span class="o">=</span> <span class="n">require</span><span class="s2">&quot;openssl.x509&quot;</span>

   <span class="n">chain</span> <span class="o">=</span> <span class="n">TlsGetCertChain</span><span class="p">()</span>
   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="n">do</span>
      <span class="o">--</span> <span class="n">v</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="n">length</span> <span class="n">of</span> <span class="n">data</span>
      <span class="o">--</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="n">raw</span> <span class="n">binary</span> <span class="n">data</span> <span class="n">of</span> <span class="n">certificate</span>
      <span class="n">cert</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="s2">&quot;DER&quot;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span><span class="n">text</span><span class="p">()</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="tlsgetcertnotafter">
<h5>TlsGetCertNotAfter<a class="headerlink" href="#tlsgetcertnotafter" title="Permalink to this headline">¶</a></h5>
<p>Get the Unix timestamp of end of validity of certificate.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">notafter</span> <span class="o">=</span> <span class="n">TlsGetCertNotAfter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">notafter</span> <span class="o">&lt;</span> <span class="n">os</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="n">then</span>
        <span class="o">--</span> <span class="n">expired</span> <span class="n">certificate</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="tlsgetcertnotbefore">
<h5>TlsGetCertNotBefore<a class="headerlink" href="#tlsgetcertnotbefore" title="Permalink to this headline">¶</a></h5>
<p>Get the Unix timestamp of beginning of validity of certificate.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">notbefore</span> <span class="o">=</span> <span class="n">TlsGetCertNotBefore</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">notbefore</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="n">then</span>
        <span class="o">--</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">valid</span> <span class="n">certificate</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="tlsgetcertserial">
<h5>TlsGetCertSerial<a class="headerlink" href="#tlsgetcertserial" title="Permalink to this headline">¶</a></h5>
<p>Get TLS certificate serial number through TlsGetCertSerial.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">serial</span> <span class="o">=</span> <span class="n">TlsGetCertSerial</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">serial</span> <span class="n">then</span>
        <span class="o">--</span> <span class="n">do</span> <span class="n">something</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="tlsgetsni">
<h5>TlsGetSNI<a class="headerlink" href="#tlsgetsni" title="Permalink to this headline">¶</a></h5>
<p>Get the Server name Indication from a TLS connection.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">asked_domain</span> <span class="o">=</span> <span class="n">TlsGetSNI</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">asked_domain</span><span class="p">,</span> <span class="s2">&quot;badguys&quot;</span><span class="p">)</span> <span class="n">then</span>
        <span class="o">--</span> <span class="n">ok</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">bad</span> <span class="n">guys</span> <span class="n">let</span><span class="s1">&#39;s do something</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ja3">
<h4>JA3<a class="headerlink" href="#ja3" title="Permalink to this headline">¶</a></h4>
<p>JA3 must be enabled in the Suricata config file (set 'app-layer.protocols.tls.ja3-fingerprints' to 'yes').</p>
<p>For log output, initialize with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tls&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>For detection, initialization is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;tls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="ja3gethash">
<h5>Ja3GetHash<a class="headerlink" href="#ja3gethash" title="Permalink to this headline">¶</a></h5>
<p>Get the JA3 hash (md5sum of JA3 string) through Ja3GetHash.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">Ja3GetHash</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hash</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="ja3getstring">
<h5>Ja3GetString<a class="headerlink" href="#ja3getstring" title="Permalink to this headline">¶</a></h5>
<p>Get the JA3 string through Ja3GetString.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="n">Ja3GetString</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">str</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="ja3sgethash">
<h5>Ja3SGetHash<a class="headerlink" href="#ja3sgethash" title="Permalink to this headline">¶</a></h5>
<p>Get the JA3S hash (md5sum of JA3S string) through JA3SGetHash.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">Ja3SGetHash</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hash</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Or, for detection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">match</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">Ja3SGetHash</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hash</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>

    <span class="o">//</span> <span class="n">matching</span> <span class="n">code</span>

    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="ja3sgetstring">
<h5>JA3SGetString<a class="headerlink" href="#ja3sgetstring" title="Permalink to this headline">¶</a></h5>
<p>Get the JA3S string through Ja3SGetString.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="n">Ja3SGetString</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">str</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Or, for detection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">match</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
  <span class="nb">str</span> <span class="o">=</span> <span class="n">Ja3SGetString</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">str</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="k">return</span> <span class="mi">0</span>
  <span class="n">end</span>

  <span class="o">//</span> <span class="n">matching</span> <span class="n">code</span>

  <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ssh">
<h4>SSH<a class="headerlink" href="#ssh" title="Permalink to this headline">¶</a></h4>
<p>Initialize with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="sshgetserverprotoversion">
<h5>SshGetServerProtoVersion<a class="headerlink" href="#sshgetserverprotoversion" title="Permalink to this headline">¶</a></h5>
<p>Get SSH protocol version used by the server through SshGetServerProtoVersion.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">SshGetServerProtoVersion</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="sshgetserversoftwareversion">
<h5>SshGetServerSoftwareVersion<a class="headerlink" href="#sshgetserversoftwareversion" title="Permalink to this headline">¶</a></h5>
<p>Get SSH software used by the server through SshGetServerSoftwareVersion.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">software</span> <span class="o">=</span> <span class="n">SshGetServerSoftwareVersion</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">software</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="sshgetclientprotoversion">
<h5>SshGetClientProtoVersion<a class="headerlink" href="#sshgetclientprotoversion" title="Permalink to this headline">¶</a></h5>
<p>Get SSH protocol version used by the client through SshGetClientProtoVersion.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">SshGetClientProtoVersion</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="sshgetclientsoftwareversion">
<h5>SshGetClientSoftwareVersion<a class="headerlink" href="#sshgetclientsoftwareversion" title="Permalink to this headline">¶</a></h5>
<p>Get SSH software used by the client through SshGetClientSoftwareVersion.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">software</span> <span class="o">=</span> <span class="n">SshGetClientSoftwareVersion</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">software</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="hasshget">
<h5>HasshGet<a class="headerlink" href="#hasshget" title="Permalink to this headline">¶</a></h5>
<p>Get MD5 of hassh algorithms used by the client through HasshGet.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">hassh</span> <span class="o">=</span> <span class="n">HasshGet</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hassh</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="hasshgetstring">
<h5>HasshGetString<a class="headerlink" href="#hasshgetstring" title="Permalink to this headline">¶</a></h5>
<p>Get hassh algorithms used by the client through HasshGetString.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">hassh_string</span> <span class="o">=</span> <span class="n">HasshGetString</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hassh</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="hasshserverget">
<h5>HasshServerGet<a class="headerlink" href="#hasshserverget" title="Permalink to this headline">¶</a></h5>
<p>Get MD5 of hassh algorithms used by the server through HasshServerGet.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">hassh_string</span> <span class="o">=</span> <span class="n">HasshServerGet</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hassh</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="hasshservergetstring">
<h5>HasshServerGetString<a class="headerlink" href="#hasshservergetstring" title="Permalink to this headline">¶</a></h5>
<p>Get hassh algorithms used by the server through HasshServerGetString.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">hassh_string</span> <span class="o">=</span> <span class="n">HasshServerGetString</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hassh</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="files">
<h4>Files<a class="headerlink" href="#files" title="Permalink to this headline">¶</a></h4>
<p>To use the file logging API, the script's init() function needs to look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="scfileinfo">
<h5>SCFileInfo<a class="headerlink" href="#scfileinfo" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fileid</span><span class="p">,</span> <span class="n">txid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">magic</span><span class="p">,</span> <span class="n">md5</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">sha256</span> <span class="o">=</span> <span class="n">SCFileInfo</span><span class="p">()</span>
</pre></div>
</div>
<p>returns fileid (number), txid (number), name (string), size (number),
magic (string), md5 in hex (string), sha1 (string), sha256 (string)</p>
</div>
<div class="section" id="scfilestate">
<h5>SCFileState<a class="headerlink" href="#scfilestate" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="p">,</span> <span class="n">stored</span> <span class="o">=</span> <span class="n">SCFileState</span><span class="p">()</span>
</pre></div>
</div>
<p>returns state (string), stored (bool)</p>
</div>
</div>
<div class="section" id="alerts">
<h4>Alerts<a class="headerlink" href="#alerts" title="Permalink to this headline">¶</a></h4>
<p>Alerts are a subset of the 'packet' logger:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;packet&quot;</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;alerts&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="scruleids">
<h5>SCRuleIds<a class="headerlink" href="#scruleids" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sid</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">SCRuleIds</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scruleaction">
<h5>SCRuleAction<a class="headerlink" href="#scruleaction" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">action</span> <span class="o">=</span> <span class="n">SCRuleAction</span><span class="p">()</span>
</pre></div>
</div>
<p>returns one of 'pass', 'reject', 'drop' or 'alert'</p>
</div>
<div class="section" id="scrulemsg">
<h5>SCRuleMsg<a class="headerlink" href="#scrulemsg" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span> <span class="o">=</span> <span class="n">SCRuleMsg</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="scruleclass">
<h5>SCRuleClass<a class="headerlink" href="#scruleclass" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">class</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">SCRuleClass</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="streaming-data">
<h4>Streaming Data<a class="headerlink" href="#streaming-data" title="Permalink to this headline">¶</a></h4>
<p>Streaming data can currently log out reassembled TCP data and
normalized HTTP data. The script will be invoked for each consecutive
data chunk.</p>
<p>In case of TCP reassembled data, all possible overlaps are removed
according to the host OS settings.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;streaming&quot;</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>In case of HTTP body data, the bodies are unzipped and dechunked if applicable.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;streaming&quot;</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<div class="section" id="scstreamingbuffer">
<h5>SCStreamingBuffer<a class="headerlink" href="#scstreamingbuffer" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="o">--</span> <span class="n">sb_ts</span> <span class="ow">and</span> <span class="n">sb_tc</span> <span class="n">are</span> <span class="n">bools</span> <span class="n">indicating</span> <span class="n">the</span> <span class="n">direction</span> <span class="n">of</span> <span class="n">the</span> <span class="n">data</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">sb_open</span><span class="p">,</span> <span class="n">sb_close</span><span class="p">,</span> <span class="n">sb_ts</span><span class="p">,</span> <span class="n">sb_tc</span> <span class="o">=</span> <span class="n">SCStreamingBuffer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sb_ts</span> <span class="n">then</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;-&quot;</span><span class="p">)</span>
    <span class="n">end</span>
    <span class="n">hex_dump</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="flow-variables">
<h4>Flow variables<a class="headerlink" href="#flow-variables" title="Permalink to this headline">¶</a></h4>
<p>It is possible to access, define and modify Flow variables from Lua. To do so,
you must use the functions described in this section and declare the counter in
init function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;tls&quot;</span><span class="p">]</span> <span class="n">tostring</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;flowint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tls-cnt&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Here we define a <cite>tls-cnt</cite> Flowint that can now be used in output or in a
signature via dedicated functions. The access to the Flow variable is done by
index so in our case we need to use 0.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">match</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">SCFlowintGet</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">a</span> <span class="n">then</span>
        <span class="n">SCFlowintSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">SCFlowintSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">end</span>
</pre></div>
</div>
<div class="section" id="scflowintget">
<h5>SCFlowintGet<a class="headerlink" href="#scflowintget" title="Permalink to this headline">¶</a></h5>
<p>Get the Flowint at index given by the parameter.</p>
</div>
<div class="section" id="scflowintset">
<h5>SCFlowintSet<a class="headerlink" href="#scflowintset" title="Permalink to this headline">¶</a></h5>
<p>Set the Flowint at index given by the first parameter. The second parameter is the value.</p>
</div>
<div class="section" id="scflowintincr">
<h5>SCFlowintIncr<a class="headerlink" href="#scflowintincr" title="Permalink to this headline">¶</a></h5>
<p>Increment Flowint at index given by the first parameter.</p>
</div>
<div class="section" id="scflowintdecr">
<h5>SCFlowintDecr<a class="headerlink" href="#scflowintdecr" title="Permalink to this headline">¶</a></h5>
<p>Decrement Flowint at index given by the first parameter.</p>
</div>
<div class="section" id="scflowvarget">
<h5>SCFlowvarGet<a class="headerlink" href="#scflowvarget" title="Permalink to this headline">¶</a></h5>
<p>Get the Flowvar at index given by the parameter.</p>
</div>
<div class="section" id="scflowvarset">
<h5>SCFlowvarSet<a class="headerlink" href="#scflowvarset" title="Permalink to this headline">¶</a></h5>
<p>Set a Flowvar. First parameter is the index, second is the data
and third is the length of data.</p>
<p>You can use it to set string</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;http.request_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;flowvar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cnt&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">match</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">SCFlowvarGet</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">a</span> <span class="n">then</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">tonumber</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">SCFlowvarSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="c1">#a)</span>
    <span class="k">else</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">SCFlowvarSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="c1">#a)</span>
    <span class="n">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="misc">
<h4>Misc<a class="headerlink" href="#misc" title="Permalink to this headline">¶</a></h4>
<div class="section" id="scthreadinfo">
<h5>SCThreadInfo<a class="headerlink" href="#scthreadinfo" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tid</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">tgroup</span> <span class="o">=</span> <span class="n">SCThreadInfo</span><span class="p">()</span>
</pre></div>
</div>
<p>It gives: tid (integer), tname (string), tgroup (string)</p>
</div>
<div class="section" id="sclogerror-sclogwarning-sclognotice-scloginfo-sclogdebug">
<h5>SCLogError, SCLogWarning, SCLogNotice, SCLogInfo, SCLogDebug<a class="headerlink" href="#sclogerror-sclogwarning-sclognotice-scloginfo-sclogdebug" title="Permalink to this headline">¶</a></h5>
<p>Print a message. It will go into the outputs defined in the
yaml. Whether it will be printed depends on the log level.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SCLogError</span><span class="p">(</span><span class="s2">&quot;some error message&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sclogpath">
<h5>SCLogPath<a class="headerlink" href="#sclogpath" title="Permalink to this headline">¶</a></h5>
<p>Expose the log path.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fast_lua.log&quot;</span>
<span class="n">function</span> <span class="n">setup</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">SCLogPath</span><span class="p">()</span> <span class="o">..</span> <span class="s2">&quot;/&quot;</span> <span class="o">..</span> <span class="n">name</span>
    <span class="n">file</span> <span class="o">=</span> <span class="k">assert</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">))</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="scbytevarget">
<h5>SCByteVarGet<a class="headerlink" href="#scbytevarget" title="Permalink to this headline">¶</a></h5>
<p>Get the ByteVar at index given by the parameter. These variables are defined by
<cite>byte_extract</cite> or <cite>byte_math</cite> in Suricata rules. Only callable from match scripts.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">&quot;bytevar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var1&quot;</span><span class="p">,</span> <span class="s2">&quot;var2&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Here we define a register that we will be using variables <cite>var1</cite> and <cite>var2</cite>.
The access to the Byte variables is done by index.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">match</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">var1</span> <span class="o">=</span> <span class="n">SCByteVarGet</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">var2</span> <span class="o">=</span> <span class="n">SCByteVarGet</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-file-extraction/file-extraction"></span><div class="section" id="file-extraction">
<span id="id1"></span><h2>File Extraction<a class="headerlink" href="#file-extraction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="architecture">
<h3>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h3>
<p>The file extraction code works on top of selected protocol parsers (see supported protocols below). The application layer parsers run on top of the stream reassembly engine and the UDP flow tracking.</p>
<p>In case of HTTP, the parser takes care of dechunking and unzipping the request and/or response data if necessary.</p>
<p>This means that settings in the stream engine, reassembly engine and the application layer parsers all affect the workings of the file extraction.</p>
<p>The rule language controls which files are extracted and stored on disk.</p>
<p>Supported protocols are:</p>
<ul class="simple">
<li>HTTP</li>
<li>SMTP</li>
<li>FTP</li>
<li>NFS</li>
<li>SMB</li>
<li>HTTP2</li>
</ul>
</div>
<div class="section" id="settings">
<h3>Settings<a class="headerlink" href="#settings" title="Permalink to this headline">¶</a></h3>
<p><em>stream.checksum_validation</em> controls whether or not the stream engine rejects packets with invalid checksums. A good idea normally, but the network interface performs checksum offloading a lot of packets may seem to be broken. This setting is enabled by default, and can be disabled by setting to &quot;no&quot;. Note that the checksum handling can be controlled per interface, see &quot;checksum_checks&quot; in example configuration.</p>
<p><em>file-store.stream-depth</em> controls how far into a stream reassembly is done. Beyond this value no reassembly will be done. This means that after this value the HTTP session will no longer be tracked. By default a setting of 1 Megabyte is used. 0 sets it to unlimited. If set to no, it is disabled and stream.reassembly.depth is considered. Non-zero values must be greater than <code class="docutils literal notranslate"><span class="pre">stream.stream-depth</span></code> to be used.</p>
<p><em>libhtp.default-config.request-body-limit</em> / <em>libhtp.server-config.&lt;config&gt;.request-body-limit</em> controls how much of the HTTP request body is tracked for inspection by the <cite>http_client_body</cite> keyword, but also used to limit file inspection. A value of 0 means unlimited.</p>
<p><em>libhtp.default-config.response-body-limit</em> / <em>libhtp.server-config.&lt;config&gt;.response-body-limit</em> is like the request body limit, only it applies to the HTTP response body.</p>
</div>
<div class="section" id="output">
<h3>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h3>
<div class="section" id="file-store-and-eve-fileinfo">
<h4>File-Store and Eve Fileinfo<a class="headerlink" href="#file-store-and-eve-fileinfo" title="Permalink to this headline">¶</a></h4>
<p>There are two output modules for logging information about extracted files.
The first is <code class="docutils literal notranslate"><span class="pre">eve.files</span></code> which is an <code class="docutils literal notranslate"><span class="pre">eve</span></code> sub-logger
that logs <code class="docutils literal notranslate"><span class="pre">fileinfo</span></code> records. These <code class="docutils literal notranslate"><span class="pre">fileinfo</span></code> records provide
metadata about the file, but not the actual file contents.</p>
<p>This must be enabled in the <code class="docutils literal notranslate"><span class="pre">eve</span></code> output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">outputs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
      <span class="n">types</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">files</span><span class="p">:</span>
              <span class="n">force</span><span class="o">-</span><span class="n">magic</span><span class="p">:</span> <span class="n">no</span>
              <span class="n">force</span><span class="o">-</span><span class="nb">hash</span><span class="p">:</span> <span class="p">[</span><span class="n">md5</span><span class="p">,</span><span class="n">sha256</span><span class="p">]</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="index.html#suricata-yaml-outputs-eve"><span class="std std-ref">Eve (Extensible Event Format)</span></a> for more details on working
with the <cite>eve</cite> output.</p>
<p>The other output module, <code class="docutils literal notranslate"><span class="pre">file-store</span></code> stores the actual files to
disk.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">file-store</span></code> module uses its own log directory (default: <cite>filestore</cite> in
the default logging directory) and logs files using the SHA256 of the
contents as the filename. Each file is then placed in a directory
named <cite>00</cite> to <cite>ff</cite> where the directory shares the first 2 characters
of the filename. For example, if the SHA256 hex string of an extracted
file starts with &quot;f9bc6d...&quot; the file we be placed in the directory
<cite>filestore/f9</cite>.</p>
<p>The size of a file that can be stored depends on <code class="docutils literal notranslate"><span class="pre">file-store.stream-depth</span></code>,
if this value is reached a file can be truncated and might not be stored completely.
If not enabled, <code class="docutils literal notranslate"><span class="pre">stream.reassembly.depth</span></code> will be considered.</p>
<p>Setting <code class="docutils literal notranslate"><span class="pre">file-store.stream-depth</span></code> to 0 permits store of the entire file;
here, 0 means &quot;unlimited.&quot;</p>
<p><code class="docutils literal notranslate"><span class="pre">file-store.stream-depth</span></code> will always override <code class="docutils literal notranslate"><span class="pre">stream.reassembly.depth</span></code>
when filestore keyword is used. However, it is not possible to set <code class="docutils literal notranslate"><span class="pre">file-store.stream-depth</span></code>
to a value less than <code class="docutils literal notranslate"><span class="pre">stream.reassembly.depth</span></code>. Values less than this amount are ignored
and a warning message will be displayed.</p>
<p>A protocol parser, like modbus, could permit to set a different
store-depth value and use it rather than <code class="docutils literal notranslate"><span class="pre">file-store.stream-depth</span></code>.</p>
<p>Using the SHA256 for file names allows for automatic de-duplication of
extracted files. However, the timestamp of a preexisting file will be
updated if the same files is extracted again, similar to the <cite>touch</cite>
command.</p>
<p>Optionally a <code class="docutils literal notranslate"><span class="pre">fileinfo</span></code> record can be written to its own file
sharing the same SHA256 as the file it references. To handle recording
the metadata of each occurrence of an extracted file, these filenames
include some extra fields to ensure uniqueness. Currently the format
is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">SHA256</span><span class="o">&gt;.&lt;</span><span class="n">SECONDS</span><span class="o">&gt;.&lt;</span><span class="n">ID</span><span class="o">&gt;.</span><span class="n">json</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;SECONDS&gt;</span></code> is the seconds from the packet that triggered the
stored file to be closed and <code class="docutils literal notranslate"><span class="pre">&lt;ID&gt;</span></code> is a unique ID for the runtime
of the Suricata instance. These values should not be depended on, and
are simply used to ensure uniqueness.</p>
<p>These <code class="docutils literal notranslate"><span class="pre">fileinfo</span></code> records are identical to the <code class="docutils literal notranslate"><span class="pre">fileinfo</span></code> records
logged to the <code class="docutils literal notranslate"><span class="pre">eve</span></code> output.</p>
<p>See <a class="reference internal" href="index.html#suricata-yaml-file-store"><span class="std std-ref">File-store (File Extraction)</span></a> for more information on
configuring the file-store output.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section documents version 2 of the <code class="docutils literal notranslate"><span class="pre">file-store</span></code>. Version 1 of the file-store has been removed as of Suricata version 6.</p>
</div>
</div>
</div>
<div class="section" id="rules">
<h3>Rules<a class="headerlink" href="#rules" title="Permalink to this headline">¶</a></h3>
<p>Without rules in place no extraction will happen. The simplest rule would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;FILE store all&quot;</span><span class="p">;</span> <span class="n">filestore</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>This will simply store all files to disk.</p>
<p>Want to store all files with a pdf extension?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;FILE PDF file claimed&quot;</span><span class="p">;</span> <span class="n">fileext</span><span class="p">:</span><span class="s2">&quot;pdf&quot;</span><span class="p">;</span> <span class="n">filestore</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Or rather all actual pdf files?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;FILE pdf detected&quot;</span><span class="p">;</span> <span class="n">filemagic</span><span class="p">:</span><span class="s2">&quot;PDF document&quot;</span><span class="p">;</span> <span class="n">filestore</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Or rather only store files from black list checksum md5 ?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Black list checksum match and extract MD5&quot;</span><span class="p">;</span> <span class="n">filemd5</span><span class="p">:</span><span class="n">fileextraction</span><span class="o">-</span><span class="n">chksum</span><span class="o">.</span><span class="n">list</span><span class="p">;</span> <span class="n">filestore</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Or only store files from black list checksum sha1 ?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;Black list checksum match and extract SHA1&quot;</span><span class="p">;</span> <span class="n">filesha1</span><span class="p">:</span><span class="n">fileextraction</span><span class="o">-</span><span class="n">chksum</span><span class="o">.</span><span class="n">list</span><span class="p">;</span> <span class="n">filestore</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">5</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>Or finally store files from black list checksum sha256 ?</p>
<dl class="docutils">
<dt>::</dt>
<dd>alert http any any -&gt; any any (msg:&quot;Black list checksum match and extract SHA256&quot;; filesha256:fileextraction-chksum.list; filestore; sid:6; rev:1;)</dd>
</dl>
<p>Bundled with the Suricata download, is a file with more example rules. In the archive, go to the <cite>rules</cite> directory and check the <code class="docutils literal notranslate"><span class="pre">files.rules</span></code> file.</p>
</div>
<div class="section" id="md5">
<h3>MD5<a class="headerlink" href="#md5" title="Permalink to this headline">¶</a></h3>
<p>Suricata can calculate MD5 checksums of files on the fly and log them. See <a class="reference internal" href="index.html#document-file-extraction/md5"><span class="doc">Storing MD5s checksums</span></a> for an explanation on how to enable this.</p>
<div class="toctree-wrapper compound">
<span id="document-file-extraction/md5"></span><div class="section" id="storing-md5s-checksums">
<span id="md5"></span><h4>Storing MD5s checksums<a class="headerlink" href="#storing-md5s-checksums" title="Permalink to this headline">¶</a></h4>
<div class="section" id="configuration">
<h5>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h5>
<p>In the Suricata config file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">file</span><span class="o">-</span><span class="n">store</span><span class="p">:</span>
     <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>       <span class="c1"># set to yes to enable</span>
     <span class="nb">dir</span><span class="p">:</span> <span class="n">filestore</span>     <span class="c1"># directory to store the files</span>
     <span class="n">force</span><span class="o">-</span><span class="nb">hash</span><span class="p">:</span> <span class="p">[</span><span class="n">md5</span><span class="p">]</span>  <span class="c1"># force logging of md5 checksums</span>
</pre></div>
</div>
<p>For JSON output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">filetype</span><span class="p">:</span> <span class="n">regular</span> <span class="c1">#regular|syslog|unix_dgram|unix_stream|redis</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">eve</span><span class="o">.</span><span class="n">json</span>
    <span class="n">types</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">force</span><span class="o">-</span><span class="n">magic</span><span class="p">:</span> <span class="n">no</span>   <span class="c1"># force logging magic on all logged files</span>
        <span class="c1"># force logging of checksums, available hash functions are md5,</span>
        <span class="c1"># sha1 and sha256</span>
        <span class="c1">#force-hash: [md5]</span>
</pre></div>
</div>
<p>Other settings affecting <a class="reference internal" href="index.html#document-file-extraction/file-extraction"><span class="doc">File Extraction</span></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="p">:</span>
  <span class="n">memcap</span><span class="p">:</span> <span class="mi">64</span><span class="n">mb</span>
  <span class="n">checksum</span><span class="o">-</span><span class="n">validation</span><span class="p">:</span> <span class="n">yes</span>      <span class="c1"># reject wrong csums</span>
  <span class="n">inline</span><span class="p">:</span> <span class="n">no</span>                    <span class="c1"># no inline mode</span>
  <span class="n">reassembly</span><span class="p">:</span>
    <span class="n">memcap</span><span class="p">:</span> <span class="mi">32</span><span class="n">mb</span>
    <span class="n">depth</span><span class="p">:</span> <span class="mi">0</span>                     <span class="c1"># reassemble all of a stream</span>
    <span class="n">toserver</span><span class="o">-</span><span class="n">chunk</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">2560</span>
    <span class="n">toclient</span><span class="o">-</span><span class="n">chunk</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">2560</span>
</pre></div>
</div>
<p>Make sure we have <em>depth: 0</em> so all files can be tracked fully.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libhtp</span><span class="p">:</span>
  <span class="n">default</span><span class="o">-</span><span class="n">config</span><span class="p">:</span>
    <span class="n">personality</span><span class="p">:</span> <span class="n">IDS</span>
    <span class="c1"># Can be specified in kb, mb, gb.  Just a number indicates</span>
    <span class="c1"># it&#39;s in bytes.</span>
    <span class="n">request</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">response</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">limit</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Make sure we have <em>request-body-limit: 0</em> and  <em>response-body-limit: 0</em></p>
</div>
<div class="section" id="testing">
<h5>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h5>
<p>For the purpose of testing we use this rule only in a file.rules (a test/example file):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">http</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;FILE store all&quot;</span><span class="p">;</span> <span class="n">filestore</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
<p>This rule above will save all the file data for files that are opened/downloaded through HTTP</p>
<p>Start Suricata (<code class="docutils literal notranslate"><span class="pre">-S</span></code> option <em>ONLY loads</em> the specified rule file and disregards any other rules that are enabled in suricata.yaml):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">S</span> <span class="n">file</span><span class="o">.</span><span class="n">rules</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span>
</pre></div>
</div>
<p>Meta data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TIME</span><span class="p">:</span>              <span class="mi">05</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mf">52.425751</span>
<span class="n">SRC</span> <span class="n">IP</span><span class="p">:</span>            <span class="mf">2.23.144.170</span>
<span class="n">DST</span> <span class="n">IP</span><span class="p">:</span>            <span class="mf">192.168.1.91</span>
<span class="n">PROTO</span><span class="p">:</span>             <span class="mi">6</span>
<span class="n">SRC</span> <span class="n">PORT</span><span class="p">:</span>          <span class="mi">80</span>
<span class="n">DST</span> <span class="n">PORT</span><span class="p">:</span>          <span class="mi">51598</span>
<span class="n">HTTP</span> <span class="n">URI</span><span class="p">:</span>          <span class="o">/</span><span class="n">en</span><span class="o">/</span><span class="n">US</span><span class="o">/</span><span class="n">prod</span><span class="o">/</span><span class="n">collateral</span><span class="o">/</span><span class="n">routers</span><span class="o">/</span><span class="n">ps5855</span><span class="o">/</span><span class="n">prod_brochure0900aecd8019dc1f</span><span class="o">.</span><span class="n">pdf</span>
<span class="n">HTTP</span> <span class="n">HOST</span><span class="p">:</span>         <span class="n">www</span><span class="o">.</span><span class="n">cisco</span><span class="o">.</span><span class="n">com</span>
<span class="n">HTTP</span> <span class="n">REFERER</span><span class="p">:</span>      <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">cisco</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">en</span><span class="o">/</span><span class="n">us</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">routers</span><span class="o">/</span><span class="mi">3800</span><span class="o">-</span><span class="n">series</span><span class="o">-</span><span class="n">integrated</span><span class="o">-</span><span class="n">services</span><span class="o">-</span><span class="n">routers</span><span class="o">-</span><span class="n">isr</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="n">FILENAME</span><span class="p">:</span>          <span class="o">/</span><span class="n">en</span><span class="o">/</span><span class="n">US</span><span class="o">/</span><span class="n">prod</span><span class="o">/</span><span class="n">collateral</span><span class="o">/</span><span class="n">routers</span><span class="o">/</span><span class="n">ps5855</span><span class="o">/</span><span class="n">prod_brochure0900aecd8019dc1f</span><span class="o">.</span><span class="n">pdf</span>
<span class="n">MAGIC</span><span class="p">:</span>             <span class="n">PDF</span> <span class="n">document</span><span class="p">,</span> <span class="n">version</span> <span class="mf">1.6</span>
<span class="n">STATE</span><span class="p">:</span>             <span class="n">CLOSED</span>
<span class="n">MD5</span><span class="p">:</span>               <span class="mi">59</span><span class="n">eba188e52467adc11bf2442ee5bf57</span>
<span class="n">SIZE</span><span class="p">:</span>              <span class="mi">9485123</span>
</pre></div>
</div>
<p>and in files-json.log (or eve.json) :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;05\/01\/2012-11:10:27.693583&quot;</span><span class="p">,</span> <span class="s2">&quot;ipver&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;srcip&quot;</span><span class="p">:</span> <span class="s2">&quot;2.23.144.170&quot;</span><span class="p">,</span> <span class="s2">&quot;dstip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.91&quot;</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;sp&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;dp&quot;</span><span class="p">:</span> <span class="mi">51598</span><span class="p">,</span> <span class="s2">&quot;http_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;\/en\/US\/prod\/collateral\/routers\/ps5855\/prod_brochure0900aecd8019dc1f.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;http_host&quot;</span><span class="p">:</span> <span class="s2">&quot;www.cisco.com&quot;</span><span class="p">,</span> <span class="s2">&quot;http_referer&quot;</span><span class="p">:</span> <span class="s2">&quot;http:\/\/www.google.com\/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0CDAQFjAA&amp;url=http%3A</span><span class="si">%2F%2F</span><span class="s2">www.cisco.com</span><span class="si">%2F</span><span class="s2">en</span><span class="si">%2F</span><span class="s2">US</span><span class="si">%2F</span><span class="s2">prod</span><span class="si">%2F</span><span class="s2">collateral</span><span class="si">%2F</span><span class="s2">routers</span><span class="si">%2F</span><span class="s2">ps5855</span><span class="si">%2F</span><span class="s2">prod_brochure0900aecd8019dc1f.pdf&amp;ei=OqyfT9eoJubi4QTyiamhAw&amp;usg=AFQjCNGdjDBpBDfQv2r3VogSH41V6T5x9Q&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;\/en\/US\/prod\/collateral\/routers\/ps5855\/prod_brochure0900aecd8019dc1f.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="s2">&quot;PDF document, version 1.6&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">,</span> <span class="s2">&quot;md5&quot;</span><span class="p">:</span> <span class="s2">&quot;59eba188e52467adc11bf2442ee5bf57&quot;</span><span class="p">,</span> <span class="s2">&quot;stored&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">9485123</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;05\/01\/2012-11:12:57.421420&quot;</span><span class="p">,</span> <span class="s2">&quot;ipver&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;srcip&quot;</span><span class="p">:</span> <span class="s2">&quot;2.23.144.170&quot;</span><span class="p">,</span> <span class="s2">&quot;dstip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.91&quot;</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;sp&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;dp&quot;</span><span class="p">:</span> <span class="mi">51598</span><span class="p">,</span> <span class="s2">&quot;http_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;\/en\/US\/prod\/collateral\/routers\/ps5855\/prod_brochure0900aecd8019dc1f.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;http_host&quot;</span><span class="p">:</span> <span class="s2">&quot;www.cisco.com&quot;</span><span class="p">,</span> <span class="s2">&quot;http_referer&quot;</span><span class="p">:</span> <span class="s2">&quot;http:\/\/www.google.com\/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0CDAQFjAA&amp;url=http%3A</span><span class="si">%2F%2F</span><span class="s2">www.cisco.com</span><span class="si">%2F</span><span class="s2">en</span><span class="si">%2F</span><span class="s2">US</span><span class="si">%2F</span><span class="s2">prod</span><span class="si">%2F</span><span class="s2">collateral</span><span class="si">%2F</span><span class="s2">routers</span><span class="si">%2F</span><span class="s2">ps5855</span><span class="si">%2F</span><span class="s2">prod_brochure0900aecd8019dc1f.pdf&amp;ei=OqyfT9eoJubi4QTyiamhAw&amp;usg=AFQjCNGdjDBpBDfQv2r3VogSH41V6T5x9Q&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;\/en\/US\/prod\/collateral\/routers\/ps5855\/prod_brochure0900aecd8019dc1f.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="s2">&quot;PDF document, version 1.6&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">,</span> <span class="s2">&quot;md5&quot;</span><span class="p">:</span> <span class="s2">&quot;59eba188e52467adc11bf2442ee5bf57&quot;</span><span class="p">,</span> <span class="s2">&quot;stored&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">9485123</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="log-all-md5s-without-any-rules">
<h5>Log all MD5s without any rules<a class="headerlink" href="#log-all-md5s-without-any-rules" title="Permalink to this headline">¶</a></h5>
<p>If you would like to log MD5s for everything and anything that passes through the traffic that you are inspecting with Suricata, but not log the files themselves, all you have to do is disable file-store and enable only the JSON output with forced MD5s - in suricata.yaml like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">file</span><span class="o">-</span><span class="n">store</span><span class="p">:</span>
    <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">no</span>       <span class="c1"># set to yes to enable</span>
    <span class="n">log</span><span class="o">-</span><span class="nb">dir</span><span class="p">:</span> <span class="n">files</span>    <span class="c1"># directory to store the files</span>
    <span class="n">force</span><span class="o">-</span><span class="n">filestore</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">force</span><span class="o">-</span><span class="nb">hash</span><span class="p">:</span> <span class="p">[</span><span class="n">md5</span><span class="p">]</span>  <span class="c1"># force logging of md5 checksums</span>
</pre></div>
</div>
</div>
</div>
<span id="document-file-extraction/public-sha1-md5-data-sets"></span><div class="section" id="public-sha1-md5-data-sets">
<h4>Public SHA1 MD5 data sets<a class="headerlink" href="#public-sha1-md5-data-sets" title="Permalink to this headline">¶</a></h4>
<p>National Software Reference Library - <a class="reference external" href="http://www.nsrl.nist.gov/Downloads.html">http://www.nsrl.nist.gov/Downloads.html</a></p>
</div>
</div>
</div>
<div class="section" id="updating-filestore-configuration">
<h3>Updating Filestore Configuration<a class="headerlink" href="#updating-filestore-configuration" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-file-extraction/config-update"></span><div class="section" id="update-file-store-v1-configuration-to-v2">
<span id="filestore-update-v1-to-v2"></span><h4>Update File-store v1 Configuration to V2<a class="headerlink" href="#update-file-store-v1-configuration-to-v2" title="Permalink to this headline">¶</a></h4>
<p>Given a file-store configuration like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">file</span><span class="o">-</span><span class="n">store</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>        <span class="c1"># set to yes to enable</span>
    <span class="n">log</span><span class="o">-</span><span class="nb">dir</span><span class="p">:</span> <span class="n">files</span>      <span class="c1"># directory to store the files</span>
    <span class="n">force</span><span class="o">-</span><span class="n">magic</span><span class="p">:</span> <span class="n">no</span>     <span class="c1"># force logging magic on all stored files</span>
    <span class="n">force</span><span class="o">-</span><span class="nb">hash</span><span class="p">:</span> <span class="p">[</span><span class="n">md5</span><span class="p">]</span>   <span class="c1"># force logging of md5 checksums</span>
    <span class="n">force</span><span class="o">-</span><span class="n">filestore</span><span class="p">:</span> <span class="n">no</span> <span class="c1"># force storing of all files</span>
    <span class="n">stream</span><span class="o">-</span><span class="n">depth</span><span class="p">:</span> <span class="mi">1</span><span class="n">mb</span>   <span class="c1"># reassemble 1mb into a stream, set to no to disable</span>
    <span class="n">waldo</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">waldo</span>   <span class="c1"># waldo file to store the file_id across runs</span>
    <span class="nb">max</span><span class="o">-</span><span class="nb">open</span><span class="o">-</span><span class="n">files</span><span class="p">:</span> <span class="mi">0</span>   <span class="c1"># how many files to keep open (O means none)</span>
    <span class="n">write</span><span class="o">-</span><span class="n">meta</span><span class="p">:</span> <span class="n">yes</span>     <span class="c1"># write a .meta file if set to yes</span>
    <span class="n">include</span><span class="o">-</span><span class="n">pid</span><span class="p">:</span> <span class="n">yes</span>    <span class="c1"># include the pid in filenames if set to yes.</span>
</pre></div>
</div>
<p>The following changes will need to be made to convert to a v2 style configuration:</p>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">version</span></code> field must be set to 2.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">log-dir</span></code> field should be renamed to <code class="docutils literal notranslate"><span class="pre">dir</span></code>. It is recommended to use a new directory instead of an existing v1 directory.</li>
<li>Remove the <code class="docutils literal notranslate"><span class="pre">waldo</span></code> option. It is no longer used.</li>
<li>Remove the <code class="docutils literal notranslate"><span class="pre">write-meta</span></code> option.</li>
<li>Optionally set <code class="docutils literal notranslate"><span class="pre">write-fileinfo</span></code> to enable writing of a metadata file along side the extracted file. Not that this option is disabled by default as a <code class="docutils literal notranslate"><span class="pre">fileinfo</span></code> event can be written to the Eve log file.</li>
<li>Remove the <code class="docutils literal notranslate"><span class="pre">include-pid</span></code> option. There is no equivalent to this option in file-store v2.</li>
</ul>
<p>Example converted configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">file</span><span class="o">-</span><span class="n">store</span><span class="p">:</span>
    <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
    <span class="nb">dir</span><span class="p">:</span> <span class="n">filestore</span>
    <span class="n">force</span><span class="o">-</span><span class="nb">hash</span><span class="p">:</span> <span class="p">[</span><span class="n">md5</span><span class="p">]</span>
    <span class="n">file</span><span class="o">-</span><span class="n">filestore</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">stream</span><span class="o">-</span><span class="n">depth</span><span class="p">:</span> <span class="mi">1</span><span class="n">mb</span>
    <span class="nb">max</span><span class="o">-</span><span class="nb">open</span><span class="o">-</span><span class="n">files</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">write</span><span class="o">-</span><span class="n">fileinfo</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>Refer to the <a class="reference internal" href="index.html#file-extraction"><span class="std std-ref">File Extraction</span></a> section of the manual for information about the format of the file-store directory for file-store v2.</p>
</div>
</div>
</div>
</div>
<span id="document-public-data-sets"></span><div class="section" id="public-data-sets">
<h2>Public Data Sets<a class="headerlink" href="#public-data-sets" title="Permalink to this headline">¶</a></h2>
<p>Collections of pcaps for testing and profiling.</p>
<p>DARPA sets: <a class="reference external" href="https://www.ll.mit.edu/r-d/datasets?author=All&amp;rdarea=All&amp;rdgroup=All&amp;keywords=cyber&amp;tag=All&amp;items_per_page=10">https://www.ll.mit.edu/r-d/datasets?author=All&amp;rdarea=All&amp;rdgroup=All&amp;keywords=cyber&amp;tag=All&amp;items_per_page=10</a></p>
<p>MAWI sets (pkt headers only, no payloads): <a class="reference external" href="http://mawi.wide.ad.jp/mawi/samplepoint-F/2012/">http://mawi.wide.ad.jp/mawi/samplepoint-F/2012/</a></p>
<p>MACCDC: <a class="reference external" href="http://www.netresec.com/?page=MACCDC">http://www.netresec.com/?page=MACCDC</a></p>
<p>Netresec: <a class="reference external" href="http://www.netresec.com/?page=PcapFiles">http://www.netresec.com/?page=PcapFiles</a></p>
<p>Wireshark: <a class="reference external" href="https://gitlab.com/wireshark/wireshark/-/wikis/SampleCaptures">https://gitlab.com/wireshark/wireshark/-/wikis/SampleCaptures</a></p>
<p>Security Onion collection: <a class="reference external" href="https://securityonion.net/docs/Pcaps">https://securityonion.net/docs/Pcaps</a></p>
<p>Stratosphere IPS. Malware Capture Facility Project: <a class="reference external" href="https://stratosphereips.org/category/dataset.html">https://stratosphereips.org/category/dataset.html</a></p>
</div>
<span id="document-capture-hardware/index"></span><div class="section" id="using-capture-hardware">
<h2>Using Capture Hardware<a class="headerlink" href="#using-capture-hardware" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-capture-hardware/endace-dag"></span><div class="section" id="endace-dag">
<h3>Endace DAG<a class="headerlink" href="#endace-dag" title="Permalink to this headline">¶</a></h3>
<p>Suricata comes with native Endace DAG card support. This means Suricata can use the <em>libdag</em> interface directly, instead of a libpcap wrapper (which should also work).</p>
<p>Steps:</p>
<p>Configure with DAG support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">dag</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span> <span class="o">--</span><span class="n">sysconfdir</span><span class="o">=/</span><span class="n">etc</span> <span class="o">--</span><span class="n">localstatedir</span><span class="o">=/</span><span class="n">var</span>
<span class="n">make</span>
<span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
<p>Results in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Suricata</span> <span class="n">Configuration</span><span class="p">:</span>
  <span class="n">AF_PACKET</span> <span class="n">support</span><span class="p">:</span>                       <span class="n">no</span>
  <span class="n">PF_RING</span> <span class="n">support</span><span class="p">:</span>                         <span class="n">no</span>
  <span class="n">NFQueue</span> <span class="n">support</span><span class="p">:</span>                         <span class="n">no</span>
  <span class="n">IPFW</span> <span class="n">support</span><span class="p">:</span>                            <span class="n">no</span>
  <span class="n">DAG</span> <span class="n">enabled</span><span class="p">:</span>                             <span class="n">yes</span>
  <span class="n">Napatech</span> <span class="n">enabled</span><span class="p">:</span>                        <span class="n">no</span>
</pre></div>
</div>
<p>Start with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">dag</span> <span class="mi">0</span><span class="p">:</span><span class="mi">0</span>
</pre></div>
</div>
<p>Started up!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">5570</span><span class="p">]</span> <span class="mi">10</span><span class="o">/</span><span class="mi">7</span><span class="o">/</span><span class="mi">2012</span> <span class="o">--</span> <span class="mi">13</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">30</span> <span class="o">-</span> <span class="p">(</span><span class="n">source</span><span class="o">-</span><span class="n">erf</span><span class="o">-</span><span class="n">dag</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">262</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Info</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ReceiveErfDagThreadInit</span><span class="p">)</span> <span class="o">--</span> <span class="n">Attached</span> <span class="ow">and</span> <span class="n">started</span> <span class="n">stream</span><span class="p">:</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">DAG</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">dag0</span>
<span class="p">[</span><span class="mi">5570</span><span class="p">]</span> <span class="mi">10</span><span class="o">/</span><span class="mi">7</span><span class="o">/</span><span class="mi">2012</span> <span class="o">--</span> <span class="mi">13</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">30</span> <span class="o">-</span> <span class="p">(</span><span class="n">source</span><span class="o">-</span><span class="n">erf</span><span class="o">-</span><span class="n">dag</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">288</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Info</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ReceiveErfDagThreadInit</span><span class="p">)</span> <span class="o">--</span> <span class="n">Starting</span> <span class="n">processing</span> <span class="n">packets</span> <span class="kn">from</span> <span class="nn">stream</span><span class="p">:</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">DAG</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">dag0</span>
</pre></div>
</div>
</div>
<span id="document-capture-hardware/napatech"></span><div class="section" id="napatech">
<h3>Napatech<a class="headerlink" href="#napatech" title="Permalink to this headline">¶</a></h3>
<div class="section" id="contents">
<h4>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li>Introduction</li>
<li>Package Installation</li>
<li>Basic Configuration</li>
<li>Advanced Multithreaded Configuration</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>Napatech packet capture accelerator cards can greatly improve the performance of your Suricata deployment using these
hardware based features:</p>
<blockquote>
<div><ul class="simple">
<li>On board burst buffering (up to 12GB)</li>
<li>Zero-copy kernel bypass DMA</li>
<li>Non-blocking PCIe performance</li>
<li>Port merging</li>
<li>Load distribution to up 128 host buffers</li>
<li>Precise timestamping</li>
<li>Accurate time synchronization</li>
</ul>
</div></blockquote>
<p>The package uses a proprietary shell script to handle the installation process.
In either case, gcc, make and the kernel header files are required to compile the kernel module and
install the software.</p>
</div>
<div class="section" id="package-installation">
<h4>Package Installation<a class="headerlink" href="#package-installation" title="Permalink to this headline">¶</a></h4>
<p><em>Note that make, gcc, and the kernel headers are required for installation</em></p>
<p><em>Root privileges are also required</em></p>
<p>The latest driver and tools installation package can be downloaded from: <a class="reference external" href="https://www.napatech.com/downloads">https://www.napatech.com/downloads</a>.</p>
<p><em>Note that you will be prompted to install the Napatech libpcap library. Answer &quot;yes&quot; if you would like to
use the Napatech card to capture packets in Wireshark, tcpdump, or another pcap based application.
Libpcap is not needed for Suricata as native Napatech API support is included</em></p>
<p>Red Hat Based Distros:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ yum install kernel-devel-$(uname -r) gcc make
       $ ./package_install_3gd.sh
</pre></div>
</div>
<p>Debian Based Distros:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apt-get install linux-headers-$(uname .r) gcc make
       $ ./package_install_3gd.sh
</pre></div>
</div>
<p>To complete installation for all distros <code class="docutils literal notranslate"><span class="pre">ntservice</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /opt/napatech3/bin/ntstart.sh -m
</pre></div>
</div>
</div>
<div class="section" id="suricata-installation">
<h4>Suricata Installation<a class="headerlink" href="#suricata-installation" title="Permalink to this headline">¶</a></h4>
<p>After downloading and extracting the Suricata tarball, you need to run configure to enable Napatech support and
prepare for compilation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./configure --enable-napatech --with-napatech-includes=/opt/napatech3/include --with-napatech-libraries=/opt/napatech3/lib
$ make
$ make install-full
</pre></div>
</div>
</div>
<div class="section" id="suricata-configuration">
<h4>Suricata configuration<a class="headerlink" href="#suricata-configuration" title="Permalink to this headline">¶</a></h4>
<p>Now edit the suricata.yaml file to configure the system. There are three ways
the system can be configured:</p>
<blockquote>
<div><p>1. Auto-config without cpu-affinity: In this mode you specify the stream
configuration in suricata.yaml file and allow the threads to
roam freely. This is good for single processor systems where NUMA node
configuration is not a performance concern.</p>
<p>2. Auto-config with cpu-affinity: In this mode you use the cpu-affinity
of the worker threads to control the creation and configuration of streams.
One stream and one worker thread will be created for each cpu identified in
suricata.yaml. This is best in systems with multiple NUMA nodes (i.e.
multi-processor systems) as the NUMA node of the host buffers is matched
to the core on which the thread is running.</p>
<p>3. Manual-config (legacy): In this mode the underlying Napatech streams are configured
by issuing NTPL commands prior to running Suricata. Suricata then connects
to the existing streams on startup.</p>
</div></blockquote>
</div>
<div class="section" id="example-configuration-auto-config-without-cpu-affinity">
<h4>Example Configuration - Auto-config without cpu-affinity:<a class="headerlink" href="#example-configuration-auto-config-without-cpu-affinity" title="Permalink to this headline">¶</a></h4>
<p>If cpu-affinity is not used it is necessary to explicitly define the streams in
the Suricata configuration file. To use this option the following options should
be set in the Suricata configuration file:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Turn off cpu-affinity</li>
<li>Enable the Napatech &quot;auto-config&quot; option</li>
<li>Specify the streams that should be created on startup</li>
<li>Specify the ports that will provide traffic to Suricata</li>
<li>Specify the hashmode used to distribute traffic to the streams</li>
</ol>
</div></blockquote>
<p>Below are the options to set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">threading</span><span class="p">:</span>
  <span class="nb">set</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span> <span class="n">no</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="n">napatech</span><span class="p">:</span>
    <span class="n">auto</span><span class="o">-</span><span class="n">config</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">streams</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0-3&quot;</span><span class="p">]</span>
    <span class="n">ports</span><span class="p">:</span> <span class="p">[</span><span class="nb">all</span><span class="p">]</span>
    <span class="n">hashmode</span><span class="p">:</span> <span class="n">hash5tuplesorted</span>
</pre></div>
</div>
<p>Now modify <code class="docutils literal notranslate"><span class="pre">ntservice.ini</span></code>. You also need make sure that you have allocated enough
host buffers in <code class="docutils literal notranslate"><span class="pre">ntservice.ini</span></code> for the streams. It's a good idea to also set the
<code class="docutils literal notranslate"><span class="pre">TimeSyncReferencePriority</span></code>. To do this make the following changes to ntservice.ini:</p>
<blockquote>
<div>HostBuffersRx = [4,16,-1] # [number of host buffers, Size(MB), NUMA node]
TimeSyncReferencePriority = OSTime  # Timestamp clock synchronized to the OS</div></blockquote>
<p>Stop and restart <code class="docutils literal notranslate"><span class="pre">ntservice</span></code> after making changes to ntservice:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /opt/napatech3/bin/ntstop.sh
$ /opt/napatech3/bin/ntstart.sh
</pre></div>
</div>
<p>Now you are ready to start Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ suricata -c /usr/local/etc/suricata/suricata.yaml --napatech --runmode workers
</pre></div>
</div>
</div>
<div class="section" id="example-configuration-auto-config-with-cpu-affinity">
<h4>Example Configuration - Auto-config with cpu-affinity:<a class="headerlink" href="#example-configuration-auto-config-with-cpu-affinity" title="Permalink to this headline">¶</a></h4>
<p>This option will create a single worker-thread and stream for each CPU defined in the
<code class="docutils literal notranslate"><span class="pre">worker-cpu-set</span></code>. To use this option make the following changes to suricata.yaml:</p>
<ol class="arabic simple">
<li>Turn on cpu-affinity</li>
<li>Specify the worker-cpu-set</li>
<li>Enable the Napatech &quot;auto-config&quot; option</li>
<li>Specify the ports that will provide traffic to Suricata</li>
<li>Specify the hashmode that will be used to control the distribution of
traffic to the different streams/cpus.</li>
</ol>
<p>When you are done it should look similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">threading</span><span class="p">:</span>
  <span class="nb">set</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span>
    <span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
      <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
    <span class="n">receive</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
      <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
    <span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
      <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="nb">all</span> <span class="p">]</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
<span class="n">napatech</span><span class="p">:</span>
  <span class="n">auto</span><span class="o">-</span><span class="n">config</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ports</span><span class="p">:</span> <span class="p">[</span><span class="nb">all</span><span class="p">]</span>
  <span class="n">hashmode</span><span class="p">:</span> <span class="n">hash5tuplesorted</span>
</pre></div>
</div>
<p>Prior to running Suricata in this mode you also need to configure a sufficient
number of host buffers on each NUMA node. So, for example, if you have a two
processor server with 32 total cores and you plan to use all of the cores you
will need to allocate 16 host buffers on each NUMA node. It is also desirable
to set the Napatech cards time source to the OS.</p>
<p>To do this make the following changes to ntservice.ini:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TimeSyncReferencePriority</span> <span class="o">=</span> <span class="n">OSTime</span>  <span class="c1"># Timestamp clock synchronized to the OS</span>
<span class="n">HostBuffersRx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># [number of host buffers, Size(MB), NUMA node]</span>
</pre></div>
</div>
<p>Stop and restart <code class="docutils literal notranslate"><span class="pre">ntservice</span></code> after making changes to ntservice:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /opt/napatech3/bin/ntstop.sh -m
$ /opt/napatech3/bin/ntstart.sh -m
</pre></div>
</div>
<p>Now you are ready to start Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ suricata -c /usr/local/etc/suricata/suricata.yaml --napatech --runmode workers
</pre></div>
</div>
</div>
<div class="section" id="example-configuration-manual-configuration">
<h4>Example Configuration - Manual Configuration<a class="headerlink" href="#example-configuration-manual-configuration" title="Permalink to this headline">¶</a></h4>
<p>For Manual Configuration the Napatech streams are created by running NTPL
commands prior to running Suricata.</p>
<p>Note that this option is provided primarily for legacy configurations as previously
this was the only way to configure Napatech products. Newer capabilities such as
flow-awareness and inline processing cannot be configured manually.</p>
<p>In this example we will setup the Napatech capture accelerator to merge all physical
ports, and then distribute the merged traffic to four streams that Suricata will ingest.</p>
<dl class="docutils">
<dt>The steps for this configuration are:</dt>
<dd><ol class="first last arabic simple">
<li>Disable the Napatech auto-config option in suricata.yaml</li>
<li>Specify the streams that Suricata is to use in suricata.yaml</li>
<li>Create a file with NTPL commands to create the underlying Napatech streams.</li>
</ol>
</dd>
</dl>
<p>First suricata.yaml should be configured similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">napatech</span><span class="p">:</span>
  <span class="n">auto</span><span class="o">-</span><span class="n">config</span><span class="p">:</span> <span class="n">no</span>
  <span class="n">streams</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0-3&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Next you need to make sure you have enough host buffers defined in ntservice.ini. As
it's also a good idea to set up the TimeSync. Here are the lines to change:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TimeSyncReferencePriority</span> <span class="o">=</span> <span class="n">OSTime</span>      <span class="c1"># Timestamp clock synchronized to the OS</span>
<span class="n">HostBuffersRx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>               <span class="c1"># [number of host buffers, Size(MB), NUMA node]</span>
</pre></div>
</div>
<p>Stop and restart ntservice after making changes to ntservice:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /opt/napatech3/bin/ntstop.sh
$ /opt/napatech3/bin/ntstart.sh
</pre></div>
</div>
<p>Now that ntservice is running we need to execute a few NTPL (Napatech Programming Language)
commands to complete the setup. Create a file will the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Delete</span><span class="o">=</span><span class="n">All</span>                              <span class="c1"># Delete any existing filters</span>
<span class="n">Assign</span><span class="p">[</span><span class="n">streamid</span><span class="o">=</span><span class="p">(</span><span class="mf">0..3</span><span class="p">)]</span><span class="o">=</span> <span class="nb">all</span>    <span class="c1"># Assign all physical ports to stream ID 0</span>
</pre></div>
</div>
<p>Next execute those command using the <code class="docutils literal notranslate"><span class="pre">ntpl</span></code> tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /opt/napatech3/bin/ntpl -f &lt;my_ntpl_file&gt;
</pre></div>
</div>
<p>Now you are ready to start Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ suricata -c /usr/local/etc/suricata/suricata.yaml --napatech --runmode workers
</pre></div>
</div>
<p>It is possible to specify much more elaborate configurations using this option. Simply by
creating the appropriate NTPL file and attaching Suricata to the streams.</p>
</div>
<div class="section" id="bypassing-flows">
<h4>Bypassing Flows<a class="headerlink" href="#bypassing-flows" title="Permalink to this headline">¶</a></h4>
<p>On flow-aware Napatech products, traffic from individual flows can be automatically
dropped or, in the case of inline configurations, forwarded by the hardware after
an inspection of the initial packet(s) of the flow by Suricata. This will save
CPU cycles since Suricata does not process packets for a flow that has already been
adjudicated. This is enabled via the hardware-bypass option in the Napatech section
of the configuration file.</p>
<p>When hardware bypass is used it is important that the ports accepting upstream
and downstream traffic from the network are configured with information on
which port the two sides of the connection will arrive. This is needed for the
hardware to properly process traffic in both directions. This is indicated in the
&quot;ports&quot; section as a hyphen separated list of port-pairs that will be receiving
upstream and downstream traffic E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">napatech</span><span class="p">:</span>
  <span class="n">hardware</span><span class="o">-</span><span class="n">bypass</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that these &quot;port-pairings&quot; are also required for IDS configurations as the hardware
needs to know on which port(s) two sides of the connection will arrive.</p>
<p>For configurations relying on optical taps the two sides of the pairing will typically
be different ports. For SPAN port configurations where both upstream and downstream traffic
are delivered to a single port both sides of the &quot;port-pair&quot; will reference the same port.</p>
<p>For example tap configurations have a form similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<p>Whereas SPAN port configurations it would look similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that SPAN and tap configurations may be combined on the same adapter.</p>
<p>There are multiple ways that Suricata can be configured to bypass traffic.
One way is to enable stream.bypass in the configuration file. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="p">:</span>
  <span class="n">bypass</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p>When enabled once Suricata has evaluated the first chunk of the stream (the
size of which is also configurable) it will indicate that the rest of the
packets in the flow can be bypassed. In IDS mode this means that the subsequent
packets of the flow will be dropped and not delivered to Suricata. In inline
operation the packets will be transmitted on the output port but not delivered
to Suricata.</p>
<p>Another way is by specifying the &quot;bypass&quot; keyword in a rule. When a rule is
triggered with this keyword then the &quot;pass&quot; or &quot;drop&quot; action will be applied
to subsequent packets of the flow automatically without further analysis by
Suricata. For example given the rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drop</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="mi">443</span> <span class="o">&lt;&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="s2">&quot;SURICATA Test rule&quot;</span><span class="p">;</span> <span class="n">bypass</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1000001</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
</pre></div>
</div>
<p>Once Suricata initially evaluates the fist packet(s) and identifies the flow,
all subsequent packets from the flow will be dropped by the hardware; thus
saving CPU cycles for more important tasks.</p>
<p>The timeout value for how long to wait before evicting stale flows from the
hardware flow table can be specified via the FlowTimeout attribute in ntservice.ini.</p>
</div>
<div class="section" id="inline-operation">
<h4>Inline Operation<a class="headerlink" href="#inline-operation" title="Permalink to this headline">¶</a></h4>
<p>Napatech flow-aware products can be configured for inline operation. This is
specified in the configuration file. When enabled, ports are specified as
port-pairs. With traffic received from one port it is transmitted out the
the peer port after inspection by Suricata. E.g. the configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">napatech</span><span class="p">:</span>
 <span class="n">inline</span><span class="p">:</span> <span class="n">enabled</span>
 <span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<p>Will pair ports 0 and 1; and 2 and 3 as peers. Rules can be defined to
pass traffic matching a given signature. For example, given the rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">pass</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="mi">443</span> <span class="o">&lt;&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="s2">&quot;SURICATA Test rule&quot;</span><span class="p">;</span>  <span class="n">bypass</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1000001</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">2</span><span class="p">;)</span>
</pre></div>
</div>
<p>Suricata will evaluate the initial packet(s) of the flow and program the flow
into the hardware. Subsequent packets from the flow will be automatically be
shunted from one port to it's peer.</p>
</div>
<div class="section" id="counters">
<h4>Counters<a class="headerlink" href="#counters" title="Permalink to this headline">¶</a></h4>
<p>The following counters are available:</p>
<ul class="simple">
<li>napa_total.pkts - The total of packets received by the card.</li>
<li>napa_total.byte - The total count of bytes received by the card.</li>
<li>napa_total.overflow_drop_pkts - The number of packets that were dropped because
the host buffers were full. (I.e. the application is not able to process
packets quickly enough.)</li>
<li>napa_total.overflow_drop_byte - The number of bytes that were dropped because
the host buffers were full. (I.e. the application is not able to process
packets quickly enough.)</li>
</ul>
<p>On flow-aware products the following counters are also available:</p>
<ul>
<li><p class="first">napa_dispatch_host.pkts, napa_dispatch_host.byte:</p>
<p>The total number of packets/bytes that were dispatched to a host buffer for
processing by Suricata. (Note: this count includes packets that may be
subsequently dropped if there is no room in the host buffer.)</p>
</li>
<li><p class="first">napa_dispatch_drop.pkts, napa_dispatch_drop.byte:</p>
<p>The total number of packets/bytes that were dropped at the hardware as
a result of a Suricata &quot;drop&quot; bypass rule or other adjudication by
Suricata that the flow packets should be dropped. These packets are not
delivered to the application.</p>
</li>
<li><p class="first">napa_dispatch_fwd.pkts, napa_dispatch_fwd.byte:</p>
<p>When inline operation is configured this is the total number of packets/bytes
that were forwarded as result of a Suricata &quot;pass&quot; bypass rule or as a result
of stream or encryption bypass being enabled in the configuration file.
These packets were not delivered to the application.</p>
</li>
<li><p class="first">napa_bypass.active_flows:</p>
<p>The number of flows actively programmed on the hardware to be forwarded or dropped.</p>
</li>
<li><p class="first">napa_bypass.total_flows:</p>
<p>The total count of flows programmed since the application started.</p>
</li>
</ul>
<p>If enable-stream-stats is enabled in the configuration file then, for each stream
that is being processed, the following counters will be output in stats.log:</p>
<ul class="simple">
<li>napa&lt;streamid&gt;.pkts: The number of packets received by the stream.</li>
<li>napa&lt;streamid&gt;.bytes: The total bytes received by the stream.</li>
<li>napa&lt;streamid&gt;.drop_pkts: The number of packets dropped from this stream due to buffer overflow conditions.</li>
<li>napa&lt;streamid&gt;.drop_byte: The number of bytes dropped from this stream due to buffer overflow conditions.</li>
</ul>
<p>This is useful for fine-grain debugging to determine if a specific CPU core or
thread is falling behind resulting in dropped packets.</p>
<p>If hba is enabled the following counter will also be provided:</p>
<ul class="simple">
<li>napa&lt;streamid&gt;.hba_drop: the number of packets dropped because the host buffer allowance high-water mark was reached.</li>
</ul>
<p>In addition to counters host buffer utilization is tracked and logged. This is also useful for
debugging. Log messages are output for both Host and On-Board buffers when reach 25, 50, 75
percent of utilization. Corresponding messages are output when utilization decreases.</p>
<p>Debugging:</p>
<p>For debugging configurations it is useful to see what traffic is flowing as well as what streams are
created and receiving traffic. There are two tools in /opt/napatech3/bin that are useful for this:</p>
<ul class="simple">
<li>monitoring: this tool will, among other things, show what traffic is arriving at the port interfaces.</li>
<li>profiling: this will show host-buffers, streams and traffic flow to the streams.</li>
</ul>
<p>If Suricata terminates abnormally stream definitions, which are normally removed at shutdown, may remain in effect.
If this happens they can be cleared by issuing the &quot;delete=all&quot; NTPL command as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /opt/napatech3/bin/ntpl -e &quot;delete=all&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="napatech-configuration-options">
<h4>Napatech configuration options:<a class="headerlink" href="#napatech-configuration-options" title="Permalink to this headline">¶</a></h4>
<p>These are the Napatech options available in the Suricata configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">napatech</span><span class="p">:</span>
  <span class="c1"># The Host Buffer Allowance for all streams</span>
  <span class="c1"># (-1 = OFF, 1 - 100 = percentage of the host buffer that can be held back)</span>
  <span class="c1"># This may be enabled when sharing streams with another application.</span>
  <span class="c1"># Otherwise, it should be turned off.</span>
  <span class="c1">#</span>
  <span class="c1"># Note: hba will be deprecated in Suricata 7</span>
  <span class="c1">#</span>
  <span class="c1">#hba: -1</span>

  <span class="c1"># When use_all_streams is set to &quot;yes&quot; the initialization code will query</span>
  <span class="c1"># the Napatech service for all configured streams and listen on all of them.</span>
  <span class="c1"># When set to &quot;no&quot; the streams config array will be used.</span>
  <span class="c1">#</span>
  <span class="c1"># This option necessitates running the appropriate NTPL commands to create</span>
  <span class="c1"># the desired streams prior to running Suricata.</span>
  <span class="c1">#use-all-streams: no</span>

  <span class="c1"># The streams to listen on when auto-config is disabled or when threading</span>
  <span class="c1"># cpu-affinity is disabled. This can be either:</span>
  <span class="c1">#   an individual stream (e.g. streams: [0])</span>
  <span class="c1"># or</span>
  <span class="c1">#   a range of streams (e.g. streams: [&quot;0-3&quot;])</span>
  <span class="c1">#</span>
  <span class="n">streams</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0-3&quot;</span><span class="p">]</span>

  <span class="c1"># Stream stats can be enabled to provide fine grain packet and byte counters</span>
  <span class="c1"># for each thread/stream that is configured.</span>
  <span class="c1">#</span>
  <span class="n">enable</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="n">stats</span><span class="p">:</span> <span class="n">no</span>

  <span class="c1"># When auto-config is enabled the streams will be created and assigned</span>
  <span class="c1"># automatically to the NUMA node where the thread resides. If cpu-affinity</span>
  <span class="c1"># is enabled in the threading section, then the streams will be created</span>
  <span class="c1"># according to the number of worker threads specified in the worker cpu set.</span>
  <span class="c1"># Otherwise, the streams array is used to define the streams.</span>
  <span class="c1">#</span>
  <span class="c1"># This option cannot be used simultaneous with &quot;use-all-streams&quot;.</span>
  <span class="c1">#</span>
  <span class="n">auto</span><span class="o">-</span><span class="n">config</span><span class="p">:</span> <span class="n">yes</span>

  <span class="c1"># Enable hardware level flow bypass.</span>
  <span class="c1">#</span>
  <span class="n">hardware</span><span class="o">-</span><span class="n">bypass</span><span class="p">:</span> <span class="n">yes</span>

  <span class="c1"># Enable inline operation. When enabled traffic arriving on a given port is</span>
  <span class="c1"># automatically forwarded out it&#39;s peer port after analysis by Suricata.</span>
  <span class="c1"># hardware-bypass must be enabled when this is enabled.</span>
  <span class="c1">#</span>
  <span class="n">inline</span><span class="p">:</span> <span class="n">no</span>

  <span class="c1"># Ports indicates which napatech ports are to be used in auto-config mode.</span>
  <span class="c1"># these are the port ID&#39;s of the ports that will be merged prior to the</span>
  <span class="c1"># traffic being distributed to the streams.</span>
  <span class="c1">#</span>
  <span class="c1"># When hardware-bypass is enabled the ports must be configured as a segment</span>
  <span class="c1"># specify the port(s) on which upstream and downstream traffic will arrive.</span>
  <span class="c1"># This information is necessary for the hardware to properly process flows.</span>
  <span class="c1">#</span>
  <span class="c1"># When using a tap configuration one of the ports will receive inbound traffic</span>
  <span class="c1"># for the network and the other will receive outbound traffic. The two ports on a</span>
  <span class="c1"># given segment must reside on the same network adapter.</span>
  <span class="c1">#</span>
  <span class="c1"># When using a SPAN-port configuration the upstream and downstream traffic</span>
  <span class="c1"># arrives on a single port. This is configured by setting the two sides of the</span>
  <span class="c1"># segment to reference the same port.  (e.g. 0-0 to configure a SPAN port on</span>
  <span class="c1"># port 0).</span>
  <span class="c1">#</span>
  <span class="c1"># port segments are specified in the form:</span>
  <span class="c1">#    ports: [0-1,2-3,4-5,6-6,7-7]</span>
  <span class="c1">#</span>
  <span class="c1"># For legacy systems when hardware-bypass is disabled this can be specified in any</span>
  <span class="c1"># of the following ways:</span>
  <span class="c1">#</span>
  <span class="c1">#   a list of individual ports (e.g. ports: [0,1,2,3])</span>
  <span class="c1">#</span>
  <span class="c1">#   a range of ports (e.g. ports: [0-3])</span>
  <span class="c1">#</span>
  <span class="c1">#   &quot;all&quot; to indicate that all ports are to be merged together</span>
  <span class="c1">#   (e.g. ports: [all])</span>
  <span class="c1">#</span>
  <span class="c1"># This parameter has no effect if auto-config is disabled.</span>
  <span class="c1">#</span>
  <span class="n">ports</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

  <span class="c1"># When auto-config is enabled the hashmode specifies the algorithm for</span>
  <span class="c1"># determining to which stream a given packet is to be delivered.</span>
  <span class="c1"># This can be any valid Napatech NTPL hashmode command.</span>
  <span class="c1">#</span>
  <span class="c1"># The most common hashmode commands are: hash2tuple, hash2tuplesorted,</span>
  <span class="c1"># hash5tuple, hash5tuplesorted and roundrobin.</span>
  <span class="c1">#</span>
  <span class="c1"># See Napatech NTPL documentation other hashmodes and details on their use.</span>
  <span class="c1">#</span>
  <span class="c1"># This parameter has no effect if auto-config is disabled.</span>
  <span class="c1">#</span>
  <span class="n">hashmode</span><span class="p">:</span> <span class="n">hash5tuplesorted</span>
</pre></div>
</div>
<p><em>Note: hba is useful only when a stream is shared with another application. When hba is enabled packets will be dropped
(i.e. not delivered to Suricata) when the host-buffer utilization reaches the high-water mark indicated by the hba value.
This insures that, should Suricata get behind in its packet processing, the other application will still receive all
of the packets. If this is enabled without another application sharing the stream it will result in sub-optimal packet
buffering.</em></p>
<p>Make sure that there are enough host-buffers declared in <code class="docutils literal notranslate"><span class="pre">ntservice.ini</span></code> to
accommodate the number of cores/streams being used.</p>
</div>
<div class="section" id="support">
<h4>Support<a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h4>
<p>Contact a support engineer at: <a class="reference external" href="mailto:ntsupport&#37;&#52;&#48;napatech&#46;com">ntsupport<span>&#64;</span>napatech<span>&#46;</span>com</a></p>
<p>Napatech Documentation can be found at: <a class="reference external" href="https://docs.napatech.com">https://docs.napatech.com</a> (Click the search icon, with no search text,
to see all documents in the portal.)</p>
</div>
</div>
<span id="document-capture-hardware/myricom"></span><div class="section" id="myricom">
<h3>Myricom<a class="headerlink" href="#myricom" title="Permalink to this headline">¶</a></h3>
<p>From: <a class="reference external" href="https://blog.inliniac.net/2012/07/10/suricata-on-myricom-capture-cards/">https://blog.inliniac.net/2012/07/10/suricata-on-myricom-capture-cards/</a></p>
<p>In this guide I'll describe using the Myricom libpcap support. I'm going to assume you installed the card properly, installed the Sniffer driver and made sure that all works. Make sure <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> shows that the card is in sniffer mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="mf">2102.860241</span><span class="p">]</span> <span class="n">myri_snf</span> <span class="n">INFO</span><span class="p">:</span> <span class="n">eth4</span><span class="p">:</span> <span class="n">Link0</span> <span class="ow">is</span> <span class="n">UP</span>
<span class="p">[</span> <span class="mf">2101.341965</span><span class="p">]</span> <span class="n">myri_snf</span> <span class="n">INFO</span><span class="p">:</span> <span class="n">eth5</span><span class="p">:</span> <span class="n">Link0</span> <span class="ow">is</span> <span class="n">UP</span>
</pre></div>
</div>
<p>I have installed the Myricom runtime and libraries in <code class="docutils literal notranslate"><span class="pre">/opt/snf</span></code></p>
<p>Compile Suricata against Myricom's libpcap:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">libpcap</span><span class="o">-</span><span class="n">includes</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">snf</span><span class="o">/</span><span class="n">include</span><span class="o">/</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">libpcap</span><span class="o">-</span><span class="n">libraries</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">snf</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span> <span class="o">--</span><span class="n">sysconfdir</span><span class="o">=/</span><span class="n">etc</span> <span class="o">--</span><span class="n">localstatedir</span><span class="o">=/</span><span class="n">var</span>
<span class="n">make</span>
<span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
<p>Next, configure the amount of ringbuffers. I'm going to work with 8 here, as my quad core + hyper threading has 8 logical CPUs. <em>See below</em> for additional information about the buffer-size parameter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth5</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">8</span>
    <span class="n">buffer</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">512</span><span class="n">kb</span>
    <span class="n">checksum</span><span class="o">-</span><span class="n">checks</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<p>The 8 threads setting causes Suricata to create 8 reader threads for eth5. The Myricom driver makes sure each of those is attached to its own ringbuffer.</p>
<p>Then start Suricata as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SNF_NUM_RINGS</span><span class="o">=</span><span class="mi">8</span> <span class="n">SNF_FLAGS</span><span class="o">=</span><span class="mh">0x1</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth5</span> <span class="o">--</span><span class="n">runmode</span><span class="o">=</span><span class="n">workers</span>
</pre></div>
</div>
<p>If you want 16 ringbuffers, update the &quot;threads&quot; variable in the Suricata configuration file to <cite>16</cite> and start Suricata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SNF_NUM_RINGS</span><span class="o">=</span><span class="mi">16</span> <span class="n">SNF_FLAGS</span><span class="o">=</span><span class="mh">0x1</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth5</span> <span class="o">--</span><span class="n">runmode</span><span class="o">=</span><span class="n">workers</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">pcap.buffer-size</span></code> configuration setting shown above is currently ignored when using Myricom cards. The value is passed through to the <code class="docutils literal notranslate"><span class="pre">pcap_set_buffer_size</span></code> libpcap API within the Suricata source code. From Myricom support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;The libpcap interface to Sniffer10G ignores the pcap_set_buffer_size() value.  The call to snf_open() uses zero as the dataring_size which informs the Sniffer library to use a default value or the value from the SNF_DATARING_SIZE environment variable.&quot;</span>
</pre></div>
</div>
<p>The following pull request opened by Myricom in the libpcap project indicates that a future SNF software release could provide support for setting the SNF_DATARING_SIZE via the pcap.buffer-size yaml setting:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/the-tcpdump-group/libpcap/pull/435">https://github.com/the-tcpdump-group/libpcap/pull/435</a></li>
</ul>
<p>Until then, the data ring and descriptor ring values can be explicitly set using the SNF_DATARING_SIZE and SNF_DESCRING_SIZE environment variables, respectively.</p>
<p>The SNF_DATARING_SIZE is the total amount of memory to be used for storing incoming packet data. This size is shared across all rings.
The SNF_DESCRING_SIZE is the total amount of memory to be used for storing meta information about the packets (packet lengths, offsets, timestamps). This size is also shared across all rings.</p>
<p>Myricom recommends that the descriptor ring be 1/4 the size of the data ring, but the ratio can be modified based on your traffic profile.
If not set explicitly, Myricom uses the following default values: SNF_DATARING_SIZE = 256MB, and SNF_DESCRING_SIZE = 64MB</p>
<p>Expanding on the 16 thread example above, you can start Suricata with a 16GB Data Ring and a 4GB Descriptor Ring using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SNF_NUM_RINGS</span><span class="o">=</span><span class="mi">16</span> <span class="n">SNF_DATARING_SIZE</span><span class="o">=</span><span class="mi">17179869184</span> <span class="n">SNF_DESCRING_SIZE</span><span class="o">=</span><span class="mi">4294967296</span> <span class="n">SNF_FLAGS</span><span class="o">=</span><span class="mh">0x1</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth5</span> <span class="o">--</span><span class="n">runmode</span><span class="o">=</span><span class="n">workers</span>
</pre></div>
</div>
<div class="section" id="debug-info">
<h4>Debug Info<a class="headerlink" href="#debug-info" title="Permalink to this headline">¶</a></h4>
<p>Myricom also provides a means for obtaining debug information. This can be useful for verifying your configuration and gathering additional information.
Setting SNF_DEBUG_MASK=3 enables debug information, and optionally setting the SNF_DEBUG_FILENAME allows you to specify the location of the output file.</p>
<p>Following through with the example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SNF_NUM_RINGS</span><span class="o">=</span><span class="mi">16</span> <span class="n">SNF_DATARING_SIZE</span><span class="o">=</span><span class="mi">17179869184</span> <span class="n">SNF_DESCRING_SIZE</span><span class="o">=</span><span class="mi">4294967296</span> <span class="n">SNF_FLAGS</span><span class="o">=</span><span class="mh">0x1</span> <span class="n">SNF_DEBUG_MASK</span><span class="o">=</span><span class="mi">3</span> <span class="n">SNF_DEBUG_FILENAME</span><span class="o">=</span><span class="s2">&quot;/tmp/snf.out&quot;</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth5</span> <span class="o">--</span><span class="n">runmode</span><span class="o">=</span><span class="n">workers</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-info">
<h4>Additional Info<a class="headerlink" href="#additional-info" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="http://www.40gbe.net/index_files/be59da7f2ab5bf0a299ab99ef441bb2e-28.html">http://www.40gbe.net/index_files/be59da7f2ab5bf0a299ab99ef441bb2e-28.html</a></li>
<li><a class="reference external" href="https://www.broadcom.com/support/knowledgebase/1211161394432/how-to-use-emulex-oneconnect-oce12000-d-adapters-with-faststack">https://www.broadcom.com/support/knowledgebase/1211161394432/how-to-use-emulex-oneconnect-oce12000-d-adapters-with-faststack</a>-</li>
</ul>
</div>
</div>
<span id="document-capture-hardware/ebpf-xdp"></span><div class="section" id="ebpf-and-xdp">
<span id="ebpf-xdp"></span><h3>eBPF and XDP<a class="headerlink" href="#ebpf-and-xdp" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>eBPF stands for extended BPF. This is an extended version of Berkeley Packet Filter available in recent
Linux kernel versions.</p>
<p>It provides more advanced features with eBPF programs developed in C and capability to use structured data shared
between kernel and userspace.</p>
<p>eBPF is used for three things in Suricata:</p>
<ul class="simple">
<li>eBPF filter: any BPF like filter can be developed. An example of filter accepting only packet for some VLANs is provided. A bypass implementation is also provided.</li>
<li>eBPF load balancing: provide programmable load balancing. Simple ippair load balancing is provided.</li>
<li>XDP programs: Suricata can load XDP programs. A bypass program is provided.</li>
</ul>
<p>Bypass can be implemented in eBPF and XDP. The advantage of XDP is that the packets are dropped at the earliest stage
possible. So performance is better. But bypassed packets don't reach the network so you can't use this on regular
traffic but only on duplicated/sniffed traffic.</p>
<p>The bypass implementation relies on one of the most powerful concept of eBPF: maps. A map is a data structure
shared between user space and kernel space/hardware. It allows user space and kernel space to interact, pass
information. Maps are often implemented as arrays or hash tables that can contain arbitrary key, value pairs.</p>
<div class="section" id="xdp">
<h5>XDP<a class="headerlink" href="#xdp" title="Permalink to this headline">¶</a></h5>
<p>XDP provides another Linux native way of optimising Suricata's performance on sniffing high speed networks:</p>
<blockquote>
<div>XDP or eXpress Data Path provides a high performance, programmable network data path in the Linux kernel as part of the IO Visor Project. XDP provides bare metal packet processing at the lowest point in the software stack which makes it ideal for speed without compromising programmability. Furthermore, new functions can be implemented dynamically with the integrated fast path without kernel modification.</div></blockquote>
<p>More info about XDP:</p>
<ul class="simple">
<li><a class="reference external" href="https://www.iovisor.org/technology/xdp">IOVisor's XDP page</a></li>
<li><a class="reference external" href="https://docs.cilium.io/en/stable/bpf/">Cilium's BPF and XDP reference guide</a></li>
</ul>
</div>
</div>
<div class="section" id="requirements">
<h4>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h4>
<p>You will need a kernel that supports XDP and, for the most performance improvement, a network
card that support XDP in the driver.</p>
<p>Suricata XDP code has been tested with 4.13.10 but 4.15 or later is necessary to use all
features like the CPU redirect map.</p>
<p>If you are using an Intel network card, you will need to stay with in tree kernel NIC drivers.
The out of tree drivers do not contain the XDP support.</p>
<p>Having a network card with support for RSS symmetric hashing is a good point or you will have to
use the XDP CPU redirect map feature.</p>
</div>
<div class="section" id="prerequisites">
<h4>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h4>
<p>This guide has been confirmed on Debian/Ubuntu &quot;LTS&quot; Linux.</p>
<div class="section" id="disable-irqbalance">
<h5>Disable irqbalance<a class="headerlink" href="#disable-irqbalance" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">irqbalance</span></code> may cause issues in most setups described here, so it is recommended
to deactivate it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">irqbalance</span>
<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">irqbalance</span>
</pre></div>
</div>
</div>
<div class="section" id="kernel">
<h5>Kernel<a class="headerlink" href="#kernel" title="Permalink to this headline">¶</a></h5>
<p>You need to run a kernel 4.13 or newer.</p>
</div>
<div class="section" id="clang-and-dependencies">
<h5>Clang and dependencies<a class="headerlink" href="#clang-and-dependencies" title="Permalink to this headline">¶</a></h5>
<p>Make sure you have <code class="docutils literal notranslate"><span class="pre">clang</span></code> (&gt;=3.9) installed on the system</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">clang</span>
</pre></div>
</div>
<p>Some i386 headers will also be needed as eBPF is not x86_64 and some included headers
are architecture specific</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">libc6</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">i386</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">recommends</span>
</pre></div>
</div>
</div>
<div class="section" id="libbpf">
<h5>libbpf<a class="headerlink" href="#libbpf" title="Permalink to this headline">¶</a></h5>
<p>Suricata uses libbpf to interact with eBPF and XDP</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">libbpf</span><span class="o">/</span><span class="n">libbpf</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>Now, you can build and install the library</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">libbpf</span><span class="o">/</span><span class="n">src</span><span class="o">/</span>
<span class="n">make</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>

<span class="n">sudo</span> <span class="n">make</span> <span class="n">install_headers</span>
<span class="n">sudo</span> <span class="n">ldconfig</span>
</pre></div>
</div>
<p>In some cases your system will not find the libbpf library that is installed under
<code class="docutils literal notranslate"><span class="pre">/usr/lib64</span></code> so you may need to modify your ldconfig configuration.</p>
</div>
</div>
<div class="section" id="compile-and-install-suricata">
<h4>Compile and install Suricata<a class="headerlink" href="#compile-and-install-suricata" title="Permalink to this headline">¶</a></h4>
<p>To get Suricata source, you can use the usual</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">OISF</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">suricata</span> <span class="o">&amp;&amp;</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">OISF</span><span class="o">/</span><span class="n">libhtp</span><span class="o">.</span><span class="n">git</span> <span class="o">-</span><span class="n">b</span> <span class="mf">0.5</span><span class="o">.</span><span class="n">x</span>

<span class="o">./</span><span class="n">autogen</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Then you need to add the eBPF flags to configure and specify the Clang
compiler for building all C sources, including the eBPF programs</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CC</span><span class="o">=</span><span class="n">clang</span> <span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span> <span class="o">--</span><span class="n">sysconfdir</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span> <span class="o">--</span><span class="n">localstatedir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span> \
<span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">ebpf</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">ebpf</span><span class="o">-</span><span class="n">build</span>

<span class="n">make</span> <span class="n">clean</span> <span class="o">&amp;&amp;</span> <span class="n">make</span>
<span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span><span class="o">-</span><span class="n">full</span>
<span class="n">sudo</span> <span class="n">ldconfig</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">clang</span></code> compiler is needed if you want to build eBPF files as the build
is done via a specific eBPF backend available only in llvm/clang suite. If you
don't want to use Clang for building Suricata itself, you can still specify it
separately, using the <code class="docutils literal notranslate"><span class="pre">--with-clang</span></code> parameter</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span> <span class="o">--</span><span class="n">sysconfdir</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span> <span class="o">--</span><span class="n">localstatedir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span> \
<span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">ebpf</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">ebpf</span><span class="o">-</span><span class="n">build</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">clang</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">clang</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-bypass">
<h4>Setup bypass<a class="headerlink" href="#setup-bypass" title="Permalink to this headline">¶</a></h4>
<p>If you plan to use eBPF or XDP for a kernel/hardware level bypass, you need to enable
some of the following features:</p>
<p>First, enable <cite>bypass</cite> in the <cite>stream</cite> section in <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="p">:</span>
  <span class="n">bypass</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p>This will bypass flows as soon as the stream depth will be reached.</p>
<p>If you want, you can also bypass encrypted flows by setting <cite>encryption-handling</cite> to <cite>bypass</cite>
in the app-layer tls section</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">-</span><span class="n">layer</span><span class="p">:</span>
  <span class="n">protocols</span><span class="p">:</span>
    <span class="n">tls</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">detection</span><span class="o">-</span><span class="n">ports</span><span class="p">:</span>
        <span class="n">dp</span><span class="p">:</span> <span class="mi">443</span>

      <span class="n">encryption</span><span class="o">-</span><span class="n">handling</span><span class="p">:</span> <span class="n">bypass</span>
</pre></div>
</div>
<p>Another solution is to use a set of signatures using the <code class="docutils literal notranslate"><span class="pre">bypass</span></code> keyword to obtain
a selective bypass. Suricata traffic ID defines flowbits that can be used in other signatures.
For instance one could use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;bypass video&quot;</span><span class="p">;</span> <span class="n">flowbits</span><span class="p">:</span><span class="n">isset</span><span class="p">,</span><span class="n">traffic</span><span class="o">/</span><span class="n">label</span><span class="o">/</span><span class="n">video</span><span class="p">;</span> <span class="n">noalert</span><span class="p">;</span> <span class="n">bypass</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1000000</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
<span class="n">alert</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="s2">&quot;bypass Skype&quot;</span><span class="p">;</span> <span class="n">flowbits</span><span class="p">:</span><span class="n">isset</span><span class="p">,</span><span class="n">traffic</span><span class="o">/</span><span class="nb">id</span><span class="o">/</span><span class="n">skype</span><span class="p">;</span> <span class="n">noalert</span><span class="p">;</span> <span class="n">bypass</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1000001</span><span class="p">;</span> <span class="n">rev</span><span class="p">:</span><span class="mi">1</span><span class="p">;)</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-ebpf-filter">
<h4>Setup eBPF filter<a class="headerlink" href="#setup-ebpf-filter" title="Permalink to this headline">¶</a></h4>
<p>The file <cite>ebpf/vlan_filter.c</cite> contains a list of VLAN id in a switch
that you need to edit to get something adapted to your network. Another
filter dropping packets from or to a set of IPv4 address is also available in
<cite>ebpf/filter.c</cite>. See <a class="reference internal" href="#ebpf-pinned-maps"><span class="std std-ref">Pinned maps usage</span></a> for more information.</p>
<p>Suricata can load as eBPF filter any eBPF code exposing a <code class="docutils literal notranslate"><span class="pre">filter</span></code> section.</p>
<p>Once modifications and build via <code class="docutils literal notranslate"><span class="pre">make</span></code> are complete, you can copy the resulting
eBPF filter as needed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">ebpf</span><span class="o">/</span><span class="n">vlan_filter</span><span class="o">.</span><span class="n">bpf</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span>
</pre></div>
</div>
<p>Then setup the <cite>ebpf-filter-file</cite> variable in af-packet section in <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth3</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">97</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_flow</span> <span class="c1"># choose any type suitable</span>
  <span class="n">defrag</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1"># eBPF file containing a &#39;filter&#39; function that will be inserted into the</span>
  <span class="c1"># kernel and used as load balancing function</span>
  <span class="n">ebpf</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">file</span><span class="p">:</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">vlan_filter</span><span class="o">.</span><span class="n">bpf</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">200000</span>
</pre></div>
</div>
<p>You can then run Suricata normally</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">suricata</span> <span class="o">--</span><span class="n">pidfile</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">pid</span>  <span class="o">--</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">=</span><span class="n">eth3</span> <span class="o">-</span><span class="n">vvv</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-ebpf-bypass">
<h4>Setup eBPF bypass<a class="headerlink" href="#setup-ebpf-bypass" title="Permalink to this headline">¶</a></h4>
<p>You can also use eBPF bypass. To do that load the <cite>bypass_filter.bpf</cite> file and
update af-packet configuration in <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> to set bypass to <cite>yes</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth3</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">97</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_qm</span> <span class="c1"># symmetric RSS hashing is mandatory to use this mode</span>
  <span class="c1"># eBPF file containing a &#39;filter&#39; function that will be inserted into the</span>
  <span class="c1"># kernel and used as packet filter function</span>
  <span class="n">ebpf</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">file</span><span class="p">:</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">bypass_filter</span><span class="o">.</span><span class="n">bpf</span>
  <span class="n">bypass</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">200000</span>
</pre></div>
</div>
<p>Constraints on eBPF code to have a bypass compliant code are stronger than for regular filters. The
filter must expose <cite>flow_table_v4</cite> and <cite>flow_table_v6</cite> per CPU array maps with similar definitions
as the one available in <cite>bypass_filter.c</cite>. These two maps will be accessed and
maintained by Suricata to handle the lists of flows to bypass.</p>
<p>If you are not using VLAN tracking (<code class="docutils literal notranslate"><span class="pre">vlan.use-for-tracking</span></code> set to <cite>false</cite> in suricata.yaml) then you also have to set
the <code class="docutils literal notranslate"><span class="pre">VLAN_TRACKING</span></code> define to <cite>0</cite> in <code class="docutils literal notranslate"><span class="pre">bypass_filter.c</span></code>.</p>
</div>
<div class="section" id="setup-ebpf-load-balancing">
<h4>Setup eBPF load balancing<a class="headerlink" href="#setup-ebpf-load-balancing" title="Permalink to this headline">¶</a></h4>
<p>eBPF load balancing allows to load balance the traffic on the listening sockets
With any logic implemented in the eBPF filter. The value returned by the function
tagged with the <code class="docutils literal notranslate"><span class="pre">loadbalancer</span></code> section is used with a modulo on the CPU count to know in
which socket the packet has to be send.</p>
<p>An implementation of a simple symmetric IP pair hashing function is provided in the <code class="docutils literal notranslate"><span class="pre">lb.bpf</span></code>
file.</p>
<p>Copy the resulting eBPF filter as needed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">ebpf</span><span class="o">/</span><span class="n">lb</span><span class="o">.</span><span class="n">bpf</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span>
</pre></div>
</div>
<p>Then use <code class="docutils literal notranslate"><span class="pre">cluster_ebpf</span></code> as load balancing method in the interface section of af-packet
and point the <code class="docutils literal notranslate"><span class="pre">ebpf-lb-file</span></code> variable to the <code class="docutils literal notranslate"><span class="pre">lb.bpf</span></code> file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth3</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">97</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_ebpf</span>
  <span class="n">defrag</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1"># eBPF file containing a &#39;loadbalancer&#39; function that will be inserted into the</span>
  <span class="c1"># kernel and used as load balancing function</span>
  <span class="n">ebpf</span><span class="o">-</span><span class="n">lb</span><span class="o">-</span><span class="n">file</span><span class="p">:</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">lb</span><span class="o">.</span><span class="n">bpf</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">200000</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-xdp-bypass">
<h4>Setup XDP bypass<a class="headerlink" href="#setup-xdp-bypass" title="Permalink to this headline">¶</a></h4>
<p>XDP bypass allows Suricata to tell the kernel that packets for some
flows have to be dropped via the XDP mechanism. This is an early
drop that occurs before the datagram reaches the Linux kernel
network stack.</p>
<p>Linux 4.15 or newer are recommended to use that feature. You can use it
on older kernel if you set <code class="docutils literal notranslate"><span class="pre">BUILD_CPUMAP</span></code> to <cite>0</cite> in <code class="docutils literal notranslate"><span class="pre">ebpf/xdp_filter.c</span></code>.</p>
<p>Copy the resulting XDP filter as needed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">ebpf</span><span class="o">/</span><span class="n">xdp_filter</span><span class="o">.</span><span class="n">bpf</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span>
</pre></div>
</div>
<p>Setup af-packet section/interface in <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code>.</p>
<p>We will use <code class="docutils literal notranslate"><span class="pre">cluster_qm</span></code> as we have symmetric hashing on the NIC, <code class="docutils literal notranslate"><span class="pre">xdp-mode:</span> <span class="pre">driver</span></code> and we will
also use the <code class="docutils literal notranslate"><span class="pre">/usr/libexec/suricata/ebpf/xdp_filter.bpf</span></code> (in our example TCP offloading/bypass)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth3</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">97</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_qm</span> <span class="c1"># symmetric hashing is a must!</span>
  <span class="n">defrag</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1"># Xdp mode, &quot;soft&quot; for skb based version, &quot;driver&quot; for network card based</span>
  <span class="c1"># and &quot;hw&quot; for card supporting eBPF.</span>
  <span class="n">xdp</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">driver</span>
  <span class="n">xdp</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">file</span><span class="p">:</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">xdp_filter</span><span class="o">.</span><span class="n">bpf</span>
  <span class="c1"># if the ebpf filter implements a bypass function, you can set &#39;bypass&#39; to</span>
  <span class="c1"># yes and benefit from these feature</span>
  <span class="n">bypass</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">200000</span>
  <span class="c1"># Uncomment the following if you are using hardware XDP with</span>
  <span class="c1"># a card like Netronome (default value is yes)</span>
  <span class="c1"># use-percpu-hash: no</span>
</pre></div>
</div>
<p>XDP bypass is compatible with AF_PACKET IPS mode. Packets from bypassed flows will be send directly
from one card to the second card without going by the kernel network stack.</p>
<p>If you are using hardware XDP offload you may have to set <code class="docutils literal notranslate"><span class="pre">use-percpu-hash</span></code> to false and
build and install the XDP filter file after setting <code class="docutils literal notranslate"><span class="pre">USE_PERCPU_HASH</span></code> to 0.</p>
<p>In the XDP filter file, you can set <code class="docutils literal notranslate"><span class="pre">ENCRYPTED_TLS_BYPASS</span></code> to 1 if you want to bypass
the encrypted TLS 1.2 packets in the eBPF code. Be aware that this will mean that Suricata will
be blind on packets on port 443 with the correct pattern.</p>
<p>If you are not using VLAN tracking (<code class="docutils literal notranslate"><span class="pre">vlan.use-for-tracking</span></code> set to false in suricata.yaml) then you also have to set
the VLAN_TRACKING define to 0 in <code class="docutils literal notranslate"><span class="pre">xdp_filter.c</span></code>.</p>
<div class="section" id="intel-nic-setup">
<h5>Intel NIC setup<a class="headerlink" href="#intel-nic-setup" title="Permalink to this headline">¶</a></h5>
<p>Intel network card don't support symmetric hashing but it is possible to emulate
it by using a specific hashing function.</p>
<p>Follow these instructions closely for desired result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="n">eth3</span> <span class="n">down</span>
</pre></div>
</div>
<p>Use in tree kernel drivers: XDP support is not available in Intel drivers available on Intel website.</p>
<p>Enable symmetric hashing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="n">eth3</span> <span class="n">down</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">L</span> <span class="n">eth3</span> <span class="n">combined</span> <span class="mi">16</span> <span class="c1"># if you have at least 16 cores</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eth3</span> <span class="n">rxhash</span> <span class="n">on</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eth3</span> <span class="n">ntuple</span> <span class="n">on</span>
<span class="n">ifconfig</span> <span class="n">eth3</span> <span class="n">up</span>
<span class="o">./</span><span class="n">set_irq_affinity</span> <span class="mi">0</span><span class="o">-</span><span class="mi">15</span> <span class="n">eth3</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">X</span> <span class="n">eth3</span> <span class="n">hkey</span> <span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span> <span class="n">equal</span> <span class="mi">16</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">x</span> <span class="n">eth3</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">n</span> <span class="n">eth3</span>
</pre></div>
</div>
<p>In the above setup you are free to use any recent <code class="docutils literal notranslate"><span class="pre">set_irq_affinity</span></code> script. It is available in any Intel x520/710 NIC sources driver download.</p>
<p><strong>NOTE:</strong>
We use a special low entropy key for the symmetric hashing. <a class="reference external" href="http://www.ndsl.kaist.edu/~kyoungsoo/papers/TR-symRSS.pdf">More info about the research for symmetric hashing set up</a></p>
</div>
<div class="section" id="disable-any-nic-offloading">
<h5>Disable any NIC offloading<a class="headerlink" href="#disable-any-nic-offloading" title="Permalink to this headline">¶</a></h5>
<p>Run the following command to disable offloading</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in rx tx tso ufo gso gro lro tx nocache copy sg txvlan rxvlan; do
       /sbin/ethtool -K eth3 $i off 2&gt;&amp;1 &gt; /dev/null;
done
</pre></div>
</div>
</div>
<div class="section" id="balance-as-much-as-you-can">
<h5>Balance as much as you can<a class="headerlink" href="#balance-as-much-as-you-can" title="Permalink to this headline">¶</a></h5>
<p>Try to use the network card's flow balancing as much as possible</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for proto in tcp4 udp4 ah4 esp4 sctp4 tcp6 udp6 ah6 esp6 sctp6; do
   /sbin/ethtool -N eth3 rx-flow-hash $proto sd
done
</pre></div>
</div>
<p>This command triggers load balancing using only source and destination IPs. This may be not optimal
in term of load balancing fairness but this ensures all packets of a flow will reach the same thread
even in the case of IP fragmentation (where source and destination port will not be available
for some fragmented packets).</p>
</div>
<div class="section" id="the-xdp-cpu-redirect-case">
<h5>The XDP CPU redirect case<a class="headerlink" href="#the-xdp-cpu-redirect-case" title="Permalink to this headline">¶</a></h5>
<p>If ever your hardware is not able to do a symmetric load balancing but support XDP in driver mode, you
can then use the CPU redirect map support available in the <cite>xdp_filter.bpf</cite> and <cite>xdp_lb.bpf</cite> file. In
this mode, the load balancing will be done by the XDP filter and each CPU will handle the whole packet
treatment including the creation of the skb structure in kernel.</p>
<p>You will need Linux 4.15 or newer to use that feature.</p>
<p>To do so set the <cite>xdp-cpu-redirect</cite> variable in af-packet interface configuration to a set of CPUs.
Then use the <cite>cluster_cpu</cite> as load balancing function. You will also need to set the affinity
to be certain that CPU cores that have the skb assigned are used by Suricata.</p>
<p>Also to avoid out of order packets, you need to set the RSS queue number to 1. So if our interface
is <cite>eth3</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ethtool</span> <span class="o">-</span><span class="n">L</span> <span class="n">eth3</span> <span class="n">combined</span> <span class="mi">1</span>
</pre></div>
</div>
<p>In case your system has more then 64 core, you need to set <cite>CPUMAP_MAX_CPUS</cite> to a value greater
than this number in <cite>xdp_lb.c</cite> and <cite>xdp_filter.c</cite>.</p>
<p>A sample configuration for pure XDP load balancing could look like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth3</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">id</span><span class="p">:</span> <span class="mi">97</span>
  <span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_cpu</span>
  <span class="n">xdp</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">driver</span>
  <span class="n">xdp</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">file</span><span class="p">:</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">xdp_lb</span><span class="o">.</span><span class="n">bpf</span>
  <span class="n">xdp</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="n">redirect</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1-17&quot;</span><span class="p">]</span> <span class="c1"># or [&quot;all&quot;] to load balance on all CPUs</span>
  <span class="n">use</span><span class="o">-</span><span class="n">mmap</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">ring</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">200000</span>
</pre></div>
</div>
<p>It is possible to use <cite>xdp_monitor</cite> to have information about the behavior of CPU redirect. This
program is available in Linux tree under the <cite>samples/bpf</cite> directory and will be build by the
make command. Sample output is the following</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">./</span><span class="n">xdp_monitor</span> <span class="o">--</span><span class="n">stats</span>
<span class="n">XDP</span><span class="o">-</span><span class="n">event</span>       <span class="n">CPU</span><span class="p">:</span><span class="n">to</span>  <span class="n">pps</span>          <span class="n">drop</span><span class="o">-</span><span class="n">pps</span>     <span class="n">extra</span><span class="o">-</span><span class="n">info</span>
<span class="n">XDP_REDIRECT</span>    <span class="mi">11</span>      <span class="mi">2</span><span class="p">,</span><span class="mi">880</span><span class="p">,</span><span class="mi">212</span>    <span class="mi">0</span>            <span class="n">Success</span>
<span class="n">XDP_REDIRECT</span>    <span class="n">total</span>   <span class="mi">2</span><span class="p">,</span><span class="mi">880</span><span class="p">,</span><span class="mi">212</span>    <span class="mi">0</span>            <span class="n">Success</span>
<span class="n">XDP_REDIRECT</span>    <span class="n">total</span>   <span class="mi">0</span>            <span class="mi">0</span>            <span class="n">Error</span>
<span class="n">cpumap</span><span class="o">-</span><span class="n">enqueue</span>   <span class="mi">11</span><span class="p">:</span><span class="mi">0</span>   <span class="mi">575</span><span class="p">,</span><span class="mi">954</span>      <span class="mi">0</span>            <span class="mf">5.27</span>       <span class="n">bulk</span><span class="o">-</span><span class="n">average</span>
<span class="n">cpumap</span><span class="o">-</span><span class="n">enqueue</span>  <span class="nb">sum</span><span class="p">:</span><span class="mi">0</span>   <span class="mi">575</span><span class="p">,</span><span class="mi">954</span>      <span class="mi">0</span>            <span class="mf">5.27</span>       <span class="n">bulk</span><span class="o">-</span><span class="n">average</span>
<span class="n">cpumap</span><span class="o">-</span><span class="n">kthread</span>  <span class="mi">0</span>       <span class="mi">575</span><span class="p">,</span><span class="mi">990</span>      <span class="mi">0</span>            <span class="mi">56</span><span class="p">,</span><span class="mi">409</span>     <span class="n">sched</span>
<span class="n">cpumap</span><span class="o">-</span><span class="n">kthread</span>  <span class="mi">1</span>       <span class="mi">576</span><span class="p">,</span><span class="mi">090</span>      <span class="mi">0</span>            <span class="mi">54</span><span class="p">,</span><span class="mi">897</span>     <span class="n">sched</span>
</pre></div>
</div>
</div>
<div class="section" id="start-suricata-with-xdp">
<h5>Start Suricata with XDP<a class="headerlink" href="#start-suricata-with-xdp" title="Permalink to this headline">¶</a></h5>
<p>You can now start Suricata with XDP bypass activated</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">xdp</span><span class="o">-</span><span class="n">suricata</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">pidfile</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">suricata</span><span class="o">.</span><span class="n">pid</span>  <span class="o">--</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">=</span><span class="n">eth3</span> <span class="o">-</span><span class="n">vvv</span>
</pre></div>
</div>
<p>Confirm you have the XDP filter engaged in the output (example):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="o">...</span>
<span class="p">(</span><span class="n">runmode</span><span class="o">-</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">220</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ParseAFPConfig</span><span class="p">)</span> <span class="o">--</span> <span class="n">Enabling</span> <span class="n">locked</span> <span class="n">memory</span> <span class="k">for</span> <span class="n">mmap</span> <span class="n">on</span> <span class="n">iface</span> <span class="n">eth3</span>
<span class="p">(</span><span class="n">runmode</span><span class="o">-</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">231</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ParseAFPConfig</span><span class="p">)</span> <span class="o">--</span> <span class="n">Enabling</span> <span class="n">tpacket</span> <span class="n">v3</span> <span class="n">capture</span> <span class="n">on</span> <span class="n">iface</span> <span class="n">eth3</span>
<span class="p">(</span><span class="n">runmode</span><span class="o">-</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">326</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ParseAFPConfig</span><span class="p">)</span> <span class="o">--</span> <span class="n">Using</span> <span class="n">queue</span> <span class="n">based</span> <span class="n">cluster</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">AF_PACKET</span> <span class="p">(</span><span class="n">iface</span> <span class="n">eth3</span><span class="p">)</span>
<span class="p">(</span><span class="n">runmode</span><span class="o">-</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">424</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Info</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ParseAFPConfig</span><span class="p">)</span> <span class="o">--</span> <span class="n">af</span><span class="o">-</span><span class="n">packet</span> <span class="n">will</span> <span class="n">use</span> <span class="s1">&#39;/usr/libexec/suricata/ebpf/xdp_filter.bpf&#39;</span> <span class="k">as</span> <span class="n">XDP</span> <span class="nb">filter</span> <span class="n">file</span>
<span class="p">(</span><span class="n">runmode</span><span class="o">-</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">429</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ParseAFPConfig</span><span class="p">)</span> <span class="o">--</span> <span class="n">Using</span> <span class="n">bypass</span> <span class="n">kernel</span> <span class="n">functionality</span> <span class="k">for</span> <span class="n">AF_PACKET</span> <span class="p">(</span><span class="n">iface</span> <span class="n">eth3</span><span class="p">)</span>
<span class="p">(</span><span class="n">runmode</span><span class="o">-</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">609</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ParseAFPConfig</span><span class="p">)</span> <span class="o">--</span> <span class="n">eth3</span><span class="p">:</span> <span class="n">enabling</span> <span class="n">zero</span> <span class="n">copy</span> <span class="n">mode</span> <span class="n">by</span> <span class="n">using</span> <span class="n">data</span> <span class="n">release</span> <span class="n">call</span>
<span class="p">(</span><span class="n">util</span><span class="o">-</span><span class="n">runmodes</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">296</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Info</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">RunModeSetLiveCaptureWorkersForDevice</span><span class="p">)</span> <span class="o">--</span> <span class="n">Going</span> <span class="n">to</span> <span class="n">use</span> <span class="mi">8</span> <span class="n">thread</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pinned-maps-usage">
<span id="ebpf-pinned-maps"></span><h4>Pinned maps usage<a class="headerlink" href="#pinned-maps-usage" title="Permalink to this headline">¶</a></h4>
<p>Pinned maps stay attached to the system if the creating process disappears and
they can also be accessed by external tools. In Suricata bypass case, this can be
used to keep bypassed flow tables active, so Suricata is not hit by previously bypassed flows when
restarting. In the socket filter case, this can be used to maintain a map from tools outside
of Suricata.</p>
<p>To use pinned maps, you first have to mount the <cite>bpf</cite> pseudo filesystem</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">bpf</span> <span class="n">none</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">bpf</span>
</pre></div>
</div>
<p>You can also add to your <cite>/etc/fstab</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bpffs</span>                      <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">bpf</span>             <span class="n">bpf</span>     <span class="n">defaults</span> <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>and run <cite>sudo mount -a</cite>.</p>
<p>Pinned maps will be accessible as file from the <cite>/sys/fs/bpf</cite> directory. Suricata
will pin them under the name <cite>suricata-$IFACE_NAME-$MAP_NAME</cite>.</p>
<p>To activate pinned maps for a interface, set <cite>pinned-maps</cite> to <cite>true</cite> in the <cite>af-packet</cite>
configuration of this interface</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth3</span>
  <span class="n">pinned</span><span class="o">-</span><span class="n">maps</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="xdp-and-pinned-maps">
<h4>XDP and pinned-maps<a class="headerlink" href="#xdp-and-pinned-maps" title="Permalink to this headline">¶</a></h4>
<p>This option can be used to expose the maps of a socket filter to other processes.
This allows for example, the external handling of a accept list or block list of
IP addresses. See <a class="reference external" href="https://github.com/StamusNetworks/bpfctrl/">bpfctrl</a> for an example
of external list handling.</p>
<p>In the case of XDP, the eBPF filter is attached to the interface so if you
activate <cite>pinned-maps</cite> the eBPF will remain attached to the interface and
the maps will remain accessible upon Suricata start.
If XDP bypass is activated, Suricata will try at start to open the pinned maps
<cite>flow_v4_table</cite> and <cite>flow_v6_table</cite>. If they are present, this means the XDP filter
is still there and Suricata will just use them instead of attaching the XDP file to
the interface.</p>
<p>So if you want to reload the XDP filter, you need to remove the files from <cite>/sys/fs/bpf/</cite>
before starting Suricata.</p>
<p>In case, you are not using bypass, this means that the used maps are managed from outside
Suricata. As their names are not known by Suricata, you need to specify a name of a map to look
for, that will be used to check for the presence of the XDP filter</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">eth3</span>
  <span class="n">pinned</span><span class="o">-</span><span class="n">maps</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">pinned</span><span class="o">-</span><span class="n">maps</span><span class="o">-</span><span class="n">name</span><span class="p">:</span> <span class="n">ipv4_drop</span>
  <span class="n">xdp</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">ebpf</span><span class="o">/</span><span class="n">xdp_filter</span><span class="o">.</span><span class="n">bpf</span>
</pre></div>
</div>
<p>If XDP bypass is used in IPS mode stopping Suricata will trigger an interruption in the traffic.
To fix that, the provided XDP filter <cite>xdp_filter.bpf</cite> is containing a map that will trigger
a global bypass if set to 1. You need to use <cite>pinned-maps</cite> to benefit from this feature.</p>
<p>To use it you need to set <cite>#define USE_GLOBAL_BYPASS   1</cite> (instead of 0) in the <cite>xdp_filter.c</cite> file and rebuild
the eBPF code and install the eBPF file in the correct place. If you write <cite>1</cite> as key <cite>0</cite> then the XDP
filter will switch to global bypass mode. Set key <cite>0</cite> to value <cite>0</cite> to send traffic to Suricata.</p>
<p>The switch must be activated on all sniffing interfaces. For an interface named <cite>eth0</cite> the global
switch map will be <cite>/sys/fs/bpf/suricata-eth0-global_bypass</cite>.</p>
<div class="section" id="pinned-maps-and-ebpf-filter">
<h5>Pinned maps and eBPF filter<a class="headerlink" href="#pinned-maps-and-ebpf-filter" title="Permalink to this headline">¶</a></h5>
<p>Pinned maps can also be used with regular eBPF filters. The main difference is that the map will not
persist after Suricata is stopped because it is attached to a socket and not an interface which
is persistent.</p>
<p>The eBPF filter <cite>filter.bpf</cite> uses a <cite>ipv4_drop</cite> map that contains the set of IPv4 addresses to drop.
If <cite>pinned-maps</cite> is set to <cite>true</cite> in the interface configuration then the map will be pinned
under <cite>/sys/fs/bpf/suricata-eth3-ipv4_drop</cite>.</p>
<p>You can then use a tool like <cite>bpfctrl</cite> to manage the IPv4 addresses in the map.</p>
</div>
</div>
<div class="section" id="hardware-bypass-with-netronome">
<h4>Hardware bypass with Netronome<a class="headerlink" href="#hardware-bypass-with-netronome" title="Permalink to this headline">¶</a></h4>
<p>Netronome cards support hardware bypass. In this case the eBPF code is running in the card
itself. This introduces some architectural differences compared to driver mode and the configuration
and eBPF filter need to be updated.</p>
<p>On eBPF side, as of Linux 4.19 CPU maps and interfaces redirect are not supported and these features
need to be disabled. By architecture, per CPU hash should not be used and has to be disabled.
To achieve this, edit the beginning of <cite>ebpf/xdp_filter.c</cite> and do</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define BUILD_CPUMAP        0</span>
<span class="o">/*</span> <span class="n">Increase</span> <span class="n">CPUMAP_MAX_CPUS</span> <span class="k">if</span> <span class="n">ever</span> <span class="n">you</span> <span class="n">have</span> <span class="n">more</span> <span class="n">than</span> <span class="mi">64</span> <span class="n">CPUs</span> <span class="o">*/</span>
<span class="c1">#define CPUMAP_MAX_CPUS     64</span>

<span class="c1">#define USE_PERCPU_HASH    0</span>
<span class="c1">#define GOT_TX_PEER    0</span>
</pre></div>
</div>
<p>Then build the bpf file with <cite>make</cite> and install it in the expected place.</p>
<p>The Suricata configuration is rather simple as you need to activate
hardware mode and the <cite>use-percpu-hash</cite> option in the <cite>af-packet</cite> configuration
of the interface</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xdp</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">hw</span>
<span class="n">use</span><span class="o">-</span><span class="n">percpu</span><span class="o">-</span><span class="nb">hash</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<p>The load  balancing will be done on IP pairs inside the eBPF code, so
using <cite>cluster_qm</cite> as cluster type is a good idea</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">cluster_qm</span>
</pre></div>
</div>
<p>As of Linux 4.19, the number of threads must be a power of 2. So set
<cite>threads</cite> variable of the <cite>af-packet</cite> interface to a power
of 2 and in the eBPF filter set the following variable accordingly</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define RSS_QUEUE_NUMBERS   32</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-live-info-about-bypass">
<h4>Getting live info about bypass<a class="headerlink" href="#getting-live-info-about-bypass" title="Permalink to this headline">¶</a></h4>
<p>You can get information about bypass via the stats event and through the unix socket.
<code class="docutils literal notranslate"><span class="pre">iface-stat</span></code> will return the number of bypassed packets (adding packets for a flow when it timeout)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;iface-stat enp94s0np0&quot;</span> <span class="o">|</span> <span class="n">jq</span>
<span class="p">{</span>
  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;pkts&quot;</span><span class="p">:</span> <span class="mi">56529854964</span><span class="p">,</span>
    <span class="s2">&quot;drop&quot;</span><span class="p">:</span> <span class="mi">932328611</span><span class="p">,</span>
    <span class="s2">&quot;bypassed&quot;</span><span class="p">:</span> <span class="mi">1569467248</span><span class="p">,</span>
    <span class="s2">&quot;invalid-checksums&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">iface-bypassed-stats</span></code> command will return the number of elements in IPv4 and IPv6 flow tables for
each interface</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># suricatasc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iface</span><span class="o">-</span><span class="n">bypassed</span><span class="o">-</span><span class="n">stats</span>
<span class="n">Success</span><span class="p">:</span>
<span class="p">{</span>
    <span class="s2">&quot;enp94s0np0&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;ipv4_fail&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
       <span class="s2">&quot;ipv4_maps_count&quot;</span><span class="p">:</span> <span class="mi">2303</span><span class="p">,</span>
       <span class="s2">&quot;ipv4_success&quot;</span><span class="p">:</span> <span class="mi">4232</span><span class="p">,</span>
       <span class="s2">&quot;ipv6_fail&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
       <span class="s2">&quot;ipv6_maps_count&quot;</span><span class="p">:</span> <span class="mi">13131</span><span class="p">,</span>
       <span class="s2">&quot;ipv6_success&quot;</span><span class="p">:</span> <span class="mi">13500</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The stats entry also contains a <cite>stats.flow_bypassed</cite> object that has local and capture
bytes and packets counters as well as a bypassed and closed flow counter</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;local_pkts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;local_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;local_capture_pkts&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="s2">&quot;local_capture_bytes&quot;</span><span class="p">:</span> <span class="mi">25000</span><span class="p">,</span>
  <span class="s2">&quot;closed&quot;</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
  <span class="s2">&quot;pkts&quot;</span><span class="p">:</span> <span class="mi">4799</span><span class="p">,</span>
  <span class="s2">&quot;bytes&quot;</span><span class="p">:</span> <span class="mi">2975133</span>
<span class="p">}</span>
</pre></div>
</div>
<p><cite>local_pkts</cite> and <cite>local_bytes</cite> are for Suricata bypassed flows. This can be because
local bypass is used or because the capture method can not bypass more flows.
<cite>pkts</cite> and <cite>bytes</cite> are counters coming from the capture method. They can take some
time to appear due to the accounting at timeout.
<cite>local_capture_pkts</cite> and <cite>local_capture_bytes</cite> are counters for packets that are seen
by Suricata before the capture method efficiently bypass the traffic. There is almost
always some for each flow because of the buffer in front of Suricata reading threads.</p>
</div>
</div>
<span id="document-capture-hardware/netmap"></span><div class="section" id="netmap">
<h3>Netmap<a class="headerlink" href="#netmap" title="Permalink to this headline">¶</a></h3>
<p>Netmap is a high speed capture framework for Linux and FreeBSD. In Linux it
is available as an external module, while in FreeBSD 11+ it is available by
default.</p>
<div class="section" id="compiling-suricata">
<h4>Compiling Suricata<a class="headerlink" href="#compiling-suricata" title="Permalink to this headline">¶</a></h4>
<div class="section" id="freebsd">
<h5>FreeBSD<a class="headerlink" href="#freebsd" title="Permalink to this headline">¶</a></h5>
<p>On FreeBSD 11 and up, NETMAP is included and enabled by default in the kernel.</p>
<p>To build Suricata with NETMAP, add <code class="docutils literal notranslate"><span class="pre">--enable-netmap</span></code> to the configure line.
The location of the NETMAP includes (/usr/src/sys/net/) does not have to be
specified.</p>
</div>
<div class="section" id="linux">
<h5>Linux<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h5>
<p>On Linux, NETMAP is not included by default. It can be pulled from github.
Follow the instructions on installation included in the NETMAP repository.</p>
<p>When NETMAP is installed, add <code class="docutils literal notranslate"><span class="pre">--enable-netmap</span></code> to the configure line.
If the includes are not added to a standard location, the location can
be specified when configuring Suricata.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">netmap</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">netmap</span><span class="o">-</span><span class="n">includes</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">netmap</span><span class="o">/</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="starting-suricata">
<h4>Starting Suricata<a class="headerlink" href="#starting-suricata" title="Permalink to this headline">¶</a></h4>
<p>When opening an interface, netmap can take various special characters as
options in the interface string.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">the interface that netmap reads from will become unavailable
for normal network operations. You can lock yourself out of
your system.</p>
</div>
<div class="section" id="ids">
<h5>IDS<a class="headerlink" href="#ids" title="Permalink to this headline">¶</a></h5>
<p>Suricata can be started in 2 ways to use netmap:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">netmap</span><span class="o">=&lt;</span><span class="n">interface</span><span class="o">&gt;</span>
<span class="n">suricata</span> <span class="o">--</span><span class="n">netmap</span><span class="o">=</span><span class="n">igb0</span>
</pre></div>
</div>
<p>In the above example Suricata will start reading from the <cite>igb0</cite> network interface.
The number of threads created depends on the number of RSS queues available on the NIC.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">netmap</span>
</pre></div>
</div>
<p>In the above example Suricata will take the <code class="docutils literal notranslate"><span class="pre">netmap</span></code> block from the Suricata
configuration and open each of the interfaces listed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netmap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb0</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">2</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb1</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">4</span>
</pre></div>
</div>
<p>For the above configuration, both <code class="docutils literal notranslate"><span class="pre">igb0</span></code> and <code class="docutils literal notranslate"><span class="pre">igb1</span></code> would be opened. With 2
threads for <code class="docutils literal notranslate"><span class="pre">igb0</span></code> and 4 capture threads for <code class="docutils literal notranslate"><span class="pre">igb1</span></code>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This multi threaded setup only works correctly if the NIC
has symmetric RSS hashing. If this is not the case, consider
using the 'lb' method below.</p>
</div>
</div>
<div class="section" id="ips">
<h5>IPS<a class="headerlink" href="#ips" title="Permalink to this headline">¶</a></h5>
<p>Suricata's Netmap based IPS mode is based on the concept of creating
a layer 2 software bridge between 2 interfaces. Suricata reads packets on
one interface and transmits them on another.</p>
<p>Packets that are blocked by the IPS policy, are simply not transmitted.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netmap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb0</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">igb1</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb1</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">ips</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">igb0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="advanced-setups">
<h4>Advanced setups<a class="headerlink" href="#advanced-setups" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="lb-load-balance">
<h4>lb (load balance)<a class="headerlink" href="#lb-load-balance" title="Permalink to this headline">¶</a></h4>
<p>&quot;lb&quot; is a tool written by Seth Hall to allow for load balancing for single
or multiple tools. One common use case is being able to run Suricata and
Zeek together on the same traffic.</p>
<p>starting lb:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">suricata</span><span class="p">:</span><span class="mi">6</span> <span class="o">-</span><span class="n">p</span> <span class="n">zeek</span><span class="p">:</span><span class="mi">6</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On FreeBSD 11, the named prefix doesn't work.</p>
</div>
<p>yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netmap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">netmap</span><span class="p">:</span><span class="n">suricata</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">6</span>
</pre></div>
</div>
<p>startup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">netmap</span><span class="o">=</span><span class="n">netmap</span><span class="p">:</span><span class="n">suricata</span>
</pre></div>
</div>
<p>The interface name as passed to Suricata includes a 'netmap:' prefix. This
tells Suricata that it's going to read from netmap pipes instead of a real
interface.</p>
<p>Then Zeek (formerly Bro) can be configured to load 6 instances. Both will
get a copy of the same traffic. The number of netmap pipes does not have
to be equal for both tools.</p>
<div class="section" id="freebsd-11">
<h5>FreeBSD 11<a class="headerlink" href="#freebsd-11" title="Permalink to this headline">¶</a></h5>
<p>On FreeBSD 11 the named pipe is not available.</p>
<p>starting lb:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="mi">6</span>
</pre></div>
</div>
<p>yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netmap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">netmap</span><span class="p">:</span><span class="n">eth0</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">6</span>
</pre></div>
</div>
<p>startup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">netmap</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&quot;lb&quot; is bundled with netmap.</p>
</div>
</div>
<div class="section" id="single-nic">
<h5>Single NIC<a class="headerlink" href="#single-nic" title="Permalink to this headline">¶</a></h5>
<p>When an interface enters NETMAP mode, it is no longer available to
the OS for other operations. This can be undesirable in certain
cases, but there is a workaround.</p>
<p>By running Suricata in a special inline mode, the interface will
show it's traffic to the OS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netmap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb0</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">tap</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">igb0</span><span class="o">^</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb0</span><span class="o">^</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">tap</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">igb0</span>
</pre></div>
</div>
<p>The copy-mode can be both 'tap' and 'ips', where the former never
drops packets based on the policies in use, and the latter may drop
packets.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Misconfiguration can lead to connectivity loss. Use
with care.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This set up can also be used to mix NETMAP with firewall
setups like pf or ipfw.</p>
</div>
</div>
<div class="section" id="vale-switches">
<h5>VALE switches<a class="headerlink" href="#vale-switches" title="Permalink to this headline">¶</a></h5>
<p>VALE is a virtual switch that can be used to create an all virtual
network or a mix of virtual and real nics.</p>
<p>A simple all virtual setup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vale</span><span class="o">-</span><span class="n">ctl</span> <span class="o">-</span><span class="n">n</span> <span class="n">vi0</span>
<span class="n">vale</span><span class="o">-</span><span class="n">ctl</span> <span class="o">-</span><span class="n">a</span> <span class="n">vale0</span><span class="p">:</span><span class="n">vi0</span>
<span class="n">vale</span><span class="o">-</span><span class="n">ctl</span> <span class="o">-</span><span class="n">n</span> <span class="n">vi1</span>
<span class="n">vale</span><span class="o">-</span><span class="n">ctl</span> <span class="o">-</span><span class="n">a</span> <span class="n">vale0</span><span class="p">:</span><span class="n">vi1</span>
</pre></div>
</div>
<p>We now have a virtual switch &quot;vale0&quot; with 2 ports &quot;vi0&quot; and &quot;vi1&quot;.</p>
<p>We can start Suricata to listen on one of the ports:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">netmap</span><span class="o">=</span><span class="n">vale0</span><span class="p">:</span><span class="n">vi1</span>
</pre></div>
</div>
<p>Then we can</p>
</div>
</div>
<div class="section" id="inline-ids">
<h4>Inline IDS<a class="headerlink" href="#inline-ids" title="Permalink to this headline">¶</a></h4>
<p>The inline IDS is almost the same as the IPS setup above, but it will not
enforce <code class="docutils literal notranslate"><span class="pre">drop</span></code> policies.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netmap</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb0</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">tap</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">igb1</span>
  <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">igb1</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">tap</span>
    <span class="n">copy</span><span class="o">-</span><span class="n">iface</span><span class="p">:</span> <span class="n">igb0</span>
</pre></div>
</div>
<p>The only difference with the IPS mode is that the <code class="docutils literal notranslate"><span class="pre">copy-mode</span></code> setting is
set to <code class="docutils literal notranslate"><span class="pre">tap</span></code>.</p>
</div>
</div>
<span id="document-capture-hardware/af-xdp"></span><div class="section" id="af-xdp">
<h3>AF_XDP<a class="headerlink" href="#af-xdp" title="Permalink to this headline">¶</a></h3>
<p>AF_XDP (eXpress Data Path) is a high speed capture framework for Linux that was
introduced in Linux v4.18. AF_XDP aims at improving capture performance by
redirecting ingress frames to user-space memory rings, thus bypassing the network
stack.</p>
<p>Note that during <code class="docutils literal notranslate"><span class="pre">af_xdp</span></code> operation the selected interface cannot be used for
regular network usage.</p>
<p>Further reading:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://www.kernel.org/doc/html/latest/networking/af_xdp.html">https://www.kernel.org/doc/html/latest/networking/af_xdp.html</a></li>
</ul>
</div></blockquote>
<div class="section" id="compiling-suricata">
<h4>Compiling Suricata<a class="headerlink" href="#compiling-suricata" title="Permalink to this headline">¶</a></h4>
<div class="section" id="linux">
<h5>Linux<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h5>
<p>libxdp and libpbf are required for this feature. When building from source the
development files will also be required.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">libxdp</span><span class="o">-</span><span class="n">devel</span> <span class="n">libbpf</span><span class="o">-</span><span class="n">devel</span>
</pre></div>
</div>
<p>This feature is enabled provided the libraries above are installed, the user
does not need to add any additional command line options.</p>
<p>The command line option <code class="docutils literal notranslate"><span class="pre">--disable-af-xdp</span></code> can be used to disable this
feature.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="starting-suricata">
<h4>Starting Suricata<a class="headerlink" href="#starting-suricata" title="Permalink to this headline">¶</a></h4>
<div class="section" id="ids">
<h5>IDS<a class="headerlink" href="#ids" title="Permalink to this headline">¶</a></h5>
<p>Suricata can be started as follows to use af-xdp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">suricata</span> <span class="o">--</span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="o">=&lt;</span><span class="n">interface</span><span class="o">&gt;</span>
  <span class="n">suricata</span> <span class="o">--</span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="o">=</span><span class="n">igb0</span>
</pre></div>
</div>
<p>In the above example Suricata will start reading from the <cite>igb0</cite> network interface.</p>
</div>
</div>
<div class="section" id="af-xdp-configuration">
<h4>AF_XDP Configuration<a class="headerlink" href="#af-xdp-configuration" title="Permalink to this headline">¶</a></h4>
<p>Each of these settings can be configured under <code class="docutils literal notranslate"><span class="pre">af-xdp</span></code> within the &quot;Configure
common capture settings&quot; section of suricata.yaml configuration file.</p>
<p>The number of threads created can be configured in the suricata.yaml configuration
file. It is recommended to use threads equal to NIC queues/CPU cores.</p>
<p>Another option is to select <code class="docutils literal notranslate"><span class="pre">auto</span></code> which will allow Suricata to configure the
number of threads based on the number of RSS queues available on the NIC.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">auto</span></code> selected, Suricata spawns receive threads equal to the number of
configured RSS queues on the interface.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">threads</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
  <span class="n">threads</span><span class="p">:</span> <span class="n">auto</span>
  <span class="n">threads</span><span class="p">:</span> <span class="mi">8</span>
</pre></div>
</div>
</div>
<div class="section" id="advanced-setup">
<h4>Advanced setup<a class="headerlink" href="#advanced-setup" title="Permalink to this headline">¶</a></h4>
<p>af-xdp capture source will operate using the default configuration settings.
However, these settings are available in the suricata.yaml configuration file.</p>
<p>Available configuration options are:</p>
<div class="section" id="force-xdp-mode">
<h5>force-xdp-mode<a class="headerlink" href="#force-xdp-mode" title="Permalink to this headline">¶</a></h5>
<p>There are two operating modes employed when loading the XDP program, these are:</p>
<ul class="simple">
<li>XDP_DRV: Mode chosen when the driver supports AF_XDP</li>
<li>XDP_SKB: Mode chosen when no AF_XDP support is unavailable</li>
</ul>
<p>XDP_DRV mode is the preferred mode, used to ensure best performance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">force</span><span class="o">-</span><span class="n">xdp</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span> <span class="n">where</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">skb</span><span class="o">|</span><span class="n">drv</span><span class="o">|</span><span class="n">none</span><span class="o">&gt;</span>
  <span class="n">force</span><span class="o">-</span><span class="n">xdp</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">drv</span>
</pre></div>
</div>
</div>
<div class="section" id="force-bind-mode">
<h5>force-bind-mode<a class="headerlink" href="#force-bind-mode" title="Permalink to this headline">¶</a></h5>
<p>During binding the kernel will first attempt to use zero-copy (preferred). If
zero-copy support is unavailable it will fallback to copy mode, copying all
packets out to user space.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">force</span><span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span> <span class="n">where</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">copy</span><span class="o">|</span><span class="n">zero</span><span class="o">|</span><span class="n">none</span><span class="o">&gt;</span>
  <span class="n">force</span><span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> <span class="n">zero</span>
</pre></div>
</div>
<p>For both options, the kernel will attempt the 'preferred' option first and
fallback upon failure. Therefore the default (none) means the kernel has
control of which option to apply. By configuring these options the user
is forcing said option. Note that if enabled, the bind will only attempt
this option, upon failure the bind will fail i.e. no fallback.</p>
</div>
<div class="section" id="mem-unaligned">
<h5>mem-unaligned<a class="headerlink" href="#mem-unaligned" title="Permalink to this headline">¶</a></h5>
<p>AF_XDP can operate in two memory alignment modes, these are:</p>
<ul class="simple">
<li>Aligned chunk mode</li>
<li>Unaligned chunk mode</li>
</ul>
<p>Aligned chunk mode is the default option which ensures alignment of the
data within the UMEM.</p>
<p>Unaligned chunk mode uses hugepages for the UMEM.
Hugepages start at the size of 2MB but they can be as large as 1GB.
Lower count of pages (memory chunks) allows faster lookup of page entries.
The hugepages need to be allocated on the NUMA node where the NIC and CPU resides.
Otherwise, if the hugepages are allocated only on NUMA node 0 and the NIC is
connected to NUMA node 1, then the application will fail to start.
Therefore, it is recommended to first find out to which NUMA node the NIC is
connected to and only then allocate hugepages and set CPU cores affinity
to the given NUMA node.</p>
<p>Memory assigned per socket/thread is 16MB, so each worker thread requires at least
16MB of free space. As stated above hugepages can be of various sizes, consult the
OS to confirm with <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/proc/meminfo</span></code>.</p>
<p>Example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">8</span> <span class="n">worker</span> <span class="n">threads</span> <span class="o">*</span> <span class="mi">16</span><span class="n">Mb</span> <span class="o">=</span> <span class="mi">128</span><span class="n">Mb</span>
<span class="n">hugepages</span> <span class="o">=</span> <span class="mi">2048</span> <span class="n">kB</span>
<span class="n">so</span><span class="p">:</span> <span class="n">pages</span> <span class="n">required</span> <span class="o">=</span> <span class="mf">62.5</span> <span class="p">(</span><span class="mi">63</span><span class="p">)</span> <span class="n">pages</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt">https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt</a> for detailed
description.</p>
<p>To enable unaligned chunk mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">mem</span><span class="o">-</span><span class="n">unaligned</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">yes</span><span class="o">/</span><span class="n">no</span><span class="o">&gt;</span>
  <span class="n">mem</span><span class="o">-</span><span class="n">unaligned</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>Introduced from Linux v5.11 a <code class="docutils literal notranslate"><span class="pre">SO_PREFER_BUSY_POLL</span></code> option has been added to
AF_XDP that allows a true polling of the socket queues. This feature has
been introduced to reduce context switching and improve CPU reaction time
during traffic reception.</p>
<p>Enabled by default, this feature will apply the following options, unless
disabled (see below). The following options are used to configure this feature.</p>
</div>
<div class="section" id="enable-busy-poll">
<h5>enable-busy-poll<a class="headerlink" href="#enable-busy-poll" title="Permalink to this headline">¶</a></h5>
<p>Enables or disables busy polling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">enable</span><span class="o">-</span><span class="n">busy</span><span class="o">-</span><span class="n">poll</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">yes</span><span class="o">/</span><span class="n">no</span><span class="o">&gt;</span>
  <span class="n">enable</span><span class="o">-</span><span class="n">busy</span><span class="o">-</span><span class="n">poll</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
</div>
<div class="section" id="busy-poll-time">
<h5>busy-poll-time<a class="headerlink" href="#busy-poll-time" title="Permalink to this headline">¶</a></h5>
<p>Sets the approximate time in microseconds to busy poll on a <code class="docutils literal notranslate"><span class="pre">blocking</span> <span class="pre">receive</span></code>
when there is no data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">busy</span><span class="o">-</span><span class="n">poll</span><span class="o">-</span><span class="n">time</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">time</span><span class="o">&gt;</span>
  <span class="n">busy</span><span class="o">-</span><span class="n">poll</span><span class="o">-</span><span class="n">time</span><span class="p">:</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<div class="section" id="busy-poll-budget">
<h5>busy-poll-budget<a class="headerlink" href="#busy-poll-budget" title="Permalink to this headline">¶</a></h5>
<p>Budget allowed for batching of ingress frames. Larger values means more
frames can be stored/read. It is recommended to test this for performance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">busy</span><span class="o">-</span><span class="n">poll</span><span class="o">-</span><span class="n">budget</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">budget</span><span class="o">&gt;</span>
  <span class="n">busy</span><span class="o">-</span><span class="n">poll</span><span class="o">-</span><span class="n">budget</span><span class="p">:</span> <span class="mi">64</span>
</pre></div>
</div>
</div>
<div class="section" id="linux-tunables">
<h5>Linux tunables<a class="headerlink" href="#linux-tunables" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">SO_PREFER_BUSY_POLL</span></code> option works in concert with the following two Linux
knobs to ensure best capture performance. These are not socket options:</p>
<ul class="simple">
<li>gro-flush-timeout</li>
<li>napi-defer-hard-irq</li>
</ul>
<p>The purpose of these two knobs is to defer interrupts and to allow the
NAPI context to be scheduled from a watchdog timer instead.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">gro-flush-timeout</span></code> indicates the timeout period for the watchdog
timer. When no traffic is received for <code class="docutils literal notranslate"><span class="pre">gro-flush-timeout</span></code> the timer will
exit and softirq handling will resume.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">napi-defer-hard-irq</span></code> indicates the number of queue scan attempts
before exiting to interrupt context. When enabled, the softirq NAPI context will
exit early, allowing busy polling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af</span><span class="o">-</span><span class="n">xdp</span><span class="p">:</span>
  <span class="n">gro</span><span class="o">-</span><span class="n">flush</span><span class="o">-</span><span class="n">timeout</span><span class="p">:</span> <span class="mi">2000000</span>
  <span class="n">napi</span><span class="o">-</span><span class="n">defer</span><span class="o">-</span><span class="n">hard</span><span class="o">-</span><span class="n">irq</span><span class="p">:</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="hardware-setup">
<h4>Hardware setup<a class="headerlink" href="#hardware-setup" title="Permalink to this headline">¶</a></h4>
<div class="section" id="intel-nic-setup">
<h5>Intel NIC setup<a class="headerlink" href="#intel-nic-setup" title="Permalink to this headline">¶</a></h5>
<p>Intel network cards don't support symmetric hashing but it is possible to emulate
it by using a specific hashing function.</p>
<p>Follow these instructions closely for desired result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="n">eth3</span> <span class="n">down</span>
</pre></div>
</div>
<p>Enable symmetric hashing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="n">eth3</span> <span class="n">down</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">L</span> <span class="n">eth3</span> <span class="n">combined</span> <span class="mi">16</span> <span class="c1"># if you have at least 16 cores</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eth3</span> <span class="n">rxhash</span> <span class="n">on</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">eth3</span> <span class="n">ntuple</span> <span class="n">on</span>
<span class="n">ifconfig</span> <span class="n">eth3</span> <span class="n">up</span>
<span class="o">./</span><span class="n">set_irq_affinity</span> <span class="mi">0</span><span class="o">-</span><span class="mi">15</span> <span class="n">eth3</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">X</span> <span class="n">eth3</span> <span class="n">hkey</span> <span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span><span class="p">:</span><span class="mi">6</span><span class="n">D</span><span class="p">:</span><span class="mi">5</span><span class="n">A</span> <span class="n">equal</span> <span class="mi">16</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">x</span> <span class="n">eth3</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">n</span> <span class="n">eth3</span>
</pre></div>
</div>
<p>In the above setup you are free to use any recent <code class="docutils literal notranslate"><span class="pre">set_irq_affinity</span></code> script. It is available in any Intel x520/710 NIC sources driver download.</p>
<p><strong>NOTE:</strong>
We use a special low entropy key for the symmetric hashing. <a class="reference external" href="http://www.ndsl.kaist.edu/~kyoungsoo/papers/TR-symRSS.pdf">More info about the research for symmetric hashing set up</a></p>
</div>
<div class="section" id="disable-any-nic-offloading">
<h5>Disable any NIC offloading<a class="headerlink" href="#disable-any-nic-offloading" title="Permalink to this headline">¶</a></h5>
<p>Suricata shall disable NIC offloading based on configuration parameter <code class="docutils literal notranslate"><span class="pre">disable-offloading</span></code>, which is enabled by default.
See <code class="docutils literal notranslate"><span class="pre">capture</span></code> section of yaml file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">capture</span><span class="p">:</span>
  <span class="c1"># disable NIC offloading. It&#39;s restored when Suricata exits.</span>
  <span class="c1"># Enabled by default.</span>
  <span class="c1">#disable-offloading: false</span>
</pre></div>
</div>
</div>
<div class="section" id="balance-as-much-as-you-can">
<h5>Balance as much as you can<a class="headerlink" href="#balance-as-much-as-you-can" title="Permalink to this headline">¶</a></h5>
<p>Try to use the network card's flow balancing as much as possible</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for proto in tcp4 udp4 ah4 esp4 sctp4 tcp6 udp6 ah6 esp6 sctp6; do
   /sbin/ethtool -N eth3 rx-flow-hash $proto sd
done
</pre></div>
</div>
<p>This command triggers load balancing using only source and destination IPs. This may be not optimal
in terms of load balancing fairness but this ensures all packets of a flow will reach the same thread
even in the case of IP fragmentation (where source and destination port will not be available for
some fragmented packets).</p>
</div>
</div>
</div>
<span id="document-capture-hardware/dpdk"></span><div class="section" id="dpdk">
<span id="id1"></span><h3>DPDK<a class="headerlink" href="#dpdk" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>The Data Plane Development Kit (DPDK) is a set of libraries and drivers that
enhance and speed up packet processing in the data plane. Its primary use is to
provide faster packet processing by bypassing the kernel network stack, which
can provide significant performance improvements. For detailed instructions on
how to setup DPDK, please refer to <a class="reference internal" href="index.html#document-configuration/suricata-yaml"><span class="doc">Suricata.yaml</span></a> to
learn more about the basic setup for DPDK.
The following sections contain examples of how to set up DPDK and Suricata for
more obscure use-cases.</p>
</div>
<div class="section" id="bond-interface">
<h4>Bond interface<a class="headerlink" href="#bond-interface" title="Permalink to this headline">¶</a></h4>
<p>Link Bonding Poll Mode Driver (Bond PMD), is a software
mechanism provided by the Data Plane Development Kit (DPDK) for aggregating
multiple physical network interfaces into a single logical interface.
Bonding can be e.g. used to:</p>
<ul class="simple">
<li>deliver bidirectional flows of tapped interfaces to the same worker,</li>
<li>establish redundancy by monitoring multiple links,</li>
<li>improve network performance by load-balancing traffic across multiple links.</li>
</ul>
<p>Bond PMD is essentially a virtual driver that manipulates with multiple
physical network interfaces. It can operate in multiple modes as described
in the <a class="reference external" href="https://doc.dpdk.org/guides/prog_guide/link_bonding_poll_mode_drv_lib.html">DPDK docs</a>
The individual bonding modes can accustom user needs.
DPDK Bond PMD has a requirement that the aggregated interfaces must be
the same device types - e.g. both physical ports run on mlx5 PMD.
Bond PMD supports multiple queues and therefore can work in workers runmode.
It should have no effect on traffic distribution of the individual ports and
flows should be distributed by physical ports according to the RSS
configuration the same way as if they would be configured independently.</p>
<p>As an example of Bond PMD, we can setup Suricata to monitor 2 interfaces
that receive TAP traffic from optical interfaces. This means that Suricata
receive one direction of the communication on one interface and the other
direction is received on the other interface.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">dpdk</span><span class="p">:</span>
  <span class="n">eal</span><span class="o">-</span><span class="n">params</span><span class="p">:</span>
    <span class="n">proc</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">primary</span>
    <span class="n">vdev</span><span class="p">:</span> <span class="s1">&#39;net_bonding0,mode=0,slave=0000:04:00.0,slave=0000:04:00.1&#39;</span>

  <span class="c1"># DPDK capture support</span>
  <span class="c1"># RX queues (and TX queues in IPS mode) are assigned to cores in 1:1 ratio</span>
  <span class="n">interfaces</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">interface</span><span class="p">:</span> <span class="n">net_bonding0</span> <span class="c1"># PCIe address of the NIC port</span>
      <span class="c1"># Threading: possible values are either &quot;auto&quot; or number of threads</span>
      <span class="c1"># - auto takes all cores</span>
      <span class="c1"># in IPS mode it is required to specify the number of cores and the</span>
      <span class="c1"># numbers on both interfaces must match</span>
      <span class="n">threads</span><span class="p">:</span> <span class="mi">4</span>
<span class="o">...</span>
</pre></div>
</div>
<p>In the DPDK part of suricata.yaml we have added a new parameter to the
eal-params section for virtual devices - <cite>vdev</cite>.
DPDK Environment Abstraction Layer (EAL) can initialize some virtual devices
during the initialization of EAL.
In this case, EAL creates a new device of type <cite>net_bonding</cite>. Suffix of
<cite>net_bonding</cite> signifies the name of the interface (in this case the zero).
Extra arguments are passed after the device name, such as the bonding mode
(<cite>mode=0</cite>). This is the round-robin mode as is described in the DPDK
documentation of Bond PMD.
Members (slaves) of the <cite>net_bonding0</cite> interface are appended after
the bonding mode parameter.</p>
<p>When the device is specified within EAL parameters, it can be used within
Suricata <cite>interfaces</cite> list. Note that the list doesn't contain PCIe addresses
of the physical ports but instead the <cite>net_bonding0</cite> interface.
Threading section is also adjusted according to the items in the interfaces
list by enablign set-cpu-affinity and listing CPUs that should be used in
management and worker CPU set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">threading</span><span class="p">:</span>
  <span class="nb">set</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span> <span class="n">yes</span>
  <span class="n">cpu</span><span class="o">-</span><span class="n">affinity</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">management</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>  <span class="c1"># include only these CPUs in affinity settings</span>
    <span class="o">-</span> <span class="n">receive</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>  <span class="c1"># include only these CPUs in affinity settings</span>
    <span class="o">-</span> <span class="n">worker</span><span class="o">-</span><span class="n">cpu</span><span class="o">-</span><span class="nb">set</span><span class="p">:</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span> <span class="p">]</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-unix-socket"></span><div class="section" id="interacting-via-unix-socket">
<h2>Interacting via Unix Socket<a class="headerlink" href="#interacting-via-unix-socket" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>Suricata can listen to a unix socket and accept commands from the user. The
exchange protocol is JSON-based and the format of the message is generic.</p>
<p>An example script called <code class="docutils literal notranslate"><span class="pre">suricatasc</span></code> is provided in the source and installed
automatically when installing/updating Suricata.</p>
<p>The unix socket is always enabled by default.</p>
<p>You'll need to have JSON support in Python:</p>
<ul class="simple">
<li>python-simplejson - simple, fast, extensible JSON encoder/decoder for Python</li>
</ul>
<p>Debian/Ubuntu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">simplejson</span>
</pre></div>
</div>
<p>The creation of the socket is managed by setting enabled to 'yes' or 'auto'
under unix-command in Suricata YAML configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unix</span><span class="o">-</span><span class="n">command</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">yes</span>
  <span class="c1">#filename: custom.socket # use this to specify an alternate file</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">filename</span></code> variable can be used to set an alternate socket
filename. The filename is always relative to the local state base
directory.</p>
<p>Clients are implemented for some programming languages and can be used as code
example to write custom scripts:</p>
<ul class="simple">
<li>Python: <a class="reference external" href="https://github.com/OISF/suricata/blob/master/python/suricata/sc/suricatasc.py">https://github.com/OISF/suricata/blob/master/python/suricata/sc/suricatasc.py</a> (provided with Suricata and used in this document)</li>
<li>Perl: <a class="reference external" href="https://github.com/aflab/suricatac">https://github.com/aflab/suricatac</a> (a simple Perl client with interactive mode)</li>
<li>C: <a class="reference external" href="https://github.com/regit/SuricataC">https://github.com/regit/SuricataC</a> (a Unix socket mode client in C without interactive mode)</li>
</ul>
</div>
<div class="section" id="commands-in-standard-running-mode">
<span id="standard-unix-socket-commands"></span><h3>Commands in standard running mode<a class="headerlink" href="#commands-in-standard-running-mode" title="Permalink to this headline">¶</a></h3>
<p>Runnable script for suricatasc is available in <cite>python/bin</cite> directory of suricata. You can
run it with the following commands.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">python</span>
<span class="n">sudo</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">suricatasc</span>
</pre></div>
</div>
<p>The set of existing commands is the following:</p>
<ul class="simple">
<li>command-list: list available commands</li>
<li>shutdown: shutdown Suricata</li>
<li>iface-list: list interfaces where Suricata is sniffing packets</li>
<li>iface-stat: list statistics for an interface</li>
<li>help: alias of command-list</li>
<li>version: display Suricata's version</li>
<li>uptime: display Suricata's uptime</li>
<li>running-mode: display running mode (workers, autofp, simple)</li>
<li>capture-mode: display capture system used</li>
<li>conf-get: get configuration item (see example below)</li>
<li>dump-counters: dump Suricata's performance counters</li>
<li>reopen-log-files: reopen log files (to be run after external log rotation)</li>
<li>ruleset-reload-rules: reload ruleset and wait for completion</li>
<li>ruleset-reload-nonblocking: reload ruleset and proceed without waiting</li>
<li>ruleset-reload-time: return time of last reload</li>
<li>ruleset-stats: display the number of rules loaded and failed</li>
<li>ruleset-failed-rules: display the list of failed rules</li>
<li>memcap-set: update memcap value of the specified item</li>
<li>memcap-show: show memcap value of the specified item</li>
<li>memcap-list: list all memcap values available</li>
<li>reload-rules: alias of ruleset-reload-rules</li>
<li>register-tenant-handler: register a tenant handler with the specified mapping</li>
<li>unregister-tenant-handler: unregister a tenant handler with the specified mapping</li>
<li>register-tenant: register tenant with a particular ID and filename</li>
<li>unregister-tenant: unregister tenant with a particular ID</li>
<li>reload-tenant: reload a tenant with specified ID and filename</li>
<li>add-hostbit: add hostbit on a host IP with a particular bit name and time of expiry</li>
<li>remove-hostbit: remove hostbit on a host IP with specified bit name</li>
<li>list-hostbit: list hostbit for a particular host IP</li>
</ul>
<p>You can access these commands with the provided example <code class="docutils literal notranslate"><span class="pre">suricatasc</span></code> script.
A typical session with <code class="docutils literal notranslate"><span class="pre">suricatasc</span></code> looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># suricatasc</span>
<span class="n">Command</span> <span class="nb">list</span><span class="p">:</span> <span class="n">shutdown</span><span class="p">,</span> <span class="n">command</span><span class="o">-</span><span class="nb">list</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">uptime</span><span class="p">,</span> <span class="n">running</span><span class="o">-</span><span class="n">mode</span><span class="p">,</span> <span class="n">capture</span><span class="o">-</span><span class="n">mode</span><span class="p">,</span> <span class="n">conf</span><span class="o">-</span><span class="n">get</span><span class="p">,</span> <span class="n">dump</span><span class="o">-</span><span class="n">counters</span><span class="p">,</span> <span class="n">iface</span><span class="o">-</span><span class="n">stat</span><span class="p">,</span> <span class="n">iface</span><span class="o">-</span><span class="nb">list</span><span class="p">,</span> <span class="n">quit</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iface</span><span class="o">-</span><span class="nb">list</span>
<span class="n">Success</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;ifaces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;eth0&#39;</span><span class="p">,</span> <span class="s1">&#39;eth1&#39;</span><span class="p">]}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iface</span><span class="o">-</span><span class="n">stat</span> <span class="n">eth0</span>
<span class="n">Success</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pkts&#39;</span><span class="p">:</span> <span class="mi">378</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;invalid-checksums&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">conf</span><span class="o">-</span><span class="n">get</span> <span class="n">unix</span><span class="o">-</span><span class="n">command</span><span class="o">.</span><span class="n">enabled</span>
<span class="n">Success</span><span class="p">:</span>
<span class="s2">&quot;yes&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="commands-on-the-cmd-prompt">
<h3>Commands on the cmd prompt<a class="headerlink" href="#commands-on-the-cmd-prompt" title="Permalink to this headline">¶</a></h3>
<p>You can use <code class="docutils literal notranslate"><span class="pre">suricatasc</span></code> directly on the command prompt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@debian64</span><span class="p">:</span><span class="o">~</span><span class="c1"># suricatasc -c version</span>
<span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;5.0.3 RELEASE&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span>
<span class="n">root</span><span class="nd">@debian64</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
<span class="n">root</span><span class="nd">@debian64</span><span class="p">:</span><span class="o">~</span><span class="c1"># suricatasc -c uptime</span>
<span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="mi">35264</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span>
<span class="n">root</span><span class="nd">@debian64</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
<p><strong>NOTE:</strong>
You need to quote commands with more than one argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@debian64</span><span class="p">:</span><span class="o">~</span><span class="c1"># suricatasc -c &quot;iface-stat eth0&quot;</span>
<span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pkts&#39;</span><span class="p">:</span> <span class="mi">5110429</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;invalid-checksums&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span>
<span class="n">root</span><span class="nd">@debian64</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
</div>
<div class="section" id="pcap-processing-mode">
<h3>PCAP processing mode<a class="headerlink" href="#pcap-processing-mode" title="Permalink to this headline">¶</a></h3>
<p>This mode is one of main motivations behind this code. The idea is to
be able to provide different pcap files to Suricata without
having to restart Suricata for each file. This saves time since
you don't need to wait for the signature engine to initialize.</p>
<p>To use this mode, start Suricata with your preferred configuration YAML file and
provide the option <code class="docutils literal notranslate"><span class="pre">--unix-socket</span></code> as argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">sigs</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">unix</span><span class="o">-</span><span class="n">socket</span>
</pre></div>
</div>
<p>It is also possible to specify the socket filename as an argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">unix</span><span class="o">-</span><span class="n">socket</span><span class="o">=</span><span class="n">custom</span><span class="o">.</span><span class="n">socket</span>
</pre></div>
</div>
<p>In this last case, you will need to provide the complete path to the
socket to <code class="docutils literal notranslate"><span class="pre">suricatasc</span></code>. To do so, you need to pass the filename as
first argument of <code class="docutils literal notranslate"><span class="pre">suricatasc</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricatasc</span> <span class="n">custom</span><span class="o">.</span><span class="n">socket</span>
</pre></div>
</div>
<p>Once Suricata is started, you can use <code class="docutils literal notranslate"><span class="pre">suricatasc</span></code> to connect to the
command socket and provide different pcap files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@tiger</span><span class="p">:</span><span class="o">~</span><span class="c1"># suricatasc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benches</span><span class="o">/</span><span class="n">file1</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">file1</span>
<span class="n">Success</span><span class="p">:</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">file</span> <span class="n">to</span> <span class="nb">list</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">benches</span><span class="o">/</span><span class="n">file2</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">file2</span>
<span class="n">Success</span><span class="p">:</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">file</span> <span class="n">to</span> <span class="nb">list</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pcap</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">continuous</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pcaps</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dirout</span>
<span class="n">Success</span><span class="p">:</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">file</span> <span class="n">to</span> <span class="nb">list</span>
</pre></div>
</div>
<p>You can add multiple files without waiting for each to be processed; they will be
sequentially processed and the generated log/alert files will be put
into the directory specified as second argument of the pcap-file
command. You need to provide an absolute path to the files and directory
as Suricata doesn't know from where the script has been run. If you pass
a directory instead of a file, all files in the directory will be processed. If
using <code class="docutils literal notranslate"><span class="pre">pcap-file-continuous</span></code> and passing in a directory, the directory will
be monitored for new files being added until you use <code class="docutils literal notranslate"><span class="pre">pcap-interrupt</span></code> or
delete/move the directory.</p>
<p>To display  how many files are waiting to get processed, you can do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">number</span>
<span class="go">Success: 3</span>
</pre></div>
</div>
<p>To display the list of queued files, do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="nb">list</span>
<span class="go">Success: {&#39;count&#39;: 2, &#39;files&#39;: [&#39;/home/benches/file1.pcap&#39;, &#39;/home/benches/file2.pcap&#39;]}</span>
</pre></div>
</div>
<p>To display current processed file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">current</span>
<span class="go">Success:</span>
<span class="go">&quot;/tmp/test.pcap&quot;</span>
</pre></div>
</div>
<p>When passing in a directory, you can see last processed time (modified time of last file) in milliseconds since epoch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">last</span><span class="o">-</span><span class="n">processed</span>
<span class="go">Success:</span>
<span class="go">1509138964000</span>
</pre></div>
</div>
<p>To interrupt directory processing which terminates the current state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">interrupt</span>
<span class="go">Success:</span>
<span class="go">&quot;Interrupted&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="build-your-own-client">
<h3>Build your own client<a class="headerlink" href="#build-your-own-client" title="Permalink to this headline">¶</a></h3>
<p>The protocol is documented in the following page
<a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Unix_Socket#Protocol">https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Unix_Socket#Protocol</a></p>
<p>The following session show what is sent (SND) and received (RCV) by
the server. Initial negotiation is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># suricatasc</span>
<span class="n">SND</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.1&quot;</span><span class="p">}</span>
<span class="n">RCV</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Once this is done, commands can be issued:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">iface</span><span class="o">-</span><span class="nb">list</span>
<span class="go">SND: {&quot;command&quot;: &quot;iface-list&quot;}</span>
<span class="go">RCV: {&quot;message&quot;: {&quot;count&quot;: 1, &quot;ifaces&quot;: [&quot;wlan0&quot;]}, &quot;return&quot;: &quot;OK&quot;}</span>
<span class="go">Success: {&#39;count&#39;: 1, &#39;ifaces&#39;: [&#39;wlan0&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">iface</span><span class="o">-</span><span class="n">stat</span> <span class="n">wlan0</span>
<span class="go">SND: {&quot;command&quot;: &quot;iface-stat&quot;, &quot;arguments&quot;: {&quot;iface&quot;: &quot;wlan0&quot;}}</span>
<span class="go">RCV: {&quot;message&quot;: {&quot;pkts&quot;: 41508, &quot;drop&quot;: 0, &quot;invalid-checksums&quot;: 0}, &quot;return&quot;: &quot;OK&quot;}</span>
<span class="go">Success: {&#39;pkts&#39;: 41508, &#39;drop&#39;: 0, &#39;invalid-checksums&#39;: 0}</span>
</pre></div>
</div>
<p>In pcap-file mode, this gives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">file</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eric</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">oisf</span><span class="o">/</span><span class="n">benches</span><span class="o">/</span><span class="n">sandnet</span><span class="o">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bench</span>
<span class="go">SND: {&quot;command&quot;: &quot;pcap-file&quot;, &quot;arguments&quot;: {&quot;output-dir&quot;: &quot;/tmp/bench&quot;, &quot;filename&quot;: &quot;/home/eric/git/oisf/benches/sandnet.pcap&quot;}}</span>
<span class="go">RCV: {&quot;message&quot;: &quot;Successfully added file to list&quot;, &quot;return&quot;: &quot;OK&quot;}</span>
<span class="go">Success: Successfully added file to list</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">number</span>
<span class="go">SND: {&quot;command&quot;: &quot;pcap-file-number&quot;}</span>
<span class="go">RCV: {&quot;message&quot;: 1, &quot;return&quot;: &quot;OK&quot;}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="nb">list</span>
<span class="go">SND: {&quot;command&quot;: &quot;pcap-file-list&quot;}</span>
<span class="go">RCV: {&quot;message&quot;: {&quot;count&quot;: 1, &quot;files&quot;: [&quot;/home/eric/git/oisf/benches/sandnet.pcap&quot;]}, &quot;return&quot;: &quot;OK&quot;}</span>
<span class="go">Success: {&#39;count&#39;: 1, &#39;files&#39;: [&#39;/home/eric/git/oisf/benches/sandnet.pcap&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pcap</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">continuous</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">eric</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">oisf</span><span class="o">/</span><span class="n">benches</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bench</span> <span class="mi">0</span> <span class="n">true</span>
<span class="go">SND: {&quot;command&quot;: &quot;pcap-file&quot;, &quot;arguments&quot;: {&quot;output-dir&quot;: &quot;/tmp/bench&quot;, &quot;filename&quot;: &quot;/home/eric/git/oisf/benches/sandnet.pcap&quot;, &quot;tenant&quot;: 0, &quot;delete-when-done&quot;: true}}</span>
<span class="go">RCV: {&quot;message&quot;: &quot;Successfully added file to list&quot;, &quot;return&quot;: &quot;OK&quot;}</span>
<span class="go">Success: Successfully added file to list</span>
</pre></div>
</div>
<p>There is one thing to be careful about: a Suricata message is sent in
multiple send operations. This result in possible incomplete read on
client side. The worse workaround is to sleep a bit before trying a
recv call. An other solution is to use non blocking socket and retry a
recv if the previous one has failed.</p>
<p>Pcap-file json format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;pcap-file&quot;</span><span class="p">,</span>
  <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;output-dir&quot;</span><span class="p">:</span> <span class="s2">&quot;path to output dir&quot;</span><span class="p">,</span>
    <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;path to file or directory to run&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tenant&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;continuous&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;delete-when-done&quot;</span><span class="p">:</span> <span class="n">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><cite>output-dir</cite> and <cite>filename</cite> are required. <cite>tenant</cite> is optional and should be a
number, indicating which tenant the file or directory should run under. <cite>continuous</cite>
is optional and should be true/false, indicating that file or directory should be
run until <cite>pcap-interrupt</cite> is sent or ctrl-c is invoked. <cite>delete-when-done</cite> is
optional and should be true/false, indicating that the file or files under the
directory specified by <cite>filename</cite> should be deleted when processing is complete.
<cite>delete-when-done</cite> defaults to false, indicating files will be kept after
processing.</p>
</div>
</div>
<span id="document-3rd-party-integration/index"></span><div class="section" id="rd-party-integration">
<h2>3rd Party Integration<a class="headerlink" href="#rd-party-integration" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-3rd-party-integration/symantec-sslv"></span><div class="section" id="symantec-ssl-visibility-bluecoat">
<h3>Symantec SSL Visibility (BlueCoat)<a class="headerlink" href="#symantec-ssl-visibility-bluecoat" title="Permalink to this headline">¶</a></h3>
<p>As Suricata itself cannot decrypt SSL/TLS traffic, some organizations use
a decryption product to handle this. This document will offer some advice
on using Suricata with the Symantec SSL Visibility appliance (formerly
known as BlueCoat).</p>
<div class="section" id="appliance-software-version">
<h4>Appliance Software Version<a class="headerlink" href="#appliance-software-version" title="Permalink to this headline">¶</a></h4>
<p>The appliance comes with two major software version options. The 3.x and 4.x
series. Suricata works best with the 4.x series.</p>
<p>TLS1.3 is only properly supported in the 4.x version of the appliance
software.</p>
</div>
<div class="section" id="magic-markers">
<h4>Magic Markers<a class="headerlink" href="#magic-markers" title="Permalink to this headline">¶</a></h4>
<p>The appliance has an indicator that data is decrypted. This is done using
a special magic source MAC address, or using a special VLAN header. Since
Suricata can use VLANs as part of flow tracking, it is recommended to use
the source MAC method.</p>
<p>In the 3.x version of the software these markers are always there, the
config just allows setting which type will be used. In the 4.x software the
markers are optional.</p>
</div>
<div class="section" id="tcp-handling">
<h4>TCP handling<a class="headerlink" href="#tcp-handling" title="Permalink to this headline">¶</a></h4>
<p>In the 3.x software, a bit of care is required in TCP stream reassembly
handling in Suricata. The decrypted traffic is presented to the IDS as
TCP data packets, that are not ack'd as regularly as would be expected
in a regular TCP session. A large TCP window is used to not violate the
TCP specs. Since in IDS mode Suricata waits for ACKs for much of its
processing, this can lead to delays in detection and logging, as well
as increased resource usage due to increased data buffering.</p>
<p>To avoid this, enable the 'stream.inline' mode, which processed data
segments as they come in without waiting for the ACKs.</p>
<p>The 4.x software sends more regular ACKs and does not need any special
handling on the Suricata side.</p>
</div>
<div class="section" id="tls-matching-in-suricata">
<h4>TLS matching in Suricata<a class="headerlink" href="#tls-matching-in-suricata" title="Permalink to this headline">¶</a></h4>
<p>The appliance takes care of the TLS handling and decryption, presenting
only the decrypted data to Suricata. This means that Suricata will not
see the TLS handshake. As a consequence of this, Suricata cannot inspect
the TLS handshake or otherwise process it. This means that for decrypted
TLS sessions, Suricata will not do any TLS keyword inspection (such as
fingerprint matching and ja3), TLS logging or TLS certificate extraction.</p>
<p>If it is important to match on and/or log such information as well, the
appliance facilities for matching and logging themselves will have to be
used.</p>
<p>For TLS traffic where the appliance security policy does not lead to
decryption of the traffic, the TLS handshake is presented to Suricata
for analysis and logging.</p>
</div>
<div class="section" id="ips">
<h4>IPS<a class="headerlink" href="#ips" title="Permalink to this headline">¶</a></h4>
<p>When using Suricata in IPS mode with the appliance, some things will
have to be considered:</p>
<ul class="simple">
<li>if Suricata DROPs a packet in the decrypted traffic, this will be seen
by the appliance after which it will trigger a RST session teardown.</li>
<li>if a packet takes more than one second to process, it will automatically
be considered a DROP by the appliance. This should not happen in normal
traffic, but with very inefficient Lua scripts this could perhaps
happen. The appliance can also be configured to wait for 5 seconds.</li>
<li>When using the Suricata 'replace' keyword to modify data, be aware
that the 3.x appliance software will not pass the modification on to
the destination so this will not have any effect. The 4.x appliance
software does support passing on modifications that were made to the
unencrypted text, by default this feature is disabled but you can
enable it if you want modifications to be passed on to the destination
in the re-encrypted stream. Due to how Suricata works, the size of
the payloads cannot be changed.</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-manpages/index"></span><div class="section" id="man-pages">
<h2>Man Pages<a class="headerlink" href="#man-pages" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-manpages/suricata"></span><div class="section" id="suricata">
<h3>Suricata<a class="headerlink" href="#suricata" title="Permalink to this headline">¶</a></h3>
<div class="section" id="synopsis">
<h4>SYNOPSIS<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h4>
<p><strong>suricata</strong> [OPTIONS] [BPF FILTER]</p>
</div>
<div class="section" id="description">
<h4>DESCRIPTION<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p><strong>suricata</strong> is a high performance Network IDS, IPS and Network Security
Monitoring engine. Open Source and owned by a community run non-profit
foundation, the Open Information Security Foundation (OISF).</p>
<p><strong>suricata</strong> can be used to analyze live traffic and pcap files. It can
generate alerts based on rules. <strong>suricata</strong> will generate traffic logs.</p>
<p>When used with live traffic <strong>suricata</strong> can be passive or active. Active
modes are: inline in a L2 bridge setup, inline with L3 integration with
host firewall (NFQ, IPFW, WinDivert), or out of band using active responses.</p>
</div>
<div class="section" id="options">
<h4>OPTIONS<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h4>
<dl class="option">
<dt id="cmdoption-h">
<code class="descname">-h</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-h" title="Permalink to this definition">¶</a></dt>
<dd><p>Display a brief usage overview.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-v">
<code class="descname">-V</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-v" title="Permalink to this definition">¶</a></dt>
<dd><p>Displays the version of Suricata.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-c">
<code class="descname">-c</code><code class="descclassname"> &lt;path&gt;</code><a class="headerlink" href="#cmdoption-c" title="Permalink to this definition">¶</a></dt>
<dd><p>Path to configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-include">
<code class="descname">--include</code><code class="descclassname"> &lt;path&gt;</code><a class="headerlink" href="#cmdoption-include" title="Permalink to this definition">¶</a></dt>
<dd><p>Additional configuration files to include. Multiple additional
configuration files can be provided and will be included in the
order specified on the command line.  These additional configuration
files are loaded as if they existed at the end of the main
configuration file.</p>
<p>Example including one additional file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">other</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>Example including more than one additional file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">other</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">suricata</span><span class="o">/</span><span class="n">extra</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="cmdoption-t">
<code class="descname">-T</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-t" title="Permalink to this definition">¶</a></dt>
<dd><p>Test configuration.</p>
</dd></dl>

<span class="target" id="cmdline-option-v"></span><dl class="option">
<dt id="id1">
<code class="descname">-v</code><code class="descclassname"></code><a class="headerlink" href="#id1" title="Permalink to this definition">¶</a></dt>
<dd><p>Increase the verbosity of the Suricata application logging by
increasing the log level from the default. This option can be
passed multiple times to further increase the verbosity.</p>
<ul class="simple">
<li>-v: INFO</li>
<li>-vv: PERF</li>
<li>-vvv: CONFIG</li>
<li>-vvvv: DEBUG</li>
</ul>
<p>This option will not decrease the log level set in the
configuration file if it is already more verbose than the level
requested with this option.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-r">
<code class="descname">-r</code><code class="descclassname"> &lt;path&gt;</code><a class="headerlink" href="#cmdoption-r" title="Permalink to this definition">¶</a></dt>
<dd><p>Run in pcap offline mode (replay mode) reading files from pcap file. If
&lt;path&gt; specifies a directory, all files in that directory will be processed
in order of modified time maintaining flow state between files.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-file-continuous">
<code class="descname">--pcap-file-continuous</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-pcap-file-continuous" title="Permalink to this definition">¶</a></dt>
<dd><p>Used with the -r option to indicate that the mode should stay alive until
interrupted. This is useful with directories to add new files and not reset
flow state between files.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-file-recursive">
<code class="descname">--pcap-file-recursive</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-pcap-file-recursive" title="Permalink to this definition">¶</a></dt>
<dd><p>Used with the -r option when the path provided is a directory.  This option
enables recursive traversal into subdirectories to a maximum depth of 255.
This option cannot be combined with --pcap-file-continuous.  Symlinks are
ignored.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-file-delete">
<code class="descname">--pcap-file-delete</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-pcap-file-delete" title="Permalink to this definition">¶</a></dt>
<dd><p>Used with the -r option to indicate that the mode should delete pcap files
after they have been processed. This is useful with pcap-file-continuous to
continuously feed files to a directory and have them cleaned up when done. If
this option is not set, pcap files will not be deleted after processing.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-i">
<code class="descname">-i</code><code class="descclassname"> &lt;interface&gt;</code><a class="headerlink" href="#cmdoption-i" title="Permalink to this definition">¶</a></dt>
<dd><p>After the -i option you can enter the interface card you would like
to use to sniff packets from.  This option will try to use the best
capture method available. Can be used several times to sniff packets from
several interfaces.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap">
<code class="descname">--pcap[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-pcap" title="Permalink to this definition">¶</a></dt>
<dd><p>Run in PCAP mode. If no device is provided the interfaces
provided in the <em>pcap</em> section of the configuration file will be
used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-af-packet">
<code class="descname">--af-packet[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-af-packet" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable capture of packet using AF_PACKET on Linux. If no device is
supplied, the list of devices from the af-packet section in the
yaml is used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-af-xdp">
<code class="descname">--af-xdp[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-af-xdp" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable capture of packet using AF_XDP on Linux. If no device is
supplied, the list of devices from the af-xdp section in the
yaml is used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-q">
<code class="descname">-q</code><code class="descclassname"> &lt;queue id&gt;</code><a class="headerlink" href="#cmdoption-q" title="Permalink to this definition">¶</a></dt>
<dd><p>Run inline of the NFQUEUE queue ID provided. May be provided
multiple times.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-s">
<code class="descname">-s</code><code class="descclassname"> &lt;filename.rules&gt;</code><a class="headerlink" href="#cmdoption-s" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -s option you can set a file with signatures, which will
be loaded together with the rules set in the yaml.</p>
<p>It is possible to use globbing when specifying rules files.
For example, <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">'/path/to/rules/*.rules'</span></code></p>
</dd></dl>

<dl class="option">
<dt id="id2">
<code class="descname">-S</code><code class="descclassname"> &lt;filename.rules&gt;</code><a class="headerlink" href="#id2" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -S option you can set a file with signatures, which will
be loaded exclusively, regardless of the rules set in the yaml.</p>
<p>It is possible to use globbing when specifying rules files.
For example, <code class="docutils literal notranslate"><span class="pre">-S</span> <span class="pre">'/path/to/rules/*.rules'</span></code></p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-l">
<code class="descname">-l</code><code class="descclassname"> &lt;directory&gt;</code><a class="headerlink" href="#cmdoption-l" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -l option you can set the default log directory. If you
already have the default-log-dir set in yaml, it will not be used
by Suricata if you use the -l option. It will use the log dir that
is set with the -l option. If you do not set a directory with
the -l option, Suricata will use the directory that is set in yaml.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-d">
<code class="descname">-D</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-d" title="Permalink to this definition">¶</a></dt>
<dd><p>Normally if you run Suricata on your console, it keeps your console
occupied. You can not use it for other purposes, and when you close
the window, Suricata stops running.  If you run Suricata as daemon
(using the -D option), it runs at the background and you will be
able to use the console for other tasks without disturbing the
engine running.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-runmode">
<code class="descname">--runmode</code><code class="descclassname"> &lt;runmode&gt;</code><a class="headerlink" href="#cmdoption-runmode" title="Permalink to this definition">¶</a></dt>
<dd><p>With the <em>--runmode</em> option you can set the runmode that you would
like to use. This command line option can override the yaml runmode
option.</p>
<p>Runmodes are: <em>workers</em>, <em>autofp</em> and <em>single</em>.</p>
<p>For more information about runmodes see <a class="reference internal" href="index.html#document-performance/runmodes"><span class="doc">Runmodes</span></a> in the user guide.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-f">
<code class="descname">-F</code><code class="descclassname"> &lt;bpf filter file&gt;</code><a class="headerlink" href="#cmdoption-f" title="Permalink to this definition">¶</a></dt>
<dd><p>Use BPF filter from file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-k">
<code class="descname">-k</code><code class="descclassname"> [all|none]</code><a class="headerlink" href="#cmdoption-k" title="Permalink to this definition">¶</a></dt>
<dd><p>Force (all) the checksum check or disable (none) all checksum
checks.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-user">
<code class="descname">--user</code><code class="descclassname">=&lt;user&gt;</code><a class="headerlink" href="#cmdoption-user" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the process user after initialization. Overrides the user
provided in the <em>run-as</em> section of the configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-group">
<code class="descname">--group</code><code class="descclassname">=&lt;group&gt;</code><a class="headerlink" href="#cmdoption-group" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the process group to group after initialization. Overrides the
group provided in the <em>run-as</em> section of the configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pidfile">
<code class="descname">--pidfile</code><code class="descclassname"> &lt;file&gt;</code><a class="headerlink" href="#cmdoption-pidfile" title="Permalink to this definition">¶</a></dt>
<dd><p>Write the process ID to file. Overrides the <em>pid-file</em> option in
the configuration file and forces the file to be written when not
running as a daemon.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-init-errors-fatal">
<code class="descname">--init-errors-fatal</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-init-errors-fatal" title="Permalink to this definition">¶</a></dt>
<dd><p>Exit with a failure when errors are encountered loading signatures.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-strict-rule-keywords">
<code class="descname">--strict-rule-keywords[</code><code class="descclassname">=all|&lt;keyword&gt;|&lt;keywords(csv)]</code><a class="headerlink" href="#cmdoption-strict-rule-keywords" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies to: classtype, reference and app-layer-event.</p>
<p>By default missing reference or classtype values are warnings and
not errors. Additionally, loading outdated app-layer-event events are
also not treated as errors, but as warnings instead.</p>
<p>If this option is enabled these warnings are considered errors.</p>
<p>If no value, or the value 'all', is specified, the option applies to
all of the keywords above. Alternatively, a comma separated list can
be supplied with the keyword names it should apply to.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-disable-detection">
<code class="descname">--disable-detection</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-disable-detection" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable the detection engine.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-disable-hashing">
<code class="descname">--disable-hashing</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-disable-hashing" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable support for hash algorithms such as md5, sha1 and sha256.</p>
<p>By default hashing is enabled. Disabling hashing will also disable some
Suricata features such as the filestore, ja3, and rule keywords that use hash
algorithms.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dump-config">
<code class="descname">--dump-config</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-dump-config" title="Permalink to this definition">¶</a></dt>
<dd><p>Dump the configuration loaded from the configuration file to the
terminal and exit.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dump-features">
<code class="descname">--dump-features</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-dump-features" title="Permalink to this definition">¶</a></dt>
<dd><p>Dump the features provided by Suricata modules and exit. Features
list (a subset of) the configuration values and are intended to
assist with comparing provided features with those required by
one or more rules.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-build-info">
<code class="descname">--build-info</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-build-info" title="Permalink to this definition">¶</a></dt>
<dd><p>Display the build information the Suricata was built with.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-app-layer-protos">
<code class="descname">--list-app-layer-protos</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-list-app-layer-protos" title="Permalink to this definition">¶</a></dt>
<dd><p>List all supported application layer protocols.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-keywords">
<code class="descname">--list-keywords</code><code class="descclassname">=[all|csv|&lt;kword&gt;]</code><a class="headerlink" href="#cmdoption-list-keywords" title="Permalink to this definition">¶</a></dt>
<dd><p>List all supported rule keywords.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-runmodes">
<code class="descname">--list-runmodes</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-list-runmodes" title="Permalink to this definition">¶</a></dt>
<dd><p>List all supported run modes.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-set">
<code class="descname">--set</code><code class="descclassname"> &lt;key&gt;=&lt;value&gt;</code><a class="headerlink" href="#cmdoption-set" title="Permalink to this definition">¶</a></dt>
<dd><p>Set a configuration value. Useful for overriding basic
configuration parameters. For example, to change the default log
directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="nb">set</span> <span class="n">default</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="nb">dir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span>
</pre></div>
</div>
<p>This option cannot be used to add new entries to a list in the
configuration file, such as a new output. It can only be used to
modify a value in a list that already exists.</p>
<p>For example, to disable the <code class="docutils literal notranslate"><span class="pre">eve-log</span></code> in the default
configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="nb">set</span> <span class="n">outputs</span><span class="mf">.1</span><span class="o">.</span><span class="n">eve</span><span class="o">-</span><span class="n">log</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">no</span>
</pre></div>
</div>
<p>Also note that the index values may change as the <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code>
is updated.</p>
<p>See the output of <code class="docutils literal notranslate"><span class="pre">--dump-config</span></code> for existing values that could
be modified with their index.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-engine-analysis">
<code class="descname">--engine-analysis</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-engine-analysis" title="Permalink to this definition">¶</a></dt>
<dd><p>Print reports on analysis of different sections in the engine and
exit. Please have a look at the conf parameter engine-analysis on
what reports can be printed</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-unix-socket">
<code class="descname">--unix-socket</code><code class="descclassname">=&lt;file&gt;</code><a class="headerlink" href="#cmdoption-unix-socket" title="Permalink to this definition">¶</a></dt>
<dd><p>Use file as the Suricata unix control socket. Overrides the
<em>filename</em> provided in the <em>unix-command</em> section of the
configuration file.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-reject-dev">
<code class="descname">--reject-dev</code><code class="descclassname">=&lt;device&gt;</code><a class="headerlink" href="#cmdoption-reject-dev" title="Permalink to this definition">¶</a></dt>
<dd><p>Use <em>device</em> to send out RST / ICMP error packets with
the <em>reject</em> keyword.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pcap-buffer-size">
<code class="descname">--pcap-buffer-size</code><code class="descclassname">=&lt;size&gt;</code><a class="headerlink" href="#cmdoption-pcap-buffer-size" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the size of the PCAP buffer (0 - 2147483647).</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-netmap">
<code class="descname">--netmap[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-netmap" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable capture of packet using NETMAP on FreeBSD or Linux. If no
device is supplied, the list of devices from the netmap section
in the yaml is used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pfring">
<code class="descname">--pfring[</code><code class="descclassname">=&lt;device&gt;]</code><a class="headerlink" href="#cmdoption-pfring" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable PF_RING packet capture. If no device provided, the devices in
the Suricata configuration will be used.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pfring-cluster-id">
<code class="descname">--pfring-cluster-id</code><code class="descclassname"> &lt;id&gt;</code><a class="headerlink" href="#cmdoption-pfring-cluster-id" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the PF_RING cluster ID.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-pfring-cluster-type">
<code class="descname">--pfring-cluster-type</code><code class="descclassname"> &lt;type&gt;</code><a class="headerlink" href="#cmdoption-pfring-cluster-type" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the PF_RING cluster type (cluster_round_robin, cluster_flow).</p>
</dd></dl>

<dl class="option">
<dt id="id3">
<code class="descname">-d</code><code class="descclassname"> &lt;divert-port&gt;</code><a class="headerlink" href="#id3" title="Permalink to this definition">¶</a></dt>
<dd><p>Run inline using IPFW divert mode.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dag">
<code class="descname">--dag</code><code class="descclassname"> &lt;device&gt;</code><a class="headerlink" href="#cmdoption-dag" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable packet capture off a DAG card. If capturing off a specific
stream the stream can be select using a device name like
&quot;dag0:4&quot;. This option may be provided multiple times read off
multiple devices and/or streams.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-napatech">
<code class="descname">--napatech</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-napatech" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable packet capture using the Napatech Streams API.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-erf-in">
<code class="descname">--erf-in</code><code class="descclassname">=&lt;file&gt;</code><a class="headerlink" href="#cmdoption-erf-in" title="Permalink to this definition">¶</a></dt>
<dd><p>Run in offline mode reading the specific ERF file (Endace
extensible record format).</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-simulate-ips">
<code class="descname">--simulate-ips</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-simulate-ips" title="Permalink to this definition">¶</a></dt>
<dd><p>Simulate IPS mode when running in a non-IPS mode.</p>
</dd></dl>

</div>
<div class="section" id="options-for-developers">
<h4>OPTIONS FOR DEVELOPERS<a class="headerlink" href="#options-for-developers" title="Permalink to this headline">¶</a></h4>
<dl class="option">
<dt id="cmdoption-u">
<code class="descname">-u</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-u" title="Permalink to this definition">¶</a></dt>
<dd><p>Run the unit tests and exit. Requires that Suricata be configured
with <em>--enable-unittests</em>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-unittest-filter">
<code class="descname">-U</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">--unittest-filter</code><code class="descclassname">=REGEX</code><a class="headerlink" href="#cmdoption-unittest-filter" title="Permalink to this definition">¶</a></dt>
<dd><p>With the -U option you can select which of the unit tests you want
to run. This option uses REGEX. Example of use: suricata -u -U
http</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-list-unittests">
<code class="descname">--list-unittests</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-list-unittests" title="Permalink to this definition">¶</a></dt>
<dd><p>Lists available unit tests.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-fatal-unittests">
<code class="descname">--fatal-unittests</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-fatal-unittests" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables fatal failure on a unit test error. Suricata will exit
instead of continuing more tests.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-unittests-coverage">
<code class="descname">--unittests-coverage</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-unittests-coverage" title="Permalink to this definition">¶</a></dt>
<dd><p>Display unit test coverage report.</p>
</dd></dl>

</div>
<div class="section" id="signals">
<h4>SIGNALS<a class="headerlink" href="#signals" title="Permalink to this headline">¶</a></h4>
<p>Suricata will respond to the following signals:</p>
<p>SIGUSR2</p>
<blockquote>
<div>Causes Suricata to perform a live rule reload.</div></blockquote>
<p>SIGHUP</p>
<blockquote>
<div>Causes Suricata to close and re-open all log files. This can be
used to re-open log files after they may have been moved away by
log rotation utilities.</div></blockquote>
</div>
<div class="section" id="files-and-directories">
<h4>FILES AND DIRECTORIES<a class="headerlink" href="#files-and-directories" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt>/etc/suricata/suricata.yaml</dt>
<dd>Default location of the Suricata configuration file.</dd>
<dt>/var/log/suricata</dt>
<dd>Default Suricata log directory.</dd>
</dl>
</div>
<div class="section" id="examples">
<h4>EXAMPLES<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<p>To capture live traffic from interface <cite>eno1</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">i</span> <span class="n">eno1</span>
</pre></div>
</div>
<p>To analyze a pcap file and output logs to the CWD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">capture</span><span class="o">.</span><span class="n">pcap</span>
</pre></div>
</div>
<p>To capture using <cite>AF_PACKET</cite> and override the flow memcap setting from the <cite>suricata.yaml</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">--</span><span class="n">af</span><span class="o">-</span><span class="n">packet</span> <span class="o">--</span><span class="nb">set</span> <span class="n">flow</span><span class="o">.</span><span class="n">memcap</span><span class="o">=</span><span class="mi">1</span><span class="n">gb</span>
</pre></div>
</div>
<p>To analyze a pcap file with a custom rule file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">pcap</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">capture</span><span class="o">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">S</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">custom</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
</div>
<div class="section" id="bugs">
<h4>BUGS<a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h4>
<p>Please visit Suricata's support page for information about submitting
bugs or feature requests.</p>
</div>
<div class="section" id="notes">
<h4>NOTES<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Suricata Home Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/">https://suricata.io/</a></p>
</div></blockquote>
</li>
<li><p class="first">Suricata Support Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/support/">https://suricata.io/support/</a></p>
</div></blockquote>
</li>
</ul>
</div>
</div>
<span id="document-manpages/suricatasc"></span><div class="section" id="suricata-socket-control">
<h3>Suricata Socket Control<a class="headerlink" href="#suricata-socket-control" title="Permalink to this headline">¶</a></h3>
<div class="section" id="synopsis">
<h4>SYNOPSIS<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h4>
<p><strong>suricatasc</strong></p>
</div>
<div class="section" id="description">
<h4>DESCRIPTION<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>Suricata socket control tool</p>
</div>
<div class="section" id="commands">
<h4>COMMANDS<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h4>
<dl class="describe">
<dt>
<code class="descname">shutdown</code></dt>
<dd><p>Shut Suricata instance down.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">command-list</code></dt>
<dd><p>List available commands.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">help</code></dt>
<dd><p>Get help about the available commands.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">version</code></dt>
<dd><p>Print the version of Suricata instance.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">uptime</code></dt>
<dd><p>Display the uptime of Suricata.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">running-mode</code></dt>
<dd><p>Display running mode. This can either be <em>workers</em>, <em>autofp</em> or <em>single</em>.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">capture-mode</code></dt>
<dd><p>Display the capture mode. This can be either of <em>PCAP_DEV</em>,
<em>PCAP_FILE</em>, <em>PFRING(DISABLED)</em>, <em>NFQ</em>, <em>NFLOG</em>, <em>IPFW</em>, <em>ERF_FILE</em>,
<em>ERF_DAG</em>, <em>AF_PACKET_DEV</em>, <em>NETMAP(DISABLED)</em>, <em>UNIX_SOCKET</em> or
<em>WINDIVERT(DISABLED)</em>.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">conf-get &lt;variable&gt;</code></dt>
<dd><p>Get configuration value for a given variable. Variable to be provided can be
either of the configuration parameters that are written in suricata.yaml.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">dump-counters</code></dt>
<dd><p>Dump Suricata's performance counters.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">ruleset-reload-rules</code></dt>
<dd><p>Reload the ruleset and wait for completion.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">reload-rules</code></dt>
<dd><p>Alias .. describe <em>ruleset-reload-rules</em>.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">ruleset-reload-nonblocking</code></dt>
<dd><p>Reload ruleset and proceed without waiting.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">ruleset-reload-time</code></dt>
<dd><p>Return time of last reload.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">ruleset-stats</code></dt>
<dd><p>Display the number of rules loaded and failed.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">ruleset-failed-rules</code></dt>
<dd><p>Display the list of failed rules.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">register-tenant-handler &lt;id&gt; &lt;htype&gt; [hargs]</code></dt>
<dd><p>Register a tenant handler with the specified mapping.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">unregister-tenant-handler &lt;id&gt; &lt;htype&gt; [hargs]</code></dt>
<dd><p>Unregister a tenant handler with the specified mapping.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">register-tenant &lt;id&gt; &lt;filename&gt;</code></dt>
<dd><p>Register tenant with a particular ID and filename.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">reload-tenant &lt;id&gt; [filename]</code></dt>
<dd><p>Reload a tenant with specified ID. A filename to a tenant yaml can be
specified. If it is omitted, the original yaml that was used to load
/ last reload the tenant is used.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">reload-tenants</code></dt>
<dd><p>Reload all registered tenants by reloading their yaml.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">unregister-tenant &lt;id&gt;</code></dt>
<dd><p>Unregister tenant with a particular ID.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">add-hostbit &lt;ipaddress&gt; &lt;hostbit&gt; &lt;expire&gt;</code></dt>
<dd><p>Add hostbit on a host IP with a particular bit name and time of expiry.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">remove-hostbit &lt;ipaddress&gt; &lt;hostbit&gt;</code></dt>
<dd><p>Remove hostbit on a host IP with specified IP address and bit name.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">list-hostbit &lt;ipaddress&gt;</code></dt>
<dd><p>List hostbit for a particular host IP.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">reopen-log-files</code></dt>
<dd><p>Reopen log files to be run after external log rotation.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">memcap-set &lt;config&gt; &lt;memcap&gt;</code></dt>
<dd><p>Update memcap value of a specified item.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">memcap-show &lt;config&gt;</code></dt>
<dd><p>Show memcap value of a specified item.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">memcap-list</code></dt>
<dd><p>List all memcap values available.</p>
</dd></dl>

</div>
<div class="section" id="pcap-mode-commands">
<h4>PCAP MODE COMMANDS<a class="headerlink" href="#pcap-mode-commands" title="Permalink to this headline">¶</a></h4>
<dl class="describe">
<dt>
<code class="descname">pcap-file &lt;file&gt; &lt;dir&gt; [tenant] [continuous] [delete-when-done]</code></dt>
<dd><p>Add pcap files to Suricata for sequential processing. The generated
log/alert files will be put into the directory specified as second argument.
Make sure to provide absolute path to the files and directory. It is
acceptable to add multiple files without waiting the result.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">pcap-file-continuous &lt;file&gt; &lt;dir&gt; [tenant] [delete-when-done]</code></dt>
<dd><p>Add pcap files to Suricata for sequential processing. Directory will be
monitored for new files being added until there is a use of
<strong>pcap-interrupt</strong> or directory is moved or deleted.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">pcap-file-number</code></dt>
<dd><p>Number of pcap files waiting to get processed.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">pcap-file-list</code></dt>
<dd><p>List of queued pcap files.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">pcap-last-processed</code></dt>
<dd><p>Processed time of last file in milliseconds since epoch.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">pcap-interrupt</code></dt>
<dd><p>Terminate the current state by interrupting directory processing.</p>
</dd></dl>

<dl class="describe">
<dt>
<code class="descname">pcap-current</code></dt>
<dd><p>Currently processed file.</p>
</dd></dl>

</div>
<div class="section" id="bugs">
<h4>BUGS<a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h4>
<p>Please visit Suricata's support page for information about submitting
bugs or feature requests.</p>
</div>
<div class="section" id="notes">
<h4>NOTES<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Suricata Home Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/">https://suricata.io/</a></p>
</div></blockquote>
</li>
<li><p class="first">Suricata Support Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/support/">https://suricata.io/support/</a></p>
</div></blockquote>
</li>
</ul>
</div>
</div>
<span id="document-manpages/suricatactl"></span><div class="section" id="suricata-control">
<h3>Suricata Control<a class="headerlink" href="#suricata-control" title="Permalink to this headline">¶</a></h3>
<div class="section" id="synopsis">
<h4>SYNOPSIS<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h4>
<p><strong>suricatactl</strong> [-h] &lt;command&gt; [&lt;args&gt;]</p>
</div>
<div class="section" id="description">
<h4>DESCRIPTION<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>This tool helps control Suricata's features.</p>
</div>
<div class="section" id="options">
<h4>OPTIONS<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h4>
<dl class="option">
<dt id="cmdoption-h">
<code class="descname">-h</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-h" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Get help about the available commands.</p>
</div>
<div class="section" id="commands">
<h4>COMMANDS<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h4>
<p><em class="manpage">suricatactl-filestore(1)</em></p>
</div>
<div class="section" id="bugs">
<h4>BUGS<a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h4>
<p>Please visit Suricata's support page for information about submitting
bugs or feature requests.</p>
</div>
<div class="section" id="notes">
<h4>NOTES<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Suricata Home Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/">https://suricata.io/</a></p>
</div></blockquote>
</li>
<li><p class="first">Suricata Support Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/support/">https://suricata.io/support/</a></p>
</div></blockquote>
</li>
</ul>
</div>
</div>
<span id="document-manpages/suricatactl-filestore"></span><div class="section" id="suricata-control-filestore">
<h3>Suricata Control Filestore<a class="headerlink" href="#suricata-control-filestore" title="Permalink to this headline">¶</a></h3>
<div class="section" id="synopsis">
<h4>SYNOPSIS<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h4>
<p><strong>suricatactl filestore</strong> [-h] &lt;command&gt; [&lt;args&gt;]</p>
</div>
<div class="section" id="description">
<h4>DESCRIPTION<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>This command lets you perform certain operations on Suricata filestore.</p>
</div>
<div class="section" id="options">
<h4>OPTIONS<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h4>
<dl class="option">
<dt id="cmdoption-h">
<code class="descname">-h</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-h" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Get help about the available commands.</p>
</div>
<div class="section" id="commands">
<h4>COMMANDS<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h4>
<p><strong>prune [-h|--help] [-n|--dry-run] [-v|verbose] [-q|--quiet] -d &lt;DIRECTORY&gt;
--age &lt;AGE&gt;</strong></p>
<p>Prune files older than a given age.</p>
<p>-d &lt;DIRECTORY&gt; | --directory &lt;DIRECTORY&gt; is a required argument which tells
that user must provide the suricata filestore directory on which all the
specified operations are to be performed.</p>
<p>--age &lt;AGE&gt; is a required argument asking the age of the files. Files older
than the age mentioned with this option shall be pruned.</p>
<p>-h | --help is an optional argument with which you can ask for help about the
command usage.</p>
<p>-n | --dry-run is an optional argument which makes the utility print only what
would happen</p>
<p>-v | --verbose is an optional argument to increase the verbosity of command.</p>
<p>-q | --quiet is an optional argument that helps log errors and warnings only
and keep silent about everything else.</p>
</div>
<div class="section" id="bugs">
<h4>BUGS<a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h4>
<p>Please visit Suricata's support page for information about submitting
bugs or feature requests.</p>
</div>
<div class="section" id="notes">
<h4>NOTES<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Suricata Home Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/">https://suricata.io/</a></p>
</div></blockquote>
</li>
<li><p class="first">Suricata Support Page</p>
<blockquote>
<div><p><a class="reference external" href="https://suricata.io/support/">https://suricata.io/support/</a></p>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-acknowledgements"></span><div class="section" id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">¶</a></h2>
<p>Thank you to the following for their Wiki and documentation
contributions that have made this user guide possible:</p>
<ul class="simple">
<li>Andreas Herz</li>
<li>Andreas Moe</li>
<li>Anne-Fleur Koolstra</li>
<li>Christophe Vandeplas</li>
<li>Darren Spruell</li>
<li>David Cannings</li>
<li>David Diallo</li>
<li>David Wharton</li>
<li>Eric Leblond</li>
<li>god lol</li>
<li>Haris Haq</li>
<li>Ignacio Sanchez</li>
<li>Jason Ish</li>
<li>Jason Taylor</li>
<li>Josh Smith</li>
<li>Juliana Fajardini</li>
<li>Ken Steele</li>
<li>Les Syv</li>
<li>Lukas Sismis</li>
<li>Mark Solaris</li>
<li>Martin Holste</li>
<li>Mats Klepsland</li>
<li>Matt Jonkman</li>
<li>Michael Bentley</li>
<li>Michael Hrishenko</li>
<li>Nathan Jimerson</li>
<li>Nicolas Merle</li>
<li>Peter Manev</li>
<li>Philipp Buehler</li>
<li>Philippe Antoine</li>
<li>Ralph Broenink</li>
<li>Rob MacGregor</li>
<li>Russel Fulton</li>
<li>Shivani Bhardwaj</li>
<li>Victor Julien</li>
<li>Vincent Fang</li>
<li>Zach Rasmor</li>
</ul>
</div>
<span id="document-licenses/index"></span><div class="section" id="licenses">
<h2>Licenses<a class="headerlink" href="#licenses" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-licenses/gnu-gpl-v2.0"></span><div class="section" id="gnu-general-public-license">
<h3>GNU General Public License<a class="headerlink" href="#gnu-general-public-license" title="Permalink to this headline">¶</a></h3>
<p><em>Version 2, June 1991</em>
<em>Copyright © 1989, 1991 Free Software Foundation, Inc.</em>
<em>51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</em></p>
<p>Everyone is permitted to copy and distribute verbatim copies
of this license document, but changing it is not allowed.</p>
<div class="section" id="preamble">
<h4>Preamble<a class="headerlink" href="#preamble" title="Permalink to this headline">¶</a></h4>
<p>The licenses for most software are designed to take away your
freedom to share and change it.  By contrast, the GNU General Public
License is intended to guarantee your freedom to share and change free
software--to make sure the software is free for all its users.  This
General Public License applies to most of the Free Software
Foundation's software and to any other program whose authors commit to
using it.  (Some other Free Software Foundation software is covered by
the GNU Lesser General Public License instead.)  You can apply it to
your programs, too.</p>
<p>When we speak of free software, we are referring to freedom, not
price.  Our General Public Licenses are designed to make sure that you
have the freedom to distribute copies of free software (and charge for
this service if you wish), that you receive source code or can get it
if you want it, that you can change the software or use pieces of it
in new free programs; and that you know you can do these things.</p>
<p>To protect your rights, we need to make restrictions that forbid
anyone to deny you these rights or to ask you to surrender the rights.
These restrictions translate to certain responsibilities for you if you
distribute copies of the software, or if you modify it.</p>
<p>For example, if you distribute copies of such a program, whether
gratis or for a fee, you must give the recipients all the rights that
you have.  You must make sure that they, too, receive or can get the
source code.  And you must show them these terms so they know their
rights.</p>
<p>We protect your rights with two steps: <strong>(1)</strong> copyright the software, and
<strong>(2)</strong> offer you this license which gives you legal permission to copy,
distribute and/or modify the software.</p>
<p>Also, for each author's protection and ours, we want to make certain
that everyone understands that there is no warranty for this free
software.  If the software is modified by someone else and passed on, we
want its recipients to know that what they have is not the original, so
that any problems introduced by others will not reflect on the original
authors' reputations.</p>
<p>Finally, any free program is threatened constantly by software
patents.  We wish to avoid the danger that redistributors of a free
program will individually obtain patent licenses, in effect making the
program proprietary.  To prevent this, we have made it clear that any
patent must be licensed for everyone's free use or not licensed at all.</p>
<p>The precise terms and conditions for copying, distribution and
modification follow.</p>
</div>
<div class="section" id="terms-and-conditions-for-copying-distribution-and-modification">
<h4>TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION<a class="headerlink" href="#terms-and-conditions-for-copying-distribution-and-modification" title="Permalink to this headline">¶</a></h4>
<p><strong>0.</strong> This License applies to any program or other work which contains
a notice placed by the copyright holder saying it may be distributed
under the terms of this General Public License.  The &quot;Program&quot;, below,
refers to any such program or work, and a &quot;work based on the Program&quot;
means either the Program or any derivative work under copyright law:
that is to say, a work containing the Program or a portion of it,
either verbatim or with modifications and/or translated into another
language.  (Hereinafter, translation is included without limitation in
the term &quot;modification&quot;.)  Each licensee is addressed as &quot;you&quot;.</p>
<p>Activities other than copying, distribution and modification are not
covered by this License; they are outside its scope.  The act of
running the Program is not restricted, and the output from the Program
is covered only if its contents constitute a work based on the
Program (independent of having been made by running the Program).
Whether that is true depends on what the Program does.</p>
<p><strong>1.</strong> You may copy and distribute verbatim copies of the Program's
source code as you receive it, in any medium, provided that you
conspicuously and appropriately publish on each copy an appropriate
copyright notice and disclaimer of warranty; keep intact all the
notices that refer to this License and to the absence of any warranty;
and give any other recipients of the Program a copy of this License
along with the Program.</p>
<p>You may charge a fee for the physical act of transferring a copy, and
you may at your option offer warranty protection in exchange for a fee.</p>
<p><strong>2.</strong> You may modify your copy or copies of the Program or any portion
of it, thus forming a work based on the Program, and copy and
distribute such modifications or work under the terms of Section 1
above, provided that you also meet all of these conditions:</p>
<ul class="simple">
<li><strong>a)</strong> You must cause the modified files to carry prominent notices
stating that you changed the files and the date of any change.</li>
<li><strong>b)</strong> You must cause any work that you distribute or publish, that in
whole or in part contains or is derived from the Program or any
part thereof, to be licensed as a whole at no charge to all third
parties under the terms of this License.</li>
<li><strong>c)</strong> If the modified program normally reads commands interactively
when run, you must cause it, when started running for such
interactive use in the most ordinary way, to print or display an
announcement including an appropriate copyright notice and a
notice that there is no warranty (or else, saying that you provide
a warranty) and that users may redistribute the program under
these conditions, and telling the user how to view a copy of this
License.  (Exception: if the Program itself is interactive but
does not normally print such an announcement, your work based on
the Program is not required to print an announcement.)</li>
</ul>
<p>These requirements apply to the modified work as a whole.  If
identifiable sections of that work are not derived from the Program,
and can be reasonably considered independent and separate works in
themselves, then this License, and its terms, do not apply to those
sections when you distribute them as separate works.  But when you
distribute the same sections as part of a whole which is a work based
on the Program, the distribution of the whole must be on the terms of
this License, whose permissions for other licensees extend to the
entire whole, and thus to each and every part regardless of who wrote it.</p>
<p>Thus, it is not the intent of this section to claim rights or contest
your rights to work written entirely by you; rather, the intent is to
exercise the right to control the distribution of derivative or
collective works based on the Program.</p>
<p>In addition, mere aggregation of another work not based on the Program
with the Program (or with a work based on the Program) on a volume of
a storage or distribution medium does not bring the other work under
the scope of this License.</p>
<p><strong>3.</strong> You may copy and distribute the Program (or a work based on it,
under Section 2) in object code or executable form under the terms of
Sections 1 and 2 above provided that you also do one of the following:</p>
<ul class="simple">
<li><strong>a)</strong> Accompany it with the complete corresponding machine-readable
source code, which must be distributed under the terms of Sections
1 and 2 above on a medium customarily used for software interchange; or,</li>
<li><strong>b)</strong> Accompany it with a written offer, valid for at least three
years, to give any third party, for a charge no more than your
cost of physically performing source distribution, a complete
machine-readable copy of the corresponding source code, to be
distributed under the terms of Sections 1 and 2 above on a medium
customarily used for software interchange; or,</li>
<li><strong>c)</strong> Accompany it with the information you received as to the offer
to distribute corresponding source code.  (This alternative is
allowed only for noncommercial distribution and only if you
received the program in object code or executable form with such
an offer, in accord with Subsection b above.)</li>
</ul>
<p>The source code for a work means the preferred form of the work for
making modifications to it.  For an executable work, complete source
code means all the source code for all modules it contains, plus any
associated interface definition files, plus the scripts used to
control compilation and installation of the executable.  However, as a
special exception, the source code distributed need not include
anything that is normally distributed (in either source or binary
form) with the major components (compiler, kernel, and so on) of the
operating system on which the executable runs, unless that component
itself accompanies the executable.</p>
<p>If distribution of executable or object code is made by offering
access to copy from a designated place, then offering equivalent
access to copy the source code from the same place counts as
distribution of the source code, even though third parties are not
compelled to copy the source along with the object code.</p>
<p><strong>4.</strong> You may not copy, modify, sublicense, or distribute the Program
except as expressly provided under this License.  Any attempt
otherwise to copy, modify, sublicense or distribute the Program is
void, and will automatically terminate your rights under this License.
However, parties who have received copies, or rights, from you under
this License will not have their licenses terminated so long as such
parties remain in full compliance.</p>
<p><strong>5.</strong> You are not required to accept this License, since you have not
signed it.  However, nothing else grants you permission to modify or
distribute the Program or its derivative works.  These actions are
prohibited by law if you do not accept this License.  Therefore, by
modifying or distributing the Program (or any work based on the
Program), you indicate your acceptance of this License to do so, and
all its terms and conditions for copying, distributing or modifying
the Program or works based on it.</p>
<p><strong>6.</strong> Each time you redistribute the Program (or any work based on the
Program), the recipient automatically receives a license from the
original licensor to copy, distribute or modify the Program subject to
these terms and conditions.  You may not impose any further
restrictions on the recipients' exercise of the rights granted herein.
You are not responsible for enforcing compliance by third parties to
this License.</p>
<p><strong>7.</strong> If, as a consequence of a court judgment or allegation of patent
infringement or for any other reason (not limited to patent issues),
conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot
distribute so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you
may not distribute the Program at all.  For example, if a patent
license would not permit royalty-free redistribution of the Program by
all those who receive copies directly or indirectly through you, then
the only way you could satisfy both it and this License would be to
refrain entirely from distribution of the Program.</p>
<p>If any portion of this section is held invalid or unenforceable under
any particular circumstance, the balance of the section is intended to
apply and the section as a whole is intended to apply in other
circumstances.</p>
<p>It is not the purpose of this section to induce you to infringe any
patents or other property right claims or to contest validity of any
such claims; this section has the sole purpose of protecting the
integrity of the free software distribution system, which is
implemented by public license practices.  Many people have made
generous contributions to the wide range of software distributed
through that system in reliance on consistent application of that
system; it is up to the author/donor to decide if he or she is willing
to distribute software through any other system and a licensee cannot
impose that choice.</p>
<p>This section is intended to make thoroughly clear what is believed to
be a consequence of the rest of this License.</p>
<p><strong>8.</strong> If the distribution and/or use of the Program is restricted in
certain countries either by patents or by copyrighted interfaces, the
original copyright holder who places the Program under this License
may add an explicit geographical distribution limitation excluding
those countries, so that distribution is permitted only in or among
countries not thus excluded.  In such case, this License incorporates
the limitation as if written in the body of this License.</p>
<p><strong>9.</strong> The Free Software Foundation may publish revised and/or new versions
of the General Public License from time to time.  Such new versions will
be similar in spirit to the present version, but may differ in detail to
address new problems or concerns.</p>
<p>Each version is given a distinguishing version number.  If the Program
specifies a version number of this License which applies to it and &quot;any
later version&quot;, you have the option of following the terms and conditions
either of that version or of any later version published by the Free
Software Foundation.  If the Program does not specify a version number of
this License, you may choose any version ever published by the Free Software
Foundation.</p>
<p><strong>10.</strong> If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author
to ask for permission.  For software which is copyrighted by the Free
Software Foundation, write to the Free Software Foundation; we sometimes
make exceptions for this.  Our decision will be guided by the two goals
of preserving the free status of all derivatives of our free software and
of promoting the sharing and reuse of software generally.</p>
</div>
<div class="section" id="no-warranty">
<h4>NO WARRANTY<a class="headerlink" href="#no-warranty" title="Permalink to this headline">¶</a></h4>
<p><strong>11.</strong> BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
PROVIDE THE PROGRAM &quot;AS IS&quot; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
REPAIR OR CORRECTION.</p>
<p><strong>12.</strong> IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.</p>
<p><em>END OF TERMS AND CONDITIONS</em></p>
</div>
<div class="section" id="how-to-apply-these-terms-to-your-new-programs">
<h4>How to Apply These Terms to Your New Programs<a class="headerlink" href="#how-to-apply-these-terms-to-your-new-programs" title="Permalink to this headline">¶</a></h4>
<p>If you develop a new program, and you want it to be of the greatest
possible use to the public, the best way to achieve this is to make it
free software which everyone can redistribute and change under these terms.</p>
<p>To do so, attach the following notices to the program.  It is safest
to attach them to the start of each source file to most effectively
convey the exclusion of warranty; and each file should have at least
the &quot;copyright&quot; line and a pointer to where the full notice is found.</p>
<blockquote>
<div><p>&lt;one line to give the program's name and a brief idea of what it does.&gt;
Copyright (C) &lt;year&gt;  &lt;name of author&gt;</p>
<p>This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along
with this program; if not, write to the Free Software Foundation, Inc.,
51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</p>
</div></blockquote>
<p>Also add information on how to contact you by electronic and paper mail.</p>
<p>If the program is interactive, make it output a short notice like this
when it starts in an interactive mode:</p>
<blockquote>
<div>Gnomovision version 69, Copyright (C) year name of author
Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
This is free software, and you are welcome to redistribute it
under certain conditions; type `show c' for details.</div></blockquote>
<p>The hypothetical commands `show w` and `show c` should show the appropriate
parts of the General Public License.  Of course, the commands you use may
be called something other than `show w' and `show c`; they could even be
mouse-clicks or menu items--whatever suits your program.</p>
<p>You should also get your employer (if you work as a programmer) or your
school, if any, to sign a &quot;copyright disclaimer&quot; for the program, if
necessary.  Here is a sample; alter the names:</p>
<blockquote>
<div><p>Yoyodyne, Inc., hereby disclaims all copyright interest in the program
`Gnomovision' (which makes passes at compilers) written by James Hacker.</p>
<p>&lt;signature of Ty Coon&gt;, 1 April 1989
Ty Coon, President of Vice</p>
</div></blockquote>
<p>This General Public License does not permit incorporating your program into
proprietary programs.  If your program is a subroutine library, you may
consider it more useful to permit linking proprietary applications with the
library.  If this is what you want to do, use the GNU Lesser General
Public License instead of this License.</p>
</div>
</div>
<span id="document-licenses/cc-nc-4.0"></span><div class="section" id="creative-commons-attribution-noncommercial-4-0-international-public-license">
<h3>Creative Commons Attribution-NonCommercial 4.0 International Public License<a class="headerlink" href="#creative-commons-attribution-noncommercial-4-0-international-public-license" title="Permalink to this headline">¶</a></h3>
<p>By exercising the Licensed Rights (defined below), You accept and agree to be bound by the terms and conditions of this Creative Commons Attribution-NonCommercial 4.0 International Public License (&quot;Public License&quot;). To the extent this Public License may be interpreted as a contract, You are granted the Licensed Rights in consideration of Your acceptance of these terms and conditions, and the Licensor grants You such rights in consideration of benefits the Licensor receives from making the Licensed Material available under these terms and conditions.</p>
<div class="section" id="section-1-definitions">
<h4>Section 1 – Definitions.<a class="headerlink" href="#section-1-definitions" title="Permalink to this headline">¶</a></h4>
<ol class="loweralpha simple">
<li><strong>Adapted Material</strong> means material subject to Copyright and Similar Rights that is derived from or based upon the Licensed Material and in which the Licensed Material is translated, altered, arranged, transformed, or otherwise modified in a manner requiring permission under the Copyright and Similar Rights held by the Licensor. For purposes of this Public License, where the Licensed Material is a musical work, performance, or sound recording, Adapted Material is always produced where the Licensed Material is synched in timed relation with a moving image.</li>
<li><strong>Adapter's License</strong> means the license You apply to Your Copyright and Similar Rights in Your contributions to Adapted Material in accordance with the terms and conditions of this Public License.</li>
<li><strong>Copyright and Similar Rights</strong> means copyright and/or similar rights closely related to copyright including, without limitation, performance, broadcast, sound recording, and Sui Generis Database Rights, without regard to how the rights are labeled or categorized. For purposes of this Public License, the rights specified in Section 2(b)(1)-(2) are not Copyright and Similar Rights.</li>
<li><strong>Effective Technological Measures</strong> means those measures that, in the absence of proper authority, may not be circumvented under laws fulfilling obligations under Article 11 of the WIPO Copyright Treaty adopted on December 20, 1996, and/or similar international agreements.</li>
<li><strong>Exceptions and Limitations</strong> means fair use, fair dealing, and/or any other exception or limitation to Copyright and Similar Rights that applies to Your use of the Licensed Material.</li>
<li><strong>Licensed Material</strong> means the artistic or literary work, database, or other material to which the Licensor applied this Public License.</li>
<li><strong>Licensed Rights</strong> means the rights granted to You subject to the terms and conditions of this Public License, which are limited to all Copyright and Similar Rights that apply to Your use of the Licensed Material and that the Licensor has authority to license.</li>
<li><strong>Licensor</strong> means the individual(s) or entity(ies) granting rights under this Public License.</li>
<li><strong>NonCommercial</strong> means not primarily intended for or directed towards commercial advantage or monetary compensation. For purposes of this Public License, the exchange of the Licensed Material for other material subject to Copyright and Similar Rights by digital file-sharing or similar means is NonCommercial provided there is no payment of monetary compensation in connection with the exchange.</li>
<li><strong>Share</strong> means to provide material to the public by any means or process that requires permission under the Licensed Rights, such as reproduction, public display, public performance, distribution, dissemination, communication, or importation, and to make material available to the public including in ways that members of the public may access the material from a place and at a time individually chosen by them.</li>
<li><strong>Sui Generis Database Rights</strong> means rights other than copyright resulting from Directive 96/9/EC of the European Parliament and of the Council of 11 March 1996 on the legal protection of databases, as amended and/or succeeded, as well as other essentially equivalent rights anywhere in the world.</li>
<li><strong>You</strong> means the individual or entity exercising the Licensed Rights under this Public License. Your has a corresponding meaning.</li>
</ol>
</div>
<div class="section" id="section-2-scope">
<h4>Section 2 – Scope.<a class="headerlink" href="#section-2-scope" title="Permalink to this headline">¶</a></h4>
<ol class="loweralpha simple">
<li><strong>License grant.</strong></li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>Subject to the terms and conditions of this Public License, the Licensor hereby grants You a worldwide, royalty-free, non-sublicensable, non-exclusive, irrevocable license to exercise the Licensed Rights in the Licensed Material to:</li>
</ol>
<blockquote>
<div><ol class="upperalpha simple">
<li>reproduce and Share the Licensed Material, in whole or in part, for NonCommercial purposes only; and</li>
<li>produce, reproduce, and Share Adapted Material for NonCommercial purposes only.</li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><strong>Exceptions and Limitations.</strong> For the avoidance of doubt, where Exceptions and Limitations apply to Your use, this Public License does not apply, and You do not need to comply with its terms and conditions.</li>
<li><strong>Term.</strong> The term of this Public License is specified in Section 6(a).</li>
<li><strong>Media and formats; technical modifications allowed.</strong> The Licensor authorizes You to exercise the Licensed Rights in all media and formats whether now known or hereafter created, and to make technical modifications necessary to do so. The Licensor waives and/or agrees not to assert any right or authority to forbid You from making technical modifications necessary to exercise the Licensed Rights, including technical modifications necessary to circumvent Effective Technological Measures. For purposes of this Public License, simply making modifications authorized by this Section 2(a)(4) never produces Adapted Material.</li>
<li><strong>Downstream recipients.</strong></li>
</ol>
<blockquote>
<div><ol class="upperalpha simple">
<li><strong>Offer from the Licensor – Licensed Material.</strong> Every recipient of the Licensed Material automatically receives an offer from the Licensor to exercise the Licensed Rights under the terms and conditions of this Public License.</li>
<li><strong>No downstream restrictions.</strong> You may not offer or impose any additional or different terms or conditions on, or apply any Effective Technological Measures to, the Licensed Material if doing so restricts exercise of the Licensed Rights by any recipient of the Licensed Material.</li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="6">
<li><strong>No endorsement.</strong> Nothing in this Public License constitutes or may be construed as permission to assert or imply that You are, or that Your use of the Licensed Material is, connected with, or sponsored, endorsed, or granted official status by, the Licensor or others designated to receive attribution as provided in Section 3(a)(1)(A)(i).</li>
</ol>
</div></blockquote>
<ol class="loweralpha simple" start="2">
<li><strong>Other rights.</strong></li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>Moral rights, such as the right of integrity, are not licensed under this Public License, nor are publicity, privacy, and/or other similar personality rights; however, to the extent possible, the Licensor waives and/or agrees not to assert any such rights held by the Licensor to the limited extent necessary to allow You to exercise the Licensed Rights, but not otherwise.</li>
<li>Patent and trademark rights are not licensed under this Public License.</li>
<li>To the extent possible, the Licensor waives any right to collect royalties from You for the exercise of the Licensed Rights, whether directly or through a collecting society under any voluntary or waivable statutory or compulsory licensing scheme. In all other cases the Licensor expressly reserves any right to collect such royalties, including when the Licensed Material is used other than for NonCommercial purposes.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="section-3-license-conditions">
<h4>Section 3 – License Conditions.<a class="headerlink" href="#section-3-license-conditions" title="Permalink to this headline">¶</a></h4>
<p>Your exercise of the Licensed Rights is expressly made subject to the following conditions.</p>
<ol class="loweralpha simple">
<li><strong>Attribution.</strong></li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>If You Share the Licensed Material (including in modified form), You must:</li>
</ol>
<blockquote>
<div><ol class="upperalpha simple">
<li>retain the following if it is supplied by the Licensor with the Licensed Material:</li>
</ol>
<blockquote>
<div><ol class="lowerroman simple">
<li>identification of the creator(s) of the Licensed Material and any others designated to receive attribution, in any reasonable manner requested by the Licensor (including by pseudonym if designated);</li>
<li>a copyright notice;</li>
<li>a notice that refers to this Public License;</li>
<li>a notice that refers to the disclaimer of warranties;</li>
<li>a URI or hyperlink to the Licensed Material to the extent reasonably practicable;</li>
</ol>
</div></blockquote>
<ol class="upperalpha simple" start="2">
<li>indicate if You modified the Licensed Material and retain an indication of any previous modifications; and</li>
<li>indicate the Licensed Material is licensed under this Public License, and include the text of, or the URI or hyperlink to, this Public License.</li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>You may satisfy the conditions in Section 3(a)(1) in any reasonable manner based on the medium, means, and context in which You Share the Licensed Material. For example, it may be reasonable to satisfy the conditions by providing a URI or hyperlink to a resource that includes the required information.</li>
<li>If requested by the Licensor, You must remove any of the information required by Section 3(a)(1)(A) to the extent reasonably practicable.</li>
<li>If You Share Adapted Material You produce, the Adapter's License You apply must not prevent recipients of the Adapted Material from complying with this Public License.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="section-4-sui-generis-database-rights">
<h4>Section 4 – Sui Generis Database Rights.<a class="headerlink" href="#section-4-sui-generis-database-rights" title="Permalink to this headline">¶</a></h4>
<p>Where the Licensed Rights include Sui Generis Database Rights that apply to Your use of the Licensed Material:</p>
<ol class="loweralpha simple">
<li>for the avoidance of doubt, Section 2(a)(1) grants You the right to extract, reuse, reproduce, and Share all or a substantial portion of the contents of the database for NonCommercial purposes only;</li>
<li>if You include all or a substantial portion of the database contents in a database in which You have Sui Generis Database Rights, then the database in which You have Sui Generis Database Rights (but not its individual contents) is Adapted Material; and</li>
<li>You must comply with the conditions in Section 3(a) if You Share all or a substantial portion of the contents of the database.</li>
</ol>
<p>For the avoidance of doubt, this Section 4 supplements and does not replace Your obligations under this Public License where the Licensed Rights include other Copyright and Similar Rights.</p>
</div>
<div class="section" id="section-5-disclaimer-of-warranties-and-limitation-of-liability">
<h4>Section 5 – Disclaimer of Warranties and Limitation of Liability.<a class="headerlink" href="#section-5-disclaimer-of-warranties-and-limitation-of-liability" title="Permalink to this headline">¶</a></h4>
<ol class="loweralpha simple">
<li><strong>Unless otherwise separately undertaken by the Licensor, to the extent possible, the Licensor offers the Licensed Material as-is and as-available, and makes no representations or warranties of any kind concerning the Licensed Material, whether express, implied, statutory, or other. This includes, without limitation, warranties of title, merchantability, fitness for a particular purpose, non-infringement, absence of latent or other defects, accuracy, or the presence or absence of errors, whether or not known or discoverable. Where disclaimers of warranties are not allowed in full or in part, this disclaimer may not apply to You.</strong></li>
<li><strong>To the extent possible, in no event will the Licensor be liable to You on any legal theory (including, without limitation, negligence) or otherwise for any direct, special, indirect, incidental, consequential, punitive, exemplary, or other losses, costs, expenses, or damages arising out of this Public License or use of the Licensed Material, even if the Licensor has been advised of the possibility of such losses, costs, expenses, or damages. Where a limitation of liability is not allowed in full or in part, this limitation may not apply to You.</strong></li>
<li>The disclaimer of warranties and limitation of liability provided above shall be interpreted in a manner that, to the extent possible, most closely approximates an absolute disclaimer and waiver of all liability.</li>
</ol>
</div>
<div class="section" id="section-6-term-and-termination">
<h4>Section 6 – Term and Termination.<a class="headerlink" href="#section-6-term-and-termination" title="Permalink to this headline">¶</a></h4>
<ol class="loweralpha simple">
<li>This Public License applies for the term of the Copyright and Similar Rights licensed here. However, if You fail to comply with this Public License, then Your rights under this Public License terminate automatically.</li>
<li>Where Your right to use the Licensed Material has terminated under Section 6(a), it reinstates:</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>automatically as of the date the violation is cured, provided it is cured within 30 days of Your discovery of the violation; or</li>
<li>upon express reinstatement by the Licensor.</li>
</ol>
<p>For the avoidance of doubt, this Section 6(b) does not affect any right the Licensor may have to seek remedies for Your violations of this Public License.</p>
</div></blockquote>
<ol class="loweralpha simple" start="3">
<li>For the avoidance of doubt, the Licensor may also offer the Licensed Material under separate terms or conditions or stop distributing the Licensed Material at any time; however, doing so will not terminate this Public License.</li>
<li>Sections 1, 5, 6, 7, and 8 survive termination of this Public License.</li>
</ol>
</div>
<div class="section" id="section-7-other-terms-and-conditions">
<h4>Section 7 – Other Terms and Conditions.<a class="headerlink" href="#section-7-other-terms-and-conditions" title="Permalink to this headline">¶</a></h4>
<ol class="loweralpha simple">
<li>The Licensor shall not be bound by any additional or different terms or conditions communicated by You unless expressly agreed.</li>
<li>Any arrangements, understandings, or agreements regarding the Licensed Material not stated herein are separate from and independent of the terms and conditions of this Public License.</li>
</ol>
</div>
<div class="section" id="section-8-interpretation">
<h4>Section 8 – Interpretation.<a class="headerlink" href="#section-8-interpretation" title="Permalink to this headline">¶</a></h4>
<ol class="loweralpha simple">
<li>For the avoidance of doubt, this Public License does not, and shall not be interpreted to, reduce, limit, restrict, or impose conditions on any use of the Licensed Material that could lawfully be made without permission under this Public License.</li>
<li>To the extent possible, if any provision of this Public License is deemed unenforceable, it shall be automatically reformed to the minimum extent necessary to make it enforceable. If the provision cannot be reformed, it shall be severed from this Public License without affecting the enforceability of the remaining terms and conditions.</li>
<li>No term or condition of this Public License will be waived and no failure to comply consented to unless expressly agreed to by the Licensor.</li>
<li>Nothing in this Public License constitutes or may be interpreted as a limitation upon, or waiver of, any privileges and immunities that apply to the Licensor or You, including from the legal processes of any jurisdiction or authority.</li>
</ol>
<p><strong>Creative Commons is not a party to its public
licenses. Notwithstanding, Creative Commons may elect to apply one of
its public licenses to material it publishes and in those instances
will be considered the &quot;Licensor.&quot; Except for the limited purpose of
indicating that material is shared under a Creative Commons public
license or as otherwise permitted by the Creative Commons policies
published at creativecommons.org/policies, Creative Commons does not
authorize the use of the trademark &quot;Creative Commons&quot; or any other
trademark or logo of Creative Commons without its prior written
consent including, without limitation, in connection with any
unauthorized modifications to any of its public licenses or any other
arrangements, understandings, or agreements concerning use of licensed
material. For the avoidance of doubt, this paragraph does not form
part of the public licenses.</strong></p>
<p><strong>Creative Commons may be contacted at creativecommons.org.</strong></p>
</div>
</div>
</div>
<div class="section" id="suricata-source-code">
<h3>Suricata Source Code<a class="headerlink" href="#suricata-source-code" title="Permalink to this headline">¶</a></h3>
<p>The Suricata source code is licensed under version 2 of the
<a class="reference internal" href="index.html#document-licenses/gnu-gpl-v2.0"><span class="doc">GNU General Public License</span></a>.</p>
</div>
<div class="section" id="suricata-documentation">
<h3>Suricata Documentation<a class="headerlink" href="#suricata-documentation" title="Permalink to this headline">¶</a></h3>
<p>The Suricata documentation (this documentation) is licensed under the
<a class="reference internal" href="index.html#document-licenses/cc-nc-4.0"><span class="doc">Creative Commons Attribution-NonCommercial 4.0 International Public License</span></a>.</p>
</div>
</div>
<span id="document-devguide/index"></span><div class="section" id="suricata-developer-guide">
<h2>Suricata Developer Guide<a class="headerlink" href="#suricata-developer-guide" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-devguide/codebase/index"></span><div class="section" id="working-with-the-codebase">
<h3>Working with the Codebase<a class="headerlink" href="#working-with-the-codebase" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-devguide/codebase/contributing/index"></span><div class="section" id="contributing">
<h4>Contributing<a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-devguide/codebase/contributing/contribution-process"></span><div class="section" id="contributing-to-suricata">
<h5>Contributing to Suricata<a class="headerlink" href="#contributing-to-suricata" title="Permalink to this headline">¶</a></h5>
<p>This guide describes what steps to take if you want to contribute a patch or
patchset to Suricata.</p>
<p>Essentially, these are:</p>
<ol class="arabic simple">
<li>Agree to and sign our <a class="reference internal" href="#contribution-agreement"><span class="std std-ref">Contribution Agreement</span></a></li>
<li>Communicate early, and use the <a class="reference internal" href="#communication-channels"><span class="std std-ref">preferred channels</span></a></li>
<li><a class="reference internal" href="#claim-ticket"><span class="std std-ref">Claim (or open) a ticket</span></a></li>
<li><a class="reference internal" href="#what-branch-to-work-on"><span class="std std-ref">Fork from master</span></a></li>
<li>Follow our <a class="reference internal" href="index.html#coding-style"><span class="std std-ref">Coding Style</span></a></li>
<li>Use our <a class="reference internal" href="#documentation-style"><span class="std std-ref">Documentation Style</span></a></li>
<li>Stick to our <a class="reference internal" href="index.html#commits"><span class="std std-ref">commit guidelines</span></a></li>
<li>Add version numbers to your <a class="reference internal" href="#send-a-pull-request"><span class="std std-ref">Pull Requests</span></a></li>
<li>Incorporate <a class="reference internal" href="#feedback"><span class="std std-ref">Feedback</span></a> into new PRs</li>
<li>[Work merged] <a class="reference internal" href="#wrap-up"><span class="std std-ref">Wrap up!</span></a></li>
</ol>
<p>The rest of this document will cover those in detail.</p>
<div class="admonition note" id="contribution-agreement">
<p class="first admonition-title">Note</p>
<p>Important!</p>
<p class="last">Before contributing, please review and sign our <a class="reference external" href="https://suricata.io/contribution-agreements/">Contribution Agreement</a>.</p>
</div>
<div class="section" id="communication-is-key">
<span id="communication-channels"></span><h6>Communication is Key!<a class="headerlink" href="#communication-is-key" title="Permalink to this headline">¶</a></h6>
<p>To clarify questions, discuss or suggest new features, talk about bugs and
optimizations, and/or ask for help, it is important to communicate.</p>
<p>These are our main channels:</p>
<ul class="simple">
<li><a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/issues">Suricata's issue tracker</a></li>
<li><a class="reference external" href="https://forum.suricata.io/c/developers/8">Suricata's forum</a></li>
<li><a class="reference external" href="https://discord.com/invite/t3rV2x7MrG">Suricata's Discord server</a></li>
</ul>
</div>
<div class="section" id="claim-or-open-a-ticket">
<span id="claim-ticket"></span><h6>Claim (or open) a ticket<a class="headerlink" href="#claim-or-open-a-ticket" title="Permalink to this headline">¶</a></h6>
<p>For features and bugs we need <a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/issues">tickets</a>. Tickets help us keep track of the work done,
indicate when changes need backports etc.</p>
<p>They are also important if you would like to see your new feature officially
added to our tool: the ticket documents your ideas so  we can analyze how do they
fit in our plans for Suricata, and, if the feature is accepted, we can properly
track progress etc.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want to add new functionalities (e.g. a new application layer
protocol), please ask us first whether we see that being merged into
Suricata or not. This helps both sides understand how the new feature will
fit in our roadmap, and prevents wasting time and motivation with
contributions that we may not accept. Therefore, <cite>before</cite> starting any code
related to a new feature, do request comments from the team about it.</p>
</div>
<p>For really trivial fixes or cleanups we won't need that.</p>
<p>Once work on the issue has been agreed upon:</p>
<p>Assign the ticket to yourself. For this, you will need to have the &quot;developer&quot;
role. You can ask for that directly on the ticket you want to claim or mention
that you are interested in working on <cite>ticket number</cite> on our <a class="reference external" href="https://discord.com/channels/864648830553292840/888087709002891324">Developer's
channel on Discord</a>.</p>
<p>If a ticket is already assigned to someone, please reach out on the ticket or
ask the person first.</p>
<p>You can reach out to other community members via <a class="reference external" href="https://discord.com/invite/t3rV2x7MrG">Suricata's Discord server</a>.</p>
</div>
<div class="section" id="expectations">
<h6>Expectations<a class="headerlink" href="#expectations" title="Permalink to this headline">¶</a></h6>
<p>If you submit a new feature that is not part of Suricata's core functionalities,
it will have the <a class="reference internal" href="#community-supported">community supported</a> status. This means we would expect some
commitment from you, or the organization who is sponsoring your work, before we
could approve the new feature, as the Suricata development team is pretty lean
(and many times overworked).</p>
<p>This means we expect that:</p>
<blockquote>
<div><ul class="simple">
<li>the new contribution comes with a set of Suricata-verify tests (and
possibly unit tests, where those apply), before we can approve it;</li>
<li>proof of compatibility with existing keywords/features is provided,
when the contribution is for replacing an existing feature;</li>
<li>you would maintain the feature once it is approved - or some other
community member would do that, in case you cannot.</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Regardless of contribution size or complexity, we expect that you respect
our guidelines and processes. We appreciate community contributors:
Suricata wouldn't be what it is without them; and the value of our tool and
community also comes from how seriously we take all this, so we ask that
our contributors do the same!</p>
</div>
<div class="section" id="what-does-community-supported-and-supporting-a-feature-mean">
<span id="community-supported"></span><h7>What does &quot;community supported&quot; and  &quot;supporting a feature&quot; mean?<a class="headerlink" href="#what-does-community-supported-and-supporting-a-feature-mean" title="Permalink to this headline">¶</a></h7>
<p>If a feature is <em>community supported</em>, the Suricata team will try to spend
minimal time on it - to be able to focus on the core functionalities. If for any
reason you're not willing or able to commit to supporting a feature, please
indicate this.</p>
<p>The team and/or community members can then consider offering help. It is best
to indicate this prior to doing the actual work, because we will reject features
if no one steps up.</p>
<p>It is also important to note that <em>community supported</em> features  will be
disabled by default, and if it brings in new dependencies (libraries or Rust
crates) those will also be optional and disabled by default.</p>
<p><strong>Supporting a feature</strong> means to actually <em>maintain</em> it:</p>
<ul class="simple">
<li>fixing bugs</li>
<li>writing documentation</li>
<li>keeping it up to date</li>
<li>offering end-user support via forum and/or Discord chat</li>
</ul>
</div>
</div>
<div class="section" id="stale-tickets-policy">
<span id="id3"></span><h6>Stale tickets policy<a class="headerlink" href="#stale-tickets-policy" title="Permalink to this headline">¶</a></h6>
<p>We understand that people's availability and interested to volunteer their time
to our project may change. Therefore, to prevent tickets going stale (not worked
on), and issues going unsolved for a long time, we have a policy to unclaim
tickets if there are no contribution updates within 6 months.</p>
<p>If you claim a ticket and later on find out that you won't be able to work on
it, it is also appreciated if you inform that to us in the ticket and unclaim
it, so everyone knows that work is still open and waiting to be done.</p>
</div>
<div class="section" id="what-branch-to-work-on">
<span id="id4"></span><h6>What branch to work on<a class="headerlink" href="#what-branch-to-work-on" title="Permalink to this headline">¶</a></h6>
<p>There are 2 or 3 active branches:</p>
<blockquote>
<div><ul class="simple">
<li>master-x.x.x (e.g. master-6.x.y)</li>
<li>master</li>
</ul>
</div></blockquote>
<p>The former is the stable branch. The latter the development branch.</p>
<p>The stable branch should only be worked on for important bug fixes. Those are
mainly expected from more experienced contributors.</p>
<p>Development of new features or large scale redesign is done in the development
branch. New development and new contributors should work with <code class="docutils literal notranslate"><span class="pre">master</span></code> except
in very special cases - which should and would be discussed with us first.</p>
<p>If in doubt, please reach out to us via <a class="reference internal" href="#communication-channels"><span class="std std-ref">Redmine, Discord or
forum</span></a>.</p>
</div>
<div class="section" id="create-your-own-branch">
<span id="id5"></span><h6>Create your own branch<a class="headerlink" href="#create-your-own-branch" title="Permalink to this headline">¶</a></h6>
<p>It's useful to create descriptive branch names. You're working on ticket 123 to
improve GeoIP? Name your branch &quot;geoip-feature-123-v1&quot;. The &quot;-v1&quot; addition is
for feedback. When incorporating feedback you will have to create a new branch
for each pull request. So, when you address the first feedback, you will work in
&quot;geoip-feature-123-v2&quot; and so on.</p>
<p>For more details check: <a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/GitHub_work_flow#Creating-a-branch-to-do-your-changes">Creating a branch to do your changes</a></p>
</div>
<div class="section" id="coding-style">
<h6>Coding Style<a class="headerlink" href="#coding-style" title="Permalink to this headline">¶</a></h6>
<p>We have a <a class="reference internal" href="index.html#coding-style"><span class="std std-ref">Coding Style</span></a> that must be followed.</p>
</div>
<div class="section" id="documentation-style">
<span id="id6"></span><h6>Documentation Style<a class="headerlink" href="#documentation-style" title="Permalink to this headline">¶</a></h6>
<p>For documenting <em>code</em>, please follow Rust documentation and/or Doxygen
guidelines, according to what your contribution is using (Rust or C).</p>
<p>If you are writing or updating <em>documentation pages</em>, please:</p>
<ul class="simple">
<li>wrap up lines at 79 (80 at most) characters;</li>
<li>when adding diagrams or images, we prefer alternatives that can be generated
automatically, if possible;</li>
<li>bear in mind that our documentation is published on <a class="reference external" href="https://docs.suricata.io/en/latest/#suricata-user-guide">Read the Docs</a> and can also be
built to pdf, so it is important that it looks good in such formats.</li>
</ul>
</div>
<div class="section" id="commit-history-matters">
<h6>Commit History matters<a class="headerlink" href="#commit-history-matters" title="Permalink to this headline">¶</a></h6>
<p>Please consider our <a class="reference internal" href="index.html#commits"><span class="std std-ref">Commit guidelines</span></a> before submitting your PR.</p>
</div>
<div class="section" id="send-a-pull-request">
<span id="id7"></span><h6>Send a Pull Request<a class="headerlink" href="#send-a-pull-request" title="Permalink to this headline">¶</a></h6>
<p>The pull request is used to request inclusion of your patches into the main
repository. Before it is merged, it will be reviewed and pushed through a QA
process.</p>
<p>Please consider our <a class="reference internal" href="index.html#pull-requests-criteria"><span class="std std-ref">Pull Requests Criteria</span></a> when
submitting.</p>
<p>We have 'GitHub-CI' integration enabled. This means some automated build check,
suricata-verity and unit tests are performed on the pull request. Generally,
this is ready after a few minutes. If the test fails, the pull request won't be
considered. So please, when you submit something, keep an eye on the checks,
and address any failures - if you do not understand what they are, it is fine to
ask about them on the failing PR itself.</p>
<p>Before merge, we also perform other integration tests in our private QA-lab. If
those fail, we may request further changes, even if the GitHub-CI has passed.</p>
</div>
<div class="section" id="feedback">
<span id="id8"></span><h6>Feedback<a class="headerlink" href="#feedback" title="Permalink to this headline">¶</a></h6>
<p>You'll likely get some feedback. Even our most experienced devs do, so don't
feel bad about it.</p>
<p>After discussing what needs to be changed (usually on the PR itself), it's time
to go back to &quot;<a class="reference internal" href="#create-your-own-branch"><span class="std std-ref">Create your own branch</span></a>&quot; and do it all again. This process
can iterate quite a few times, as the contribution is refined.</p>
</div>
<div class="section" id="wrapping-up">
<span id="wrap-up"></span><h6>Wrapping up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h6>
<div class="section" id="merged-cleanup">
<h7>Merged! Cleanup<a class="headerlink" href="#merged-cleanup" title="Permalink to this headline">¶</a></h7>
<p>Congrats! Your change has been merged into the main repository. Many thanks!</p>
<p>We strongly suggest cleaning up: delete your related branches, both locally and
on GitHub - this helps you in keeping things organized when you want to make new
contributions.</p>
</div>
<div class="section" id="update-ticket">
<span id="id9"></span><h7>Update ticket<a class="headerlink" href="#update-ticket" title="Permalink to this headline">¶</a></h7>
<p>You can now put the URL of the <em>merged</em> pull request in the Redmine ticket.
Next, mark the ticket as &quot;Closed&quot; or &quot;Resolved&quot;.</p>
<p>Well done! You are all set now.</p>
</div>
</div>
</div>
<span id="document-devguide/codebase/contributing/code-submission-process"></span><div class="section" id="code-submission-process">
<h5>Code Submission Process<a class="headerlink" href="#code-submission-process" title="Permalink to this headline">¶</a></h5>
<div class="section" id="commits">
<span id="id1"></span><h6>Commits<a class="headerlink" href="#commits" title="Permalink to this headline">¶</a></h6>
<ol class="arabic simple">
<li>Commits need to be logically separated. Don't fix unrelated things in one commit.</li>
<li>Don't add unnecessary commits, if commit 2 fixes commit 1 merge them together (squash)</li>
<li>Commits need to have proper messages, explaining anything that is non-trivial</li>
<li>Commits should not at the same time change, rename and/or move code. Use separate commits
for each of this, e.g, a commit to rename files, then a commit to change the code.</li>
<li>Documentation updates should be in their own commit (not mixed with code commits)</li>
<li><dl class="first docutils">
<dt>Commit messages need to be properly formatted:</dt>
<dd><ul class="first last">
<li>Meaningful and short (50 chars max) subject line followed by an empty line</li>
<li>Naming convention: prefix message with sub-system (&quot;rule parsing: fixing foobar&quot;). If
you're not sure what to use, look at past commits to the file(s) in your PR.</li>
<li>Description, wrapped at ~72 characters</li>
</ul>
</dd>
</dl>
</li>
<li>Commits should be individually compilable, starting with the oldest commit. Make sure that
each commit can be built if it and the preceding commits in the PR are used.</li>
</ol>
<p>Information that needs to be part of a commit (if applicable):</p>
<ol class="arabic simple">
<li>Ticket it fixes. E.g. &quot;Fixes Bug #123.&quot;</li>
<li>Compiler warnings addressed.</li>
<li>Coverity Scan issues addressed.</li>
<li>Static analyzer error it fixes (cppcheck/scan-build/etc)</li>
</ol>
<p>When in doubt, check our git history for other messages or changes done to the
same module your're working on. This is a good example of a <a class="reference external" href="https://github.com/OISF/suricata/commit/33fca4d4db112b75ffa22eb2e6f14f038cbcc1f9">commit message</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pcap</span><span class="o">/</span><span class="n">file</span><span class="p">:</span> <span class="n">normalize</span> <span class="n">file</span> <span class="n">timestamps</span>

<span class="n">Normalize</span> <span class="n">the</span> <span class="n">timestamps</span> <span class="n">that</span> <span class="n">are</span> <span class="n">too</span> <span class="n">far</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">past</span> <span class="n">to</span> <span class="n">epoch</span><span class="o">.</span>

<span class="n">Bug</span><span class="p">:</span> <span class="c1">#6240.</span>
</pre></div>
</div>
</div>
<div class="section" id="pull-requests">
<span id="pull-requests-criteria"></span><h6>Pull Requests<a class="headerlink" href="#pull-requests" title="Permalink to this headline">¶</a></h6>
<p>A github pull request is actually just a pointer to a branch in your tree. GitHub provides a review interface that we use.</p>
<ol class="arabic simple">
<li>A branch can only be used in for an individual PR.</li>
<li>A branch should not be updated after the pull request</li>
<li>A pull request always needs a good description (link to issue tracker if related to a ticket).</li>
<li>Incremental pull requests need to link to the prior iteration</li>
<li>Incremental pull requests need to describe changes since the last PR</li>
<li>Link to the ticket(s) that are addressed to it.</li>
<li>When fixing an issue, update the issue status to <code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">Review</span></code> after submitting the PR.</li>
<li>Pull requests are automatically tested using github actions (<a class="reference external" href="https://github.com/OISF/suricata/blob/master/.github/workflows/builds.yml">https://github.com/OISF/suricata/blob/master/.github/workflows/builds.yml</a>).
Failing builds won't be considered and should be closed immediately.</li>
<li>Pull requests that change, or add a feature should include a documentation update commit</li>
</ol>
</div>
<div class="section" id="tests-and-qa">
<h6>Tests and QA<a class="headerlink" href="#tests-and-qa" title="Permalink to this headline">¶</a></h6>
<p>As much as possible, new functionality should be easy to QA.</p>
<ol class="arabic simple">
<li>Add <code class="docutils literal notranslate"><span class="pre">suricata-verify</span></code> tests for verification. See <a class="reference external" href="https://github.com/OISF/suricata-verify">https://github.com/OISF/suricata-verify</a></li>
<li>Add unittests if a <code class="docutils literal notranslate"><span class="pre">suricata-verify</span></code> test isn't possible.</li>
<li>Provide pcaps that reproduce the problem. Try to trim as much as possible to the pcap includes the minimal
set of packets that demonstrate the problem.</li>
<li>Provide example rules if the code added new keywords or new options to existing keywords</li>
</ol>
</div>
</div>
<span id="document-devguide/codebase/contributing/github-pr-workflow"></span><div class="section" id="github-pull-request-workflow">
<h5>GitHub Pull Request Workflow<a class="headerlink" href="#github-pull-request-workflow" title="Permalink to this headline">¶</a></h5>
<div class="section" id="draft-pull-requests">
<h6>Draft Pull Requests<a class="headerlink" href="#draft-pull-requests" title="Permalink to this headline">¶</a></h6>
<p>A Pull Request (PR) should be marked as <cite>draft</cite> if it is not intended to be merged as is,
but is waiting for some sort of feedback.
The author of the PR should be explicit with what kind of feedback is expected
(CI/QA run, discussion on the code, etc...)</p>
<p>GitHub filter is <code class="docutils literal notranslate"><span class="pre">is:pr</span> <span class="pre">is:open</span> <span class="pre">draft:true</span> <span class="pre">sort:updated-asc</span></code></p>
<p>A draft may be closed if it has not been updated in two months.</p>
</div>
<div class="section" id="mergeable-pull-requests">
<h6>Mergeable Pull Requests<a class="headerlink" href="#mergeable-pull-requests" title="Permalink to this headline">¶</a></h6>
<dl class="docutils">
<dt>When a Pull Request is intended to be merged as is, the workflow is the following:</dt>
<dd><ol class="first last arabic simple">
<li>get reviewed, and either request changes or get approved</li>
<li>if approved, get staged in a next branch (with other PRs), wait for CI validation
(and eventually request changes if CI finds anything)</li>
<li>get merged and closed</li>
</ol>
</dd>
</dl>
<p>A newly created PR should match the filter
<code class="docutils literal notranslate"><span class="pre">is:pr</span> <span class="pre">is:open</span> <span class="pre">draft:false</span> <span class="pre">review:none</span> <span class="pre">sort:updated-asc</span> <span class="pre">no:assignee</span></code>
The whole team is responsible to assign a PR to someone precise within 2 weeks.</p>
<p>When someone gets assigned a PR, the PR should get a review status within 2 weeks:
either changes requested, approved, or assigned to someone else if more
expertise is needed.</p>
<p>GitHub filter for changes-requested PRs is <code class="docutils literal notranslate"><span class="pre">is:pr</span> <span class="pre">is:open</span> <span class="pre">draft:false</span> <span class="pre">sort:</span>
<span class="pre">updated-asc</span> <span class="pre">review:changes-requested</span></code></p>
<p>Such a PR may be closed if it has not been updated in two months.
It is expected that the author creates a new PR with a new version of the patch
as described in <a class="reference internal" href="index.html#pull-requests-criteria"><span class="std std-ref">Pull Requests Criteria</span></a>.</p>
<p>Command to get approved PRs is <code class="docutils literal notranslate"><span class="pre">gh</span> <span class="pre">pr</span> <span class="pre">list</span> <span class="pre">--json</span> <span class="pre">number,reviewDecision</span> <span class="pre">--search</span>
<span class="pre">&quot;state:open</span> <span class="pre">type:pr</span> <span class="pre">-review:none&quot;</span> <span class="pre">|</span> <span class="pre">jq</span> <span class="pre">'.[]</span> <span class="pre">|</span> <span class="pre">select(.reviewDecision==&quot;&quot;)'</span></code></p>
<p>Web UI filter does not work cf <a class="reference external" href="https://github.com/orgs/community/discussions/55826">https://github.com/orgs/community/discussions/55826</a></p>
<p>Once in approved state, the PRs are in the responsibility of the merger, along
with the next branches/PRs.</p>
</div>
</div>
</div>
</div>
<span id="document-devguide/codebase/installation-from-git"></span><div class="section" id="installation-from-git">
<span id="id1"></span><h4>Installation from GIT<a class="headerlink" href="#installation-from-git" title="Permalink to this headline">¶</a></h4>
<div class="section" id="ubuntu-installation-from-git">
<h5>Ubuntu Installation from GIT<a class="headerlink" href="#ubuntu-installation-from-git" title="Permalink to this headline">¶</a></h5>
<p>This document will explain how to install and use the most recent code of
Suricata on Ubuntu. Installing from GIT on other operating systems is
basically the same, except that some commands are Ubuntu-specific
(like sudo and apt-get). In case you are using another operating system,
you should replace those commands with your OS-specific commands.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These instructions were tested on Ubuntu 22.04.</p>
</div>
<div class="section" id="pre-installation-requirements">
<h6>Pre-installation requirements<a class="headerlink" href="#pre-installation-requirements" title="Permalink to this headline">¶</a></h6>
<p>Before you can build Suricata for your system, run the following command
to ensure that you have everything you need for the installation.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>libpcre2-dev<span class="w"> </span>build-essential<span class="w"> </span>autoconf<span class="w"> </span><span class="se">\</span>
automake<span class="w"> </span>libtool<span class="w"> </span>libpcap-dev<span class="w"> </span>libnet1-dev<span class="w"> </span>libyaml-0-2<span class="w"> </span>libyaml-dev<span class="w"> </span><span class="se">\</span>
pkg-config<span class="w"> </span>zlib1g<span class="w"> </span>zlib1g-dev<span class="w"> </span>libcap-ng-dev<span class="w"> </span>libcap-ng0<span class="w"> </span>make<span class="w"> </span><span class="se">\</span>
libmagic-dev<span class="w"> </span>libjansson-dev<span class="w"> </span>rustc<span class="w"> </span>cargo<span class="w"> </span>jq<span class="w"> </span>git-core
</pre></div>
</div>
<p>Add <code class="docutils literal notranslate"><span class="pre">${HOME}/.cargo/bin</span></code> to your path:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.cargo/bin
cargo<span class="w"> </span>install<span class="w"> </span>--force<span class="w"> </span>cbindgen
</pre></div>
</div>
<p>Depending on the current status of your system, it may take a while to
complete this process.</p>
<p><strong>IPS</strong></p>
<p>By default, Suricata works as an IDS. If you want to use it as an IDS and IPS
program, enter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>libnetfilter-queue-dev<span class="w"> </span>libnetfilter-queue1<span class="w"> </span><span class="se">\</span>
libnfnetlink-dev<span class="w"> </span>libnfnetlink0
</pre></div>
</div>
</div>
<div class="section" id="suricata">
<h6>Suricata<a class="headerlink" href="#suricata" title="Permalink to this headline">¶</a></h6>
<p>First, it is convenient to create a directory for Suricata.
Name it 'suricata' or 'oisf', for example. Open the terminal and enter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>suricata<span class="w">  </span><span class="c1"># mkdir oisf</span>
</pre></div>
</div>
<p>Followed by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>suricata<span class="w">  </span><span class="c1"># cd oisf</span>
</pre></div>
</div>
<p>Next, enter the following line in the terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/OISF/suricata.git
<span class="nb">cd</span><span class="w"> </span>suricata
</pre></div>
</div>
<p>Libhtp and suricata-update are not bundled. Get them by doing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./scripts/bundle.sh
</pre></div>
</div>
<p>Followed by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./autogen.sh
</pre></div>
</div>
<p>To configure, please enter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./configure
</pre></div>
</div>
<p>To compile, please enter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make
</pre></div>
</div>
<p>To install Suricata, enter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>make<span class="w"> </span>install
sudo<span class="w"> </span>ldconfig
</pre></div>
</div>
</div>
<div class="section" id="auto-setup">
<h6>Auto-setup<a class="headerlink" href="#auto-setup" title="Permalink to this headline">¶</a></h6>
<p>You can also use the available auto-setup features of Suricata. Ex:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./configure<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install-conf
</pre></div>
</div>
<p><em>make install-conf</em>
would do the regular &quot;make install&quot; and then it would automatically
create/setup all the necessary directories and <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> for you.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./configure<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>install-rules
</pre></div>
</div>
<p><em>make install-rules</em>
would do the regular &quot;make install&quot; and then it would automatically download
and set-up the latest ruleset from Emerging Threats available for Suricata.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./configure<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>install-full
</pre></div>
</div>
<p><em>make install-full</em>
would combine everything mentioned above (install-conf and install-rules) -
and will present you with a ready to run (configured and set-up) Suricata.</p>
</div>
<div class="section" id="post-installation">
<h6>Post installation<a class="headerlink" href="#post-installation" title="Permalink to this headline">¶</a></h6>
<p>Please continue with <a class="reference internal" href="index.html#basic-setup"><span class="std std-ref">Basic setup</span></a>.</p>
<p>In case you have already created your Suricata directory and cloned the
repository in it, if you want to update your local repository with the
most recent code, please run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>suricata/suricata
</pre></div>
</div>
<p>next, enter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>pull
</pre></div>
</div>
<p>After that, you should run <em>./autogen.sh</em> again.</p>
</div>
</div>
</div>
<span id="document-devguide/codebase/code-style"></span><div class="section" id="coding-style">
<span id="id1"></span><h4>Coding Style<a class="headerlink" href="#coding-style" title="Permalink to this headline">¶</a></h4>
<p>Suricata uses a fairly strict coding style. This document describes it.</p>
<div class="section" id="formatting">
<h5>Formatting<a class="headerlink" href="#formatting" title="Permalink to this headline">¶</a></h5>
<div class="section" id="clang-format">
<h6>clang-format<a class="headerlink" href="#clang-format" title="Permalink to this headline">¶</a></h6>
<p><code class="docutils literal notranslate"><span class="pre">clang-format</span></code> is configured to help you with formatting C code.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">.clang-format</span></code> script requires clang 9 or newer.</p>
</div>
<div class="section" id="format-your-changes">
<h7>Format your Changes<a class="headerlink" href="#format-your-changes" title="Permalink to this headline">¶</a></h7>
<p>Before opening a pull request, please also try to ensure it is formatted
properly. We use <code class="docutils literal notranslate"><span class="pre">clang-format</span></code> for this, which has git integration through the
<code class="docutils literal notranslate"><span class="pre">git-clang-format</span></code> script to only format your changes.</p>
<p>On some systems, it may already be installed (or be installable via your package
manager). If so, you can simply run it.</p>
<p>It is recommended to format each commit as you go. However, you can always
reformat your whole branch after the fact.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Depending on your installation, you might have to use the version-specific
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clang-format</span></code> in the commands below, e.g. <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clang-format-9</span></code>,
and possibly even provide the <code class="docutils literal notranslate"><span class="pre">clang-format</span></code> binary with
<code class="docutils literal notranslate"><span class="pre">--binary</span> <span class="pre">clang-format-9</span></code>.</p>
<p class="last">As an alternative, you can use the provided <code class="docutils literal notranslate"><span class="pre">scripts/clang-format.sh</span></code>
that isolates you from the different versions.</p>
</div>
<div class="section" id="formatting-the-most-recent-commit-only">
<h8>Formatting the most recent commit only<a class="headerlink" href="#formatting-the-most-recent-commit-only" title="Permalink to this headline">¶</a></h8>
<p>The following command will format only the code changed in the most recent commit:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clang-format<span class="w"> </span>HEAD^
<span class="c1"># Or with script:</span>
$<span class="w"> </span>scripts/clang-format.sh<span class="w"> </span>commit
</pre></div>
</div>
<p>Note that this modifies the files, but doesn't commit them. If the changes are
trivial, you’ll likely want to run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>--amend<span class="w"> </span>-a
</pre></div>
</div>
<p>in order to update the last commit with all pending changes.</p>
<p>For bigger formatting changes, we do ask you to add them to separate, dedicated
commits.</p>
</div>
<div class="section" id="formatting-code-in-staging">
<h8>Formatting code in staging<a class="headerlink" href="#formatting-code-in-staging" title="Permalink to this headline">¶</a></h8>
<p>The following command will format the changes in staging, i.e. files you
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code>-ed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clang-format
<span class="c1"># Or with script:</span>
$<span class="w"> </span>scripts/clang-format.sh<span class="w"> </span>cached
</pre></div>
</div>
<p>If you also want to change the unstaged changes, do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clang-format<span class="w"> </span>--force
<span class="c1"># Or with script:</span>
$<span class="w"> </span>scripts/clang-format.sh<span class="w"> </span>cached<span class="w"> </span>--force
</pre></div>
</div>
</div>
<div class="section" id="formatting-your-branch-s-commits">
<h8>Formatting your branch's commits<a class="headerlink" href="#formatting-your-branch-s-commits" title="Permalink to this headline">¶</a></h8>
<p>In case you have multiple commits on your branch already and forgot to
format them you can fix that up as well.</p>
<p>The following command will format every commit in your branch off master and
rewrite history using the existing commit metadata.</p>
<p>Tip: Create a new version of your branch first and run this off the new version.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># In a new version of your pull request:</span>
$<span class="w"> </span>scripts/clang-format.sh<span class="w"> </span>rewrite-branch
</pre></div>
</div>
<p>Note that the above should only be used for rather minimal formatting changes.
As mentioned, we prefer that you add such changes to a dedicated commit for
formatting changes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Format all changes by commits on your branch:</span>
$<span class="w"> </span>git<span class="w"> </span>clang-format<span class="w"> </span>first_commit_on_your_branch^
<span class="c1"># Or with script:</span>
$<span class="w"> </span>scripts/clang-format.sh<span class="w"> </span>branch
</pre></div>
</div>
<p>Note the usage of <code class="docutils literal notranslate"><span class="pre">first_commit_on_your_branch^</span></code>, not <code class="docutils literal notranslate"><span class="pre">master</span></code>, to avoid picking up
new commits on <code class="docutils literal notranslate"><span class="pre">master</span></code> in case you've updated master since you've branched.</p>
</div>
<div class="section" id="check-formatting">
<h8>Check formatting<a class="headerlink" href="#check-formatting" title="Permalink to this headline">¶</a></h8>
<p>Check if your branch changes' formatting is correct with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>scripts/clang-format.sh<span class="w"> </span>check-branch
</pre></div>
</div>
<p>Add the <code class="docutils literal notranslate"><span class="pre">--diffstat</span></code> parameter if you want to see the files needing formatting.
Add the <code class="docutils literal notranslate"><span class="pre">--diff</span></code> parameter if you want to see the actual diff of the formatting
change.</p>
</div>
<div class="section" id="formatting-a-whole-file">
<h8>Formatting a whole file<a class="headerlink" href="#formatting-a-whole-file" title="Permalink to this headline">¶</a></h8>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><p class="first"><strong>Note</strong></p>
<p class="last">Do not reformat whole files by default, i.e. do not use
<code class="docutils literal notranslate"><span class="pre">clang-format</span></code> proper in general.</p>
</td>
</tr>
</tbody>
</table>
<p>If you were ever to do so, formatting changes of existing code with clang-format
shall be a different commit and must not be mixed with actual code changes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>clang-format<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>file<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="disabling-clang-format">
<h7>Disabling clang-format<a class="headerlink" href="#disabling-clang-format" title="Permalink to this headline">¶</a></h7>
<p>There might be times, where the clang-format's formatting might not please.
This might mostly happen with macros, arrays (single or multi-dimensional ones),
struct initialization, or where one manually formatted code.</p>
<p>You can always disable clang-format.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* clang-format off */</span>
<span class="cp">#define APP_LAYER_INCOMPLETE(c, n) (AppLayerResult){1, (c), (n)}</span>
<span class="cm">/* clang-format on */</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-clang-format-and-git-clang-format">
<h7>Installing clang-format and git-clang-format<a class="headerlink" href="#installing-clang-format-and-git-clang-format" title="Permalink to this headline">¶</a></h7>
<p>clang-format 9 or newer is required.</p>
<p>On ubuntu 18.04:</p>
<ul>
<li><p class="first">It is sufficient to only install clang-format, e.g.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>clang-format-9
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">See <a class="reference external" href="http://apt.llvm.org">http://apt.llvm.org</a> for other releases in case the clang-format version
is not found in the default repos.</p>
</li>
</ul>
<p>On fedora:</p>
<ul>
<li><p class="first">Install the <code class="docutils literal notranslate"><span class="pre">clang</span></code>  and <code class="docutils literal notranslate"><span class="pre">git-clang-format</span></code> packages with</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>clang<span class="w"> </span>git-clang-format
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="line-length">
<h6>Line length<a class="headerlink" href="#line-length" title="Permalink to this headline">¶</a></h6>
<p>Limit line lengths to 100 characters.</p>
<p>When wrapping lines that are too long, they should be indented at least 8
spaces from previous line. You should attempt to wrap the minimal portion of
the line to meet the 100 character limit.</p>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>ColumnLimit: 100</li>
<li>ContinuationIndentWidth: 8</li>
<li>ReflowComments: true</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="indent">
<h6>Indent<a class="headerlink" href="#indent" title="Permalink to this headline">¶</a></h6>
<p>We use 4 space indentation.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">DecodeEthernet</span><span class="p">(</span><span class="n">ThreadVars</span><span class="w"> </span><span class="o">*</span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="n">DecodeThreadVars</span><span class="w"> </span><span class="o">*</span><span class="n">dtv</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pkt</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">PacketQueue</span><span class="w"> </span><span class="o">*</span><span class="n">pq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">SCPerfCounterIncr</span><span class="p">(</span><span class="n">dtv</span><span class="o">-&gt;</span><span class="n">counter_eth</span><span class="p">,</span><span class="w"> </span><span class="n">tv</span><span class="o">-&gt;</span><span class="n">sc_perf_pca</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ETHERNET_HEADER_LEN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ENGINE_SET_INVALID_EVENT</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">ETHERNET_PKT_TOO_SMALL</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TM_ECODE_FAILED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="n">DecodeNetworkLayer</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="n">dtv</span><span class="p">,</span><span class="w"> </span><span class="n">SCNtohs</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ethh</span><span class="o">-&gt;</span><span class="n">eth_type</span><span class="p">),</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">            </span><span class="n">pkt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ETHERNET_HEADER_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ETHERNET_HEADER_LEN</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TM_ECODE_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Use 8 space indentation when wrapping function parameters, loops and if statements.</p>
<p>Use 4 space indentation when wrapping variable definitions.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">SCPlugin</span><span class="w"> </span><span class="n">PluginSpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OUTPUT_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Some Developer&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">license</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GPLv2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateInit</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>AlignAfterOpenBracket: DontAlign</li>
<li>Cpp11BracedListStyle: false</li>
<li>IndentWidth: 4</li>
<li>TabWidth: 8 <a class="reference internal" href="index.html#llvm" id="id2">[llvm]</a></li>
<li>UseTab: Never <a class="reference internal" href="index.html#llvm" id="id3">[llvm]</a></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="braces">
<h6>Braces<a class="headerlink" href="#braces" title="Permalink to this headline">¶</a></h6>
<p>Functions should have the opening brace on a newline:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">SomeFunction</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DoSomething</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note: you may encounter non-compliant code.</p>
<p>Control and loop statements should have the opening brace on the same line:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ETHERNET_HEADER_LEN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ENGINE_SET_INVALID_EVENT</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">ETHERNET_PKT_TOO_SMALL</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TM_ECODE_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ascii_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="n">ascii_code</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">goto_table</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="p">][</span><span class="n">ascii_code</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SC_AC_FAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">funcs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">funcs</span><span class="p">;</span>
<span class="w">    </span><span class="n">funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="n">SCFree</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Opening and closing braces go on the same line as as the _else_ (also known as a &quot;cuddled else&quot;).</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DoThis</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DoThat</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Structs, unions and enums should have the opening brace on the same line:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TCPVars</span><span class="w"> </span><span class="n">tcpvars</span><span class="p">;</span>
<span class="w">    </span><span class="n">ICMPV4Vars</span><span class="w"> </span><span class="n">icmpv4vars</span><span class="p">;</span>
<span class="w">    </span><span class="n">ICMPV6Vars</span><span class="w"> </span><span class="n">icmpv6vars</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">l4vars</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">icmp_s</span><span class="p">;</span>

<span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DETECT_TAG_TYPE_SESSION</span><span class="p">,</span>
<span class="w">    </span><span class="n">DETECT_TAG_TYPE_HOST</span><span class="p">,</span>
<span class="w">    </span><span class="n">DETECT_TAG_TYPE_MAX</span>
<span class="p">};</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>BreakBeforeBraces: Custom <a class="reference internal" href="index.html#breakbeforebraces" id="id4">[breakbeforebraces]</a></li>
<li>BraceWrapping:<ul>
<li>AfterClass:      true</li>
<li>AfterControlStatement: false</li>
<li>AfterEnum:       false</li>
<li>AfterFunction:   true</li>
<li>AfterStruct:     false</li>
<li>AfterUnion:      false</li>
<li>AfterExternBlock: true</li>
<li>BeforeElse:      false</li>
<li>IndentBraces:    false</li>
</ul>
</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="flow">
<h5>Flow<a class="headerlink" href="#flow" title="Permalink to this headline">¶</a></h5>
<p>Don't use conditions and statements on the same line. E.g.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"> </span><span class="c1">// &lt;- wrong</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"> </span><span class="c1">// &lt;- right</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;- wrong</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;- right</span>
</pre></div>
</div>
<p>Don't put short or empty functions and structs on one line.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">empty_function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">short_function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Don't use unnecessary branching. E.g.:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Can be written as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>AllowShortBlocksOnASingleLine: false <a class="reference internal" href="index.html#llvm" id="id5">[llvm]</a></li>
<li>AllowShortBlocksOnASingleLine: Never <a class="reference internal" href="index.html#llvm" id="id6">[llvm]</a> (breaking change in clang 10!) <a class="reference internal" href="index.html#clang10" id="id7">[clang10]</a></li>
<li>AllowShortEnumsOnASingleLine: false <a class="reference internal" href="index.html#clang11" id="id8">[clang11]</a></li>
<li>AllowShortFunctionsOnASingleLine: None</li>
<li>AllowShortIfStatementsOnASingleLine: Never <a class="reference internal" href="index.html#llvm" id="id9">[llvm]</a></li>
<li>AllowShortLoopsOnASingleLine: false <a class="reference internal" href="index.html#llvm" id="id10">[llvm]</a></li>
<li>BreakBeforeBraces: Custom <a class="reference internal" href="index.html#breakbeforebraces" id="id11">[breakbeforebraces]</a></li>
<li>BraceWrapping:<ul>
<li>SplitEmptyFunction: true</li>
<li>SplitEmptyRecord: true</li>
</ul>
</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="alignment">
<h5>Alignment<a class="headerlink" href="#alignment" title="Permalink to this headline">¶</a></h5>
<div class="section" id="pointers">
<h6>Pointers<a class="headerlink" href="#pointers" title="Permalink to this headline">¶</a></h6>
<p>Pointers shall be right aligned.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">foo</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>PointerAlignment: Right</li>
<li>DerivePointerAlignment: false</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="declarations-and-comments">
<h6>Declarations and Comments<a class="headerlink" href="#declarations-and-comments" title="Permalink to this headline">¶</a></h6>
<p>Trailing comments should be aligned for consecutive lines.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bla</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">       </span><span class="cm">/* comment */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">bb</span><span class="p">;</span><span class="w"> </span><span class="cm">/* comment */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ccc</span><span class="p">;</span><span class="w">    </span><span class="cm">/* comment */</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">alignment</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// multiple consecutive vars</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w">           </span><span class="cm">/* comment */</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">abc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1312</span><span class="p">;</span><span class="w">   </span><span class="cm">/* comment */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">abcdefghikl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w"> </span><span class="cm">/* comment */</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>AlignConsecutiveAssignments: false</li>
<li>AlignConsecutiveDeclarations: false</li>
<li>AlignTrailingComments: true</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="functions">
<h5>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h5>
<div class="section" id="parameter-names">
<h6>parameter names<a class="headerlink" href="#parameter-names" title="Permalink to this headline">¶</a></h6>
<p>TODO</p>
</div>
<div class="section" id="function-names">
<h6>Function names<a class="headerlink" href="#function-names" title="Permalink to this headline">¶</a></h6>
<p>Function names are NamedLikeThis().</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">ConfNode</span><span class="w"> </span><span class="o">*</span><span class="n">ConfGetNodeOrCreate</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">final</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="static-vs-non-static">
<h6>static vs non-static<a class="headerlink" href="#static-vs-non-static" title="Permalink to this headline">¶</a></h6>
<p>Functions should be declared static whenever possible.</p>
</div>
<div class="section" id="inline">
<h6>inline<a class="headerlink" href="#inline" title="Permalink to this headline">¶</a></h6>
<p>The inlining of functions should be used only in critical paths.</p>
</div>
</div>
<div class="section" id="variables">
<h5>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h5>
<div class="section" id="names">
<h6>Names<a class="headerlink" href="#names" title="Permalink to this headline">¶</a></h6>
<p>A variable is <code class="docutils literal notranslate"><span class="pre">named_like_this</span></code> in all lowercase.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ConfNode</span><span class="w"> </span><span class="o">*</span><span class="n">parent_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">;</span>
</pre></div>
</div>
<p>Generally, use descriptive variable names.</p>
<p>In loop vars, make sure <code class="docutils literal notranslate"><span class="pre">i</span></code> is a signed int type.</p>
</div>
<div class="section" id="scope">
<h6>Scope<a class="headerlink" href="#scope" title="Permalink to this headline">¶</a></h6>
<p>TODO</p>
</div>
</div>
<div class="section" id="macros">
<h5>Macros<a class="headerlink" href="#macros" title="Permalink to this headline">¶</a></h5>
<p>Macro names are ALL_CAPS_WITH_UNDERSCORES.
Enclose parameters in parens on each usage inside the macro.</p>
<p>Align macro values on consecutive lines.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define ACTION_ALERT       0x01</span>
<span class="cp">#define ACTION_DROP        0x02</span>
<span class="cp">#define ACTION_REJECT      0x04</span>
<span class="cp">#define ACTION_REJECT_DST  0x08</span>
<span class="cp">#define ACTION_REJECT_BOTH 0x10</span>
<span class="cp">#define ACTION_PASS        0x20</span>
</pre></div>
</div>
<p>Align escape for multi-line macros right-most at ColumnLimit.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MULTILINE_DEF(a, b)                                              \</span>
<span class="cp">    if ((a) &gt; 2) {                                                       \</span>
<span class="cp">        auto temp = (b) / 2;                                             \</span>
<span class="cp">        (b) += 10;                                                       \</span>
<span class="cp">        someFunctionCall((a), (b));                                      \</span>
<span class="cp">    }</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>AlignConsecutiveMacros: true <a class="reference internal" href="index.html#clang9" id="id12">[clang9]</a></li>
<li>AlignEscapedNewlines: Right</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="comments">
<h5>Comments<a class="headerlink" href="#comments" title="Permalink to this headline">¶</a></h5>
<p>TODO</p>
<div class="section" id="function-comments">
<h6>Function comments<a class="headerlink" href="#function-comments" title="Permalink to this headline">¶</a></h6>
<p>We use Doxygen, functions are documented using Doxygen notation:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * \brief Helper function to get a node, creating it if it does not</span>
<span class="cm"> * exist.</span>
<span class="cm"> *</span>
<span class="cm"> * This function exits on memory failure as creating configuration</span>
<span class="cm"> * nodes is usually part of application initialization.</span>
<span class="cm"> *</span>
<span class="cm"> * \param name The name of the configuration node to get.</span>
<span class="cm"> * \param final Flag to set created nodes as final or not.</span>
<span class="cm"> *</span>
<span class="cm"> * \retval The existing configuration node if it exists, or a newly</span>
<span class="cm"> * created node for the provided name. On error, NULL will be returned.</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="n">ConfNode</span><span class="w"> </span><span class="o">*</span><span class="n">ConfGetNodeOrCreate</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">final</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="general-comments">
<h6>General comments<a class="headerlink" href="#general-comments" title="Permalink to this headline">¶</a></h6>
<p>We use <code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">foobar</span> <span class="pre">*/</span></code> style and try to avoid <code class="docutils literal notranslate"><span class="pre">//</span></code> style.</p>
</div>
</div>
<div class="section" id="file-names">
<h5>File names<a class="headerlink" href="#file-names" title="Permalink to this headline">¶</a></h5>
<p>File names are all lowercase and have a .c. .h  or .rs (Rust) extension.</p>
<p>Most files have a _subsystem_ prefix, e.g. <code class="docutils literal notranslate"><span class="pre">detect-dsize.c,</span> <span class="pre">util-ip.c</span></code></p>
<p>Some cases have a multi-layer prefix, e.g. <code class="docutils literal notranslate"><span class="pre">util-mpm-ac.c</span></code></p>
</div>
<div class="section" id="enums">
<h5>Enums<a class="headerlink" href="#enums" title="Permalink to this headline">¶</a></h5>
<p>Use a common prefix for all enum values. Value names are ALL_CAPS_WITH_UNDERSCORES.</p>
<p>Put each enum values on a separate line.
Tip: Add a trailing comma to the last element to force &quot;one-value-per-line&quot;
formatting in clang-format.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">VALUE_ONE</span><span class="p">,</span><span class="w"> </span><span class="n">VALUE_TWO</span><span class="w"> </span><span class="p">};</span><span class="w">  </span><span class="c1">// &lt;- wrong</span>

<span class="c1">// right</span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VALUE_ONE</span><span class="p">,</span>
<span class="w">    </span><span class="n">VALUE_TWO</span><span class="p">,</span><span class="w"> </span><span class="c1">// &lt;- force one-value-per-line</span>
<span class="p">};</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>AllowShortEnumsOnASingleLine: false <a class="reference internal" href="index.html#clang11" id="id13">[clang11]</a></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="structures-and-typedefs">
<h5>Structures and typedefs<a class="headerlink" href="#structures-and-typedefs" title="Permalink to this headline">¶</a></h5>
<p>TODO</p>
</div>
<div class="section" id="switch-statements">
<h5>switch statements<a class="headerlink" href="#switch-statements" title="Permalink to this headline">¶</a></h5>
<p>Switch statements are indented like in the following example, so the 'case' is indented from the switch:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ethh</span><span class="o">-&gt;</span><span class="n">eth_type</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ETHERNET_TYPE_IP</span><span class="p">:</span>
<span class="w">        </span><span class="n">DecodeIPV4</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="n">dtv</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">pkt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ETHERNET_HEADER_LEN</span><span class="p">,</span>
<span class="w">                   </span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ETHERNET_HEADER_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">pq</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<p>Fall through cases will be commented with <code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">fall</span> <span class="pre">through</span> <span class="pre">*/</span></code>. E.g.:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">suri</span><span class="o">-&gt;</span><span class="n">run_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">RUNMODE_PCAP_DEV</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">RUNMODE_AFP_DEV</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">RUNMODE_PFRING</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* find payload for interface and use it */</span>
<span class="w">        </span><span class="n">default_packet_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetIfaceMaxPacketSize</span><span class="p">(</span><span class="n">suri</span><span class="o">-&gt;</span><span class="n">pcap_dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">default_packet_size</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/* fall through */</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">default_packet_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_PACKET_SIZE</span><span class="p">;</span>
</pre></div>
</div>
<p>Do not put short case labels on one line.
Put opening brace on same line as case statement.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bla</span><span class="p">();</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span>
<span class="w">        </span><span class="n">blu</span><span class="p">();</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">gugus</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>IndentCaseLabels: true</li>
<li>IndentCaseBlocks: false <a class="reference internal" href="index.html#clang11" id="id14">[clang11]</a></li>
<li>AllowShortCaseLabelsOnASingleLine: false <a class="reference internal" href="index.html#llvm" id="id15">[llvm]</a></li>
<li>BreakBeforeBraces: Custom <a class="reference internal" href="index.html#breakbeforebraces" id="id16">[breakbeforebraces]</a></li>
<li>BraceWrapping:<ul>
<li>AfterCaseLabel:  false (default)</li>
</ul>
</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="const">
<h5>const<a class="headerlink" href="#const" title="Permalink to this headline">¶</a></h5>
<p>TODO</p>
</div>
<div class="section" id="goto">
<h5>goto<a class="headerlink" href="#goto" title="Permalink to this headline">¶</a></h5>
<p>Goto statements should be used with care. Generally, we use it primarily for error handling. E.g.:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">DetectFileextData</span><span class="w"> </span><span class="o">*</span><span class="nf">DetectFileextParse</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DetectFileextData</span><span class="w"> </span><span class="o">*</span><span class="n">fileext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">fileext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCMalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DetectFileextData</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fileext</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">fileext</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">DetectFileextData</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DetectContentDataParse</span><span class="p">(</span><span class="s">&quot;fileext&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fileext</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fileext</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fileext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fileext</span><span class="p">;</span>

<span class="nl">error</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fileext</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="n">DetectFileextFree</span><span class="p">(</span><span class="n">fileext</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Put goto labels at brace level.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">goto_style_nested</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foo</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">label1</span><span class="p">:</span>
<span class="w">        </span><span class="n">bar</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="nl">label2</span><span class="p">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>IndentGotoLabels: true (default) <a class="reference internal" href="index.html#clang10" id="id17">[clang10]</a></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="includes">
<h5>Includes<a class="headerlink" href="#includes" title="Permalink to this headline">¶</a></h5>
<p>TODO</p>
<p>A .c file shall include it's own header first.</p>
<dl class="docutils">
<dt>clang-format:</dt>
<dd><ul class="first last simple">
<li>SortIncludes: false</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="unittests">
<h5>Unittests<a class="headerlink" href="#unittests" title="Permalink to this headline">¶</a></h5>
<p>When writing unittests that use a data array containing a protocol message, please put an explanatory comment that contain the readable content of the message</p>
<p>So instead of:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">SMTPProcessDataChunkTest02</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">mimemsg</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mh">0x45</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2D</span><span class="p">,</span><span class="w"> </span><span class="mh">0x56</span><span class="p">,</span><span class="w"> </span><span class="mh">0x65</span><span class="p">,</span><span class="w"> </span><span class="mh">0x72</span><span class="p">,</span>
</pre></div>
</div>
<p>you should have something like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">SMTPParserTest14</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* 220 mx.google.com ESMTP d15sm986283wfl.6&lt;CR&gt;&lt;LF&gt; */</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">welcome_reply</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">,</span>
</pre></div>
</div>
</div>
<div class="section" id="banned-functions">
<h5>Banned functions<a class="headerlink" href="#banned-functions" title="Permalink to this headline">¶</a></h5>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="39%" />
<col width="29%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">function</th>
<th class="head">replacement</th>
<th class="head">reason</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>strtok</td>
<td>strtok_r</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>sprintf</td>
<td>snprintf</td>
<td>unsafe</td>
</tr>
<tr class="row-even"><td>strcat</td>
<td>strlcat</td>
<td>unsafe</td>
</tr>
<tr class="row-odd"><td>strcpy</td>
<td>strlcpy</td>
<td>unsafe</td>
</tr>
<tr class="row-even"><td>strncpy</td>
<td>strlcat</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>strncat</td>
<td>strlcpy</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>strndup</td>
<td>&#160;</td>
<td>OS specific</td>
</tr>
<tr class="row-odd"><td>strchrnul</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>rand</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rand_r</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>index</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rindex</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>bzero</td>
<td>memset</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<p>Also, check the existing code. If yours is wildly different, it's wrong.
Example: <a class="reference external" href="https://github.com/oisf/suricata/blob/master/src/decode-ethernet.c">https://github.com/oisf/suricata/blob/master/src/decode-ethernet.c</a></p>
<p class="rubric">Footnotes</p>
<table class="docutils citation" frame="void" id="llvm" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[llvm]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id3">2</a>, <a class="fn-backref" href="#id5">3</a>, <a class="fn-backref" href="#id6">4</a>, <a class="fn-backref" href="#id9">5</a>, <a class="fn-backref" href="#id10">6</a>, <a class="fn-backref" href="#id15">7</a>)</em> Default LLVM clang-format Style</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="clang9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[clang9]</a></td><td>Requires clang 9</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="clang10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[clang10]</td><td><em>(<a class="fn-backref" href="#id7">1</a>, <a class="fn-backref" href="#id17">2</a>)</em> Requires clang 10</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="clang11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[clang11]</td><td><em>(<a class="fn-backref" href="#id8">1</a>, <a class="fn-backref" href="#id13">2</a>, <a class="fn-backref" href="#id14">3</a>)</em> Requires clang 11</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="breakbeforebraces" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[breakbeforebraces]</td><td><em>(<a class="fn-backref" href="#id4">1</a>, <a class="fn-backref" href="#id11">2</a>, <a class="fn-backref" href="#id16">3</a>)</em> BreakBeforeBraces: Mozilla is closest, but does not split empty functions/structs</td></tr>
</tbody>
</table>
</div>
</div>
<span id="document-devguide/codebase/fuzz-testing"></span><div class="section" id="fuzz-testing">
<h4>Fuzz Testing<a class="headerlink" href="#fuzz-testing" title="Permalink to this headline">¶</a></h4>
<p>To enable fuzz targets compilation, add <cite>--enable-fuzztargets</cite> to configure.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This changes various parts of Suricata making the <cite>suricata</cite> binary
unsafe for production use.</p>
</div>
<p>The targets can be used with libFuzzer, AFL and other fuzz platforms.</p>
<div class="section" id="running-the-fuzzers">
<h5>Running the Fuzzers<a class="headerlink" href="#running-the-fuzzers" title="Permalink to this headline">¶</a></h5>
<p>TODO. For now see src/tests/fuzz/README</p>
<div class="section" id="reproducing-issues">
<h6>Reproducing issues<a class="headerlink" href="#reproducing-issues" title="Permalink to this headline">¶</a></h6>
</div>
</div>
<div class="section" id="extending-coverage">
<h5>Extending Coverage<a class="headerlink" href="#extending-coverage" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="adding-fuzz-targets">
<h5>Adding Fuzz Targets<a class="headerlink" href="#adding-fuzz-targets" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="oss-fuzz">
<h5>Oss-Fuzz<a class="headerlink" href="#oss-fuzz" title="Permalink to this headline">¶</a></h5>
<p>Suricata is continuously fuzz tested in Oss-Fuzz. See <a class="reference external" href="https://github.com/google/oss-fuzz/tree/master/projects/suricata">https://github.com/google/oss-fuzz/tree/master/projects/suricata</a></p>
</div>
</div>
<span id="document-devguide/codebase/testing"></span><div class="section" id="testing-suricata">
<h4><a class="toc-backref" href="#id2">Testing Suricata</a><a class="headerlink" href="#testing-suricata" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#testing-suricata" id="id2">Testing Suricata</a><ul>
<li><a class="reference internal" href="#general-concepts" id="id3">General Concepts</a></li>
<li><a class="reference internal" href="#unit-tests" id="id4">Unit tests</a><ul>
<li><a class="reference internal" href="#code-examples" id="id5">Code Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1" id="id6">Suricata-Verify</a></li>
<li><a class="reference internal" href="#generating-input" id="id7">Generating Input</a><ul>
<li><a class="reference internal" href="#using-real-traffic" id="id8">Using real traffic</a></li>
<li><a class="reference internal" href="#crafting-input-samples-with-scapy" id="id9">Crafting input samples with Scapy</a></li>
<li><a class="reference internal" href="#other-examples-from-our-suricata-verify-tests" id="id10">Other examples from our Suricata-Verify tests:</a></li>
<li><a class="reference internal" href="#finding-capture-samples" id="id11">Finding Capture Samples</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="general-concepts">
<h5><a class="toc-backref" href="#id3">General Concepts</a><a class="headerlink" href="#general-concepts" title="Permalink to this headline">¶</a></h5>
<p>There are a few ways of testing Suricata:</p>
<ul>
<li><p class="first"><strong>Unit tests</strong>: for independently checking specific functions or portions of code. This guide has specific sections to
further explain those, for C and Rust;</p>
</li>
<li><p class="first"><a class="reference external" href="https://github.com/OISF/suricata-verify">Suricata-Verify</a>: those are used to check more complex behavior, like the log output or the alert counts for a given input, where that input is usually comprised of several packets;</p>
</li>
<li><p class="first"><strong>Static and dynamic analysis tools</strong>: to help in finding bugs, memory leaks and other issues (like     <a class="reference external" href="https://clang-analyzer.llvm.org/scan-build.html#scanbuild_basicusage">scan-build</a>, from <cite>clang</cite>,     which is also used for our C formatting checks; or ASAN, which checks for memory issues);</p>
</li>
<li><p class="first"><strong>Fuzz testing</strong>: especially good for uncovering existing, often non-trivial bugs. For more on how to fuzz test Suricata, check <a class="reference internal" href="index.html#document-devguide/codebase/fuzz-testing"><span class="doc">Fuzz Testing</span></a>;</p>
</li>
<li><p class="first"><strong>CI checks</strong>: each PR submitted to the project's public repositories will be run against a suit of Continuous Integration
workflows, as part of our QA process. Those cover: formatting and commit checks; fuzz tests (CI Fuzz), and several  builds. See our <a class="reference external" href="https://github.com/OISF/suricata/tree/master/.github/workflows">github workflows</a> for details and those in
action at <a class="reference external" href="https://github.com/OISF/suricata/actions">https://github.com/OISF/suricata/actions</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you can run unit tests or other checks and report failures in our <a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/issues">issue tracker</a>, that is rather useful and appreciated!</p>
</div>
</li>
</ul>
<p>The focus of this document are Unit tests and Suricata-Verify tests, especially on offering some guidance regarding when to use each type of test, and how to prepare input
for them.</p>
</div>
<div class="section" id="unit-tests">
<h5><a class="toc-backref" href="#id4">Unit tests</a><a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h5>
<p>Use these to check that specific functions behave as expected, in success and in failure scenarios. Specially useful
during development, for nom parsers in the Rust codebase, for instance, or for checking that messages
or message parts of a protocol/stream are processed as they should.</p>
<p>To execute all unit tests (both from C and Rust code), as well as <code class="docutils literal notranslate"><span class="pre">libhtp</span></code> ones, from the Suricata main directory, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">check</span>
</pre></div>
</div>
<p>Check the Suricata Devguide on <a class="reference internal" href="index.html#document-devguide/codebase/unittests-c"><span class="doc">Unit Tests - C</span></a> or <a class="reference internal" href="index.html#document-devguide/codebase/unittests-rust"><span class="doc">Unit tests - Rust</span></a> for more on how to write and run unit tests,
given that the way to do so differs, depending on the language.</p>
<div class="section" id="code-examples">
<h6><a class="toc-backref" href="#id5">Code Examples</a><a class="headerlink" href="#code-examples" title="Permalink to this headline">¶</a></h6>
<p>An example from the <a class="reference external" href="https://github.com/OISF/suricata/blob/master/rust/src/dns/parser.rs#L417">DNS parser</a>. This
checks that the given raw input (note the comments indicating what it means), once processed by <code class="docutils literal notranslate"><span class="pre">dns_parse_name</span></code> yields
the expected result, including the unparsed portion.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="sd">/// Parse a simple name with no pointers.</span>
<span class="cp">#[test]</span>
<span class="k">fn</span> <span class="nf">test_dns_parse_name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span>
<span class="w">                                            </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x63</span><span class="p">,</span><span class="w"> </span><span class="cm">/* .......c */</span>
<span class="w">        </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x69</span><span class="p">,</span><span class="w"> </span><span class="mh">0x65</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x74</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x63</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="cm">/* lient-cf */</span>
<span class="w">        </span><span class="mh">0x07</span><span class="p">,</span><span class="w"> </span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x72</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="cm">/* .dropbox */</span>
<span class="w">        </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="mh">0x63</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="cm">/* .com.... */</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">expected_remainder</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dns_parse_name</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="s">&quot;client-cf.dropbox.com&quot;</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name</span><span class="p">[</span><span class="o">..</span><span class="p">]);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">expected_remainder</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From the C side, <code class="docutils literal notranslate"><span class="pre">decode-ethernet.c</span></code> offers an good example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Test a DCE ethernet frame that is too small.</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">DecodeEthernetTestDceTooSmall</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">raw_eth</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x94</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span>
<span class="w">        </span><span class="mh">0x94</span><span class="p">,</span><span class="w"> </span><span class="mh">0x56</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">Packet</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PacketGetFromAlloc</span><span class="p">();</span>
<span class="w">    </span><span class="n">FAIL_IF_NULL</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">ThreadVars</span><span class="w"> </span><span class="n">tv</span><span class="p">;</span>
<span class="w">    </span><span class="n">DecodeThreadVars</span><span class="w"> </span><span class="n">dtv</span><span class="p">;</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtv</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">DecodeThreadVars</span><span class="p">));</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ThreadVars</span><span class="p">));</span>

<span class="w">    </span><span class="n">DecodeEthernet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtv</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">raw_eth</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">raw_eth</span><span class="p">));</span>

<span class="w">    </span><span class="n">FAIL_IF_NOT</span><span class="p">(</span><span class="n">ENGINE_ISSET_EVENT</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">DCE_PKT_TOO_SMALL</span><span class="p">));</span>

<span class="w">    </span><span class="n">PacketFree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">PASS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id1">
<h5><a class="toc-backref" href="#id6">Suricata-Verify</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<p>As mentioned above, these tests are used to check more complex behavior that involve a complete flow, with exchange of requests and responses. This can be done in an easier and more straightforward way,
since one doesn't have to simulate the network traffic and Suricata engine mechanics - one simply runs it, with the desired input packet capture,
configuration and checks.</p>
<p>A Suricata-verify test can help to ensure that code refactoring doesn't affect protocol logs, or signature detection,
for instance, as this could have a major impact to Suricata users and integrators.</p>
<p>For simpler tests, providing the pcap input is enough. But it is also possible to provide Suricata rules to be
inspected, and have Suricata Verify match for alerts and specific events.</p>
<p>Refer to the <a class="reference external" href="https://github.com/OISF/suricata-verify#readme">Suricata Verify readme</a> for details on how to create
this type of test. It suffices to have a packet capture representative of the behavior one wants to test, and then
follow the steps described there.</p>
<p>The Git repository for the Suricata Verify tests is a great source for examples, like the <a class="reference external" href="https://github.com/OISF/suricata-verify/tree/master/tests/app-layer-template">app-layer-template</a> one.</p>
</div>
<div class="section" id="generating-input">
<h5><a class="toc-backref" href="#id7">Generating Input</a><a class="headerlink" href="#generating-input" title="Permalink to this headline">¶</a></h5>
<div class="section" id="using-real-traffic">
<h6><a class="toc-backref" href="#id8">Using real traffic</a><a class="headerlink" href="#using-real-traffic" title="Permalink to this headline">¶</a></h6>
<p>Having a packet capture for the desired protocol you want to test, open it in <a class="reference external" href="https://www.wireshark.org/">Wireshark</a>, and select the specific
packet chosen for the test input, then use the Wireshark option <code class="docutils literal notranslate"><span class="pre">Follow</span> <span class="pre">[TCP/UDP/HTTP/HTTP2/QUIC]</span> <span class="pre">Stream</span></code>. This allows for inspecting the whole network traffic stream in a different window.
There, it's possible to choose to <code class="docutils literal notranslate"><span class="pre">Show</span> <span class="pre">and</span> <span class="pre">save</span> <span class="pre">data</span> <span class="pre">as</span></code> <code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">Arrays</span></code>, as well as to select if one wants to see the whole conversation or just <strong>client</strong> or <strong>server</strong> packets.
It is also possible to reach the same effect by accessing the <strong>Analyze-&gt;Follow-&gt;TCP Stream</strong> top menu in Wireshark.
(There are other stream options, the available one will depend on the type of network traffic captured).</p>
<p>This option will show the packet data as hexadecimal compatible with C-array style, and easily adapted for Rust,
as well. As shown in the image:</p>
<img alt="_images/InputCaptureExample.png" src="_images/InputCaptureExample.png" />
<p>Wireshark can be also used to <a class="reference external" href="https://gitlab.com/wireshark/wireshark/-/wikis/CaptureSetup">capture sample network traffic</a> and generate pcap files.</p>
</div>
<div class="section" id="crafting-input-samples-with-scapy">
<h6><a class="toc-backref" href="#id9">Crafting input samples with Scapy</a><a class="headerlink" href="#crafting-input-samples-with-scapy" title="Permalink to this headline">¶</a></h6>
<p>It is also possible to use Scapy to create specific traffic: <a class="reference external" href="https://scapy.readthedocs.io/en/latest/usage.html">Scapy usage</a></p>
<p>Suricata-verify tests have several examples of pcaps generated in such a way. Look for Python scripts like the one used
for the <a class="reference external" href="https://github.com/OISF/suricata-verify/blob/master/tests/dcerpc/dcerpc-udp-scapy/dcerpc_udp_scapy.py">dce-udp-scapy</a>.</p>
</div>
<div class="section" id="other-examples-from-our-suricata-verify-tests">
<h6><a class="toc-backref" href="#id10">Other examples from our Suricata-Verify tests:</a><a class="headerlink" href="#other-examples-from-our-suricata-verify-tests" title="Permalink to this headline">¶</a></h6>
<p>Going through Suricata-Verify tests <cite>readme</cite> files it is also possible to find an assorted collection of pcap generation possibilities, some with explanation on the how-tos. To list a few:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/OISF/suricata-verify/blob/master/tests/http2-range/README.md">http2-range</a></li>
<li><a class="reference external" href="https://github.com/OISF/suricata-verify/blob/master/tests/http-range/README.md">http-range</a></li>
<li><a class="reference external" href="https://github.com/OISF/suricata-verify/blob/master/tests/smb2-delete/README.md">smb2-delete</a></li>
<li><a class="reference external" href="https://github.com/OISF/suricata-verify/blob/master/tests/smtp-rset/README.md">smtp-rset</a></li>
<li><a class="reference external" href="https://github.com/OISF/suricata-verify/blob/master/tests/http-auth-unrecognized/README.md">http-auth-unrecognized</a></li>
</ul>
</div>
<div class="section" id="finding-capture-samples">
<h6><a class="toc-backref" href="#id11">Finding Capture Samples</a><a class="headerlink" href="#finding-capture-samples" title="Permalink to this headline">¶</a></h6>
<p>If you can't capture traffic for the desired protocol from live traffic, or craft something up, you can try finding the type of traffic you
are interested in in public data sets. There's a thread for <a class="reference external" href="https://forum.suricata.io/t/sharing-good-sources-of-sample-captures/1766/4">Sharing good sources of sample captures</a> in our forum.</p>
</div>
</div>
</div>
<span id="document-devguide/codebase/unittests-c"></span><div class="section" id="unit-tests-c">
<h4>Unit Tests - C<a class="headerlink" href="#unit-tests-c" title="Permalink to this headline">¶</a></h4>
<p>Unit tests are a great way to create tests that can check the internal state
of parsers, structures and other objects.</p>
<p>Tests should:</p>
<ul class="simple">
<li>use <code class="docutils literal notranslate"><span class="pre">FAIL</span></code>/<code class="docutils literal notranslate"><span class="pre">PASS</span></code> macros</li>
<li>be deterministic</li>
<li>not leak memory on <code class="docutils literal notranslate"><span class="pre">PASS</span></code></li>
<li>not use conditions</li>
</ul>
<p>Unit tests are used by developers of Suricata and advanced users who would like to contribute by debugging and testing the engine.
Unit tests are small pieces (units) of code which check certain code functionalities in Suricata. If Suricata's code is modified, developers can run unit tests to see if there are any unforeseen effects on other parts of the engine's code.
Unit tests will not be compiled with Suricata by default.
If you would like to compile Suricata with unit tests, enter the following during the configure-stage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">unittests</span>
</pre></div>
</div>
<p>The unit tests specific command line options can be found at <a class="reference external" href="https://docs.suricata.io/en/suricata-6.0.3/command-line-options.html#unit-tests">Command Line Options</a>.</p>
<p>Example:
You can run tests specifically on flowbits. This is how you should do that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suricata</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">U</span> <span class="n">flowbit</span>
</pre></div>
</div>
<p>It is highly appreciated if you would run unit tests and report failing tests in our <a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/issues">issue tracker</a>.</p>
<p>If you want more info about the unittests, regular debug mode can help. This is enabled by adding the configure option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">debug</span>
</pre></div>
</div>
<p>Then, set the debug level from the command-line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SC_LOG_LEVEL</span><span class="o">=</span><span class="n">Debug</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">u</span>
</pre></div>
</div>
<p>This will be very verbose. You can also add the <code class="docutils literal notranslate"><span class="pre">SC_LOG_OP_FILTER</span></code> to limit the output, it is grep-like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SC_LOG_LEVEL</span><span class="o">=</span><span class="n">Debug</span> <span class="n">SC_LOG_OP_FILTER</span><span class="o">=</span><span class="s2">&quot;(something|somethingelse)&quot;</span> <span class="n">suricata</span> <span class="o">-</span><span class="n">u</span>
</pre></div>
</div>
<p>This example will show all lines (debug, info, and all other levels) that contain either something or something else.
Keep in mind the <a class="reference external" href="https://docs.suricata.io/en/latest/manpages/suricata.html#id1">log level</a>  precedence: if you choose <em>Info</em> level, for instance, Suricata won't show messages from the other levels.</p>
<div class="section" id="writing-unit-tests-c-codebase">
<h5>Writing Unit Tests - C codebase<a class="headerlink" href="#writing-unit-tests-c-codebase" title="Permalink to this headline">¶</a></h5>
<p>Suricata unit tests are somewhat different in C and in Rust. In C, they are comprised of a function with no arguments and returning 0 for failure or 1 for success. Instead of explicitly returning a value, FAIL_* and PASS macros should be used. For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MyUnitTest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">FAIL_IF</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">FAIL_IF_NOT</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">FAIL_IF_NOT_NULL</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">FAIL_IF_NULL</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="n">PASS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each unit test needs to be registered with <code class="docutils literal notranslate"><span class="pre">UtRegisterTest()</span></code>. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UtRegisterTest</span><span class="p">(</span><span class="s2">&quot;MyUnitTest&quot;</span><span class="p">,</span> <span class="n">MyUnitTest</span><span class="p">);</span>
</pre></div>
</div>
<p>where the first argument is the name of the test, and the second argument is the function. Existing modules should already have a function that registers its unit tests. Otherwise the unit tests will need to be registered. Look for a module similar to your new module to see how best to register the unit tests or ask the development team for help.</p>
<div class="section" id="examples">
<h6>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h6>
<p>From <code class="docutils literal notranslate"><span class="pre">conf-yaml-loader.c</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Test that a configuration section is overridden but subsequent</span>
<span class="cm"> * occurrences.</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">ConfYamlOverrideTest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">config</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="s">&quot;%YAML 1.1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;---</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;some-log-dir: /var/log</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;some-log-dir: /tmp</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;parent:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  child0:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;    key: value</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;parent:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  child1:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;    key: value</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">;</span>

<span class="w">    </span><span class="n">ConfCreateContextBackup</span><span class="p">();</span>
<span class="w">    </span><span class="n">ConfInit</span><span class="p">();</span>

<span class="w">    </span><span class="n">FAIL_IF</span><span class="p">(</span><span class="n">ConfYamlLoadString</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">FAIL_IF_NOT</span><span class="p">(</span><span class="n">ConfGet</span><span class="p">(</span><span class="s">&quot;some-log-dir&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">));</span>
<span class="w">    </span><span class="n">FAIL_IF</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/tmp&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Test that parent.child0 does not exist, but child1 does. */</span>
<span class="w">    </span><span class="n">FAIL_IF_NOT_NULL</span><span class="p">(</span><span class="n">ConfGetNode</span><span class="p">(</span><span class="s">&quot;parent.child0&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">FAIL_IF_NOT</span><span class="p">(</span><span class="n">ConfGet</span><span class="p">(</span><span class="s">&quot;parent.child1.key&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">));</span>
<span class="w">    </span><span class="n">FAIL_IF</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">ConfDeInit</span><span class="p">();</span>
<span class="w">    </span><span class="n">ConfRestoreContextBackup</span><span class="p">();</span>

<span class="w">    </span><span class="n">PASS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">detect-ike-chosen-sa.c</span></code>, it is possible to see the freeing of resources (<code class="docutils literal notranslate"><span class="pre">DetectIkeChosenSaFree</span></code>) and the
function that should group all the <code class="docutils literal notranslate"><span class="pre">UtRegisterTest</span></code> calls:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifdef UNITTESTS</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">IKEChosenSaParserTest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DetectIkeChosenSaData</span><span class="w"> </span><span class="o">*</span><span class="n">de</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">de</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DetectIkeChosenSaParse</span><span class="p">(</span><span class="s">&quot;alg_hash=2&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">FAIL_IF_NULL</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
<span class="w">    </span><span class="n">FAIL_IF</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">sa_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">FAIL_IF</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">sa_type</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;alg_hash&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">DetectIkeChosenSaFree</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">de</span><span class="p">);</span>
<span class="w">    </span><span class="n">PASS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* UNITTESTS */</span>

<span class="kt">void</span><span class="w"> </span><span class="n">IKEChosenSaRegisterTests</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef UNITTESTS</span>
<span class="w">    </span><span class="n">UtRegisterTest</span><span class="p">(</span><span class="s">&quot;IKEChosenSaParserTest&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">IKEChosenSaParserTest</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* UNITTESTS */</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-devguide/codebase/unittests-rust"></span><div class="section" id="unit-tests-rust">
<h4>Unit tests - Rust<a class="headerlink" href="#unit-tests-rust" title="Permalink to this headline">¶</a></h4>
<div class="section" id="rust-tests-with-cargo-check">
<h5>Rust tests with Cargo check<a class="headerlink" href="#rust-tests-with-cargo-check" title="Permalink to this headline">¶</a></h5>
<p>Rust offers a built-in tool for running unit and integration tests. To do so, one makes usage of:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">[</span><span class="n">options</span><span class="p">][</span><span class="n">testname</span><span class="p">][</span><span class="o">--</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">options</span><span class="p">]</span>
</pre></div>
</div>
<p><a class="reference external" href="https://doc.rust-lang.org/cargo/commands/cargo-test.html">The Cargo Book</a> explains all options in more detail.</p>
<p>For testing a specific Rust module from Suricata, it suffices to go to the <code class="docutils literal notranslate"><span class="pre">rust</span></code> directory and run the above command,
specifying the desired module (like <code class="docutils literal notranslate"><span class="pre">http2</span></code>).</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">http2</span>
</pre></div>
</div>
<p>The line above will make <em>rustc</em> compile the Rust side of Suricata and run unit tests in the <code class="docutils literal notranslate"><span class="pre">http2</span></code> rust module.</p>
<p>For running all Suricata unit tests from our Rust codebase, just run <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code>.</p>
</div>
<div class="section" id="adding-unit-tests">
<h5>Adding unit tests<a class="headerlink" href="#adding-unit-tests" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want to understand <em>when</em> to use a unit test, please read the devguide section on <a class="reference internal" href="index.html#document-devguide/codebase/testing"><span class="doc">Testing Suricata</span></a>.</p>
</div>
</div></blockquote>
<p>In general, it is preferable to have the unit tests in the same file that they test. At the end of the file, after all other functions. Add a <code class="docutils literal notranslate"><span class="pre">tests</span></code> module, if there isn't one yet, and add the <code class="docutils literal notranslate"><span class="pre">#[test]</span></code> attribute before the unit test
function. It is also necessary to import (<code class="docutils literal notranslate"><span class="pre">use</span></code>) the module to test, as well as any other modules used. As seen in the example below:</p>
<div class="section" id="example">
<h6>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h6>
<p>From <code class="docutils literal notranslate"><span class="pre">nfs</span> <span class="pre">&gt;</span> <span class="pre">rpc_records.rs</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">nfs</span>::<span class="n">rpc_records</span>::<span class="o">*</span><span class="p">;</span>
<span class="w">     </span><span class="k">use</span><span class="w"> </span><span class="n">nom</span>::<span class="nb">Err</span>::<span class="n">Incomplete</span><span class="p">;</span>
<span class="w">     </span><span class="k">use</span><span class="w"> </span><span class="n">nom</span>::<span class="n">Needed</span>::<span class="n">Size</span><span class="p">;</span>

<span class="w">     </span><span class="cp">#[test]</span>
<span class="w">     </span><span class="k">fn</span> <span class="nf">test_partial_input_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span>
<span class="w">             </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9c</span><span class="p">,</span><span class="w"> </span><span class="c1">// flags</span>
<span class="w">             </span><span class="mh">0x8e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="c1">// xid</span>
<span class="w">             </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="c1">// msgtype</span>
<span class="w">             </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="c1">// rpcver</span>
<span class="w">             </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="c1">// program</span>
<span class="w">             </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="c1">// progver</span>
<span class="w">             </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="c1">// procedure</span>
<span class="w">         </span><span class="p">];</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RpcRequestPacketPartial</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">hdr</span>: <span class="nc">RpcPacketHeader</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="n">frag_is_last</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">                     </span><span class="n">frag_len</span>: <span class="mi">156</span><span class="p">,</span>
<span class="w">                     </span><span class="n">xid</span>: <span class="mi">2384986750</span><span class="p">,</span>
<span class="w">                     </span><span class="n">msgtype</span>: <span class="mi">1</span>
<span class="w">                 </span><span class="p">},</span>
<span class="w">             </span><span class="n">rpcver</span>: <span class="mi">2</span><span class="p">,</span>
<span class="w">             </span><span class="n">program</span>: <span class="mi">3</span><span class="p">,</span>
<span class="w">             </span><span class="n">progver</span>: <span class="mi">4</span><span class="p">,</span>
<span class="w">             </span><span class="n">procedure</span>: <span class="mi">5</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_rpc_request_partial</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="w">         </span><span class="k">match</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="nb">Ok</span><span class="p">((</span><span class="n">rem</span><span class="p">,</span><span class="w"> </span><span class="n">hdr</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">rem</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">                 </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">);</span>
<span class="w">             </span><span class="p">},</span>
<span class="w">             </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;failed {:?}&quot;</span><span class="p">,</span><span class="n">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once that is done, Rust should recognize the new test. If you want to check a single test, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cargo</span> <span class="n">test</span> <span class="n">module</span><span class="p">::</span><span class="n">file_name</span><span class="p">::</span><span class="n">tests</span><span class="p">::</span><span class="n">test_name</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">tests</span></code> refers to <code class="docutils literal notranslate"><span class="pre">mod</span> <span class="pre">tests</span></code>. If you know the test name is unique, you can even run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cargo</span> <span class="n">test</span> <span class="n">test_name</span>
</pre></div>
</div>
<p>Following the same idea, it is also possible to test specific modules or submodules. For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cargo</span> <span class="n">test</span> <span class="n">nfs</span><span class="p">::</span><span class="n">rpc_records</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-devguide/internals/index"></span><div class="section" id="suricata-internals">
<h3>Suricata Internals<a class="headerlink" href="#suricata-internals" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-devguide/internals/pipeline/index"></span><div class="section" id="packet-pipeline">
<h4>Packet Pipeline<a class="headerlink" href="#packet-pipeline" title="Permalink to this headline">¶</a></h4>
</div>
<span id="document-devguide/internals/threading/index"></span><div class="section" id="threading">
<h4>Threading<a class="headerlink" href="#threading" title="Permalink to this headline">¶</a></h4>
</div>
<span id="document-devguide/internals/datastructs/index"></span><div class="section" id="important-data-structures">
<h4>Important Data Structures<a class="headerlink" href="#important-data-structures" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<p>This section explains the most important Suricata Data structures.</p>
<p>For a complete overview, see the doxygen: <a class="reference external" href="https://doxygen.openinfosecfoundation.org">https://doxygen.openinfosecfoundation.org</a></p>
</div>
</div>
<span id="document-devguide/internals/engines/index"></span><div class="section" id="engines">
<h4>Engines<a class="headerlink" href="#engines" title="Permalink to this headline">¶</a></h4>
<div class="section" id="flow">
<h5>Flow<a class="headerlink" href="#flow" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="stream">
<h5>Stream<a class="headerlink" href="#stream" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="defrag">
<h5>Defrag<a class="headerlink" href="#defrag" title="Permalink to this headline">¶</a></h5>
</div>
</div>
</div>
</div>
<span id="document-devguide/extending/index"></span><div class="section" id="extending-suricata">
<h3>Extending Suricata<a class="headerlink" href="#extending-suricata" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-devguide/extending/capture/index"></span><div class="section" id="packet-capture">
<h4>Packet Capture<a class="headerlink" href="#packet-capture" title="Permalink to this headline">¶</a></h4>
</div>
<span id="document-devguide/extending/decoder/index"></span><div class="section" id="packet-decoder">
<h4>Packet Decoder<a class="headerlink" href="#packet-decoder" title="Permalink to this headline">¶</a></h4>
</div>
<span id="document-devguide/extending/app-layer/index"></span><div class="section" id="app-layer">
<h4>App-Layer<a class="headerlink" href="#app-layer" title="Permalink to this headline">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-devguide/extending/app-layer/app-layer-frames"></span><div class="section" id="application-layer-frame-support">
<h5><a class="toc-backref" href="#id12">Application Layer Frame Support</a><a class="headerlink" href="#application-layer-frame-support" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#application-layer-frame-support" id="id12">Application Layer Frame Support</a><ul>
<li><a class="reference internal" href="#baseline" id="id13">Baseline</a></li>
<li><a class="reference internal" href="#general-concepts" id="id14">General Concepts</a></li>
<li><a class="reference internal" href="#adding-frame-support-to-a-parser" id="id15">Adding Frame Support to a Parser</a><ul>
<li><a class="reference internal" href="#basic-steps" id="id16">Basic steps</a></li>
<li><a class="reference internal" href="#implementation-examples-api-callbacks" id="id17">Implementation Examples &amp; API Callbacks</a><ul>
<li><a class="reference internal" href="#rust" id="id18">Rust</a></li>
<li><a class="reference internal" href="#c-code" id="id19">C code</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#visual-context" id="id20">Visual context</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="baseline">
<h6><a class="toc-backref" href="#id13">Baseline</a><a class="headerlink" href="#baseline" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://docs.suricata.io/en/latest/rules/intro.html">Suricata rules format</a></li>
</ul>
</div>
<div class="section" id="general-concepts">
<h6><a class="toc-backref" href="#id14">General Concepts</a><a class="headerlink" href="#general-concepts" title="Permalink to this headline">¶</a></h6>
<p>Frame support was introduced with Suricata 7.0. Up until 6.0.x, Suricata's architecture and state of parsers meant that the network traffic available to the detection engine was just a stream of data, without detail about higher level parsers.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Suricata, <em>Frame</em> is a generic term that can represent any unit of network data we are interested in, which could be comprised of one or several records of other, lower level protocol(s). Frames work as &quot;stream annotations&quot;, allowing Suricata to tell the detection engine what type of record exists at a specific offset in the stream.</p>
</div>
<p>The normal pipeline of detection in Suricata implied that:</p>
<ul class="simple">
<li>Certain rules could be quite costly performance-wise. This happened because the same stream could be inspected several times for different rules, since for certain signatures the detection is done when Suricata is still inspecting a lower level stream, not the application layer protocol (e.g., <em>TCP</em> traffic, in place of <em>SMB</em> one);</li>
<li>Rules could be difficult and tedious to write (and read), requiring that writers went in byte-detail to express matching on specific payload patterns.</li>
</ul>
<p>What the Frame support offers is the ability to &quot;point&quot; to a specific portion of stream and identify what type of traffic Suricata is looking at. Then, as the engine reassembles the stream, one can have &quot;read access&quot; to that portion of the stream, aggregating concepts like what type of application layer protocol that is, and differentiating between <code class="docutils literal notranslate"><span class="pre">header</span></code>, <code class="docutils literal notranslate"><span class="pre">data</span></code> or even protocol versions (<em>SMB1</em>, <em>SMB2</em>...).</p>
<p>The goal of the stream <em>Frame</em> is to expose application layer protocol <a class="reference external" href="https://en.wikipedia.org/wiki/Protocol_data_unit">PDUs</a> and other such arbitrary elements to the detection engine directly, instead of relying on Transactions. The main purpose is to bring <em>TCP data</em> processing times down by specialising/ filtering down traffic detection.</p>
</div>
<div class="section" id="adding-frame-support-to-a-parser">
<h6><a class="toc-backref" href="#id15">Adding Frame Support to a Parser</a><a class="headerlink" href="#adding-frame-support-to-a-parser" title="Permalink to this headline">¶</a></h6>
<p>The application layer parser exposes frames it supports to the detect engine, by tagging them as they're parsed. The rest works automatically.</p>
<p>In order to allow the engine to identify frames for records of a given application layer parser, thought must be given as to which frames make sense for the specific protocol you are handling. Some parsers may have clear <code class="docutils literal notranslate"><span class="pre">header</span></code> and <code class="docutils literal notranslate"><span class="pre">data</span></code> fields that form its <em>protocol data unit</em> (pdu). For others, the distinction might be between <code class="docutils literal notranslate"><span class="pre">request</span></code> and <code class="docutils literal notranslate"><span class="pre">response</span></code>, only. Whereas for others it may make sense to have specific types of data. This is better understood by seeing the different types of frame keywords, which vary on a per-protocol basis.</p>
<p>It is also important to keep follow naming conventions when defining Frame Types. While a protocol may have strong naming standards for certain structures, do compare those with what Suricata already has registered:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">hdr</span></code>: used for the record header portion</li>
<li><code class="docutils literal notranslate"><span class="pre">data</span></code>: is used for the record data portion</li>
<li><code class="docutils literal notranslate"><span class="pre">pdu</span></code>: unless documented otherwise, means the whole record, comprising <code class="docutils literal notranslate"><span class="pre">hdr</span></code> and <code class="docutils literal notranslate"><span class="pre">data</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">request</span></code>: a message from a client to a server</li>
<li><code class="docutils literal notranslate"><span class="pre">response</span></code>: a message from a server to a client</li>
</ul>
<div class="section" id="basic-steps">
<h7><a class="toc-backref" href="#id16">Basic steps</a><a class="headerlink" href="#basic-steps" title="Permalink to this headline">¶</a></h7>
<p>Once the frame types that make sense for a given protocol are defined, the basic steps for adding them are:</p>
<ul class="simple">
<li>create an enum with the frame types;</li>
<li>identify the parsing function(s) where application layer records are parsed;</li>
<li>identify the correct moment to register the frames;</li>
<li>use the Frame API calls directly or build upon them and use your functions to register the frames;</li>
<li>register the relevant frame callbacks when registering the parser.</li>
</ul>
<p>Once these are done, you can enable frame eve-output to confirm that your frames are being properly registered. It is important to notice that some hard coded limits could influence what you see on the logs (max size of log output; type of logging for the payload, cf. <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/4988">https://redmine.openinfosecfoundation.org/issues/4988</a>).</p>
<p>If all the steps are successfully followed, you should be able to write a rule using the <em>frame</em> keyword and the frame types you have registered with the application layer parser.</p>
<p>Using the <em>SMB</em> parser as example, before frame support, a rule would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="o">...</span> <span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;|ff|SMB&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;some smb 1 issue&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>With frame support, one is able to do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">smb</span> <span class="o">...</span> <span class="n">flow</span><span class="p">:</span><span class="n">to_server</span><span class="p">;</span> <span class="n">frame</span><span class="p">:</span><span class="n">smb1</span><span class="o">.</span><span class="n">data</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span><span class="s2">&quot;some smb 1 issue&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="implementation-examples-api-callbacks">
<h7><a class="toc-backref" href="#id17">Implementation Examples &amp; API Callbacks</a><a class="headerlink" href="#implementation-examples-api-callbacks" title="Permalink to this headline">¶</a></h7>
<p>Though the steps are the same, there are a few differences when implementing frame support in Rust or in C. The following sections elaborate on that, as well as on the process itself. (Note that the code snippets have omitted portions of code that weren't so relevant to this document).</p>
<div class="section" id="rust">
<h8><a class="toc-backref" href="#id18">Rust</a><a class="headerlink" href="#rust" title="Permalink to this headline">¶</a></h8>
<p>This section shows how Frame support is added in Rust, using examples from the <a class="reference external" href="https://github.com/OISF/suricata/blob/master/rust/src/sip/sip.rs">SIP parser</a>, and the <a class="reference external" href="https://github.com/OISF/suricata/blob/master/rust/src/telnet/telnet.rs">telnet parser</a>.</p>
<p><strong>Define the frame types</strong>. The frame types are defined as an enum. In Rust, make sure to derive from the <code class="docutils literal notranslate"><span class="pre">AppLayerFrameType</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">rust/src/sip/sip.rs</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(AppLayerFrameType)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">SIPFrameType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Pdu</span><span class="p">,</span>
<span class="w">    </span><span class="n">RequestLine</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResponseLine</span><span class="p">,</span>
<span class="w">    </span><span class="n">RequestHeaders</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResponseHeaders</span><span class="p">,</span>
<span class="w">    </span><span class="n">RequestBody</span><span class="p">,</span>
<span class="w">    </span><span class="n">ResponseBody</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p><strong>Frame registering</strong>. Some understanding of the parser will be needed in order to find where the frames should be registered. It makes sense that it will happen when the input stream is being parsed into records. See when some pdu and request frames are created for SIP:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">rust/src/sip/sip.rs</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">parse_request</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">flow</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">core</span>::<span class="n">Flow</span><span class="p">,</span><span class="w"> </span><span class="n">stream_slice</span>: <span class="nc">StreamSlice</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream_slice</span><span class="p">.</span><span class="n">as_slice</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_pdu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">flow</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">stream_slice</span><span class="p">,</span>
<span class="w">        </span><span class="n">input</span><span class="p">,</span>
<span class="w">        </span><span class="n">input</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">        </span><span class="n">SIPFrameType</span>::<span class="n">Pdu</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">SCLogDebug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ts: pdu {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_pdu</span><span class="p">);</span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">sip_parse_request</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sip_frames_ts</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stream_slice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">request</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">new_tx</span><span class="p">(</span><span class="k">crate</span>::<span class="n">core</span>::<span class="n">Direction</span>::<span class="n">ToServer</span><span class="p">);</span>
<span class="w">            </span><span class="n">tx</span><span class="p">.</span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">req_line</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sip_take_line</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">tx</span><span class="p">.</span><span class="n">request_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req_line</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">transactions</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>when to create PDU frames</p>
<p class="last">The standard approach we follow for frame registration is that a frame <code class="docutils literal notranslate"><span class="pre">pdu</span></code> will always be created, regardless of parser status (in practice, before the parser is called). The other frames are then created when and if only the parser succeeds.</p>
</div>
<p><strong>Use the Frame API or build upon them as needed</strong>. These are the frame registration functions highlighted above:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">rust/src/sip/sip.rs</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">sip_frames_ts</span><span class="p">(</span><span class="n">flow</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">core</span>::<span class="n">Flow</span><span class="p">,</span><span class="w"> </span><span class="n">stream_slice</span>: <span class="kp">&amp;</span><span class="nc">StreamSlice</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="nc">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">oi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream_slice</span><span class="p">.</span><span class="n">as_slice</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">flow</span><span class="p">,</span>
<span class="w">        </span><span class="n">stream_slice</span><span class="p">,</span>
<span class="w">        </span><span class="n">oi</span><span class="p">,</span>
<span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="n">request_line_len</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">        </span><span class="n">SIPFrameType</span>::<span class="n">RequestLine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">SCLogDebug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ts: request_line {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_f</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">hi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oi</span><span class="p">[</span><span class="n">r</span><span class="p">.</span><span class="n">request_line_len</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="o">..</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">flow</span><span class="p">,</span>
<span class="w">        </span><span class="n">stream_slice</span><span class="p">,</span>
<span class="w">        </span><span class="n">hi</span><span class="p">,</span>
<span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="n">headers_len</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">        </span><span class="n">SIPFrameType</span>::<span class="n">RequestHeaders</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">SCLogDebug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ts: request_headers {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_f</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">body_len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">bi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oi</span><span class="p">[</span><span class="n">r</span><span class="p">.</span><span class="n">body_offset</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="o">..</span><span class="p">];</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="n">flow</span><span class="p">,</span>
<span class="w">            </span><span class="n">stream_slice</span><span class="p">,</span>
<span class="w">            </span><span class="n">bi</span><span class="p">,</span>
<span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="n">body_len</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">            </span><span class="n">SIPFrameType</span>::<span class="n">RequestBody</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">SCLogDebug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ts: request_body {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p><strong>Register relevant frame callbacks.</strong> As these are inferred from the <code class="docutils literal notranslate"><span class="pre">#[derive(AppLayerFrameType)]</span></code> statement, all that is needed is:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">rust/src/sip/sip.rs</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="n">get_frame_id_by_name</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">SIPFrameType</span>::<span class="n">ffi_id_from_name</span><span class="p">),</span>
<span class="n">get_frame_name_by_id</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">SIPFrameType</span>::<span class="n">ffi_name_from_id</span><span class="p">),</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>on frame_len</p>
<p class="last">For protocols which search for an end of frame char, like telnet, indicate unknown length by passing <code class="docutils literal notranslate"><span class="pre">-1</span></code>. Once the length is known, it must be updated. For those where length is a field in the record (e.g. <em>SIP</em>), the frame is set to match said length, even if that is bigger than the current input</p>
</div>
<p>The telnet parser has examples of using the Frame API directly for registering telnet frames, and also illustrates how that is done when length is not yet known:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">rust/src/telnet/telnet.rs</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">parse_request</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">flow</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Flow</span><span class="p">,</span><span class="w"> </span><span class="n">stream_slice</span>: <span class="kp">&amp;</span><span class="nc">StreamSlice</span><span class="p">,</span><span class="w"> </span><span class="n">input</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">AppLayerResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="o">!</span><span class="n">start</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">request_frame</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">request_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">                </span><span class="n">flow</span><span class="p">,</span>
<span class="w">                </span><span class="n">stream_slice</span><span class="p">,</span>
<span class="w">                </span><span class="n">start</span><span class="p">,</span>
<span class="w">                </span><span class="o">-</span><span class="mi">1_</span><span class="k">i64</span><span class="p">,</span>
<span class="w">                </span><span class="n">TelnetFrameType</span>::<span class="n">Pdu</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">request_specific_frame</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">is_ctl</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span>::<span class="n">peek_message_is_ctl</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">is_ctl</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">                        </span><span class="n">flow</span><span class="p">,</span>
<span class="w">                        </span><span class="n">stream_slice</span><span class="p">,</span>
<span class="w">                        </span><span class="n">start</span><span class="p">,</span>
<span class="w">                        </span><span class="o">-</span><span class="mi">1_</span><span class="k">i64</span><span class="p">,</span>
<span class="w">                        </span><span class="n">TelnetFrameType</span>::<span class="n">Ctl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span>
<span class="w">                        </span><span class="n">flow</span><span class="p">,</span>
<span class="w">                        </span><span class="n">stream_slice</span><span class="p">,</span>
<span class="w">                        </span><span class="n">start</span><span class="p">,</span>
<span class="w">                        </span><span class="o">-</span><span class="mi">1_</span><span class="k">i64</span><span class="p">,</span>
<span class="w">                        </span><span class="n">TelnetFrameType</span>::<span class="n">Data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
</pre></div>
</div>
</div>
<p>We then update length later on (note especially lines 3 and 10):</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">rust/src/telnet/telnet.rs</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-rust notranslate"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><span class="k">match</span><span class="w"> </span><span class="n">parser</span>::<span class="n">parse_message</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">((</span><span class="n">rem</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">consumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rem</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">rem</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;lockup&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rem</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">request_frame</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">frame</span><span class="p">.</span><span class="n">set_len</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span><span class="w"> </span><span class="n">consumed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">);</span>
</pre></div></td></tr></table></div>
</div>
</div>
<p>The Frame API calls parameters represent:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">flow</span></code>: dedicated data type, carries specific flow-related data</li>
<li><code class="docutils literal notranslate"><span class="pre">stream_slice</span></code>: dedicated data type, carries stream data, shown further bellow</li>
<li><code class="docutils literal notranslate"><span class="pre">frame_start</span></code>: a pointer to the start of the frame buffer in the stream (<code class="docutils literal notranslate"><span class="pre">cur_i</span></code> in the SMB code snippet)</li>
<li><code class="docutils literal notranslate"><span class="pre">frame_len</span></code>: what we expect the frame length to be (the engine may need to wait until it has enough data. See what is done in the telnet snippet request frames registering)</li>
<li><code class="docutils literal notranslate"><span class="pre">frame_type</span></code>: type of frame it's being registering (defined in an enum, as shown further above)</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">StreamSlice</span></code> contains the input data to the parser, alongside other Stream-related data important in parsing context. Definition  is found in <em>applayer.rs</em>:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">rust/src/applayer.rs</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">StreamSlice</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">input</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">input_len</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="sd">/// STREAM_* flags</span>
<span class="w">    </span><span class="n">flags</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">offset</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="c-code">
<h8><a class="toc-backref" href="#id19">C code</a><a class="headerlink" href="#c-code" title="Permalink to this headline">¶</a></h8>
<p>Implementing Frame support in C involves a bit more manual work, as one cannot make use of the Rust derives. Code snippets from the <em>HTTP</em> parser:</p>
<p>Defining the frame types with the enum means:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">src/app-layer-htp.c</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enum</span> <span class="n">HttpFrameTypes</span> <span class="p">{</span>
    <span class="n">HTTP_FRAME_REQUEST</span><span class="p">,</span>
    <span class="n">HTTP_FRAME_RESPONSE</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">SCEnumCharMap</span> <span class="n">http_frame_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span>
            <span class="s2">&quot;request&quot;</span><span class="p">,</span>
            <span class="n">HTTP_FRAME_REQUEST</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">,</span>
            <span class="n">HTTP_FRAME_RESPONSE</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<p>The HTTP parser uses the Frame registration functions from the C API (<code class="docutils literal notranslate"><span class="pre">app-layer-frames.c</span></code>) directly for registering request Frames. Here we also don't know the length yet. The <code class="docutils literal notranslate"><span class="pre">0</span></code> indicates flow direction: <code class="docutils literal notranslate"><span class="pre">toserver</span></code>, and <code class="docutils literal notranslate"><span class="pre">1</span></code> would be used for <code class="docutils literal notranslate"><span class="pre">toclient</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">src/app-layer-htp.c</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="n">AppLayerFrameNewByAbsoluteOffset</span><span class="p">(</span>
        <span class="n">hstate</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">,</span> <span class="n">hstate</span><span class="o">-&gt;</span><span class="nb">slice</span><span class="p">,</span> <span class="n">consumed</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HTTP_FRAME_REQUEST</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SCLogDebug</span><span class="p">(</span><span class="s2">&quot;frame %p/%&quot;</span> <span class="n">PRIi64</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="nb">id</span><span class="p">);</span>
    <span class="n">hstate</span><span class="o">-&gt;</span><span class="n">request_frame_id</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="nb">id</span><span class="p">;</span>
    <span class="n">AppLayerFrameSetTxId</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">HtpGetActiveRequestTxID</span><span class="p">(</span><span class="n">hstate</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Updating <code class="docutils literal notranslate"><span class="pre">frame-&gt;len</span></code> later:</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">src/app-layer-htp.c</span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">hstate</span><span class="o">-&gt;</span><span class="n">request_frame_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="n">AppLayerFrameGetById</span><span class="p">(</span><span class="n">hstate</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hstate</span><span class="o">-&gt;</span><span class="n">request_frame_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">const</span> <span class="n">uint64_t</span> <span class="n">request_size</span> <span class="o">=</span> <span class="n">abs_right_edge</span> <span class="o">-</span> <span class="n">hstate</span><span class="o">-&gt;</span><span class="n">last_request_data_stamp</span><span class="p">;</span>

        <span class="n">SCLogDebug</span><span class="p">(</span><span class="s2">&quot;HTTP request complete: data offset %&quot;</span> <span class="n">PRIu64</span> <span class="s2">&quot;, request_size %&quot;</span> <span class="n">PRIu64</span><span class="p">,</span>
                <span class="n">hstate</span><span class="o">-&gt;</span><span class="n">last_request_data_stamp</span><span class="p">,</span> <span class="n">request_size</span><span class="p">);</span>
        <span class="n">SCLogDebug</span><span class="p">(</span><span class="s2">&quot;frame %p/%&quot;</span> <span class="n">PRIi64</span> <span class="s2">&quot; setting len to  %&quot;</span> <span class="n">PRIu64</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="nb">id</span><span class="p">,</span>
                <span class="n">request_size</span><span class="p">);</span>
        <span class="n">frame</span><span class="o">-&gt;</span><span class="nb">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">int64_t</span><span class="p">)</span><span class="n">request_size</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Register relevant callbacks (note that the actual functions will also have to be written, for C):</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">src/app-layer-htp.c</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">AppLayerParserRegisterGetFrameFuncs</span><span class="p">(</span>
<span class="w">        </span><span class="n">IPPROTO_TCP</span><span class="p">,</span><span class="w"> </span><span class="n">ALPROTO_HTTP1</span><span class="p">,</span><span class="w"> </span><span class="n">HTTPGetFrameIdByName</span><span class="p">,</span><span class="w"> </span><span class="n">HTTPGetFrameNameById</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">GetFrameIdByName</span></code> functions can be &quot;probed&quot;, so they should not generate any output or that could be misleading (for instance, Suricata generating a log message stating that a valid frame type is unknown).</p>
</div>
</div>
</div>
</div>
<div class="section" id="visual-context">
<h6><a class="toc-backref" href="#id20">Visual context</a><a class="headerlink" href="#visual-context" title="Permalink to this headline">¶</a></h6>
<p><code class="docutils literal notranslate"><span class="pre">input</span></code> and <code class="docutils literal notranslate"><span class="pre">input_len</span></code> are used to calculate the proper offset, for storing the frame. The stream buffer slides forward, so frame offsets/frames have to be updated. The <cite>relative offset</cite> (<code class="docutils literal notranslate"><span class="pre">rel_offset</span></code>) reflects that:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">Start</span><span class="p">:</span>
<span class="p">[</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">]</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="n">frame</span><span class="w">   </span><span class="p">...........]</span>
<span class="w">   </span><span class="nl">rel_offset</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="nl">len</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span>

<span class="nl">Slide</span><span class="p">:</span>
<span class="w">     </span><span class="p">[</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">]</span>
<span class="p">[</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="p">....</span><span class="w">          </span><span class="p">.]</span>
<span class="w"> </span><span class="nl">rel_offset</span><span class="p">:</span><span class="w"> </span><span class="mi">-10</span>
<span class="w"> </span><span class="nl">len</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span>

<span class="nl">Slide</span><span class="p">:</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">]</span>
<span class="p">[</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="p">...........</span><span class="w">    </span><span class="p">]</span>
<span class="w"> </span><span class="nl">rel_offset</span><span class="p">:</span><span class="w"> </span><span class="mi">-16</span>
<span class="w"> </span><span class="nl">len</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span>
</pre></div>
</div>
<p>The way the engine handles stream frames can be illustrated as follows:</p>
<a class="reference internal image-reference" href="_images/StreamFrames.png"><img alt="_images/StreamFrames.png" src="_images/StreamFrames.png" style="width: 714.4000000000001px; height: 649.6px;" /></a>
</div>
</div>
<span id="document-devguide/extending/app-layer/parser"></span><div class="section" id="parsers">
<h5>Parsers<a class="headerlink" href="#parsers" title="Permalink to this headline">¶</a></h5>
<div class="section" id="callbacks">
<h6>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h6>
<p>The API calls callbacks that are registered at the start of the program.</p>
<p>The function prototype is:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="n">AppLayerResult</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">AppLayerParserFPtr</span><span class="p">)(</span><span class="n">Flow</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">protocol_state</span><span class="p">,</span>
<span class="w">        </span><span class="n">AppLayerParserState</span><span class="w"> </span><span class="o">*</span><span class="n">pstate</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">buf_len</span><span class="p">,</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">local_storage</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="examples">
<h7>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h7>
<p>A C example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">AppLayerResult</span><span class="w"> </span><span class="nf">HTPHandleRequestData</span><span class="p">(</span><span class="n">Flow</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">htp_state</span><span class="p">,</span>
<span class="w">        </span><span class="n">AppLayerParserState</span><span class="w"> </span><span class="o">*</span><span class="n">pstate</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">input_len</span><span class="p">,</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">local_data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</pre></div>
</div>
<p>In Rust, the callbacks are similar.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">rs_dns_parse_response_tcp</span><span class="p">(</span><span class="n">_flow</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">core</span>::<span class="n">Flow</span><span class="p">,</span>
<span class="w">        </span><span class="n">state</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">raw</span>::<span class="n">c_void</span><span class="p">,</span>
<span class="w">        </span><span class="n">_pstate</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">raw</span>::<span class="n">c_void</span><span class="p">,</span>
<span class="w">        </span><span class="n">input</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">input_len</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">_data</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">raw</span>::<span class="n">c_void</span><span class="p">,</span>
<span class="w">        </span><span class="n">_flags</span>: <span class="kt">u8</span><span class="p">)</span>
-&gt; <span class="nc">AppLayerResult</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="return-types">
<h6>Return Types<a class="headerlink" href="#return-types" title="Permalink to this headline">¶</a></h6>
<p>Parsers return the type <cite>AppLayerResult</cite>.</p>
<dl class="docutils">
<dt>There are 3 possible results:</dt>
<dd><ul class="first last simple">
<li><cite>APP_LAYER_OK</cite> - parser consumed the data successfully</li>
<li><cite>APP_LAYER_ERROR</cite> - parser encountered a unrecoverable error</li>
<li><cite>APP_LAYER_INCOMPLETE(c,n)</cite> - parser consumed <cite>c</cite> bytes, and needs <cite>n</cite> more before being called again</li>
</ul>
</dd>
<dt>Rust parsers follow the same logic, but can return</dt>
<dd><ul class="first last simple">
<li><cite>AppLayerResult::ok()</cite></li>
<li><cite>AppLayerResult::err()</cite></li>
<li><cite>AppLayerResult::incomplete(c,n)</cite></li>
</ul>
</dd>
</dl>
<p>For <cite>i32</cite> and <cite>bool</cite>, Rust parsers can also use <cite>.into()</cite>.</p>
<div class="section" id="app-layer-ok-applayerresult-ok">
<h7>APP_LAYER_OK / AppLayerResult::ok()<a class="headerlink" href="#app-layer-ok-applayerresult-ok" title="Permalink to this headline">¶</a></h7>
<p>When a parser returns &quot;OK&quot;, it signals to the API that all data has been consumed. The parser will be called again when more data is available.</p>
</div>
<div class="section" id="app-layer-error-applayerresult-err">
<h7>APP_LAYER_ERROR / AppLayerResult::err()<a class="headerlink" href="#app-layer-error-applayerresult-err" title="Permalink to this headline">¶</a></h7>
<p>Returning &quot;ERROR&quot; from the parser indicates to the API that the parser encountered an unrecoverable error and the processing of the protocol should stop for the rest of this flow.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This should not be used for recoverable errors. For those events should be set.</p>
</div>
</div>
<div class="section" id="app-layer-incomplete-applayerresult-incomplete">
<h7>APP_LAYER_INCOMPLETE / AppLayerResult::incomplete()<a class="headerlink" href="#app-layer-incomplete-applayerresult-incomplete" title="Permalink to this headline">¶</a></h7>
<p>Using &quot;INCOMPLETE&quot; a parser can indicate how much more data is needed. Many protocols use records that have the size as one of the first parameters. When the parser receives a partial record, it can read this value and then tell the API to only call the parser again when enough data is available.</p>
<p><cite>consumed</cite> is used how much of the current data has been processed
<cite>needed</cite> is the number of bytes that the parser needs on top of what was consumed.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="mi">32</span> <span class="n">record</span> <span class="mi">1</span> <span class="p">][</span> <span class="mi">32</span> <span class="n">record</span> <span class="mi">2</span> <span class="p">][</span> <span class="mi">32</span> <span class="n">r</span><span class="o">..</span> <span class="p">]</span>
 <span class="mi">0</span>          <span class="mi">31</span>  <span class="mi">32</span>         <span class="mi">63</span>  <span class="mi">64</span>    <span class="mi">72</span>
                            <span class="o">^</span>   <span class="o">^</span>
<span class="n">consumed</span><span class="p">:</span> <span class="mi">64</span> <span class="o">---------------/</span>   <span class="o">|</span>
<span class="n">needed</span><span class="p">:</span>   <span class="mi">32</span> <span class="o">-------------------/</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&quot;INCOMPLETE&quot; is only supported for TCP</p>
</div>
<p>The parser will be called again when the <cite>needed</cite> data is available OR when the stream ends. In the latter case the data will be incomplete. It's up to the parser to decide what to do with it in this case.</p>
<div class="section" id="supporting-incomplete-data">
<h8>Supporting incomplete data<a class="headerlink" href="#supporting-incomplete-data" title="Permalink to this headline">¶</a></h8>
<p>In some cases it may be preferable to actually support dealing with incomplete records. For example protocols like SMB and NFS can use very large records during file transfers. Completely queuing these before processing could be a waste of resources. In such cases the &quot;INCOMPLETE&quot; logic could be used for just the record header, while the record data is streamed into the parser.</p>
</div>
</div>
</div>
</div>
<span id="document-devguide/extending/app-layer/transactions"></span><div class="section" id="transactions">
<h5><a class="toc-backref" href="#id1">Transactions</a><a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#transactions" id="id1">Transactions</a><ul>
<li><a class="reference internal" href="#general-concepts" id="id2">General Concepts</a></li>
<li><a class="reference internal" href="#how-the-engine-uses-transactions" id="id3">How the engine uses transactions</a><ul>
<li><a class="reference internal" href="#logging" id="id4">Logging</a></li>
<li><a class="reference internal" href="#rule-matching" id="id5">Rule Matching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#progress-tracking" id="id6">Progress Tracking</a><ul>
<li><a class="reference internal" href="#in-summary-transactions-and-state" id="id7">In Summary - Transactions and State</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples" id="id8">Examples</a><ul>
<li><a class="reference internal" href="#enums" id="id9">Enums</a></li>
<li><a class="reference internal" href="#api-callbacks" id="id10">API Callbacks</a></li>
<li><a class="reference internal" href="#sequence-diagrams" id="id11">Sequence Diagrams</a></li>
<li><a class="reference internal" href="#template-protocol" id="id12">Template Protocol</a></li>
</ul>
</li>
<li><a class="reference internal" href="#work-in-progress-changes" id="id13">Work In Progress changes</a></li>
<li><a class="reference internal" href="#common-words-and-abbreviations" id="id14">Common words and abbreviations</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="general-concepts">
<h6><a class="toc-backref" href="#id2">General Concepts</a><a class="headerlink" href="#general-concepts" title="Permalink to this headline">¶</a></h6>
<p>For Suricata, transactions are an abstraction that help with detecting and logging. An example of a complete transaction is
a pair of messages in the form of a request (from client to server) and a response (from server to client) in HTTP.</p>
<p>In order to know when to log an event for a given protocol, the engine tracks the progress of each transaction - that
is, when is it complete, or when it reaches a key intermediate state. They aid during the detection phase,
when dealing with protocols that can have large PDUs (protocol data units), like TCP, in controlling state for partial rule matching -- in case of rules that mention more than one field.</p>
<p>Transactions are implemented and stored in the per-flow state. The engine interacts with them using a set of callbacks the parser registers.</p>
</div>
<div class="section" id="how-the-engine-uses-transactions">
<h6><a class="toc-backref" href="#id3">How the engine uses transactions</a><a class="headerlink" href="#how-the-engine-uses-transactions" title="Permalink to this headline">¶</a></h6>
<div class="section" id="logging">
<h7><a class="toc-backref" href="#id4">Logging</a><a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h7>
<p>Suricata controls when logging should happen based on transaction completeness. For simpler protocols, such as <code class="docutils literal notranslate"><span class="pre">dns</span></code>
or <code class="docutils literal notranslate"><span class="pre">ntp</span></code>, that will most
likely happen once per transaction, by the time of its completion. In other cases, like with HTTP, this may happen at intermediary states.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">OutputTxLog</span></code>, the engine will compare current state with the value defined for the logging to happen, per flow
direction (<code class="docutils literal notranslate"><span class="pre">logger-&gt;tc_log_progress</span></code>, <code class="docutils literal notranslate"><span class="pre">logger-&gt;ts_log_progress</span></code>). If state is less than that value, the engine skips to
the next logger. Code snippet from: suricata/src/output-tx.c:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">TmEcode</span><span class="w"> </span><span class="nf">OutputTxLog</span><span class="p">(</span><span class="n">ThreadVars</span><span class="w"> </span><span class="o">*</span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">thread_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ts_eof</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tc_eof</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">last_pseudo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">SCLogDebug</span><span class="p">(</span><span class="s">&quot;EOF, so log now&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="o">-&gt;</span><span class="n">LogCondition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logger</span><span class="o">-&gt;</span><span class="n">LogCondition</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">alstate</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="n">tx_id</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">SCLogDebug</span><span class="p">(</span><span class="s">&quot;conditions not met, not logging&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">next_logger</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tx_progress_tc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">logger</span><span class="o">-&gt;</span><span class="n">tc_log_progress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">SCLogDebug</span><span class="p">(</span><span class="s">&quot;progress not far enough, not logging&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">next_logger</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tx_progress_ts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">logger</span><span class="o">-&gt;</span><span class="n">ts_log_progress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">SCLogDebug</span><span class="p">(</span><span class="s">&quot;progress not far enough, not logging&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">next_logger</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="rule-matching">
<h7><a class="toc-backref" href="#id5">Rule Matching</a><a class="headerlink" href="#rule-matching" title="Permalink to this headline">¶</a></h7>
<p>Transaction progress is also used for certain keywords to know what is the minimum state before we can expect a match: until that, Suricata won't even try to look for the patterns.</p>
<p>As seen in <code class="docutils literal notranslate"><span class="pre">DetectAppLayerMpmRegister2</span></code> that has <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">progress</span></code> as parameter, and <code class="docutils literal notranslate"><span class="pre">DetectAppLayerInspectEngineRegister2</span></code>, which expects <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">tx_min_progress</span></code>, for instance. In the code snippet,
<code class="docutils literal notranslate"><span class="pre">HTTP2StateDataClient</span></code>, <code class="docutils literal notranslate"><span class="pre">HTTP2StateDataServer</span></code> and <code class="docutils literal notranslate"><span class="pre">0</span></code> are the values passed to the functions - in the last
example, for <code class="docutils literal notranslate"><span class="pre">FTPDATA</span></code>,
the existence of a transaction implies that a file is being transferred. Hence the <code class="docutils literal notranslate"><span class="pre">0</span></code> value.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">DetectFiledataRegister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="n">DetectAppLayerMpmRegister2</span><span class="p">(</span><span class="s">&quot;file_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SIG_FLAG_TOSERVER</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">            </span><span class="n">PrefilterMpmFiledataRegister</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">            </span><span class="n">ALPROTO_HTTP2</span><span class="p">,</span><span class="w"> </span><span class="n">HTTP2StateDataClient</span><span class="p">);</span>
<span class="w">    </span><span class="n">DetectAppLayerMpmRegister2</span><span class="p">(</span><span class="s">&quot;file_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SIG_FLAG_TOCLIENT</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">            </span><span class="n">PrefilterMpmFiledataRegister</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">            </span><span class="n">ALPROTO_HTTP2</span><span class="p">,</span><span class="w"> </span><span class="n">HTTP2StateDataServer</span><span class="p">);</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="n">DetectAppLayerInspectEngineRegister2</span><span class="p">(</span><span class="s">&quot;file_data&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">ALPROTO_HTTP2</span><span class="p">,</span><span class="w"> </span><span class="n">SIG_FLAG_TOCLIENT</span><span class="p">,</span><span class="w"> </span><span class="n">HTTP2StateDataServer</span><span class="p">,</span>
<span class="w">        </span><span class="n">DetectEngineInspectFiledata</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">DetectAppLayerInspectEngineRegister2</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;file_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ALPROTO_FTPDATA</span><span class="p">,</span><span class="w"> </span><span class="n">SIG_FLAG_TOSERVER</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DetectEngineInspectFiledata</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="progress-tracking">
<h6><a class="toc-backref" href="#id6">Progress Tracking</a><a class="headerlink" href="#progress-tracking" title="Permalink to this headline">¶</a></h6>
<p>As a rule of thumb, transactions will follow a request-response model: if a transaction has had a request and a response, it is complete.</p>
<p>But if a protocol has situations where a request or response won’t expect or generate a message from its counterpart,
it is also possible to have uni-directional transactions. In such cases, transaction is set to complete at the moment of
creation.</p>
<p>For example, DNS responses may be considered as completed transactions, because they also contain the request data, so
all information needed for logging and detection can be found in the response.</p>
<p>In addition, for file transfer protocols, or similar ones where there may be several messages before the file exchange
is completed (NFS, SMB), it is possible to create a level of abstraction to handle such complexity. This could be achieved by adding phases to the model implemented by the protocol (e.g., protocol negotiation phase (SMB), request parsed (HTTP), and so on).</p>
<p>This is controlled by implementing progress states. In Suricata, those will be enums that are incremented as the parsing
progresses. A state will start at 0. The higher its value, the closer the transaction would be to completion. Due to how
the engine tracks detection across states, there is an upper limit of 48 to the state progress (it must be &lt; 48).</p>
<p>The engine interacts with transactions' state using a set of callbacks the parser registers. State is defined per flow direction (<code class="docutils literal notranslate"><span class="pre">STREAM_TOSERVER</span></code> / <code class="docutils literal notranslate"><span class="pre">STREAM_TOCLIENT</span></code>).</p>
<div class="section" id="in-summary-transactions-and-state">
<h7><a class="toc-backref" href="#id7">In Summary - Transactions and State</a><a class="headerlink" href="#in-summary-transactions-and-state" title="Permalink to this headline">¶</a></h7>
<ul class="simple">
<li>Initial State value: <code class="docutils literal notranslate"><span class="pre">0</span></code>.</li>
<li>Simpler scenarios: State is simply a bool.  <code class="docutils literal notranslate"><span class="pre">1</span></code> represents transaction completion, per direction.</li>
<li>Complex Transaction State in Suricata: <code class="docutils literal notranslate"><span class="pre">enum</span></code> (Rust: <code class="docutils literal notranslate"><span class="pre">i32</span></code>). Completion is indicated by the highest enum value (some examples are: SSH, HTTP, HTTP2, DNS, SMB).</li>
</ul>
</div>
</div>
<div class="section" id="examples">
<h6><a class="toc-backref" href="#id8">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h6>
<p>This section shares some examples from Suricata codebase, to help visualize how Transactions work and are handled by the engine.</p>
<div class="section" id="enums">
<h7><a class="toc-backref" href="#id9">Enums</a><a class="headerlink" href="#enums" title="Permalink to this headline">¶</a></h7>
<p>Code snippet from: rust/src/ssh/ssh.rs:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">SSHConnectionState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SshStateInProgress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">SshStateBannerWaitEol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">SshStateBannerDone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">SshStateFinished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From src/app-layer-ftp.h:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">FTP_STATE_IN_PROGRESS</span><span class="p">,</span>
<span class="w">    </span><span class="n">FTP_STATE_PORT_DONE</span><span class="p">,</span>
<span class="w">    </span><span class="n">FTP_STATE_FINISHED</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>From src/app-layer-ssl.h:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TLS_STATE_IN_PROGRESS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">TLS_STATE_CERT_READY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">TLS_HANDSHAKE_DONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">TLS_STATE_FINISHED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="api-callbacks">
<h7><a class="toc-backref" href="#id10">API Callbacks</a><a class="headerlink" href="#api-callbacks" title="Permalink to this headline">¶</a></h7>
<p>In Rust, this is done via the RustParser struct. As seen in rust/src/applayer.rs:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="sd">/// Rust parser declaration</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RustParser</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span>
<span class="w">        </span><span class="p">.</span>
<span class="w">        </span><span class="p">.</span>
<span class="w">    </span><span class="sd">/// Progress values at which the tx is considered complete in a direction</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tx_comp_st_ts</span>:      <span class="nc">c_int</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tx_comp_st_tc</span>:      <span class="nc">c_int</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="w">    </span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In C, the callback API is:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">AppLayerParserRegisterStateProgressCompletionStatus</span><span class="p">(</span>
<span class="w">    </span><span class="n">AppProto</span><span class="w"> </span><span class="n">alproto</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tc</span><span class="p">)</span>
</pre></div>
</div>
<p>Simple scenario described, in Rust:</p>
<p>rust/src/dhcp/dhcp.rs:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="n">tx_comp_st_ts</span>: <span class="mi">1</span><span class="p">,</span>
<span class="n">tx_comp_st_tc</span>: <span class="mi">1</span><span class="p">,</span>
</pre></div>
</div>
<p>For SSH, this looks like this:</p>
<p>rust/src/ssh/ssh.rs:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="n">tx_comp_st_ts</span>: <span class="nc">SSHConnectionState</span>::<span class="n">SshStateFinished</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="n">tx_comp_st_tc</span>: <span class="nc">SSHConnectionState</span>::<span class="n">SshStateFinished</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
</pre></div>
</div>
<p>In C, callback usage would be as follows:</p>
<p>src/app-layer-dcerpc.c:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">AppLayerParserRegisterStateProgressCompletionStatus</span><span class="p">(</span><span class="n">ALPROTO_DCERPC</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>src/app-layer-ftp.c:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">AppLayerParserRegisterStateProgressCompletionStatus</span><span class="p">(</span>
<span class="w">    </span><span class="n">ALPROTO_FTP</span><span class="p">,</span><span class="w"> </span><span class="n">FTP_STATE_FINISHED</span><span class="p">,</span><span class="w"> </span><span class="n">FTP_STATE_FINISHED</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="sequence-diagrams">
<h7><a class="toc-backref" href="#id11">Sequence Diagrams</a><a class="headerlink" href="#sequence-diagrams" title="Permalink to this headline">¶</a></h7>
<p>A DNS transaction in Suricata can be considered unidirectional:</p>
<a class="reference internal image-reference" href="_images/DnsUnidirectionalTransactions.png"><img alt="A sequence diagram with two entities, Client and Server, with an arrow going from the Client to the Server, labeled &quot;DNS Request&quot;. After that, there is a dotted line labeled &quot;Transaction Completed&quot;." src="_images/DnsUnidirectionalTransactions.png" style="width: 600px;" /></a>
<p>An HTTP2 transaction is an example of a bidirectional transaction, in Suricata (note that, while HTTP2 may have multiple streams, those are mapped to transactions in Suricata. They run in parallel, scenario not shown in this Sequence Diagram - which shows one transaction, only):</p>
<a class="reference internal image-reference" href="_images/HTTP2BidirectionalTransaction.png"><img alt="A sequence diagram with two entities, Client and Server, with an arrow going from the Client to the Server labeled &quot;Request&quot; and below that an arrow going from Server to Client labeled &quot;Response&quot;. Below those arrows, a dotted line indicates that the transaction is completed." src="_images/HTTP2BidirectionalTransaction.png" style="width: 600px;" /></a>
<p>A TLS Handshake is a more complex example, where several messages are exchanged before the transaction is considered completed:</p>
<a class="reference internal image-reference" href="_images/TlsHandshake.png"><img alt="A sequence diagram with two entities, Client and Server, with an arrow going from the Client to the Server labeled &quot;ClientHello&quot; and below that an arrow going from Server to Client labeled &quot;ServerHello&quot;. Below those arrows, several more follow from Server to Client and vice-versa, before a dotted line indicates that the transaction is finally completed." src="_images/TlsHandshake.png" style="width: 600px;" /></a>
</div>
<div class="section" id="template-protocol">
<h7><a class="toc-backref" href="#id12">Template Protocol</a><a class="headerlink" href="#template-protocol" title="Permalink to this headline">¶</a></h7>
<p>Suricata has a template protocol for educational purposes, which has simple bidirectional transactions.</p>
<p>A completed transaction for the template looks like this:</p>
<a class="reference internal image-reference" href="_images/TemplateTransaction.png"><img alt="A sequence diagram with two entities, Client and Server, with an arrow going from the Client to the Server, labeled &quot;Request&quot;. An arrow below that first one goes from Server to Client." src="_images/TemplateTransaction.png" style="width: 600px;" /></a>
<p>Following are the functions that check whether a transaction is considered completed, for the Template Protocol. Those are called by the Suricata API. Similar functions exist for each protocol, and may present implementation differences, based on what is considered a transaction for that given protocol.</p>
<p>In C:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">TemplateGetStateProgress</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">txv</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TemplateTransaction</span><span class="w"> </span><span class="o">*</span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txv</span><span class="p">;</span>

<span class="w">    </span><span class="n">SCLogNotice</span><span class="p">(</span><span class="s">&quot;Transaction progress requested for tx ID %&quot;</span><span class="n">PRIu64</span>
<span class="w">        </span><span class="s">&quot;, direction=0x%02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_id</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">STREAM_TOCLIENT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">response_done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">STREAM_TOSERVER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* For the template, just the existence of the transaction means the</span>
<span class="cm">         * request is done. */</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And in Rust:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">rs_template_tx_get_alstate_progress</span><span class="p">(</span>
<span class="w">    </span><span class="n">tx</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">raw</span>::<span class="n">c_void</span><span class="p">,</span>
<span class="w">    </span><span class="n">_direction</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">os</span>::<span class="n">raw</span>::<span class="n">c_int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast_pointer</span><span class="o">!</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="n">TemplateTransaction</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Transaction is done if we have a response.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="work-in-progress-changes">
<h6><a class="toc-backref" href="#id13">Work In Progress changes</a><a class="headerlink" href="#work-in-progress-changes" title="Permalink to this headline">¶</a></h6>
<p>Currently we are working to have files be part of the transaction instead of the per-flow state, as seen in <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/4444">https://redmine.openinfosecfoundation.org/issues/4444</a>.</p>
<p>Another work in progress is to limit the number of transactions per flow, to prevent Denial of Service (DoS) by quadratic complexity - a type of attack that may happen to protocols which can have multiple transactions at the same time - such as HTTP2 so-called streams (see  <a class="reference external" href="https://redmine.openinfosecfoundation.org/issues/4530">https://redmine.openinfosecfoundation.org/issues/4530</a>).</p>
</div>
<div class="section" id="common-words-and-abbreviations">
<h6><a class="toc-backref" href="#id14">Common words and abbreviations</a><a class="headerlink" href="#common-words-and-abbreviations" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>al, applayer: application layer</li>
<li>alproto: application layer protocol</li>
<li>alstate: application layer state</li>
<li>engine: refers to Suricata core detection logic</li>
<li>flow: a bidirectional flow of packets with the same 5-tuple elements (protocol, source ip, destination ip, source port, destination port. Vlans can be added as well)</li>
<li>PDU: Protocol Data Unit</li>
<li>rs: rust</li>
<li>tc: to client</li>
<li>ts: to server</li>
<li>tx: transaction</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-devguide/extending/detect/index"></span><div class="section" id="detection">
<h4>Detection<a class="headerlink" href="#detection" title="Permalink to this headline">¶</a></h4>
</div>
<span id="document-devguide/extending/output/index"></span><div class="section" id="output">
<h4>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<p>Extending Suricata's alert and event output.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2023, OISF
      
        <span class="commit">
          Revision <code>af4bb917</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/suricata-7.0.1/">suricata-7.0.1</a></dd>
        
          <dd><a href="/en/suricata-7.0.0-rc2/">suricata-7.0.0-rc2</a></dd>
        
          <dd><a href="/en/suricata-7.0.0-rc1/">suricata-7.0.0-rc1</a></dd>
        
          <dd><a href="/en/suricata-7.0.0-beta1/">suricata-7.0.0-beta1</a></dd>
        
          <dd><a href="/en/suricata-7.0.0/">suricata-7.0.0</a></dd>
        
          <dd><a href="/en/suricata-6.0.9/">suricata-6.0.9</a></dd>
        
          <dd><a href="/en/suricata-6.0.8/">suricata-6.0.8</a></dd>
        
          <dd><a href="/en/suricata-6.0.7/">suricata-6.0.7</a></dd>
        
          <dd><a href="/en/suricata-6.0.6/">suricata-6.0.6</a></dd>
        
          <dd><a href="/en/suricata-6.0.5/">suricata-6.0.5</a></dd>
        
          <dd><a href="/en/suricata-6.0.4/">suricata-6.0.4</a></dd>
        
          <dd><a href="/en/suricata-6.0.3/">suricata-6.0.3</a></dd>
        
          <dd><a href="/en/suricata-6.0.2/">suricata-6.0.2</a></dd>
        
          <dd><a href="/en/suricata-6.0.14/">suricata-6.0.14</a></dd>
        
          <dd><a href="/en/suricata-6.0.13/">suricata-6.0.13</a></dd>
        
          <dd><a href="/en/suricata-6.0.12/">suricata-6.0.12</a></dd>
        
          <dd><a href="/en/suricata-6.0.11/">suricata-6.0.11</a></dd>
        
          <dd><a href="/en/suricata-6.0.10/">suricata-6.0.10</a></dd>
        
          <dd><a href="/en/suricata-6.0.1/">suricata-6.0.1</a></dd>
        
          <dd><a href="/en/suricata-6.0.0-rc1/">suricata-6.0.0-rc1</a></dd>
        
          <dd><a href="/en/suricata-6.0.0-beta1/">suricata-6.0.0-beta1</a></dd>
        
          <dd><a href="/en/suricata-6.0.0/">suricata-6.0.0</a></dd>
        
          <dd><a href="/en/suricata-5.0.9/">suricata-5.0.9</a></dd>
        
          <dd><a href="/en/suricata-5.0.8/">suricata-5.0.8</a></dd>
        
          <dd><a href="/en/suricata-5.0.7/">suricata-5.0.7</a></dd>
        
          <dd><a href="/en/suricata-5.0.6/">suricata-5.0.6</a></dd>
        
          <dd><a href="/en/suricata-5.0.5/">suricata-5.0.5</a></dd>
        
          <dd><a href="/en/suricata-5.0.4/">suricata-5.0.4</a></dd>
        
          <dd><a href="/en/suricata-5.0.3/">suricata-5.0.3</a></dd>
        
          <dd><a href="/en/suricata-5.0.2/">suricata-5.0.2</a></dd>
        
          <dd><a href="/en/suricata-5.0.10/">suricata-5.0.10</a></dd>
        
          <dd><a href="/en/suricata-5.0.1/">suricata-5.0.1</a></dd>
        
          <dd><a href="/en/suricata-5.0.0-rc1/">suricata-5.0.0-rc1</a></dd>
        
          <dd><a href="/en/suricata-5.0.0-beta1/">suricata-5.0.0-beta1</a></dd>
        
          <dd><a href="/en/suricata-5.0.0/">suricata-5.0.0</a></dd>
        
          <dd><a href="/en/suricata-4.1.9/">suricata-4.1.9</a></dd>
        
          <dd><a href="/en/suricata-4.1.8/">suricata-4.1.8</a></dd>
        
          <dd><a href="/en/suricata-4.1.7/">suricata-4.1.7</a></dd>
        
          <dd><a href="/en/suricata-4.1.6/">suricata-4.1.6</a></dd>
        
          <dd><a href="/en/suricata-4.1.5/">suricata-4.1.5</a></dd>
        
          <dd><a href="/en/suricata-4.1.4/">suricata-4.1.4</a></dd>
        
          <dd><a href="/en/suricata-4.1.3/">suricata-4.1.3</a></dd>
        
          <dd><a href="/en/suricata-4.1.2/">suricata-4.1.2</a></dd>
        
          <dd><a href="/en/suricata-4.1.10/">suricata-4.1.10</a></dd>
        
          <dd><a href="/en/suricata-4.1.1/">suricata-4.1.1</a></dd>
        
          <dd><a href="/en/suricata-4.1.0-rc2/">suricata-4.1.0-rc2</a></dd>
        
          <dd><a href="/en/suricata-4.1.0-rc1/">suricata-4.1.0-rc1</a></dd>
        
          <dd><a href="/en/suricata-4.1.0-beta1/">suricata-4.1.0-beta1</a></dd>
        
          <dd><a href="/en/suricata-4.1.0/">suricata-4.1.0</a></dd>
        
          <dd><a href="/en/suricata-4.0.7/">suricata-4.0.7</a></dd>
        
          <dd><a href="/en/suricata-4.0.6/">suricata-4.0.6</a></dd>
        
          <dd><a href="/en/suricata-4.0.5/">suricata-4.0.5</a></dd>
        
          <dd><a href="/en/suricata-4.0.4/">suricata-4.0.4</a></dd>
        
          <dd><a href="/en/suricata-4.0.3/">suricata-4.0.3</a></dd>
        
          <dd><a href="/en/suricata-4.0.2/">suricata-4.0.2</a></dd>
        
          <dd><a href="/en/suricata-4.0.1/">suricata-4.0.1</a></dd>
        
          <dd><a href="/en/suricata-4.0.0-rc2/">suricata-4.0.0-rc2</a></dd>
        
          <dd><a href="/en/suricata-4.0.0-rc1/">suricata-4.0.0-rc1</a></dd>
        
          <dd><a href="/en/suricata-4.0.0-beta1/">suricata-4.0.0-beta1</a></dd>
        
          <dd><a href="/en/suricata-4.0.0/">suricata-4.0.0</a></dd>
        
          <dd><a href="/en/suricata-3.2rc1/">suricata-3.2rc1</a></dd>
        
          <dd><a href="/en/suricata-3.2beta1/">suricata-3.2beta1</a></dd>
        
          <dd><a href="/en/suricata-3.2.5/">suricata-3.2.5</a></dd>
        
          <dd><a href="/en/suricata-3.2.4/">suricata-3.2.4</a></dd>
        
          <dd><a href="/en/suricata-3.2.3/">suricata-3.2.3</a></dd>
        
          <dd><a href="/en/suricata-3.2.2/">suricata-3.2.2</a></dd>
        
          <dd><a href="/en/suricata-3.2.1/">suricata-3.2.1</a></dd>
        
          <dd><a href="/en/suricata-3.2/">suricata-3.2</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//docs.suricata.io/_/downloads/en/latest/pdf/">pdf</a></dd>
        
          <dd><a href="//docs.suricata.io/_/downloads/en/latest/htmlzip/">html</a></dd>
        
          <dd><a href="//docs.suricata.io/_/downloads/en/latest/epub/">epub</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/suricata/?fromdocs=suricata">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/suricata/?fromdocs=suricata">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>